const Xt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Rt="rgba(0, 0, 0, 1)";function Ht(y,s){return!s||s===1?y.map(a=>({...a})):y.map(a=>a.type==="line"?{...a,length:(a.length||0)*s}:a.type==="arc"?{...a,radius:(a.radius||0)*s}:{...a})}const Vt=.75,Dt=14,Yt=60,Pt=[0,10,-10,20,-20,30,-30];function T(y){return y*Math.PI/180}function Wt(y){const s=y.closest(".proceso");return s&&getComputedStyle(s).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Ut(y,s,a){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.setAttribute("viewBox","0 0 "+y+" "+s),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.style.width="100%",o.style.height="100%",o.style.display="block",o.style.background=a||"#ffffff",o.style.shapeRendering="geometricPrecision",o.style.textRendering="optimizeLegibility",o.style.boxSizing="border-box",o}function Jt(y,s,a,o){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",s),n.setAttribute("stroke",a),n.setAttribute("fill","none"),n.setAttribute("stroke-width",o),n.setAttribute("vector-effect","non-scaling-stroke"),y.appendChild(n),n}function Ft(y){let s="",a=Number(y)||0;for(;a>=0;){const o=a%26;s=String.fromCharCode(65+o)+s,a=Math.floor(a/26)-1}return s}const Kt=0,Qt=-25;function Zt(y,s,a,o){if(!s||!s.length)return;const n=2,m=12,r=m+n,w=s.map(A=>(A.letter?A.letter+" ":"")+(A.text||"")),t=m*w.length+n*(w.length-1),i=Kt;let f=o-Qt-t+m/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let A=0;A<w.length;A++){const l=w[A],p=document.createElementNS("http://www.w3.org/2000/svg","text");p.setAttribute("x",i),p.setAttribute("y",f),p.setAttribute("fill",Rt),p.setAttribute("font-size",m),p.setAttribute("text-anchor","start"),p.setAttribute("alignment-baseline","middle"),p.style.pointerEvents="none",p.textContent=l,y.appendChild(p);const d=qt(l,m).w;window.__legendBoxesGroup.push({left:i,right:i+d,top:f-m/2,bottom:f+m/2}),f+=r}}function te(y){const s=(y||"").split(/\s+/).filter(Boolean),a=[];for(let o=0;o<s.length;o++){const n=s[o];if(n.endsWith("r")){const m=parseFloat(n.slice(0,-1));let r=360;o+1<s.length&&s[o+1].endsWith("d")&&(r=parseFloat(s[++o].slice(0,-1))),a.push({type:"arc",radius:m,arcAngle:r})}else n.endsWith("d")?a.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):a.push({type:"line",length:parseFloat(n)})}return a}function ee(y){let s=[],a=0,o=0,n=0;s.push({x:a,y:o});for(let m=0;m<y.length;m++){const r=y[m];if(r.type==="line")a+=r.length*Math.cos(T(n)),o+=r.length*Math.sin(T(n)),s.push({x:a,y:o});else if(r.type==="turn")n+=r.angle;else if(r.type==="arc"){const w=a+r.radius*Math.cos(T(n+90)),t=o+r.radius*Math.sin(T(n+90)),i=Math.atan2(o-t,a-w),f=i+T(r.arcAngle);a=w+r.radius*Math.cos(f),o=t+r.radius*Math.sin(f),n+=r.arcAngle,s.push({x:a,y:o})}}return s}function Gt(y){let s=[],a=0,o=0,n=0;for(let m=0;m<y.length;m++){const r=y[m];if(r.type==="line"){const w={x:a,y:o},t={x:a+r.length*Math.cos(T(n)),y:o+r.length*Math.sin(T(n))};s.push({start:w,end:t,length:r.length}),a=t.x,o=t.y}else if(r.type==="turn")n+=r.angle;else if(r.type==="arc"){const w=a+r.radius*Math.cos(T(n+90)),t=o+r.radius*Math.sin(T(n+90)),i=Math.atan2(o-t,a-w),f=i+T(r.arcAngle);a=w+r.radius*Math.cos(f),o=t+r.radius*Math.sin(f),n+=r.arcAngle}}return s}function qt(y,s){const a=s||12;return{w:(y?y.length:0)*a*.55,h:a}}function Z(y,s,a){const o=a||0;return!(y.right+o<s.left||y.left-o>s.right||y.bottom+o<s.top||y.top-o>s.bottom)}function It(y,s,a,o){const n=s/2;return Math.max(a+n,Math.min(o-n,y))}function oe(y,s){const o=[];let n=0;function m(){n>1e-9&&(o.push({type:"line",length:n}),n=0)}for(let r=0;r<y.length;r++){const w=y[r];if(w.type==="line"){n+=w.length;continue}if(w.type==="turn"){if(Math.abs(w.angle)<1e-9)continue;m(),o.push(w);continue}if(w.type==="arc"){m(),o.push(w);continue}m(),o.push(w)}return m(),o}function jt(y,s){const a=s&&s.decimals||0,o=s&&s.step||null;let n=Number(y||0);return o&&o>0&&(n=Math.round(n/o)*o),n.toFixed(a).replace(/\.0+$/,"")}function ne(y,s){const a=Math.hypot(y,s)||1;let o=y/a,n=s/a;return(n<-1e-9||Math.abs(n)<=1e-9&&o<0)&&(o=-o,n=-n),{ux:o,uy:n}}function zt(y,s,a){const o=a||.01,n=ne(y,s),m=Math.round(n.ux/o)*o,r=Math.round(n.uy/o)*o;return m+"|"+r}function ae(y,s,a){const o=a&&a.dirPrecision||.01,n=a&&a.labelFormat||{decimals:0,step:null},m=y.reduce((p,d)=>p+Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y),0),r=s.reduce((p,d)=>p+(d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),0),w=r>0?m/r:1,t=new Map;for(let p=0;p<s.length;p++){const d=s[p],g=d.end.x-d.start.x,u=d.end.y-d.start.y,c=zt(g,u,o),e=t.get(c)||[];e.push({length:d.length||Math.hypot(g,u),index:p}),t.set(c,e)}const i=s.map(p=>p.length||Math.hypot(p.end.x-p.start.x,p.end.y-p.start.y)),f=new Set,A=new Set,l=[];for(let p=0;p<y.length;p++){const d=y[p],g=d.end.x-d.start.x,u=d.end.y-d.start.y,c=zt(g,u,o),e=t.get(c)||[],x=Math.hypot(g,u);let h=x;if(e.length){const S=x/w;let b=null,v=1/0;for(const I of e){const j=Math.abs(I.length-S),C=A.has(I.index)?.1:0;j+C<v&&(b=I,v=j+C)}b&&(h=b.length,A.add(b.index))}else p<i.length&&(h=i[p]);const M=jt(h,n),E=c+"|"+M;f.has(E)||(f.add(E),l.push({start:d.start,end:d.end,_dirKey:c,_label:M,_lenChosen:h}))}return l}function se(y,s){const a=s,o=y.map(u=>Object.assign({},u));let n=0,m=0,r=0;const w=[];let t=null,i=-1,f=-1;const A=1e-7;function l(u){return u*Math.PI/180}function p(u){return Math.abs(Math.sin(l(u)))<1e-12}function d(u,c,e,x){return Math.min(c,x)-Math.max(u,e)>A}for(let u=0;u<o.length;u++){let e=function(){const S={x:Math.cos(l(r)),y:Math.sin(l(r))},b=n+o[u].length*S.x,v=m+o[u].length*S.y,I=p(r);for(let j=0;j<w.length;j++){const C=w[j];if(I&&C.horiz&&Math.abs(m-C.y)<A){if(d(Math.min(n,b),Math.max(n,b),Math.min(C.x1,C.x2),Math.max(C.x1,C.x2))&&t&&i>=0&&f>=0)return o[f].length+=a,n+=t.x*a,m+=t.y*a,w[i].x2+=t.x*a,w[i].y2+=t.y*a,!0}else if(!I&&!C.horiz&&Math.abs(n-C.x)<A&&d(Math.min(m,v),Math.max(m,v),Math.min(C.y1,C.y2),Math.max(C.y1,C.y2))&&t&&i>=0&&f>=0)return o[f].length+=a,n+=t.x*a,m+=t.y*a,w[i].x2+=t.x*a,w[i].y2+=t.y*a,!0}return!1};var g=e;const c=o[u];if(c.type==="turn"){r+=c.angle;continue}if(c.type==="arc"){const S=n+c.radius*Math.cos(l(r+90)),b=m+c.radius*Math.sin(l(r+90)),v=Math.atan2(m-b,n-S),I=v+l(c.arcAngle);n=S+c.radius*Math.cos(I),m=b+c.radius*Math.sin(I),r+=c.arcAngle,t=null;continue}for(;e(););const x={x:Math.cos(l(r)),y:Math.sin(l(r))},h=n+o[u].length*x.x,M=m+o[u].length*x.y,E=p(r);w.push({x1:n,y1:m,x2:h,y2:M,horiz:E,y:m,x:n}),t=x,i=w.length-1,f=u,n=h,m=M}return o}function At(y,s,a,o){const n=T(o),m=Math.cos(n),r=Math.sin(n),w=y.x-s,t=y.y-a;return{x:s+w*m-t*r,y:a+w*r+t*m}}function ie(y,s,a,o,n,m,r,w,t){let i="",f=0,A=0,l=0,p=!1;function d(u,c){const e=At({x:u,y:c},s,a,o);return{x:w+(e.x-m)*n,y:t+(e.y-r)*n}}function g(){if(!p){const u=d(f,A);i+="M "+u.x+" "+u.y,p=!0}}for(let u=0;u<y.length;u++){const c=y[u];if(c.type==="turn"){l+=c.angle;continue}if(c.type==="line"){const e=f+c.length*Math.cos(T(l)),x=A+c.length*Math.sin(T(l));g();const h=d(e,x);i+=" L "+h.x+" "+h.y,f=e,A=x;continue}if(c.type==="arc"){const e=f+c.radius*Math.cos(T(l+90)),x=A+c.radius*Math.sin(T(l+90)),h=Math.atan2(A-x,f-e),M=h+T(c.arcAngle),E=e+c.radius*Math.cos(M),S=x+c.radius*Math.sin(M),b=Math.abs(c.arcAngle)%360;if(g(),b<1e-6||Math.abs(c.arcAngle)>=359.9){const ct=h+Math.sign(c.arcAngle)*Math.PI,J=e+c.radius*Math.cos(ct),O=x+c.radius*Math.sin(ct),N=d(J,O),z=d(f,A),L=c.radius*n,tt=c.arcAngle>=0?1:0;i+=" A "+L+" "+L+" 0 1 "+tt+" "+N.x+" "+N.y,i+=" A "+L+" "+L+" 0 1 "+tt+" "+z.x+" "+z.y,l+=c.arcAngle;continue}const v=d(E,S),I=c.radius*n,j=b>180?1:0,C=c.arcAngle>=0?1:0;i+=" A "+I+" "+I+" 0 "+j+" "+C+" "+v.x+" "+v.y,f=E,A=S,l+=c.arcAngle}}return i||"M 0 0"}function re(y){const s=ee(y);let a=Math.min(...s.map(g=>g.x)),o=Math.max(...s.map(g=>g.x)),n=Math.min(...s.map(g=>g.y)),m=Math.max(...s.map(g=>g.y));const r=(a+o)/2,w=(n+m)/2,i=m-n>o-a?-90:0,f=s.map(g=>At(g,r,w,i));a=Math.min(...f.map(g=>g.x)),o=Math.max(...f.map(g=>g.x)),n=Math.min(...f.map(g=>g.y)),m=Math.max(...f.map(g=>g.y));const A=Math.max(1,o-a),l=Math.max(1,m-n),p=(a+o)/2,d=(n+m)/2;return{rotDeg:i,w:A,h:l,cxModel:r,cyModel:w,midX:p,midY:d,ptsRot:f}}function ce(y){const s=[];let a=0,o=0,n=0;function m(r){const w=T(r);return{x:Math.cos(w),y:Math.sin(w)}}for(let r=0;r<y.length;r++){const w=y[r];if(w.type==="line")a+=w.length*Math.cos(T(n)),o+=w.length*Math.sin(T(n));else if(w.type==="turn"){const t=m(n),i=w.angle;n+=i;const f=m(n);s.push({x:a,y:o,angleDeg:i,prevDir:t,nextDir:f})}else if(w.type==="arc"){const t=a+w.radius*Math.cos(T(n+90)),i=o+w.radius*Math.sin(T(n+90)),f=Math.atan2(o-i,a-t),A=f+T(w.arcAngle);a=t+w.radius*Math.cos(A),o=i+w.radius*Math.sin(A),n+=w.arcAngle}}return s}function le(y,s,a){const o=Array.from({length:s},()=>({sumH:0,maxW:0,items:[]})),n=[...y.keys()].sort((m,r)=>y[r].h-y[m].h);for(const m of n){let r=0,w=1/0;for(let i=0;i<s;i++){const f=o[i],A=f.sumH+(f.items.length>0?a:0)+y[m].h;A<w&&(w=A,r=i)}const t=o[r];t.sumH=t.items.length>0?t.sumH+a+y[m].h:t.sumH+y[m].h,t.maxW=Math.max(t.maxW,y[m].w),t.items.push(m)}return o}function de(y,s,a,o={}){const n=o.padding??12,m=o.gapCol??12,r=o.gapRow??10,w=Math.max(1,Math.min(y.length,o.kMax??4)),t=Math.max(10,s-2*n),i=Math.max(10,a-2*n),f=A(y);function A(e){const x=e.map(L=>L.w/Math.max(L.h,1)),h=e.map(L=>L.h),M=e.map(L=>L.w),E=e.map(L=>L.w*L.h),S=L=>L.reduce((tt,ht)=>tt+ht,0)/L.length,b=(L,tt)=>L.reduce((ht,pt)=>ht+Math.pow(pt-tt,2),0)/L.length,v=(L,tt)=>Math.sqrt(b(L,tt)),I=S(x),j=S(h),C=S(M),ct=E.reduce((L,tt)=>L+tt,0),J=v(h,j),O=v(M,C),N=j>0?J/j:0,z=C>0?O/C:0;return{avgAspectRatio:I,avgHeight:j,avgWidth:C,totalArea:ct,heightCV:N,widthCV:z,isLinear:I>6||j<C*.12,isUniformHeight:N<.15,isUniformWidth:z<.15,isHighlyVariable:N>.5||z>.5,count:e.length}}let l={S:0,k:1,cols:null,score:0};for(let e=1;e<=w;e++){const x=le(y,e,r),h=x.reduce((pt,D)=>pt+D.maxW,0)+m*(e-1),M=Math.max(...x.map(pt=>pt.sumH));if(h<=0||M<=0)continue;const E=t/h,S=i/M,b=Math.min(E,S),v=Math.max(.01,b*.92),I=f.totalArea*v*v,j=t*i,C=I/j,ct=x.map(pt=>pt.sumH*v),J=ct.reduce((pt,D)=>pt+D,0)/e,O=Math.max(...ct)-Math.min(...ct),N=J>0?1-O/J:1,z=e===1?1.1:e===2?.9:.7,L=e>f.count*.5?.7:1,tt=N>.85?1.05:1,ht=v*(1+C*.25)*(1+N*.1)*z*L*tt;ht>l.score&&(l={S:v,k:e,cols:x,score:ht,efficiency:C,colBalance:N})}const p=l.cols.map(e=>e.maxW*l.S),d=p.reduce((e,x)=>e+x,0);let g=[];if(l.k===1)g[0]=s/2;else{const e=(l.k-1)*m,x=d+e;if(x<t){const h=t-x,M=m+h/(l.k-1);let E=n;for(let S=0;S<l.k;S++)g[S]=E+p[S]/2,E+=p[S]+M}else{let h=n+Math.max(0,(t-x)/2);for(let M=0;M<l.k;M++)g[M]=h+p[M]/2,h+=p[M]+m}}const u=[],c=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(e=>e.right));for(let e=0;e<l.k;e++){const x=l.cols[e];u[e]=[];const h=x.items.map(O=>y[O].h*l.S),M=h.reduce((O,N)=>O+N,0);if(x.items.length===0)continue;const E=g[e],S=l.cols[e].maxW*l.S,b=E-S/2,v=E+S/2,I=c(),C=Math.max(0,Math.min(v,I)-b)/S,ct=C>.05;let J=i;if(ct&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const N=Math.min(...window.__legendBoxesGroup.map(z=>z.top))-15;J=Math.max(10,N-n),console.log(`üìè Columna ${e}: X=${b.toFixed(0)}-${v.toFixed(0)}, legendWidth=${I.toFixed(0)}, solape=${(C*100).toFixed(0)}%, altura reducida a ${J.toFixed(0)}px`)}else console.log(`üìè Columna ${e}: X=${b.toFixed(0)}-${v.toFixed(0)}, legendWidth=${I.toFixed(0)}, solape=${(C*100).toFixed(0)}%, altura completa ${J.toFixed(0)}px`);if(x.items.length===1){const O=h[0],N=n+J/2,z=Math.max(n+O/2,Math.min(N,a-n-O/2));u[e].push(z);continue}if(M>J){console.warn(`Columna ${e}: elementos no caben (${M}px > ${J}px)`);const z=M/x.items.length<4?20:5;let L=n;for(let tt=0;tt<x.items.length;tt++){const ht=Math.max(h[tt],2),pt=L+ht/2;u[e].push(pt),L+=ht+z}}else{const O=J-M,N=x.items.length-1;let z=O/N;M/x.items.length<4?z=Math.max(18,Math.min(z,50)):z=Math.max(5,z);const ht=M+N*z,pt=J-ht;let D=n+Math.max(0,pt/2);for(let ot=0;ot<x.items.length;ot++){const rt=Math.max(h[ot],2),q=D+rt/2,X=n+J-rt/2,k=Math.max(n+rt/2,Math.min(q,X));u[e].push(k),D+=rt+z}}}return{S:l.S,k:l.k,cols:l.cols,centersX:g,centersYByCol:u,padding:n,gapRow:r,gapCol:m}}window.renderizarGrupoSVG=function(s,a){const o=s&&s.etiqueta&&s.etiqueta.id!=null?s.etiqueta.id:s&&s.id!=null?s.id:a,n=document.getElementById("contenedor-svg-"+o);if(!n)return;const m=600,r=150,w=Wt(n),t=Ut(m,r,w);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const i=(s.elementos||[]).map((d,g)=>{var h,M,E;const u=d.barras!=null?d.barras:0;let c="N/A";if(d.diametro!=null&&d.diametro!==""){const b=String(d.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(b){const v=parseFloat(b[0]);isFinite(v)&&(c=String(Math.round(v)))}}const e=[];(h=d.coladas)!=null&&h.colada1&&e.push(d.coladas.colada1),(M=d.coladas)!=null&&M.colada2&&e.push(d.coladas.colada2),(E=d.coladas)!=null&&E.colada3&&e.push(d.coladas.colada3);const x=e.length>0?` (${e.join(", ")})`:"";return{letter:Ft(g),text:`√ò${c} x${u}${x}`}});Zt(t,i,m,r);const f=s.elementos.map(d=>{const g=te(d.dimensiones||""),u=oe(g);let c=0;for(const E of u)E.type==="line"&&(c=Math.max(c,Math.abs(E.length||0))),E.type==="arc"&&(c=Math.max(c,Math.abs(E.radius||0)));const x=c<=50?2:1,h=Ht(u,x),M=re(h);return{dimsRaw:g,dimsNoZero:u,dimsScaled:h,geomScale:x,medida:M}}),A=f.map(d=>d.medida),l=de(A,m,r,{padding:20,gapCol:50,gapRow:22,kMax:3}),p=new Map;for(let d=0;d<l.k;d++)l.cols[d].items.forEach((g,u)=>p.set(g,{c:d,j:u}));s.elementos.forEach(function(d,g){const{dimsNoZero:u,dimsScaled:c,medida:e}=f[g],x=p.get(g),h=l.centersX[x.c],M=l.centersYByCol[x.c][x.j],E=l.S,S=e.ptsRot.map(D=>({x:h+(D.x-e.midX)*E,y:M+(D.y-e.midY)*E})),b=Math.min(...S.map(D=>D.x)),v=Math.max(...S.map(D=>D.x)),I=Math.min(...S.map(D=>D.y)),j=Math.max(...S.map(D=>D.y)),C={left:b,right:v,top:I,bottom:j};window.__figBoxesGroup.push({...C});const ct=se(c,.6),J=ie(ct,e.cxModel,e.cyModel,e.rotDeg,E,e.midX,e.midY,h,M),O=Jt(t,J,Xt,2);(function(){const ot=ce(c);function rt(_){return Math.abs(Math.abs(_)-90)>=Vt}const q=(_,B)=>At({x:_.x,y:_.y},0,0,B),X=(_,B)=>{const H=At({x:_,y:B},e.cxModel,e.cyModel,e.rotDeg);return{x:h+(H.x-e.midX)*E,y:M+(H.y-e.midY)*E}},k=_=>Math.max(10,Math.min(28,_));ot.forEach(_=>{if(!rt(_.angleDeg))return;const B=X(_.x,_.y),H=q(_.prevDir,e.rotDeg),ut=q(_.nextDir,e.rotDeg),V=Math.atan2(H.y,H.x),P=V+T(_.angleDeg),Y=Math.min(C.right-C.left,C.bottom-C.top);let $=k(.12*Y);const ft=B.x+$*Math.cos(V),mt=B.y+$*Math.sin(V),R=B.x+$*Math.cos(P),wt=B.y+$*Math.sin(P),W=Math.abs(_.angleDeg),nt=W>180?1:0,vt=_.angleDeg>=0?1:0,at=document.createElementNS("http://www.w3.org/2000/svg","path");at.setAttribute("d",`M ${ft} ${mt} A ${$} ${$} 0 ${nt} ${vt} ${R} ${wt}`),at.setAttribute("stroke","rgba(255,99,71,0.7)"),at.setAttribute("stroke-width","2"),at.setAttribute("fill","none"),at.style.pointerEvents="none",t.appendChild(at);let F=H.x+ut.x,G=H.y+ut.y;W>180&&(F=-F,G=-G);let U=Math.hypot(F,G);if(U<1e-6){const it=_.angleDeg>=0?1:-1;F=-H.y*it,G=H.x*it,U=Math.hypot(F,G)||1}F/=U,G/=U;const K=(Math.round(_.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",Q=qt(K,14);function Mt(it,lt){return{left:it-Q.w/2,right:it+Q.w/2,top:lt-Q.h/2,bottom:lt+Q.h/2}}let et=null;for(let it=Dt;it<=Yt&&!et;it+=4)for(let lt=0;lt<Pt.length&&!et;lt++){const yt=Pt[lt],xt=q({x:F,y:G},yt),Et=B.x+xt.x*($+it),dt=B.y+xt.y*($+it),gt=Mt(Et,dt);gt.top<0||gt.bottom>r||gt.left<0||gt.right>m||window.__figBoxesGroup.some(bt=>Z(bt,gt,6))||(window.__dimBoxesGroup||[]).some(bt=>Z(bt,gt,2))||(window.__angleBoxesGroup||[]).some(bt=>Z(bt,gt,2))||(window.__placedLetterBoxes||[]).some(bt=>Z(bt,gt,2))||(window.__legendBoxesGroup||[]).some(bt=>Z(bt,gt,6))||(et={x:Et,y:dt,box:gt})}if(!et){const it=B.x+F*($+Dt),lt=B.y+G*($+Dt),yt=Mt(it,lt);et={x:it,y:lt,box:yt}}window.__angleBoxesGroup.push(et.box);const st=document.createElementNS("http://www.w3.org/2000/svg","text");st.setAttribute("x",et.x),st.setAttribute("y",et.y),st.setAttribute("fill",Bt),st.setAttribute("font-size",14),st.setAttribute("text-anchor","middle"),st.setAttribute("alignment-baseline","middle"),st.style.cursor="pointer",st.textContent=K,t.appendChild(st),st.addEventListener("mouseenter",()=>{at.setAttribute("stroke","rgba(255,69,0,1)"),at.setAttribute("stroke-width","3"),at.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),st.addEventListener("mouseleave",()=>{at.setAttribute("stroke","rgba(255,99,71,0.7)"),at.setAttribute("stroke-width","2"),at.style.filter="none"})})})();const N=O.cloneNode(!1);N.setAttribute("stroke-width","50"),N.setAttribute("stroke","transparent"),N.setAttribute("fill","none"),N.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(D=>{N.addEventListener(D,ot=>O.dispatchEvent(new ot.constructor(ot.type,ot)))}),t.insertBefore(N,O);const z=(d.codigo!=null?d.codigo:d.id)+"";O.style.cursor="pointer",O.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),O.addEventListener("click",function(D){if(D.ctrlKey||D.metaKey||D.shiftKey){D.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(d.id);return}abrirModalDividirElemento(d.id,z)}),O.addEventListener("contextmenu",function(D){D.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(d.id)});const L=[],tt=Gt(ct),ht=Gt(u);ae(tt,ht,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(D){const ot=At(D.start,e.cxModel,e.cyModel,e.rotDeg),rt=At(D.end,e.cxModel,e.cyModel,e.rotDeg),q={x:h+(ot.x-e.midX)*E,y:M+(ot.y-e.midY)*E},X={x:h+(rt.x-e.midX)*E,y:M+(rt.y-e.midY)*E},k=D._label,_=X.x-q.x,B=X.y-q.y,H=Math.hypot(_,B)||1,ut=_/H,V=B/H,P=B/H,Y=-_/H,$=(q.x+X.x)/2,ft=(q.y+X.y)/2,mt=$+P*10,R=ft+Y*10,wt=qt(k,14),W=wt.w,nt=wt.h;function vt(et,st){return{left:et-W/2,right:et+W/2,top:st-nt/2,bottom:st+nt/2}}const at=H*.45;let F=mt,G=R;for(let et=0;et<=Math.ceil(at/6);et++){const st=et%2===0?1:-1,it=Math.ceil(et/2),lt=st*it*6;if(Math.abs(lt)>at)continue;const yt=mt+ut*lt,xt=R+V*lt,Et=(yt-q.x)*ut+(xt-q.y)*V;if(Et<0+W*.3||Et>H-W*.3)continue;const dt=vt(yt,xt);if(!(Z({left:Math.min(q.x,X.x),right:Math.max(q.x,X.x),top:Math.min(q.y,X.y),bottom:Math.max(q.y,X.y)},dt,0)||(window.__angleBoxesGroup||[]).some(St=>Z(St,dt,2))||(window.__legendBoxesGroup||[]).some(St=>Z(St,dt,6))||L.some(St=>Z(St,dt,2))||dt.top<0||dt.bottom>r||dt.left<0||dt.right>m)){F=yt,G=xt,L.push(dt),window.__dimBoxesGroup.push(dt);break}}const U=document.createElementNS("http://www.w3.org/2000/svg","line");U.setAttribute("x1",q.x),U.setAttribute("y1",q.y),U.setAttribute("x2",X.x),U.setAttribute("y2",X.y),U.setAttribute("stroke","rgba(0,0,255,0.6)"),U.setAttribute("stroke-width","4"),U.setAttribute("stroke-linecap","round"),U.setAttribute("vector-effect","non-scaling-stroke"),U.style.opacity=0,U.style.pointerEvents="none",U.style.transition="opacity 120ms ease",t.appendChild(U);const K=document.createElementNS("http://www.w3.org/2000/svg","text");K.setAttribute("x",F),K.setAttribute("y",G),K.setAttribute("fill",Bt),K.setAttribute("font-size",14),K.setAttribute("text-anchor","middle"),K.setAttribute("alignment-baseline","middle"),K.setAttribute("tabindex","0"),K.style.cursor="pointer",K.textContent=k,t.appendChild(K);function Q(){U.style.opacity=1}function Mt(){U.style.opacity=0}K.addEventListener("mouseenter",Q),K.addEventListener("mouseleave",Mt),K.addEventListener("focus",Q),K.addEventListener("blur",Mt)}),function(){const ot=[];let rt=0,q=0,X=0;for(let k=0;k<c.length;k++){const _=c[k];if(_.type==="line")rt+=_.length*Math.cos(T(X)),q+=_.length*Math.sin(T(X));else if(_.type==="turn")X+=_.angle;else if(_.type==="arc"){const B=rt+_.radius*Math.cos(T(X+90)),H=q+_.radius*Math.sin(T(X+90)),ut=Math.atan2(q-H,rt-B),V=ut+T(_.arcAngle);let P=_.radius;for(let Y=0;Y<u.length;Y++){const $=u[Y];if($.type==="arc"&&Math.abs($.arcAngle-_.arcAngle)<.01){P=$.radius;break}}ot.push({center:{x:B,y:H},radius:_.radius,originalRadius:P,arcAngle:_.arcAngle,startAngle:ut,endAngle:V}),rt=B+_.radius*Math.cos(V),q=H+_.radius*Math.sin(V),X+=_.arcAngle}}ot.forEach(function(k){const _=At(k.center,e.cxModel,e.cyModel,e.rotDeg),B={x:h+(_.x-e.midX)*E,y:M+(_.y-e.midY)*E},H=(k.startAngle+k.endAngle)/2,ut=k.radius*E,V="R"+jt(k.originalRadius,{decimals:0,step:null}),P=qt(V,14),Y=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let $=!1,ft,mt,R;for(let Q=0;Q<Y.length&&!$;Q++){const Mt=Y[Q],et=H+T(Mt),st={x:k.center.x+k.radius*Math.cos(et),y:k.center.y+k.radius*Math.sin(et)},it=At(st,e.cxModel,e.cyModel,e.rotDeg),lt={x:h+(it.x-e.midX)*E,y:M+(it.y-e.midY)*E},yt=lt.x-B.x,xt=lt.y-B.y,Et=Math.hypot(yt,xt)||1,dt=yt/Et,gt=xt/Et;for(let Ct=8;Ct<=60&&!$;Ct+=6){const _t=ut*.7;if(ft=B.x+dt*_t+dt*Ct,mt=B.y+gt*_t+gt*Ct,R={left:ft-P.w/2,right:ft+P.w/2,top:mt-P.h/2,bottom:mt+P.h/2},!(R.top<0||R.bottom>r||R.left<0||R.right>m||window.__figBoxesGroup.some(Lt=>Z(Lt,R,2))||(window.__legendBoxesGroup||[]).some(Lt=>Z(Lt,R,2)))){$=!0;break}}}if(!$)return;L.push(R);const wt={x:ft-B.x,y:mt-B.y},W=Math.hypot(wt.x,wt.y)||1,nt={x:wt.x/W,y:wt.y/W},vt=B.x+nt.x*ut*.6,at=B.y+nt.y*ut*.6,F=document.createElementNS("http://www.w3.org/2000/svg","line");F.setAttribute("x1",B.x),F.setAttribute("y1",B.y),F.setAttribute("x2",vt),F.setAttribute("y2",at),F.setAttribute("stroke","rgba(0,128,0,0.6)"),F.setAttribute("stroke-width","4"),F.setAttribute("stroke-linecap","round"),F.setAttribute("vector-effect","non-scaling-stroke"),F.style.opacity=0,F.style.pointerEvents="none",F.style.transition="opacity 120ms ease",t.appendChild(F);const G=document.createElementNS("http://www.w3.org/2000/svg","text");G.setAttribute("x",ft),G.setAttribute("y",mt),G.setAttribute("fill",Bt),G.setAttribute("font-size",14),G.setAttribute("text-anchor","middle"),G.setAttribute("alignment-baseline","middle"),G.setAttribute("tabindex","0"),G.style.cursor="pointer",G.textContent=V,t.appendChild(G);function U(){F.style.opacity=1}function K(){F.style.opacity=0}G.addEventListener("mouseenter",U),G.addEventListener("mouseleave",K),G.addEventListener("focus",U),G.addEventListener("blur",K)})}(),function(){const ot=Ft(g),rt=14,q=qt(ot,rt);function X(P,Y){return{left:P,right:P+q.w,top:Y-q.h/2,bottom:Y+q.h/2}}let k=null;const _=(C.top+C.bottom)/2,B=Math.max(q.h/2,Math.min(_,r-q.h/2));function H(P){for(let $=0;$<=30;$+=4){const ft=$%2===0?1:-1,mt=Math.ceil($/2),R=ft*mt*4,wt=Math.max(q.h/2,Math.min(r-q.h/2,B+R)),W=P,nt=X(W,wt);if(!(window.__figBoxesGroup.some(Q=>Z(Q,nt,6))||(window.__dimBoxesGroup||[]).some(Q=>Z(Q,nt,3))||(window.__angleBoxesGroup||[]).some(Q=>Z(Q,nt,3))||(window.__legendBoxesGroup||[]).some(Q=>Z(Q,nt,6))||(window.__placedLetterBoxes||[]).some(Q=>Z(Q,nt,2))||nt.top<0||nt.bottom>r||nt.left<0||nt.right>m))return k={x:W,y:wt,box:nt},!0}return!1}const ut=[{x:C.right+10,priority:1},{x:C.left-10-q.w,priority:1},{x:C.right+15,priority:2},{x:C.left-15-q.w,priority:2},{x:C.right+5,priority:2},{x:C.left-5-q.w,priority:2},{x:C.right+20,priority:3},{x:C.left-20-q.w,priority:3},{x:C.right+25,priority:3},{x:C.left-25-q.w,priority:3},{x:C.right+30,priority:3},{x:C.left-30-q.w,priority:3}];ut.sort((P,Y)=>P.priority-Y.priority);for(const P of ut){if(k)break;const Y=It(P.x,q.w,0,m);if(H(Y))break}if(!k){const P=(C.left+C.right)/2,Y=[{x:P-q.w/2,y:C.top-q.h-5},{x:P-q.w/2,y:C.bottom+q.h+5}];for(const $ of Y){if(k)break;const ft=It($.x,q.w,0,m),mt=Math.max(q.h/2,Math.min(r-q.h/2,$.y)),R=X(ft,mt);!window.__figBoxesGroup.some(W=>Z(W,R,6))&&!(window.__dimBoxesGroup||[]).some(W=>Z(W,R,3))&&!(window.__angleBoxesGroup||[]).some(W=>Z(W,R,3))&&!(window.__legendBoxesGroup||[]).some(W=>Z(W,R,6))&&!(window.__placedLetterBoxes||[]).some(W=>Z(W,R,2))&&R.top>=0&&R.bottom<=r&&R.left>=0&&R.right<=m&&(k={x:ft,y:mt,box:R})}}if(!k){const P=It(m-q.w,q.w,0,m),Y=B;k={x:P,y:Y,box:X(P,Y)}}window.__placedLetterBoxes.push(k.box);const V=document.createElementNS("http://www.w3.org/2000/svg","text");V.setAttribute("x",k.x),V.setAttribute("y",k.y),V.setAttribute("fill",Rt),V.setAttribute("font-size",rt),V.setAttribute("text-anchor","start"),V.setAttribute("alignment-baseline","middle"),V.style.fontWeight="600",V.style.pointerEvents="none",V.textContent=ot,t.appendChild(V)}()}),n.innerHTML="",n.appendChild(t)};function kt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const y=window.elementosAgrupadosScript;if(!y)return;const s=document.getElementById("grid-maquina");if(s&&window.updateGridClasses){const a=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,o),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}y.forEach(function(a,o){renderizarGrupoSVG(a,o)}),requestAnimationFrame(()=>{s&&(s.style.opacity="1",s.style.visibility="visible",s.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",s.className)),document.querySelectorAll(".proceso").forEach(a=>{a.style.opacity="1"})}),window.actualizarSVGConColadas=function(a,o){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,m=n.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(a));if(m===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${a}`);return}const r=n[m];r.elementos&&o&&r.elementos.forEach(w=>{const t=String(w.id),i=o[t];w.coladas||(w.coladas={colada1:null,colada2:null,colada3:null}),i&&Array.isArray(i)&&(w.coladas.colada1=i[0]||null,w.coladas.colada2=i[1]||null,w.coladas.colada3=i[2]||null)}),renderizarGrupoSVG(r,m),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${a}`,o)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",kt):kt();document.addEventListener("livewire:navigated",kt);window.abrirModalDividirElemento=function(s){const a=document.getElementById("modalDividirElemento"),o=document.getElementById("dividir_elemento_id"),n=document.getElementById("formDividirElemento");!a||!o||!n||(o.value=s,window.rutaDividirElemento&&n.setAttribute("action",window.rutaDividirElemento),a.classList.remove("hidden"))};window.enviarDivision=async function(){const s=document.getElementById("formDividirElemento"),a=s.getAttribute("action")||window.rutaDividirElemento,o=new FormData(s);try{const n=document.querySelector('meta[name="csrf-token"]'),m=o.get("_token")||(n?n.getAttribute("content"):null),w=await fetch(a,{method:"POST",headers:m?{"X-CSRF-TOKEN":m}:{},body:o}),t=await w.json();if(!w.ok||!t.success)throw new Error(t.message||"Error al dividir");s.reset();const i=document.getElementById("modalDividirElemento");i&&i.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",t.message,"success"):alert(t.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(y){const s={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},a={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function o(t,i,f={}){console.log(`üîÑ Actualizando etiqueta ${t} a estado: ${i}`);const A=String(t).replace(/\./g,"-"),l=document.querySelector(`#etiqueta-${A}`);if(!l)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${t}`),!1;const p=String(i).toLowerCase().trim(),d=a[p];if(!d)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${i}`),!1;l.dataset.estado=p,Array.from(l.classList).forEach(e=>{e.startsWith("estado-")&&l.classList.remove(e)}),l.classList.add(d.cssClass),l.style.setProperty("--bg-estado",d.bgColor);const u=l.querySelector('[id^="contenedor-svg-"]');if(u){const e=u.querySelector("svg");e&&(e.style.background=d.bgColor)}const c=l.querySelector(".etiqueta-card")||l;return c&&(c.style.background=d.bgColor),n(l,p),m(l),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:t,estado:p,datosExtra:f}})),console.log(`‚úÖ Etiqueta ${t} actualizada a ${i}`),!0}function n(t,i){const f=t.querySelectorAll(".btn-fabricar"),A=["empaquetada","en-paquete"];f.forEach(l=>{A.includes(i)?(l.disabled=!0,l.style.opacity="0.5",l.style.cursor="not-allowed",l.title=`Etiqueta ya ${i}`):(l.disabled=!1,l.style.opacity="1",l.style.cursor="pointer",l.title="Fabricar esta etiqueta")})}function m(t){t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400)}function r(t,i,f={}){console.log(`üîÑ Actualizando ${t.length} etiquetas...`);const l=t.map(p=>o(p,i,f)).filter(p=>p).length;return console.log(`‚úÖ ${l}/${t.length} etiquetas actualizadas`),l}function w(t){const i=String(t).replace(/\./g,"-"),f=document.querySelector(`#etiqueta-${i}`);return f?{id:t,estado:f.dataset.estado||"desconocido",elemento:f}:null}window.addEventListener("paquete:creado",t=>{const{codigoPaquete:i,etiquetaIds:f}=t.detail;console.log(`üì¶ Evento paquete:creado recibido - ${i} con ${f.length} etiquetas`),r(f,"empaquetada",{codigo_paquete:i})}),y.SistemaDOM={actualizarEstadoEtiqueta:o,actualizarMultiplesEtiquetas:r,obtenerEstadoActual:w,ESTADOS_CONFIG:a},y.ColoresEstado={actualizar:(t,i)=>{s[t]=i;const f=document.getElementById("colores-estado-css");if(f){let A=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[l,p]of Object.entries(s))A+=`.proceso.estado-${l} {
    --bg-estado: ${p};
}
`;f.textContent=A,console.log(`‚úÖ Color actualizado para estado "${t}": ${i}`)}},obtenerColor:t=>s[t],todos:()=>({...s})}})(window);function $t(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async t=>{var u,c,e;const i=t.target.closest(".btn-fabricar");if(!i)return;t.preventDefault();const f=(c=(u=document.getElementById("maquina-info"))==null?void 0:u.dataset)==null?void 0:c.maquinaId;if(!f){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const A=String(i.dataset.etiquetaId||"").trim(),l=A.replace(/\./g,"-"),p=document.querySelector(`#etiqueta-${l}`);if(p){const x=(p.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(x)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${A} ya est√° en estado ${x}.`,timer:2500,showConfirmButton:!1});return}}const d=Number(((e=window.DIAMETRO_POR_ETIQUETA)==null?void 0:e[A])??0);if(!A){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!d&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const g=i.disabled;i.disabled=!0;try{await y(A,f,d)}finally{i.disabled=g}});async function y(t,i,f=null){var h,M,E,S;const A=`/actualizar-etiqueta/${t}/maquina/${i}`,l=(h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.getAttribute("content"),p=t.replace(/\./g,"-"),g=(((E=(M=document.querySelector(`#etiqueta-${p}`))==null?void 0:M.dataset)==null?void 0:E.estado)||"").toLowerCase()==="fabricando",u=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",c=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",e=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(u&&c||e){if(g&&((S=window._decisionCortePorEtiqueta)!=null&&S[t])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:a});return}for(;;){let b;try{b=await Cortes.mejorCorteSimple(t,f,l)}catch(v){w(v);return}if(!b)return;if(b.accion==="optimizar"){let v;try{v=await Cortes.mejorCorteOptimizado(t,f,b.patrones,l)}catch(I){w(I);return}if((v==null?void 0:v.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:v.longitudBarraCm,etiquetas:v.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:a});return}else{if(v==="volver")continue;return}}if(b.accion==="fabricar_patron_simple"){const v=Math.round(Number(b.longitud_m||0)*100);if(!v){w("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:v,etiquetas:[{etiqueta_sub_id:t,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:a});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,i,l)}catch(b){w(b)}return}try{const b=await fetch(A,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({})}),v=await b.json();if(!b.ok)throw new Error(v.message||"Error al actualizar");a(t,v)}catch(b){w(b)}}async function s(t,i,f){var M,E;const{value:A,isConfirmed:l}=await Swal.fire({title:"üì¶ Escanear producto",text:"Escanea el QR del paquete de material a usar",input:"text",inputPlaceholder:"C√≥digo del producto...",showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",inputValidator:S=>{if(!S||!S.trim())return"Debes escanear o introducir el c√≥digo del producto"}});if(!l||!A)return;let p;try{const S=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(A.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":f}});if(!S.ok){const b=await S.json();throw new Error(b.message||"Producto no encontrado")}p=await S.json()}catch(S){await Swal.fire({icon:"error",title:"Producto no encontrado",text:S.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${A}`});return}const{value:d,isConfirmed:g}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${p.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${p.diametro} mm</p>
                    <p><strong>Stock actual:</strong> ${((M=p.peso_stock)==null?void 0:M.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${p.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!g)return;const u=d==="completo",c=`/actualizar-etiqueta/${t}/maquina/${i}`,e=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f},body:JSON.stringify({producto_id:p.id,paquete_completo:u})}),x=await e.json();if(!e.ok)throw new Error(x.message||"Error al fabricar");const h=((E=x.metricas)==null?void 0:E.peso_consumido)||0;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${p.codigo}</p>
                <p><strong>Peso consumido:</strong> ${h.toFixed(2)} kg</p>
                ${u?'<p class="text-orange-600">El paquete ha sido marcado como consumido.</p>':""}
            `,timer:3e3,showConfirmButton:!1}),a(t,x)}function a(t,i){var A,l;const f=t.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:i.estado,peso_etiqueta:i.peso_etiqueta,nombre:i.nombre,data_completa:i}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,i.estado,{peso:i.peso_etiqueta,nombre:i.nombre||t}):o(t,i.estado),i.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,i.coladas_por_elemento),(i.estado||"").toLowerCase()){case"cortando":r("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":r("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),n(f);break;case"fabricando":r("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":r("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),n(f),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"fabricada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),m(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":r("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(A=window._decisionCortePorEtiqueta)!=null&&A[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),n(f),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"completada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),m(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":r("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":r("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),n(f);break;case"soldando":r("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":r("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),n(f);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${i.estado}`),r("warning","Estado desconocido",`El estado recibido (${i.estado}) no est√° reconocido.`,3e3)}(l=i.productos_afectados)!=null&&l.length&&i.productos_afectados.forEach(p=>{const d=document.getElementById(`peso-stock-${p.id}`),g=document.getElementById(`progreso-texto-${p.id}`),u=document.getElementById(`progreso-barra-${p.id}`);d&&(d.textContent=`${p.peso_stock} kg`),g&&(g.textContent=`${p.peso_stock} / ${p.peso_inicial} kg`),u&&(u.style.height=`${p.peso_stock/p.peso_inicial*100}%`)})}function o(t,i){const f=t.replace(/\./g,"-"),A=document.getElementById("etiqueta-"+f);if(!A)return;A.dataset.estado=String(i||"").toLowerCase(),A.className=A.className.split(" ").filter(d=>!d.startsWith("estado-")).join(" ").trim(),A.classList.add("estado-"+A.dataset.estado);const l=A.querySelector('[id^="contenedor-svg-"]'),p=l==null?void 0:l.querySelector("svg");p&&(p.style.background=getComputedStyle(A).getPropertyValue("--bg-estado").trim())}function n(t){const i=`#etiqueta-${CSS.escape(t)}`,f=document.querySelector(i),A=Array.from(document.querySelectorAll(".proceso")),l=x=>(x||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),p=x=>{var E;const h=(E=x.dataset)==null?void 0:E.estado;if(h)return l(h);const M=x.querySelector('[id^="estado-"]');return l((M==null?void 0:M.textContent)||(M==null?void 0:M.innerText)||"")},d=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),g=x=>d.has(p(x)),u=f?A.indexOf(f):-1,e=(u>=0?A.slice(u+1):A).find(x=>!g(x));e?e.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function m(t,i){var d;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!i||!Array.isArray(i)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(i.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const f=window.elementosAgrupadosScript.findIndex(g=>{var u;return((u=g.etiqueta)==null?void 0:u.etiqueta_sub_id)===t});if(f===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[f].elementos=i;const A=window.elementosAgrupadosScript[f],l=(d=A.etiqueta)==null?void 0:d.id;if(!l){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const p=document.getElementById("contenedor-svg-"+l);if(!p){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${l})`);return}try{const g=p.querySelector("svg");g&&g.remove();const u=600,c=150,e=p.closest(".proceso"),x=e&&getComputedStyle(e).getPropertyValue("--bg-estado").trim()||"#e5e7eb",h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("viewBox",`0 0 ${u} ${c}`),h.setAttribute("preserveAspectRatio","xMidYMid meet"),h.style.width="100%",h.style.height="100%",h.style.display="block",h.style.background=x;const M=(A.elementos||[]).map((S,b)=>{var ct,J,O;const v=S.barras!=null?S.barras:0;let I="N/A";if(S.diametro!=null&&S.diametro!==""){const z=String(S.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(z){const L=parseFloat(z[0]);isFinite(L)&&(I=String(Math.round(L)))}}const j=[];(ct=S.coladas)!=null&&ct.colada1&&j.push(S.coladas.colada1),(J=S.coladas)!=null&&J.colada2&&j.push(S.coladas.colada2),(O=S.coladas)!=null&&O.colada3&&j.push(S.coladas.colada3);const C=j.length>0?` (${j.join(", ")})`:"";return{letter:indexToLetters(b),text:`√ò${I} x${v}${C}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(h,M,u,c):console.error("‚ùå drawLegendBottomLeft no est√° definida");const E=document.createElementNS("http://www.w3.org/2000/svg","text");E.setAttribute("x",u/2),E.setAttribute("y",c/2),E.setAttribute("text-anchor","middle"),E.setAttribute("fill","#059669"),E.setAttribute("font-size","14"),E.setAttribute("font-weight","600"),E.textContent="‚úì Coladas actualizadas",h.appendChild(E),p.appendChild(h),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{E&&E.parentNode&&E.remove()},2e3)}catch(g){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,g),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function r(t,i,f,A=2e3){Swal.fire({icon:t,title:i,text:f,timer:A,showConfirmButton:!1})}function w(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=a}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$t):$t();document.addEventListener("livewire:navigated",$t);(function(y){let s=[],a=!1,o=null;async function n(g){var c;const u=`/etiquetas/${encodeURIComponent(g)}/validar-para-paquete`;try{const e=await fetch(u,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.content}});if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const h=await e.json();if(console.log("üîç validarEtiqueta response:",{status:e.status,data:h,peso_etiqueta:h.peso_etiqueta}),!e.ok)throw new Error((h==null?void 0:h.message)||(h==null?void 0:h.motivo)||"Error al validar");return h}catch(e){throw e}}function m(g,u){const c=u.id||g;if(s.some(h=>h.id===c))return!1;const e=parseFloat(u.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:g,id:c,peso_etiqueta_recibido:u.peso_etiqueta,peso_parseado:e,data_completa:u});const x={id:c,type:"etiqueta",peso:e,estado:u.estado||"desconocido",nombre:u.nombre||"Sin nombre"};return s.push(x),f(),!0}function r(g){const u=s.findIndex(c=>c.id===g);u>=0&&s.splice(u,1),f()}function w(){s=[],f()}function t(){return s.reduce((g,u)=>g+(parseFloat(u.peso)||0),0)}function i(){return s}function f(){const g=document.getElementById("itemsList");if(!g)return;g.innerHTML="";for(const e of s){const x=document.createElement("li");x.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",x.dataset.code=e.id,x.innerHTML=`
                <div>
                    <div class="font-semibold">${e.id} === ${e.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,x.querySelector("button").onclick=()=>r(e.id),g.appendChild(x)}const u=t(),c=document.createElement("li");c.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",c.textContent=`Total: ${u.toFixed(2)} kg (${s.length} etiquetas)`,g.appendChild(c)}async function A(){var x,h,M;if(!s.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const g=Number(((h=(x=document.getElementById("maquina-info"))==null?void 0:x.dataset)==null?void 0:h.maquinaId)||window.maquinaId),u=Number(((M=document.getElementById("ubicacion-id"))==null?void 0:M.value)||window.ubicacionId);if(!g||!u){await Swal.fire("Faltan datos","Debe especificarse la m√°quina y la ubicaci√≥n.","error");return}const c={items:s.map(E=>({id:E.id,type:E.type})),maquina_id:g,ubicacion_id:u},e=async(E={})=>{var v;const S=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(v=document.querySelector('meta[name="csrf-token"]'))==null?void 0:v.content},body:JSON.stringify({...c,...E})}),b=await S.json();if(!S.ok)throw new Error(b.message||"Error al crear el paquete");return b};try{const E=await e();if(E.success)return l(E);if(E.warning){let S="<div style='text-align:left;'>Se detectaron advertencias:";for(const[v,I]of Object.entries(E.warning))Array.isArray(I)&&I.length&&(S+=`<br><strong>${v.replaceAll("_"," ")}:</strong> ${I.join(", ")}`);if(S+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:S,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const v=await e({confirmar:!0});if(v.success)return l(v);throw new Error(v.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(E){await Swal.fire("Error",E.message||"Error inesperado","error")}}async function l(g){var x;const u=g.codigo_paquete||((x=g.paquete)==null?void 0:x.codigo)||"N/D",c=t(),e=[...s.map(h=>h.id)];await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${u}</strong> creado correctamente</p><p>${e.length} etiquetas ¬∑ ${c.toFixed(2)} kg</p>`}),w(),console.log(`üì¶ Disparando evento paquete:creado para ${u}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:u,etiquetaIds:e,pesoTotal:c}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),e.forEach(h=>{p(h,u)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function p(g,u){const c=String(g).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${c}`);if(!e){console.warn(`‚ùå No se encontr√≥ elemento: ${g}`);return}console.log(`üîÑ Actualizando manualmente: ${g}`),Array.from(e.classList).forEach(b=>{b.startsWith("estado-")&&e.classList.remove(b)}),e.classList.add("estado-en-paquete"),e.dataset.estado="en-paquete",e.style.setProperty("--bg-estado","#e3e4FA");const h=e.querySelector('[id^="contenedor-svg-"]');if(h){const b=h.querySelector("svg");b&&(b.style.background="#e3e4FA")}const M=e.querySelector(".etiqueta-card")||e;M&&(M.style.background="#e3e4FA");const E=e.querySelector("h3");if(E&&!e.querySelector(".paquete-info")){const b=document.createElement("div");b.className="paquete-info text-sm font-semibold mt-2 no-print",b.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",b.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${u}</span>
            `,E.parentNode.insertBefore(b,E.nextSibling)}e.querySelectorAll(".btn-fabricar").forEach(b=>{b.disabled=!0,b.style.opacity="0.5",b.style.cursor="not-allowed"}),e.style.transition="transform 0.5s ease, background-color 0.5s ease",e.style.transform="scale(1.03)",setTimeout(()=>{e.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${g} actualizada manualmente`)}function d(){if(a)return;a=!0;const g=document.getElementById("qrItem");g&&(g.addEventListener("change",()=>g.dispatchEvent(new Event("input"))),g.addEventListener("input",async function(){const c=this.value.trim();if(c)try{const e=await n(c);if(!e.valida){await Swal.fire("Etiqueta no v√°lida",e.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}m(c,e)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(e){console.error("Error de validaci√≥n:",e),await Swal.fire("Error",e.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const u=document.getElementById("crearPaqueteBtn");u&&u.addEventListener("click",A),document.addEventListener("focus",function(c){c.target.id&&c.target.id.startsWith("input-etiqueta-")&&(o=c.target,console.log("üéØ Focus en input:",c.target.id))},!0),document.addEventListener("click",async function(c){var e;if(c.target.classList.contains("btn-agregar-carro")||c.target.closest(".btn-agregar-carro")){const h=(c.target.classList.contains("btn-agregar-carro")?c.target:c.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!h){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const M=document.querySelector(`[x-show="tabActivo === 'crear'"]`),E=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(M&&window.getComputedStyle(M).display,E&&window.getComputedStyle(E).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let b=document.activeElement;(!b||!((e=b.id)!=null&&e.startsWith("input-etiqueta-")))&&(b=o),(!b||!document.body.contains(b))&&(b=document.querySelector('input[id^="input-etiqueta-"]')),b?(b.value=h,b.focus(),b.classList.add("ring-4","ring-green-400"),setTimeout(()=>{b.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${h} a√±adida al input:`,b.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",h);try{const b=await n(h);if(!b.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:b.motivo||"Motivo no especificado"});return}m(h,b)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(b){console.error("Error al a√±adir al carro:",b),await Swal.fire({icon:"error",title:"Error",text:b.message||"No se pudo a√±adir al carro"})}}})}y.TrabajoPaquete={inicializar:d,agregarItemEtiqueta:m,eliminarItem:r,limpiarCarro:w,obtenerItems:i,calcularPesoTotal:t,crearPaquete:A,validarEtiqueta:n,actualizarListaVisual:f},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d(),document.addEventListener("livewire:navigated",d)})(window);function Tt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(s,a){const o=document.getElementById("grid-maquina");if(!o)return;console.log("üîß Actualizando clases:",{showLeft:s,showRight:a,clasesAnteriores:o.className}),s||a?o.classList.add("columnas-laterales-visibles"):o.classList.remove("columnas-laterales-visibles"),s&&a?o.classList.add("ambas-columnas"):o.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",o.className),o.offsetHeight,o.querySelectorAll(".etiqueta-card").forEach(m=>{m.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a)});function y(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((m,r)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),r.disconnect();const t=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(t,i)}}).observe(document.body,{childList:!0,subtree:!0});return}const a=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,o),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}y()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);
