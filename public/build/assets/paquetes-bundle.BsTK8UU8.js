document.addEventListener("DOMContentLoaded",function(){const m=document.getElementById("modal-dibujo"),v=document.getElementById("cerrar-modal"),g=document.getElementById("canvas-dibujo");if(!g){console.log("Canvas no encontrado en esta p√°gina, saltando inicializaci√≥n de figuras");return}const f=g.getContext("2d"),n=50,r=25,o=10,q=100;function t(e){const a=[],s=[];return e.split(/\s+/).forEach(i=>{i.includes("d")?s.push(parseFloat(i.replace("d",""))||0):a.push(parseFloat(i)||50)}),{longitudes:a,angulos:s}}function Y(e,a){let s=0,i=0,c=0,d=0,u=0,h=0,p=0;return e.forEach((y,E)=>{s+=y*Math.cos(c*Math.PI/180),i+=y*Math.sin(c*Math.PI/180),d=Math.min(d,s),u=Math.max(u,s),h=Math.min(h,i),p=Math.max(p,i),c+=a[E]||0}),{minX:d,maxX:u,minY:h,maxY:p}}function S(e){f.clearRect(0,0,g.width,g.height);const a=e.length,s=g.width,i=r*2+a*q+(a-1)*o;g.height=i;const c=s-2*n,d=(i-2*r-(a-1)*o)/a;e.forEach((u,h)=>{const{longitudes:p,angulos:y}=t(u.dimensiones||""),E=n+c/2,b=r+d/2+h*(d+o);p.length===1?P(f,E,b,c,p):l(f,E,b,c,d,p,y),f.font="14px Arial",f.fillStyle="#FF0000",f.fillText(`#${u.id}`,n+c-10,b+d/2-5)})}function P(e,a,s,i,c){const d=i/Math.abs(c),u=Math.abs(c)*d;e.strokeStyle="#0000FF",e.lineWidth=2,e.beginPath(),e.moveTo(a-u/2,s),e.lineTo(a+u/2,s),e.stroke(),e.font="12px Arial",e.fillStyle="red",e.fillText(c.toString(),a,s-10)}function l(e,a,s,i,c,d,u){const{minX:h,maxX:p,minY:y,maxY:E}=Y(d,u),b=p-h,C=E-y,z=b<C,w=Math.min(i/(z?C:b),c/(z?b:C)),k=(h+p)/2,I=(y+E)/2;e.save(),e.translate(a,s),z&&e.rotate(-Math.PI/2),e.scale(w,w),e.translate(-k,-I),e.strokeStyle="#0000FF",e.lineWidth=2/w,e.beginPath();let L=0,M=0,j=0;e.moveTo(L,M),d.forEach((X,T)=>{const F=L+X*Math.cos(j*Math.PI/180),$=M+X*Math.sin(j*Math.PI/180);e.lineTo(F,$);const D=(L+F)/2,W=(M+$)/2,B=Math.atan2($-M,F-L);e.save(),e.translate(D,W),e.rotate(B),e.font=`${12/w}px Arial`,e.fillStyle="red",e.fillText(X.toFixed(1),0,-5/w),e.restore(),L=F,M=$,j+=u[T]||0}),e.stroke(),e.restore()}function A(e){const a=window.paquetes.find(c=>c.id==e);if(console.log(window.paquetes),!a){console.warn("No se encontr√≥ el paquete.");return}let s=a.elementos||[],i=a.subpaquetes||[];s.length>0?(S(s),m.classList.remove("hidden")):i.length>0?(S(i),m.classList.remove("hidden")):alert("Este paquete no tiene elementos para dibujar.")}v.addEventListener("click",function(){m.classList.add("hidden")}),m.addEventListener("click",function(e){e.target===m&&m.classList.add("hidden")}),window.mostrarDibujo=A});(function(m){function v(n,r,o=null){const q=String(n).replace(/\./g,"-");let t=document.querySelector(`#etiqueta-${q}`);if(!t){const l=document.querySelector(`[data-etiqueta-sub-id="${n}"]`);l&&(t=l.querySelector(".etiqueta-card"))}if(!t){const l=document.querySelectorAll("[data-etiquetas-sub-ids]");for(const A of l)try{if(JSON.parse(A.dataset.etiquetasSubIds||"[]").includes(n)){t=A,console.log(`üì¶ Etiqueta ${n} encontrada en grupo`);break}}catch{}}if(!t){console.warn(`‚ö†Ô∏è No se encontr√≥ elemento: ${n}`);return}if(console.log(`üîÑ Actualizando estado de etiqueta ${n} a: ${r}`),Array.from(t.classList).forEach(l=>{l.startsWith("estado-")&&t.classList.remove(l)}),r==="en-paquete"&&o)t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.dataset.paquete=o,t.style.setProperty("--bg-estado","#e3e4FA"),g(t,o);else if(r==="pendiente"){t.classList.add("estado-pendiente"),t.dataset.estado="pendiente",delete t.dataset.paquete,t.style.setProperty("--bg-estado","#ffffff");const l=t.querySelector(".paquete-codigo");l&&(l.textContent="",l.style.display="none")}const S=t.querySelector('[id^="contenedor-svg-"]');if(S){const l=S.querySelector("svg");l&&(l.style.background=r==="en-paquete"?"#e3e4FA":"#ffffff")}const P=t.querySelector(".etiqueta-card")||t;P&&(P.style.background=r==="en-paquete"?"#e3e4FA":"#ffffff"),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${n} actualizada a estado: ${r}`)}function g(n,r){const o=n.querySelector(".paquete-codigo");o&&(o.textContent=`(${r})`,o.style.display="inline")}function f(){console.log("üéß Inicializando listeners de paquetes..."),window.addEventListener("paquete:creado",n=>{console.log("üéâ Paquete creado:",n.detail);const{codigoPaquete:r,etiquetaIds:o}=n.detail;Array.isArray(o)&&o.forEach(q=>{v(q,"en-paquete",r)})}),window.addEventListener("paquete:actualizado",n=>{console.log("üîÑ Paquete actualizado:",n.detail);const{paqueteId:r,etiquetaCodigo:o,eliminada:q}=n.detail;q?v(o,"pendiente"):fetch(`/api/paquetes/${r}`).then(t=>t.json()).then(t=>{t.success&&t.paquete&&v(o,"en-paquete",t.paquete.codigo)}).catch(t=>console.error("Error al obtener info del paquete:",t))}),window.addEventListener("paquete:eliminado",n=>{console.log("üóëÔ∏è Evento paquete:eliminado recibido:",n.detail)}),console.log("‚úÖ Listeners de paquetes inicializados")}m.GestionPaquetesDOM={actualizarEstadoEtiquetaPaquete:v,actualizarInfoPaqueteEnEtiqueta:g,inicializarListenersPaquetes:f},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f()})(window);
