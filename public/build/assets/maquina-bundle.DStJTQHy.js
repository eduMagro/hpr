const Vt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Ut="rgba(0, 0, 0, 1)";function Ht(S,c){return!c||c===1?S.map(r=>({...r})):S.map(r=>r.type==="line"?{...r,length:(r.length||0)*c}:r.type==="arc"?{...r,radius:(r.radius||0)*c}:{...r})}const Yt=.75,Tt=14,Wt=60,Ft=[0,10,-10,20,-20,30,-30];function X(S){return S*Math.PI/180}function Jt(S){const c=S.closest(".proceso");return c&&getComputedStyle(c).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Qt(S,c,r){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("viewBox","0 0 "+S+" "+c),s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.background=r||"#ffffff",s.style.shapeRendering="geometricPrecision",s.style.textRendering="optimizeLegibility",s.style.boxSizing="border-box",s}function Kt(S,c,r,s){const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",c),i.setAttribute("stroke",r),i.setAttribute("fill","none"),i.setAttribute("stroke-width",s),i.setAttribute("vector-effect","non-scaling-stroke"),S.appendChild(i),i}function zt(S){let c="",r=Number(S)||0;for(;r>=0;){const s=r%26;c=String.fromCharCode(65+s)+c,r=Math.floor(r/26)-1}return c}const Zt=0,te=-25;function ee(S,c,r,s){if(!c||!c.length)return;const i=2,b=12,w=b+i,q=c.map(a=>(a.letter?a.letter+" ":"")+(a.text||"")),p=b*q.length+i*(q.length-1),x=Zt;let t=s-te-p+b/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let a=0;a<q.length;a++){const o=q[a],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",x),d.setAttribute("y",t),d.setAttribute("fill",Ut),d.setAttribute("font-size",b),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=o,S.appendChild(d);const u=Lt(o,b).w;window.__legendBoxesGroup.push({left:x,right:x+u,top:t-b/2,bottom:t+b/2}),t+=w}}function oe(S){const c=(S||"").split(/\s+/).filter(Boolean),r=[];for(let s=0;s<c.length;s++){const i=c[s];if(i.endsWith("r")){const b=parseFloat(i.slice(0,-1));let w=360;s+1<c.length&&c[s+1].endsWith("d")&&(w=parseFloat(c[++s].slice(0,-1))),r.push({type:"arc",radius:b,arcAngle:w})}else i.endsWith("d")?r.push({type:"turn",angle:parseFloat(i.slice(0,-1))}):r.push({type:"line",length:parseFloat(i)})}return r}function ae(S){let c=[],r=0,s=0,i=0;c.push({x:r,y:s});for(let b=0;b<S.length;b++){const w=S[b];if(w.type==="line")r+=w.length*Math.cos(X(i)),s+=w.length*Math.sin(X(i)),c.push({x:r,y:s});else if(w.type==="turn")i+=w.angle;else if(w.type==="arc"){const q=r+w.radius*Math.cos(X(i+90)),p=s+w.radius*Math.sin(X(i+90)),x=Math.atan2(s-p,r-q),t=x+X(w.arcAngle);r=q+w.radius*Math.cos(t),s=p+w.radius*Math.sin(t),i+=w.arcAngle,c.push({x:r,y:s})}}return c}function Rt(S){let c=[],r=0,s=0,i=0;for(let b=0;b<S.length;b++){const w=S[b];if(w.type==="line"){const q={x:r,y:s},p={x:r+w.length*Math.cos(X(i)),y:s+w.length*Math.sin(X(i))};c.push({start:q,end:p,length:w.length}),r=p.x,s=p.y}else if(w.type==="turn")i+=w.angle;else if(w.type==="arc"){const q=r+w.radius*Math.cos(X(i+90)),p=s+w.radius*Math.sin(X(i+90)),x=Math.atan2(s-p,r-q),t=x+X(w.arcAngle);r=q+w.radius*Math.cos(t),s=p+w.radius*Math.sin(t),i+=w.arcAngle}}return c}function Lt(S,c){const r=c||12;return{w:(S?S.length:0)*r*.55,h:r}}function it(S,c,r){const s=r||0;return!(S.right+s<c.left||S.left-s>c.right||S.bottom+s<c.top||S.top-s>c.bottom)}function Nt(S,c,r,s){const i=c/2;return Math.max(r+i,Math.min(s-i,S))}function ne(S,c){const s=[];let i=0;function b(){i>1e-9&&(s.push({type:"line",length:i}),i=0)}for(let w=0;w<S.length;w++){const q=S[w];if(q.type==="line"){i+=q.length;continue}if(q.type==="turn"){if(Math.abs(q.angle)<1e-9)continue;b(),s.push(q);continue}if(q.type==="arc"){b(),s.push(q);continue}b(),s.push(q)}return b(),s}function Xt(S,c){const r=c&&c.decimals||0,s=c&&c.step||null;let i=Number(S||0);return s&&s>0&&(i=Math.round(i/s)*s),i.toFixed(r).replace(/\.0+$/,"")}function ie(S,c){const r=Math.hypot(S,c)||1;let s=S/r,i=c/r;return(i<-1e-9||Math.abs(i)<=1e-9&&s<0)&&(s=-s,i=-i),{ux:s,uy:i}}function jt(S,c,r){const s=r||.01,i=ie(S,c),b=Math.round(i.ux/s)*s,w=Math.round(i.uy/s)*s;return b+"|"+w}function se(S,c,r){const s=r&&r.dirPrecision||.01,i=r&&r.labelFormat||{decimals:0,step:null},b=S.reduce((d,u)=>d+Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y),0),w=c.reduce((d,u)=>d+(u.length||Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y)),0),q=w>0?b/w:1,p=new Map;for(let d=0;d<c.length;d++){const u=c[d],h=u.end.x-u.start.x,l=u.end.y-u.start.y,e=jt(h,l,s),n=p.get(e)||[];n.push({length:u.length||Math.hypot(h,l),index:d}),p.set(e,n)}const x=c.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),t=new Set,a=new Set,o=[];for(let d=0;d<S.length;d++){const u=S[d],h=u.end.x-u.start.x,l=u.end.y-u.start.y,e=jt(h,l,s),n=p.get(e)||[],f=Math.hypot(h,l);let g=f;if(n.length){const A=f/q;let y=null,E=1/0;for(const _ of n){const B=Math.abs(_.length-A),L=a.has(_.index)?.1:0;B+L<E&&(y=_,E=B+L)}y&&(g=y.length,a.add(y.index))}else d<x.length&&(g=x[d]);const m=Xt(g,i),v=e+"|"+m;t.has(v)||(t.add(v),o.push({start:u.start,end:u.end,_dirKey:e,_label:m,_lenChosen:g}))}return o}function re(S,c){const r=c,s=S.map(l=>Object.assign({},l));let i=0,b=0,w=0;const q=[];let p=null,x=-1,t=-1;const a=1e-7;function o(l){return l*Math.PI/180}function d(l){return Math.abs(Math.sin(o(l)))<1e-12}function u(l,e,n,f){return Math.min(e,f)-Math.max(l,n)>a}for(let l=0;l<s.length;l++){let n=function(){const A={x:Math.cos(o(w)),y:Math.sin(o(w))},y=i+s[l].length*A.x,E=b+s[l].length*A.y,_=d(w);for(let B=0;B<q.length;B++){const L=q[B];if(_&&L.horiz&&Math.abs(b-L.y)<a){if(u(Math.min(i,y),Math.max(i,y),Math.min(L.x1,L.x2),Math.max(L.x1,L.x2))&&p&&x>=0&&t>=0)return s[t].length+=r,i+=p.x*r,b+=p.y*r,q[x].x2+=p.x*r,q[x].y2+=p.y*r,!0}else if(!_&&!L.horiz&&Math.abs(i-L.x)<a&&u(Math.min(b,E),Math.max(b,E),Math.min(L.y1,L.y2),Math.max(L.y1,L.y2))&&p&&x>=0&&t>=0)return s[t].length+=r,i+=p.x*r,b+=p.y*r,q[x].x2+=p.x*r,q[x].y2+=p.y*r,!0}return!1};var h=n;const e=s[l];if(e.type==="turn"){w+=e.angle;continue}if(e.type==="arc"){const A=i+e.radius*Math.cos(o(w+90)),y=b+e.radius*Math.sin(o(w+90)),E=Math.atan2(b-y,i-A),_=E+o(e.arcAngle);i=A+e.radius*Math.cos(_),b=y+e.radius*Math.sin(_),w+=e.arcAngle,p=null;continue}for(;n(););const f={x:Math.cos(o(w)),y:Math.sin(o(w))},g=i+s[l].length*f.x,m=b+s[l].length*f.y,v=d(w);q.push({x1:i,y1:b,x2:g,y2:m,horiz:v,y:b,x:i}),p=f,x=q.length-1,t=l,i=g,b=m}return s}function St(S,c,r,s){const i=X(s),b=Math.cos(i),w=Math.sin(i),q=S.x-c,p=S.y-r;return{x:c+q*b-p*w,y:r+q*w+p*b}}function ce(S,c,r,s,i,b,w,q,p){let x="",t=0,a=0,o=0,d=!1;function u(l,e){const n=St({x:l,y:e},c,r,s);return{x:q+(n.x-b)*i,y:p+(n.y-w)*i}}function h(){if(!d){const l=u(t,a);x+="M "+l.x+" "+l.y,d=!0}}for(let l=0;l<S.length;l++){const e=S[l];if(e.type==="turn"){o+=e.angle;continue}if(e.type==="line"){const n=t+e.length*Math.cos(X(o)),f=a+e.length*Math.sin(X(o));h();const g=u(n,f);x+=" L "+g.x+" "+g.y,t=n,a=f;continue}if(e.type==="arc"){const n=t+e.radius*Math.cos(X(o+90)),f=a+e.radius*Math.sin(X(o+90)),g=Math.atan2(a-f,t-n),m=g+X(e.arcAngle),v=n+e.radius*Math.cos(m),A=f+e.radius*Math.sin(m),y=Math.abs(e.arcAngle)%360;if(h(),y<1e-6||Math.abs(e.arcAngle)>=359.9){const O=g+Math.sign(e.arcAngle)*Math.PI,z=n+e.radius*Math.cos(O),M=f+e.radius*Math.sin(O),C=u(z,M),I=u(t,a),$=e.radius*i,D=e.arcAngle>=0?1:0;x+=" A "+$+" "+$+" 0 1 "+D+" "+C.x+" "+C.y,x+=" A "+$+" "+$+" 0 1 "+D+" "+I.x+" "+I.y,o+=e.arcAngle;continue}const E=u(v,A),_=e.radius*i,B=y>180?1:0,L=e.arcAngle>=0?1:0;x+=" A "+_+" "+_+" 0 "+B+" "+L+" "+E.x+" "+E.y,t=v,a=A,o+=e.arcAngle}}return x||"M 0 0"}function le(S){const c=ae(S);let r=Math.min(...c.map(h=>h.x)),s=Math.max(...c.map(h=>h.x)),i=Math.min(...c.map(h=>h.y)),b=Math.max(...c.map(h=>h.y));const w=(r+s)/2,q=(i+b)/2,x=b-i>s-r?-90:0,t=c.map(h=>St(h,w,q,x));r=Math.min(...t.map(h=>h.x)),s=Math.max(...t.map(h=>h.x)),i=Math.min(...t.map(h=>h.y)),b=Math.max(...t.map(h=>h.y));const a=Math.max(1,s-r),o=Math.max(1,b-i),d=(r+s)/2,u=(i+b)/2;return{rotDeg:x,w:a,h:o,cxModel:w,cyModel:q,midX:d,midY:u,ptsRot:t}}function de(S){const c=[];let r=0,s=0,i=0;function b(w){const q=X(w);return{x:Math.cos(q),y:Math.sin(q)}}for(let w=0;w<S.length;w++){const q=S[w];if(q.type==="line")r+=q.length*Math.cos(X(i)),s+=q.length*Math.sin(X(i));else if(q.type==="turn"){const p=b(i),x=q.angle;i+=x;const t=b(i);c.push({x:r,y:s,angleDeg:x,prevDir:p,nextDir:t})}else if(q.type==="arc"){const p=r+q.radius*Math.cos(X(i+90)),x=s+q.radius*Math.sin(X(i+90)),t=Math.atan2(s-x,r-p),a=t+X(q.arcAngle);r=p+q.radius*Math.cos(a),s=x+q.radius*Math.sin(a),i+=q.arcAngle}}return c}function ue(S,c,r){const s=Array.from({length:c},()=>({sumH:0,maxW:0,items:[]})),i=[...S.keys()].sort((b,w)=>S[w].h-S[b].h);for(const b of i){let w=0,q=1/0;for(let x=0;x<c;x++){const t=s[x],a=t.sumH+(t.items.length>0?r:0)+S[b].h;a<q&&(q=a,w=x)}const p=s[w];p.sumH=p.items.length>0?p.sumH+r+S[b].h:p.sumH+S[b].h,p.maxW=Math.max(p.maxW,S[b].w),p.items.push(b)}return s}function pe(S,c,r,s={}){const i=s.padding??12,b=s.gapCol??12,w=s.gapRow??10,q=Math.max(1,Math.min(S.length,s.kMax??4)),p=Math.max(10,c-2*i),x=Math.max(10,r-2*i),t=a(S);function a(n){const f=n.map($=>$.w/Math.max($.h,1)),g=n.map($=>$.h),m=n.map($=>$.w),v=n.map($=>$.w*$.h),A=$=>$.reduce((D,F)=>D+F,0)/$.length,y=($,D)=>$.reduce((F,P)=>F+Math.pow(P-D,2),0)/$.length,E=($,D)=>Math.sqrt(y($,D)),_=A(f),B=A(g),L=A(m),O=v.reduce(($,D)=>$+D,0),z=E(g,B),M=E(m,L),C=B>0?z/B:0,I=L>0?M/L:0;return{avgAspectRatio:_,avgHeight:B,avgWidth:L,totalArea:O,heightCV:C,widthCV:I,isLinear:_>6||B<L*.12,isUniformHeight:C<.15,isUniformWidth:I<.15,isHighlyVariable:C>.5||I>.5,count:n.length}}let o={S:0,k:1,cols:null,score:0};for(let n=1;n<=q;n++){const f=ue(S,n,w),g=f.reduce((P,J)=>P+J.maxW,0)+b*(n-1),m=Math.max(...f.map(P=>P.sumH));if(g<=0||m<=0)continue;const v=p/g,A=x/m,y=Math.min(v,A),E=Math.max(.01,y*.92),_=t.totalArea*E*E,B=p*x,L=_/B,O=f.map(P=>P.sumH*E),z=O.reduce((P,J)=>P+J,0)/n,M=Math.max(...O)-Math.min(...O),C=z>0?1-M/z:1,I=n===1?1.1:n===2?.9:.7,$=n>t.count*.5?.7:1,D=C>.85?1.05:1,F=E*(1+L*.25)*(1+C*.1)*I*$*D;F>o.score&&(o={S:E,k:n,cols:f,score:F,efficiency:L,colBalance:C})}const d=o.cols.map(n=>n.maxW*o.S),u=d.reduce((n,f)=>n+f,0);let h=[];if(o.k===1)h[0]=c/2;else{const n=(o.k-1)*b,f=u+n;if(f<p){const g=p-f,m=b+g/(o.k-1);let v=i;for(let A=0;A<o.k;A++)h[A]=v+d[A]/2,v+=d[A]+m}else{let g=i+Math.max(0,(p-f)/2);for(let m=0;m<o.k;m++)h[m]=g+d[m]/2,g+=d[m]+b}}const l=[],e=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(n=>n.right));for(let n=0;n<o.k;n++){const f=o.cols[n];l[n]=[];const g=f.items.map(M=>S[M].h*o.S),m=g.reduce((M,C)=>M+C,0);if(f.items.length===0)continue;const v=h[n],A=o.cols[n].maxW*o.S,y=v-A/2,E=v+A/2,_=e(),L=Math.max(0,Math.min(E,_)-y)/A,O=L>.05;let z=x;if(O&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const C=Math.min(...window.__legendBoxesGroup.map(I=>I.top))-15;z=Math.max(10,C-i),console.log(`üìè Columna ${n}: X=${y.toFixed(0)}-${E.toFixed(0)}, legendWidth=${_.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura reducida a ${z.toFixed(0)}px`)}else console.log(`üìè Columna ${n}: X=${y.toFixed(0)}-${E.toFixed(0)}, legendWidth=${_.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura completa ${z.toFixed(0)}px`);if(f.items.length===1){const M=g[0],C=i+z/2,I=Math.max(i+M/2,Math.min(C,r-i-M/2));l[n].push(I);continue}if(m>z){console.warn(`Columna ${n}: elementos no caben (${m}px > ${z}px)`);const I=m/f.items.length<4?20:5;let $=i;for(let D=0;D<f.items.length;D++){const F=Math.max(g[D],2),P=$+F/2;l[n].push(P),$+=F+I}}else{const M=z-m,C=f.items.length-1;let I=M/C;m/f.items.length<4?I=Math.max(18,Math.min(I,50)):I=Math.max(5,I);const F=m+C*I,P=z-F;let J=i+Math.max(0,P/2);for(let pt=0;pt<f.items.length;pt++){const k=Math.max(g[pt],2),R=J+k/2,st=i+z-k/2,T=Math.max(i+k/2,Math.min(R,st));l[n].push(T),J+=k+I}}}return{S:o.S,k:o.k,cols:o.cols,centersX:h,centersYByCol:l,padding:i,gapRow:w,gapCol:b}}window.renderizarGrupoSVG=function(c,r){const s=c&&c.etiqueta&&c.etiqueta.id!=null?c.etiqueta.id:c&&c.id!=null?c.id:r,i=document.getElementById("contenedor-svg-"+s);if(!i)return;const b=600,w=150,q=Jt(i),p=Qt(b,w,q);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const x=[],t=new Map;(c.elementos||[]).forEach(l=>{var g,m,v,A,y,E;let e="0";if(l.diametro!=null&&l.diametro!==""){const B=String(l.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(B){const L=parseFloat(B[0]);isFinite(L)&&(e=String(Math.round(L)))}}const n=(l.dimensiones||"barra").trim().toLowerCase(),f=`${e}|${n}`;if(t.has(f)){const _=t.get(f);x[_].barrasTotal+=l.barras||0,(g=l.coladas)!=null&&g.colada1&&!x[_].coladasSet.has(l.coladas.colada1)&&x[_].coladasSet.add(l.coladas.colada1),(m=l.coladas)!=null&&m.colada2&&!x[_].coladasSet.has(l.coladas.colada2)&&x[_].coladasSet.add(l.coladas.colada2),(v=l.coladas)!=null&&v.colada3&&!x[_].coladasSet.has(l.coladas.colada3)&&x[_].coladasSet.add(l.coladas.colada3)}else{const _=new Set;(A=l.coladas)!=null&&A.colada1&&_.add(l.coladas.colada1),(y=l.coladas)!=null&&y.colada2&&_.add(l.coladas.colada2),(E=l.coladas)!=null&&E.colada3&&_.add(l.coladas.colada3),x.push({elemento:l,diametro:e,dimensiones:l.dimensiones,barrasTotal:l.barras||0,coladasSet:_}),t.set(f,x.length-1)}});const a=x.map((l,e)=>{const n=[];c.colada_etiqueta&&n.push(c.colada_etiqueta),c.colada_etiqueta_2&&c.colada_etiqueta_2!==c.colada_etiqueta&&n.push(c.colada_etiqueta_2),n.length===0&&l.coladasSet.size>0&&n.push(...l.coladasSet);const f=n.length>0?` (${n.join(", ")})`:"";return{letter:zt(e),text:`√ò${l.diametro} x${l.barrasTotal}${f}`}});ee(p,a,b,w);const o=x.map(l=>{const e=l.elemento,n=oe(e.dimensiones||""),f=ne(n);let g=0;for(const E of f)E.type==="line"&&(g=Math.max(g,Math.abs(E.length||0))),E.type==="arc"&&(g=Math.max(g,Math.abs(E.radius||0)));const v=g<=50?2:1,A=Ht(f,v),y=le(A);return{dimsRaw:n,dimsNoZero:f,dimsScaled:A,geomScale:v,medida:y}}),d=o.map(l=>l.medida),u=pe(d,b,w,{padding:20,gapCol:50,gapRow:22,kMax:3}),h=new Map;for(let l=0;l<u.k;l++)u.cols[l].items.forEach((e,n)=>h.set(e,{c:l,j:n}));x.forEach(function(l,e){const n=l.elemento,{dimsNoZero:f,dimsScaled:g,medida:m}=o[e],v=h.get(e),A=u.centersX[v.c],y=u.centersYByCol[v.c][v.j],E=u.S,_=m.ptsRot.map(k=>({x:A+(k.x-m.midX)*E,y:y+(k.y-m.midY)*E})),B=Math.min(..._.map(k=>k.x)),L=Math.max(..._.map(k=>k.x)),O=Math.min(..._.map(k=>k.y)),z=Math.max(..._.map(k=>k.y)),M={left:B,right:L,top:O,bottom:z};window.__figBoxesGroup.push({...M});const C=re(g,.6),I=ce(C,m.cxModel,m.cyModel,m.rotDeg,E,m.midX,m.midY,A,y),$=Kt(p,I,Vt,2);(function(){const R=de(g);function st(N){return Math.abs(Math.abs(N)-90)>=Yt}const T=(N,G)=>St({x:N.x,y:N.y},0,0,G),Q=(N,G)=>{const K=St({x:N,y:G},m.cxModel,m.cyModel,m.rotDeg);return{x:A+(K.x-m.midX)*E,y:y+(K.y-m.midY)*E}},j=N=>Math.max(10,Math.min(28,N));R.forEach(N=>{if(!st(N.angleDeg))return;const G=Q(N.x,N.y),K=T(N.prevDir,m.rotDeg),gt=T(N.nextDir,m.rotDeg),Z=Math.atan2(K.y,K.x),V=Z+X(N.angleDeg),tt=Math.min(M.right-M.left,M.bottom-M.top);let U=j(.12*tt);const wt=G.x+U*Math.cos(Z),ht=G.y+U*Math.sin(Z),W=G.x+U*Math.cos(V),yt=G.y+U*Math.sin(V),et=Math.abs(N.angleDeg),ct=et>180?1:0,Mt=N.angleDeg>=0?1:0,lt=document.createElementNS("http://www.w3.org/2000/svg","path");lt.setAttribute("d",`M ${wt} ${ht} A ${U} ${U} 0 ${ct} ${Mt} ${W} ${yt}`),lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.setAttribute("fill","none"),lt.style.pointerEvents="none",p.appendChild(lt);let H=K.x+gt.x,Y=K.y+gt.y;et>180&&(H=-H,Y=-Y);let ot=Math.hypot(H,Y);if(ot<1e-6){const ut=N.angleDeg>=0?1:-1;H=-K.y*ut,Y=K.x*ut,ot=Math.hypot(H,Y)||1}H/=ot,Y/=ot;const at=(Math.round(N.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",nt=Lt(at,14);function At(ut,mt){return{left:ut-nt.w/2,right:ut+nt.w/2,top:mt-nt.h/2,bottom:mt+nt.h/2}}let rt=null;for(let ut=Tt;ut<=Wt&&!rt;ut+=4)for(let mt=0;mt<Ft.length&&!rt;mt++){const xt=Ft[mt],Et=T({x:H,y:Y},xt),_t=G.x+Et.x*(U+ut),ft=G.y+Et.y*(U+ut),bt=At(_t,ft);bt.top<0||bt.bottom>w||bt.left<0||bt.right>b||window.__figBoxesGroup.some(qt=>it(qt,bt,6))||(window.__dimBoxesGroup||[]).some(qt=>it(qt,bt,2))||(window.__angleBoxesGroup||[]).some(qt=>it(qt,bt,2))||(window.__placedLetterBoxes||[]).some(qt=>it(qt,bt,2))||(window.__legendBoxesGroup||[]).some(qt=>it(qt,bt,6))||(rt={x:_t,y:ft,box:bt})}if(!rt){const ut=G.x+H*(U+Tt),mt=G.y+Y*(U+Tt),xt=At(ut,mt);rt={x:ut,y:mt,box:xt}}window.__angleBoxesGroup.push(rt.box);const dt=document.createElementNS("http://www.w3.org/2000/svg","text");dt.setAttribute("x",rt.x),dt.setAttribute("y",rt.y),dt.setAttribute("fill",Bt),dt.setAttribute("font-size",14),dt.setAttribute("text-anchor","middle"),dt.setAttribute("alignment-baseline","middle"),dt.style.cursor="pointer",dt.textContent=at,p.appendChild(dt),dt.addEventListener("mouseenter",()=>{lt.setAttribute("stroke","rgba(255,69,0,1)"),lt.setAttribute("stroke-width","3"),lt.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),dt.addEventListener("mouseleave",()=>{lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.style.filter="none"})})})();const D=$.cloneNode(!1);D.setAttribute("stroke-width","50"),D.setAttribute("stroke","transparent"),D.setAttribute("fill","none"),D.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(k=>{D.addEventListener(k,R=>$.dispatchEvent(new R.constructor(R.type,R)))}),p.insertBefore(D,$),(n.codigo!=null?n.codigo:n.id)+"",$.style.cursor="pointer",$.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),$.addEventListener("click",function(k){if(k.ctrlKey||k.metaKey||k.shiftKey){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(n.id);return}abrirModalDividirElemento(n.id,n.barras||0)}),$.addEventListener("contextmenu",function(k){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(n.id)});const F=[],P=Rt(C),J=Rt(f);se(P,J,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(k){const R=St(k.start,m.cxModel,m.cyModel,m.rotDeg),st=St(k.end,m.cxModel,m.cyModel,m.rotDeg),T={x:A+(R.x-m.midX)*E,y:y+(R.y-m.midY)*E},Q={x:A+(st.x-m.midX)*E,y:y+(st.y-m.midY)*E},j=k._label,N=Q.x-T.x,G=Q.y-T.y,K=Math.hypot(N,G)||1,gt=N/K,Z=G/K,V=G/K,tt=-N/K,U=(T.x+Q.x)/2,wt=(T.y+Q.y)/2,ht=U+V*10,W=wt+tt*10,yt=Lt(j,14),et=yt.w,ct=yt.h;function Mt(rt,dt){return{left:rt-et/2,right:rt+et/2,top:dt-ct/2,bottom:dt+ct/2}}const lt=K*.45;let H=ht,Y=W;for(let rt=0;rt<=Math.ceil(lt/6);rt++){const dt=rt%2===0?1:-1,ut=Math.ceil(rt/2),mt=dt*ut*6;if(Math.abs(mt)>lt)continue;const xt=ht+gt*mt,Et=W+Z*mt,_t=(xt-T.x)*gt+(Et-T.y)*Z;if(_t<0+et*.3||_t>K-et*.3)continue;const ft=Mt(xt,Et);if(!(it({left:Math.min(T.x,Q.x),right:Math.max(T.x,Q.x),top:Math.min(T.y,Q.y),bottom:Math.max(T.y,Q.y)},ft,0)||(window.__angleBoxesGroup||[]).some(vt=>it(vt,ft,2))||(window.__legendBoxesGroup||[]).some(vt=>it(vt,ft,6))||F.some(vt=>it(vt,ft,2))||ft.top<0||ft.bottom>w||ft.left<0||ft.right>b)){H=xt,Y=Et,F.push(ft),window.__dimBoxesGroup.push(ft);break}}const ot=document.createElementNS("http://www.w3.org/2000/svg","line");ot.setAttribute("x1",T.x),ot.setAttribute("y1",T.y),ot.setAttribute("x2",Q.x),ot.setAttribute("y2",Q.y),ot.setAttribute("stroke","rgba(0,0,255,0.6)"),ot.setAttribute("stroke-width","4"),ot.setAttribute("stroke-linecap","round"),ot.setAttribute("vector-effect","non-scaling-stroke"),ot.style.opacity=0,ot.style.pointerEvents="none",ot.style.transition="opacity 120ms ease",p.appendChild(ot);const at=document.createElementNS("http://www.w3.org/2000/svg","text");at.setAttribute("x",H),at.setAttribute("y",Y),at.setAttribute("fill",Bt),at.setAttribute("font-size",14),at.setAttribute("text-anchor","middle"),at.setAttribute("alignment-baseline","middle"),at.setAttribute("tabindex","0"),at.style.cursor="pointer",at.textContent=j,p.appendChild(at);function nt(){ot.style.opacity=1}function At(){ot.style.opacity=0}at.addEventListener("mouseenter",nt),at.addEventListener("mouseleave",At),at.addEventListener("focus",nt),at.addEventListener("blur",At)}),function(){const R=[];let st=0,T=0,Q=0;for(let j=0;j<g.length;j++){const N=g[j];if(N.type==="line")st+=N.length*Math.cos(X(Q)),T+=N.length*Math.sin(X(Q));else if(N.type==="turn")Q+=N.angle;else if(N.type==="arc"){const G=st+N.radius*Math.cos(X(Q+90)),K=T+N.radius*Math.sin(X(Q+90)),gt=Math.atan2(T-K,st-G),Z=gt+X(N.arcAngle);let V=N.radius;for(let tt=0;tt<f.length;tt++){const U=f[tt];if(U.type==="arc"&&Math.abs(U.arcAngle-N.arcAngle)<.01){V=U.radius;break}}R.push({center:{x:G,y:K},radius:N.radius,originalRadius:V,arcAngle:N.arcAngle,startAngle:gt,endAngle:Z}),st=G+N.radius*Math.cos(Z),T=K+N.radius*Math.sin(Z),Q+=N.arcAngle}}R.forEach(function(j){const N=St(j.center,m.cxModel,m.cyModel,m.rotDeg),G={x:A+(N.x-m.midX)*E,y:y+(N.y-m.midY)*E},K=(j.startAngle+j.endAngle)/2,gt=j.radius*E,Z="R"+Xt(j.originalRadius,{decimals:0,step:null}),V=Lt(Z,14),tt=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let U=!1,wt,ht,W;for(let nt=0;nt<tt.length&&!U;nt++){const At=tt[nt],rt=K+X(At),dt={x:j.center.x+j.radius*Math.cos(rt),y:j.center.y+j.radius*Math.sin(rt)},ut=St(dt,m.cxModel,m.cyModel,m.rotDeg),mt={x:A+(ut.x-m.midX)*E,y:y+(ut.y-m.midY)*E},xt=mt.x-G.x,Et=mt.y-G.y,_t=Math.hypot(xt,Et)||1,ft=xt/_t,bt=Et/_t;for(let Ct=8;Ct<=60&&!U;Ct+=6){const $t=gt*.7;if(wt=G.x+ft*$t+ft*Ct,ht=G.y+bt*$t+bt*Ct,W={left:wt-V.w/2,right:wt+V.w/2,top:ht-V.h/2,bottom:ht+V.h/2},!(W.top<0||W.bottom>w||W.left<0||W.right>b||window.__figBoxesGroup.some(It=>it(It,W,2))||(window.__legendBoxesGroup||[]).some(It=>it(It,W,2)))){U=!0;break}}}if(!U)return;F.push(W);const yt={x:wt-G.x,y:ht-G.y},et=Math.hypot(yt.x,yt.y)||1,ct={x:yt.x/et,y:yt.y/et},Mt=G.x+ct.x*gt*.6,lt=G.y+ct.y*gt*.6,H=document.createElementNS("http://www.w3.org/2000/svg","line");H.setAttribute("x1",G.x),H.setAttribute("y1",G.y),H.setAttribute("x2",Mt),H.setAttribute("y2",lt),H.setAttribute("stroke","rgba(0,128,0,0.6)"),H.setAttribute("stroke-width","4"),H.setAttribute("stroke-linecap","round"),H.setAttribute("vector-effect","non-scaling-stroke"),H.style.opacity=0,H.style.pointerEvents="none",H.style.transition="opacity 120ms ease",p.appendChild(H);const Y=document.createElementNS("http://www.w3.org/2000/svg","text");Y.setAttribute("x",wt),Y.setAttribute("y",ht),Y.setAttribute("fill",Bt),Y.setAttribute("font-size",14),Y.setAttribute("text-anchor","middle"),Y.setAttribute("alignment-baseline","middle"),Y.setAttribute("tabindex","0"),Y.style.cursor="pointer",Y.textContent=Z,p.appendChild(Y);function ot(){H.style.opacity=1}function at(){H.style.opacity=0}Y.addEventListener("mouseenter",ot),Y.addEventListener("mouseleave",at),Y.addEventListener("focus",ot),Y.addEventListener("blur",at)})}(),function(){const R=zt(e),st=14,T=Lt(R,st);function Q(V,tt){return{left:V,right:V+T.w,top:tt-T.h/2,bottom:tt+T.h/2}}let j=null;const N=(M.top+M.bottom)/2,G=Math.max(T.h/2,Math.min(N,w-T.h/2));function K(V){for(let U=0;U<=30;U+=4){const wt=U%2===0?1:-1,ht=Math.ceil(U/2),W=wt*ht*4,yt=Math.max(T.h/2,Math.min(w-T.h/2,G+W)),et=V,ct=Q(et,yt);if(!(window.__figBoxesGroup.some(nt=>it(nt,ct,6))||(window.__dimBoxesGroup||[]).some(nt=>it(nt,ct,3))||(window.__angleBoxesGroup||[]).some(nt=>it(nt,ct,3))||(window.__legendBoxesGroup||[]).some(nt=>it(nt,ct,6))||(window.__placedLetterBoxes||[]).some(nt=>it(nt,ct,2))||ct.top<0||ct.bottom>w||ct.left<0||ct.right>b))return j={x:et,y:yt,box:ct},!0}return!1}const gt=[{x:M.right+10,priority:1},{x:M.left-10-T.w,priority:1},{x:M.right+15,priority:2},{x:M.left-15-T.w,priority:2},{x:M.right+5,priority:2},{x:M.left-5-T.w,priority:2},{x:M.right+20,priority:3},{x:M.left-20-T.w,priority:3},{x:M.right+25,priority:3},{x:M.left-25-T.w,priority:3},{x:M.right+30,priority:3},{x:M.left-30-T.w,priority:3}];gt.sort((V,tt)=>V.priority-tt.priority);for(const V of gt){if(j)break;const tt=Nt(V.x,T.w,0,b);if(K(tt))break}if(!j){const V=(M.left+M.right)/2,tt=[{x:V-T.w/2,y:M.top-T.h-5},{x:V-T.w/2,y:M.bottom+T.h+5}];for(const U of tt){if(j)break;const wt=Nt(U.x,T.w,0,b),ht=Math.max(T.h/2,Math.min(w-T.h/2,U.y)),W=Q(wt,ht);!window.__figBoxesGroup.some(et=>it(et,W,6))&&!(window.__dimBoxesGroup||[]).some(et=>it(et,W,3))&&!(window.__angleBoxesGroup||[]).some(et=>it(et,W,3))&&!(window.__legendBoxesGroup||[]).some(et=>it(et,W,6))&&!(window.__placedLetterBoxes||[]).some(et=>it(et,W,2))&&W.top>=0&&W.bottom<=w&&W.left>=0&&W.right<=b&&(j={x:wt,y:ht,box:W})}}if(!j){const V=Nt(b-T.w,T.w,0,b),tt=G;j={x:V,y:tt,box:Q(V,tt)}}window.__placedLetterBoxes.push(j.box);const Z=document.createElementNS("http://www.w3.org/2000/svg","text");Z.setAttribute("x",j.x),Z.setAttribute("y",j.y),Z.setAttribute("fill",Ut),Z.setAttribute("font-size",st),Z.setAttribute("text-anchor","start"),Z.setAttribute("alignment-baseline","middle"),Z.style.fontWeight="600",Z.style.pointerEvents="none",Z.textContent=R,p.appendChild(Z)}()}),i.innerHTML="",i.appendChild(p)};function Pt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const S=window.elementosAgrupadosScript;if(!S)return;const c=document.getElementById("grid-maquina");if(c&&window.updateGridClasses){const r=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,s),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}S.forEach(function(r,s){renderizarGrupoSVG(r,s)}),requestAnimationFrame(()=>{c&&(c.style.opacity="1",c.style.visibility="visible",c.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",c.className)),document.querySelectorAll(".proceso").forEach(r=>{r.style.opacity="1"})}),window.actualizarSVGConColadas=function(r,s){if(!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,b=i.findIndex(q=>q.etiqueta&&String(q.etiqueta.etiqueta_sub_id)===String(r));if(b===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${r}`);return}const w=i[b];w.elementos&&s&&w.elementos.forEach(q=>{const p=String(q.id),x=s[p];q.coladas||(q.coladas={colada1:null,colada2:null,colada3:null}),x&&Array.isArray(x)&&(q.coladas.colada1=x[0]||null,q.coladas.colada2=x[1]||null,q.coladas.colada3=x[2]||null)}),renderizarGrupoSVG(w,b),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${r}`,s)},window.limpiarColadasSVG=function(r){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,i=s.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(r));if(i===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${r}`);return}const b=s[i];b.elementos&&b.elementos.forEach(w=>{w.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(b,i),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${r}`)},window.addEventListener("regenerar-svg-etiqueta",function(r){var q;const s=(q=r.detail)==null?void 0:q.etiquetaSubId;if(!s||!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,b=i.findIndex(p=>p.etiqueta&&String(p.etiqueta.etiqueta_sub_id)===String(s));if(b===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${s}`);return}const w=i[b];renderizarGrupoSVG(w,b),console.log(`üîÑ SVG regenerado para etiqueta ${s} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pt):Pt();document.addEventListener("livewire:navigated",Pt);window.abrirModalDividirElemento=function(c,r){const s=document.getElementById("modalDividirElemento"),i=document.getElementById("dividir_elemento_id"),b=document.getElementById("dividir_barras_totales"),w=document.getElementById("dividir_peso_total"),q=document.getElementById("labelBarrasActuales"),p=document.getElementById("barras_a_mover"),x=document.getElementById("previewDivision"),t=document.getElementById("formDividirElemento"),a=document.getElementById("badgeSugerenciaPeso"),o=document.getElementById("barrasSugeridas"),d=document.getElementById("detalleSugerencia");if(!s||!i||!t)return;i.value=c;let u=null,h=parseInt(r)||0;if(window.elementosAgrupadosScript){for(const y of window.elementosAgrupadosScript)if(y.elementos){const E=y.elementos.find(_=>String(_.id)===String(c));if(E){u=E,E.barras&&(h=parseInt(E.barras)||0);break}}}if(!u&&window.gruposResumenData){for(const y of window.gruposResumenData)if(y.elementos){const E=y.elementos.find(_=>String(_.id)===String(c));if(E){u=E,E.barras&&(h=parseInt(E.barras)||0);break}}}const l=u&&u.estado==="fabricado",e=u&&u.paquete_id,n=l||e,f=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),g=f==null?void 0:f.closest("label");if(f){if(f.disabled=n,g)if(n){g.classList.add("opacity-50","cursor-not-allowed");let y=l?"El elemento ya est√° fabricado":"El elemento pertenece a un paquete";g.setAttribute("title",y)}else g.classList.remove("opacity-50","cursor-not-allowed"),g.removeAttribute("title");if(n&&f.checked){const y=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');y&&(y.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}b&&(b.value=h),q&&(q.textContent=h>0?h:"-");const m=u&&parseFloat(u.peso_numerico)||0;w&&(w.value=m),console.log("üîç Debug badge sugerencia:",{peso_numerico:u==null?void 0:u.peso_numerico,pesoTotal:m,barrasTotales:h});const v=1200,A=document.getElementById("divisionAutoData");if(a&&o&&h>0&&m>0){const y=m/h,E=Math.floor(v/y);if(m>v&&E<h){const _=Math.ceil(h/E),B=Math.floor(h/_),L=h%_;A&&(A.value=JSON.stringify({elemento_id:c,etiqueta_sub_id:(u==null?void 0:u.etiqueta_sub_id)||null,num_etiquetas:_,barras_por_etiqueta:B,etiquetas_con_barra_extra:L,barras_totales:h,peso_por_barra:y}));let O="";if(L===0)O=`${_} etiquetas de ${B} barras cada una (~${(B*y).toFixed(0)} kg)`;else{const z=B+1,M=B;O=`${L} etiqueta(s) de ${z} barras + ${_-L} etiqueta(s) de ${M} barras`}o.textContent=`${_} etiquetas`,d.innerHTML=O+`<br><span class="text-xs text-amber-600">Barras m√°x por etiqueta: ${E} (para no superar ${v} kg)</span>`,a.classList.remove("hidden")}else a.classList.add("hidden"),A&&(A.value="")}else a&&a.classList.add("hidden"),A&&(A.value="");p&&(p.value=""),x&&x.classList.add("hidden"),window.rutaDividirElemento&&t.setAttribute("action",window.rutaDividirElemento),s.classList.remove("hidden")};window.enviarDivision=async function(){const c=document.getElementById("formDividirElemento"),r=c.getAttribute("action")||window.rutaDividirElemento,s=new FormData(c);try{const i=document.querySelector('meta[name="csrf-token"]'),b=s.get("_token")||(i?i.getAttribute("content"):null),q=await fetch(r,{method:"POST",headers:b?{"X-CSRF-TOKEN":b}:{},body:s}),p=await q.json();if(!q.ok||!p.success)throw new Error(p.message||"Error al dividir");c.reset();const x=document.getElementById("modalDividirElemento");x&&x.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",p.message,"success"):alert(p.message)}catch(i){window.Swal?window.Swal.fire("Error",i&&i.message||"Error","error"):alert(i&&i.message||"Error")}};(function(S){const c={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},r={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function s(p,x,t={}){console.log(`üîÑ Actualizando etiqueta ${p} a estado: ${x}`);const a=String(p).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${a}`);if(!o)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${p}`),!1;const d=String(x).toLowerCase().trim(),u=r[d];if(!u)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${x}`),!1;o.dataset.estado=d,Array.from(o.classList).forEach(n=>{n.startsWith("estado-")&&o.classList.remove(n)}),o.classList.add(u.cssClass),o.style.setProperty("--bg-estado",u.bgColor);const l=o.querySelector('[id^="contenedor-svg-"]');if(l){const n=l.querySelector("svg");n&&(n.style.background=u.bgColor)}const e=o.querySelector(".etiqueta-card")||o;return e&&(e.style.background=u.bgColor),i(o,d),b(o),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:p,estado:d,datosExtra:t}})),console.log(`‚úÖ Etiqueta ${p} actualizada a ${x}`),!0}function i(p,x){const t=p.querySelectorAll(".btn-fabricar"),a=["empaquetada","en-paquete"];t.forEach(o=>{a.includes(x)?(o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed",o.title=`Etiqueta ya ${x}`):(o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer",o.title="Fabricar esta etiqueta")})}function b(p){p.style.transition="transform 0.5s ease, background-color 0.5s ease",p.style.transform="scale(1.03)",setTimeout(()=>{p.style.transform="scale(1)"},400)}function w(p,x,t={}){console.log(`üîÑ Actualizando ${p.length} etiquetas...`);const o=p.map(d=>s(d,x,t)).filter(d=>d).length;return console.log(`‚úÖ ${o}/${p.length} etiquetas actualizadas`),o}function q(p){const x=String(p).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${x}`);return t?{id:p,estado:t.dataset.estado||"desconocido",elemento:t}:null}window.addEventListener("paquete:creado",p=>{const{codigoPaquete:x,etiquetaIds:t}=p.detail;console.log(`üì¶ Evento paquete:creado recibido - ${x} con ${t.length} etiquetas`),w(t,"empaquetada",{codigo_paquete:x})}),S.SistemaDOM={actualizarEstadoEtiqueta:s,actualizarMultiplesEtiquetas:w,obtenerEstadoActual:q,ESTADOS_CONFIG:r},S.ColoresEstado={actualizar:(p,x)=>{c[p]=x;const t=document.getElementById("colores-estado-css");if(t){let a=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[o,d]of Object.entries(c))a+=`.proceso.estado-${o} {
    --bg-estado: ${d};
}
`;t.textContent=a,console.log(`‚úÖ Color actualizado para estado "${p}": ${x}`)}},obtenerColor:p=>c[p],todos:()=>({...c})}})(window);function Dt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const t=localStorage.getItem("decisionCortePorEtiqueta");t&&(window._decisionCortePorEtiqueta=JSON.parse(t),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(t){console.warn("No se pudieron restaurar decisiones de corte:",t)}document.addEventListener("click",async t=>{var f,g,m;const a=t.target.closest(".btn-fabricar");if(!a)return;t.preventDefault();const o=(g=(f=document.getElementById("maquina-info"))==null?void 0:f.dataset)==null?void 0:g.maquinaId;if(!o){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const d=a.dataset.grupoId;if(d){const v=a.disabled;a.disabled=!0;try{await c(d,o)}finally{a.disabled=v}return}const u=String(a.dataset.etiquetaId||"").trim(),h=u.replace(/\./g,"-"),l=document.querySelector(`#etiqueta-${h}`);if(l){const v=(l.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(v)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${u} ya est√° en estado ${v}.`,timer:2500,showConfirmButton:!1});return}}const e=Number(((m=window.DIAMETRO_POR_ETIQUETA)==null?void 0:m[u])??0);if(!u){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!e&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const n=a.disabled;a.disabled=!0;try{await S(u,o,e)}finally{a.disabled=n}});async function S(t,a,o=null){var A,y,E,_,B,L,O,z;const d=`/actualizar-etiqueta/${t}/maquina/${a}`,u=(A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"),h=t.replace(/\./g,"-"),e=(((E=(y=document.querySelector(`#etiqueta-${h}`))==null?void 0:y.dataset)==null?void 0:E.estado)||"").toLowerCase()==="fabricando",n=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",f=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",g=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",m=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:n,esSL28:f,esCortadoraManual:g,esCortadoraDobladoraBarra:m}),n&&f||g||m){if(e)if((_=window._decisionCortePorEtiqueta)!=null&&_[t]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:i,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const M=await fetch(`/api/etiquetas/${t}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":u}});if(M.ok){const C=await M.json();if(C.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:C.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],csrfToken:u,etiquetaId:t,onUpdate:i,pedirDesperdicio:!1});return}}}catch(M){console.warn("No se pudo obtener longitud asignada:",M)}for(;;){let M;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),M=await Cortes.mejorCorteSimple(t,o,u),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",M)}catch(C){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",C),x(C);return}if(!M){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",M.accion),M.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let C;try{C=await Cortes.mejorCorteOptimizado(t,o,M.patrones,u)}catch(I){x(I);return}if((C==null?void 0:C.accion)==="fabricar"){const I=((B=C.patronInfo)==null?void 0:B.desperdicio_cm)||((L=C.patron)==null?void 0:L.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:C.longitudBarraCm,etiquetas:C.etiquetas,desperdicioEstimadoCm:I},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:i});if($!=null&&$.cancelled)continue;return}else{if(C==="volver")continue;return}}if(M.accion==="fabricar_patron_simple"){const C=Math.round(Number(M.longitud_m||0)*100);if(!C){x("Longitud de barra no v√°lida.");return}const I=((O=M.patronInfo)==null?void 0:O.desperdicio_cm)||((z=M.patron)==null?void 0:z.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:C,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],desperdicioEstimadoCm:I},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:i});if($!=null&&$.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,a,u)}catch(M){x(M)}return}try{const M=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({})}),C=await M.json();if(!M.ok)throw new Error(C.message||"Error al actualizar");i(t,C)}catch(M){x(M)}}async function c(t,a){var A,y,E,_,B,L,O,z,M;const o=(A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"),d=document.querySelector(`[data-grupo-id="${t}"] .etiqueta-card`),u=(((y=d==null?void 0:d.dataset)==null?void 0:y.estado)||"pendiente").toLowerCase(),h=parseInt((E=d==null?void 0:d.dataset)==null?void 0:E.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(u)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${u}.`,timer:2500,showConfirmButton:!1});return}const l=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",e=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",n=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",f=l&&e||n;let g=[];try{g=JSON.parse(((_=d==null?void 0:d.dataset)==null?void 0:_.etiquetasSubIds)||"[]")}catch(C){console.warn("Error parseando etiquetas del grupo:",C)}const m=(B=d==null?void 0:d.dataset)==null?void 0:B.primeraEtiquetaId,v=((L=d==null?void 0:d.dataset)==null?void 0:L.planillaId)||window.PLANILLA_ID;if(u==="pendiente"&&f&&m){try{for(;;){const C=await Cortes.mejorCorteSimple(m,h,o);if(!C)return;if(C.accion==="optimizar"){const I=await Cortes.mejorCorteOptimizado(m,h,null,o);if(I==="volver")continue;if(!I||I.accion!=="fabricar")return;const $=((O=I.patronInfo)==null?void 0:O.desperdicio_cm)||0;let D=null;const F=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:I.longitudBarraCm,etiquetas:I.etiquetas,csrfToken:o,etiquetaId:m,desperdicioEstimadoCm:$,onUpdate:(P,J)=>{J.producto_n_colada&&(D={colada1:J.producto_n_colada,colada2:J.producto2_n_colada||null}),r(d,"fabricando",t,D)},pedirDesperdicio:!0});if(F!=null&&F.cancelled)continue;r(d,"fabricando",t,D),p("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(C.accion==="fabricar_patron_simple"){const I=Math.round(Number(C.longitud_m||0)*100);if(!I){x("Longitud de barra no v√°lida.");return}const $=((z=C.patronInfo)==null?void 0:z.desperdicio_cm)||((M=C.patron)==null?void 0:M.sobra_cm)||0,D=g.map(J=>({etiqueta_sub_id:J,patron_letras:C.patron_letras||""}));let F=null;const P=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:I,etiquetas:D,csrfToken:o,etiquetaId:m,desperdicioEstimadoCm:$,onUpdate:(J,pt)=>{pt.producto_n_colada&&(F={colada1:pt.producto_n_colada,colada2:pt.producto2_n_colada||null}),r(d,"fabricando",t,F)},pedirDesperdicio:!0});if(P!=null&&P.cancelled)continue;r(d,"fabricando",t,F),p("info","Fabricando",`Grupo iniciado (${g.length} etiquetas)`);return}return}}catch(C){x(C)}return}try{const C=await fetch(`/api/etiquetas/resumir/${t}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({maquina_id:a})}),I=await C.json();if(!C.ok||!I.success)throw new Error(I.message||"Error al actualizar grupo");const $=I.nuevo_estado||"actualizado",D=I.imprimir_etiquetas||[],F={colada1:I.producto_n_colada||null,colada2:I.producto2_n_colada||null};if(r(d,$,t,F),$==="fabricando"){const P=F.colada1?` - Colada: ${F.colada1}`:"";p("info","Fabricando",`Grupo iniciado (${I.etiquetas_actualizadas||0} etiquetas)${P}`)}else $==="completada"&&p("success","¬°Completado!",`Grupo completado (${I.etiquetas_actualizadas||0} etiquetas)`);if($==="completada"&&D.length>0){const P=D.map(R=>R.etiqueta_sub_id);await new Promise(R=>setTimeout(R,300));const J=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${P.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(J.isConfirmed||J.isDenied){const R=J.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(st=>setTimeout(st,800)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(P,R)}await new Promise(R=>setTimeout(R,500));const pt=I.planilla_id||v,k=I.maquina_id||a;if(pt&&k)try{await fetch("/api/etiquetas/resumir",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o,Accept:"application/json"},body:JSON.stringify({planilla_id:pt,maquina_id:k})}),console.log("Etiquetas reagrupadas despu√©s de completar")}catch(R){console.warn("No se pudieron reagrupar las etiquetas:",R)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let R=0;for(const st of P)try{const T=await window.TrabajoPaquete.validarEtiqueta(st);T.valida&&window.TrabajoPaquete.agregarItemEtiqueta(st,T)&&R++}catch(T){console.warn(`No se pudo a√±adir ${st} al carro:`,T)}R>0&&p("success","A√±adidas al carro",`${R} etiquetas a√±adidas al carro`)}r(d,"completada",t)}}catch(C){x(C)}}function r(t,a,o,d=null){if(!t)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(l=>{t.classList.remove(`estado-${l}`)}),t.classList.add(`estado-${a}`),t.dataset.estado=a;const u=t.dataset.contenedorSvgId,h=t.dataset.elementos;if(u&&h&&typeof window.renderizarGrupoSVG=="function")try{const l=JSON.parse(h);d&&(l.forEach(n=>{n.coladas={colada1:d.colada1||null,colada2:d.colada2||null,colada3:null}}),t.dataset.elementos=JSON.stringify(l));const e={id:parseInt(u),etiqueta:{id:parseInt(u)},elementos:l};window.renderizarGrupoSVG(e,o)}catch(l){console.warn("No se pudo re-renderizar SVG del grupo:",l)}}async function s(t,a,o){var C,I,$,D,F;const d=Number(((C=window.DIAMETRO_POR_ETIQUETA)==null?void 0:C[t])??0),h=Number(((I=window.LONGITUD_POR_ETIQUETA)==null?void 0:I[t])??0)/100;let l="";try{const P=await fetch(`/api/productos/sugerencias?diametro=${d}&longitud=${h}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(P.ok){const J=await P.json();J.productos&&J.productos.length>0?l=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${d}mm x ${h.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${J.productos.map(pt=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${pt.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${pt.codigo}</td>
                                                <td class="px-2 py-1">${pt.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${pt.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${pt.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:l=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${d}mm x ${h.toFixed(1)}m</p>`}}catch(P){console.warn("No se pudieron cargar sugerencias:",P)}const{value:e,isConfirmed:n}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${l}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const P=document.getElementById("swal-input-producto").value;return!P||!P.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):P.trim()}});if(!n||!e)return;let f;try{const P=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(e.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(!P.ok){const J=await P.json();throw new Error(J.message||"Producto no encontrado")}f=await P.json()}catch(P){await Swal.fire({icon:"error",title:"Producto no encontrado",text:P.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${e}`});return}const g=(f.tipo||"").toLowerCase(),m=Number(f.diametro??0),v=Number(f.longitud??0);if(g&&g!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${f.codigo}</p>
                        <p><strong>Tipo:</strong> ${f.tipo||"N/A"}</p>
                    </div>
                `});return}if(m>0&&d>0&&Math.abs(m-d)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${m} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${d} mm</p>
                    </div>
                `});return}if(v>0&&h>0&&Math.abs(v-h)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${v.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${h.toFixed(2)} m</p>
                    </div>
                `});return}const A=f.longitud?`${f.longitud} m`:"N/A",{value:y,isConfirmed:E}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${f.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${f.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${A}</p>
                    <p><strong>Stock actual:</strong> ${(($=f.peso_stock)==null?void 0:$.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${f.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!E)return;const _=y==="completo",B=`/actualizar-etiqueta/${t}/maquina/${a}`,L=await fetch(B,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({producto_id:f.id,paquete_completo:_})}),O=await L.json();if(!L.ok)throw new Error(O.message||"Error al fabricar");const z=((D=O.metricas)==null?void 0:D.peso_consumido)||0,M=((F=O.metricas)==null?void 0:F.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${f.codigo}</p>
                <p><strong>Peso consumido:</strong> ${z.toFixed(2)} kg</p>
                ${M?`<p><strong>Paquete:</strong> ${M}</p>`:""}
                ${_?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),i(t,O),M&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const P=document.getElementById("codigo_paquete_mover");P&&(P.value=M,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function i(t,a){var d,u;const o=t.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:a.estado,peso_etiqueta:a.peso_etiqueta,nombre:a.nombre,producto_n_colada:a.producto_n_colada,producto2_n_colada:a.producto2_n_colada,data_completa:a}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,a.estado,{peso:a.peso_etiqueta,nombre:a.nombre||t}):b(t,a.estado),a.producto_n_colada&&window.elementosAgrupadosScript){const h=window.elementosAgrupadosScript.findIndex(l=>l.etiqueta&&String(l.etiqueta.etiqueta_sub_id)===String(t));if(h!==-1){const l=window.elementosAgrupadosScript[h];l.colada_etiqueta=a.producto_n_colada,l.colada_etiqueta_2=a.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(l,h),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${a.producto_n_colada}`))}}switch(a.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,a.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(t,!0),(a.estado||"").toLowerCase()){case"pendiente":p("info","Pendiente","La etiqueta est√° pendiente de fabricaci√≥n.");break;case"cortando":p("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":p("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),w(o);break;case"fabricando":p("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":p("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),w(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"fabricada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),q(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":p("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(d=window._decisionCortePorEtiqueta)!=null&&d[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),w(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"completada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),q(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":p("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":p("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),w(o);break;case"soldando":p("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":p("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),w(o);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${a.estado}`),p("warning","Estado desconocido",`El estado recibido (${a.estado}) no est√° reconocido.`,3e3)}(u=a.productos_afectados)!=null&&u.length&&a.productos_afectados.forEach(h=>{const l=document.getElementById(`peso-stock-${h.id}`),e=document.getElementById(`progreso-texto-${h.id}`),n=document.getElementById(`progreso-barra-${h.id}`);l&&(l.textContent=`${h.peso_stock} kg`),e&&(e.textContent=`${h.peso_stock} / ${h.peso_inicial} kg`),n&&(n.style.height=`${h.peso_stock/h.peso_inicial*100}%`)})}function b(t,a){const o=t.replace(/\./g,"-"),d=document.getElementById("etiqueta-"+o);if(!d)return;d.dataset.estado=String(a||"").toLowerCase(),d.className=d.className.split(" ").filter(l=>!l.startsWith("estado-")).join(" ").trim(),d.classList.add("estado-"+d.dataset.estado);const u=d.querySelector('[id^="contenedor-svg-"]'),h=u==null?void 0:u.querySelector("svg");h&&(h.style.background=getComputedStyle(d).getPropertyValue("--bg-estado").trim())}function w(t){const a=`#etiqueta-${CSS.escape(t)}`,o=document.querySelector(a),d=Array.from(document.querySelectorAll(".proceso")),u=m=>(m||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),h=m=>{var y;const v=(y=m.dataset)==null?void 0:y.estado;if(v)return u(v);const A=m.querySelector('[id^="estado-"]');return u((A==null?void 0:A.textContent)||(A==null?void 0:A.innerText)||"")},l=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),e=m=>l.has(h(m)),n=o?d.indexOf(o):-1,g=(n>=0?d.slice(n+1):d).find(m=>!e(m));g?g.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function q(t,a){var l;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!a||!Array.isArray(a)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(a.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const o=window.elementosAgrupadosScript.findIndex(e=>{var n;return((n=e.etiqueta)==null?void 0:n.etiqueta_sub_id)===t});if(o===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[o].elementos=a;const d=window.elementosAgrupadosScript[o],u=(l=d.etiqueta)==null?void 0:l.id;if(!u){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const h=document.getElementById("contenedor-svg-"+u);if(!h){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${u})`);return}try{const e=h.querySelector("svg");e&&e.remove();const n=600,f=150,g=h.closest(".proceso"),m=g&&getComputedStyle(g).getPropertyValue("--bg-estado").trim()||"#e5e7eb",v=document.createElementNS("http://www.w3.org/2000/svg","svg");v.setAttribute("viewBox",`0 0 ${n} ${f}`),v.setAttribute("preserveAspectRatio","xMidYMid meet"),v.style.width="100%",v.style.height="100%",v.style.display="block",v.style.background=m;const A=(d.elementos||[]).map((E,_)=>{var M,C,I;const B=E.barras!=null?E.barras:0;let L="N/A";if(E.diametro!=null&&E.diametro!==""){const D=String(E.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(D){const F=parseFloat(D[0]);isFinite(F)&&(L=String(Math.round(F)))}}const O=[];(M=E.coladas)!=null&&M.colada1&&O.push(E.coladas.colada1),(C=E.coladas)!=null&&C.colada2&&O.push(E.coladas.colada2),(I=E.coladas)!=null&&I.colada3&&O.push(E.coladas.colada3);const z=O.length>0?` (${O.join(", ")})`:"";return{letter:indexToLetters(_),text:`√ò${L} x${B}${z}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(v,A,n,f):console.error("‚ùå drawLegendBottomLeft no est√° definida");const y=document.createElementNS("http://www.w3.org/2000/svg","text");y.setAttribute("x",n/2),y.setAttribute("y",f/2),y.setAttribute("text-anchor","middle"),y.setAttribute("fill","#059669"),y.setAttribute("font-size","14"),y.setAttribute("font-weight","600"),y.textContent="‚úì Coladas actualizadas",v.appendChild(y),h.appendChild(v),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{y&&y.parentNode&&y.remove()},2e3)}catch(e){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,e),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function p(t,a,o,d=2e3){Swal.fire({icon:t,title:a,text:o,timer:d,showConfirmButton:!1})}function x(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=i}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);(function(S){let c=[],r=!1,s=null;async function i(e){var f;const n=`/etiquetas/${encodeURIComponent(e)}/validar-para-paquete`;try{const g=await fetch(n,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.content}});if(!(g.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const v=await g.json();if(!g.ok)throw new Error((v==null?void 0:v.message)||(v==null?void 0:v.motivo)||"Error al validar");return v}catch(g){throw g}}function b(e,n){const f=n.id||e;if(c.some(v=>v.id===f))return!1;const g=parseFloat(n.peso_etiqueta)||0,m={id:f,type:"etiqueta",peso:g,estado:n.estado||"desconocido",nombre:n.nombre||"Sin nombre"};return c.push(m),t(),!0}function w(e){const n=c.findIndex(f=>f.id===e);n>=0&&c.splice(n,1),t()}function q(){c=[],t()}function p(){return c.reduce((e,n)=>e+(parseFloat(n.peso)||0),0)}function x(){return c}function t(){const e=document.getElementById("itemsList");if(!e)return;e.innerHTML="";for(const g of c){const m=document.createElement("li");m.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",m.dataset.code=g.id,m.innerHTML=`
                <div>
                    <div class="font-semibold">${g.id}</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,m.querySelector("button").onclick=()=>w(g.id),e.appendChild(m)}const n=p(),f=document.createElement("li");f.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",f.textContent=`Total: ${Math.round(n)} kg (${c.length} etiquetas)`,e.appendChild(f)}async function a(){var v,A,y;if(!c.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const e=Number(((A=(v=document.getElementById("maquina-info"))==null?void 0:v.dataset)==null?void 0:A.maquinaId)||window.maquinaId),n=Number(((y=document.getElementById("ubicacion-id"))==null?void 0:y.value)||window.ubicacionId),f=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!e){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!f&&!n){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const g={items:c.map(E=>({id:E.id,type:E.type})),maquina_id:e,ubicacion_id:f?null:n,sin_ubicacion:f},m=async(E={})=>{var L;const _=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(L=document.querySelector('meta[name="csrf-token"]'))==null?void 0:L.content},body:JSON.stringify({...g,...E})}),B=await _.json();if(!_.ok)throw new Error(B.message||"Error al crear el paquete");return B};try{const E=await m();if(E.success)return o(E);if(E.warning){let _="<div style='text-align:left;'>Se detectaron advertencias:";for(const[L,O]of Object.entries(E.warning))Array.isArray(O)&&O.length&&(_+=`<br><strong>${L.replaceAll("_"," ")}:</strong> ${O.join(", ")}`);if(_+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:_,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const L=await m({confirmar:!0});if(L.success)return o(L);throw new Error(L.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(E){await Swal.fire("Error",E.message||"Error inesperado","error")}}async function o(e){var v;console.log("üì¶ postCreacion llamada con data:",e);const n=e.codigo_paquete||((v=e.paquete)==null?void 0:v.codigo)||"N/D",f=p(),g=[...c.map(A=>A.id)];console.log("üì¶ Etiquetas a actualizar:",g),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${n}</strong> creado correctamente</p>
                       <p>${g.length} etiquetas ¬∑ ${f.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),q(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const A=document.getElementById("codigo_paquete_mover");A&&(A.value=n,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${n}</strong> creado correctamente</p><p>${g.length} etiquetas ¬∑ ${f.toFixed(2)} kg</p>`}),q()),console.log(`üì¶ Disparando evento paquete:creado para ${n}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:n,etiquetaIds:g,pesoTotal:f}})),console.log(`üîÑ Actualizando DOM para ${g.length} etiquetas con paquete ${n}`),g.forEach(A=>{d(A,n)})}function d(e,n){const f=String(e).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${e} (safe: ${f})`);let g=document.querySelector(`#etiqueta-${f}`);if(g&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${f}`),!g){const _=document.querySelector(`[data-etiqueta-sub-id="${e}"]`);_&&(g=_.querySelector(".etiqueta-card"),g&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!g){const _=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${_.length} grupos...`);for(const B of _)try{const L=JSON.parse(B.dataset.etiquetasSubIds||"[]");if(L.includes(e)){g=B,console.log(`‚úÖ Etiqueta ${e} encontrada en grupo con ${L.length} etiquetas`);break}}catch(L){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",L)}}if(!g){console.warn(`‚ùå No se encontr√≥ elemento: ${e}`);return}console.log(`üîÑ Actualizando manualmente: ${e}`),Array.from(g.classList).forEach(_=>{_.startsWith("estado-")&&g.classList.remove(_)}),g.classList.add("estado-en-paquete"),g.dataset.estado="en-paquete",g.style.setProperty("--bg-estado","#e3e4FA");const v=g.querySelector('[id^="contenedor-svg-"]');if(v){const _=v.querySelector("svg");_&&(_.style.background="#e3e4FA")}const A=g.querySelector(".etiqueta-card")||g;A&&(A.style.background="#e3e4FA");const y=g.querySelector(".paquete-codigo");y?(y.textContent=`(${n})`,y.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${n})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),g.querySelectorAll(".btn-fabricar").forEach(_=>{_.disabled=!0,_.style.opacity="0.5",_.style.cursor="not-allowed"}),g.style.transition="transform 0.5s ease, background-color 0.5s ease",g.style.transform="scale(1.03)",setTimeout(()=>{g.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${e} actualizada manualmente`)}function u(){h(),r||(l(),r=!0)}function h(){const e=document.getElementById("qrItem");e&&!e.dataset.initialized&&(e.dataset.initialized="true",e.addEventListener("change",()=>e.dispatchEvent(new Event("input"))),e.addEventListener("input",async function(){const n=this.value.trim();if(n)try{const f=await i(n);if(!f.valida){await Swal.fire("Etiqueta no v√°lida",f.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}b(n,f)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(f){console.error("Error de validaci√≥n:",f),await Swal.fire("Error",f.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}))}function l(){document.addEventListener("click",async function(e){if(e.target.id==="crearPaqueteBtn"||e.target.closest("#crearPaqueteBtn")){e.preventDefault(),await a();return}}),document.addEventListener("focus",function(e){e.target.id&&e.target.id.startsWith("input-etiqueta-")&&(s=e.target,console.log("üéØ Focus en input:",e.target.id))},!0),document.addEventListener("click",async function(e){var n;if(e.target.classList.contains("btn-agregar-carro")||e.target.closest(".btn-agregar-carro")){const g=(e.target.classList.contains("btn-agregar-carro")?e.target:e.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!g){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const m=document.querySelector(`[x-show="tabActivo === 'crear'"]`),v=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(m&&window.getComputedStyle(m).display,v&&window.getComputedStyle(v).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let y=document.activeElement;(!y||!((n=y.id)!=null&&n.startsWith("input-etiqueta-")))&&(y=s),(!y||!document.body.contains(y))&&(y=document.querySelector('input[id^="input-etiqueta-"]')),y?(y.value=g,y.focus(),y.classList.add("ring-4","ring-green-400"),setTimeout(()=>{y.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${g} a√±adida al input:`,y.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",g);try{const y=await i(g);if(!y.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:y.motivo||"Motivo no especificado"});return}b(g,y)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(y){console.error("Error al a√±adir al carro:",y),await Swal.fire({icon:"error",title:"Error",text:y.message||"No se pudo a√±adir al carro"})}}if(e.target.classList.contains("btn-agregar-carro-grupo")||e.target.closest(".btn-agregar-carro-grupo")){const f=e.target.classList.contains("btn-agregar-carro-grupo")?e.target:e.target.closest(".btn-agregar-carro-grupo"),g=f.dataset.grupoId;let m=[];try{m=JSON.parse(f.dataset.etiquetas||"[]")}catch(_){console.error("Error parseando etiquetas del grupo:",_);return}if(!m.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${m.length} etiquetas del grupo ${g} al carro`);let v=0,A=0,y=0,E=[];for(const _ of m)try{const B=await i(_.id);if(!B.valida){y++,B.motivo&&!E.includes(B.motivo)&&E.push(B.motivo);continue}b(_.id,B)?v++:A++}catch(B){y++,console.error("Error validando etiqueta:",_.id,B)}if(v>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${v}</strong> etiquetas al carro.</p>
                            ${A>0?`<p class="text-gray-500">${A} ya estaban en el carro.</p>`:""}
                            ${y>0?`<p class="text-red-500">${y} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(A>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const _=E.length>0?`<ul class="text-left mt-2 text-sm">${E.map(B=>`<li>‚Ä¢ ${B}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${_}
                        `})}}})}S.TrabajoPaquete={inicializar:u,agregarItemEtiqueta:b,eliminarItem:w,limpiarCarro:q,obtenerItems:x,calcularPesoTotal:p,crearPaquete:a,validarEtiqueta:i,actualizarListaVisual:t},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u(),document.addEventListener("livewire:navigated",u)})(window);function Ot(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(c,r){const s=document.getElementById("grid-maquina");if(!s)return;console.log("üîß Actualizando clases:",{showLeft:c,showRight:r,clasesAnteriores:s.className}),c||r?s.classList.add("columnas-laterales-visibles"):s.classList.remove("columnas-laterales-visibles"),c&&r?s.classList.add("ambas-columnas"):s.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",s.className),s.offsetHeight,s.querySelectorAll(".etiqueta-card").forEach(b=>{b.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const c=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,r)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const c=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,r)});function S(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((b,w)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),w.disconnect();const p=JSON.parse(localStorage.getItem("showLeft")??"true"),x=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(p,x)}}).observe(document.body,{childList:!0,subtree:!0});return}const r=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,s),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}S()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ot):Ot();document.addEventListener("livewire:navigated",Ot);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const S={debounceTime:500};let c=0;async function r(a){var u;const o=Date.now();if(o-c<S.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};c=o;const d=(u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${a}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const l=await fetch(`/etiquetas/${encodeURIComponent(a)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),e=await l.json();return!l.ok||!e.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:e.message||"No se pudo revertir el cambio."}),{success:!1,message:e.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${e.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${e.estado}</strong>
                    </p>
                    ${e.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),w(a,e),e)}catch(h){return console.error("Error al deshacer etiqueta:",h),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:h.message}}}async function s(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/puede-deshacer`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{puede_deshacer:!1}}catch(o){return console.error("Error al verificar undo:",o),{puede_deshacer:!1}}}async function i(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/historial`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{success:!1,historial:[]}}catch(o){return console.error("Error al obtener historial:",o),{success:!1,historial:[]}}}async function b(a){var u;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const o=await i(a);if(!o.success||!((u=o.historial)!=null&&u.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=o.historial.map((h,l)=>`
            <tr class="${h.revertido?"bg-gray-100 text-gray-400":l===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${h.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${h.accion}</td>
                <td class="px-2 py-1 text-xs">${h.estado_anterior||"-"} ‚Üí ${h.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${h.revertido?'<span class="text-gray-400">Revertido</span>':l===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${a}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${o.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${o.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:o.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:o.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:o.puede_deshacer?"#f59e0b":"#6b7280"}).then(h=>{h.isConfirmed&&o.puede_deshacer&&r(a)})}function w(a,o){const d=a.replace(/\./g,"-"),u=document.getElementById(`etiqueta-${d}`);if(u){u.dataset.estado=o.estado,u.className=u.className.split(" ").filter(e=>!e.startsWith("estado-")).join(" ").trim(),u.classList.add(`estado-${o.estado}`);const h=u.querySelector('[id^="contenedor-svg-"]'),l=h==null?void 0:h.querySelector("svg");l&&(l.style.background=getComputedStyle(u).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(a,o.estado)}if(o.estado==="pendiente"){if(window.elementosAgrupadosScript){const e=window.elementosAgrupadosScript.find(n=>n.etiqueta&&String(n.etiqueta.etiqueta_sub_id)===String(a));e&&(e.colada_etiqueta=null,e.colada_etiqueta_2=null,e.elementos&&e.elementos.forEach(n=>{n.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:a}})))}const h=document.getElementById(`colada-${d}`);h&&(h.textContent="")}console.log(`‚úÖ DOM actualizado para ${a}: estado = ${o.estado}`)}function q(a,o){const d=a.replace(/\./g,"-"),u=document.querySelector(`#etiqueta-${d} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${a}, puede=${o}, btn encontrado=${!!u}`),u&&(u.disabled=!1,u.classList.remove("opacity-50","cursor-not-allowed"),u.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function p(){document.addEventListener("click",async a=>{const o=a.target.closest(".btn-deshacer");if(!o)return;a.preventDefault(),a.stopPropagation();const d=o.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await r(d)}),document.addEventListener("click",async a=>{const o=a.target.closest(".btn-historial");if(!o)return;a.preventDefault(),a.stopPropagation();const d=o.dataset.etiquetaId;d&&await b(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function x(){let a=null;window.addEventListener("etiqueta-fabricada",o=>{var d;(d=o.detail)!=null&&d.etiquetaSubId&&(a=o.detail.etiquetaSubId)}),document.addEventListener("keydown",async o=>{var d,u;if(o.ctrlKey&&o.key==="z"&&!o.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const h=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),l=((u=h==null?void 0:h.dataset)==null?void 0:u.etiquetaId)||a;l&&(o.preventDefault(),await r(l))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function t(){p(),x(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:r,puedeDeshacer:s,obtenerHistorial:i,mostrarHistorial:b,actualizarBoton:q},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t(),document.addEventListener("livewire:navigated",t)})();
