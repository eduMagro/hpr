const Xe="rgba(0, 0, 0, 0.8)",Be="rgba(0, 0, 0, 1)",Ue="rgba(0, 0, 0, 1)";function He(A,l){return!l||l===1?A.map(c=>({...c})):A.map(c=>c.type==="line"?{...c,length:(c.length||0)*l}:c.type==="arc"?{...c,radius:(c.radius||0)*l}:{...c})}const Ye=.75,Te=14,We=60,Fe=[0,10,-10,20,-20,30,-30];function U(A){return A*Math.PI/180}function Je(A){const l=A.closest(".proceso");return l&&getComputedStyle(l).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Qe(A,l,c){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("viewBox","0 0 "+A+" "+l),s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.background=c||"#ffffff",s.style.shapeRendering="geometricPrecision",s.style.textRendering="optimizeLegibility",s.style.boxSizing="border-box",s}function Ke(A,l,c,s){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",l),n.setAttribute("stroke",c),n.setAttribute("fill","none"),n.setAttribute("stroke-width",s),n.setAttribute("vector-effect","non-scaling-stroke"),A.appendChild(n),n}function ze(A){let l="",c=Number(A)||0;for(;c>=0;){const s=c%26;l=String.fromCharCode(65+s)+l,c=Math.floor(c/26)-1}return l}const Ze=0,et=-25;function tt(A,l,c,s){if(!l||!l.length)return;const n=2,b=12,w=b+n,q=l.map(a=>(a.letter?a.letter+" ":"")+(a.text||"")),m=b*q.length+n*(q.length-1),x=Ze;let e=s-et-m+b/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let a=0;a<q.length;a++){const o=q[a],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",x),d.setAttribute("y",e),d.setAttribute("fill",Ue),d.setAttribute("font-size",b),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=o,A.appendChild(d);const u=Le(o,b).w;window.__legendBoxesGroup.push({left:x,right:x+u,top:e-b/2,bottom:e+b/2}),e+=w}}function ot(A){const l=(A||"").split(/\s+/).filter(Boolean),c=[];for(let s=0;s<l.length;s++){const n=l[s];if(n.endsWith("r")){const b=parseFloat(n.slice(0,-1));let w=360;s+1<l.length&&l[s+1].endsWith("d")&&(w=parseFloat(l[++s].slice(0,-1))),c.push({type:"arc",radius:b,arcAngle:w})}else n.endsWith("d")?c.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):c.push({type:"line",length:parseFloat(n)})}return c}function at(A){let l=[],c=0,s=0,n=0;l.push({x:c,y:s});for(let b=0;b<A.length;b++){const w=A[b];if(w.type==="line")c+=w.length*Math.cos(U(n)),s+=w.length*Math.sin(U(n)),l.push({x:c,y:s});else if(w.type==="turn")n+=w.angle;else if(w.type==="arc"){const q=c+w.radius*Math.cos(U(n+90)),m=s+w.radius*Math.sin(U(n+90)),x=Math.atan2(s-m,c-q),e=x+U(w.arcAngle);c=q+w.radius*Math.cos(e),s=m+w.radius*Math.sin(e),n+=w.arcAngle,l.push({x:c,y:s})}}return l}function Re(A){let l=[],c=0,s=0,n=0;for(let b=0;b<A.length;b++){const w=A[b];if(w.type==="line"){const q={x:c,y:s},m={x:c+w.length*Math.cos(U(n)),y:s+w.length*Math.sin(U(n))};l.push({start:q,end:m,length:w.length}),c=m.x,s=m.y}else if(w.type==="turn")n+=w.angle;else if(w.type==="arc"){const q=c+w.radius*Math.cos(U(n+90)),m=s+w.radius*Math.sin(U(n+90)),x=Math.atan2(s-m,c-q),e=x+U(w.arcAngle);c=q+w.radius*Math.cos(e),s=m+w.radius*Math.sin(e),n+=w.arcAngle}}return l}function Le(A,l){const c=l||12;return{w:(A?A.length:0)*c*.55,h:c}}function ne(A,l,c){const s=c||0;return!(A.right+s<l.left||A.left-s>l.right||A.bottom+s<l.top||A.top-s>l.bottom)}function De(A,l,c,s){const n=l/2;return Math.max(c+n,Math.min(s-n,A))}function nt(A,l){const s=[];let n=0;function b(){n>1e-9&&(s.push({type:"line",length:n}),n=0)}for(let w=0;w<A.length;w++){const q=A[w];if(q.type==="line"){n+=q.length;continue}if(q.type==="turn"){if(Math.abs(q.angle)<1e-9)continue;b(),s.push(q);continue}if(q.type==="arc"){b(),s.push(q);continue}b(),s.push(q)}return b(),s}function Ve(A,l){const c=l&&l.decimals||0,s=l&&l.step||null;let n=Number(A||0);return s&&s>0&&(n=Math.round(n/s)*s),n.toFixed(c).replace(/\.0+$/,"")}function st(A,l){const c=Math.hypot(A,l)||1;let s=A/c,n=l/c;return(n<-1e-9||Math.abs(n)<=1e-9&&s<0)&&(s=-s,n=-n),{ux:s,uy:n}}function je(A,l,c){const s=c||.01,n=st(A,l),b=Math.round(n.ux/s)*s,w=Math.round(n.uy/s)*s;return b+"|"+w}function it(A,l,c){const s=c&&c.dirPrecision||.01,n=c&&c.labelFormat||{decimals:0,step:null},b=A.reduce((d,u)=>d+Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y),0),w=l.reduce((d,u)=>d+(u.length||Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y)),0),q=w>0?b/w:1,m=new Map;for(let d=0;d<l.length;d++){const u=l[d],f=u.end.x-u.start.x,i=u.end.y-u.start.y,t=je(f,i,s),r=m.get(t)||[];r.push({length:u.length||Math.hypot(f,i),index:d}),m.set(t,r)}const x=l.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),e=new Set,a=new Set,o=[];for(let d=0;d<A.length;d++){const u=A[d],f=u.end.x-u.start.x,i=u.end.y-u.start.y,t=je(f,i,s),r=m.get(t)||[],g=Math.hypot(f,i);let h=g;if(r.length){const C=g/q;let y=null,E=1/0;for(const v of r){const I=Math.abs(v.length-C),M=a.has(v.index)?.1:0;I+M<E&&(y=v,E=I+M)}y&&(h=y.length,a.add(y.index))}else d<x.length&&(h=x[d]);const p=Ve(h,n),_=t+"|"+p;e.has(_)||(e.add(_),o.push({start:u.start,end:u.end,_dirKey:t,_label:p,_lenChosen:h}))}return o}function rt(A,l){const c=l,s=A.map(i=>Object.assign({},i));let n=0,b=0,w=0;const q=[];let m=null,x=-1,e=-1;const a=1e-7;function o(i){return i*Math.PI/180}function d(i){return Math.abs(Math.sin(o(i)))<1e-12}function u(i,t,r,g){return Math.min(t,g)-Math.max(i,r)>a}for(let i=0;i<s.length;i++){let r=function(){const C={x:Math.cos(o(w)),y:Math.sin(o(w))},y=n+s[i].length*C.x,E=b+s[i].length*C.y,v=d(w);for(let I=0;I<q.length;I++){const M=q[I];if(v&&M.horiz&&Math.abs(b-M.y)<a){if(u(Math.min(n,y),Math.max(n,y),Math.min(M.x1,M.x2),Math.max(M.x1,M.x2))&&m&&x>=0&&e>=0)return s[e].length+=c,n+=m.x*c,b+=m.y*c,q[x].x2+=m.x*c,q[x].y2+=m.y*c,!0}else if(!v&&!M.horiz&&Math.abs(n-M.x)<a&&u(Math.min(b,E),Math.max(b,E),Math.min(M.y1,M.y2),Math.max(M.y1,M.y2))&&m&&x>=0&&e>=0)return s[e].length+=c,n+=m.x*c,b+=m.y*c,q[x].x2+=m.x*c,q[x].y2+=m.y*c,!0}return!1};var f=r;const t=s[i];if(t.type==="turn"){w+=t.angle;continue}if(t.type==="arc"){const C=n+t.radius*Math.cos(o(w+90)),y=b+t.radius*Math.sin(o(w+90)),E=Math.atan2(b-y,n-C),v=E+o(t.arcAngle);n=C+t.radius*Math.cos(v),b=y+t.radius*Math.sin(v),w+=t.arcAngle,m=null;continue}for(;r(););const g={x:Math.cos(o(w)),y:Math.sin(o(w))},h=n+s[i].length*g.x,p=b+s[i].length*g.y,_=d(w);q.push({x1:n,y1:b,x2:h,y2:p,horiz:_,y:b,x:n}),m=g,x=q.length-1,e=i,n=h,b=p}return s}function Se(A,l,c,s){const n=U(s),b=Math.cos(n),w=Math.sin(n),q=A.x-l,m=A.y-c;return{x:l+q*b-m*w,y:c+q*w+m*b}}function ct(A,l,c,s,n,b,w,q,m){let x="",e=0,a=0,o=0,d=!1;function u(i,t){const r=Se({x:i,y:t},l,c,s);return{x:q+(r.x-b)*n,y:m+(r.y-w)*n}}function f(){if(!d){const i=u(e,a);x+="M "+i.x+" "+i.y,d=!0}}for(let i=0;i<A.length;i++){const t=A[i];if(t.type==="turn"){o+=t.angle;continue}if(t.type==="line"){const r=e+t.length*Math.cos(U(o)),g=a+t.length*Math.sin(U(o));f();const h=u(r,g);x+=" L "+h.x+" "+h.y,e=r,a=g;continue}if(t.type==="arc"){const r=e+t.radius*Math.cos(U(o+90)),g=a+t.radius*Math.sin(U(o+90)),h=Math.atan2(a-g,e-r),p=h+U(t.arcAngle),_=r+t.radius*Math.cos(p),C=g+t.radius*Math.sin(p),y=Math.abs(t.arcAngle)%360;if(f(),y<1e-6||Math.abs(t.arcAngle)>=359.9){const O=h+Math.sign(t.arcAngle)*Math.PI,z=r+t.radius*Math.cos(O),S=g+t.radius*Math.sin(O),L=u(z,S),D=u(e,a),$=t.radius*n,N=t.arcAngle>=0?1:0;x+=" A "+$+" "+$+" 0 1 "+N+" "+L.x+" "+L.y,x+=" A "+$+" "+$+" 0 1 "+N+" "+D.x+" "+D.y,o+=t.arcAngle;continue}const E=u(_,C),v=t.radius*n,I=y>180?1:0,M=t.arcAngle>=0?1:0;x+=" A "+v+" "+v+" 0 "+I+" "+M+" "+E.x+" "+E.y,e=_,a=C,o+=t.arcAngle}}return x||"M 0 0"}function lt(A){const l=at(A);let c=Math.min(...l.map(f=>f.x)),s=Math.max(...l.map(f=>f.x)),n=Math.min(...l.map(f=>f.y)),b=Math.max(...l.map(f=>f.y));const w=(c+s)/2,q=(n+b)/2,x=b-n>s-c?-90:0,e=l.map(f=>Se(f,w,q,x));c=Math.min(...e.map(f=>f.x)),s=Math.max(...e.map(f=>f.x)),n=Math.min(...e.map(f=>f.y)),b=Math.max(...e.map(f=>f.y));const a=Math.max(1,s-c),o=Math.max(1,b-n),d=(c+s)/2,u=(n+b)/2;return{rotDeg:x,w:a,h:o,cxModel:w,cyModel:q,midX:d,midY:u,ptsRot:e}}function dt(A){const l=[];let c=0,s=0,n=0;function b(w){const q=U(w);return{x:Math.cos(q),y:Math.sin(q)}}for(let w=0;w<A.length;w++){const q=A[w];if(q.type==="line")c+=q.length*Math.cos(U(n)),s+=q.length*Math.sin(U(n));else if(q.type==="turn"){const m=b(n),x=q.angle;n+=x;const e=b(n);l.push({x:c,y:s,angleDeg:x,prevDir:m,nextDir:e})}else if(q.type==="arc"){const m=c+q.radius*Math.cos(U(n+90)),x=s+q.radius*Math.sin(U(n+90)),e=Math.atan2(s-x,c-m),a=e+U(q.arcAngle);c=m+q.radius*Math.cos(a),s=x+q.radius*Math.sin(a),n+=q.arcAngle}}return l}function ut(A,l,c){const s=Array.from({length:l},()=>({sumH:0,maxW:0,items:[]})),n=[...A.keys()].sort((b,w)=>A[w].h-A[b].h);for(const b of n){let w=0,q=1/0;for(let x=0;x<l;x++){const e=s[x],a=e.sumH+(e.items.length>0?c:0)+A[b].h;a<q&&(q=a,w=x)}const m=s[w];m.sumH=m.items.length>0?m.sumH+c+A[b].h:m.sumH+A[b].h,m.maxW=Math.max(m.maxW,A[b].w),m.items.push(b)}return s}function pt(A,l,c,s={}){const n=s.padding??12,b=s.gapCol??12,w=s.gapRow??10,q=Math.max(1,Math.min(A.length,s.kMax??4)),m=Math.max(10,l-2*n),x=Math.max(10,c-2*n),e=a(A);function a(r){const g=r.map($=>$.w/Math.max($.h,1)),h=r.map($=>$.h),p=r.map($=>$.w),_=r.map($=>$.w*$.h),C=$=>$.reduce((N,F)=>N+F,0)/$.length,y=($,N)=>$.reduce((F,P)=>F+Math.pow(P-N,2),0)/$.length,E=($,N)=>Math.sqrt(y($,N)),v=C(g),I=C(h),M=C(p),O=_.reduce(($,N)=>$+N,0),z=E(h,I),S=E(p,M),L=I>0?z/I:0,D=M>0?S/M:0;return{avgAspectRatio:v,avgHeight:I,avgWidth:M,totalArea:O,heightCV:L,widthCV:D,isLinear:v>6||I<M*.12,isUniformHeight:L<.15,isUniformWidth:D<.15,isHighlyVariable:L>.5||D>.5,count:r.length}}let o={S:0,k:1,cols:null,score:0};for(let r=1;r<=q;r++){const g=ut(A,r,w),h=g.reduce((P,Y)=>P+Y.maxW,0)+b*(r-1),p=Math.max(...g.map(P=>P.sumH));if(h<=0||p<=0)continue;const _=m/h,C=x/p,y=Math.min(_,C),E=Math.max(.01,y*.92),v=e.totalArea*E*E,I=m*x,M=v/I,O=g.map(P=>P.sumH*E),z=O.reduce((P,Y)=>P+Y,0)/r,S=Math.max(...O)-Math.min(...O),L=z>0?1-S/z:1,D=r===1?1.1:r===2?.9:.7,$=r>e.count*.5?.7:1,N=L>.85?1.05:1,F=E*(1+M*.25)*(1+L*.1)*D*$*N;F>o.score&&(o={S:E,k:r,cols:g,score:F,efficiency:M,colBalance:L})}const d=o.cols.map(r=>r.maxW*o.S),u=d.reduce((r,g)=>r+g,0);let f=[];if(o.k===1)f[0]=l/2;else{const r=(o.k-1)*b,g=u+r;if(g<m){const h=m-g,p=b+h/(o.k-1);let _=n;for(let C=0;C<o.k;C++)f[C]=_+d[C]/2,_+=d[C]+p}else{let h=n+Math.max(0,(m-g)/2);for(let p=0;p<o.k;p++)f[p]=h+d[p]/2,h+=d[p]+b}}const i=[],t=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(r=>r.right));for(let r=0;r<o.k;r++){const g=o.cols[r];i[r]=[];const h=g.items.map(S=>A[S].h*o.S),p=h.reduce((S,L)=>S+L,0);if(g.items.length===0)continue;const _=f[r],C=o.cols[r].maxW*o.S,y=_-C/2,E=_+C/2,v=t(),M=Math.max(0,Math.min(E,v)-y)/C,O=M>.05;let z=x;if(O&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const L=Math.min(...window.__legendBoxesGroup.map(D=>D.top))-15;z=Math.max(10,L-n),console.log(`üìè Columna ${r}: X=${y.toFixed(0)}-${E.toFixed(0)}, legendWidth=${v.toFixed(0)}, solape=${(M*100).toFixed(0)}%, altura reducida a ${z.toFixed(0)}px`)}else console.log(`üìè Columna ${r}: X=${y.toFixed(0)}-${E.toFixed(0)}, legendWidth=${v.toFixed(0)}, solape=${(M*100).toFixed(0)}%, altura completa ${z.toFixed(0)}px`);if(g.items.length===1){const S=h[0],L=n+z/2,D=Math.max(n+S/2,Math.min(L,c-n-S/2));i[r].push(D);continue}if(p>z){console.warn(`Columna ${r}: elementos no caben (${p}px > ${z}px)`);const D=p/g.items.length<4?20:5;let $=n;for(let N=0;N<g.items.length;N++){const F=Math.max(h[N],2),P=$+F/2;i[r].push(P),$+=F+D}}else{const S=z-p,L=g.items.length-1;let D=S/L;p/g.items.length<4?D=Math.max(18,Math.min(D,50)):D=Math.max(5,D);const F=p+L*D,P=z-F;let Y=n+Math.max(0,P/2);for(let ue=0;ue<g.items.length;ue++){const k=Math.max(h[ue],2),de=Y+k/2,he=n+z-k/2,B=Math.max(n+k/2,Math.min(de,he));i[r].push(B),Y+=k+D}}}return{S:o.S,k:o.k,cols:o.cols,centersX:f,centersYByCol:i,padding:n,gapRow:w,gapCol:b}}window.renderizarGrupoSVG=function(l,c){const s=l&&l.etiqueta&&l.etiqueta.id!=null?l.etiqueta.id:l&&l.id!=null?l.id:c,n=document.getElementById("contenedor-svg-"+s);if(!n)return;const b=600,w=150,q=Je(n),m=Qe(b,w,q);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const x=[],e=new Map;(l.elementos||[]).forEach(i=>{var h,p,_,C,y,E;let t="0";if(i.diametro!=null&&i.diametro!==""){const I=String(i.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(I){const M=parseFloat(I[0]);isFinite(M)&&(t=String(Math.round(M)))}}const r=(i.dimensiones||"barra").trim().toLowerCase(),g=`${t}|${r}`;if(e.has(g)){const v=e.get(g);x[v].barrasTotal+=i.barras||0,(h=i.coladas)!=null&&h.colada1&&!x[v].coladasSet.has(i.coladas.colada1)&&x[v].coladasSet.add(i.coladas.colada1),(p=i.coladas)!=null&&p.colada2&&!x[v].coladasSet.has(i.coladas.colada2)&&x[v].coladasSet.add(i.coladas.colada2),(_=i.coladas)!=null&&_.colada3&&!x[v].coladasSet.has(i.coladas.colada3)&&x[v].coladasSet.add(i.coladas.colada3)}else{const v=new Set;(C=i.coladas)!=null&&C.colada1&&v.add(i.coladas.colada1),(y=i.coladas)!=null&&y.colada2&&v.add(i.coladas.colada2),(E=i.coladas)!=null&&E.colada3&&v.add(i.coladas.colada3),x.push({elemento:i,diametro:t,dimensiones:i.dimensiones,barrasTotal:i.barras||0,coladasSet:v}),e.set(g,x.length-1)}});const a=x.map((i,t)=>{const r=[];l.colada_etiqueta&&r.push(l.colada_etiqueta),l.colada_etiqueta_2&&l.colada_etiqueta_2!==l.colada_etiqueta&&r.push(l.colada_etiqueta_2),r.length===0&&i.coladasSet.size>0&&r.push(...i.coladasSet);const g=r.length>0?` (${r.join(", ")})`:"";return{letter:ze(t),text:`√ò${i.diametro} x${i.barrasTotal}${g}`}});tt(m,a,b,w);const o=x.map(i=>{const t=i.elemento,r=ot(t.dimensiones||""),g=nt(r);let h=0;for(const E of g)E.type==="line"&&(h=Math.max(h,Math.abs(E.length||0))),E.type==="arc"&&(h=Math.max(h,Math.abs(E.radius||0)));const _=h<=50?2:1,C=He(g,_),y=lt(C);return{dimsRaw:r,dimsNoZero:g,dimsScaled:C,geomScale:_,medida:y}}),d=o.map(i=>i.medida),u=pt(d,b,w,{padding:20,gapCol:50,gapRow:22,kMax:3}),f=new Map;for(let i=0;i<u.k;i++)u.cols[i].items.forEach((t,r)=>f.set(t,{c:i,j:r}));x.forEach(function(i,t){const r=i.elemento,{dimsNoZero:g,dimsScaled:h,medida:p}=o[t],_=f.get(t),C=u.centersX[_.c],y=u.centersYByCol[_.c][_.j],E=u.S,v=p.ptsRot.map(k=>({x:C+(k.x-p.midX)*E,y:y+(k.y-p.midY)*E})),I=Math.min(...v.map(k=>k.x)),M=Math.max(...v.map(k=>k.x)),O=Math.min(...v.map(k=>k.y)),z=Math.max(...v.map(k=>k.y)),S={left:I,right:M,top:O,bottom:z};window.__figBoxesGroup.push({...S});const L=rt(h,.6),D=ct(L,p.cxModel,p.cyModel,p.rotDeg,E,p.midX,p.midY,C,y),$=Ke(m,D,Xe,2);(function(){const de=dt(h);function he(T){return Math.abs(Math.abs(T)-90)>=Ye}const B=(T,G)=>Se({x:T.x,y:T.y},0,0,G),K=(T,G)=>{const J=Se({x:T,y:G},p.cxModel,p.cyModel,p.rotDeg);return{x:C+(J.x-p.midX)*E,y:y+(J.y-p.midY)*E}},R=T=>Math.max(10,Math.min(28,T));de.forEach(T=>{if(!he(T.angleDeg))return;const G=K(T.x,T.y),J=B(T.prevDir,p.rotDeg),fe=B(T.nextDir,p.rotDeg),Q=Math.atan2(J.y,J.x),V=Q+U(T.angleDeg),Z=Math.min(S.right-S.left,S.bottom-S.top);let j=R(.12*Z);const we=G.x+j*Math.cos(Q),ge=G.y+j*Math.sin(Q),W=G.x+j*Math.cos(V),ye=G.y+j*Math.sin(V),ee=Math.abs(T.angleDeg),ie=ee>180?1:0,Ce=T.angleDeg>=0?1:0,re=document.createElementNS("http://www.w3.org/2000/svg","path");re.setAttribute("d",`M ${we} ${ge} A ${j} ${j} 0 ${ie} ${Ce} ${W} ${ye}`),re.setAttribute("stroke","rgba(255,99,71,0.7)"),re.setAttribute("stroke-width","2"),re.setAttribute("fill","none"),re.style.pointerEvents="none",m.appendChild(re);let X=J.x+fe.x,H=J.y+fe.y;ee>180&&(X=-X,H=-H);let te=Math.hypot(X,H);if(te<1e-6){const le=T.angleDeg>=0?1:-1;X=-J.y*le,H=J.x*le,te=Math.hypot(X,H)||1}X/=te,H/=te;const oe=(Math.round(T.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",ae=Le(oe,14);function Ae(le,pe){return{left:le-ae.w/2,right:le+ae.w/2,top:pe-ae.h/2,bottom:pe+ae.h/2}}let se=null;for(let le=Te;le<=We&&!se;le+=4)for(let pe=0;pe<Fe.length&&!se;pe++){const xe=Fe[pe],Ee=B({x:X,y:H},xe),_e=G.x+Ee.x*(j+le),me=G.y+Ee.y*(j+le),be=Ae(_e,me);be.top<0||be.bottom>w||be.left<0||be.right>b||window.__figBoxesGroup.some(qe=>ne(qe,be,6))||(window.__dimBoxesGroup||[]).some(qe=>ne(qe,be,2))||(window.__angleBoxesGroup||[]).some(qe=>ne(qe,be,2))||(window.__placedLetterBoxes||[]).some(qe=>ne(qe,be,2))||(window.__legendBoxesGroup||[]).some(qe=>ne(qe,be,6))||(se={x:_e,y:me,box:be})}if(!se){const le=G.x+X*(j+Te),pe=G.y+H*(j+Te),xe=Ae(le,pe);se={x:le,y:pe,box:xe}}window.__angleBoxesGroup.push(se.box);const ce=document.createElementNS("http://www.w3.org/2000/svg","text");ce.setAttribute("x",se.x),ce.setAttribute("y",se.y),ce.setAttribute("fill",Be),ce.setAttribute("font-size",14),ce.setAttribute("text-anchor","middle"),ce.setAttribute("alignment-baseline","middle"),ce.style.cursor="pointer",ce.textContent=oe,m.appendChild(ce),ce.addEventListener("mouseenter",()=>{re.setAttribute("stroke","rgba(255,69,0,1)"),re.setAttribute("stroke-width","3"),re.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),ce.addEventListener("mouseleave",()=>{re.setAttribute("stroke","rgba(255,99,71,0.7)"),re.setAttribute("stroke-width","2"),re.style.filter="none"})})})();const N=$.cloneNode(!1);N.setAttribute("stroke-width","50"),N.setAttribute("stroke","transparent"),N.setAttribute("fill","none"),N.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(k=>{N.addEventListener(k,de=>$.dispatchEvent(new de.constructor(de.type,de)))}),m.insertBefore(N,$),(r.codigo!=null?r.codigo:r.id)+"",$.style.cursor="pointer",$.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),$.addEventListener("click",function(k){if(k.ctrlKey||k.metaKey||k.shiftKey){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(r.id);return}abrirModalDividirElemento(r.id,r.barras||0)}),$.addEventListener("contextmenu",function(k){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(r.id)});const F=[],P=Re(L),Y=Re(g);it(P,Y,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(k){const de=Se(k.start,p.cxModel,p.cyModel,p.rotDeg),he=Se(k.end,p.cxModel,p.cyModel,p.rotDeg),B={x:C+(de.x-p.midX)*E,y:y+(de.y-p.midY)*E},K={x:C+(he.x-p.midX)*E,y:y+(he.y-p.midY)*E},R=k._label,T=K.x-B.x,G=K.y-B.y,J=Math.hypot(T,G)||1,fe=T/J,Q=G/J,V=G/J,Z=-T/J,j=(B.x+K.x)/2,we=(B.y+K.y)/2,ge=j+V*10,W=we+Z*10,ye=Le(R,14),ee=ye.w,ie=ye.h;function Ce(se,ce){return{left:se-ee/2,right:se+ee/2,top:ce-ie/2,bottom:ce+ie/2}}const re=J*.45;let X=ge,H=W;for(let se=0;se<=Math.ceil(re/6);se++){const ce=se%2===0?1:-1,le=Math.ceil(se/2),pe=ce*le*6;if(Math.abs(pe)>re)continue;const xe=ge+fe*pe,Ee=W+Q*pe,_e=(xe-B.x)*fe+(Ee-B.y)*Q;if(_e<0+ee*.3||_e>J-ee*.3)continue;const me=Ce(xe,Ee);if(!(ne({left:Math.min(B.x,K.x),right:Math.max(B.x,K.x),top:Math.min(B.y,K.y),bottom:Math.max(B.y,K.y)},me,0)||(window.__angleBoxesGroup||[]).some(ve=>ne(ve,me,2))||(window.__legendBoxesGroup||[]).some(ve=>ne(ve,me,6))||F.some(ve=>ne(ve,me,2))||me.top<0||me.bottom>w||me.left<0||me.right>b)){X=xe,H=Ee,F.push(me),window.__dimBoxesGroup.push(me);break}}const te=document.createElementNS("http://www.w3.org/2000/svg","line");te.setAttribute("x1",B.x),te.setAttribute("y1",B.y),te.setAttribute("x2",K.x),te.setAttribute("y2",K.y),te.setAttribute("stroke","rgba(0,0,255,0.6)"),te.setAttribute("stroke-width","4"),te.setAttribute("stroke-linecap","round"),te.setAttribute("vector-effect","non-scaling-stroke"),te.style.opacity=0,te.style.pointerEvents="none",te.style.transition="opacity 120ms ease",m.appendChild(te);const oe=document.createElementNS("http://www.w3.org/2000/svg","text");oe.setAttribute("x",X),oe.setAttribute("y",H),oe.setAttribute("fill",Be),oe.setAttribute("font-size",14),oe.setAttribute("text-anchor","middle"),oe.setAttribute("alignment-baseline","middle"),oe.setAttribute("tabindex","0"),oe.style.cursor="pointer",oe.textContent=R,m.appendChild(oe);function ae(){te.style.opacity=1}function Ae(){te.style.opacity=0}oe.addEventListener("mouseenter",ae),oe.addEventListener("mouseleave",Ae),oe.addEventListener("focus",ae),oe.addEventListener("blur",Ae)}),function(){const de=[];let he=0,B=0,K=0;for(let R=0;R<h.length;R++){const T=h[R];if(T.type==="line")he+=T.length*Math.cos(U(K)),B+=T.length*Math.sin(U(K));else if(T.type==="turn")K+=T.angle;else if(T.type==="arc"){const G=he+T.radius*Math.cos(U(K+90)),J=B+T.radius*Math.sin(U(K+90)),fe=Math.atan2(B-J,he-G),Q=fe+U(T.arcAngle);let V=T.radius;for(let Z=0;Z<g.length;Z++){const j=g[Z];if(j.type==="arc"&&Math.abs(j.arcAngle-T.arcAngle)<.01){V=j.radius;break}}de.push({center:{x:G,y:J},radius:T.radius,originalRadius:V,arcAngle:T.arcAngle,startAngle:fe,endAngle:Q}),he=G+T.radius*Math.cos(Q),B=J+T.radius*Math.sin(Q),K+=T.arcAngle}}de.forEach(function(R){const T=Se(R.center,p.cxModel,p.cyModel,p.rotDeg),G={x:C+(T.x-p.midX)*E,y:y+(T.y-p.midY)*E},J=(R.startAngle+R.endAngle)/2,fe=R.radius*E,Q="R"+Ve(R.originalRadius,{decimals:0,step:null}),V=Le(Q,14),Z=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let j=!1,we,ge,W;for(let ae=0;ae<Z.length&&!j;ae++){const Ae=Z[ae],se=J+U(Ae),ce={x:R.center.x+R.radius*Math.cos(se),y:R.center.y+R.radius*Math.sin(se)},le=Se(ce,p.cxModel,p.cyModel,p.rotDeg),pe={x:C+(le.x-p.midX)*E,y:y+(le.y-p.midY)*E},xe=pe.x-G.x,Ee=pe.y-G.y,_e=Math.hypot(xe,Ee)||1,me=xe/_e,be=Ee/_e;for(let Me=8;Me<=60&&!j;Me+=6){const $e=fe*.7;if(we=G.x+me*$e+me*Me,ge=G.y+be*$e+be*Me,W={left:we-V.w/2,right:we+V.w/2,top:ge-V.h/2,bottom:ge+V.h/2},!(W.top<0||W.bottom>w||W.left<0||W.right>b||window.__figBoxesGroup.some(Ie=>ne(Ie,W,2))||(window.__legendBoxesGroup||[]).some(Ie=>ne(Ie,W,2)))){j=!0;break}}}if(!j)return;F.push(W);const ye={x:we-G.x,y:ge-G.y},ee=Math.hypot(ye.x,ye.y)||1,ie={x:ye.x/ee,y:ye.y/ee},Ce=G.x+ie.x*fe*.6,re=G.y+ie.y*fe*.6,X=document.createElementNS("http://www.w3.org/2000/svg","line");X.setAttribute("x1",G.x),X.setAttribute("y1",G.y),X.setAttribute("x2",Ce),X.setAttribute("y2",re),X.setAttribute("stroke","rgba(0,128,0,0.6)"),X.setAttribute("stroke-width","4"),X.setAttribute("stroke-linecap","round"),X.setAttribute("vector-effect","non-scaling-stroke"),X.style.opacity=0,X.style.pointerEvents="none",X.style.transition="opacity 120ms ease",m.appendChild(X);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",we),H.setAttribute("y",ge),H.setAttribute("fill",Be),H.setAttribute("font-size",14),H.setAttribute("text-anchor","middle"),H.setAttribute("alignment-baseline","middle"),H.setAttribute("tabindex","0"),H.style.cursor="pointer",H.textContent=Q,m.appendChild(H);function te(){X.style.opacity=1}function oe(){X.style.opacity=0}H.addEventListener("mouseenter",te),H.addEventListener("mouseleave",oe),H.addEventListener("focus",te),H.addEventListener("blur",oe)})}(),function(){const de=ze(t),he=14,B=Le(de,he);function K(V,Z){return{left:V,right:V+B.w,top:Z-B.h/2,bottom:Z+B.h/2}}let R=null;const T=(S.top+S.bottom)/2,G=Math.max(B.h/2,Math.min(T,w-B.h/2));function J(V){for(let j=0;j<=30;j+=4){const we=j%2===0?1:-1,ge=Math.ceil(j/2),W=we*ge*4,ye=Math.max(B.h/2,Math.min(w-B.h/2,G+W)),ee=V,ie=K(ee,ye);if(!(window.__figBoxesGroup.some(ae=>ne(ae,ie,6))||(window.__dimBoxesGroup||[]).some(ae=>ne(ae,ie,3))||(window.__angleBoxesGroup||[]).some(ae=>ne(ae,ie,3))||(window.__legendBoxesGroup||[]).some(ae=>ne(ae,ie,6))||(window.__placedLetterBoxes||[]).some(ae=>ne(ae,ie,2))||ie.top<0||ie.bottom>w||ie.left<0||ie.right>b))return R={x:ee,y:ye,box:ie},!0}return!1}const fe=[{x:S.right+10,priority:1},{x:S.left-10-B.w,priority:1},{x:S.right+15,priority:2},{x:S.left-15-B.w,priority:2},{x:S.right+5,priority:2},{x:S.left-5-B.w,priority:2},{x:S.right+20,priority:3},{x:S.left-20-B.w,priority:3},{x:S.right+25,priority:3},{x:S.left-25-B.w,priority:3},{x:S.right+30,priority:3},{x:S.left-30-B.w,priority:3}];fe.sort((V,Z)=>V.priority-Z.priority);for(const V of fe){if(R)break;const Z=De(V.x,B.w,0,b);if(J(Z))break}if(!R){const V=(S.left+S.right)/2,Z=[{x:V-B.w/2,y:S.top-B.h-5},{x:V-B.w/2,y:S.bottom+B.h+5}];for(const j of Z){if(R)break;const we=De(j.x,B.w,0,b),ge=Math.max(B.h/2,Math.min(w-B.h/2,j.y)),W=K(we,ge);!window.__figBoxesGroup.some(ee=>ne(ee,W,6))&&!(window.__dimBoxesGroup||[]).some(ee=>ne(ee,W,3))&&!(window.__angleBoxesGroup||[]).some(ee=>ne(ee,W,3))&&!(window.__legendBoxesGroup||[]).some(ee=>ne(ee,W,6))&&!(window.__placedLetterBoxes||[]).some(ee=>ne(ee,W,2))&&W.top>=0&&W.bottom<=w&&W.left>=0&&W.right<=b&&(R={x:we,y:ge,box:W})}}if(!R){const V=De(b-B.w,B.w,0,b),Z=G;R={x:V,y:Z,box:K(V,Z)}}window.__placedLetterBoxes.push(R.box);const Q=document.createElementNS("http://www.w3.org/2000/svg","text");Q.setAttribute("x",R.x),Q.setAttribute("y",R.y),Q.setAttribute("fill",Ue),Q.setAttribute("font-size",he),Q.setAttribute("text-anchor","start"),Q.setAttribute("alignment-baseline","middle"),Q.style.fontWeight="600",Q.style.pointerEvents="none",Q.textContent=de,m.appendChild(Q)}()}),n.innerHTML="",n.appendChild(m)};function Pe(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const A=window.elementosAgrupadosScript;if(!A)return;const l=document.getElementById("grid-maquina");if(l&&window.updateGridClasses){const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}A.forEach(function(c,s){renderizarGrupoSVG(c,s)}),requestAnimationFrame(()=>{l&&(l.style.opacity="1",l.style.visibility="visible",l.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",l.className)),document.querySelectorAll(".proceso").forEach(c=>{c.style.opacity="1"})}),window.actualizarSVGConColadas=function(c,s){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,b=n.findIndex(q=>q.etiqueta&&String(q.etiqueta.etiqueta_sub_id)===String(c));if(b===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const w=n[b];w.elementos&&s&&w.elementos.forEach(q=>{const m=String(q.id),x=s[m];q.coladas||(q.coladas={colada1:null,colada2:null,colada3:null}),x&&Array.isArray(x)&&(q.coladas.colada1=x[0]||null,q.coladas.colada2=x[1]||null,q.coladas.colada3=x[2]||null)}),renderizarGrupoSVG(w,b),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${c}`,s)},window.limpiarColadasSVG=function(c){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,n=s.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(c));if(n===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const b=s[n];b.elementos&&b.elementos.forEach(w=>{w.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(b,n),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${c}`)},window.addEventListener("regenerar-svg-etiqueta",function(c){var q;const s=(q=c.detail)==null?void 0:q.etiquetaSubId;if(!s||!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,b=n.findIndex(m=>m.etiqueta&&String(m.etiqueta.etiqueta_sub_id)===String(s));if(b===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${s}`);return}const w=n[b];renderizarGrupoSVG(w,b),console.log(`üîÑ SVG regenerado para etiqueta ${s} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pe):Pe();document.addEventListener("livewire:navigated",Pe);window.abrirModalDividirElemento=function(l,c){const s=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),b=document.getElementById("dividir_barras_totales"),w=document.getElementById("dividir_peso_total"),q=document.getElementById("labelBarrasActuales"),m=document.getElementById("barras_a_mover"),x=document.getElementById("previewDivision"),e=document.getElementById("formDividirElemento"),a=document.getElementById("badgeSugerenciaPeso"),o=document.getElementById("barrasSugeridas"),d=document.getElementById("detalleSugerencia");if(!s||!n||!e)return;n.value=l;let u=null,f=parseInt(c)||0;if(window.elementosAgrupadosScript){for(const y of window.elementosAgrupadosScript)if(y.elementos){const E=y.elementos.find(v=>String(v.id)===String(l));if(E){u=E,E.barras&&(f=parseInt(E.barras)||0);break}}}if(!u&&window.gruposResumenData){for(const y of window.gruposResumenData)if(y.elementos){const E=y.elementos.find(v=>String(v.id)===String(l));if(E){u=E,E.barras&&(f=parseInt(E.barras)||0);break}}}const i=u&&u.estado==="fabricado",t=u&&u.paquete_id,r=i||t,g=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),h=g==null?void 0:g.closest("label");if(g){if(g.disabled=r,h)if(r){h.classList.add("opacity-50","cursor-not-allowed");let y=i?"El elemento ya est√° fabricado":"El elemento pertenece a un paquete";h.setAttribute("title",y)}else h.classList.remove("opacity-50","cursor-not-allowed"),h.removeAttribute("title");if(r&&g.checked){const y=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');y&&(y.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}b&&(b.value=f),q&&(q.textContent=f>0?f:"-");const p=u&&parseFloat(u.peso_numerico)||0;w&&(w.value=p),console.log("üîç Debug badge sugerencia:",{peso_numerico:u==null?void 0:u.peso_numerico,pesoTotal:p,barrasTotales:f});const _=1200,C=document.getElementById("divisionAutoData");if(a&&o&&f>0&&p>0){const y=p/f,E=Math.floor(_/y);if(p>_&&E<f){const v=Math.ceil(f/E),I=Math.floor(f/v),M=f%v;C&&(C.value=JSON.stringify({elemento_id:l,etiqueta_sub_id:(u==null?void 0:u.etiqueta_sub_id)||null,num_etiquetas:v,barras_por_etiqueta:I,etiquetas_con_barra_extra:M,barras_totales:f,peso_por_barra:y}));let O="";if(M===0)O=`${v} etiquetas de ${I} barras cada una (~${(I*y).toFixed(0)} kg)`;else{const z=I+1,S=I;O=`${M} etiqueta(s) de ${z} barras + ${v-M} etiqueta(s) de ${S} barras`}o.textContent=`${v} etiquetas`,d.innerHTML=O+`<br><span class="text-xs text-amber-600">Barras m√°x por etiqueta: ${E} (para no superar ${_} kg)</span>`,a.classList.remove("hidden")}else a.classList.add("hidden"),C&&(C.value="")}else a&&a.classList.add("hidden"),C&&(C.value="");m&&(m.value=""),x&&x.classList.add("hidden"),window.rutaDividirElemento&&e.setAttribute("action",window.rutaDividirElemento),s.classList.remove("hidden")};window.enviarDivision=async function(){const l=document.getElementById("formDividirElemento"),c=l.getAttribute("action")||window.rutaDividirElemento,s=new FormData(l);try{const n=document.querySelector('meta[name="csrf-token"]'),b=s.get("_token")||(n?n.getAttribute("content"):null),q=await fetch(c,{method:"POST",headers:b?{"X-CSRF-TOKEN":b}:{},body:s}),m=await q.json();if(!q.ok||!m.success)throw new Error(m.message||"Error al dividir");l.reset();const x=document.getElementById("modalDividirElemento");x&&x.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",m.message,"success"):alert(m.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(A){const l={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",doblando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},c={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},doblando:{cssClass:"estado-doblando",bgColor:"#facc15",texto:"Doblando",icono:"‚öôÔ∏è"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function s(m,x,e={}){console.log(`üîÑ Actualizando etiqueta ${m} a estado: ${x}`);const a=String(m).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${a}`);if(!o)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${m}`),!1;const d=o.dataset.tieneMaquina2==="true"||e.es_secundaria;let u=String(x).toLowerCase().trim();const f=e.estado2||o.dataset.estado2||null;d&&f&&(u=f.toLowerCase().trim(),console.log(`üîÑ Usando estado2 para color: ${u}`));const i=String(x).toLowerCase().trim(),t=c[u]||c[i];if(!t)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${x}`),!1;o.dataset.estado=i,f&&(o.dataset.estado2=f),Array.from(o.classList).forEach(_=>{(_.startsWith("estado-")||_.startsWith("estado2-"))&&o.classList.remove(_)}),o.classList.add(t.cssClass),f&&o.classList.add(`estado2-${f}`),o.style.setProperty("--bg-estado",t.bgColor);const g=o.querySelector('[id^="contenedor-svg-"]');if(g){const _=g.querySelector("svg");_&&(_.style.background=t.bgColor)}const h=o.querySelector(".etiqueta-card")||o;h&&(h.style.background=t.bgColor),n(o,u);const p=o.querySelector(".estado-badge");if(p){const _=c[i];let C=_?_.texto:i;if(f){const y=c[f.toLowerCase()];C+="/"+(y?y.texto:f)}p.textContent=C,p.className="estado-badge ml-2 text-xs px-2 py-0.5 rounded-full",u==="pendiente"?p.classList.add("bg-gray-200","text-gray-700"):["fabricando","ensamblando","soldando","doblando"].includes(u)?p.classList.add("bg-yellow-200","text-yellow-800"):["fabricada","completada","ensamblada","soldada"].includes(u)?p.classList.add("bg-green-200","text-green-800"):u==="en-paquete"||u==="empaquetada"?p.classList.add("bg-purple-200","text-purple-800"):p.classList.add("bg-gray-200","text-gray-700")}return b(o),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:m,estado:i,datosExtra:e}})),console.log(`‚úÖ Etiqueta ${m} actualizada a ${x}`),!0}function n(m,x){const e=m.querySelectorAll(".btn-fabricar"),a=["empaquetada","en-paquete"];e.forEach(o=>{a.includes(x)?(o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed",o.title=`Etiqueta ya ${x}`):(o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer",o.title="Fabricar esta etiqueta")})}function b(m){m.style.transition="transform 0.5s ease, background-color 0.5s ease",m.style.transform="scale(1.03)",setTimeout(()=>{m.style.transform="scale(1)"},400)}function w(m,x,e={}){console.log(`üîÑ Actualizando ${m.length} etiquetas...`);const o=m.map(d=>s(d,x,e)).filter(d=>d).length;return console.log(`‚úÖ ${o}/${m.length} etiquetas actualizadas`),o}function q(m){const x=String(m).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${x}`);return e?{id:m,estado:e.dataset.estado||"desconocido",elemento:e}:null}window.addEventListener("paquete:creado",m=>{const{codigoPaquete:x,etiquetaIds:e}=m.detail;console.log(`üì¶ Evento paquete:creado recibido - ${x} con ${e.length} etiquetas`),w(e,"empaquetada",{codigo_paquete:x})}),A.SistemaDOM={actualizarEstadoEtiqueta:s,actualizarMultiplesEtiquetas:w,obtenerEstadoActual:q,ESTADOS_CONFIG:c},A.ColoresEstado={actualizar:(m,x)=>{l[m]=x;const e=document.getElementById("colores-estado-css");if(e){let a=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[o,d]of Object.entries(l))a+=`.proceso.estado-${o} {
    --bg-estado: ${d};
}
`;e.textContent=a,console.log(`‚úÖ Color actualizado para estado "${m}": ${x}`)}},obtenerColor:m=>l[m],todos:()=>({...l})}})(window);function Ne(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const e=localStorage.getItem("decisionCortePorEtiqueta");e&&(window._decisionCortePorEtiqueta=JSON.parse(e),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(e){console.warn("No se pudieron restaurar decisiones de corte:",e)}document.addEventListener("click",async e=>{var g,h,p;const a=e.target.closest(".btn-fabricar");if(!a)return;e.preventDefault();const o=(h=(g=document.getElementById("maquina-info"))==null?void 0:g.dataset)==null?void 0:h.maquinaId;if(!o){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const d=a.dataset.grupoId;if(d){const _=a.disabled;a.disabled=!0;try{await l(d,o)}finally{a.disabled=_}return}const u=String(a.dataset.etiquetaId||"").trim(),f=u.replace(/\./g,"-"),i=document.querySelector(`#etiqueta-${f}`);if(i){const _=(i.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(_)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${u} ya est√° en estado ${_}.`,timer:2500,showConfirmButton:!1});return}}const t=Number(((p=window.DIAMETRO_POR_ETIQUETA)==null?void 0:p[u])??0);if(!u){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!t&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const r=a.disabled;a.disabled=!0;try{await A(u,o,t)}finally{a.disabled=r}});async function A(e,a,o=null){var C,y,E,v,I,M,O,z;const d=`/actualizar-etiqueta/${e}/maquina/${a}`,u=(C=document.querySelector('meta[name="csrf-token"]'))==null?void 0:C.getAttribute("content"),f=e.replace(/\./g,"-"),t=(((E=(y=document.querySelector(`#etiqueta-${f}`))==null?void 0:y.dataset)==null?void 0:E.estado)||"").toLowerCase()==="fabricando",r=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",g=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",h=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",p=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:r,esSL28:g,esCortadoraManual:h,esCortadoraDobladoraBarra:p}),r&&g||h||p){if(t)if((v=window._decisionCortePorEtiqueta)!=null&&v[e]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[e],csrfToken:u,etiquetaId:e,onUpdate:n,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[e],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const S=await fetch(`/api/etiquetas/${e}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":u}});if(S.ok){const L=await S.json();if(L.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:L.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:e,elementos:[]}],csrfToken:u,etiquetaId:e,onUpdate:n,pedirDesperdicio:!1});return}}}catch(S){console.warn("No se pudo obtener longitud asignada:",S)}for(;;){let S;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),S=await Cortes.mejorCorteSimple(e,o,u),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",S)}catch(L){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",L),x(L);return}if(!S){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",S.accion),S.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let L;try{L=await Cortes.mejorCorteOptimizado(e,o,S.patrones,u)}catch(D){x(D);return}if((L==null?void 0:L.accion)==="fabricar"){const D=((I=L.patronInfo)==null?void 0:I.desperdicio_cm)||((M=L.patron)==null?void 0:M.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[e]={longitudBarraCm:L.longitudBarraCm,etiquetas:L.etiquetas,desperdicioEstimadoCm:D},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[e],csrfToken:u,etiquetaId:e,onUpdate:n});if($!=null&&$.cancelled)continue;return}else{if(L==="volver")continue;return}}if(S.accion==="fabricar_patron_simple"){const L=Math.round(Number(S.longitud_m||0)*100);if(!L){x("Longitud de barra no v√°lida.");return}const D=((O=S.patronInfo)==null?void 0:O.desperdicio_cm)||((z=S.patron)==null?void 0:z.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[e]={longitudBarraCm:L,etiquetas:[{etiqueta_sub_id:e,elementos:[]}],desperdicioEstimadoCm:D},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[e],csrfToken:u,etiquetaId:e,onUpdate:n});if($!=null&&$.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(e,a,u)}catch(S){x(S)}return}try{const S=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({})}),L=await S.json();if(!S.ok)throw new Error(L.message||"Error al actualizar");n(e,L)}catch(S){x(S)}}async function l(e,a){var _,C,y,E,v,I,M,O,z;const o=(_=document.querySelector('meta[name="csrf-token"]'))==null?void 0:_.getAttribute("content"),d=document.querySelector(`[data-grupo-id="${e}"] .etiqueta-card`),u=(((C=d==null?void 0:d.dataset)==null?void 0:C.estado)||"pendiente").toLowerCase(),f=parseInt((y=d==null?void 0:d.dataset)==null?void 0:y.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(u)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${u}.`,timer:2500,showConfirmButton:!1});return}const i=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",t=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",r=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",g=i&&t||r;let h=[];try{h=JSON.parse(((E=d==null?void 0:d.dataset)==null?void 0:E.etiquetasSubIds)||"[]")}catch(S){console.warn("Error parseando etiquetas del grupo:",S)}const p=(v=d==null?void 0:d.dataset)==null?void 0:v.primeraEtiquetaId;if((I=d==null?void 0:d.dataset)!=null&&I.planillaId||window.PLANILLA_ID,u==="pendiente"&&g&&p){try{for(;;){const S=await Cortes.mejorCorteSimple(p,f,o);if(!S)return;if(S.accion==="optimizar"){const L=await Cortes.mejorCorteOptimizado(p,f,null,o);if(L==="volver")continue;if(!L||L.accion!=="fabricar")return;const D=((M=L.patronInfo)==null?void 0:M.desperdicio_cm)||0;let $=null;const N=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:L.longitudBarraCm,etiquetas:L.etiquetas,csrfToken:o,etiquetaId:p,desperdicioEstimadoCm:D,onUpdate:(F,P)=>{P.producto_n_colada&&($={colada1:P.producto_n_colada,colada2:P.producto2_n_colada||null}),c(d,"fabricando",e,$)},pedirDesperdicio:!0});if(N!=null&&N.cancelled)continue;c(d,"fabricando",e,$),m("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(S.accion==="fabricar_patron_simple"){const L=Math.round(Number(S.longitud_m||0)*100);if(!L){x("Longitud de barra no v√°lida.");return}const D=((O=S.patronInfo)==null?void 0:O.desperdicio_cm)||((z=S.patron)==null?void 0:z.sobra_cm)||0,$=h.map(P=>({etiqueta_sub_id:P,patron_letras:S.patron_letras||""}));let N=null;const F=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:L,etiquetas:$,csrfToken:o,etiquetaId:p,desperdicioEstimadoCm:D,onUpdate:(P,Y)=>{Y.producto_n_colada&&(N={colada1:Y.producto_n_colada,colada2:Y.producto2_n_colada||null}),c(d,"fabricando",e,N)},pedirDesperdicio:!0});if(F!=null&&F.cancelled)continue;c(d,"fabricando",e,N),m("info","Fabricando",`Grupo iniciado (${h.length} etiquetas)`);return}return}}catch(S){x(S)}return}try{const S=await fetch(`/api/etiquetas/resumir/${e}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({maquina_id:a})}),L=await S.json();if(!S.ok||!L.success)throw new Error(L.message||"Error al actualizar grupo");const D=L.nuevo_estado||"actualizado",$=L.imprimir_etiquetas||[],N={colada1:L.producto_n_colada||null,colada2:L.producto2_n_colada||null};if(c(d,D,e,N),D==="fabricando"){const F=N.colada1?` - Colada: ${N.colada1}`:"";m("info","Fabricando",`Grupo iniciado (${L.etiquetas_actualizadas||0} etiquetas)${F}`)}else D==="completada"&&m("success","¬°Completado!",`Grupo completado (${L.etiquetas_actualizadas||0} etiquetas)`);if(D==="completada"&&$.length>0){const F=$.map(Y=>Y.etiqueta_sub_id),P=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${F.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(P.isConfirmed||P.isDenied){const Y=P.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(ue=>setTimeout(ue,200)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(F,Y)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let Y=0;for(const ue of F)try{const k=await window.TrabajoPaquete.validarEtiqueta(ue);k.valida&&window.TrabajoPaquete.agregarItemEtiqueta(ue,k)&&Y++}catch(k){console.warn(`No se pudo a√±adir ${ue} al carro:`,k)}Y>0&&m("success","A√±adidas al carro",`${Y} etiquetas a√±adidas al carro`)}c(d,"completada",e)}}catch(S){x(S)}}function c(e,a,o,d=null){if(!e)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(i=>{e.classList.remove(`estado-${i}`)}),e.classList.add(`estado-${a}`),e.dataset.estado=a;const u=e.dataset.contenedorSvgId,f=e.dataset.elementos;if(u&&f&&typeof window.renderizarGrupoSVG=="function")try{const i=JSON.parse(f);d&&(i.forEach(r=>{r.coladas={colada1:d.colada1||null,colada2:d.colada2||null,colada3:null}}),e.dataset.elementos=JSON.stringify(i));const t={id:parseInt(u),etiqueta:{id:parseInt(u)},elementos:i};window.renderizarGrupoSVG(t,o)}catch(i){console.warn("No se pudo re-renderizar SVG del grupo:",i)}}async function s(e,a,o){var L,D,$,N,F;const d=Number(((L=window.DIAMETRO_POR_ETIQUETA)==null?void 0:L[e])??0),f=Number(((D=window.LONGITUD_POR_ETIQUETA)==null?void 0:D[e])??0)/100;let i="";try{const P=await fetch(`/api/productos/sugerencias?diametro=${d}&longitud=${f}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(P.ok){const Y=await P.json();Y.productos&&Y.productos.length>0?i=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${d}mm x ${f.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Y.productos.map(ue=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${ue.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${ue.codigo}</td>
                                                <td class="px-2 py-1">${ue.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${ue.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${ue.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:i=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${d}mm x ${f.toFixed(1)}m</p>`}}catch(P){console.warn("No se pudieron cargar sugerencias:",P)}const{value:t,isConfirmed:r}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${i}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const P=document.getElementById("swal-input-producto").value;return!P||!P.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):P.trim()}});if(!r||!t)return;let g;try{const P=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(t.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(!P.ok){const Y=await P.json();throw new Error(Y.message||"Producto no encontrado")}g=await P.json()}catch(P){await Swal.fire({icon:"error",title:"Producto no encontrado",text:P.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${t}`});return}const h=(g.tipo||"").toLowerCase(),p=Number(g.diametro??0),_=Number(g.longitud??0);if(h&&h!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${g.codigo}</p>
                        <p><strong>Tipo:</strong> ${g.tipo||"N/A"}</p>
                    </div>
                `});return}if(p>0&&d>0&&Math.abs(p-d)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${p} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${d} mm</p>
                    </div>
                `});return}if(_>0&&f>0&&Math.abs(_-f)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${_.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${f.toFixed(2)} m</p>
                    </div>
                `});return}const C=g.longitud?`${g.longitud} m`:"N/A",{value:y,isConfirmed:E}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${g.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${g.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${C}</p>
                    <p><strong>Stock actual:</strong> ${(($=g.peso_stock)==null?void 0:$.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${g.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!E)return;const v=y==="completo",I=`/actualizar-etiqueta/${e}/maquina/${a}`,M=await fetch(I,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({producto_id:g.id,paquete_completo:v})}),O=await M.json();if(!M.ok)throw new Error(O.message||"Error al fabricar");const z=((N=O.metricas)==null?void 0:N.peso_consumido)||0,S=((F=O.metricas)==null?void 0:F.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${g.codigo}</p>
                <p><strong>Peso consumido:</strong> ${z.toFixed(2)} kg</p>
                ${S?`<p><strong>Paquete:</strong> ${S}</p>`:""}
                ${v?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),n(e,O),S&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const P=document.getElementById("codigo_paquete_mover");P&&(P.value=S,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function n(e,a){var d,u;const o=e.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:e,estado:a.estado,peso_etiqueta:a.peso_etiqueta,nombre:a.nombre,producto_n_colada:a.producto_n_colada,producto2_n_colada:a.producto2_n_colada,data_completa:a}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(e,a.estado,{peso:a.peso_etiqueta,nombre:a.nombre||e,estado2:a.estado2||null,es_secundaria:a.es_secundaria||!1}):b(e,a.estado),a.estado2){const f=String(e).replace(/\./g,"-"),i=document.getElementById(`etiqueta-${f}`);i&&(i.dataset.estado2=a.estado2)}if(a.producto_n_colada&&window.elementosAgrupadosScript){const f=window.elementosAgrupadosScript.findIndex(i=>i.etiqueta&&String(i.etiqueta.etiqueta_sub_id)===String(e));if(f!==-1){const i=window.elementosAgrupadosScript[f];i.colada_etiqueta=a.producto_n_colada,i.colada_etiqueta_2=a.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(i,f),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${a.producto_n_colada}`))}}switch(a.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(e,a.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(e,!0),(a.estado||"").toLowerCase()){case"pendiente":m("info","Pendiente","La etiqueta est√° pendiente de fabricaci√≥n.");break;case"cortando":m("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":m("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),w(o);break;case"fabricando":m("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":m("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),w(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(e,{id:e,peso_etiqueta:a.peso_etiqueta||0,estado:"fabricada",nombre:a.nombre||e}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(i=>i.coladas&&(i.coladas.colada1||i.coladas.colada2||i.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${e}`,a.elementos),q(e,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${e}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${e}`);break;case"completada":m("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(d=window._decisionCortePorEtiqueta)!=null&&d[e]&&(delete window._decisionCortePorEtiqueta[e],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),w(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(e,{id:e,peso_etiqueta:a.peso_etiqueta||0,estado:"completada",nombre:a.nombre||e}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(i=>i.coladas&&(i.coladas.colada1||i.coladas.colada2||i.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${e}`,a.elementos),q(e,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${e}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${e}`);break;case"ensamblando":m("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":m("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),w(o);break;case"soldando":m("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":m("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),w(o);break;case"doblando":m("info","Doblando","La etiqueta est√° en proceso de doblado.");break;case"completada":m("success","Doblado completado","El proceso de doblado ha finalizado correctamente."),w(o);break;default:console.warn(`Estado no manejado para etiqueta ${e}: ${a.estado}`),m("warning","Estado desconocido",`El estado recibido (${a.estado}) no est√° reconocido.`,3e3)}(u=a.productos_afectados)!=null&&u.length&&a.productos_afectados.forEach(f=>{const i=document.getElementById(`peso-stock-${f.id}`),t=document.getElementById(`progreso-texto-${f.id}`),r=document.getElementById(`progreso-barra-${f.id}`);i&&(i.textContent=`${f.peso_stock} kg`),t&&(t.textContent=`${f.peso_stock} / ${f.peso_inicial} kg`),r&&(r.style.height=`${f.peso_stock/f.peso_inicial*100}%`)})}function b(e,a){const o=e.replace(/\./g,"-"),d=document.getElementById("etiqueta-"+o);if(!d)return;d.dataset.estado=String(a||"").toLowerCase(),d.className=d.className.split(" ").filter(i=>!i.startsWith("estado-")).join(" ").trim(),d.classList.add("estado-"+d.dataset.estado);const u=d.querySelector('[id^="contenedor-svg-"]'),f=u==null?void 0:u.querySelector("svg");f&&(f.style.background=getComputedStyle(d).getPropertyValue("--bg-estado").trim())}function w(e){const a=`#etiqueta-${CSS.escape(e)}`,o=document.querySelector(a),d=Array.from(document.querySelectorAll(".proceso")),u=p=>(p||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),f=p=>{var y;const _=(y=p.dataset)==null?void 0:y.estado;if(_)return u(_);const C=p.querySelector('[id^="estado-"]');return u((C==null?void 0:C.textContent)||(C==null?void 0:C.innerText)||"")},i=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),t=p=>i.has(f(p)),r=o?d.indexOf(o):-1,h=(r>=0?d.slice(r+1):d).find(p=>!t(p));h?h.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function q(e,a){var i;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${e}`),!a||!Array.isArray(a)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${e}`);return}if(a.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${e}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const o=window.elementosAgrupadosScript.findIndex(t=>{var r;return((r=t.etiqueta)==null?void 0:r.etiqueta_sub_id)===e});if(o===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${e}`);return}window.elementosAgrupadosScript[o].elementos=a;const d=window.elementosAgrupadosScript[o],u=(i=d.etiqueta)==null?void 0:i.id;if(!u){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${e}`);return}const f=document.getElementById("contenedor-svg-"+u);if(!f){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${e} (id: ${u})`);return}try{const t=f.querySelector("svg");t&&t.remove();const r=600,g=150,h=f.closest(".proceso"),p=h&&getComputedStyle(h).getPropertyValue("--bg-estado").trim()||"#e5e7eb",_=document.createElementNS("http://www.w3.org/2000/svg","svg");_.setAttribute("viewBox",`0 0 ${r} ${g}`),_.setAttribute("preserveAspectRatio","xMidYMid meet"),_.style.width="100%",_.style.height="100%",_.style.display="block",_.style.background=p;const C=(d.elementos||[]).map((E,v)=>{var S,L,D;const I=E.barras!=null?E.barras:0;let M="N/A";if(E.diametro!=null&&E.diametro!==""){const N=String(E.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(N){const F=parseFloat(N[0]);isFinite(F)&&(M=String(Math.round(F)))}}const O=[];(S=E.coladas)!=null&&S.colada1&&O.push(E.coladas.colada1),(L=E.coladas)!=null&&L.colada2&&O.push(E.coladas.colada2),(D=E.coladas)!=null&&D.colada3&&O.push(E.coladas.colada3);const z=O.length>0?` (${O.join(", ")})`:"";return{letter:indexToLetters(v),text:`√ò${M} x${I}${z}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(_,C,r,g):console.error("‚ùå drawLegendBottomLeft no est√° definida");const y=document.createElementNS("http://www.w3.org/2000/svg","text");y.setAttribute("x",r/2),y.setAttribute("y",g/2),y.setAttribute("text-anchor","middle"),y.setAttribute("fill","#059669"),y.setAttribute("font-size","14"),y.setAttribute("font-weight","600"),y.textContent="‚úì Coladas actualizadas",_.appendChild(y),f.appendChild(_),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${e}`),setTimeout(()=>{y&&y.parentNode&&y.remove()},2e3)}catch(t){console.error(`‚ùå Error al actualizar SVG para etiqueta ${e}:`,t),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function m(e,a,o,d=2e3){Swal.fire({icon:e,title:a,text:o,timer:d,showConfirmButton:!1})}function x(e){Swal.fire({icon:"error",title:"Error",text:e.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=n}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ne):Ne();document.addEventListener("livewire:navigated",Ne);(function(A){let l=[],c=!1,s=null;async function n(t){var g;const r=`/etiquetas/${encodeURIComponent(t)}/validar-para-paquete`;try{const h=await fetch(r,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.content}});if(!(h.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const _=await h.json();if(!h.ok)throw new Error((_==null?void 0:_.message)||(_==null?void 0:_.motivo)||"Error al validar");return _}catch(h){throw h}}function b(t,r){const g=r.id||t;if(l.some(_=>_.id===g))return!1;const h=parseFloat(r.peso_etiqueta)||0,p={id:g,type:"etiqueta",peso:h,estado:r.estado||"desconocido",nombre:r.nombre||"Sin nombre"};return l.push(p),e(),!0}function w(t){const r=l.findIndex(g=>g.id===t);r>=0&&l.splice(r,1),e()}function q(){l=[],e()}function m(){return l.reduce((t,r)=>t+(parseFloat(r.peso)||0),0)}function x(){return l}function e(){const t=document.getElementById("itemsList");if(!t)return;t.innerHTML="";for(const h of l){const p=document.createElement("li");p.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",p.dataset.code=h.id,p.innerHTML=`
                <div>
                    <div class="font-semibold">${h.id}</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,p.querySelector("button").onclick=()=>w(h.id),t.appendChild(p)}const r=m(),g=document.createElement("li");g.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",g.textContent=`Total: ${Math.round(r)} kg (${l.length} etiquetas)`,t.appendChild(g)}async function a(){var _,C,y;if(!l.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const t=Number(((C=(_=document.getElementById("maquina-info"))==null?void 0:_.dataset)==null?void 0:C.maquinaId)||window.maquinaId),r=Number(((y=document.getElementById("ubicacion-id"))==null?void 0:y.value)||window.ubicacionId),g=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!t){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!g&&!r){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const h={items:l.map(E=>({id:E.id,type:E.type})),maquina_id:t,ubicacion_id:g?null:r,sin_ubicacion:g},p=async(E={})=>{var M;const v=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(M=document.querySelector('meta[name="csrf-token"]'))==null?void 0:M.content},body:JSON.stringify({...h,...E})}),I=await v.json();if(!v.ok)throw new Error(I.message||"Error al crear el paquete");return I};try{const E=await p();if(E.success)return o(E);if(E.warning){let v="<div style='text-align:left;'>Se detectaron advertencias:";for(const[M,O]of Object.entries(E.warning))Array.isArray(O)&&O.length&&(v+=`<br><strong>${M.replaceAll("_"," ")}:</strong> ${O.join(", ")}`);if(v+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:v,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const M=await p({confirmar:!0});if(M.success)return o(M);throw new Error(M.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(E){await Swal.fire("Error",E.message||"Error inesperado","error")}}async function o(t){var _;console.log("üì¶ postCreacion llamada con data:",t);const r=t.codigo_paquete||((_=t.paquete)==null?void 0:_.codigo)||"N/D",g=m(),h=[...l.map(C=>C.id)];console.log("üì¶ Etiquetas a actualizar:",h),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${r}</strong> creado correctamente</p>
                       <p>${h.length} etiquetas ¬∑ ${g.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),q(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const C=document.getElementById("codigo_paquete_mover");C&&(C.value=r,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},50)))},50))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${r}</strong> creado correctamente</p><p>${h.length} etiquetas ¬∑ ${g.toFixed(2)} kg</p>`}),q()),console.log(`üì¶ Disparando evento paquete:creado para ${r}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:r,etiquetaIds:h,pesoTotal:g}})),console.log(`üîÑ Actualizando DOM para ${h.length} etiquetas con paquete ${r}`),h.forEach(C=>{d(C,r)})}function d(t,r){const g=String(t).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${t} (safe: ${g})`);let h=document.querySelector(`#etiqueta-${g}`);if(h&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${g}`),!h){const v=document.querySelector(`[data-etiqueta-sub-id="${t}"]`);v&&(h=v.querySelector(".etiqueta-card"),h&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!h){const v=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${v.length} grupos...`);for(const I of v)try{const M=JSON.parse(I.dataset.etiquetasSubIds||"[]");if(M.includes(t)){h=I,console.log(`‚úÖ Etiqueta ${t} encontrada en grupo con ${M.length} etiquetas`);break}}catch(M){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",M)}}if(!h){console.warn(`‚ùå No se encontr√≥ elemento: ${t}`);return}console.log(`üîÑ Actualizando manualmente: ${t}`),Array.from(h.classList).forEach(v=>{v.startsWith("estado-")&&h.classList.remove(v)}),h.classList.add("estado-en-paquete"),h.dataset.estado="en-paquete",h.style.setProperty("--bg-estado","#e3e4FA");const _=h.querySelector('[id^="contenedor-svg-"]');if(_){const v=_.querySelector("svg");v&&(v.style.background="#e3e4FA")}const C=h.querySelector(".etiqueta-card")||h;C&&(C.style.background="#e3e4FA");const y=h.querySelector(".paquete-codigo");y?(y.textContent=`(${r})`,y.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${r})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),h.querySelectorAll(".btn-fabricar").forEach(v=>{v.disabled=!0,v.style.opacity="0.5",v.style.cursor="not-allowed"}),h.style.transition="transform 0.5s ease, background-color 0.5s ease",h.style.transform="scale(1.03)",setTimeout(()=>{h.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${t} actualizada manualmente`)}function u(){f(),c||(i(),c=!0)}function f(){const t=document.getElementById("qrItem");t&&!t.dataset.initialized&&(t.dataset.initialized="true",t.addEventListener("change",()=>t.dispatchEvent(new Event("input"))),t.addEventListener("input",async function(){const r=this.value.trim();if(r)try{const g=await n(r);if(!g.valida){await Swal.fire("Etiqueta no v√°lida",g.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}b(r,g)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(g){console.error("Error de validaci√≥n:",g),await Swal.fire("Error",g.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}))}function i(){document.addEventListener("click",async function(t){if(t.target.id==="crearPaqueteBtn"||t.target.closest("#crearPaqueteBtn")){t.preventDefault(),await a();return}}),document.addEventListener("focus",function(t){t.target.id&&t.target.id.startsWith("input-etiqueta-")&&(s=t.target,console.log("üéØ Focus en input:",t.target.id))},!0),document.addEventListener("click",async function(t){var r;if(t.target.classList.contains("btn-agregar-carro")||t.target.closest(".btn-agregar-carro")){const h=(t.target.classList.contains("btn-agregar-carro")?t.target:t.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!h){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const p=document.querySelector(`[x-show="tabActivo === 'crear'"]`),_=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(p&&window.getComputedStyle(p).display,_&&window.getComputedStyle(_).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let y=document.activeElement;(!y||!((r=y.id)!=null&&r.startsWith("input-etiqueta-")))&&(y=s),(!y||!document.body.contains(y))&&(y=document.querySelector('input[id^="input-etiqueta-"]')),y?(y.value=h,y.focus(),y.classList.add("ring-4","ring-green-400"),setTimeout(()=>{y.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${h} a√±adida al input:`,y.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",h);try{const y=await n(h);if(!y.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:y.motivo||"Motivo no especificado"});return}b(h,y)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(y){console.error("Error al a√±adir al carro:",y),await Swal.fire({icon:"error",title:"Error",text:y.message||"No se pudo a√±adir al carro"})}}if(t.target.classList.contains("btn-agregar-carro-grupo")||t.target.closest(".btn-agregar-carro-grupo")){const g=t.target.classList.contains("btn-agregar-carro-grupo")?t.target:t.target.closest(".btn-agregar-carro-grupo"),h=g.dataset.grupoId;let p=[];try{p=JSON.parse(g.dataset.etiquetas||"[]")}catch(I){console.error("Error parseando etiquetas del grupo:",I);return}if(!p.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${p.length} etiquetas del grupo ${h} al carro`);let _=0,C=0,y=0,E=[];const v=await Promise.all(p.map(async I=>{try{const M=await n(I.id);return{id:I.id,data:M,error:null}}catch(M){return{id:I.id,data:null,error:M}}}));for(const{id:I,data:M,error:O}of v){if(O){y++,console.error("Error validando etiqueta:",I,O);continue}if(!M.valida){y++,M.motivo&&!E.includes(M.motivo)&&E.push(M.motivo);continue}b(I,M)?_++:C++}if(_>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${_}</strong> etiquetas al carro.</p>
                            ${C>0?`<p class="text-gray-500">${C} ya estaban en el carro.</p>`:""}
                            ${y>0?`<p class="text-red-500">${y} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(C>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const I=E.length>0?`<ul class="text-left mt-2 text-sm">${E.map(M=>`<li>‚Ä¢ ${M}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${I}
                        `})}}})}A.TrabajoPaquete={inicializar:u,agregarItemEtiqueta:b,eliminarItem:w,limpiarCarro:q,obtenerItems:x,calcularPesoTotal:m,crearPaquete:a,validarEtiqueta:n,actualizarListaVisual:e},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u(),document.addEventListener("livewire:navigated",u)})(window);function Oe(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(l,c){const s=document.getElementById("grid-maquina");if(!s)return;console.log("üîß Actualizando clases:",{showLeft:l,showRight:c,clasesAnteriores:s.className}),l||c?s.classList.add("columnas-laterales-visibles"):s.classList.remove("columnas-laterales-visibles"),l&&c?s.classList.add("ambas-columnas"):s.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",s.className),s.offsetHeight,s.querySelectorAll(".etiqueta-card").forEach(b=>{b.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)});function A(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((b,w)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),w.disconnect();const m=JSON.parse(localStorage.getItem("showLeft")??"true"),x=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(m,x)}}).observe(document.body,{childList:!0,subtree:!0});return}const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}A()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Oe):Oe();document.addEventListener("livewire:navigated",Oe);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const A={debounceTime:500};let l=0;async function c(a){var u;const o=Date.now();if(o-l<A.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};l=o;const d=(u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${a}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const i=await fetch(`/etiquetas/${encodeURIComponent(a)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),t=await i.json();return!i.ok||!t.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:t.message||"No se pudo revertir el cambio."}),{success:!1,message:t.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${t.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${t.estado}</strong>
                    </p>
                    ${t.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),w(a,t),t)}catch(f){return console.error("Error al deshacer etiqueta:",f),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:f.message}}}async function s(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/puede-deshacer`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{puede_deshacer:!1}}catch(o){return console.error("Error al verificar undo:",o),{puede_deshacer:!1}}}async function n(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/historial`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{success:!1,historial:[]}}catch(o){return console.error("Error al obtener historial:",o),{success:!1,historial:[]}}}async function b(a){var u;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const o=await n(a);if(!o.success||!((u=o.historial)!=null&&u.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=o.historial.map((f,i)=>`
            <tr class="${f.revertido?"bg-gray-100 text-gray-400":i===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${f.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${f.accion}</td>
                <td class="px-2 py-1 text-xs">${f.estado_anterior||"-"} ‚Üí ${f.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${f.revertido?'<span class="text-gray-400">Revertido</span>':i===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${a}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${o.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${o.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:o.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:o.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:o.puede_deshacer?"#f59e0b":"#6b7280"}).then(f=>{f.isConfirmed&&o.puede_deshacer&&c(a)})}function w(a,o){const d=a.replace(/\./g,"-"),u=document.getElementById(`etiqueta-${d}`);if(u){u.dataset.estado=o.estado,u.className=u.className.split(" ").filter(t=>!t.startsWith("estado-")).join(" ").trim(),u.classList.add(`estado-${o.estado}`);const f=u.querySelector('[id^="contenedor-svg-"]'),i=f==null?void 0:f.querySelector("svg");i&&(i.style.background=getComputedStyle(u).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(a,o.estado)}if(o.estado==="pendiente"){if(window.elementosAgrupadosScript){const t=window.elementosAgrupadosScript.find(r=>r.etiqueta&&String(r.etiqueta.etiqueta_sub_id)===String(a));t&&(t.colada_etiqueta=null,t.colada_etiqueta_2=null,t.elementos&&t.elementos.forEach(r=>{r.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:a}})))}const f=document.getElementById(`colada-${d}`);f&&(f.textContent="")}console.log(`‚úÖ DOM actualizado para ${a}: estado = ${o.estado}`)}function q(a,o){const d=a.replace(/\./g,"-"),u=document.querySelector(`#etiqueta-${d} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${a}, puede=${o}, btn encontrado=${!!u}`),u&&(u.disabled=!1,u.classList.remove("opacity-50","cursor-not-allowed"),u.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function m(){document.addEventListener("click",async a=>{const o=a.target.closest(".btn-deshacer");if(!o)return;a.preventDefault(),a.stopPropagation();const d=o.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await c(d)}),document.addEventListener("click",async a=>{const o=a.target.closest(".btn-historial");if(!o)return;a.preventDefault(),a.stopPropagation();const d=o.dataset.etiquetaId;d&&await b(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function x(){let a=null;window.addEventListener("etiqueta-fabricada",o=>{var d;(d=o.detail)!=null&&d.etiquetaSubId&&(a=o.detail.etiquetaSubId)}),document.addEventListener("keydown",async o=>{var d,u;if(o.ctrlKey&&o.key==="z"&&!o.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const f=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),i=((u=f==null?void 0:f.dataset)==null?void 0:u.etiquetaId)||a;i&&(o.preventDefault(),await c(i))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function e(){m(),x(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:c,puedeDeshacer:s,obtenerHistorial:n,mostrarHistorial:b,actualizarBoton:q},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e(),document.addEventListener("livewire:navigated",e)})();
