const L=()=>window.AppPlanif,M=()=>L().csrf,j=()=>L().routes,W=()=>{var n;const o=L()||{};let l=o.turnos;return Array.isArray(l)||(l=((n=o.turnosConfig)==null?void 0:n.turnos)||[]),{maquinas:o.maquinas||[],eventos:o.eventos||[],cargaTrabajo:o.cargaTrabajo||{},turnos:l}};let P=null;function E(){P&&(P.remove(),P=null,document.removeEventListener("click",E),document.removeEventListener("scroll",E,!0),window.removeEventListener("resize",E))}function O(o,l,n){E();const r=document.createElement("div");r.className="fc-contextmenu",Object.assign(r.style,{position:"fixed",zIndex:9999,minWidth:"240px",background:"#fff",border:"1px solid #e5e7eb",boxShadow:"0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05)",borderRadius:"8px",overflow:"hidden",visibility:"hidden"}),r.innerHTML=n,document.body.appendChild(r);const i=r.getBoundingClientRect(),a=window.innerHeight,c=window.innerWidth;let s=l;l+i.height>a&&(s=l-i.height,s<0&&(s=Math.max(0,a-i.height)));let m=o;return o+i.width>c&&(m=o-i.width,m<0&&(m=Math.max(0,c-i.width))),Object.assign(r.style,{top:s+"px",left:m+"px",visibility:"visible"}),P=r,setTimeout(()=>{document.addEventListener("click",E),document.addEventListener("scroll",E,!0),window.addEventListener("resize",E)},0),r}function K(o,l,{headerHtml:n="",items:r=[]}){const i=`
    <div class="ctx-menu-container">
      ${n?`<div class="ctx-menu-header">${n}</div>`:""}
      ${r.map((c,s)=>`
        <button class="ctx-menu-item${c.danger?" ctx-menu-danger":""}${c.disabled?" ctx-menu-disabled":""}" data-idx="${s}" ${c.disabled?"disabled":""}>
          ${c.icon?`<span class="ctx-menu-icon">${c.icon}</span>`:""}
          <span class="ctx-menu-label">${c.label}</span>
        </button>
      `).join("")}
    </div>
  `,a=O(o,l,i);return a.querySelectorAll(".ctx-menu-item").forEach(c=>{const s=parseInt(c.dataset.idx,10),m=r[s];c.addEventListener("click",async y=>{if(y.preventDefault(),y.stopPropagation(),console.log("[baseMenu] Click en item:",m.label,"disabled:",m.disabled),m.disabled){console.log("[baseMenu] Item deshabilitado, ignorando");return}const f=m.onClick;console.log("[baseMenu] Ejecutando acci√≥n..."),E();try{await(f==null?void 0:f()),console.log("[baseMenu] Acci√≥n completada")}catch(u){console.error("[baseMenu] Error en acci√≥n:",u)}})}),a}async function B(o,l={}){const n={headers:{Accept:"application/json","X-CSRF-TOKEN":M()},...l};n.body&&typeof n.body!="string"&&(n.headers["Content-Type"]="application/json",n.body=JSON.stringify(n.body));const r=await fetch(o,n);let i=null;try{i=await r.json()}catch{}if(!r.ok)throw new Error((i==null?void 0:i.message)||`HTTP ${r.status}`);return i}async function Y(o){const l=await Swal.fire({title:"Nuevo festivo",input:"text",inputLabel:"T√≠tulo del festivo",inputValue:"Festivo",showCancelButton:!0,confirmButtonText:"Crear",cancelButtonText:"Cancelar",inputValidator:r=>!r||!r.trim()?"Pon un t√≠tulo":void 0});return l.isConfirmed?(await B(j().festivo.store,{method:"POST",body:{fecha:o,titulo:l.value.trim()}})).festivo:null}function J(o){var r,i,a;if(!o)return null;const[l]=o.split(":").map(Number),n=((i=(r=window.AppPlanif)==null?void 0:r.turnosConfig)==null?void 0:i.turnos)||((a=window.AppPlanif)==null?void 0:a.turnos)||[];for(const c of n){if(!c.hora_inicio||!c.hora_fin)continue;const[s]=c.hora_inicio.split(":").map(Number),[m]=c.hora_fin.split(":").map(Number),y=m<s;let f=!1;if(y?f=l>=s||l<m:f=l>=s&&l<m,f)return c.nombre}return l>=0&&l<8?"noche":l>=8&&l<16?"ma√±ana":"tarde"}const H=[{bg:"bg-emerald-50",border:"border-emerald-200",text:"text-emerald-700",badge:"bg-emerald-100 text-emerald-800"},{bg:"bg-blue-50",border:"border-blue-200",text:"text-blue-700",badge:"bg-blue-100 text-blue-800"},{bg:"bg-amber-50",border:"border-amber-200",text:"text-amber-700",badge:"bg-amber-100 text-amber-800"},{bg:"bg-purple-50",border:"border-purple-200",text:"text-purple-700",badge:"bg-purple-100 text-purple-800"},{bg:"bg-rose-50",border:"border-rose-200",text:"text-rose-700",badge:"bg-rose-100 text-rose-800"},{bg:"bg-cyan-50",border:"border-cyan-200",text:"text-cyan-700",badge:"bg-cyan-100 text-cyan-800"}];function G(o,l,n,r){const i=H[r%H.length],a=`swal-trabajador-${n}-${l}`,c=o.operarios.length;if(c===0)return"";const s=o.operarios.map(m=>`<option value="${m.id}">${m.name} ${m.primer_apellido||""} ${m.segundo_apellido||""}</option>`).join("");return`
        <div class="mb-3 ${i.bg} ${i.border} border rounded-lg p-2">
            <label class="block text-xs font-semibold ${i.text} mb-1">
                ${o.empresa_nombre}
                <span class="${i.badge} text-xs px-1.5 py-0.5 rounded-full ml-1">${c}</span>
            </label>
            <select id="${a}" data-tipo="${n}" class="swal2-input w-full select-operario text-sm py-1" style="margin: 0;">
                <option value="" selected>Seleccionar...</option>
                ${s}
            </select>
        </div>
    `}function N(o,l,n,r){if(!o||o.length===0)return`
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-500 mb-2">${n}</p>
                <p class="text-xs text-gray-400 italic">No hay operarios</p>
            </div>
        `;const i=o.reduce((c,s)=>c+s.operarios.length,0),a=o.map((c,s)=>G(c,s,l,s)).join("");return`
        <div class="mb-4">
            <p class="text-sm font-semibold text-gray-700 mb-2">
                ${n} <span class="${r}">(${i})</span>
            </p>
            <div class="space-y-2 max-h-48 overflow-y-auto pr-1">
                ${a}
            </div>
        </div>
    `}async function U(o,l,n,r=null){const i=J(r);console.log("[generarTurnos] horaISO:",r,"turnoDetectado:",i);let a={sin_turno_por_empresa:[],de_maquina_por_empresa:[],todos_por_empresa:[],todos:[]};try{const u=await fetch(`/api/usuarios/operarios-agrupados?fecha=${o}&maquina_id=${l}`,{headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"}});u.ok?(a=await u.json(),console.log("[generarTurnos] Datos recibidos:",a)):console.error("Error al obtener operarios:",u.status)}catch(u){console.error("Error al obtener operarios:",u)}const c=i?`<span class="text-green-600 font-semibold">${i.charAt(0).toUpperCase()+i.slice(1)}</span>`:'<span class="text-gray-400">No detectado</span>',s=N(a.sin_turno_por_empresa,"sin_turno","Sin turno asignado este d√≠a","text-green-600"),m=N(a.de_maquina_por_empresa,"de_maquina",`Asignados a ${n}`,"text-blue-600"),y=N(a.todos_por_empresa,"todos","Todos los operarios","text-gray-600"),{value:f}=await Swal.fire({title:"Generar Turnos",html:`
            <div class="text-left space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha inicio:</strong> ${o}<br>
                        <strong>M√°quina:</strong> ${n}<br>
                        <strong>Turno detectado:</strong> ${c}
                    </p>
                </div>

                <!-- Tabs para las secciones -->
                <div class="border-b border-gray-200 mb-3">
                    <nav class="flex space-x-1" aria-label="Tabs">
                        <button type="button" data-tab="sin_turno" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-green-500 text-green-600 bg-green-50">
                            Sin turno hoy
                        </button>
                        <button type="button" data-tab="de_maquina" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            De ${n}
                        </button>
                        <button type="button" data-tab="todos" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            Todos
                        </button>
                    </nav>
                </div>

                <!-- Contenido de tabs -->
                <div id="tab-content-sin_turno" class="tab-content">
                    ${s}
                </div>
                <div id="tab-content-de_maquina" class="tab-content hidden">
                    ${m}
                </div>
                <div id="tab-content-todos" class="tab-content hidden">
                    ${y}
                </div>

                <input type="hidden" id="swal-trabajador" value="" />
                <input type="hidden" id="swal-turno-detectado" value="${i||""}" />

                <!-- Trabajador seleccionado -->
                <div id="trabajador-seleccionado" class="hidden bg-green-50 border border-green-200 rounded-lg p-2 mb-3">
                    <p class="text-sm text-green-800">
                        <strong>Seleccionado:</strong> <span id="nombre-seleccionado"></span>
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Alcance de generaci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-alcance" class="swal2-input w-full">
                        <option value="un_dia">Solo este d√≠a (${o})</option>
                        <option value="dos_semanas">Hasta el viernes de la semana siguiente</option>
                        <option value="resto_a√±o">Desde ${o} hasta fin de a√±o</option>
                    </select>
                </div>

                <div class="mb-4" id="turno-inicio-container" style="display: ${i?"none":"block"};">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Turno inicial (para diurnos) <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-turno-inicio" class="swal2-input w-full">
                        <option value="ma√±ana" ${i==="ma√±ana"?"selected":""}>Ma√±ana</option>
                        <option value="tarde" ${i==="tarde"?"selected":""}>Tarde</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Los turnos alternar√°n cada viernes</p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">
                        <strong>Nota:</strong> Se saltar√°n autom√°ticamente s√°bados, domingos, festivos y d√≠as con vacaciones.
                    </p>
                </div>
            </div>
        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Generar Turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",width:"650px",didOpen:()=>{const u=document.getElementById("swal-trabajador"),v=document.getElementById("turno-inicio-container"),t=document.getElementById("trabajador-seleccionado"),e=document.getElementById("nombre-seleccionado"),d=a.todos||[];function p(g,b){u.value=g,document.querySelectorAll(".select-operario").forEach(h=>{h!==b&&(h.value="")});const x=d.find(h=>h.id===parseInt(g));x&&(e.textContent=`${x.name} ${x.primer_apellido||""} ${x.segundo_apellido||""} (${x.empresa_nombre||"Sin empresa"})`,t.classList.remove("hidden"),x.turno==="diurno"?v.style.display="block":v.style.display="none")}document.querySelectorAll(".select-operario").forEach(g=>{g.addEventListener("change",b=>{b.target.value&&p(b.target.value,b.target)})}),document.querySelectorAll(".tab-btn").forEach(g=>{g.addEventListener("click",b=>{const x=b.target.dataset.tab;document.querySelectorAll(".tab-btn").forEach(h=>{h.classList.remove("border-green-500","text-green-600","bg-green-50"),h.classList.add("border-transparent","text-gray-500")}),b.target.classList.remove("border-transparent","text-gray-500"),b.target.classList.add("border-green-500","text-green-600","bg-green-50"),document.querySelectorAll(".tab-content").forEach(h=>{h.classList.add("hidden")}),document.getElementById(`tab-content-${x}`).classList.remove("hidden")})})},preConfirm:()=>{const u=document.getElementById("swal-trabajador").value,v=document.getElementById("swal-alcance").value,t=document.getElementById("swal-turno-inicio").value,e=document.getElementById("swal-turno-detectado").value;return u?{trabajador_id:u,alcance:v,turno_inicio:t,turno_detectado:e||null}:(Swal.showValidationMessage("Debes seleccionar un trabajador"),!1)}});if(!f)return null;try{const v=await fetch("/profile/generar-turnos-calendario",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"},body:JSON.stringify({user_id:f.trabajador_id,maquina_id:l,fecha_inicio:o,alcance:f.alcance,turno_inicio:f.turno_inicio,turno_detectado:f.turno_detectado})}),t=await v.json();if(console.log("[generarTurnos] Respuesta backend:",t),t.eventos&&t.eventos.length>0&&console.log("[generarTurnos] Primer evento:",t.eventos[0]),!v.ok)throw new Error(t.message||`Error HTTP ${v.status}`);return{...t,eventos:t.eventos||[]}}catch(u){return console.error("Error al generar turnos:",u),await Swal.fire({icon:"error",title:"Error",text:u.message||"No se pudieron generar los turnos",confirmButtonText:"Aceptar"}),null}}async function R({fromISO:o,toISO:l,calendar:n,maquinaId:r=null}){if(await Swal.fire({icon:"question",title:"Copiar registros",html:`¬øCopiar registros de <b>${o}</b> a <b>${l}</b>?<br><small class="text-gray-500">Se guardar√°n en la base de datos</small>`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar"}).then(a=>a.isConfirmed))try{const a=await fetch("/asignaciones-turno/copiar-dia",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":M(),Accept:"application/json"},body:JSON.stringify({fecha_origen:o,fecha_destino:l,maquina_id:r})}),c=await a.json();if(!a.ok)throw new Error(c.message||`Error HTTP ${a.status}`);c.eventos&&c.eventos.length>0&&c.eventos.forEach(s=>{n.addEvent({id:s.id,title:s.title,start:s.start,end:s.end,resourceId:s.resourceId,backgroundColor:s.backgroundColor,borderColor:s.borderColor,textColor:s.textColor||"#000000",extendedProps:s.extendedProps||{}})}),Swal.fire({icon:"success",title:"Copiado completado",html:`Se han copiado <b>${c.copiadas||0}</b> registros a ${l}.`,timer:1800,showConfirmButton:!1})}catch(a){console.error("Error al copiar d√≠a:",a),Swal.fire({icon:"error",title:"Error al copiar",text:a.message||"No se pudieron copiar los registros."})}}async function z({maquinaId:o,maquinaNombre:l,fechaISO:n,duracionSemanas:r,calendar:i}){const a=r===1?"la semana actual":"las pr√≥ximas 2 semanas";if(await Swal.fire({icon:"question",title:"Copiar semana anterior",html:`¬øCopiar los turnos de la semana anterior de <b>${l}</b> para ${a}?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6"}).then(s=>s.isConfirmed))try{const s=new Date(n),m=s.getDay(),y=m===0?-6:1-m,f=new Date(s);f.setDate(s.getDate()+y);const u=f.toISOString().slice(0,10),v=await fetch("/asignaciones-turno/repetir-semana-maquina",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":M(),Accept:"application/json"},body:JSON.stringify({maquina_id:o,semana_inicio:u,duracion_semanas:r})}),t=await v.json();if(!v.ok)throw new Error(t.message||`Error HTTP ${v.status}`);t.eventos&&t.eventos.length>0&&t.eventos.forEach(e=>{i.getEventById(e.id)||i.addEvent({id:e.id,title:e.title,start:e.start,end:e.end,resourceId:e.resourceId,backgroundColor:e.backgroundColor,borderColor:e.borderColor,textColor:e.textColor||"#000000",extendedProps:e.extendedProps||{}})}),await Swal.fire({icon:"success",title:"Turnos copiados",html:`Se han copiado <b>${t.turnos_creados||0}</b> turnos correctamente.`,timer:2e3,showConfirmButton:!1})}catch(s){console.error("Error al copiar turnos:",s),await Swal.fire({icon:"error",title:"Error",text:s.message||"No se pudieron copiar los turnos",confirmButtonText:"Aceptar"})}}function Q(o,l,{fechaISO:n,resourceId:r,horaISO:i},a,c){var t;const s=new Date(n);s.setDate(s.getDate()-1);const m=new Date(n);m.setDate(m.getDate()+1);const y=s.toISOString().slice(0,10),f=m.toISOString().slice(0,10),u=r?((t=c.find(e=>String(e.id)===String(r)))==null?void 0:t.title)||`M√°quina ${r}`:"Seleccione una m√°quina",v=[{icon:"üìÖ",label:"Crear festivo este d√≠a",onClick:async()=>{const e=await Y(n);if(!e)return;const d=new Date(e.fecha+"T00:00:00"),p=new Date(d);p.setDate(p.getDate()+1);const g=(c||[]).map(b=>b.id);a.addEvent({id:"festivo-"+e.id,title:e.titulo,start:d.toISOString(),end:p.toISOString(),allDay:!0,resourceIds:g,backgroundColor:"#ff0000",borderColor:"#b91c1c",textColor:"#ffffff",editable:!0,classNames:["evento-festivo"],extendedProps:{es_festivo:!0,festivo_id:e.id,entrada:null,salida:null}}),Swal.fire({icon:"success",title:"Festivo creado",timer:1200,showConfirmButton:!1})}},{icon:"‚¨ÖÔ∏è",label:`Copiar registros del d√≠a anterior (${y} ‚Üí ${n})`,onClick:()=>R({fromISO:y,toISO:n,calendar:a})},{icon:"‚û°Ô∏è",label:`Copiar registros del d√≠a siguiente (${f} ‚Üí ${n})`,onClick:()=>R({fromISO:f,toISO:n,calendar:a})},{icon:"üìÖ",label:r?`Copiar semana anterior ‚Üí semana actual (${u})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!r,onClick:()=>z({maquinaId:r,maquinaNombre:u,fechaISO:n,duracionSemanas:1,calendar:a})},{icon:"üìÖüìÖ",label:r?`Copiar semana anterior ‚Üí 2 semanas (${u})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!r,onClick:()=>z({maquinaId:r,maquinaNombre:u,fechaISO:n,duracionSemanas:2,calendar:a})},{icon:"üîß",label:r?`Generar turnos para ${u}`:"Generar turnos (seleccione una m√°quina)",disabled:!r,onClick:async()=>{var d,p;if(console.log("[menu] Click en generar turnos, resourceId:",r),!r){console.log("[menu] No hay resourceId, mostrando advertencia"),Swal.fire({icon:"warning",title:"M√°quina no seleccionada",text:"Haz clic derecho sobre una m√°quina espec√≠fica para generar turnos."});return}console.log("[menu] Llamando a generarTurnosDialog...");const e=await U(n,r,u,i);if(console.log("[menu] Resultado del di√°logo:",e),e&&e.eventos){console.log("[menu] Procesando eventos:",e.eventos.length);const g=(p=(d=e.eventos[0])==null?void 0:d.extendedProps)==null?void 0:p.user_id;if(g){const b=a.getEvents(),x=e.eventos.map(h=>{var w;return(w=h.start)==null?void 0:w.slice(0,10)});b.forEach(h=>{var _,k,S,T;const w=(_=h.extendedProps)==null?void 0:_.user_id,C=((k=h.startStr)==null?void 0:k.slice(0,10))||((S=h.start)==null?void 0:S.toISOString().slice(0,10));w===g&&x.includes(C)&&!((T=h.extendedProps)!=null&&T.es_festivo)&&(console.log("[menu] Eliminando evento antiguo:",h.id),h.remove())})}e.eventos.forEach(b=>{console.log("[menu] A√±adiendo evento:",{id:b.id,start:b.start,end:b.end,resourceId:b.resourceId}),a.addEvent({id:b.id,title:b.title,start:b.start,end:b.end,resourceId:b.resourceId,backgroundColor:b.backgroundColor,borderColor:b.borderColor,textColor:b.textColor||"#000000",extendedProps:b.extendedProps||{}})}),console.log("[menu] Eventos actualizados correctamente")}}}];K(o,l,{headerHtml:`<div>Acciones para <b>${n}</b></div>`,items:v})}function Z(o,l,{event:n,titulo:r}){O(o,l,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${r}
    </div>
    <button id="ctx-eliminar-festivo" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      üóëÔ∏è Eliminar festivo
    </button>
  `).querySelector("#ctx-eliminar-festivo").addEventListener("click",async()=>{if(E(),!await Swal.fire({icon:"warning",title:"Eliminar festivo",html:`<div>¬øSeguro que quieres eliminar <b>${r}</b>?</div>`,showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(s=>s.isConfirmed))return;const c=n.extendedProps.festivo_id;await B(j().festivo.delete.replace("__ID__",c),{method:"DELETE"}),n.remove(),Swal.fire({icon:"success",title:"Festivo eliminado",timer:1200,showConfirmButton:!1})})}async function ee(o){const l=o.extendedProps||{},n=l.entrada||"",r=l.salida||"",i=await Swal.fire({title:"Editar fichaje",html:`
      <div class="flex flex-col gap-3">
        <label class="text-left text-sm">Entrada</label>
        <input id="entradaHora" type="time" class="swal2-input" value="${n}">
        <label class="text-left text-sm">Salida</label>
        <input id="salidaHora" type="time" class="swal2-input" value="${r}">
      </div>`,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",preConfirm:()=>{const c=document.getElementById("entradaHora").value,s=document.getElementById("salidaHora").value;return!c&&!s?(Swal.showValidationMessage("Debes indicar al menos una hora"),!1):{entrada:c,salida:s}}});if(!i.isConfirmed)return;const a=o.id.toString().replace(/^turno-/,"");await B(j().asignacion.updateHoras.replace("__ID__",a),{method:"POST",body:i.value}),o.setExtendedProp("entrada",i.value.entrada),o.setExtendedProp("salida",i.value.salida),Swal.fire({icon:"success",title:"Horas actualizadas",timer:1500,showConfirmButton:!1})}function te(o,l,n){var s,m;const r=n.title||"Operario",i=((s=n.extendedProps)==null?void 0:s.categoria_nombre)??"",a=((m=n.extendedProps)==null?void 0:m.especialidad_nombre)??"Sin especialidad",c=O(o,l,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${r} <div style="font-size:12px">${i} ¬∑ ${a}</div>
    </div>
    <button id="ctx-editar-fichajes" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      ‚úèÔ∏è Editar fichajes
    </button>
    <button id="ctx-eliminar-registro" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;color:#b91c1c;">
      üóëÔ∏è Eliminar registro
    </button>
  `);c.querySelector("#ctx-editar-fichajes").addEventListener("click",async()=>{E(),await ee(n)}),c.querySelector("#ctx-eliminar-registro").addEventListener("click",async()=>{var v;if(E(),!await Swal.fire({icon:"warning",title:"Eliminar registro",html:`<div>¬øSeguro que quieres eliminar este evento/asignaci√≥n?</div>
                   <div class="text-xs text-gray-500 mt-1">Esta acci√≥n no se puede deshacer.</div>`,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",showCancelButton:!0,confirmButtonColor:"#b91c1c"}).then(t=>t.isConfirmed))return;const f="/asignaciones-turnos/destroy",u={_method:"DELETE",fecha_inicio:n.startStr,fecha_fin:n.endStr??n.startStr,tipo:"eliminarTurnoEstado",user_id:(v=n.extendedProps)==null?void 0:v.user_id};console.log("[workerMenu] Eliminando turno, payload:",u),console.log("[workerMenu] Event extendedProps:",n.extendedProps);try{await B(f,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(u)}),n.remove(),Swal.fire({icon:"success",title:"Registro eliminado",timer:1300,showConfirmButton:!1})}catch(t){console.error("Error al eliminar el turno:",t),Swal.fire({icon:"error",title:"Error al eliminar",text:t.message||"No se pudo eliminar el turno."})}})}function oe(o,l){const n=[];if(!o||typeof o!="object")return n;const r=(l||[]).filter(a=>a.hora_inicio&&a.hora_fin);if(r.length===0)return n;const i={};r.forEach(a=>{const c=a.nombre.toLowerCase(),[s]=a.hora_inicio.split(":").map(Number),[m]=a.hora_fin.split(":").map(Number),y=m<s;let f,u;y?(f="00:00:00",u="00:30:00"):s<14?(f="08:00:00",u="08:30:00"):(f="16:00:00",u="16:30:00"),i[c]={esNocturno:y,slotInicio:f,slotFin:u,color:a.color}});for(const[a,c]of Object.entries(o))if(!(!c||typeof c!="object")){for(const[s,m]of Object.entries(c))if(m)for(const[y,f]of Object.entries(i)){const u=m[y]||0;u<=0||n.push({id:`carga-${a}-${s}-${y}`,title:`${u}h`,start:`${s}T${f.slotInicio}`,end:`${s}T${f.slotFin}`,resourceId:a,backgroundColor:X(u),borderColor:X(u),textColor:"#000",editable:!1,classNames:["evento-carga"],extendedProps:{es_carga:!0,turno:y,horas:u}})}}return n}function X(o){return o>6?"#fca5a5":o>3?"#fcd34d":"#86efac"}function ne(o){const l={slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[]};if(!o||o.length===0)return l;const n=o.filter(i=>i.hora_inicio&&i.hora_fin);return n.length===0?l:{slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[...n].sort((i,a)=>{const[c]=i.hora_inicio.split(":").map(Number),[s]=i.hora_fin.split(":").map(Number),[m]=a.hora_inicio.split(":").map(Number),[y]=a.hora_fin.split(":").map(Number),f=s<c,u=y<m;return f&&!u?-1:!f&&u?1:c-m})}}function ae(o,l,n){const r=localStorage.getItem(o);return l.includes(r)?r:n}function re(o){const{maquinas:l,eventos:n,cargaTrabajo:r,turnos:i}=W(),a=ne(i),c=oe(r,i),s=[...n,...c],m="vistaObras",y="fechaObras";let f=!1;const u=new FullCalendar.Calendar(o,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",locale:"es",initialView:ae(m,["resourceTimelineDay","resourceTimelineWeek"],"resourceTimelineWeek"),initialDate:localStorage.getItem(y)||void 0,selectable:!0,unselectAuto:!0,datesSet(t){localStorage.setItem("vistaObras",t.view.type),localStorage.setItem("fechaObras",t.startStr);const e=t.view.type==="resourceTimelineDay";if(o.classList.toggle("vista-dia",e),o.classList.toggle("vista-semana",!e),e){const p=o.querySelector(".fc-toolbar-title");if(p){const g=t.start,b={weekday:"long",day:"numeric",month:"long",year:"numeric"};p.textContent=g.toLocaleDateString("es-ES",b)}}const d=document.getElementById("btnRepetirSemana");d&&(t.view.type==="resourceTimelineWeek"?(d.classList.remove("hidden"),d.dataset.fecha=t.startStr):d.classList.add("hidden"))},displayEventEnd:!0,eventMinHeight:30,firstDay:1,height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"resourceTimelineDay,resourceTimelineWeek"},buttonText:{today:"Hoy",week:"Semana",day:"D√≠a"},slotLabelDidMount(t){if(t.view.type==="resourceTimelineDay"&&a.turnos){const d=t.date.getHours();let p=0;d>=8&&d<16?p=1:d>=16&&(p=2);const g=a.turnos[p];g&&(t.el.style.backgroundColor=g.color||"#e5e7eb")}},slotLabelContent(t){if(t.view.type==="resourceTimelineDay"){const d=t.date.getHours();if(d===0)return{html:"<b>Noche</b>"};if(d===8)return{html:"<b>Ma√±ana</b>"};if(d===16)return{html:"<b>Tarde</b>"}}return null},views:{resourceTimelineDay:{slotMinTime:a.slotMinTime,slotMaxTime:a.slotMaxTime,slotDuration:a.slotDuration,titleFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"}},resourceTimelineWeek:{slotDuration:{days:1},slotLabelFormat:{weekday:"long"}}},editable:!0,resources:l,resourceOrder:"orden",resourceAreaWidth:"100px",resourceLabelDidMount(t){const e=t.resource.extendedProps.backgroundColor;e&&(t.el.style.backgroundColor=e,t.el.style.color="#fff")},filterResourcesWithEvents:!1,events:s,resourceAreaColumns:[{field:"title",headerContent:"M√°quinas"}],eventDragStart:t=>{f=!0;const e=t.el;e._tippy&&(e._tippy.hide(),e._tippy.disable()),document.querySelectorAll(".fc-event").forEach(d=>{d._tippy&&d._tippy.disable()})},eventDragStop:t=>{f=!1,setTimeout(()=>{document.querySelectorAll(".fc-event").forEach(p=>{p._tippy&&p._tippy.enable()});const e=t.el,d=t.event.extendedProps||{};if(!e._tippy&&d.foto&&!d.es_festivo){const p=`<img src="${d.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`;tippy(e,{content:p,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(f)return!1}})}},100)},eventDrop:async t=>{var p,g;const e=t.event,d=e.extendedProps||{};try{if(d.es_festivo){const $=e.startStr.slice(0,10);await fetch(j().festivo.update.replace("__ID__",d.festivo_id),{method:"PUT",headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({fecha:$})}).then(D=>{if(!D.ok)throw new Error(`HTTP ${D.status}`)});return}const b=e.id.replace(/^turno-/,""),x=(p=e.getResources())==null?void 0:p[0],h=x?parseInt(x.id,10):null,w=(g=e.start)==null?void 0:g.toISOString(),C=new Date(w).getHours();let _=null;for(const $ of a.turnos){const[D]=$.hora_inicio.split(":").map(Number),[A]=$.hora_fin.split(":").map(Number),V=A<D;let I=!1;if(V?I=C>=D||C<A:I=C>=D&&C<A,I){_=$.id;break}}if(_||(_=C>=6&&C<14?1:C>=14&&C<22?2:3),!h||!w)throw new Error("Datos incompletos");const k=j().asignacion.updatePuesto.replace("__ID__",b),S=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf},body:JSON.stringify({maquina_id:h,start:w,turno_id:_})}),T=await S.json();if(!S.ok)throw new Error((T==null?void 0:T.message)||`HTTP ${S.status}`);T.color&&(e.setProp("backgroundColor",T.color),e.setProp("borderColor",T.color)),typeof T.nuevo_obra_id<"u"&&e.setExtendedProp("obra_id",T.nuevo_obra_id),e.setExtendedProp("turno_id",_);const F=a.turnos.find($=>$.id===_);F&&e.setExtendedProp("turno_nombre",F.nombre),u.refetchEvents()}catch(b){console.error(b),Swal.fire("Error",b.message||"Ocurri√≥ un error inesperado.","error"),t.revert()}},eventDidMount(t){const e=t.event,d=e.extendedProps||{};if(d.es_carga){t.el.title=`${d.horas}h de trabajo - Turno ${d.turno}`;return}if(t.el._tippy&&t.el._tippy.destroy(),d.foto&&!d.es_festivo){const p=`<img src="${d.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`,g=tippy(t.el,{content:p,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(f)return!1}});f&&g&&g.disable()}t.el.addEventListener("contextmenu",p=>{p.preventDefault(),p.stopPropagation(),d.es_festivo?Z(p.clientX,p.clientY,{event:e,titulo:e.title}):te(p.clientX,p.clientY,e)})},eventClick(t){const d=t.event.extendedProps||{};if(d.es_festivo)return;const p=d.user_id;if(p){const g=j().userShow.replace(":id",p);window.location.href=g}},eventContent(t){const e=t.event.extendedProps;if(e!=null&&e.es_carga)return{html:`<div class="carga-content">${e.horas}h</div>`};if(e!=null&&e.es_festivo)return{html:`<div class="px-2 py-1 text-xs font-semibold" style="color:#fff">${t.event.title}</div>`};const d=e.entrada&&e.salida?`${e.entrada} / ${e.salida}`:e.entrada||e.salida||"-- / --",p=e.turno_nombre?e.turno_nombre.charAt(0).toUpperCase()+e.turno_nombre.slice(1):"";return{html:`
          <div class="px-2 py-1 text-xs font-semibold flex items-center">
            <div class="flex flex-col">
              <span>${t.event.title} <span class="text-[10px] font-medium opacity-70">[${p}]</span></span>
              <span class="text-[10px] font-normal opacity-80">(${e.categoria_nombre??""} üõ† ${e.especialidad_nombre??"Sin especialidad"})</span>
            </div>
            <div class="ml-auto text-right">
              <span class="text-[10px] font-normal opacity-80">${d}</span>
            </div>
          </div>`}}});u.render(),console.log("[cal] Configurando event listener para contextmenu...");const v=u.el;return console.log("[cal] Elemento ra√≠z del calendario:",v),console.log("[cal] Agregando event listener de contextmenu al calendario"),v.addEventListener("contextmenu",t=>{if(console.log("[cal] ¬°Contextmenu disparado!",t.target),t.target.closest(".fc-event")){console.log("[cal] Es un evento, ignorando");return}t.preventDefault();let e=null,d=null,p=null;const g=t.target.closest("[data-date]");if(g){const x=g.getAttribute("data-date")||"";x.includes("T")?(d=x.slice(0,10),p=x.slice(11,16)):d=x.slice(0,10)}if(!p&&u.view.type==="resourceTimelineDay"){const x=u;if(x.getDate(),typeof x.el.getBoundingClientRect=="function"){x.el.getBoundingClientRect();const h=x.el.querySelector(".fc-timeline-body");if(h){const w=h.getBoundingClientRect(),C=t.clientX-w.left,_=w.width,k=C/_*24,S=Math.floor(k);p=String(S).padStart(2,"0")+":00",console.log("[cal] Hora calculada por posici√≥n X:",p)}}}if(!d){console.log("[cal] No se pudo determinar la fecha");return}console.log("[cal] Fecha encontrada:",d,"Hora:",p),console.log("[cal] Elemento clickeado:",t.target),console.log("[cal] Elemento con data-date:",g);const b=v.querySelectorAll(".fc-timeline-lane[data-resource-id]");if(console.log("[cal] Filas de recursos encontradas:",b.length),b.length>0){const x=t.clientY;console.log("[cal] Posici√≥n Y del click:",x);for(const h of b){const w=h.getBoundingClientRect();if(console.log("[cal] Examinando lane con resource-id:",h.dataset.resourceId,"top:",w.top,"bottom:",w.bottom),x>=w.top&&x<=w.bottom){e=h.dataset.resourceId,console.log("[cal] ¬°ResourceId encontrado por posici√≥n Y!:",e);break}}}console.log("[cal] ResourceId final detectado:",e,"Fecha:",d,"Hora:",p),Q(t.clientX,t.clientY,{fechaISO:d,resourceId:e,horaISO:p},u,l)}),console.log("[cal] Event listener de contextmenu agregado correctamente"),u}function q(){const o=document.getElementById("calendario");if(!o||o.getAttribute("data-calendar-type")!=="trabajadores"||!window.AppPlanif)return;if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}const l=re(o);window.calendarTrabajadores=l}function se(){if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",q):q();document.addEventListener("livewire:navigated",q);document.addEventListener("livewire:navigating",se);
