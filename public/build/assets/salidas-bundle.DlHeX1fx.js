function c(){window.actualizarEstado=function(t){Swal.fire({title:"¬øEst√°s seguro?",text:"¬øQuieres marcar esta salida como completada?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"S√≠, marcar como completada",cancelButtonText:"Cancelar"}).then(a=>{a.isConfirmed&&fetch(`/salidas/${t}/actualizar-estado`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({estado:"completada"})}).then(e=>e.json()).then(e=>{e.success?(Swal.fire("Completada","La salida ha sido marcada como completada.","success"),location.reload()):Swal.fire("Completada",e.message,"success")}).catch(e=>{Swal.fire("Error","Hubo un error al realizar la solicitud.","error")})})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c();document.addEventListener("livewire:navigated",c);function f(){const t=document.getElementById("btn-generar-formularios");t&&t.addEventListener("click",g);const a=document.getElementById("btn-crear-todas-salidas");a&&a.addEventListener("click",S);const e=document.getElementById("btn-guardar-asignaciones");e&&e.addEventListener("click",b),document.querySelector(".paquete-item")&&(m(),p())}function g(){const t=parseInt(document.getElementById("num-salidas").value);if(t<1||t>10){Swal.fire("‚ö†Ô∏è","El n√∫mero de salidas debe estar entre 1 y 10","warning");return}const a=document.getElementById("formularios-salidas");a.innerHTML="";const e=window.AppGestionSalidas.empresas,o=window.AppGestionSalidas.camiones;for(let r=1;r<=t;r++){const s=w(r,e,o);a.appendChild(s)}document.getElementById("btn-crear-container").classList.remove("hidden")}function w(t,a,e){const o=document.createElement("div");o.className="bg-gray-50 border border-gray-300 rounded-lg p-4",o.dataset.salidaIndex=t;const r=new Date().toISOString().split("T")[0];o.innerHTML=`
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Salida #${t}</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Salida</label>
                <input type="date"
                       class="salida-fecha w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
                       value="${r}"
                       required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa de Transporte (opcional)</label>
                <select class="salida-empresa w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Sin asignar (se asignar√° despu√©s)</option>
                    ${a.map(i=>`
                        <option value="${i.id}">${i.nombre}</option>
                    `).join("")}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cami√≥n (opcional)</label>
                <select class="salida-camion w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Sin asignar (se asignar√° despu√©s)</option>
                    ${e.map(i=>`
                        <option value="${i.id}" data-empresa="${i.empresa_id}">
                            ${i.modelo} - ${i.matricula||"Sin matr√≠cula"}
                        </option>
                    `).join("")}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo SAGE (opcional)</label>
                <input type="text"
                       class="salida-codigo-sage w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
                       placeholder="C√≥digo SAGE">
            </div>
        </div>
    `;const s=o.querySelector(".salida-empresa"),n=o.querySelector(".salida-camion");return s.addEventListener("change",function(){const i=this.value;n.querySelectorAll("option").forEach(l=>{if(l.value===""){l.style.display="block";return}l.dataset.empresa===i?l.style.display="block":(l.style.display="none",l.selected&&(n.value=""))})}),o}async function S(){const t=document.querySelectorAll("[data-salida-index]"),a=[];for(const e of t){const o=e.querySelector(".salida-fecha").value,r=e.querySelector(".salida-empresa").value,s=e.querySelector(".salida-camion").value,n=e.querySelector(".salida-codigo-sage").value;if(!o){Swal.fire("‚ö†Ô∏è","Por favor, completa la fecha de salida en todas las salidas","warning");return}a.push({fecha_salida:o,empresa_transporte_id:r||null,camion_id:s?parseInt(s):null,codigo_sage:n||null})}try{Swal.fire({title:"Creando salidas...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const o=await(await fetch(window.AppGestionSalidas.routes.crearSalidasVacias,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf},body:JSON.stringify({salidas:a,planillas_ids:window.AppGestionSalidas.planillasIds})})).json();o.success?(await Swal.fire({icon:"success",title:"‚úÖ Salidas Creadas",text:`Se han creado ${o.salidas_creadas} salidas correctamente`,timer:2e3}),window.location.href=window.AppGestionSalidas.routes.recargarVista):Swal.fire("‚ùå",o.message||"Error al crear las salidas","error")}catch(e){console.error("Error:",e),Swal.fire("‚ùå","Error al crear las salidas","error")}}function m(){let t=null;document.querySelectorAll(".paquete-item").forEach(a=>{a.addEventListener("dragstart",e=>{t=a,a.style.opacity="0.5",e.dataTransfer.effectAllowed="move"}),a.addEventListener("dragend",e=>{a.style.opacity="1",t=null})}),document.querySelectorAll(".drop-zone").forEach(a=>{a.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",a.style.backgroundColor="#e0f2fe"}),a.addEventListener("dragleave",e=>{a.style.backgroundColor=""}),a.addEventListener("drop",e=>{if(e.preventDefault(),a.style.backgroundColor="",t){const o=a.querySelector(".text-gray-400");o&&o.remove(),a.appendChild(t),p()}})})}function p(){document.querySelectorAll(".drop-zone").forEach(t=>{if(t.dataset.salidaId==="null")return;const a=t.querySelectorAll(".paquete-item");let e=0;a.forEach(r=>{const s=parseFloat(r.dataset.peso)||0;e+=s});const o=document.querySelector(`.peso-total-salida[data-salida-id="${t.dataset.salidaId}"]`);o&&(o.textContent=`${e.toFixed(2)} kg`)})}async function b(){const t=[];document.querySelectorAll(".drop-zone").forEach(a=>{const e=a.dataset.salidaId;a.querySelectorAll(".paquete-item").forEach(r=>{const s=parseInt(r.dataset.paqueteId);t.push({paquete_id:s,salida_id:e==="null"?null:parseInt(e)})})});try{Swal.fire({title:"Guardando asignaciones...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const e=await(await fetch(window.AppGestionSalidas.routes.guardarAsignacionesPaquetes,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf},body:JSON.stringify({asignaciones:t})})).json();e.success?await Swal.fire({icon:"success",title:"‚úÖ Asignaciones Guardadas",text:"Los paquetes han sido asignados correctamente a las salidas",timer:2e3}):Swal.fire("‚ö†Ô∏è",e.message||"No se pudieron guardar las asignaciones","warning")}catch(a){console.error("Error:",a),Swal.fire("‚ùå","Error al guardar las asignaciones","error")}}function y(t){const a=document.getElementById("modal-dibujo"),e=document.getElementById("canvas-dibujo");if(!a||!e){console.error("Modal o canvas no encontrado");return}const o=window.paquetes.find(s=>s.id==t);if(!o){console.warn("No se encontr√≥ el paquete");return}const r=[];if(o.etiquetas&&o.etiquetas.length>0&&o.etiquetas.forEach(s=>{s.elementos&&s.elementos.length>0&&s.elementos.forEach(n=>{r.push({id:n.id,dimensiones:n.dimensiones})})}),r.length===0){Swal.fire("‚ö†Ô∏è","Este paquete no tiene elementos para dibujar.","warning");return}e.innerHTML="",r.forEach(s=>{const n=document.createElement("div");n.id=`elemento-${s.id}`,n.style.width="100%",n.style.height="200px",n.style.border="1px solid #e5e7eb",n.style.borderRadius="4px",n.style.background="white",n.style.position="relative",n.style.marginBottom="10px",e.appendChild(n)}),a.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{r.forEach(s=>{typeof window.dibujarFiguraElemento=="function"?window.dibujarFiguraElemento(`elemento-${s.id}`,s.dimensiones,null):console.error("‚ùå dibujarFiguraElemento no est√° disponible")})})})}window.mostrarDibujo=y;function h(){const t=document.getElementById("cerrar-modal"),a=document.getElementById("modal-dibujo");t&&a&&(t.addEventListener("click",function(){a.classList.add("hidden")}),a.addEventListener("click",function(e){e.target===a&&a.classList.add("hidden")}))}function u(){f(),h()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("livewire:navigated",u);async function v(t){if((await Swal.fire({title:"¬øEliminar salida?",text:"Los paquetes asignados volver√°n a estar disponibles. Esta acci√≥n no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"S√≠, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{Swal.fire({title:"Eliminando salida...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const e=await fetch(`/salidas-ferralla/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf}}),o=await e.text();let r;try{r=JSON.parse(o)}catch(s){console.error("Error al parsear JSON:",s),console.error("Respuesta del servidor:",o),Swal.fire("Error","Error al procesar la respuesta del servidor. Revisa la consola para m√°s detalles.","error");return}if(e.ok&&r.success){const s=document.querySelector(`.drop-zone[data-salida-id="${t}"]`),n=s?s.querySelectorAll(".paquete-item"):[],i=document.querySelector('.drop-zone[data-salida-id="null"]');i&&n.length>0&&n.forEach(l=>{i.appendChild(l)});const d=s?s.closest(".bg-blue-50"):null;d&&d.remove(),Swal.fire({icon:"success",title:"Salida eliminada",text:"La salida ha sido eliminada correctamente",timer:2e3,showConfirmButton:!1})}else Swal.fire("Error",r.message||"No se pudo eliminar la salida","error")}catch(e){console.error("Error completo:",e),Swal.fire("Error","Error al eliminar la salida: "+e.message,"error")}}function E(){const t=window.AppGestionSalidas.mostrarTodosPaquetes;window.AppGestionSalidas.mostrarTodosPaquetes=!t;const a=window.AppGestionSalidas.mostrarTodosPaquetes?window.paquetesTodos:window.paquetesFiltrados;x(a),q(),T(),m()}function x(t){const a=document.querySelector('.paquetes-zona[data-salida-id="null"]');if(!a){console.error("No se encontr√≥ el contenedor de paquetes disponibles");return}a.innerHTML="",t.forEach(e=>{const o=document.createElement("div");o.className="paquete-item bg-white border border-gray-300 rounded p-2 mb-2 cursor-move hover:shadow-md transition-shadow",o.draggable=!0,o.dataset.paqueteId=e.id,o.dataset.peso=e.peso,o.innerHTML=`
            <div class="flex items-center justify-between text-xs">
                <span class="font-medium">üì¶ ${e.codigo}</span>
                <button onclick="mostrarDibujo(${e.id}); event.stopPropagation();"
                    class="text-blue-500 hover:underline text-xs">
                    üëÅÔ∏è Ver
                </button>
            </div>
            <div class="flex items-center justify-between text-xs mt-1">
                <span class="text-gray-500">${e.planilla_codigo||"N/A"}</span>
                <span class="text-gray-600">${parseFloat(e.peso).toFixed(2)} kg</span>
            </div>
            <div class="text-xs text-gray-500 mt-1 border-t border-gray-200 pt-1">
                <div class="truncate" title="${e.obra}">üèóÔ∏è ${e.obra}</div>
                <div class="truncate" title="${e.cliente}">üë§ ${e.cliente}</div>
            </div>
        `,a.appendChild(o)}),console.log(`‚úÖ Renderizados ${t.length} paquetes`)}function q(){const t=document.getElementById("btn-toggle-paquetes");if(!t)return;window.AppGestionSalidas.mostrarTodosPaquetes?(t.className="text-xs px-3 py-1 rounded-md transition-colors bg-orange-500 hover:bg-orange-600 text-white",t.innerHTML="üìç Ver solo obra/cliente"):(t.className="text-xs px-3 py-1 rounded-md transition-colors bg-blue-500 hover:bg-blue-600 text-white",t.innerHTML="üåê Ver todos pendientes")}function T(){const t=document.querySelector('.paquetes-zona[data-salida-id="null"]').closest(".bg-gray-50").querySelector("p.text-xs");if(!t)return;window.AppGestionSalidas.mostrarTodosPaquetes?t.innerHTML="Mostrando <strong>TODOS</strong> los paquetes pendientes sin filtro":t.innerHTML="Mostrando solo paquetes de <strong>esta obra/cliente</strong>"}window.eliminarSalida=v;window.toggleFiltroPaquetes=E;
