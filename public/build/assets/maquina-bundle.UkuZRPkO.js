const Xt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Ut="rgba(0, 0, 0, 1)";function Ht(q,d){return!d||d===1?q.map(l=>({...l})):q.map(l=>l.type==="line"?{...l,length:(l.length||0)*d}:l.type==="arc"?{...l,radius:(l.radius||0)*d}:{...l})}const Yt=.75,Tt=14,Wt=60,Ft=[0,10,-10,20,-20,30,-30];function U(q){return q*Math.PI/180}function Jt(q){const d=q.closest(".proceso");return d&&getComputedStyle(d).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Qt(q,d,l){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");return r.setAttribute("viewBox","0 0 "+q+" "+d),r.setAttribute("preserveAspectRatio","xMidYMid meet"),r.style.width="100%",r.style.height="100%",r.style.display="block",r.style.background=l||"#ffffff",r.style.shapeRendering="geometricPrecision",r.style.textRendering="optimizeLegibility",r.style.boxSizing="border-box",r}function Kt(q,d,l,r){const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",d),i.setAttribute("stroke",l),i.setAttribute("fill","none"),i.setAttribute("stroke-width",r),i.setAttribute("vector-effect","non-scaling-stroke"),q.appendChild(i),i}function zt(q){let d="",l=Number(q)||0;for(;l>=0;){const r=l%26;d=String.fromCharCode(65+r)+d,l=Math.floor(l/26)-1}return d}const Zt=0,te=-25;function ee(q,d,l,r){if(!d||!d.length)return;const i=2,h=12,g=h+i,x=d.map(s=>(s.letter?s.letter+" ":"")+(s.text||"")),p=h*x.length+i*(x.length-1),b=Zt;let o=r-te-p+h/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let s=0;s<x.length;s++){const n=x[s],u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",b),u.setAttribute("y",o),u.setAttribute("fill",Ut),u.setAttribute("font-size",h),u.setAttribute("text-anchor","start"),u.setAttribute("alignment-baseline","middle"),u.style.pointerEvents="none",u.textContent=n,q.appendChild(u);const m=Lt(n,h).w;window.__legendBoxesGroup.push({left:b,right:b+m,top:o-h/2,bottom:o+h/2}),o+=g}}function oe(q){const d=(q||"").split(/\s+/).filter(Boolean),l=[];for(let r=0;r<d.length;r++){const i=d[r];if(i.endsWith("r")){const h=parseFloat(i.slice(0,-1));let g=360;r+1<d.length&&d[r+1].endsWith("d")&&(g=parseFloat(d[++r].slice(0,-1))),l.push({type:"arc",radius:h,arcAngle:g})}else i.endsWith("d")?l.push({type:"turn",angle:parseFloat(i.slice(0,-1))}):l.push({type:"line",length:parseFloat(i)})}return l}function ae(q){let d=[],l=0,r=0,i=0;d.push({x:l,y:r});for(let h=0;h<q.length;h++){const g=q[h];if(g.type==="line")l+=g.length*Math.cos(U(i)),r+=g.length*Math.sin(U(i)),d.push({x:l,y:r});else if(g.type==="turn")i+=g.angle;else if(g.type==="arc"){const x=l+g.radius*Math.cos(U(i+90)),p=r+g.radius*Math.sin(U(i+90)),b=Math.atan2(r-p,l-x),o=b+U(g.arcAngle);l=x+g.radius*Math.cos(o),r=p+g.radius*Math.sin(o),i+=g.arcAngle,d.push({x:l,y:r})}}return d}function Rt(q){let d=[],l=0,r=0,i=0;for(let h=0;h<q.length;h++){const g=q[h];if(g.type==="line"){const x={x:l,y:r},p={x:l+g.length*Math.cos(U(i)),y:r+g.length*Math.sin(U(i))};d.push({start:x,end:p,length:g.length}),l=p.x,r=p.y}else if(g.type==="turn")i+=g.angle;else if(g.type==="arc"){const x=l+g.radius*Math.cos(U(i+90)),p=r+g.radius*Math.sin(U(i+90)),b=Math.atan2(r-p,l-x),o=b+U(g.arcAngle);l=x+g.radius*Math.cos(o),r=p+g.radius*Math.sin(o),i+=g.arcAngle}}return d}function Lt(q,d){const l=d||12;return{w:(q?q.length:0)*l*.55,h:l}}function st(q,d,l){const r=l||0;return!(q.right+r<d.left||q.left-r>d.right||q.bottom+r<d.top||q.top-r>d.bottom)}function Nt(q,d,l,r){const i=d/2;return Math.max(l+i,Math.min(r-i,q))}function ne(q,d){const r=[];let i=0;function h(){i>1e-9&&(r.push({type:"line",length:i}),i=0)}for(let g=0;g<q.length;g++){const x=q[g];if(x.type==="line"){i+=x.length;continue}if(x.type==="turn"){if(Math.abs(x.angle)<1e-9)continue;h(),r.push(x);continue}if(x.type==="arc"){h(),r.push(x);continue}h(),r.push(x)}return h(),r}function Vt(q,d){const l=d&&d.decimals||0,r=d&&d.step||null;let i=Number(q||0);return r&&r>0&&(i=Math.round(i/r)*r),i.toFixed(l).replace(/\.0+$/,"")}function se(q,d){const l=Math.hypot(q,d)||1;let r=q/l,i=d/l;return(i<-1e-9||Math.abs(i)<=1e-9&&r<0)&&(r=-r,i=-i),{ux:r,uy:i}}function jt(q,d,l){const r=l||.01,i=se(q,d),h=Math.round(i.ux/r)*r,g=Math.round(i.uy/r)*r;return h+"|"+g}function ie(q,d,l){const r=l&&l.dirPrecision||.01,i=l&&l.labelFormat||{decimals:0,step:null},h=q.reduce((u,m)=>u+Math.hypot(m.end.x-m.start.x,m.end.y-m.start.y),0),g=d.reduce((u,m)=>u+(m.length||Math.hypot(m.end.x-m.start.x,m.end.y-m.start.y)),0),x=g>0?h/g:1,p=new Map;for(let u=0;u<d.length;u++){const m=d[u],c=m.end.x-m.start.x,e=m.end.y-m.start.y,a=jt(c,e,r),t=p.get(a)||[];t.push({length:m.length||Math.hypot(c,e),index:u}),p.set(a,t)}const b=d.map(u=>u.length||Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y)),o=new Set,s=new Set,n=[];for(let u=0;u<q.length;u++){const m=q[u],c=m.end.x-m.start.x,e=m.end.y-m.start.y,a=jt(c,e,r),t=p.get(a)||[],y=Math.hypot(c,e);let E=y;if(t.length){const _=y/x;let w=null,S=1/0;for(const v of t){const T=Math.abs(v.length-_),B=s.has(v.index)?.1:0;T+B<S&&(w=v,S=T+B)}w&&(E=w.length,s.add(w.index))}else u<b.length&&(E=b[u]);const f=Vt(E,i),M=a+"|"+f;o.has(M)||(o.add(M),n.push({start:m.start,end:m.end,_dirKey:a,_label:f,_lenChosen:E}))}return n}function re(q,d){const l=d,r=q.map(e=>Object.assign({},e));let i=0,h=0,g=0;const x=[];let p=null,b=-1,o=-1;const s=1e-7;function n(e){return e*Math.PI/180}function u(e){return Math.abs(Math.sin(n(e)))<1e-12}function m(e,a,t,y){return Math.min(a,y)-Math.max(e,t)>s}for(let e=0;e<r.length;e++){let t=function(){const _={x:Math.cos(n(g)),y:Math.sin(n(g))},w=i+r[e].length*_.x,S=h+r[e].length*_.y,v=u(g);for(let T=0;T<x.length;T++){const B=x[T];if(v&&B.horiz&&Math.abs(h-B.y)<s){if(m(Math.min(i,w),Math.max(i,w),Math.min(B.x1,B.x2),Math.max(B.x1,B.x2))&&p&&b>=0&&o>=0)return r[o].length+=l,i+=p.x*l,h+=p.y*l,x[b].x2+=p.x*l,x[b].y2+=p.y*l,!0}else if(!v&&!B.horiz&&Math.abs(i-B.x)<s&&m(Math.min(h,S),Math.max(h,S),Math.min(B.y1,B.y2),Math.max(B.y1,B.y2))&&p&&b>=0&&o>=0)return r[o].length+=l,i+=p.x*l,h+=p.y*l,x[b].x2+=p.x*l,x[b].y2+=p.y*l,!0}return!1};var c=t;const a=r[e];if(a.type==="turn"){g+=a.angle;continue}if(a.type==="arc"){const _=i+a.radius*Math.cos(n(g+90)),w=h+a.radius*Math.sin(n(g+90)),S=Math.atan2(h-w,i-_),v=S+n(a.arcAngle);i=_+a.radius*Math.cos(v),h=w+a.radius*Math.sin(v),g+=a.arcAngle,p=null;continue}for(;t(););const y={x:Math.cos(n(g)),y:Math.sin(n(g))},E=i+r[e].length*y.x,f=h+r[e].length*y.y,M=u(g);x.push({x1:i,y1:h,x2:E,y2:f,horiz:M,y:h,x:i}),p=y,b=x.length-1,o=e,i=E,h=f}return r}function _t(q,d,l,r){const i=U(r),h=Math.cos(i),g=Math.sin(i),x=q.x-d,p=q.y-l;return{x:d+x*h-p*g,y:l+x*g+p*h}}function ce(q,d,l,r,i,h,g,x,p){let b="",o=0,s=0,n=0,u=!1;function m(e,a){const t=_t({x:e,y:a},d,l,r);return{x:x+(t.x-h)*i,y:p+(t.y-g)*i}}function c(){if(!u){const e=m(o,s);b+="M "+e.x+" "+e.y,u=!0}}for(let e=0;e<q.length;e++){const a=q[e];if(a.type==="turn"){n+=a.angle;continue}if(a.type==="line"){const t=o+a.length*Math.cos(U(n)),y=s+a.length*Math.sin(U(n));c();const E=m(t,y);b+=" L "+E.x+" "+E.y,o=t,s=y;continue}if(a.type==="arc"){const t=o+a.radius*Math.cos(U(n+90)),y=s+a.radius*Math.sin(U(n+90)),E=Math.atan2(s-y,o-t),f=E+U(a.arcAngle),M=t+a.radius*Math.cos(f),_=y+a.radius*Math.sin(f),w=Math.abs(a.arcAngle)%360;if(c(),w<1e-6||Math.abs(a.arcAngle)>=359.9){const z=E+Math.sign(a.arcAngle)*Math.PI,V=t+a.radius*Math.cos(z),A=y+a.radius*Math.sin(z),C=m(V,A),$=m(o,s),L=a.radius*i,P=a.arcAngle>=0?1:0;b+=" A "+L+" "+L+" 0 1 "+P+" "+C.x+" "+C.y,b+=" A "+L+" "+L+" 0 1 "+P+" "+$.x+" "+$.y,n+=a.arcAngle;continue}const S=m(M,_),v=a.radius*i,T=w>180?1:0,B=a.arcAngle>=0?1:0;b+=" A "+v+" "+v+" 0 "+T+" "+B+" "+S.x+" "+S.y,o=M,s=_,n+=a.arcAngle}}return b||"M 0 0"}function le(q){const d=ae(q);let l=Math.min(...d.map(c=>c.x)),r=Math.max(...d.map(c=>c.x)),i=Math.min(...d.map(c=>c.y)),h=Math.max(...d.map(c=>c.y));const g=(l+r)/2,x=(i+h)/2,b=h-i>r-l?-90:0,o=d.map(c=>_t(c,g,x,b));l=Math.min(...o.map(c=>c.x)),r=Math.max(...o.map(c=>c.x)),i=Math.min(...o.map(c=>c.y)),h=Math.max(...o.map(c=>c.y));const s=Math.max(1,r-l),n=Math.max(1,h-i),u=(l+r)/2,m=(i+h)/2;return{rotDeg:b,w:s,h:n,cxModel:g,cyModel:x,midX:u,midY:m,ptsRot:o}}function de(q){const d=[];let l=0,r=0,i=0;function h(g){const x=U(g);return{x:Math.cos(x),y:Math.sin(x)}}for(let g=0;g<q.length;g++){const x=q[g];if(x.type==="line")l+=x.length*Math.cos(U(i)),r+=x.length*Math.sin(U(i));else if(x.type==="turn"){const p=h(i),b=x.angle;i+=b;const o=h(i);d.push({x:l,y:r,angleDeg:b,prevDir:p,nextDir:o})}else if(x.type==="arc"){const p=l+x.radius*Math.cos(U(i+90)),b=r+x.radius*Math.sin(U(i+90)),o=Math.atan2(r-b,l-p),s=o+U(x.arcAngle);l=p+x.radius*Math.cos(s),r=b+x.radius*Math.sin(s),i+=x.arcAngle}}return d}function ue(q,d,l){const r=Array.from({length:d},()=>({sumH:0,maxW:0,items:[]})),i=[...q.keys()].sort((h,g)=>q[g].h-q[h].h);for(const h of i){let g=0,x=1/0;for(let b=0;b<d;b++){const o=r[b],s=o.sumH+(o.items.length>0?l:0)+q[h].h;s<x&&(x=s,g=b)}const p=r[g];p.sumH=p.items.length>0?p.sumH+l+q[h].h:p.sumH+q[h].h,p.maxW=Math.max(p.maxW,q[h].w),p.items.push(h)}return r}function pe(q,d,l,r={}){const i=r.padding??12,h=r.gapCol??12,g=r.gapRow??10,x=Math.max(1,Math.min(q.length,r.kMax??4)),p=Math.max(10,d-2*i),b=Math.max(10,l-2*i),o=s(q);function s(t){const y=t.map(L=>L.w/Math.max(L.h,1)),E=t.map(L=>L.h),f=t.map(L=>L.w),M=t.map(L=>L.w*L.h),_=L=>L.reduce((P,G)=>P+G,0)/L.length,w=(L,P)=>L.reduce((G,D)=>G+Math.pow(D-P,2),0)/L.length,S=(L,P)=>Math.sqrt(w(L,P)),v=_(y),T=_(E),B=_(f),z=M.reduce((L,P)=>L+P,0),V=S(E,T),A=S(f,B),C=T>0?V/T:0,$=B>0?A/B:0;return{avgAspectRatio:v,avgHeight:T,avgWidth:B,totalArea:z,heightCV:C,widthCV:$,isLinear:v>6||T<B*.12,isUniformHeight:C<.15,isUniformWidth:$<.15,isHighlyVariable:C>.5||$>.5,count:t.length}}let n={S:0,k:1,cols:null,score:0};for(let t=1;t<=x;t++){const y=ue(q,t,g),E=y.reduce((D,J)=>D+J.maxW,0)+h*(t-1),f=Math.max(...y.map(D=>D.sumH));if(E<=0||f<=0)continue;const M=p/E,_=b/f,w=Math.min(M,_),S=Math.max(.01,w*.92),v=o.totalArea*S*S,T=p*b,B=v/T,z=y.map(D=>D.sumH*S),V=z.reduce((D,J)=>D+J,0)/t,A=Math.max(...z)-Math.min(...z),C=V>0?1-A/V:1,$=t===1?1.1:t===2?.9:.7,L=t>o.count*.5?.7:1,P=C>.85?1.05:1,G=S*(1+B*.25)*(1+C*.1)*$*L*P;G>n.score&&(n={S,k:t,cols:y,score:G,efficiency:B,colBalance:C})}const u=n.cols.map(t=>t.maxW*n.S),m=u.reduce((t,y)=>t+y,0);let c=[];if(n.k===1)c[0]=d/2;else{const t=(n.k-1)*h,y=m+t;if(y<p){const E=p-y,f=h+E/(n.k-1);let M=i;for(let _=0;_<n.k;_++)c[_]=M+u[_]/2,M+=u[_]+f}else{let E=i+Math.max(0,(p-y)/2);for(let f=0;f<n.k;f++)c[f]=E+u[f]/2,E+=u[f]+h}}const e=[],a=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(t=>t.right));for(let t=0;t<n.k;t++){const y=n.cols[t];e[t]=[];const E=y.items.map(A=>q[A].h*n.S),f=E.reduce((A,C)=>A+C,0);if(y.items.length===0)continue;const M=c[t],_=n.cols[t].maxW*n.S,w=M-_/2,S=M+_/2,v=a(),B=Math.max(0,Math.min(S,v)-w)/_,z=B>.05;let V=b;if(z&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const C=Math.min(...window.__legendBoxesGroup.map($=>$.top))-15;V=Math.max(10,C-i),console.log(`üìè Columna ${t}: X=${w.toFixed(0)}-${S.toFixed(0)}, legendWidth=${v.toFixed(0)}, solape=${(B*100).toFixed(0)}%, altura reducida a ${V.toFixed(0)}px`)}else console.log(`üìè Columna ${t}: X=${w.toFixed(0)}-${S.toFixed(0)}, legendWidth=${v.toFixed(0)}, solape=${(B*100).toFixed(0)}%, altura completa ${V.toFixed(0)}px`);if(y.items.length===1){const A=E[0],C=i+V/2,$=Math.max(i+A/2,Math.min(C,l-i-A/2));e[t].push($);continue}if(f>V){console.warn(`Columna ${t}: elementos no caben (${f}px > ${V}px)`);const $=f/y.items.length<4?20:5;let L=i;for(let P=0;P<y.items.length;P++){const G=Math.max(E[P],2),D=L+G/2;e[t].push(D),L+=G+$}}else{const A=V-f,C=y.items.length-1;let $=A/C;f/y.items.length<4?$=Math.max(18,Math.min($,50)):$=Math.max(5,$);const G=f+C*$,D=V-G;let J=i+Math.max(0,D/2);for(let pt=0;pt<y.items.length;pt++){const O=Math.max(E[pt],2),F=J+O/2,it=i+V-O/2,I=Math.max(i+O/2,Math.min(F,it));e[t].push(I),J+=O+$}}}return{S:n.S,k:n.k,cols:n.cols,centersX:c,centersYByCol:e,padding:i,gapRow:g,gapCol:h}}window.renderizarGrupoSVG=function(d,l){const r=d&&d.etiqueta&&d.etiqueta.id!=null?d.etiqueta.id:d&&d.id!=null?d.id:l,i=document.getElementById("contenedor-svg-"+r);if(!i)return;const h=600,g=150,x=Jt(i),p=Qt(h,g,x);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const b=[],o=new Map;(d.elementos||[]).forEach(e=>{var E,f,M,_,w,S;let a="0";if(e.diametro!=null&&e.diametro!==""){const T=String(e.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(T){const B=parseFloat(T[0]);isFinite(B)&&(a=String(Math.round(B)))}}const t=(e.dimensiones||"barra").trim().toLowerCase(),y=`${a}|${t}`;if(o.has(y)){const v=o.get(y);b[v].barrasTotal+=e.barras||0,(E=e.coladas)!=null&&E.colada1&&!b[v].coladasSet.has(e.coladas.colada1)&&b[v].coladasSet.add(e.coladas.colada1),(f=e.coladas)!=null&&f.colada2&&!b[v].coladasSet.has(e.coladas.colada2)&&b[v].coladasSet.add(e.coladas.colada2),(M=e.coladas)!=null&&M.colada3&&!b[v].coladasSet.has(e.coladas.colada3)&&b[v].coladasSet.add(e.coladas.colada3)}else{const v=new Set;(_=e.coladas)!=null&&_.colada1&&v.add(e.coladas.colada1),(w=e.coladas)!=null&&w.colada2&&v.add(e.coladas.colada2),(S=e.coladas)!=null&&S.colada3&&v.add(e.coladas.colada3),b.push({elemento:e,diametro:a,dimensiones:e.dimensiones,barrasTotal:e.barras||0,coladasSet:v}),o.set(y,b.length-1)}});const s=b.map((e,a)=>{const t=[];d.colada_etiqueta&&t.push(d.colada_etiqueta),d.colada_etiqueta_2&&d.colada_etiqueta_2!==d.colada_etiqueta&&t.push(d.colada_etiqueta_2),t.length===0&&e.coladasSet.size>0&&t.push(...e.coladasSet);const y=t.length>0?` (${t.join(", ")})`:"";return{letter:zt(a),text:`√ò${e.diametro} x${e.barrasTotal}${y}`}});ee(p,s,h,g);const n=b.map(e=>{const a=e.elemento,t=oe(a.dimensiones||""),y=ne(t);let E=0;for(const S of y)S.type==="line"&&(E=Math.max(E,Math.abs(S.length||0))),S.type==="arc"&&(E=Math.max(E,Math.abs(S.radius||0)));const M=E<=50?2:1,_=Ht(y,M),w=le(_);return{dimsRaw:t,dimsNoZero:y,dimsScaled:_,geomScale:M,medida:w}}),u=n.map(e=>e.medida),m=pe(u,h,g,{padding:20,gapCol:50,gapRow:22,kMax:3}),c=new Map;for(let e=0;e<m.k;e++)m.cols[e].items.forEach((a,t)=>c.set(a,{c:e,j:t}));b.forEach(function(e,a){const t=e.elemento,{dimsNoZero:y,dimsScaled:E,medida:f}=n[a],M=c.get(a),_=m.centersX[M.c],w=m.centersYByCol[M.c][M.j],S=m.S,v=f.ptsRot.map(O=>({x:_+(O.x-f.midX)*S,y:w+(O.y-f.midY)*S})),T=Math.min(...v.map(O=>O.x)),B=Math.max(...v.map(O=>O.x)),z=Math.min(...v.map(O=>O.y)),V=Math.max(...v.map(O=>O.y)),A={left:T,right:B,top:z,bottom:V};window.__figBoxesGroup.push({...A});const C=re(E,.6),$=ce(C,f.cxModel,f.cyModel,f.rotDeg,S,f.midX,f.midY,_,w),L=Kt(p,$,Xt,2);(function(){const F=de(E);function it(N){return Math.abs(Math.abs(N)-90)>=Yt}const I=(N,k)=>_t({x:N.x,y:N.y},0,0,k),Q=(N,k)=>{const K=_t({x:N,y:k},f.cxModel,f.cyModel,f.rotDeg);return{x:_+(K.x-f.midX)*S,y:w+(K.y-f.midY)*S}},R=N=>Math.max(10,Math.min(28,N));F.forEach(N=>{if(!it(N.angleDeg))return;const k=Q(N.x,N.y),K=I(N.prevDir,f.rotDeg),gt=I(N.nextDir,f.rotDeg),Z=Math.atan2(K.y,K.x),X=Z+U(N.angleDeg),tt=Math.min(A.right-A.left,A.bottom-A.top);let j=R(.12*tt);const wt=k.x+j*Math.cos(Z),ht=k.y+j*Math.sin(Z),W=k.x+j*Math.cos(X),bt=k.y+j*Math.sin(X),et=Math.abs(N.angleDeg),ct=et>180?1:0,Ct=N.angleDeg>=0?1:0,lt=document.createElementNS("http://www.w3.org/2000/svg","path");lt.setAttribute("d",`M ${wt} ${ht} A ${j} ${j} 0 ${ct} ${Ct} ${W} ${bt}`),lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.setAttribute("fill","none"),lt.style.pointerEvents="none",p.appendChild(lt);let H=K.x+gt.x,Y=K.y+gt.y;et>180&&(H=-H,Y=-Y);let ot=Math.hypot(H,Y);if(ot<1e-6){const ut=N.angleDeg>=0?1:-1;H=-K.y*ut,Y=K.x*ut,ot=Math.hypot(H,Y)||1}H/=ot,Y/=ot;const at=(Math.round(N.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",nt=Lt(at,14);function At(ut,mt){return{left:ut-nt.w/2,right:ut+nt.w/2,top:mt-nt.h/2,bottom:mt+nt.h/2}}let rt=null;for(let ut=Tt;ut<=Wt&&!rt;ut+=4)for(let mt=0;mt<Ft.length&&!rt;mt++){const xt=Ft[mt],Et=I({x:H,y:Y},xt),St=k.x+Et.x*(j+ut),ft=k.y+Et.y*(j+ut),yt=At(St,ft);yt.top<0||yt.bottom>g||yt.left<0||yt.right>h||window.__figBoxesGroup.some(qt=>st(qt,yt,6))||(window.__dimBoxesGroup||[]).some(qt=>st(qt,yt,2))||(window.__angleBoxesGroup||[]).some(qt=>st(qt,yt,2))||(window.__placedLetterBoxes||[]).some(qt=>st(qt,yt,2))||(window.__legendBoxesGroup||[]).some(qt=>st(qt,yt,6))||(rt={x:St,y:ft,box:yt})}if(!rt){const ut=k.x+H*(j+Tt),mt=k.y+Y*(j+Tt),xt=At(ut,mt);rt={x:ut,y:mt,box:xt}}window.__angleBoxesGroup.push(rt.box);const dt=document.createElementNS("http://www.w3.org/2000/svg","text");dt.setAttribute("x",rt.x),dt.setAttribute("y",rt.y),dt.setAttribute("fill",Bt),dt.setAttribute("font-size",14),dt.setAttribute("text-anchor","middle"),dt.setAttribute("alignment-baseline","middle"),dt.style.cursor="pointer",dt.textContent=at,p.appendChild(dt),dt.addEventListener("mouseenter",()=>{lt.setAttribute("stroke","rgba(255,69,0,1)"),lt.setAttribute("stroke-width","3"),lt.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),dt.addEventListener("mouseleave",()=>{lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.style.filter="none"})})})();const P=L.cloneNode(!1);P.setAttribute("stroke-width","50"),P.setAttribute("stroke","transparent"),P.setAttribute("fill","none"),P.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(O=>{P.addEventListener(O,F=>L.dispatchEvent(new F.constructor(F.type,F)))}),p.insertBefore(P,L),(t.codigo!=null?t.codigo:t.id)+"",L.style.cursor="pointer",L.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),L.addEventListener("click",function(O){if(O.ctrlKey||O.metaKey||O.shiftKey){O.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(t.id);return}abrirModalDividirElemento(t.id,t.barras||0)}),L.addEventListener("contextmenu",function(O){O.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(t.id)});const G=[],D=Rt(C),J=Rt(y);ie(D,J,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(O){const F=_t(O.start,f.cxModel,f.cyModel,f.rotDeg),it=_t(O.end,f.cxModel,f.cyModel,f.rotDeg),I={x:_+(F.x-f.midX)*S,y:w+(F.y-f.midY)*S},Q={x:_+(it.x-f.midX)*S,y:w+(it.y-f.midY)*S},R=O._label,N=Q.x-I.x,k=Q.y-I.y,K=Math.hypot(N,k)||1,gt=N/K,Z=k/K,X=k/K,tt=-N/K,j=(I.x+Q.x)/2,wt=(I.y+Q.y)/2,ht=j+X*10,W=wt+tt*10,bt=Lt(R,14),et=bt.w,ct=bt.h;function Ct(rt,dt){return{left:rt-et/2,right:rt+et/2,top:dt-ct/2,bottom:dt+ct/2}}const lt=K*.45;let H=ht,Y=W;for(let rt=0;rt<=Math.ceil(lt/6);rt++){const dt=rt%2===0?1:-1,ut=Math.ceil(rt/2),mt=dt*ut*6;if(Math.abs(mt)>lt)continue;const xt=ht+gt*mt,Et=W+Z*mt,St=(xt-I.x)*gt+(Et-I.y)*Z;if(St<0+et*.3||St>K-et*.3)continue;const ft=Ct(xt,Et);if(!(st({left:Math.min(I.x,Q.x),right:Math.max(I.x,Q.x),top:Math.min(I.y,Q.y),bottom:Math.max(I.y,Q.y)},ft,0)||(window.__angleBoxesGroup||[]).some(vt=>st(vt,ft,2))||(window.__legendBoxesGroup||[]).some(vt=>st(vt,ft,6))||G.some(vt=>st(vt,ft,2))||ft.top<0||ft.bottom>g||ft.left<0||ft.right>h)){H=xt,Y=Et,G.push(ft),window.__dimBoxesGroup.push(ft);break}}const ot=document.createElementNS("http://www.w3.org/2000/svg","line");ot.setAttribute("x1",I.x),ot.setAttribute("y1",I.y),ot.setAttribute("x2",Q.x),ot.setAttribute("y2",Q.y),ot.setAttribute("stroke","rgba(0,0,255,0.6)"),ot.setAttribute("stroke-width","4"),ot.setAttribute("stroke-linecap","round"),ot.setAttribute("vector-effect","non-scaling-stroke"),ot.style.opacity=0,ot.style.pointerEvents="none",ot.style.transition="opacity 120ms ease",p.appendChild(ot);const at=document.createElementNS("http://www.w3.org/2000/svg","text");at.setAttribute("x",H),at.setAttribute("y",Y),at.setAttribute("fill",Bt),at.setAttribute("font-size",14),at.setAttribute("text-anchor","middle"),at.setAttribute("alignment-baseline","middle"),at.setAttribute("tabindex","0"),at.style.cursor="pointer",at.textContent=R,p.appendChild(at);function nt(){ot.style.opacity=1}function At(){ot.style.opacity=0}at.addEventListener("mouseenter",nt),at.addEventListener("mouseleave",At),at.addEventListener("focus",nt),at.addEventListener("blur",At)}),function(){const F=[];let it=0,I=0,Q=0;for(let R=0;R<E.length;R++){const N=E[R];if(N.type==="line")it+=N.length*Math.cos(U(Q)),I+=N.length*Math.sin(U(Q));else if(N.type==="turn")Q+=N.angle;else if(N.type==="arc"){const k=it+N.radius*Math.cos(U(Q+90)),K=I+N.radius*Math.sin(U(Q+90)),gt=Math.atan2(I-K,it-k),Z=gt+U(N.arcAngle);let X=N.radius;for(let tt=0;tt<y.length;tt++){const j=y[tt];if(j.type==="arc"&&Math.abs(j.arcAngle-N.arcAngle)<.01){X=j.radius;break}}F.push({center:{x:k,y:K},radius:N.radius,originalRadius:X,arcAngle:N.arcAngle,startAngle:gt,endAngle:Z}),it=k+N.radius*Math.cos(Z),I=K+N.radius*Math.sin(Z),Q+=N.arcAngle}}F.forEach(function(R){const N=_t(R.center,f.cxModel,f.cyModel,f.rotDeg),k={x:_+(N.x-f.midX)*S,y:w+(N.y-f.midY)*S},K=(R.startAngle+R.endAngle)/2,gt=R.radius*S,Z="R"+Vt(R.originalRadius,{decimals:0,step:null}),X=Lt(Z,14),tt=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let j=!1,wt,ht,W;for(let nt=0;nt<tt.length&&!j;nt++){const At=tt[nt],rt=K+U(At),dt={x:R.center.x+R.radius*Math.cos(rt),y:R.center.y+R.radius*Math.sin(rt)},ut=_t(dt,f.cxModel,f.cyModel,f.rotDeg),mt={x:_+(ut.x-f.midX)*S,y:w+(ut.y-f.midY)*S},xt=mt.x-k.x,Et=mt.y-k.y,St=Math.hypot(xt,Et)||1,ft=xt/St,yt=Et/St;for(let Mt=8;Mt<=60&&!j;Mt+=6){const $t=gt*.7;if(wt=k.x+ft*$t+ft*Mt,ht=k.y+yt*$t+yt*Mt,W={left:wt-X.w/2,right:wt+X.w/2,top:ht-X.h/2,bottom:ht+X.h/2},!(W.top<0||W.bottom>g||W.left<0||W.right>h||window.__figBoxesGroup.some(It=>st(It,W,2))||(window.__legendBoxesGroup||[]).some(It=>st(It,W,2)))){j=!0;break}}}if(!j)return;G.push(W);const bt={x:wt-k.x,y:ht-k.y},et=Math.hypot(bt.x,bt.y)||1,ct={x:bt.x/et,y:bt.y/et},Ct=k.x+ct.x*gt*.6,lt=k.y+ct.y*gt*.6,H=document.createElementNS("http://www.w3.org/2000/svg","line");H.setAttribute("x1",k.x),H.setAttribute("y1",k.y),H.setAttribute("x2",Ct),H.setAttribute("y2",lt),H.setAttribute("stroke","rgba(0,128,0,0.6)"),H.setAttribute("stroke-width","4"),H.setAttribute("stroke-linecap","round"),H.setAttribute("vector-effect","non-scaling-stroke"),H.style.opacity=0,H.style.pointerEvents="none",H.style.transition="opacity 120ms ease",p.appendChild(H);const Y=document.createElementNS("http://www.w3.org/2000/svg","text");Y.setAttribute("x",wt),Y.setAttribute("y",ht),Y.setAttribute("fill",Bt),Y.setAttribute("font-size",14),Y.setAttribute("text-anchor","middle"),Y.setAttribute("alignment-baseline","middle"),Y.setAttribute("tabindex","0"),Y.style.cursor="pointer",Y.textContent=Z,p.appendChild(Y);function ot(){H.style.opacity=1}function at(){H.style.opacity=0}Y.addEventListener("mouseenter",ot),Y.addEventListener("mouseleave",at),Y.addEventListener("focus",ot),Y.addEventListener("blur",at)})}(),function(){const F=zt(a),it=14,I=Lt(F,it);function Q(X,tt){return{left:X,right:X+I.w,top:tt-I.h/2,bottom:tt+I.h/2}}let R=null;const N=(A.top+A.bottom)/2,k=Math.max(I.h/2,Math.min(N,g-I.h/2));function K(X){for(let j=0;j<=30;j+=4){const wt=j%2===0?1:-1,ht=Math.ceil(j/2),W=wt*ht*4,bt=Math.max(I.h/2,Math.min(g-I.h/2,k+W)),et=X,ct=Q(et,bt);if(!(window.__figBoxesGroup.some(nt=>st(nt,ct,6))||(window.__dimBoxesGroup||[]).some(nt=>st(nt,ct,3))||(window.__angleBoxesGroup||[]).some(nt=>st(nt,ct,3))||(window.__legendBoxesGroup||[]).some(nt=>st(nt,ct,6))||(window.__placedLetterBoxes||[]).some(nt=>st(nt,ct,2))||ct.top<0||ct.bottom>g||ct.left<0||ct.right>h))return R={x:et,y:bt,box:ct},!0}return!1}const gt=[{x:A.right+10,priority:1},{x:A.left-10-I.w,priority:1},{x:A.right+15,priority:2},{x:A.left-15-I.w,priority:2},{x:A.right+5,priority:2},{x:A.left-5-I.w,priority:2},{x:A.right+20,priority:3},{x:A.left-20-I.w,priority:3},{x:A.right+25,priority:3},{x:A.left-25-I.w,priority:3},{x:A.right+30,priority:3},{x:A.left-30-I.w,priority:3}];gt.sort((X,tt)=>X.priority-tt.priority);for(const X of gt){if(R)break;const tt=Nt(X.x,I.w,0,h);if(K(tt))break}if(!R){const X=(A.left+A.right)/2,tt=[{x:X-I.w/2,y:A.top-I.h-5},{x:X-I.w/2,y:A.bottom+I.h+5}];for(const j of tt){if(R)break;const wt=Nt(j.x,I.w,0,h),ht=Math.max(I.h/2,Math.min(g-I.h/2,j.y)),W=Q(wt,ht);!window.__figBoxesGroup.some(et=>st(et,W,6))&&!(window.__dimBoxesGroup||[]).some(et=>st(et,W,3))&&!(window.__angleBoxesGroup||[]).some(et=>st(et,W,3))&&!(window.__legendBoxesGroup||[]).some(et=>st(et,W,6))&&!(window.__placedLetterBoxes||[]).some(et=>st(et,W,2))&&W.top>=0&&W.bottom<=g&&W.left>=0&&W.right<=h&&(R={x:wt,y:ht,box:W})}}if(!R){const X=Nt(h-I.w,I.w,0,h),tt=k;R={x:X,y:tt,box:Q(X,tt)}}window.__placedLetterBoxes.push(R.box);const Z=document.createElementNS("http://www.w3.org/2000/svg","text");Z.setAttribute("x",R.x),Z.setAttribute("y",R.y),Z.setAttribute("fill",Ut),Z.setAttribute("font-size",it),Z.setAttribute("text-anchor","start"),Z.setAttribute("alignment-baseline","middle"),Z.style.fontWeight="600",Z.style.pointerEvents="none",Z.textContent=F,p.appendChild(Z)}()}),i.innerHTML="",i.appendChild(p)};function Dt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const q=window.elementosAgrupadosScript;if(!q)return;const d=document.getElementById("grid-maquina");if(d&&window.updateGridClasses){const l=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,r),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}q.forEach(function(l,r){renderizarGrupoSVG(l,r)}),requestAnimationFrame(()=>{d&&(d.style.opacity="1",d.style.visibility="visible",d.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",d.className)),document.querySelectorAll(".proceso").forEach(l=>{l.style.opacity="1"})}),window.actualizarSVGConColadas=function(l,r){if(!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,h=i.findIndex(x=>x.etiqueta&&String(x.etiqueta.etiqueta_sub_id)===String(l));if(h===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${l}`);return}const g=i[h];g.elementos&&r&&g.elementos.forEach(x=>{const p=String(x.id),b=r[p];x.coladas||(x.coladas={colada1:null,colada2:null,colada3:null}),b&&Array.isArray(b)&&(x.coladas.colada1=b[0]||null,x.coladas.colada2=b[1]||null,x.coladas.colada3=b[2]||null)}),renderizarGrupoSVG(g,h),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${l}`,r)},window.limpiarColadasSVG=function(l){if(!window.elementosAgrupadosScript)return;const r=window.elementosAgrupadosScript,i=r.findIndex(g=>g.etiqueta&&String(g.etiqueta.etiqueta_sub_id)===String(l));if(i===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${l}`);return}const h=r[i];h.elementos&&h.elementos.forEach(g=>{g.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(h,i),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${l}`)},window.addEventListener("regenerar-svg-etiqueta",function(l){var x;const r=(x=l.detail)==null?void 0:x.etiquetaSubId;if(!r||!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,h=i.findIndex(p=>p.etiqueta&&String(p.etiqueta.etiqueta_sub_id)===String(r));if(h===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${r}`);return}const g=i[h];renderizarGrupoSVG(g,h),console.log(`üîÑ SVG regenerado para etiqueta ${r} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);window.abrirModalDividirElemento=function(d,l){const r=document.getElementById("modalDividirElemento"),i=document.getElementById("dividir_elemento_id"),h=document.getElementById("dividir_barras_totales"),g=document.getElementById("labelBarrasActuales"),x=document.getElementById("barras_a_mover"),p=document.getElementById("previewDivision"),b=document.getElementById("formDividirElemento");if(!r||!i||!b)return;i.value=d;let o=null,s=parseInt(l)||0;if(window.elementosAgrupadosScript){for(const a of window.elementosAgrupadosScript)if(a.elementos){const t=a.elementos.find(y=>String(y.id)===String(d));if(t){o=t,t.barras&&(s=parseInt(t.barras)||0);break}}}if(!o&&window.gruposResumenData){for(const a of window.gruposResumenData)if(a.elementos){const t=a.elementos.find(y=>String(y.id)===String(d));if(t){o=t,t.barras&&(s=parseInt(t.barras)||0);break}}}const n=o&&o.estado==="fabricado",u=o&&o.paquete_id,m=n||u,c=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),e=c==null?void 0:c.closest("label");if(c){if(c.disabled=m,e)if(m){e.classList.add("opacity-50","cursor-not-allowed");let a=n?"El elemento ya est√° fabricado":"El elemento pertenece a un paquete";e.setAttribute("title",a)}else e.classList.remove("opacity-50","cursor-not-allowed"),e.removeAttribute("title");if(m&&c.checked){const a=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');a&&(a.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}h&&(h.value=s),g&&(g.textContent=s>0?s:"-"),x&&(x.value=""),p&&p.classList.add("hidden"),window.rutaDividirElemento&&b.setAttribute("action",window.rutaDividirElemento),r.classList.remove("hidden")};window.enviarDivision=async function(){const d=document.getElementById("formDividirElemento"),l=d.getAttribute("action")||window.rutaDividirElemento,r=new FormData(d);try{const i=document.querySelector('meta[name="csrf-token"]'),h=r.get("_token")||(i?i.getAttribute("content"):null),x=await fetch(l,{method:"POST",headers:h?{"X-CSRF-TOKEN":h}:{},body:r}),p=await x.json();if(!x.ok||!p.success)throw new Error(p.message||"Error al dividir");d.reset();const b=document.getElementById("modalDividirElemento");b&&b.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",p.message,"success"):alert(p.message)}catch(i){window.Swal?window.Swal.fire("Error",i&&i.message||"Error","error"):alert(i&&i.message||"Error")}};(function(q){const d={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},l={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function r(p,b,o={}){console.log(`üîÑ Actualizando etiqueta ${p} a estado: ${b}`);const s=String(p).replace(/\./g,"-"),n=document.querySelector(`#etiqueta-${s}`);if(!n)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${p}`),!1;const u=String(b).toLowerCase().trim(),m=l[u];if(!m)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${b}`),!1;n.dataset.estado=u,Array.from(n.classList).forEach(t=>{t.startsWith("estado-")&&n.classList.remove(t)}),n.classList.add(m.cssClass),n.style.setProperty("--bg-estado",m.bgColor);const e=n.querySelector('[id^="contenedor-svg-"]');if(e){const t=e.querySelector("svg");t&&(t.style.background=m.bgColor)}const a=n.querySelector(".etiqueta-card")||n;return a&&(a.style.background=m.bgColor),i(n,u),h(n),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:p,estado:u,datosExtra:o}})),console.log(`‚úÖ Etiqueta ${p} actualizada a ${b}`),!0}function i(p,b){const o=p.querySelectorAll(".btn-fabricar"),s=["empaquetada","en-paquete"];o.forEach(n=>{s.includes(b)?(n.disabled=!0,n.style.opacity="0.5",n.style.cursor="not-allowed",n.title=`Etiqueta ya ${b}`):(n.disabled=!1,n.style.opacity="1",n.style.cursor="pointer",n.title="Fabricar esta etiqueta")})}function h(p){p.style.transition="transform 0.5s ease, background-color 0.5s ease",p.style.transform="scale(1.03)",setTimeout(()=>{p.style.transform="scale(1)"},400)}function g(p,b,o={}){console.log(`üîÑ Actualizando ${p.length} etiquetas...`);const n=p.map(u=>r(u,b,o)).filter(u=>u).length;return console.log(`‚úÖ ${n}/${p.length} etiquetas actualizadas`),n}function x(p){const b=String(p).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${b}`);return o?{id:p,estado:o.dataset.estado||"desconocido",elemento:o}:null}window.addEventListener("paquete:creado",p=>{const{codigoPaquete:b,etiquetaIds:o}=p.detail;console.log(`üì¶ Evento paquete:creado recibido - ${b} con ${o.length} etiquetas`),g(o,"empaquetada",{codigo_paquete:b})}),q.SistemaDOM={actualizarEstadoEtiqueta:r,actualizarMultiplesEtiquetas:g,obtenerEstadoActual:x,ESTADOS_CONFIG:l},q.ColoresEstado={actualizar:(p,b)=>{d[p]=b;const o=document.getElementById("colores-estado-css");if(o){let s=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[n,u]of Object.entries(d))s+=`.proceso.estado-${n} {
    --bg-estado: ${u};
}
`;o.textContent=s,console.log(`‚úÖ Color actualizado para estado "${p}": ${b}`)}},obtenerColor:p=>d[p],todos:()=>({...d})}})(window);function Pt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const o=localStorage.getItem("decisionCortePorEtiqueta");o&&(window._decisionCortePorEtiqueta=JSON.parse(o),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(o){console.warn("No se pudieron restaurar decisiones de corte:",o)}document.addEventListener("click",async o=>{var y,E,f;const s=o.target.closest(".btn-fabricar");if(!s)return;o.preventDefault();const n=(E=(y=document.getElementById("maquina-info"))==null?void 0:y.dataset)==null?void 0:E.maquinaId;if(!n){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const u=s.dataset.grupoId;if(u){const M=s.disabled;s.disabled=!0;try{await d(u,n)}finally{s.disabled=M}return}const m=String(s.dataset.etiquetaId||"").trim(),c=m.replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${c}`);if(e){const M=(e.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(M)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${m} ya est√° en estado ${M}.`,timer:2500,showConfirmButton:!1});return}}const a=Number(((f=window.DIAMETRO_POR_ETIQUETA)==null?void 0:f[m])??0);if(!m){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!a&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const t=s.disabled;s.disabled=!0;try{await q(m,n,a)}finally{s.disabled=t}});async function q(o,s,n=null){var _,w,S,v,T,B,z,V;const u=`/actualizar-etiqueta/${o}/maquina/${s}`,m=(_=document.querySelector('meta[name="csrf-token"]'))==null?void 0:_.getAttribute("content"),c=o.replace(/\./g,"-"),a=(((S=(w=document.querySelector(`#etiqueta-${c}`))==null?void 0:w.dataset)==null?void 0:S.estado)||"").toLowerCase()==="fabricando",t=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",y=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",E=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",f=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:t,esSL28:y,esCortadoraManual:E,esCortadoraDobladoraBarra:f}),t&&y||E||f){if(a)if((v=window._decisionCortePorEtiqueta)!=null&&v[o]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:i,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[o],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const A=await fetch(`/api/etiquetas/${o}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":m}});if(A.ok){const C=await A.json();if(C.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:C.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:o,elementos:[]}],csrfToken:m,etiquetaId:o,onUpdate:i,pedirDesperdicio:!1});return}}}catch(A){console.warn("No se pudo obtener longitud asignada:",A)}for(;;){let A;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),A=await Cortes.mejorCorteSimple(o,n,m),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",A)}catch(C){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",C),b(C);return}if(!A){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",A.accion),A.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let C;try{C=await Cortes.mejorCorteOptimizado(o,n,A.patrones,m)}catch($){b($);return}if((C==null?void 0:C.accion)==="fabricar"){const $=((T=C.patronInfo)==null?void 0:T.desperdicio_cm)||((B=C.patron)==null?void 0:B.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[o]={longitudBarraCm:C.longitudBarraCm,etiquetas:C.etiquetas,desperdicioEstimadoCm:$},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const L=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:i});if(L!=null&&L.cancelled)continue;return}else{if(C==="volver")continue;return}}if(A.accion==="fabricar_patron_simple"){const C=Math.round(Number(A.longitud_m||0)*100);if(!C){b("Longitud de barra no v√°lida.");return}const $=((z=A.patronInfo)==null?void 0:z.desperdicio_cm)||((V=A.patron)==null?void 0:V.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[o]={longitudBarraCm:C,etiquetas:[{etiqueta_sub_id:o,elementos:[]}],desperdicioEstimadoCm:$},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const L=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:i});if(L!=null&&L.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await r(o,s,m)}catch(A){b(A)}return}try{const A=await fetch(u,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":m},body:JSON.stringify({})}),C=await A.json();if(!A.ok)throw new Error(C.message||"Error al actualizar");i(o,C)}catch(A){b(A)}}async function d(o,s){var _,w,S,v,T,B,z,V,A;const n=(_=document.querySelector('meta[name="csrf-token"]'))==null?void 0:_.getAttribute("content"),u=document.querySelector(`[data-grupo-id="${o}"] .etiqueta-card`),m=(((w=u==null?void 0:u.dataset)==null?void 0:w.estado)||"pendiente").toLowerCase(),c=parseInt((S=u==null?void 0:u.dataset)==null?void 0:S.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(m)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${m}.`,timer:2500,showConfirmButton:!1});return}const e=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",a=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",t=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",y=e&&a||t;let E=[];try{E=JSON.parse(((v=u==null?void 0:u.dataset)==null?void 0:v.etiquetasSubIds)||"[]")}catch(C){console.warn("Error parseando etiquetas del grupo:",C)}const f=(T=u==null?void 0:u.dataset)==null?void 0:T.primeraEtiquetaId,M=((B=u==null?void 0:u.dataset)==null?void 0:B.planillaId)||window.PLANILLA_ID;if(m==="pendiente"&&y&&f){try{for(;;){const C=await Cortes.mejorCorteSimple(f,c,n);if(!C)return;if(C.accion==="optimizar"){const $=await Cortes.mejorCorteOptimizado(f,c,null,n);if($==="volver")continue;if(!$||$.accion!=="fabricar")return;const L=((z=$.patronInfo)==null?void 0:z.desperdicio_cm)||0;let P=null;const G=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:$.longitudBarraCm,etiquetas:$.etiquetas,csrfToken:n,etiquetaId:f,desperdicioEstimadoCm:L,onUpdate:(D,J)=>{J.producto_n_colada&&(P={colada1:J.producto_n_colada,colada2:J.producto2_n_colada||null}),l(u,"fabricando",o,P)},pedirDesperdicio:!0});if(G!=null&&G.cancelled)continue;l(u,"fabricando",o,P),p("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(C.accion==="fabricar_patron_simple"){const $=Math.round(Number(C.longitud_m||0)*100);if(!$){b("Longitud de barra no v√°lida.");return}const L=((V=C.patronInfo)==null?void 0:V.desperdicio_cm)||((A=C.patron)==null?void 0:A.sobra_cm)||0,P=E.map(J=>({etiqueta_sub_id:J,patron_letras:C.patron_letras||""}));let G=null;const D=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:$,etiquetas:P,csrfToken:n,etiquetaId:f,desperdicioEstimadoCm:L,onUpdate:(J,pt)=>{pt.producto_n_colada&&(G={colada1:pt.producto_n_colada,colada2:pt.producto2_n_colada||null}),l(u,"fabricando",o,G)},pedirDesperdicio:!0});if(D!=null&&D.cancelled)continue;l(u,"fabricando",o,G),p("info","Fabricando",`Grupo iniciado (${E.length} etiquetas)`);return}return}}catch(C){b(C)}return}try{const C=await fetch(`/api/etiquetas/resumir/${o}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({maquina_id:s})}),$=await C.json();if(!C.ok||!$.success)throw new Error($.message||"Error al actualizar grupo");const L=$.nuevo_estado||"actualizado",P=$.imprimir_etiquetas||[],G={colada1:$.producto_n_colada||null,colada2:$.producto2_n_colada||null};if(l(u,L,o,G),L==="fabricando"){const D=G.colada1?` - Colada: ${G.colada1}`:"";p("info","Fabricando",`Grupo iniciado (${$.etiquetas_actualizadas||0} etiquetas)${D}`)}else L==="completada"&&p("success","¬°Completado!",`Grupo completado (${$.etiquetas_actualizadas||0} etiquetas)`);if(L==="completada"&&P.length>0){const D=P.map(F=>F.etiqueta_sub_id);await new Promise(F=>setTimeout(F,300));const J=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${D.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(J.isConfirmed||J.isDenied){const F=J.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(it=>setTimeout(it,800)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(D,F)}await new Promise(F=>setTimeout(F,500));const pt=$.planilla_id||M,O=$.maquina_id||s;if(pt&&O)try{await fetch("/api/etiquetas/resumir",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n,Accept:"application/json"},body:JSON.stringify({planilla_id:pt,maquina_id:O})}),console.log("Etiquetas reagrupadas despu√©s de completar")}catch(F){console.warn("No se pudieron reagrupar las etiquetas:",F)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let F=0;for(const it of D)try{const I=await window.TrabajoPaquete.validarEtiqueta(it);I.valida&&window.TrabajoPaquete.agregarItemEtiqueta(it,I)&&F++}catch(I){console.warn(`No se pudo a√±adir ${it} al carro:`,I)}F>0&&p("success","A√±adidas al carro",`${F} etiquetas a√±adidas al carro`)}l(u,"completada",o)}}catch(C){b(C)}}function l(o,s,n,u=null){if(!o)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(e=>{o.classList.remove(`estado-${e}`)}),o.classList.add(`estado-${s}`),o.dataset.estado=s;const m=o.dataset.contenedorSvgId,c=o.dataset.elementos;if(m&&c&&typeof window.renderizarGrupoSVG=="function")try{const e=JSON.parse(c);u&&(e.forEach(t=>{t.coladas={colada1:u.colada1||null,colada2:u.colada2||null,colada3:null}}),o.dataset.elementos=JSON.stringify(e));const a={id:parseInt(m),etiqueta:{id:parseInt(m)},elementos:e};window.renderizarGrupoSVG(a,n)}catch(e){console.warn("No se pudo re-renderizar SVG del grupo:",e)}}async function r(o,s,n){var C,$,L,P,G;const u=Number(((C=window.DIAMETRO_POR_ETIQUETA)==null?void 0:C[o])??0),c=Number((($=window.LONGITUD_POR_ETIQUETA)==null?void 0:$[o])??0)/100;let e="";try{const D=await fetch(`/api/productos/sugerencias?diametro=${u}&longitud=${c}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":n}});if(D.ok){const J=await D.json();J.productos&&J.productos.length>0?e=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${u}mm x ${c.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${J.productos.map(pt=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${pt.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${pt.codigo}</td>
                                                <td class="px-2 py-1">${pt.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${pt.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${pt.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:e=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${u}mm x ${c.toFixed(1)}m</p>`}}catch(D){console.warn("No se pudieron cargar sugerencias:",D)}const{value:a,isConfirmed:t}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${e}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const D=document.getElementById("swal-input-producto").value;return!D||!D.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):D.trim()}});if(!t||!a)return;let y;try{const D=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(a.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":n}});if(!D.ok){const J=await D.json();throw new Error(J.message||"Producto no encontrado")}y=await D.json()}catch(D){await Swal.fire({icon:"error",title:"Producto no encontrado",text:D.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${a}`});return}const E=(y.tipo||"").toLowerCase(),f=Number(y.diametro??0),M=Number(y.longitud??0);if(E&&E!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${y.codigo}</p>
                        <p><strong>Tipo:</strong> ${y.tipo||"N/A"}</p>
                    </div>
                `});return}if(f>0&&u>0&&Math.abs(f-u)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${f} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${u} mm</p>
                    </div>
                `});return}if(M>0&&c>0&&Math.abs(M-c)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${M.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${c.toFixed(2)} m</p>
                    </div>
                `});return}const _=y.longitud?`${y.longitud} m`:"N/A",{value:w,isConfirmed:S}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${y.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${y.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${_}</p>
                    <p><strong>Stock actual:</strong> ${((L=y.peso_stock)==null?void 0:L.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${y.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!S)return;const v=w==="completo",T=`/actualizar-etiqueta/${o}/maquina/${s}`,B=await fetch(T,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({producto_id:y.id,paquete_completo:v})}),z=await B.json();if(!B.ok)throw new Error(z.message||"Error al fabricar");const V=((P=z.metricas)==null?void 0:P.peso_consumido)||0,A=((G=z.metricas)==null?void 0:G.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${y.codigo}</p>
                <p><strong>Peso consumido:</strong> ${V.toFixed(2)} kg</p>
                ${A?`<p><strong>Paquete:</strong> ${A}</p>`:""}
                ${v?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),i(o,z),A&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const D=document.getElementById("codigo_paquete_mover");D&&(D.value=A,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function i(o,s){var u,m;const n=o.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:o,estado:s.estado,peso_etiqueta:s.peso_etiqueta,nombre:s.nombre,producto_n_colada:s.producto_n_colada,producto2_n_colada:s.producto2_n_colada,data_completa:s}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(o,s.estado,{peso:s.peso_etiqueta,nombre:s.nombre||o}):h(o,s.estado),s.producto_n_colada&&window.elementosAgrupadosScript){const c=window.elementosAgrupadosScript.findIndex(e=>e.etiqueta&&String(e.etiqueta.etiqueta_sub_id)===String(o));if(c!==-1){const e=window.elementosAgrupadosScript[c];e.colada_etiqueta=s.producto_n_colada,e.colada_etiqueta_2=s.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(e,c),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${s.producto_n_colada}`))}}switch(s.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(o,s.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(o,!0),(s.estado||"").toLowerCase()){case"cortando":p("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":p("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),g(n);break;case"fabricando":p("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":p("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),g(n),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(o,{id:o,peso_etiqueta:s.peso_etiqueta||0,estado:"fabricada",nombre:s.nombre||o}),s.elementos&&Array.isArray(s.elementos)&&s.elementos.length>0?s.elementos.some(e=>e.coladas&&(e.coladas.colada1||e.coladas.colada2||e.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${o}`,s.elementos),x(o,s.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${o}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${o}`);break;case"completada":p("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(u=window._decisionCortePorEtiqueta)!=null&&u[o]&&(delete window._decisionCortePorEtiqueta[o],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),g(n),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(o,{id:o,peso_etiqueta:s.peso_etiqueta||0,estado:"completada",nombre:s.nombre||o}),s.elementos&&Array.isArray(s.elementos)&&s.elementos.length>0?s.elementos.some(e=>e.coladas&&(e.coladas.colada1||e.coladas.colada2||e.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${o}`,s.elementos),x(o,s.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${o}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${o}`);break;case"ensamblando":p("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":p("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),g(n);break;case"soldando":p("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":p("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),g(n);break;default:console.warn(`Estado no manejado para etiqueta ${o}: ${s.estado}`),p("warning","Estado desconocido",`El estado recibido (${s.estado}) no est√° reconocido.`,3e3)}(m=s.productos_afectados)!=null&&m.length&&s.productos_afectados.forEach(c=>{const e=document.getElementById(`peso-stock-${c.id}`),a=document.getElementById(`progreso-texto-${c.id}`),t=document.getElementById(`progreso-barra-${c.id}`);e&&(e.textContent=`${c.peso_stock} kg`),a&&(a.textContent=`${c.peso_stock} / ${c.peso_inicial} kg`),t&&(t.style.height=`${c.peso_stock/c.peso_inicial*100}%`)})}function h(o,s){const n=o.replace(/\./g,"-"),u=document.getElementById("etiqueta-"+n);if(!u)return;u.dataset.estado=String(s||"").toLowerCase(),u.className=u.className.split(" ").filter(e=>!e.startsWith("estado-")).join(" ").trim(),u.classList.add("estado-"+u.dataset.estado);const m=u.querySelector('[id^="contenedor-svg-"]'),c=m==null?void 0:m.querySelector("svg");c&&(c.style.background=getComputedStyle(u).getPropertyValue("--bg-estado").trim())}function g(o){const s=`#etiqueta-${CSS.escape(o)}`,n=document.querySelector(s),u=Array.from(document.querySelectorAll(".proceso")),m=f=>(f||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),c=f=>{var w;const M=(w=f.dataset)==null?void 0:w.estado;if(M)return m(M);const _=f.querySelector('[id^="estado-"]');return m((_==null?void 0:_.textContent)||(_==null?void 0:_.innerText)||"")},e=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),a=f=>e.has(c(f)),t=n?u.indexOf(n):-1,E=(t>=0?u.slice(t+1):u).find(f=>!a(f));E?E.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function x(o,s){var e;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${o}`),!s||!Array.isArray(s)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${o}`);return}if(s.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${o}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const n=window.elementosAgrupadosScript.findIndex(a=>{var t;return((t=a.etiqueta)==null?void 0:t.etiqueta_sub_id)===o});if(n===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${o}`);return}window.elementosAgrupadosScript[n].elementos=s;const u=window.elementosAgrupadosScript[n],m=(e=u.etiqueta)==null?void 0:e.id;if(!m){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${o}`);return}const c=document.getElementById("contenedor-svg-"+m);if(!c){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${o} (id: ${m})`);return}try{const a=c.querySelector("svg");a&&a.remove();const t=600,y=150,E=c.closest(".proceso"),f=E&&getComputedStyle(E).getPropertyValue("--bg-estado").trim()||"#e5e7eb",M=document.createElementNS("http://www.w3.org/2000/svg","svg");M.setAttribute("viewBox",`0 0 ${t} ${y}`),M.setAttribute("preserveAspectRatio","xMidYMid meet"),M.style.width="100%",M.style.height="100%",M.style.display="block",M.style.background=f;const _=(u.elementos||[]).map((S,v)=>{var A,C,$;const T=S.barras!=null?S.barras:0;let B="N/A";if(S.diametro!=null&&S.diametro!==""){const P=String(S.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(P){const G=parseFloat(P[0]);isFinite(G)&&(B=String(Math.round(G)))}}const z=[];(A=S.coladas)!=null&&A.colada1&&z.push(S.coladas.colada1),(C=S.coladas)!=null&&C.colada2&&z.push(S.coladas.colada2),($=S.coladas)!=null&&$.colada3&&z.push(S.coladas.colada3);const V=z.length>0?` (${z.join(", ")})`:"";return{letter:indexToLetters(v),text:`√ò${B} x${T}${V}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(M,_,t,y):console.error("‚ùå drawLegendBottomLeft no est√° definida");const w=document.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("x",t/2),w.setAttribute("y",y/2),w.setAttribute("text-anchor","middle"),w.setAttribute("fill","#059669"),w.setAttribute("font-size","14"),w.setAttribute("font-weight","600"),w.textContent="‚úì Coladas actualizadas",M.appendChild(w),c.appendChild(M),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${o}`),setTimeout(()=>{w&&w.parentNode&&w.remove()},2e3)}catch(a){console.error(`‚ùå Error al actualizar SVG para etiqueta ${o}:`,a),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function p(o,s,n,u=2e3){Swal.fire({icon:o,title:s,text:n,timer:u,showConfirmButton:!1})}function b(o){Swal.fire({icon:"error",title:"Error",text:o.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=i}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pt):Pt();document.addEventListener("livewire:navigated",Pt);(function(q){let d=[],l=!1,r=null;async function i(c){var a;const e=`/etiquetas/${encodeURIComponent(c)}/validar-para-paquete`;try{const t=await fetch(e,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content}});if(!(t.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const E=await t.json();if(console.log("üîç validarEtiqueta response:",{status:t.status,data:E,peso_etiqueta:E.peso_etiqueta}),!t.ok)throw new Error((E==null?void 0:E.message)||(E==null?void 0:E.motivo)||"Error al validar");return E}catch(t){throw t}}function h(c,e){const a=e.id||c;if(d.some(E=>E.id===a))return!1;const t=parseFloat(e.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:c,id:a,peso_etiqueta_recibido:e.peso_etiqueta,peso_parseado:t,data_completa:e});const y={id:a,type:"etiqueta",peso:t,estado:e.estado||"desconocido",nombre:e.nombre||"Sin nombre"};return d.push(y),o(),!0}function g(c){const e=d.findIndex(a=>a.id===c);e>=0&&d.splice(e,1),o()}function x(){d=[],o()}function p(){return d.reduce((c,e)=>c+(parseFloat(e.peso)||0),0)}function b(){return d}function o(){const c=document.getElementById("itemsList");if(!c)return;c.innerHTML="";for(const t of d){const y=document.createElement("li");y.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",y.dataset.code=t.id,y.innerHTML=`
                <div>
                    <div class="font-semibold">${t.id} === ${t.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,y.querySelector("button").onclick=()=>g(t.id),c.appendChild(y)}const e=p(),a=document.createElement("li");a.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",a.textContent=`Total: ${e.toFixed(2)} kg (${d.length} etiquetas)`,c.appendChild(a)}async function s(){var E,f,M;if(!d.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const c=Number(((f=(E=document.getElementById("maquina-info"))==null?void 0:E.dataset)==null?void 0:f.maquinaId)||window.maquinaId),e=Number(((M=document.getElementById("ubicacion-id"))==null?void 0:M.value)||window.ubicacionId),a=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!c){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!a&&!e){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const t={items:d.map(_=>({id:_.id,type:_.type})),maquina_id:c,ubicacion_id:a?null:e,sin_ubicacion:a},y=async(_={})=>{var v;const w=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(v=document.querySelector('meta[name="csrf-token"]'))==null?void 0:v.content},body:JSON.stringify({...t,..._})}),S=await w.json();if(!w.ok)throw new Error(S.message||"Error al crear el paquete");return S};try{const _=await y();if(_.success)return n(_);if(_.warning){let w="<div style='text-align:left;'>Se detectaron advertencias:";for(const[v,T]of Object.entries(_.warning))Array.isArray(T)&&T.length&&(w+=`<br><strong>${v.replaceAll("_"," ")}:</strong> ${T.join(", ")}`);if(w+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:w,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const v=await y({confirmar:!0});if(v.success)return n(v);throw new Error(v.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(_){await Swal.fire("Error",_.message||"Error inesperado","error")}}async function n(c){var E;console.log("üì¶ postCreacion llamada con data:",c);const e=c.codigo_paquete||((E=c.paquete)==null?void 0:E.codigo)||"N/D",a=p(),t=[...d.map(f=>f.id)];console.log("üì¶ Etiquetas a actualizar:",t),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${e}</strong> creado correctamente</p>
                       <p>${t.length} etiquetas ¬∑ ${a.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),x(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const f=document.getElementById("codigo_paquete_mover");f&&(f.value=e,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${e}</strong> creado correctamente</p><p>${t.length} etiquetas ¬∑ ${a.toFixed(2)} kg</p>`}),x()),console.log(`üì¶ Disparando evento paquete:creado para ${e}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:e,etiquetaIds:t,pesoTotal:a}})),console.log(`üîÑ Actualizando DOM para ${t.length} etiquetas con paquete ${e}`),t.forEach(f=>{u(f,e)})}function u(c,e){const a=String(c).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${c} (safe: ${a})`);let t=document.querySelector(`#etiqueta-${a}`);if(t&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${a}`),!t){const w=document.querySelector(`[data-etiqueta-sub-id="${c}"]`);w&&(t=w.querySelector(".etiqueta-card"),t&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!t){const w=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${w.length} grupos...`);for(const S of w)try{const v=JSON.parse(S.dataset.etiquetasSubIds||"[]");if(v.includes(c)){t=S,console.log(`‚úÖ Etiqueta ${c} encontrada en grupo con ${v.length} etiquetas`);break}}catch(v){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",v)}}if(!t){console.warn(`‚ùå No se encontr√≥ elemento: ${c}`);return}console.log(`üîÑ Actualizando manualmente: ${c}`),Array.from(t.classList).forEach(w=>{w.startsWith("estado-")&&t.classList.remove(w)}),t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.style.setProperty("--bg-estado","#e3e4FA");const E=t.querySelector('[id^="contenedor-svg-"]');if(E){const w=E.querySelector("svg");w&&(w.style.background="#e3e4FA")}const f=t.querySelector(".etiqueta-card")||t;f&&(f.style.background="#e3e4FA");const M=t.querySelector(".paquete-codigo");M?(M.textContent=`(${e})`,M.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${e})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),t.querySelectorAll(".btn-fabricar").forEach(w=>{w.disabled=!0,w.style.opacity="0.5",w.style.cursor="not-allowed"}),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${c} actualizada manualmente`)}function m(){if(l)return;l=!0;const c=document.getElementById("qrItem");c&&(c.addEventListener("change",()=>c.dispatchEvent(new Event("input"))),c.addEventListener("input",async function(){const a=this.value.trim();if(a)try{const t=await i(a);if(!t.valida){await Swal.fire("Etiqueta no v√°lida",t.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}h(a,t)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(t){console.error("Error de validaci√≥n:",t),await Swal.fire("Error",t.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const e=document.getElementById("crearPaqueteBtn");e&&e.addEventListener("click",s),document.addEventListener("focus",function(a){a.target.id&&a.target.id.startsWith("input-etiqueta-")&&(r=a.target,console.log("üéØ Focus en input:",a.target.id))},!0),document.addEventListener("click",async function(a){var t;if(a.target.classList.contains("btn-agregar-carro")||a.target.closest(".btn-agregar-carro")){const E=(a.target.classList.contains("btn-agregar-carro")?a.target:a.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!E){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const f=document.querySelector(`[x-show="tabActivo === 'crear'"]`),M=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(f&&window.getComputedStyle(f).display,M&&window.getComputedStyle(M).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let w=document.activeElement;(!w||!((t=w.id)!=null&&t.startsWith("input-etiqueta-")))&&(w=r),(!w||!document.body.contains(w))&&(w=document.querySelector('input[id^="input-etiqueta-"]')),w?(w.value=E,w.focus(),w.classList.add("ring-4","ring-green-400"),setTimeout(()=>{w.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${E} a√±adida al input:`,w.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",E);try{const w=await i(E);if(!w.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:w.motivo||"Motivo no especificado"});return}h(E,w)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(w){console.error("Error al a√±adir al carro:",w),await Swal.fire({icon:"error",title:"Error",text:w.message||"No se pudo a√±adir al carro"})}}if(a.target.classList.contains("btn-agregar-carro-grupo")||a.target.closest(".btn-agregar-carro-grupo")){const y=a.target.classList.contains("btn-agregar-carro-grupo")?a.target:a.target.closest(".btn-agregar-carro-grupo"),E=y.dataset.grupoId;let f=[];try{f=JSON.parse(y.dataset.etiquetas||"[]")}catch(v){console.error("Error parseando etiquetas del grupo:",v);return}if(!f.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${f.length} etiquetas del grupo ${E} al carro`);let M=0,_=0,w=0,S=[];for(const v of f)try{const T=await i(v.id);if(!T.valida){w++,T.motivo&&!S.includes(T.motivo)&&S.push(T.motivo);continue}h(v.id,T)?M++:_++}catch(T){w++,console.error("Error validando etiqueta:",v.id,T)}if(M>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${M}</strong> etiquetas al carro.</p>
                            ${_>0?`<p class="text-gray-500">${_} ya estaban en el carro.</p>`:""}
                            ${w>0?`<p class="text-red-500">${w} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(_>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const v=S.length>0?`<ul class="text-left mt-2 text-sm">${S.map(T=>`<li>‚Ä¢ ${T}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${v}
                        `})}}})}q.TrabajoPaquete={inicializar:m,agregarItemEtiqueta:h,eliminarItem:g,limpiarCarro:x,obtenerItems:b,calcularPesoTotal:p,crearPaquete:s,validarEtiqueta:i,actualizarListaVisual:o},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m(),document.addEventListener("livewire:navigated",m)})(window);function Ot(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(d,l){const r=document.getElementById("grid-maquina");if(!r)return;console.log("üîß Actualizando clases:",{showLeft:d,showRight:l,clasesAnteriores:r.className}),d||l?r.classList.add("columnas-laterales-visibles"):r.classList.remove("columnas-laterales-visibles"),d&&l?r.classList.add("ambas-columnas"):r.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",r.className),r.offsetHeight,r.querySelectorAll(".etiqueta-card").forEach(h=>{h.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const d=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(d,l)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const d=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(d,l)});function q(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((h,g)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),g.disconnect();const p=JSON.parse(localStorage.getItem("showLeft")??"true"),b=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(p,b)}}).observe(document.body,{childList:!0,subtree:!0});return}const l=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,r),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}q()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ot):Ot();document.addEventListener("livewire:navigated",Ot);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const q={debounceTime:500};let d=0;async function l(s){var m;const n=Date.now();if(n-d<q.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};d=n;const u=(m=document.querySelector('meta[name="csrf-token"]'))==null?void 0:m.getAttribute("content");if(!u)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${s}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const e=await fetch(`/etiquetas/${encodeURIComponent(s)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u}}),a=await e.json();return!e.ok||!a.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:a.message||"No se pudo revertir el cambio."}),{success:!1,message:a.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${a.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${a.estado}</strong>
                    </p>
                    ${a.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),g(s,a),a)}catch(c){return console.error("Error al deshacer etiqueta:",c),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:c.message}}}async function r(s){try{const n=await fetch(`/etiquetas/${encodeURIComponent(s)}/puede-deshacer`,{headers:{Accept:"application/json"}});return n.ok?await n.json():{puede_deshacer:!1}}catch(n){return console.error("Error al verificar undo:",n),{puede_deshacer:!1}}}async function i(s){try{const n=await fetch(`/etiquetas/${encodeURIComponent(s)}/historial`,{headers:{Accept:"application/json"}});return n.ok?await n.json():{success:!1,historial:[]}}catch(n){return console.error("Error al obtener historial:",n),{success:!1,historial:[]}}}async function h(s){var m;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const n=await i(s);if(!n.success||!((m=n.historial)!=null&&m.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const u=n.historial.map((c,e)=>`
            <tr class="${c.revertido?"bg-gray-100 text-gray-400":e===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${c.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${c.accion}</td>
                <td class="px-2 py-1 text-xs">${c.estado_anterior||"-"} ‚Üí ${c.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${c.revertido?'<span class="text-gray-400">Revertido</span>':e===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${s}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${u}</tbody>
                    </table>
                </div>
                ${n.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${n.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:n.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:n.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:n.puede_deshacer?"#f59e0b":"#6b7280"}).then(c=>{c.isConfirmed&&n.puede_deshacer&&l(s)})}function g(s,n){const u=s.replace(/\./g,"-"),m=document.getElementById(`etiqueta-${u}`);if(m){m.dataset.estado=n.estado,m.className=m.className.split(" ").filter(a=>!a.startsWith("estado-")).join(" ").trim(),m.classList.add(`estado-${n.estado}`);const c=m.querySelector('[id^="contenedor-svg-"]'),e=c==null?void 0:c.querySelector("svg");e&&(e.style.background=getComputedStyle(m).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(s,n.estado)}if(n.estado==="pendiente"){if(window.elementosAgrupadosScript){const a=window.elementosAgrupadosScript.find(t=>t.etiqueta&&String(t.etiqueta.etiqueta_sub_id)===String(s));a&&(a.colada_etiqueta=null,a.colada_etiqueta_2=null,a.elementos&&a.elementos.forEach(t=>{t.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:s}})))}const c=document.getElementById(`colada-${u}`);c&&(c.textContent="")}console.log(`‚úÖ DOM actualizado para ${s}: estado = ${n.estado}`)}function x(s,n){const u=s.replace(/\./g,"-"),m=document.querySelector(`#etiqueta-${u} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${s}, puede=${n}, btn encontrado=${!!m}`),m&&(m.disabled=!1,m.classList.remove("opacity-50","cursor-not-allowed"),m.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function p(){document.addEventListener("click",async s=>{const n=s.target.closest(".btn-deshacer");if(!n)return;s.preventDefault(),s.stopPropagation();const u=n.dataset.etiquetaId;if(!u){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await l(u)}),document.addEventListener("click",async s=>{const n=s.target.closest(".btn-historial");if(!n)return;s.preventDefault(),s.stopPropagation();const u=n.dataset.etiquetaId;u&&await h(u)}),console.log("‚úÖ Event listeners de historial inicializados")}function b(){let s=null;window.addEventListener("etiqueta-fabricada",n=>{var u;(u=n.detail)!=null&&u.etiquetaSubId&&(s=n.detail.etiquetaSubId)}),document.addEventListener("keydown",async n=>{var u,m;if(n.ctrlKey&&n.key==="z"&&!n.shiftKey){if(["INPUT","TEXTAREA"].includes((u=document.activeElement)==null?void 0:u.tagName))return;const c=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),e=((m=c==null?void 0:c.dataset)==null?void 0:m.etiquetaId)||s;e&&(n.preventDefault(),await l(e))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function o(){p(),b(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:l,puedeDeshacer:r,obtenerHistorial:i,mostrarHistorial:h,actualizarBoton:x},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o(),document.addEventListener("livewire:navigated",o)})();
