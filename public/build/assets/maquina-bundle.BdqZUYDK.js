const jt="rgba(0, 0, 0, 0.8)",Lt="rgba(0, 0, 0, 1)",Rt="rgba(0, 0, 0, 1)";function Xt(x,i){return!i||i===1?x.map(s=>({...s})):x.map(s=>s.type==="line"?{...s,length:(s.length||0)*i}:s.type==="arc"?{...s,radius:(s.radius||0)*i}:{...s})}const Ht=.75,$t=14,Vt=60,Nt=[0,10,-10,20,-20,30,-30];function G(x){return x*Math.PI/180}function Ut(x){const i=x.closest(".proceso");return i&&getComputedStyle(i).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Yt(x,i,s){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");return a.setAttribute("viewBox","0 0 "+x+" "+i),a.setAttribute("preserveAspectRatio","xMidYMid meet"),a.style.width="100%",a.style.height="100%",a.style.display="block",a.style.background=s||"#ffffff",a.style.shapeRendering="geometricPrecision",a.style.textRendering="optimizeLegibility",a.style.boxSizing="border-box",a}function Wt(x,i,s,a){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",i),n.setAttribute("stroke",s),n.setAttribute("fill","none"),n.setAttribute("stroke-width",a),n.setAttribute("vector-effect","non-scaling-stroke"),x.appendChild(n),n}function Ot(x){let i="",s=Number(x)||0;for(;s>=0;){const a=s%26;i=String.fromCharCode(65+a)+i,s=Math.floor(s/26)-1}return i}const Jt=0,Kt=-25;function Qt(x,i,s,a){if(!i||!i.length)return;const n=2,g=12,p=g+n,w=i.map(f=>(f.letter?f.letter+" ":"")+(f.text||"")),t=g*w.length+n*(w.length-1),c=Jt;let h=a-Kt-t+g/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let f=0;f<w.length;f++){const o=w[f],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",c),d.setAttribute("y",h),d.setAttribute("fill",Rt),d.setAttribute("font-size",g),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=o,x.appendChild(d);const l=qt(o,g).w;window.__legendBoxesGroup.push({left:c,right:c+l,top:h-g/2,bottom:h+g/2}),h+=p}}function Zt(x){const i=(x||"").split(/\s+/).filter(Boolean),s=[];for(let a=0;a<i.length;a++){const n=i[a];if(n.endsWith("r")){const g=parseFloat(n.slice(0,-1));let p=360;a+1<i.length&&i[a+1].endsWith("d")&&(p=parseFloat(i[++a].slice(0,-1))),s.push({type:"arc",radius:g,arcAngle:p})}else n.endsWith("d")?s.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):s.push({type:"line",length:parseFloat(n)})}return s}function te(x){let i=[],s=0,a=0,n=0;i.push({x:s,y:a});for(let g=0;g<x.length;g++){const p=x[g];if(p.type==="line")s+=p.length*Math.cos(G(n)),a+=p.length*Math.sin(G(n)),i.push({x:s,y:a});else if(p.type==="turn")n+=p.angle;else if(p.type==="arc"){const w=s+p.radius*Math.cos(G(n+90)),t=a+p.radius*Math.sin(G(n+90)),c=Math.atan2(a-t,s-w),h=c+G(p.arcAngle);s=w+p.radius*Math.cos(h),a=t+p.radius*Math.sin(h),n+=p.arcAngle,i.push({x:s,y:a})}}return i}function Ft(x){let i=[],s=0,a=0,n=0;for(let g=0;g<x.length;g++){const p=x[g];if(p.type==="line"){const w={x:s,y:a},t={x:s+p.length*Math.cos(G(n)),y:a+p.length*Math.sin(G(n))};i.push({start:w,end:t,length:p.length}),s=t.x,a=t.y}else if(p.type==="turn")n+=p.angle;else if(p.type==="arc"){const w=s+p.radius*Math.cos(G(n+90)),t=a+p.radius*Math.sin(G(n+90)),c=Math.atan2(a-t,s-w),h=c+G(p.arcAngle);s=w+p.radius*Math.cos(h),a=t+p.radius*Math.sin(h),n+=p.arcAngle}}return i}function qt(x,i){const s=i||12;return{w:(x?x.length:0)*s*.55,h:s}}function ot(x,i,s){const a=s||0;return!(x.right+a<i.left||x.left-a>i.right||x.bottom+a<i.top||x.top-a>i.bottom)}function Bt(x,i,s,a){const n=i/2;return Math.max(s+n,Math.min(a-n,x))}function ee(x,i){const a=[];let n=0;function g(){n>1e-9&&(a.push({type:"line",length:n}),n=0)}for(let p=0;p<x.length;p++){const w=x[p];if(w.type==="line"){n+=w.length;continue}if(w.type==="turn"){if(Math.abs(w.angle)<1e-9)continue;g(),a.push(w);continue}if(w.type==="arc"){g(),a.push(w);continue}g(),a.push(w)}return g(),a}function zt(x,i){const s=i&&i.decimals||0,a=i&&i.step||null;let n=Number(x||0);return a&&a>0&&(n=Math.round(n/a)*a),n.toFixed(s).replace(/\.0+$/,"")}function oe(x,i){const s=Math.hypot(x,i)||1;let a=x/s,n=i/s;return(n<-1e-9||Math.abs(n)<=1e-9&&a<0)&&(a=-a,n=-n),{ux:a,uy:n}}function Gt(x,i,s){const a=s||.01,n=oe(x,i),g=Math.round(n.ux/a)*a,p=Math.round(n.uy/a)*a;return g+"|"+p}function ae(x,i,s){const a=s&&s.dirPrecision||.01,n=s&&s.labelFormat||{decimals:0,step:null},g=x.reduce((d,l)=>d+Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y),0),p=i.reduce((d,l)=>d+(l.length||Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y)),0),w=p>0?g/p:1,t=new Map;for(let d=0;d<i.length;d++){const l=i[d],u=l.end.x-l.start.x,m=l.end.y-l.start.y,r=Gt(u,m,a),e=t.get(r)||[];e.push({length:l.length||Math.hypot(u,m),index:d}),t.set(r,e)}const c=i.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),h=new Set,f=new Set,o=[];for(let d=0;d<x.length;d++){const l=x[d],u=l.end.x-l.start.x,m=l.end.y-l.start.y,r=Gt(u,m,a),e=t.get(r)||[],E=Math.hypot(u,m);let y=E;if(e.length){const M=E/w;let b=null,q=1/0;for(const $ of e){const D=Math.abs($.length-M),S=f.has($.index)?.1:0;D+S<q&&(b=$,q=D+S)}b&&(y=b.length,f.add(b.index))}else d<c.length&&(y=c[d]);const A=zt(y,n),v=r+"|"+A;h.has(v)||(h.add(v),o.push({start:l.start,end:l.end,_dirKey:r,_label:A,_lenChosen:y}))}return o}function ne(x,i){const s=i,a=x.map(m=>Object.assign({},m));let n=0,g=0,p=0;const w=[];let t=null,c=-1,h=-1;const f=1e-7;function o(m){return m*Math.PI/180}function d(m){return Math.abs(Math.sin(o(m)))<1e-12}function l(m,r,e,E){return Math.min(r,E)-Math.max(m,e)>f}for(let m=0;m<a.length;m++){let e=function(){const M={x:Math.cos(o(p)),y:Math.sin(o(p))},b=n+a[m].length*M.x,q=g+a[m].length*M.y,$=d(p);for(let D=0;D<w.length;D++){const S=w[D];if($&&S.horiz&&Math.abs(g-S.y)<f){if(l(Math.min(n,b),Math.max(n,b),Math.min(S.x1,S.x2),Math.max(S.x1,S.x2))&&t&&c>=0&&h>=0)return a[h].length+=s,n+=t.x*s,g+=t.y*s,w[c].x2+=t.x*s,w[c].y2+=t.y*s,!0}else if(!$&&!S.horiz&&Math.abs(n-S.x)<f&&l(Math.min(g,q),Math.max(g,q),Math.min(S.y1,S.y2),Math.max(S.y1,S.y2))&&t&&c>=0&&h>=0)return a[h].length+=s,n+=t.x*s,g+=t.y*s,w[c].x2+=t.x*s,w[c].y2+=t.y*s,!0}return!1};var u=e;const r=a[m];if(r.type==="turn"){p+=r.angle;continue}if(r.type==="arc"){const M=n+r.radius*Math.cos(o(p+90)),b=g+r.radius*Math.sin(o(p+90)),q=Math.atan2(g-b,n-M),$=q+o(r.arcAngle);n=M+r.radius*Math.cos($),g=b+r.radius*Math.sin($),p+=r.arcAngle,t=null;continue}for(;e(););const E={x:Math.cos(o(p)),y:Math.sin(o(p))},y=n+a[m].length*E.x,A=g+a[m].length*E.y,v=d(p);w.push({x1:n,y1:g,x2:y,y2:A,horiz:v,y:g,x:n}),t=E,c=w.length-1,h=m,n=y,g=A}return a}function Et(x,i,s,a){const n=G(a),g=Math.cos(n),p=Math.sin(n),w=x.x-i,t=x.y-s;return{x:i+w*g-t*p,y:s+w*p+t*g}}function se(x,i,s,a,n,g,p,w,t){let c="",h=0,f=0,o=0,d=!1;function l(m,r){const e=Et({x:m,y:r},i,s,a);return{x:w+(e.x-g)*n,y:t+(e.y-p)*n}}function u(){if(!d){const m=l(h,f);c+="M "+m.x+" "+m.y,d=!0}}for(let m=0;m<x.length;m++){const r=x[m];if(r.type==="turn"){o+=r.angle;continue}if(r.type==="line"){const e=h+r.length*Math.cos(G(o)),E=f+r.length*Math.sin(G(o));u();const y=l(e,E);c+=" L "+y.x+" "+y.y,h=e,f=E;continue}if(r.type==="arc"){const e=h+r.radius*Math.cos(G(o+90)),E=f+r.radius*Math.sin(G(o+90)),y=Math.atan2(f-E,h-e),A=y+G(r.arcAngle),v=e+r.radius*Math.cos(A),M=E+r.radius*Math.sin(A),b=Math.abs(r.arcAngle)%360;if(u(),b<1e-6||Math.abs(r.arcAngle)>=359.9){const Q=y+Math.sign(r.arcAngle)*Math.PI,V=e+r.radius*Math.cos(Q),O=E+r.radius*Math.sin(Q),k=l(V,O),P=l(h,f),B=r.radius*n,I=r.arcAngle>=0?1:0;c+=" A "+B+" "+B+" 0 1 "+I+" "+k.x+" "+k.y,c+=" A "+B+" "+B+" 0 1 "+I+" "+P.x+" "+P.y,o+=r.arcAngle;continue}const q=l(v,M),$=r.radius*n,D=b>180?1:0,S=r.arcAngle>=0?1:0;c+=" A "+$+" "+$+" 0 "+D+" "+S+" "+q.x+" "+q.y,h=v,f=M,o+=r.arcAngle}}return c||"M 0 0"}function ie(x){const i=te(x);let s=Math.min(...i.map(u=>u.x)),a=Math.max(...i.map(u=>u.x)),n=Math.min(...i.map(u=>u.y)),g=Math.max(...i.map(u=>u.y));const p=(s+a)/2,w=(n+g)/2,c=g-n>a-s?-90:0,h=i.map(u=>Et(u,p,w,c));s=Math.min(...h.map(u=>u.x)),a=Math.max(...h.map(u=>u.x)),n=Math.min(...h.map(u=>u.y)),g=Math.max(...h.map(u=>u.y));const f=Math.max(1,a-s),o=Math.max(1,g-n),d=(s+a)/2,l=(n+g)/2;return{rotDeg:c,w:f,h:o,cxModel:p,cyModel:w,midX:d,midY:l,ptsRot:h}}function re(x){const i=[];let s=0,a=0,n=0;function g(p){const w=G(p);return{x:Math.cos(w),y:Math.sin(w)}}for(let p=0;p<x.length;p++){const w=x[p];if(w.type==="line")s+=w.length*Math.cos(G(n)),a+=w.length*Math.sin(G(n));else if(w.type==="turn"){const t=g(n),c=w.angle;n+=c;const h=g(n);i.push({x:s,y:a,angleDeg:c,prevDir:t,nextDir:h})}else if(w.type==="arc"){const t=s+w.radius*Math.cos(G(n+90)),c=a+w.radius*Math.sin(G(n+90)),h=Math.atan2(a-c,s-t),f=h+G(w.arcAngle);s=t+w.radius*Math.cos(f),a=c+w.radius*Math.sin(f),n+=w.arcAngle}}return i}function ce(x,i,s){const a=Array.from({length:i},()=>({sumH:0,maxW:0,items:[]})),n=[...x.keys()].sort((g,p)=>x[p].h-x[g].h);for(const g of n){let p=0,w=1/0;for(let c=0;c<i;c++){const h=a[c],f=h.sumH+(h.items.length>0?s:0)+x[g].h;f<w&&(w=f,p=c)}const t=a[p];t.sumH=t.items.length>0?t.sumH+s+x[g].h:t.sumH+x[g].h,t.maxW=Math.max(t.maxW,x[g].w),t.items.push(g)}return a}function le(x,i,s,a={}){const n=a.padding??12,g=a.gapCol??12,p=a.gapRow??10,w=Math.max(1,Math.min(x.length,a.kMax??4)),t=Math.max(10,i-2*n),c=Math.max(10,s-2*n),h=f(x);function f(e){const E=e.map(B=>B.w/Math.max(B.h,1)),y=e.map(B=>B.h),A=e.map(B=>B.w),v=e.map(B=>B.w*B.h),M=B=>B.reduce((I,nt)=>I+nt,0)/B.length,b=(B,I)=>B.reduce((nt,L)=>nt+Math.pow(L-I,2),0)/B.length,q=(B,I)=>Math.sqrt(b(B,I)),$=M(E),D=M(y),S=M(A),Q=v.reduce((B,I)=>B+I,0),V=q(y,D),O=q(A,S),k=D>0?V/D:0,P=S>0?O/S:0;return{avgAspectRatio:$,avgHeight:D,avgWidth:S,totalArea:Q,heightCV:k,widthCV:P,isLinear:$>6||D<S*.12,isUniformHeight:k<.15,isUniformWidth:P<.15,isHighlyVariable:k>.5||P>.5,count:e.length}}let o={S:0,k:1,cols:null,score:0};for(let e=1;e<=w;e++){const E=ce(x,e,p),y=E.reduce((L,Z)=>L+Z.maxW,0)+g*(e-1),A=Math.max(...E.map(L=>L.sumH));if(y<=0||A<=0)continue;const v=t/y,M=c/A,b=Math.min(v,M),q=Math.max(.01,b*.92),$=h.totalArea*q*q,D=t*c,S=$/D,Q=E.map(L=>L.sumH*q),V=Q.reduce((L,Z)=>L+Z,0)/e,O=Math.max(...Q)-Math.min(...Q),k=V>0?1-O/V:1,P=e===1?1.1:e===2?.9:.7,B=e>h.count*.5?.7:1,I=k>.85?1.05:1,nt=q*(1+S*.25)*(1+k*.1)*P*B*I;nt>o.score&&(o={S:q,k:e,cols:E,score:nt,efficiency:S,colBalance:k})}const d=o.cols.map(e=>e.maxW*o.S),l=d.reduce((e,E)=>e+E,0);let u=[];if(o.k===1)u[0]=i/2;else{const e=(o.k-1)*g,E=l+e;if(E<t){const y=t-E,A=g+y/(o.k-1);let v=n;for(let M=0;M<o.k;M++)u[M]=v+d[M]/2,v+=d[M]+A}else{let y=n+Math.max(0,(t-E)/2);for(let A=0;A<o.k;A++)u[A]=y+d[A]/2,y+=d[A]+g}}const m=[],r=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(e=>e.right));for(let e=0;e<o.k;e++){const E=o.cols[e];m[e]=[];const y=E.items.map(O=>x[O].h*o.S),A=y.reduce((O,k)=>O+k,0);if(E.items.length===0)continue;const v=u[e],M=o.cols[e].maxW*o.S,b=v-M/2,q=v+M/2,$=r(),S=Math.max(0,Math.min(q,$)-b)/M,Q=S>.05;let V=c;if(Q&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const k=Math.min(...window.__legendBoxesGroup.map(P=>P.top))-15;V=Math.max(10,k-n),console.log(`üìè Columna ${e}: X=${b.toFixed(0)}-${q.toFixed(0)}, legendWidth=${$.toFixed(0)}, solape=${(S*100).toFixed(0)}%, altura reducida a ${V.toFixed(0)}px`)}else console.log(`üìè Columna ${e}: X=${b.toFixed(0)}-${q.toFixed(0)}, legendWidth=${$.toFixed(0)}, solape=${(S*100).toFixed(0)}%, altura completa ${V.toFixed(0)}px`);if(E.items.length===1){const O=y[0],k=n+V/2,P=Math.max(n+O/2,Math.min(k,s-n-O/2));m[e].push(P);continue}if(A>V){console.warn(`Columna ${e}: elementos no caben (${A}px > ${V}px)`);const P=A/E.items.length<4?20:5;let B=n;for(let I=0;I<E.items.length;I++){const nt=Math.max(y[I],2),L=B+nt/2;m[e].push(L),B+=nt+P}}else{const O=V-A,k=E.items.length-1;let P=O/k;A/E.items.length<4?P=Math.max(18,Math.min(P,50)):P=Math.max(5,P);const nt=A+k*P,L=V-nt;let Z=n+Math.max(0,L/2);for(let lt=0;lt<E.items.length;lt++){const C=Math.max(y[lt],2),H=Z+C/2,N=n+V-C/2,_=Math.max(n+C/2,Math.min(H,N));m[e].push(_),Z+=C+P}}}return{S:o.S,k:o.k,cols:o.cols,centersX:u,centersYByCol:m,padding:n,gapRow:p,gapCol:g}}window.renderizarGrupoSVG=function(i,s){const a=i&&i.etiqueta&&i.etiqueta.id!=null?i.etiqueta.id:i&&i.id!=null?i.id:s,n=document.getElementById("contenedor-svg-"+a);if(!n)return;const g=600,p=150,w=Ut(n),t=Yt(g,p,w);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const c=(i.elementos||[]).map((l,u)=>{var y,A,v;const m=l.barras!=null?l.barras:0;let r="N/A";if(l.diametro!=null&&l.diametro!==""){const b=String(l.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(b){const q=parseFloat(b[0]);isFinite(q)&&(r=String(Math.round(q)))}}const e=[];(y=l.coladas)!=null&&y.colada1&&e.push(l.coladas.colada1),(A=l.coladas)!=null&&A.colada2&&e.push(l.coladas.colada2),(v=l.coladas)!=null&&v.colada3&&e.push(l.coladas.colada3);const E=e.length>0?` (${e.join(", ")})`:"";return{letter:Ot(u),text:`√ò${r} x${m}${E}`}});Qt(t,c,g,p);const h=i.elementos.map(l=>{const u=Zt(l.dimensiones||""),m=ee(u);let r=0;for(const v of m)v.type==="line"&&(r=Math.max(r,Math.abs(v.length||0))),v.type==="arc"&&(r=Math.max(r,Math.abs(v.radius||0)));const E=r<=50?2:1,y=Xt(m,E),A=ie(y);return{dimsRaw:u,dimsNoZero:m,dimsScaled:y,geomScale:E,medida:A}}),f=h.map(l=>l.medida),o=le(f,g,p,{padding:20,gapCol:50,gapRow:22,kMax:3}),d=new Map;for(let l=0;l<o.k;l++)o.cols[l].items.forEach((u,m)=>d.set(u,{c:l,j:m}));i.elementos.forEach(function(l,u){const{dimsNoZero:m,dimsScaled:r,medida:e}=h[u],E=d.get(u),y=o.centersX[E.c],A=o.centersYByCol[E.c][E.j],v=o.S,M=e.ptsRot.map(L=>({x:y+(L.x-e.midX)*v,y:A+(L.y-e.midY)*v})),b=Math.min(...M.map(L=>L.x)),q=Math.max(...M.map(L=>L.x)),$=Math.min(...M.map(L=>L.y)),D=Math.max(...M.map(L=>L.y)),S={left:b,right:q,top:$,bottom:D};window.__figBoxesGroup.push({...S});const Q=ne(r,.6),V=se(Q,e.cxModel,e.cyModel,e.rotDeg,v,e.midX,e.midY,y,A),O=Wt(t,V,jt,2);(function(){const Z=re(r);function lt(_){return Math.abs(Math.abs(_)-90)>=Ht}const C=(_,T)=>Et({x:_.x,y:_.y},0,0,T),H=(_,T)=>{const U=Et({x:_,y:T},e.cxModel,e.cyModel,e.rotDeg);return{x:y+(U.x-e.midX)*v,y:A+(U.y-e.midY)*v}},N=_=>Math.max(10,Math.min(28,_));Z.forEach(_=>{if(!lt(_.angleDeg))return;const T=H(_.x,_.y),U=C(_.prevDir,e.rotDeg),mt=C(_.nextDir,e.rotDeg),Y=Math.atan2(U.y,U.x),R=Y+G(_.angleDeg),W=Math.min(S.right-S.left,S.bottom-S.top);let F=N(.12*W);const ft=T.x+F*Math.cos(Y),pt=T.y+F*Math.sin(Y),X=T.x+F*Math.cos(R),ht=T.y+F*Math.sin(R),J=Math.abs(_.angleDeg),st=J>180?1:0,Mt=_.angleDeg>=0?1:0,it=document.createElementNS("http://www.w3.org/2000/svg","path");it.setAttribute("d",`M ${ft} ${pt} A ${F} ${F} 0 ${st} ${Mt} ${X} ${ht}`),it.setAttribute("stroke","rgba(255,99,71,0.7)"),it.setAttribute("stroke-width","2"),it.setAttribute("fill","none"),it.style.pointerEvents="none",t.appendChild(it);let z=U.x+mt.x,j=U.y+mt.y;J>180&&(z=-z,j=-j);let K=Math.hypot(z,j);if(K<1e-6){const ct=_.angleDeg>=0?1:-1;z=-U.y*ct,j=U.x*ct,K=Math.hypot(z,j)||1}z/=K,j/=K;const tt=(Math.round(_.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",et=qt(tt,14);function At(ct,dt){return{left:ct-et.w/2,right:ct+et.w/2,top:dt-et.h/2,bottom:dt+et.h/2}}let at=null;for(let ct=$t;ct<=Vt&&!at;ct+=4)for(let dt=0;dt<Nt.length&&!at;dt++){const wt=Nt[dt],yt=C({x:z,y:j},wt),bt=T.x+yt.x*(F+ct),ut=T.y+yt.y*(F+ct),gt=At(bt,ut);gt.top<0||gt.bottom>p||gt.left<0||gt.right>g||window.__figBoxesGroup.some(xt=>ot(xt,gt,6))||(window.__dimBoxesGroup||[]).some(xt=>ot(xt,gt,2))||(window.__angleBoxesGroup||[]).some(xt=>ot(xt,gt,2))||(window.__placedLetterBoxes||[]).some(xt=>ot(xt,gt,2))||(window.__legendBoxesGroup||[]).some(xt=>ot(xt,gt,6))||(at={x:bt,y:ut,box:gt})}if(!at){const ct=T.x+z*(F+$t),dt=T.y+j*(F+$t),wt=At(ct,dt);at={x:ct,y:dt,box:wt}}window.__angleBoxesGroup.push(at.box);const rt=document.createElementNS("http://www.w3.org/2000/svg","text");rt.setAttribute("x",at.x),rt.setAttribute("y",at.y),rt.setAttribute("fill",Lt),rt.setAttribute("font-size",14),rt.setAttribute("text-anchor","middle"),rt.setAttribute("alignment-baseline","middle"),rt.style.cursor="pointer",rt.textContent=tt,t.appendChild(rt),rt.addEventListener("mouseenter",()=>{it.setAttribute("stroke","rgba(255,69,0,1)"),it.setAttribute("stroke-width","3"),it.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),rt.addEventListener("mouseleave",()=>{it.setAttribute("stroke","rgba(255,99,71,0.7)"),it.setAttribute("stroke-width","2"),it.style.filter="none"})})})();const k=O.cloneNode(!1);k.setAttribute("stroke-width","50"),k.setAttribute("stroke","transparent"),k.setAttribute("fill","none"),k.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(L=>{k.addEventListener(L,Z=>O.dispatchEvent(new Z.constructor(Z.type,Z)))}),t.insertBefore(k,O),(l.codigo!=null?l.codigo:l.id)+"",O.style.cursor="pointer",O.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),O.addEventListener("click",function(L){if(L.ctrlKey||L.metaKey||L.shiftKey){L.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id);return}abrirModalDividirElemento(l.id,l.barras||0)}),O.addEventListener("contextmenu",function(L){L.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id)});const P=[],B=Ft(Q),I=Ft(m);ae(B,I,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(L){const Z=Et(L.start,e.cxModel,e.cyModel,e.rotDeg),lt=Et(L.end,e.cxModel,e.cyModel,e.rotDeg),C={x:y+(Z.x-e.midX)*v,y:A+(Z.y-e.midY)*v},H={x:y+(lt.x-e.midX)*v,y:A+(lt.y-e.midY)*v},N=L._label,_=H.x-C.x,T=H.y-C.y,U=Math.hypot(_,T)||1,mt=_/U,Y=T/U,R=T/U,W=-_/U,F=(C.x+H.x)/2,ft=(C.y+H.y)/2,pt=F+R*10,X=ft+W*10,ht=qt(N,14),J=ht.w,st=ht.h;function Mt(at,rt){return{left:at-J/2,right:at+J/2,top:rt-st/2,bottom:rt+st/2}}const it=U*.45;let z=pt,j=X;for(let at=0;at<=Math.ceil(it/6);at++){const rt=at%2===0?1:-1,ct=Math.ceil(at/2),dt=rt*ct*6;if(Math.abs(dt)>it)continue;const wt=pt+mt*dt,yt=X+Y*dt,bt=(wt-C.x)*mt+(yt-C.y)*Y;if(bt<0+J*.3||bt>U-J*.3)continue;const ut=Mt(wt,yt);if(!(ot({left:Math.min(C.x,H.x),right:Math.max(C.x,H.x),top:Math.min(C.y,H.y),bottom:Math.max(C.y,H.y)},ut,0)||(window.__angleBoxesGroup||[]).some(vt=>ot(vt,ut,2))||(window.__legendBoxesGroup||[]).some(vt=>ot(vt,ut,6))||P.some(vt=>ot(vt,ut,2))||ut.top<0||ut.bottom>p||ut.left<0||ut.right>g)){z=wt,j=yt,P.push(ut),window.__dimBoxesGroup.push(ut);break}}const K=document.createElementNS("http://www.w3.org/2000/svg","line");K.setAttribute("x1",C.x),K.setAttribute("y1",C.y),K.setAttribute("x2",H.x),K.setAttribute("y2",H.y),K.setAttribute("stroke","rgba(0,0,255,0.6)"),K.setAttribute("stroke-width","4"),K.setAttribute("stroke-linecap","round"),K.setAttribute("vector-effect","non-scaling-stroke"),K.style.opacity=0,K.style.pointerEvents="none",K.style.transition="opacity 120ms ease",t.appendChild(K);const tt=document.createElementNS("http://www.w3.org/2000/svg","text");tt.setAttribute("x",z),tt.setAttribute("y",j),tt.setAttribute("fill",Lt),tt.setAttribute("font-size",14),tt.setAttribute("text-anchor","middle"),tt.setAttribute("alignment-baseline","middle"),tt.setAttribute("tabindex","0"),tt.style.cursor="pointer",tt.textContent=N,t.appendChild(tt);function et(){K.style.opacity=1}function At(){K.style.opacity=0}tt.addEventListener("mouseenter",et),tt.addEventListener("mouseleave",At),tt.addEventListener("focus",et),tt.addEventListener("blur",At)}),function(){const Z=[];let lt=0,C=0,H=0;for(let N=0;N<r.length;N++){const _=r[N];if(_.type==="line")lt+=_.length*Math.cos(G(H)),C+=_.length*Math.sin(G(H));else if(_.type==="turn")H+=_.angle;else if(_.type==="arc"){const T=lt+_.radius*Math.cos(G(H+90)),U=C+_.radius*Math.sin(G(H+90)),mt=Math.atan2(C-U,lt-T),Y=mt+G(_.arcAngle);let R=_.radius;for(let W=0;W<m.length;W++){const F=m[W];if(F.type==="arc"&&Math.abs(F.arcAngle-_.arcAngle)<.01){R=F.radius;break}}Z.push({center:{x:T,y:U},radius:_.radius,originalRadius:R,arcAngle:_.arcAngle,startAngle:mt,endAngle:Y}),lt=T+_.radius*Math.cos(Y),C=U+_.radius*Math.sin(Y),H+=_.arcAngle}}Z.forEach(function(N){const _=Et(N.center,e.cxModel,e.cyModel,e.rotDeg),T={x:y+(_.x-e.midX)*v,y:A+(_.y-e.midY)*v},U=(N.startAngle+N.endAngle)/2,mt=N.radius*v,Y="R"+zt(N.originalRadius,{decimals:0,step:null}),R=qt(Y,14),W=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let F=!1,ft,pt,X;for(let et=0;et<W.length&&!F;et++){const At=W[et],at=U+G(At),rt={x:N.center.x+N.radius*Math.cos(at),y:N.center.y+N.radius*Math.sin(at)},ct=Et(rt,e.cxModel,e.cyModel,e.rotDeg),dt={x:y+(ct.x-e.midX)*v,y:A+(ct.y-e.midY)*v},wt=dt.x-T.x,yt=dt.y-T.y,bt=Math.hypot(wt,yt)||1,ut=wt/bt,gt=yt/bt;for(let St=8;St<=60&&!F;St+=6){const Ct=mt*.7;if(ft=T.x+ut*Ct+ut*St,pt=T.y+gt*Ct+gt*St,X={left:ft-R.w/2,right:ft+R.w/2,top:pt-R.h/2,bottom:pt+R.h/2},!(X.top<0||X.bottom>p||X.left<0||X.right>g||window.__figBoxesGroup.some(_t=>ot(_t,X,2))||(window.__legendBoxesGroup||[]).some(_t=>ot(_t,X,2)))){F=!0;break}}}if(!F)return;P.push(X);const ht={x:ft-T.x,y:pt-T.y},J=Math.hypot(ht.x,ht.y)||1,st={x:ht.x/J,y:ht.y/J},Mt=T.x+st.x*mt*.6,it=T.y+st.y*mt*.6,z=document.createElementNS("http://www.w3.org/2000/svg","line");z.setAttribute("x1",T.x),z.setAttribute("y1",T.y),z.setAttribute("x2",Mt),z.setAttribute("y2",it),z.setAttribute("stroke","rgba(0,128,0,0.6)"),z.setAttribute("stroke-width","4"),z.setAttribute("stroke-linecap","round"),z.setAttribute("vector-effect","non-scaling-stroke"),z.style.opacity=0,z.style.pointerEvents="none",z.style.transition="opacity 120ms ease",t.appendChild(z);const j=document.createElementNS("http://www.w3.org/2000/svg","text");j.setAttribute("x",ft),j.setAttribute("y",pt),j.setAttribute("fill",Lt),j.setAttribute("font-size",14),j.setAttribute("text-anchor","middle"),j.setAttribute("alignment-baseline","middle"),j.setAttribute("tabindex","0"),j.style.cursor="pointer",j.textContent=Y,t.appendChild(j);function K(){z.style.opacity=1}function tt(){z.style.opacity=0}j.addEventListener("mouseenter",K),j.addEventListener("mouseleave",tt),j.addEventListener("focus",K),j.addEventListener("blur",tt)})}(),function(){const Z=Ot(u),lt=14,C=qt(Z,lt);function H(R,W){return{left:R,right:R+C.w,top:W-C.h/2,bottom:W+C.h/2}}let N=null;const _=(S.top+S.bottom)/2,T=Math.max(C.h/2,Math.min(_,p-C.h/2));function U(R){for(let F=0;F<=30;F+=4){const ft=F%2===0?1:-1,pt=Math.ceil(F/2),X=ft*pt*4,ht=Math.max(C.h/2,Math.min(p-C.h/2,T+X)),J=R,st=H(J,ht);if(!(window.__figBoxesGroup.some(et=>ot(et,st,6))||(window.__dimBoxesGroup||[]).some(et=>ot(et,st,3))||(window.__angleBoxesGroup||[]).some(et=>ot(et,st,3))||(window.__legendBoxesGroup||[]).some(et=>ot(et,st,6))||(window.__placedLetterBoxes||[]).some(et=>ot(et,st,2))||st.top<0||st.bottom>p||st.left<0||st.right>g))return N={x:J,y:ht,box:st},!0}return!1}const mt=[{x:S.right+10,priority:1},{x:S.left-10-C.w,priority:1},{x:S.right+15,priority:2},{x:S.left-15-C.w,priority:2},{x:S.right+5,priority:2},{x:S.left-5-C.w,priority:2},{x:S.right+20,priority:3},{x:S.left-20-C.w,priority:3},{x:S.right+25,priority:3},{x:S.left-25-C.w,priority:3},{x:S.right+30,priority:3},{x:S.left-30-C.w,priority:3}];mt.sort((R,W)=>R.priority-W.priority);for(const R of mt){if(N)break;const W=Bt(R.x,C.w,0,g);if(U(W))break}if(!N){const R=(S.left+S.right)/2,W=[{x:R-C.w/2,y:S.top-C.h-5},{x:R-C.w/2,y:S.bottom+C.h+5}];for(const F of W){if(N)break;const ft=Bt(F.x,C.w,0,g),pt=Math.max(C.h/2,Math.min(p-C.h/2,F.y)),X=H(ft,pt);!window.__figBoxesGroup.some(J=>ot(J,X,6))&&!(window.__dimBoxesGroup||[]).some(J=>ot(J,X,3))&&!(window.__angleBoxesGroup||[]).some(J=>ot(J,X,3))&&!(window.__legendBoxesGroup||[]).some(J=>ot(J,X,6))&&!(window.__placedLetterBoxes||[]).some(J=>ot(J,X,2))&&X.top>=0&&X.bottom<=p&&X.left>=0&&X.right<=g&&(N={x:ft,y:pt,box:X})}}if(!N){const R=Bt(g-C.w,C.w,0,g),W=T;N={x:R,y:W,box:H(R,W)}}window.__placedLetterBoxes.push(N.box);const Y=document.createElementNS("http://www.w3.org/2000/svg","text");Y.setAttribute("x",N.x),Y.setAttribute("y",N.y),Y.setAttribute("fill",Rt),Y.setAttribute("font-size",lt),Y.setAttribute("text-anchor","start"),Y.setAttribute("alignment-baseline","middle"),Y.style.fontWeight="600",Y.style.pointerEvents="none",Y.textContent=Z,t.appendChild(Y)}()}),n.innerHTML="",n.appendChild(t)};function It(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const x=window.elementosAgrupadosScript;if(!x)return;const i=document.getElementById("grid-maquina");if(i&&window.updateGridClasses){const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}x.forEach(function(s,a){renderizarGrupoSVG(s,a)}),requestAnimationFrame(()=>{i&&(i.style.opacity="1",i.style.visibility="visible",i.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",i.className)),document.querySelectorAll(".proceso").forEach(s=>{s.style.opacity="1"})}),window.actualizarSVGConColadas=function(s,a){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,g=n.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(s));if(g===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${s}`);return}const p=n[g];p.elementos&&a&&p.elementos.forEach(w=>{const t=String(w.id),c=a[t];w.coladas||(w.coladas={colada1:null,colada2:null,colada3:null}),c&&Array.isArray(c)&&(w.coladas.colada1=c[0]||null,w.coladas.colada2=c[1]||null,w.coladas.colada3=c[2]||null)}),renderizarGrupoSVG(p,g),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${s}`,a)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It();document.addEventListener("livewire:navigated",It);window.abrirModalDividirElemento=function(i,s){const a=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),g=document.getElementById("dividir_barras_totales"),p=document.getElementById("labelBarrasActuales"),w=document.getElementById("barras_a_mover"),t=document.getElementById("previewDivision"),c=document.getElementById("formDividirElemento");if(!a||!n||!c)return;n.value=i;let h=parseInt(s)||0;if(h===0&&window.elementosAgrupadosScript){for(const f of window.elementosAgrupadosScript)if(f.elementos){const o=f.elementos.find(d=>String(d.id)===String(i));if(o&&o.barras){h=parseInt(o.barras)||0;break}}}g&&(g.value=h),p&&(p.textContent=h>0?h:"-"),w&&(w.value=""),t&&t.classList.add("hidden"),window.rutaDividirElemento&&c.setAttribute("action",window.rutaDividirElemento),a.classList.remove("hidden")};window.enviarDivision=async function(){const i=document.getElementById("formDividirElemento"),s=i.getAttribute("action")||window.rutaDividirElemento,a=new FormData(i);try{const n=document.querySelector('meta[name="csrf-token"]'),g=a.get("_token")||(n?n.getAttribute("content"):null),w=await fetch(s,{method:"POST",headers:g?{"X-CSRF-TOKEN":g}:{},body:a}),t=await w.json();if(!w.ok||!t.success)throw new Error(t.message||"Error al dividir");i.reset();const c=document.getElementById("modalDividirElemento");c&&c.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",t.message,"success"):alert(t.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(x){const i={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},s={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function a(t,c,h={}){console.log(`üîÑ Actualizando etiqueta ${t} a estado: ${c}`);const f=String(t).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${f}`);if(!o)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${t}`),!1;const d=String(c).toLowerCase().trim(),l=s[d];if(!l)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${c}`),!1;o.dataset.estado=d,Array.from(o.classList).forEach(e=>{e.startsWith("estado-")&&o.classList.remove(e)}),o.classList.add(l.cssClass),o.style.setProperty("--bg-estado",l.bgColor);const m=o.querySelector('[id^="contenedor-svg-"]');if(m){const e=m.querySelector("svg");e&&(e.style.background=l.bgColor)}const r=o.querySelector(".etiqueta-card")||o;return r&&(r.style.background=l.bgColor),n(o,d),g(o),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:t,estado:d,datosExtra:h}})),console.log(`‚úÖ Etiqueta ${t} actualizada a ${c}`),!0}function n(t,c){const h=t.querySelectorAll(".btn-fabricar"),f=["empaquetada","en-paquete"];h.forEach(o=>{f.includes(c)?(o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed",o.title=`Etiqueta ya ${c}`):(o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer",o.title="Fabricar esta etiqueta")})}function g(t){t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400)}function p(t,c,h={}){console.log(`üîÑ Actualizando ${t.length} etiquetas...`);const o=t.map(d=>a(d,c,h)).filter(d=>d).length;return console.log(`‚úÖ ${o}/${t.length} etiquetas actualizadas`),o}function w(t){const c=String(t).replace(/\./g,"-"),h=document.querySelector(`#etiqueta-${c}`);return h?{id:t,estado:h.dataset.estado||"desconocido",elemento:h}:null}window.addEventListener("paquete:creado",t=>{const{codigoPaquete:c,etiquetaIds:h}=t.detail;console.log(`üì¶ Evento paquete:creado recibido - ${c} con ${h.length} etiquetas`),p(h,"empaquetada",{codigo_paquete:c})}),x.SistemaDOM={actualizarEstadoEtiqueta:a,actualizarMultiplesEtiquetas:p,obtenerEstadoActual:w,ESTADOS_CONFIG:s},x.ColoresEstado={actualizar:(t,c)=>{i[t]=c;const h=document.getElementById("colores-estado-css");if(h){let f=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[o,d]of Object.entries(i))f+=`.proceso.estado-${o} {
    --bg-estado: ${d};
}
`;h.textContent=f,console.log(`‚úÖ Color actualizado para estado "${t}": ${c}`)}},obtenerColor:t=>i[t],todos:()=>({...i})}})(window);function Dt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async t=>{var m,r,e;const c=t.target.closest(".btn-fabricar");if(!c)return;t.preventDefault();const h=(r=(m=document.getElementById("maquina-info"))==null?void 0:m.dataset)==null?void 0:r.maquinaId;if(!h){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const f=String(c.dataset.etiquetaId||"").trim(),o=f.replace(/\./g,"-"),d=document.querySelector(`#etiqueta-${o}`);if(d){const E=(d.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(E)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${f} ya est√° en estado ${E}.`,timer:2500,showConfirmButton:!1});return}}const l=Number(((e=window.DIAMETRO_POR_ETIQUETA)==null?void 0:e[f])??0);if(!f){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!l&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const u=c.disabled;c.disabled=!0;try{await x(f,h,l)}finally{c.disabled=u}});async function x(t,c,h=null){var y,A,v,M;const f=`/actualizar-etiqueta/${t}/maquina/${c}`,o=(y=document.querySelector('meta[name="csrf-token"]'))==null?void 0:y.getAttribute("content"),d=t.replace(/\./g,"-"),u=(((v=(A=document.querySelector(`#etiqueta-${d}`))==null?void 0:A.dataset)==null?void 0:v.estado)||"").toLowerCase()==="fabricando",m=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",r=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",e=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(m&&r||e){if(u&&((M=window._decisionCortePorEtiqueta)!=null&&M[t])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:o,etiquetaId:t,onUpdate:s});return}for(;;){let b;try{b=await Cortes.mejorCorteSimple(t,h,o)}catch(q){w(q);return}if(!b)return;if(b.accion==="optimizar"){let q;try{q=await Cortes.mejorCorteOptimizado(t,h,b.patrones,o)}catch($){w($);return}if((q==null?void 0:q.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q.longitudBarraCm,etiquetas:q.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:o,etiquetaId:t,onUpdate:s});return}else{if(q==="volver")continue;return}}if(b.accion==="fabricar_patron_simple"){const q=Math.round(Number(b.longitud_m||0)*100);if(!q){w("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q,etiquetas:[{etiqueta_sub_id:t,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:o,etiquetaId:t,onUpdate:s});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await i(t,c,o)}catch(b){w(b)}return}try{const b=await fetch(f,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({})}),q=await b.json();if(!b.ok)throw new Error(q.message||"Error al actualizar");s(t,q)}catch(b){w(b)}}async function i(t,c,h){var V,O,k,P,B;const f=Number(((V=window.DIAMETRO_POR_ETIQUETA)==null?void 0:V[t])??0),d=Number(((O=window.LONGITUD_POR_ETIQUETA)==null?void 0:O[t])??0)/100;let l="";try{const I=await fetch(`/api/productos/sugerencias?diametro=${f}&longitud=${d}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":h}});if(I.ok){const nt=await I.json();nt.productos&&nt.productos.length>0?l=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${f}mm x ${d.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${nt.productos.map(L=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${L.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${L.codigo}</td>
                                                <td class="px-2 py-1">${L.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${L.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${L.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:l=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${f}mm x ${d.toFixed(1)}m</p>`}}catch(I){console.warn("No se pudieron cargar sugerencias:",I)}const{value:u,isConfirmed:m}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${l}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const I=document.getElementById("swal-input-producto").value;return!I||!I.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):I.trim()}});if(!m||!u)return;let r;try{const I=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(u.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":h}});if(!I.ok){const nt=await I.json();throw new Error(nt.message||"Producto no encontrado")}r=await I.json()}catch(I){await Swal.fire({icon:"error",title:"Producto no encontrado",text:I.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${u}`});return}const e=(r.tipo||"").toLowerCase(),E=Number(r.diametro??0),y=Number(r.longitud??0);if(e&&e!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${r.codigo}</p>
                        <p><strong>Tipo:</strong> ${r.tipo||"N/A"}</p>
                    </div>
                `});return}if(E>0&&f>0&&Math.abs(E-f)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${E} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${f} mm</p>
                    </div>
                `});return}if(y>0&&d>0&&Math.abs(y-d)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${y.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${d.toFixed(2)} m</p>
                    </div>
                `});return}const A=r.longitud?`${r.longitud} m`:"N/A",{value:v,isConfirmed:M}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${r.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${r.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${A}</p>
                    <p><strong>Stock actual:</strong> ${((k=r.peso_stock)==null?void 0:k.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${r.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!M)return;const b=v==="completo",q=`/actualizar-etiqueta/${t}/maquina/${c}`,$=await fetch(q,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":h},body:JSON.stringify({producto_id:r.id,paquete_completo:b})}),D=await $.json();if(!$.ok)throw new Error(D.message||"Error al fabricar");const S=((P=D.metricas)==null?void 0:P.peso_consumido)||0,Q=((B=D.metricas)==null?void 0:B.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${r.codigo}</p>
                <p><strong>Peso consumido:</strong> ${S.toFixed(2)} kg</p>
                ${Q?`<p><strong>Paquete:</strong> ${Q}</p>`:""}
                ${b?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),s(t,D),Q&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const I=document.getElementById("codigo_paquete_mover");I&&(I.value=Q,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function s(t,c){var f,o;const h=t.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:c.estado,peso_etiqueta:c.peso_etiqueta,nombre:c.nombre,data_completa:c}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,c.estado,{peso:c.peso_etiqueta,nombre:c.nombre||t}):a(t,c.estado),c.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,c.coladas_por_elemento),(c.estado||"").toLowerCase()){case"cortando":p("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":p("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),n(h);break;case"fabricando":p("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":p("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),n(h),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:c.peso_etiqueta||0,estado:"fabricada",nombre:c.nombre||t}),c.elementos&&Array.isArray(c.elementos)&&c.elementos.length>0?c.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,c.elementos),g(t,c.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":p("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(f=window._decisionCortePorEtiqueta)!=null&&f[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),n(h),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:c.peso_etiqueta||0,estado:"completada",nombre:c.nombre||t}),c.elementos&&Array.isArray(c.elementos)&&c.elementos.length>0?c.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,c.elementos),g(t,c.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":p("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":p("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),n(h);break;case"soldando":p("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":p("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),n(h);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${c.estado}`),p("warning","Estado desconocido",`El estado recibido (${c.estado}) no est√° reconocido.`,3e3)}(o=c.productos_afectados)!=null&&o.length&&c.productos_afectados.forEach(d=>{const l=document.getElementById(`peso-stock-${d.id}`),u=document.getElementById(`progreso-texto-${d.id}`),m=document.getElementById(`progreso-barra-${d.id}`);l&&(l.textContent=`${d.peso_stock} kg`),u&&(u.textContent=`${d.peso_stock} / ${d.peso_inicial} kg`),m&&(m.style.height=`${d.peso_stock/d.peso_inicial*100}%`)})}function a(t,c){const h=t.replace(/\./g,"-"),f=document.getElementById("etiqueta-"+h);if(!f)return;f.dataset.estado=String(c||"").toLowerCase(),f.className=f.className.split(" ").filter(l=>!l.startsWith("estado-")).join(" ").trim(),f.classList.add("estado-"+f.dataset.estado);const o=f.querySelector('[id^="contenedor-svg-"]'),d=o==null?void 0:o.querySelector("svg");d&&(d.style.background=getComputedStyle(f).getPropertyValue("--bg-estado").trim())}function n(t){const c=`#etiqueta-${CSS.escape(t)}`,h=document.querySelector(c),f=Array.from(document.querySelectorAll(".proceso")),o=E=>(E||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),d=E=>{var v;const y=(v=E.dataset)==null?void 0:v.estado;if(y)return o(y);const A=E.querySelector('[id^="estado-"]');return o((A==null?void 0:A.textContent)||(A==null?void 0:A.innerText)||"")},l=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),u=E=>l.has(d(E)),m=h?f.indexOf(h):-1,e=(m>=0?f.slice(m+1):f).find(E=>!u(E));e?e.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function g(t,c){var l;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!c||!Array.isArray(c)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(c.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const h=window.elementosAgrupadosScript.findIndex(u=>{var m;return((m=u.etiqueta)==null?void 0:m.etiqueta_sub_id)===t});if(h===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[h].elementos=c;const f=window.elementosAgrupadosScript[h],o=(l=f.etiqueta)==null?void 0:l.id;if(!o){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const d=document.getElementById("contenedor-svg-"+o);if(!d){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${o})`);return}try{const u=d.querySelector("svg");u&&u.remove();const m=600,r=150,e=d.closest(".proceso"),E=e&&getComputedStyle(e).getPropertyValue("--bg-estado").trim()||"#e5e7eb",y=document.createElementNS("http://www.w3.org/2000/svg","svg");y.setAttribute("viewBox",`0 0 ${m} ${r}`),y.setAttribute("preserveAspectRatio","xMidYMid meet"),y.style.width="100%",y.style.height="100%",y.style.display="block",y.style.background=E;const A=(f.elementos||[]).map((M,b)=>{var Q,V,O;const q=M.barras!=null?M.barras:0;let $="N/A";if(M.diametro!=null&&M.diametro!==""){const P=String(M.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(P){const B=parseFloat(P[0]);isFinite(B)&&($=String(Math.round(B)))}}const D=[];(Q=M.coladas)!=null&&Q.colada1&&D.push(M.coladas.colada1),(V=M.coladas)!=null&&V.colada2&&D.push(M.coladas.colada2),(O=M.coladas)!=null&&O.colada3&&D.push(M.coladas.colada3);const S=D.length>0?` (${D.join(", ")})`:"";return{letter:indexToLetters(b),text:`√ò${$} x${q}${S}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(y,A,m,r):console.error("‚ùå drawLegendBottomLeft no est√° definida");const v=document.createElementNS("http://www.w3.org/2000/svg","text");v.setAttribute("x",m/2),v.setAttribute("y",r/2),v.setAttribute("text-anchor","middle"),v.setAttribute("fill","#059669"),v.setAttribute("font-size","14"),v.setAttribute("font-weight","600"),v.textContent="‚úì Coladas actualizadas",y.appendChild(v),d.appendChild(y),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{v&&v.parentNode&&v.remove()},2e3)}catch(u){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,u),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function p(t,c,h,f=2e3){Swal.fire({icon:t,title:c,text:h,timer:f,showConfirmButton:!1})}function w(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=s}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);(function(x){let i=[],s=!1,a=null;async function n(u){var r;const m=`/etiquetas/${encodeURIComponent(u)}/validar-para-paquete`;try{const e=await fetch(m,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content}});if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const y=await e.json();if(console.log("üîç validarEtiqueta response:",{status:e.status,data:y,peso_etiqueta:y.peso_etiqueta}),!e.ok)throw new Error((y==null?void 0:y.message)||(y==null?void 0:y.motivo)||"Error al validar");return y}catch(e){throw e}}function g(u,m){const r=m.id||u;if(i.some(y=>y.id===r))return!1;const e=parseFloat(m.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:u,id:r,peso_etiqueta_recibido:m.peso_etiqueta,peso_parseado:e,data_completa:m});const E={id:r,type:"etiqueta",peso:e,estado:m.estado||"desconocido",nombre:m.nombre||"Sin nombre"};return i.push(E),h(),!0}function p(u){const m=i.findIndex(r=>r.id===u);m>=0&&i.splice(m,1),h()}function w(){i=[],h()}function t(){return i.reduce((u,m)=>u+(parseFloat(m.peso)||0),0)}function c(){return i}function h(){const u=document.getElementById("itemsList");if(!u)return;u.innerHTML="";for(const e of i){const E=document.createElement("li");E.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",E.dataset.code=e.id,E.innerHTML=`
                <div>
                    <div class="font-semibold">${e.id} === ${e.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,E.querySelector("button").onclick=()=>p(e.id),u.appendChild(E)}const m=t(),r=document.createElement("li");r.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",r.textContent=`Total: ${m.toFixed(2)} kg (${i.length} etiquetas)`,u.appendChild(r)}async function f(){var y,A,v;if(!i.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const u=Number(((A=(y=document.getElementById("maquina-info"))==null?void 0:y.dataset)==null?void 0:A.maquinaId)||window.maquinaId),m=Number(((v=document.getElementById("ubicacion-id"))==null?void 0:v.value)||window.ubicacionId),r=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!u){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!r&&!m){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const e={items:i.map(M=>({id:M.id,type:M.type})),maquina_id:u,ubicacion_id:r?null:m,sin_ubicacion:r},E=async(M={})=>{var $;const b=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":($=document.querySelector('meta[name="csrf-token"]'))==null?void 0:$.content},body:JSON.stringify({...e,...M})}),q=await b.json();if(!b.ok)throw new Error(q.message||"Error al crear el paquete");return q};try{const M=await E();if(M.success)return o(M);if(M.warning){let b="<div style='text-align:left;'>Se detectaron advertencias:";for(const[$,D]of Object.entries(M.warning))Array.isArray(D)&&D.length&&(b+=`<br><strong>${$.replaceAll("_"," ")}:</strong> ${D.join(", ")}`);if(b+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:b,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const $=await E({confirmar:!0});if($.success)return o($);throw new Error($.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(M){await Swal.fire("Error",M.message||"Error inesperado","error")}}async function o(u){var y;const m=u.codigo_paquete||((y=u.paquete)==null?void 0:y.codigo)||"N/D",r=t(),e=[...i.map(A=>A.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${m}</strong> creado correctamente</p>
                       <p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),w(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const A=document.getElementById("codigo_paquete_mover");A&&(A.value=m,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${m}</strong> creado correctamente</p><p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>`}),w()),console.log(`üì¶ Disparando evento paquete:creado para ${m}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:m,etiquetaIds:e,pesoTotal:r}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),e.forEach(A=>{d(A,m)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function d(u,m){const r=String(u).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${r}`);if(!e){console.warn(`‚ùå No se encontr√≥ elemento: ${u}`);return}console.log(`üîÑ Actualizando manualmente: ${u}`),Array.from(e.classList).forEach(b=>{b.startsWith("estado-")&&e.classList.remove(b)}),e.classList.add("estado-en-paquete"),e.dataset.estado="en-paquete",e.style.setProperty("--bg-estado","#e3e4FA");const y=e.querySelector('[id^="contenedor-svg-"]');if(y){const b=y.querySelector("svg");b&&(b.style.background="#e3e4FA")}const A=e.querySelector(".etiqueta-card")||e;A&&(A.style.background="#e3e4FA");const v=e.querySelector("h3");if(v&&!e.querySelector(".paquete-info")){const b=document.createElement("div");b.className="paquete-info text-sm font-semibold mt-2 no-print",b.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",b.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${m}</span>
            `,v.parentNode.insertBefore(b,v.nextSibling)}e.querySelectorAll(".btn-fabricar").forEach(b=>{b.disabled=!0,b.style.opacity="0.5",b.style.cursor="not-allowed"}),e.style.transition="transform 0.5s ease, background-color 0.5s ease",e.style.transform="scale(1.03)",setTimeout(()=>{e.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${u} actualizada manualmente`)}function l(){if(s)return;s=!0;const u=document.getElementById("qrItem");u&&(u.addEventListener("change",()=>u.dispatchEvent(new Event("input"))),u.addEventListener("input",async function(){const r=this.value.trim();if(r)try{const e=await n(r);if(!e.valida){await Swal.fire("Etiqueta no v√°lida",e.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}g(r,e)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(e){console.error("Error de validaci√≥n:",e),await Swal.fire("Error",e.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const m=document.getElementById("crearPaqueteBtn");m&&m.addEventListener("click",f),document.addEventListener("focus",function(r){r.target.id&&r.target.id.startsWith("input-etiqueta-")&&(a=r.target,console.log("üéØ Focus en input:",r.target.id))},!0),document.addEventListener("click",async function(r){var e;if(r.target.classList.contains("btn-agregar-carro")||r.target.closest(".btn-agregar-carro")){const y=(r.target.classList.contains("btn-agregar-carro")?r.target:r.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!y){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const A=document.querySelector(`[x-show="tabActivo === 'crear'"]`),v=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(A&&window.getComputedStyle(A).display,v&&window.getComputedStyle(v).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let b=document.activeElement;(!b||!((e=b.id)!=null&&e.startsWith("input-etiqueta-")))&&(b=a),(!b||!document.body.contains(b))&&(b=document.querySelector('input[id^="input-etiqueta-"]')),b?(b.value=y,b.focus(),b.classList.add("ring-4","ring-green-400"),setTimeout(()=>{b.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${y} a√±adida al input:`,b.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",y);try{const b=await n(y);if(!b.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:b.motivo||"Motivo no especificado"});return}g(y,b)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(b){console.error("Error al a√±adir al carro:",b),await Swal.fire({icon:"error",title:"Error",text:b.message||"No se pudo a√±adir al carro"})}}})}x.TrabajoPaquete={inicializar:l,agregarItemEtiqueta:g,eliminarItem:p,limpiarCarro:w,obtenerItems:c,calcularPesoTotal:t,crearPaquete:f,validarEtiqueta:n,actualizarListaVisual:h},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l(),document.addEventListener("livewire:navigated",l)})(window);function Tt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(i,s){const a=document.getElementById("grid-maquina");if(!a)return;console.log("üîß Actualizando clases:",{showLeft:i,showRight:s,clasesAnteriores:a.className}),i||s?a.classList.add("columnas-laterales-visibles"):a.classList.remove("columnas-laterales-visibles"),i&&s?a.classList.add("ambas-columnas"):a.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",a.className),a.offsetHeight,a.querySelectorAll(".etiqueta-card").forEach(g=>{g.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,s)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,s)});function x(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((g,p)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),p.disconnect();const t=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(t,c)}}).observe(document.body,{childList:!0,subtree:!0});return}const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}x()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const x={debounceTime:500};let i=0;async function s(f){var l;const o=Date.now();if(o-i<x.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};i=o;const d=(l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${f}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const m=await fetch(`/etiquetas/${encodeURIComponent(f)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),r=await m.json();return!m.ok||!r.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:r.message||"No se pudo revertir el cambio."}),{success:!1,message:r.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${r.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${r.estado}</strong>
                    </p>
                    ${r.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),p(f,r),r)}catch(u){return console.error("Error al deshacer etiqueta:",u),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:u.message}}}async function a(f){try{const o=await fetch(`/etiquetas/${encodeURIComponent(f)}/puede-deshacer`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{puede_deshacer:!1}}catch(o){return console.error("Error al verificar undo:",o),{puede_deshacer:!1}}}async function n(f){try{const o=await fetch(`/etiquetas/${encodeURIComponent(f)}/historial`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{success:!1,historial:[]}}catch(o){return console.error("Error al obtener historial:",o),{success:!1,historial:[]}}}async function g(f){var l;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const o=await n(f);if(!o.success||!((l=o.historial)!=null&&l.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=o.historial.map((u,m)=>`
            <tr class="${u.revertido?"bg-gray-100 text-gray-400":m===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${u.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${u.accion}</td>
                <td class="px-2 py-1 text-xs">${u.estado_anterior||"-"} ‚Üí ${u.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${u.revertido?'<span class="text-gray-400">Revertido</span>':m===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${f}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${o.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${o.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:o.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:o.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:o.puede_deshacer?"#f59e0b":"#6b7280"}).then(u=>{u.isConfirmed&&o.puede_deshacer&&s(f)})}function p(f,o){const d=f.replace(/\./g,"-"),l=document.getElementById(`etiqueta-${d}`);if(!l){console.warn(`Elemento etiqueta-${d} no encontrado en DOM`),typeof window.refrescarEtiquetasMaquina=="function"&&window.refrescarEtiquetasMaquina();return}l.dataset.estado=o.estado,l.className=l.className.split(" ").filter(r=>!r.startsWith("estado-")).join(" ").trim(),l.classList.add(`estado-${o.estado}`);const u=l.querySelector('[id^="contenedor-svg-"]'),m=u==null?void 0:u.querySelector("svg");m&&(m.style.background=getComputedStyle(l).getPropertyValue("--bg-estado").trim()),w(f,o.puede_deshacer),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(f,o.estado),console.log(`‚úÖ DOM actualizado para ${f}: estado = ${o.estado}`)}function w(f,o){const d=f.replace(/\./g,"-"),l=document.querySelector(`#etiqueta-${d} .btn-deshacer`);l&&(l.disabled=!o,l.classList.toggle("opacity-50",!o),l.classList.toggle("cursor-not-allowed",!o),l.title=o?"Deshacer √∫ltimo cambio":"No hay cambios para deshacer")}function t(){document.addEventListener("click",async f=>{const o=f.target.closest(".btn-deshacer");if(!o)return;f.preventDefault(),f.stopPropagation();const d=o.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await s(d)}),document.addEventListener("click",async f=>{const o=f.target.closest(".btn-historial");if(!o)return;f.preventDefault(),f.stopPropagation();const d=o.dataset.etiquetaId;d&&await g(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function c(){let f=null;window.addEventListener("etiqueta-fabricada",o=>{var d;(d=o.detail)!=null&&d.etiquetaSubId&&(f=o.detail.etiquetaSubId)}),document.addEventListener("keydown",async o=>{var d,l;if(o.ctrlKey&&o.key==="z"&&!o.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const u=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),m=((l=u==null?void 0:u.dataset)==null?void 0:l.etiquetaId)||f;m&&(o.preventDefault(),await s(m))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function h(){t(),c(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:s,puedeDeshacer:a,obtenerHistorial:n,mostrarHistorial:g,actualizarBoton:w},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h(),document.addEventListener("livewire:navigated",h)})();
