const jt="rgba(0, 0, 0, 0.8)",Lt="rgba(0, 0, 0, 1)",zt="rgba(0, 0, 0, 1)";function Xt(x,i){return!i||i===1?x.map(l=>({...l})):x.map(l=>l.type==="line"?{...l,length:(l.length||0)*i}:l.type==="arc"?{...l,radius:(l.radius||0)*i}:{...l})}const Ht=.75,$t=14,Ut=60,Pt=[0,10,-10,20,-20,30,-30];function G(x){return x*Math.PI/180}function Vt(x){const i=x.closest(".proceso");return i&&getComputedStyle(i).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Yt(x,i,l){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");return a.setAttribute("viewBox","0 0 "+x+" "+i),a.setAttribute("preserveAspectRatio","xMidYMid meet"),a.style.width="100%",a.style.height="100%",a.style.display="block",a.style.background=l||"#ffffff",a.style.shapeRendering="geometricPrecision",a.style.textRendering="optimizeLegibility",a.style.boxSizing="border-box",a}function Wt(x,i,l,a){const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",i),s.setAttribute("stroke",l),s.setAttribute("fill","none"),s.setAttribute("stroke-width",a),s.setAttribute("vector-effect","non-scaling-stroke"),x.appendChild(s),s}function Ot(x){let i="",l=Number(x)||0;for(;l>=0;){const a=l%26;i=String.fromCharCode(65+a)+i,l=Math.floor(l/26)-1}return i}const Jt=0,Kt=-25;function Qt(x,i,l,a){if(!i||!i.length)return;const s=2,f=12,h=f+s,w=i.map(g=>(g.letter?g.letter+" ":"")+(g.text||"")),p=f*w.length+s*(w.length-1),o=Jt;let r=a-Kt-p+f/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let g=0;g<w.length;g++){const e=w[g],m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",o),m.setAttribute("y",r),m.setAttribute("fill",zt),m.setAttribute("font-size",f),m.setAttribute("text-anchor","start"),m.setAttribute("alignment-baseline","middle"),m.style.pointerEvents="none",m.textContent=e,x.appendChild(m);const c=St(e,f).w;window.__legendBoxesGroup.push({left:o,right:o+c,top:r-f/2,bottom:r+f/2}),r+=h}}function Zt(x){const i=(x||"").split(/\s+/).filter(Boolean),l=[];for(let a=0;a<i.length;a++){const s=i[a];if(s.endsWith("r")){const f=parseFloat(s.slice(0,-1));let h=360;a+1<i.length&&i[a+1].endsWith("d")&&(h=parseFloat(i[++a].slice(0,-1))),l.push({type:"arc",radius:f,arcAngle:h})}else s.endsWith("d")?l.push({type:"turn",angle:parseFloat(s.slice(0,-1))}):l.push({type:"line",length:parseFloat(s)})}return l}function te(x){let i=[],l=0,a=0,s=0;i.push({x:l,y:a});for(let f=0;f<x.length;f++){const h=x[f];if(h.type==="line")l+=h.length*Math.cos(G(s)),a+=h.length*Math.sin(G(s)),i.push({x:l,y:a});else if(h.type==="turn")s+=h.angle;else if(h.type==="arc"){const w=l+h.radius*Math.cos(G(s+90)),p=a+h.radius*Math.sin(G(s+90)),o=Math.atan2(a-p,l-w),r=o+G(h.arcAngle);l=w+h.radius*Math.cos(r),a=p+h.radius*Math.sin(r),s+=h.arcAngle,i.push({x:l,y:a})}}return i}function Ft(x){let i=[],l=0,a=0,s=0;for(let f=0;f<x.length;f++){const h=x[f];if(h.type==="line"){const w={x:l,y:a},p={x:l+h.length*Math.cos(G(s)),y:a+h.length*Math.sin(G(s))};i.push({start:w,end:p,length:h.length}),l=p.x,a=p.y}else if(h.type==="turn")s+=h.angle;else if(h.type==="arc"){const w=l+h.radius*Math.cos(G(s+90)),p=a+h.radius*Math.sin(G(s+90)),o=Math.atan2(a-p,l-w),r=o+G(h.arcAngle);l=w+h.radius*Math.cos(r),a=p+h.radius*Math.sin(r),s+=h.arcAngle}}return i}function St(x,i){const l=i||12;return{w:(x?x.length:0)*l*.55,h:l}}function ot(x,i,l){const a=l||0;return!(x.right+a<i.left||x.left-a>i.right||x.bottom+a<i.top||x.top-a>i.bottom)}function Bt(x,i,l,a){const s=i/2;return Math.max(l+s,Math.min(a-s,x))}function ee(x,i){const a=[];let s=0;function f(){s>1e-9&&(a.push({type:"line",length:s}),s=0)}for(let h=0;h<x.length;h++){const w=x[h];if(w.type==="line"){s+=w.length;continue}if(w.type==="turn"){if(Math.abs(w.angle)<1e-9)continue;f(),a.push(w);continue}if(w.type==="arc"){f(),a.push(w);continue}f(),a.push(w)}return f(),a}function Rt(x,i){const l=i&&i.decimals||0,a=i&&i.step||null;let s=Number(x||0);return a&&a>0&&(s=Math.round(s/a)*a),s.toFixed(l).replace(/\.0+$/,"")}function oe(x,i){const l=Math.hypot(x,i)||1;let a=x/l,s=i/l;return(s<-1e-9||Math.abs(s)<=1e-9&&a<0)&&(a=-a,s=-s),{ux:a,uy:s}}function Gt(x,i,l){const a=l||.01,s=oe(x,i),f=Math.round(s.ux/a)*a,h=Math.round(s.uy/a)*a;return f+"|"+h}function ae(x,i,l){const a=l&&l.dirPrecision||.01,s=l&&l.labelFormat||{decimals:0,step:null},f=x.reduce((m,c)=>m+Math.hypot(c.end.x-c.start.x,c.end.y-c.start.y),0),h=i.reduce((m,c)=>m+(c.length||Math.hypot(c.end.x-c.start.x,c.end.y-c.start.y)),0),w=h>0?f/h:1,p=new Map;for(let m=0;m<i.length;m++){const c=i[m],d=c.end.x-c.start.x,u=c.end.y-c.start.y,n=Gt(d,u,a),t=p.get(n)||[];t.push({length:c.length||Math.hypot(d,u),index:m}),p.set(n,t)}const o=i.map(m=>m.length||Math.hypot(m.end.x-m.start.x,m.end.y-m.start.y)),r=new Set,g=new Set,e=[];for(let m=0;m<x.length;m++){const c=x[m],d=c.end.x-c.start.x,u=c.end.y-c.start.y,n=Gt(d,u,a),t=p.get(n)||[],A=Math.hypot(d,u);let y=A;if(t.length){const q=A/w;let b=null,S=1/0;for(const C of t){const D=Math.abs(C.length-q),M=g.has(C.index)?.1:0;D+M<S&&(b=C,S=D+M)}b&&(y=b.length,g.add(b.index))}else m<o.length&&(y=o[m]);const E=Rt(y,s),v=n+"|"+E;r.has(v)||(r.add(v),e.push({start:c.start,end:c.end,_dirKey:n,_label:E,_lenChosen:y}))}return e}function ne(x,i){const l=i,a=x.map(u=>Object.assign({},u));let s=0,f=0,h=0;const w=[];let p=null,o=-1,r=-1;const g=1e-7;function e(u){return u*Math.PI/180}function m(u){return Math.abs(Math.sin(e(u)))<1e-12}function c(u,n,t,A){return Math.min(n,A)-Math.max(u,t)>g}for(let u=0;u<a.length;u++){let t=function(){const q={x:Math.cos(e(h)),y:Math.sin(e(h))},b=s+a[u].length*q.x,S=f+a[u].length*q.y,C=m(h);for(let D=0;D<w.length;D++){const M=w[D];if(C&&M.horiz&&Math.abs(f-M.y)<g){if(c(Math.min(s,b),Math.max(s,b),Math.min(M.x1,M.x2),Math.max(M.x1,M.x2))&&p&&o>=0&&r>=0)return a[r].length+=l,s+=p.x*l,f+=p.y*l,w[o].x2+=p.x*l,w[o].y2+=p.y*l,!0}else if(!C&&!M.horiz&&Math.abs(s-M.x)<g&&c(Math.min(f,S),Math.max(f,S),Math.min(M.y1,M.y2),Math.max(M.y1,M.y2))&&p&&o>=0&&r>=0)return a[r].length+=l,s+=p.x*l,f+=p.y*l,w[o].x2+=p.x*l,w[o].y2+=p.y*l,!0}return!1};var d=t;const n=a[u];if(n.type==="turn"){h+=n.angle;continue}if(n.type==="arc"){const q=s+n.radius*Math.cos(e(h+90)),b=f+n.radius*Math.sin(e(h+90)),S=Math.atan2(f-b,s-q),C=S+e(n.arcAngle);s=q+n.radius*Math.cos(C),f=b+n.radius*Math.sin(C),h+=n.arcAngle,p=null;continue}for(;t(););const A={x:Math.cos(e(h)),y:Math.sin(e(h))},y=s+a[u].length*A.x,E=f+a[u].length*A.y,v=m(h);w.push({x1:s,y1:f,x2:y,y2:E,horiz:v,y:f,x:s}),p=A,o=w.length-1,r=u,s=y,f=E}return a}function Et(x,i,l,a){const s=G(a),f=Math.cos(s),h=Math.sin(s),w=x.x-i,p=x.y-l;return{x:i+w*f-p*h,y:l+w*h+p*f}}function se(x,i,l,a,s,f,h,w,p){let o="",r=0,g=0,e=0,m=!1;function c(u,n){const t=Et({x:u,y:n},i,l,a);return{x:w+(t.x-f)*s,y:p+(t.y-h)*s}}function d(){if(!m){const u=c(r,g);o+="M "+u.x+" "+u.y,m=!0}}for(let u=0;u<x.length;u++){const n=x[u];if(n.type==="turn"){e+=n.angle;continue}if(n.type==="line"){const t=r+n.length*Math.cos(G(e)),A=g+n.length*Math.sin(G(e));d();const y=c(t,A);o+=" L "+y.x+" "+y.y,r=t,g=A;continue}if(n.type==="arc"){const t=r+n.radius*Math.cos(G(e+90)),A=g+n.radius*Math.sin(G(e+90)),y=Math.atan2(g-A,r-t),E=y+G(n.arcAngle),v=t+n.radius*Math.cos(E),q=A+n.radius*Math.sin(E),b=Math.abs(n.arcAngle)%360;if(d(),b<1e-6||Math.abs(n.arcAngle)>=359.9){const ct=y+Math.sign(n.arcAngle)*Math.PI,H=t+n.radius*Math.cos(ct),N=A+n.radius*Math.sin(ct),T=c(H,N),O=c(r,g),B=n.radius*s,V=n.arcAngle>=0?1:0;o+=" A "+B+" "+B+" 0 1 "+V+" "+T.x+" "+T.y,o+=" A "+B+" "+B+" 0 1 "+V+" "+O.x+" "+O.y,e+=n.arcAngle;continue}const S=c(v,q),C=n.radius*s,D=b>180?1:0,M=n.arcAngle>=0?1:0;o+=" A "+C+" "+C+" 0 "+D+" "+M+" "+S.x+" "+S.y,r=v,g=q,e+=n.arcAngle}}return o||"M 0 0"}function ie(x){const i=te(x);let l=Math.min(...i.map(d=>d.x)),a=Math.max(...i.map(d=>d.x)),s=Math.min(...i.map(d=>d.y)),f=Math.max(...i.map(d=>d.y));const h=(l+a)/2,w=(s+f)/2,o=f-s>a-l?-90:0,r=i.map(d=>Et(d,h,w,o));l=Math.min(...r.map(d=>d.x)),a=Math.max(...r.map(d=>d.x)),s=Math.min(...r.map(d=>d.y)),f=Math.max(...r.map(d=>d.y));const g=Math.max(1,a-l),e=Math.max(1,f-s),m=(l+a)/2,c=(s+f)/2;return{rotDeg:o,w:g,h:e,cxModel:h,cyModel:w,midX:m,midY:c,ptsRot:r}}function re(x){const i=[];let l=0,a=0,s=0;function f(h){const w=G(h);return{x:Math.cos(w),y:Math.sin(w)}}for(let h=0;h<x.length;h++){const w=x[h];if(w.type==="line")l+=w.length*Math.cos(G(s)),a+=w.length*Math.sin(G(s));else if(w.type==="turn"){const p=f(s),o=w.angle;s+=o;const r=f(s);i.push({x:l,y:a,angleDeg:o,prevDir:p,nextDir:r})}else if(w.type==="arc"){const p=l+w.radius*Math.cos(G(s+90)),o=a+w.radius*Math.sin(G(s+90)),r=Math.atan2(a-o,l-p),g=r+G(w.arcAngle);l=p+w.radius*Math.cos(g),a=o+w.radius*Math.sin(g),s+=w.arcAngle}}return i}function ce(x,i,l){const a=Array.from({length:i},()=>({sumH:0,maxW:0,items:[]})),s=[...x.keys()].sort((f,h)=>x[h].h-x[f].h);for(const f of s){let h=0,w=1/0;for(let o=0;o<i;o++){const r=a[o],g=r.sumH+(r.items.length>0?l:0)+x[f].h;g<w&&(w=g,h=o)}const p=a[h];p.sumH=p.items.length>0?p.sumH+l+x[f].h:p.sumH+x[f].h,p.maxW=Math.max(p.maxW,x[f].w),p.items.push(f)}return a}function le(x,i,l,a={}){const s=a.padding??12,f=a.gapCol??12,h=a.gapRow??10,w=Math.max(1,Math.min(x.length,a.kMax??4)),p=Math.max(10,i-2*s),o=Math.max(10,l-2*s),r=g(x);function g(t){const A=t.map(B=>B.w/Math.max(B.h,1)),y=t.map(B=>B.h),E=t.map(B=>B.w),v=t.map(B=>B.w*B.h),q=B=>B.reduce((V,P)=>V+P,0)/B.length,b=(B,V)=>B.reduce((P,$)=>P+Math.pow($-V,2),0)/B.length,S=(B,V)=>Math.sqrt(b(B,V)),C=q(A),D=q(y),M=q(E),ct=v.reduce((B,V)=>B+V,0),H=S(y,D),N=S(E,M),T=D>0?H/D:0,O=M>0?N/M:0;return{avgAspectRatio:C,avgHeight:D,avgWidth:M,totalArea:ct,heightCV:T,widthCV:O,isLinear:C>6||D<M*.12,isUniformHeight:T<.15,isUniformWidth:O<.15,isHighlyVariable:T>.5||O>.5,count:t.length}}let e={S:0,k:1,cols:null,score:0};for(let t=1;t<=w;t++){const A=ce(x,t,h),y=A.reduce(($,z)=>$+z.maxW,0)+f*(t-1),E=Math.max(...A.map($=>$.sumH));if(y<=0||E<=0)continue;const v=p/y,q=o/E,b=Math.min(v,q),S=Math.max(.01,b*.92),C=r.totalArea*S*S,D=p*o,M=C/D,ct=A.map($=>$.sumH*S),H=ct.reduce(($,z)=>$+z,0)/t,N=Math.max(...ct)-Math.min(...ct),T=H>0?1-N/H:1,O=t===1?1.1:t===2?.9:.7,B=t>r.count*.5?.7:1,V=T>.85?1.05:1,P=S*(1+M*.25)*(1+T*.1)*O*B*V;P>e.score&&(e={S,k:t,cols:A,score:P,efficiency:M,colBalance:T})}const m=e.cols.map(t=>t.maxW*e.S),c=m.reduce((t,A)=>t+A,0);let d=[];if(e.k===1)d[0]=i/2;else{const t=(e.k-1)*f,A=c+t;if(A<p){const y=p-A,E=f+y/(e.k-1);let v=s;for(let q=0;q<e.k;q++)d[q]=v+m[q]/2,v+=m[q]+E}else{let y=s+Math.max(0,(p-A)/2);for(let E=0;E<e.k;E++)d[E]=y+m[E]/2,y+=m[E]+f}}const u=[],n=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(t=>t.right));for(let t=0;t<e.k;t++){const A=e.cols[t];u[t]=[];const y=A.items.map(N=>x[N].h*e.S),E=y.reduce((N,T)=>N+T,0);if(A.items.length===0)continue;const v=d[t],q=e.cols[t].maxW*e.S,b=v-q/2,S=v+q/2,C=n(),M=Math.max(0,Math.min(S,C)-b)/q,ct=M>.05;let H=o;if(ct&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const T=Math.min(...window.__legendBoxesGroup.map(O=>O.top))-15;H=Math.max(10,T-s),console.log(`üìè Columna ${t}: X=${b.toFixed(0)}-${S.toFixed(0)}, legendWidth=${C.toFixed(0)}, solape=${(M*100).toFixed(0)}%, altura reducida a ${H.toFixed(0)}px`)}else console.log(`üìè Columna ${t}: X=${b.toFixed(0)}-${S.toFixed(0)}, legendWidth=${C.toFixed(0)}, solape=${(M*100).toFixed(0)}%, altura completa ${H.toFixed(0)}px`);if(A.items.length===1){const N=y[0],T=s+H/2,O=Math.max(s+N/2,Math.min(T,l-s-N/2));u[t].push(O);continue}if(E>H){console.warn(`Columna ${t}: elementos no caben (${E}px > ${H}px)`);const O=E/A.items.length<4?20:5;let B=s;for(let V=0;V<A.items.length;V++){const P=Math.max(y[V],2),$=B+P/2;u[t].push($),B+=P+O}}else{const N=H-E,T=A.items.length-1;let O=N/T;E/A.items.length<4?O=Math.max(18,Math.min(O,50)):O=Math.max(5,O);const P=E+T*O,$=H-P;let z=s+Math.max(0,$/2);for(let lt=0;lt<A.items.length;lt++){const _=Math.max(y[lt],2),Y=z+_/2,k=s+H-_/2,L=Math.max(s+_/2,Math.min(Y,k));u[t].push(L),z+=_+O}}}return{S:e.S,k:e.k,cols:e.cols,centersX:d,centersYByCol:u,padding:s,gapRow:h,gapCol:f}}window.renderizarGrupoSVG=function(i,l){const a=i&&i.etiqueta&&i.etiqueta.id!=null?i.etiqueta.id:i&&i.id!=null?i.id:l,s=document.getElementById("contenedor-svg-"+a);if(!s)return;const f=600,h=150,w=Vt(s),p=Yt(f,h,w);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const o=(i.elementos||[]).map((c,d)=>{var y,E,v;const u=c.barras!=null?c.barras:0;let n="N/A";if(c.diametro!=null&&c.diametro!==""){const b=String(c.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(b){const S=parseFloat(b[0]);isFinite(S)&&(n=String(Math.round(S)))}}const t=[];(y=c.coladas)!=null&&y.colada1&&t.push(c.coladas.colada1),(E=c.coladas)!=null&&E.colada2&&t.push(c.coladas.colada2),(v=c.coladas)!=null&&v.colada3&&t.push(c.coladas.colada3);const A=t.length>0?` (${t.join(", ")})`:"";return{letter:Ot(d),text:`√ò${n} x${u}${A}`}});Qt(p,o,f,h);const r=i.elementos.map(c=>{const d=Zt(c.dimensiones||""),u=ee(d);let n=0;for(const v of u)v.type==="line"&&(n=Math.max(n,Math.abs(v.length||0))),v.type==="arc"&&(n=Math.max(n,Math.abs(v.radius||0)));const A=n<=50?2:1,y=Xt(u,A),E=ie(y);return{dimsRaw:d,dimsNoZero:u,dimsScaled:y,geomScale:A,medida:E}}),g=r.map(c=>c.medida),e=le(g,f,h,{padding:20,gapCol:50,gapRow:22,kMax:3}),m=new Map;for(let c=0;c<e.k;c++)e.cols[c].items.forEach((d,u)=>m.set(d,{c,j:u}));i.elementos.forEach(function(c,d){const{dimsNoZero:u,dimsScaled:n,medida:t}=r[d],A=m.get(d),y=e.centersX[A.c],E=e.centersYByCol[A.c][A.j],v=e.S,q=t.ptsRot.map($=>({x:y+($.x-t.midX)*v,y:E+($.y-t.midY)*v})),b=Math.min(...q.map($=>$.x)),S=Math.max(...q.map($=>$.x)),C=Math.min(...q.map($=>$.y)),D=Math.max(...q.map($=>$.y)),M={left:b,right:S,top:C,bottom:D};window.__figBoxesGroup.push({...M});const ct=ne(n,.6),H=se(ct,t.cxModel,t.cyModel,t.rotDeg,v,t.midX,t.midY,y,E),N=Wt(p,H,jt,2);(function(){const z=re(n);function lt(L){return Math.abs(Math.abs(L)-90)>=Ht}const _=(L,I)=>Et({x:L.x,y:L.y},0,0,I),Y=(L,I)=>{const W=Et({x:L,y:I},t.cxModel,t.cyModel,t.rotDeg);return{x:y+(W.x-t.midX)*v,y:E+(W.y-t.midY)*v}},k=L=>Math.max(10,Math.min(28,L));z.forEach(L=>{if(!lt(L.angleDeg))return;const I=Y(L.x,L.y),W=_(L.prevDir,t.rotDeg),pt=_(L.nextDir,t.rotDeg),J=Math.atan2(W.y,W.x),R=J+G(L.angleDeg),K=Math.min(M.right-M.left,M.bottom-M.top);let F=k(.12*K);const ft=I.x+F*Math.cos(J),mt=I.y+F*Math.sin(J),U=I.x+F*Math.cos(R),ht=I.y+F*Math.sin(R),Q=Math.abs(L.angleDeg),nt=Q>180?1:0,vt=L.angleDeg>=0?1:0,st=document.createElementNS("http://www.w3.org/2000/svg","path");st.setAttribute("d",`M ${ft} ${mt} A ${F} ${F} 0 ${nt} ${vt} ${U} ${ht}`),st.setAttribute("stroke","rgba(255,99,71,0.7)"),st.setAttribute("stroke-width","2"),st.setAttribute("fill","none"),st.style.pointerEvents="none",p.appendChild(st);let j=W.x+pt.x,X=W.y+pt.y;Q>180&&(j=-j,X=-X);let Z=Math.hypot(j,X);if(Z<1e-6){const rt=L.angleDeg>=0?1:-1;j=-W.y*rt,X=W.x*rt,Z=Math.hypot(j,X)||1}j/=Z,X/=Z;const tt=(Math.round(L.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",et=St(tt,14);function At(rt,dt){return{left:rt-et.w/2,right:rt+et.w/2,top:dt-et.h/2,bottom:dt+et.h/2}}let at=null;for(let rt=$t;rt<=Ut&&!at;rt+=4)for(let dt=0;dt<Pt.length&&!at;dt++){const wt=Pt[dt],yt=_({x:j,y:X},wt),xt=I.x+yt.x*(F+rt),ut=I.y+yt.y*(F+rt),gt=At(xt,ut);gt.top<0||gt.bottom>h||gt.left<0||gt.right>f||window.__figBoxesGroup.some(bt=>ot(bt,gt,6))||(window.__dimBoxesGroup||[]).some(bt=>ot(bt,gt,2))||(window.__angleBoxesGroup||[]).some(bt=>ot(bt,gt,2))||(window.__placedLetterBoxes||[]).some(bt=>ot(bt,gt,2))||(window.__legendBoxesGroup||[]).some(bt=>ot(bt,gt,6))||(at={x:xt,y:ut,box:gt})}if(!at){const rt=I.x+j*(F+$t),dt=I.y+X*(F+$t),wt=At(rt,dt);at={x:rt,y:dt,box:wt}}window.__angleBoxesGroup.push(at.box);const it=document.createElementNS("http://www.w3.org/2000/svg","text");it.setAttribute("x",at.x),it.setAttribute("y",at.y),it.setAttribute("fill",Lt),it.setAttribute("font-size",14),it.setAttribute("text-anchor","middle"),it.setAttribute("alignment-baseline","middle"),it.style.cursor="pointer",it.textContent=tt,p.appendChild(it),it.addEventListener("mouseenter",()=>{st.setAttribute("stroke","rgba(255,69,0,1)"),st.setAttribute("stroke-width","3"),st.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),it.addEventListener("mouseleave",()=>{st.setAttribute("stroke","rgba(255,99,71,0.7)"),st.setAttribute("stroke-width","2"),st.style.filter="none"})})})();const T=N.cloneNode(!1);T.setAttribute("stroke-width","50"),T.setAttribute("stroke","transparent"),T.setAttribute("fill","none"),T.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach($=>{T.addEventListener($,z=>N.dispatchEvent(new z.constructor(z.type,z)))}),p.insertBefore(T,N),(c.codigo!=null?c.codigo:c.id)+"",N.style.cursor="pointer",N.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),N.addEventListener("click",function($){if($.ctrlKey||$.metaKey||$.shiftKey){$.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(c.id);return}abrirModalDividirElemento(c.id,c.barras||0)}),N.addEventListener("contextmenu",function($){$.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(c.id)});const O=[],B=Ft(ct),V=Ft(u);ae(B,V,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function($){const z=Et($.start,t.cxModel,t.cyModel,t.rotDeg),lt=Et($.end,t.cxModel,t.cyModel,t.rotDeg),_={x:y+(z.x-t.midX)*v,y:E+(z.y-t.midY)*v},Y={x:y+(lt.x-t.midX)*v,y:E+(lt.y-t.midY)*v},k=$._label,L=Y.x-_.x,I=Y.y-_.y,W=Math.hypot(L,I)||1,pt=L/W,J=I/W,R=I/W,K=-L/W,F=(_.x+Y.x)/2,ft=(_.y+Y.y)/2,mt=F+R*10,U=ft+K*10,ht=St(k,14),Q=ht.w,nt=ht.h;function vt(at,it){return{left:at-Q/2,right:at+Q/2,top:it-nt/2,bottom:it+nt/2}}const st=W*.45;let j=mt,X=U;for(let at=0;at<=Math.ceil(st/6);at++){const it=at%2===0?1:-1,rt=Math.ceil(at/2),dt=it*rt*6;if(Math.abs(dt)>st)continue;const wt=mt+pt*dt,yt=U+J*dt,xt=(wt-_.x)*pt+(yt-_.y)*J;if(xt<0+Q*.3||xt>W-Q*.3)continue;const ut=vt(wt,yt);if(!(ot({left:Math.min(_.x,Y.x),right:Math.max(_.x,Y.x),top:Math.min(_.y,Y.y),bottom:Math.max(_.y,Y.y)},ut,0)||(window.__angleBoxesGroup||[]).some(qt=>ot(qt,ut,2))||(window.__legendBoxesGroup||[]).some(qt=>ot(qt,ut,6))||O.some(qt=>ot(qt,ut,2))||ut.top<0||ut.bottom>h||ut.left<0||ut.right>f)){j=wt,X=yt,O.push(ut),window.__dimBoxesGroup.push(ut);break}}const Z=document.createElementNS("http://www.w3.org/2000/svg","line");Z.setAttribute("x1",_.x),Z.setAttribute("y1",_.y),Z.setAttribute("x2",Y.x),Z.setAttribute("y2",Y.y),Z.setAttribute("stroke","rgba(0,0,255,0.6)"),Z.setAttribute("stroke-width","4"),Z.setAttribute("stroke-linecap","round"),Z.setAttribute("vector-effect","non-scaling-stroke"),Z.style.opacity=0,Z.style.pointerEvents="none",Z.style.transition="opacity 120ms ease",p.appendChild(Z);const tt=document.createElementNS("http://www.w3.org/2000/svg","text");tt.setAttribute("x",j),tt.setAttribute("y",X),tt.setAttribute("fill",Lt),tt.setAttribute("font-size",14),tt.setAttribute("text-anchor","middle"),tt.setAttribute("alignment-baseline","middle"),tt.setAttribute("tabindex","0"),tt.style.cursor="pointer",tt.textContent=k,p.appendChild(tt);function et(){Z.style.opacity=1}function At(){Z.style.opacity=0}tt.addEventListener("mouseenter",et),tt.addEventListener("mouseleave",At),tt.addEventListener("focus",et),tt.addEventListener("blur",At)}),function(){const z=[];let lt=0,_=0,Y=0;for(let k=0;k<n.length;k++){const L=n[k];if(L.type==="line")lt+=L.length*Math.cos(G(Y)),_+=L.length*Math.sin(G(Y));else if(L.type==="turn")Y+=L.angle;else if(L.type==="arc"){const I=lt+L.radius*Math.cos(G(Y+90)),W=_+L.radius*Math.sin(G(Y+90)),pt=Math.atan2(_-W,lt-I),J=pt+G(L.arcAngle);let R=L.radius;for(let K=0;K<u.length;K++){const F=u[K];if(F.type==="arc"&&Math.abs(F.arcAngle-L.arcAngle)<.01){R=F.radius;break}}z.push({center:{x:I,y:W},radius:L.radius,originalRadius:R,arcAngle:L.arcAngle,startAngle:pt,endAngle:J}),lt=I+L.radius*Math.cos(J),_=W+L.radius*Math.sin(J),Y+=L.arcAngle}}z.forEach(function(k){const L=Et(k.center,t.cxModel,t.cyModel,t.rotDeg),I={x:y+(L.x-t.midX)*v,y:E+(L.y-t.midY)*v},W=(k.startAngle+k.endAngle)/2,pt=k.radius*v,J="R"+Rt(k.originalRadius,{decimals:0,step:null}),R=St(J,14),K=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let F=!1,ft,mt,U;for(let et=0;et<K.length&&!F;et++){const At=K[et],at=W+G(At),it={x:k.center.x+k.radius*Math.cos(at),y:k.center.y+k.radius*Math.sin(at)},rt=Et(it,t.cxModel,t.cyModel,t.rotDeg),dt={x:y+(rt.x-t.midX)*v,y:E+(rt.y-t.midY)*v},wt=dt.x-I.x,yt=dt.y-I.y,xt=Math.hypot(wt,yt)||1,ut=wt/xt,gt=yt/xt;for(let Mt=8;Mt<=60&&!F;Mt+=6){const Ct=pt*.7;if(ft=I.x+ut*Ct+ut*Mt,mt=I.y+gt*Ct+gt*Mt,U={left:ft-R.w/2,right:ft+R.w/2,top:mt-R.h/2,bottom:mt+R.h/2},!(U.top<0||U.bottom>h||U.left<0||U.right>f||window.__figBoxesGroup.some(_t=>ot(_t,U,2))||(window.__legendBoxesGroup||[]).some(_t=>ot(_t,U,2)))){F=!0;break}}}if(!F)return;O.push(U);const ht={x:ft-I.x,y:mt-I.y},Q=Math.hypot(ht.x,ht.y)||1,nt={x:ht.x/Q,y:ht.y/Q},vt=I.x+nt.x*pt*.6,st=I.y+nt.y*pt*.6,j=document.createElementNS("http://www.w3.org/2000/svg","line");j.setAttribute("x1",I.x),j.setAttribute("y1",I.y),j.setAttribute("x2",vt),j.setAttribute("y2",st),j.setAttribute("stroke","rgba(0,128,0,0.6)"),j.setAttribute("stroke-width","4"),j.setAttribute("stroke-linecap","round"),j.setAttribute("vector-effect","non-scaling-stroke"),j.style.opacity=0,j.style.pointerEvents="none",j.style.transition="opacity 120ms ease",p.appendChild(j);const X=document.createElementNS("http://www.w3.org/2000/svg","text");X.setAttribute("x",ft),X.setAttribute("y",mt),X.setAttribute("fill",Lt),X.setAttribute("font-size",14),X.setAttribute("text-anchor","middle"),X.setAttribute("alignment-baseline","middle"),X.setAttribute("tabindex","0"),X.style.cursor="pointer",X.textContent=J,p.appendChild(X);function Z(){j.style.opacity=1}function tt(){j.style.opacity=0}X.addEventListener("mouseenter",Z),X.addEventListener("mouseleave",tt),X.addEventListener("focus",Z),X.addEventListener("blur",tt)})}(),function(){const z=Ot(d),lt=14,_=St(z,lt);function Y(R,K){return{left:R,right:R+_.w,top:K-_.h/2,bottom:K+_.h/2}}let k=null;const L=(M.top+M.bottom)/2,I=Math.max(_.h/2,Math.min(L,h-_.h/2));function W(R){for(let F=0;F<=30;F+=4){const ft=F%2===0?1:-1,mt=Math.ceil(F/2),U=ft*mt*4,ht=Math.max(_.h/2,Math.min(h-_.h/2,I+U)),Q=R,nt=Y(Q,ht);if(!(window.__figBoxesGroup.some(et=>ot(et,nt,6))||(window.__dimBoxesGroup||[]).some(et=>ot(et,nt,3))||(window.__angleBoxesGroup||[]).some(et=>ot(et,nt,3))||(window.__legendBoxesGroup||[]).some(et=>ot(et,nt,6))||(window.__placedLetterBoxes||[]).some(et=>ot(et,nt,2))||nt.top<0||nt.bottom>h||nt.left<0||nt.right>f))return k={x:Q,y:ht,box:nt},!0}return!1}const pt=[{x:M.right+10,priority:1},{x:M.left-10-_.w,priority:1},{x:M.right+15,priority:2},{x:M.left-15-_.w,priority:2},{x:M.right+5,priority:2},{x:M.left-5-_.w,priority:2},{x:M.right+20,priority:3},{x:M.left-20-_.w,priority:3},{x:M.right+25,priority:3},{x:M.left-25-_.w,priority:3},{x:M.right+30,priority:3},{x:M.left-30-_.w,priority:3}];pt.sort((R,K)=>R.priority-K.priority);for(const R of pt){if(k)break;const K=Bt(R.x,_.w,0,f);if(W(K))break}if(!k){const R=(M.left+M.right)/2,K=[{x:R-_.w/2,y:M.top-_.h-5},{x:R-_.w/2,y:M.bottom+_.h+5}];for(const F of K){if(k)break;const ft=Bt(F.x,_.w,0,f),mt=Math.max(_.h/2,Math.min(h-_.h/2,F.y)),U=Y(ft,mt);!window.__figBoxesGroup.some(Q=>ot(Q,U,6))&&!(window.__dimBoxesGroup||[]).some(Q=>ot(Q,U,3))&&!(window.__angleBoxesGroup||[]).some(Q=>ot(Q,U,3))&&!(window.__legendBoxesGroup||[]).some(Q=>ot(Q,U,6))&&!(window.__placedLetterBoxes||[]).some(Q=>ot(Q,U,2))&&U.top>=0&&U.bottom<=h&&U.left>=0&&U.right<=f&&(k={x:ft,y:mt,box:U})}}if(!k){const R=Bt(f-_.w,_.w,0,f),K=I;k={x:R,y:K,box:Y(R,K)}}window.__placedLetterBoxes.push(k.box);const J=document.createElementNS("http://www.w3.org/2000/svg","text");J.setAttribute("x",k.x),J.setAttribute("y",k.y),J.setAttribute("fill",zt),J.setAttribute("font-size",lt),J.setAttribute("text-anchor","start"),J.setAttribute("alignment-baseline","middle"),J.style.fontWeight="600",J.style.pointerEvents="none",J.textContent=z,p.appendChild(J)}()}),s.innerHTML="",s.appendChild(p)};function It(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const x=window.elementosAgrupadosScript;if(!x)return;const i=document.getElementById("grid-maquina");if(i&&window.updateGridClasses){const l=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,a),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}x.forEach(function(l,a){renderizarGrupoSVG(l,a)}),requestAnimationFrame(()=>{i&&(i.style.opacity="1",i.style.visibility="visible",i.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",i.className)),document.querySelectorAll(".proceso").forEach(l=>{l.style.opacity="1"})}),window.actualizarSVGConColadas=function(l,a){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,f=s.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(l));if(f===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${l}`);return}const h=s[f];h.elementos&&a&&h.elementos.forEach(w=>{const p=String(w.id),o=a[p];w.coladas||(w.coladas={colada1:null,colada2:null,colada3:null}),o&&Array.isArray(o)&&(w.coladas.colada1=o[0]||null,w.coladas.colada2=o[1]||null,w.coladas.colada3=o[2]||null)}),renderizarGrupoSVG(h,f),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${l}`,a)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It();document.addEventListener("livewire:navigated",It);window.abrirModalDividirElemento=function(i,l){const a=document.getElementById("modalDividirElemento"),s=document.getElementById("dividir_elemento_id"),f=document.getElementById("dividir_barras_totales"),h=document.getElementById("labelBarrasActuales"),w=document.getElementById("barras_a_mover"),p=document.getElementById("previewDivision"),o=document.getElementById("formDividirElemento");if(!a||!s||!o)return;s.value=i;let r=parseInt(l)||0;if(r===0&&window.elementosAgrupadosScript){for(const g of window.elementosAgrupadosScript)if(g.elementos){const e=g.elementos.find(m=>String(m.id)===String(i));if(e&&e.barras){r=parseInt(e.barras)||0;break}}}f&&(f.value=r),h&&(h.textContent=r>0?r:"-"),w&&(w.value=""),p&&p.classList.add("hidden"),window.rutaDividirElemento&&o.setAttribute("action",window.rutaDividirElemento),a.classList.remove("hidden")};window.enviarDivision=async function(){const i=document.getElementById("formDividirElemento"),l=i.getAttribute("action")||window.rutaDividirElemento,a=new FormData(i);try{const s=document.querySelector('meta[name="csrf-token"]'),f=a.get("_token")||(s?s.getAttribute("content"):null),w=await fetch(l,{method:"POST",headers:f?{"X-CSRF-TOKEN":f}:{},body:a}),p=await w.json();if(!w.ok||!p.success)throw new Error(p.message||"Error al dividir");i.reset();const o=document.getElementById("modalDividirElemento");o&&o.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",p.message,"success"):alert(p.message)}catch(s){window.Swal?window.Swal.fire("Error",s&&s.message||"Error","error"):alert(s&&s.message||"Error")}};(function(x){const i={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},l={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function a(p,o,r={}){console.log(`üîÑ Actualizando etiqueta ${p} a estado: ${o}`);const g=String(p).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${g}`);if(!e)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${p}`),!1;const m=String(o).toLowerCase().trim(),c=l[m];if(!c)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${o}`),!1;e.dataset.estado=m,Array.from(e.classList).forEach(t=>{t.startsWith("estado-")&&e.classList.remove(t)}),e.classList.add(c.cssClass),e.style.setProperty("--bg-estado",c.bgColor);const u=e.querySelector('[id^="contenedor-svg-"]');if(u){const t=u.querySelector("svg");t&&(t.style.background=c.bgColor)}const n=e.querySelector(".etiqueta-card")||e;return n&&(n.style.background=c.bgColor),s(e,m),f(e),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:p,estado:m,datosExtra:r}})),console.log(`‚úÖ Etiqueta ${p} actualizada a ${o}`),!0}function s(p,o){const r=p.querySelectorAll(".btn-fabricar"),g=["empaquetada","en-paquete"];r.forEach(e=>{g.includes(o)?(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",e.title=`Etiqueta ya ${o}`):(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",e.title="Fabricar esta etiqueta")})}function f(p){p.style.transition="transform 0.5s ease, background-color 0.5s ease",p.style.transform="scale(1.03)",setTimeout(()=>{p.style.transform="scale(1)"},400)}function h(p,o,r={}){console.log(`üîÑ Actualizando ${p.length} etiquetas...`);const e=p.map(m=>a(m,o,r)).filter(m=>m).length;return console.log(`‚úÖ ${e}/${p.length} etiquetas actualizadas`),e}function w(p){const o=String(p).replace(/\./g,"-"),r=document.querySelector(`#etiqueta-${o}`);return r?{id:p,estado:r.dataset.estado||"desconocido",elemento:r}:null}window.addEventListener("paquete:creado",p=>{const{codigoPaquete:o,etiquetaIds:r}=p.detail;console.log(`üì¶ Evento paquete:creado recibido - ${o} con ${r.length} etiquetas`),h(r,"empaquetada",{codigo_paquete:o})}),x.SistemaDOM={actualizarEstadoEtiqueta:a,actualizarMultiplesEtiquetas:h,obtenerEstadoActual:w,ESTADOS_CONFIG:l},x.ColoresEstado={actualizar:(p,o)=>{i[p]=o;const r=document.getElementById("colores-estado-css");if(r){let g=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[e,m]of Object.entries(i))g+=`.proceso.estado-${e} {
    --bg-estado: ${m};
}
`;r.textContent=g,console.log(`‚úÖ Color actualizado para estado "${p}": ${o}`)}},obtenerColor:p=>i[p],todos:()=>({...i})}})(window);function Tt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async o=>{var t,A,y;const r=o.target.closest(".btn-fabricar");if(!r)return;o.preventDefault();const g=(A=(t=document.getElementById("maquina-info"))==null?void 0:t.dataset)==null?void 0:A.maquinaId;if(!g){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const e=r.dataset.grupoId;if(e){const E=r.disabled;r.disabled=!0;try{await i(e,g)}finally{r.disabled=E}return}const m=String(r.dataset.etiquetaId||"").trim(),c=m.replace(/\./g,"-"),d=document.querySelector(`#etiqueta-${c}`);if(d){const E=(d.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(E)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${m} ya est√° en estado ${E}.`,timer:2500,showConfirmButton:!1});return}}const u=Number(((y=window.DIAMETRO_POR_ETIQUETA)==null?void 0:y[m])??0);if(!m){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!u&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const n=r.disabled;r.disabled=!0;try{await x(m,g,u)}finally{r.disabled=n}});async function x(o,r,g=null){var E,v,q,b;const e=`/actualizar-etiqueta/${o}/maquina/${r}`,m=(E=document.querySelector('meta[name="csrf-token"]'))==null?void 0:E.getAttribute("content"),c=o.replace(/\./g,"-"),u=(((q=(v=document.querySelector(`#etiqueta-${c}`))==null?void 0:v.dataset)==null?void 0:q.estado)||"").toLowerCase()==="fabricando",n=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",t=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",A=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(n&&t||A){if(u&&((b=window._decisionCortePorEtiqueta)!=null&&b[o])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:a});return}for(;;){let S;try{S=await Cortes.mejorCorteSimple(o,g,m)}catch(C){p(C);return}if(!S)return;if(S.accion==="optimizar"){let C;try{C=await Cortes.mejorCorteOptimizado(o,g,S.patrones,m)}catch(D){p(D);return}if((C==null?void 0:C.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[o]={longitudBarraCm:C.longitudBarraCm,etiquetas:C.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:a});return}else{if(C==="volver")continue;return}}if(S.accion==="fabricar_patron_simple"){const C=Math.round(Number(S.longitud_m||0)*100);if(!C){p("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[o]={longitudBarraCm:C,etiquetas:[{etiqueta_sub_id:o,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[o],csrfToken:m,etiquetaId:o,onUpdate:a});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await l(o,r,m)}catch(S){p(S)}return}try{const S=await fetch(e,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":m},body:JSON.stringify({})}),C=await S.json();if(!S.ok)throw new Error(C.message||"Error al actualizar");a(o,C)}catch(S){p(S)}}async function i(o,r){var c,d;const g=(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content"),e=document.querySelector(`[data-grupo-id="${o}"] .etiqueta-card`),m=(((d=e==null?void 0:e.dataset)==null?void 0:d.estado)||"pendiente").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(m)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${m}.`,timer:2500,showConfirmButton:!1});return}try{const u=await fetch(`/api/etiquetas/resumir/${o}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":g},body:JSON.stringify({maquina_id:r})}),n=await u.json();if(!u.ok||!n.success)throw new Error(n.message||"Error al actualizar grupo");const t=n.nuevo_estado||"actualizado";t==="fabricando"?w("info","Fabricando",`Grupo iniciado (${n.etiquetas_actualizadas||0} etiquetas)`):t==="completada"?w("success","¬°Completado!",`Grupo completado (${n.etiquetas_actualizadas||0} etiquetas)`):w("success","Actualizado",n.message),e&&(["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(A=>{e.classList.remove(`estado-${A}`)}),e.classList.add(`estado-${t}`),e.dataset.estado=t),typeof window.refrescarEtiquetasMaquina=="function"&&await window.refrescarEtiquetasMaquina()}catch(u){p(u)}}async function l(o,r,g){var N,T,O,B,V;const e=Number(((N=window.DIAMETRO_POR_ETIQUETA)==null?void 0:N[o])??0),c=Number(((T=window.LONGITUD_POR_ETIQUETA)==null?void 0:T[o])??0)/100;let d="";try{const P=await fetch(`/api/productos/sugerencias?diametro=${e}&longitud=${c}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":g}});if(P.ok){const $=await P.json();$.productos&&$.productos.length>0?d=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${e}mm x ${c.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${$.productos.map(z=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${z.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${z.codigo}</td>
                                                <td class="px-2 py-1">${z.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${z.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${z.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:d=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${e}mm x ${c.toFixed(1)}m</p>`}}catch(P){console.warn("No se pudieron cargar sugerencias:",P)}const{value:u,isConfirmed:n}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${d}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const P=document.getElementById("swal-input-producto").value;return!P||!P.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):P.trim()}});if(!n||!u)return;let t;try{const P=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(u.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":g}});if(!P.ok){const $=await P.json();throw new Error($.message||"Producto no encontrado")}t=await P.json()}catch(P){await Swal.fire({icon:"error",title:"Producto no encontrado",text:P.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${u}`});return}const A=(t.tipo||"").toLowerCase(),y=Number(t.diametro??0),E=Number(t.longitud??0);if(A&&A!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${t.codigo}</p>
                        <p><strong>Tipo:</strong> ${t.tipo||"N/A"}</p>
                    </div>
                `});return}if(y>0&&e>0&&Math.abs(y-e)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${y} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${e} mm</p>
                    </div>
                `});return}if(E>0&&c>0&&Math.abs(E-c)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${E.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${c.toFixed(2)} m</p>
                    </div>
                `});return}const v=t.longitud?`${t.longitud} m`:"N/A",{value:q,isConfirmed:b}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${t.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${t.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${v}</p>
                    <p><strong>Stock actual:</strong> ${((O=t.peso_stock)==null?void 0:O.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${t.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!b)return;const S=q==="completo",C=`/actualizar-etiqueta/${o}/maquina/${r}`,D=await fetch(C,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":g},body:JSON.stringify({producto_id:t.id,paquete_completo:S})}),M=await D.json();if(!D.ok)throw new Error(M.message||"Error al fabricar");const ct=((B=M.metricas)==null?void 0:B.peso_consumido)||0,H=((V=M.metricas)==null?void 0:V.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${t.codigo}</p>
                <p><strong>Peso consumido:</strong> ${ct.toFixed(2)} kg</p>
                ${H?`<p><strong>Paquete:</strong> ${H}</p>`:""}
                ${S?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),a(o,M),H&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const P=document.getElementById("codigo_paquete_mover");P&&(P.value=H,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function a(o,r){var e,m;const g=o.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:o,estado:r.estado,peso_etiqueta:r.peso_etiqueta,nombre:r.nombre,data_completa:r}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(o,r.estado,{peso:r.peso_etiqueta,nombre:r.nombre||o}):s(o,r.estado),r.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(o,r.coladas_por_elemento),(r.estado||"").toLowerCase()){case"cortando":w("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":w("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),f(g);break;case"fabricando":w("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":w("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),f(g),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(o,{id:o,peso_etiqueta:r.peso_etiqueta||0,estado:"fabricada",nombre:r.nombre||o}),r.elementos&&Array.isArray(r.elementos)&&r.elementos.length>0?r.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${o}`,r.elementos),h(o,r.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${o}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${o}`);break;case"completada":w("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(e=window._decisionCortePorEtiqueta)!=null&&e[o]&&(delete window._decisionCortePorEtiqueta[o],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),f(g),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(o,{id:o,peso_etiqueta:r.peso_etiqueta||0,estado:"completada",nombre:r.nombre||o}),r.elementos&&Array.isArray(r.elementos)&&r.elementos.length>0?r.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${o}`,r.elementos),h(o,r.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${o}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${o}`);break;case"ensamblando":w("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":w("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),f(g);break;case"soldando":w("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":w("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),f(g);break;default:console.warn(`Estado no manejado para etiqueta ${o}: ${r.estado}`),w("warning","Estado desconocido",`El estado recibido (${r.estado}) no est√° reconocido.`,3e3)}(m=r.productos_afectados)!=null&&m.length&&r.productos_afectados.forEach(c=>{const d=document.getElementById(`peso-stock-${c.id}`),u=document.getElementById(`progreso-texto-${c.id}`),n=document.getElementById(`progreso-barra-${c.id}`);d&&(d.textContent=`${c.peso_stock} kg`),u&&(u.textContent=`${c.peso_stock} / ${c.peso_inicial} kg`),n&&(n.style.height=`${c.peso_stock/c.peso_inicial*100}%`)})}function s(o,r){const g=o.replace(/\./g,"-"),e=document.getElementById("etiqueta-"+g);if(!e)return;e.dataset.estado=String(r||"").toLowerCase(),e.className=e.className.split(" ").filter(d=>!d.startsWith("estado-")).join(" ").trim(),e.classList.add("estado-"+e.dataset.estado);const m=e.querySelector('[id^="contenedor-svg-"]'),c=m==null?void 0:m.querySelector("svg");c&&(c.style.background=getComputedStyle(e).getPropertyValue("--bg-estado").trim())}function f(o){const r=`#etiqueta-${CSS.escape(o)}`,g=document.querySelector(r),e=Array.from(document.querySelectorAll(".proceso")),m=y=>(y||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),c=y=>{var q;const E=(q=y.dataset)==null?void 0:q.estado;if(E)return m(E);const v=y.querySelector('[id^="estado-"]');return m((v==null?void 0:v.textContent)||(v==null?void 0:v.innerText)||"")},d=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),u=y=>d.has(c(y)),n=g?e.indexOf(g):-1,A=(n>=0?e.slice(n+1):e).find(y=>!u(y));A?A.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function h(o,r){var d;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${o}`),!r||!Array.isArray(r)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${o}`);return}if(r.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${o}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const g=window.elementosAgrupadosScript.findIndex(u=>{var n;return((n=u.etiqueta)==null?void 0:n.etiqueta_sub_id)===o});if(g===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${o}`);return}window.elementosAgrupadosScript[g].elementos=r;const e=window.elementosAgrupadosScript[g],m=(d=e.etiqueta)==null?void 0:d.id;if(!m){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${o}`);return}const c=document.getElementById("contenedor-svg-"+m);if(!c){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${o} (id: ${m})`);return}try{const u=c.querySelector("svg");u&&u.remove();const n=600,t=150,A=c.closest(".proceso"),y=A&&getComputedStyle(A).getPropertyValue("--bg-estado").trim()||"#e5e7eb",E=document.createElementNS("http://www.w3.org/2000/svg","svg");E.setAttribute("viewBox",`0 0 ${n} ${t}`),E.setAttribute("preserveAspectRatio","xMidYMid meet"),E.style.width="100%",E.style.height="100%",E.style.display="block",E.style.background=y;const v=(e.elementos||[]).map((b,S)=>{var H,N,T;const C=b.barras!=null?b.barras:0;let D="N/A";if(b.diametro!=null&&b.diametro!==""){const B=String(b.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(B){const V=parseFloat(B[0]);isFinite(V)&&(D=String(Math.round(V)))}}const M=[];(H=b.coladas)!=null&&H.colada1&&M.push(b.coladas.colada1),(N=b.coladas)!=null&&N.colada2&&M.push(b.coladas.colada2),(T=b.coladas)!=null&&T.colada3&&M.push(b.coladas.colada3);const ct=M.length>0?` (${M.join(", ")})`:"";return{letter:indexToLetters(S),text:`√ò${D} x${C}${ct}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(E,v,n,t):console.error("‚ùå drawLegendBottomLeft no est√° definida");const q=document.createElementNS("http://www.w3.org/2000/svg","text");q.setAttribute("x",n/2),q.setAttribute("y",t/2),q.setAttribute("text-anchor","middle"),q.setAttribute("fill","#059669"),q.setAttribute("font-size","14"),q.setAttribute("font-weight","600"),q.textContent="‚úì Coladas actualizadas",E.appendChild(q),c.appendChild(E),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${o}`),setTimeout(()=>{q&&q.parentNode&&q.remove()},2e3)}catch(u){console.error(`‚ùå Error al actualizar SVG para etiqueta ${o}:`,u),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function w(o,r,g,e=2e3){Swal.fire({icon:o,title:r,text:g,timer:e,showConfirmButton:!1})}function p(o){Swal.fire({icon:"error",title:"Error",text:o.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=a}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);(function(x){let i=[],l=!1,a=null;async function s(d){var n;const u=`/etiquetas/${encodeURIComponent(d)}/validar-para-paquete`;try{const t=await fetch(u,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content}});if(!(t.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const y=await t.json();if(console.log("üîç validarEtiqueta response:",{status:t.status,data:y,peso_etiqueta:y.peso_etiqueta}),!t.ok)throw new Error((y==null?void 0:y.message)||(y==null?void 0:y.motivo)||"Error al validar");return y}catch(t){throw t}}function f(d,u){const n=u.id||d;if(i.some(y=>y.id===n))return!1;const t=parseFloat(u.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:d,id:n,peso_etiqueta_recibido:u.peso_etiqueta,peso_parseado:t,data_completa:u});const A={id:n,type:"etiqueta",peso:t,estado:u.estado||"desconocido",nombre:u.nombre||"Sin nombre"};return i.push(A),r(),!0}function h(d){const u=i.findIndex(n=>n.id===d);u>=0&&i.splice(u,1),r()}function w(){i=[],r()}function p(){return i.reduce((d,u)=>d+(parseFloat(u.peso)||0),0)}function o(){return i}function r(){const d=document.getElementById("itemsList");if(!d)return;d.innerHTML="";for(const t of i){const A=document.createElement("li");A.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",A.dataset.code=t.id,A.innerHTML=`
                <div>
                    <div class="font-semibold">${t.id} === ${t.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,A.querySelector("button").onclick=()=>h(t.id),d.appendChild(A)}const u=p(),n=document.createElement("li");n.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",n.textContent=`Total: ${u.toFixed(2)} kg (${i.length} etiquetas)`,d.appendChild(n)}async function g(){var y,E,v;if(!i.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const d=Number(((E=(y=document.getElementById("maquina-info"))==null?void 0:y.dataset)==null?void 0:E.maquinaId)||window.maquinaId),u=Number(((v=document.getElementById("ubicacion-id"))==null?void 0:v.value)||window.ubicacionId),n=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!d){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!n&&!u){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const t={items:i.map(q=>({id:q.id,type:q.type})),maquina_id:d,ubicacion_id:n?null:u,sin_ubicacion:n},A=async(q={})=>{var C;const b=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(C=document.querySelector('meta[name="csrf-token"]'))==null?void 0:C.content},body:JSON.stringify({...t,...q})}),S=await b.json();if(!b.ok)throw new Error(S.message||"Error al crear el paquete");return S};try{const q=await A();if(q.success)return e(q);if(q.warning){let b="<div style='text-align:left;'>Se detectaron advertencias:";for(const[C,D]of Object.entries(q.warning))Array.isArray(D)&&D.length&&(b+=`<br><strong>${C.replaceAll("_"," ")}:</strong> ${D.join(", ")}`);if(b+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:b,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const C=await A({confirmar:!0});if(C.success)return e(C);throw new Error(C.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(q){await Swal.fire("Error",q.message||"Error inesperado","error")}}async function e(d){var y;const u=d.codigo_paquete||((y=d.paquete)==null?void 0:y.codigo)||"N/D",n=p(),t=[...i.map(E=>E.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${u}</strong> creado correctamente</p>
                       <p>${t.length} etiquetas ¬∑ ${n.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),w(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const E=document.getElementById("codigo_paquete_mover");E&&(E.value=u,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${u}</strong> creado correctamente</p><p>${t.length} etiquetas ¬∑ ${n.toFixed(2)} kg</p>`}),w()),console.log(`üì¶ Disparando evento paquete:creado para ${u}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:u,etiquetaIds:t,pesoTotal:n}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),t.forEach(E=>{m(E,u)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function m(d,u){const n=String(d).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${n}`);if(!t){console.warn(`‚ùå No se encontr√≥ elemento: ${d}`);return}console.log(`üîÑ Actualizando manualmente: ${d}`),Array.from(t.classList).forEach(b=>{b.startsWith("estado-")&&t.classList.remove(b)}),t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.style.setProperty("--bg-estado","#e3e4FA");const y=t.querySelector('[id^="contenedor-svg-"]');if(y){const b=y.querySelector("svg");b&&(b.style.background="#e3e4FA")}const E=t.querySelector(".etiqueta-card")||t;E&&(E.style.background="#e3e4FA");const v=t.querySelector("h3");if(v&&!t.querySelector(".paquete-info")){const b=document.createElement("div");b.className="paquete-info text-sm font-semibold mt-2 no-print",b.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",b.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${u}</span>
            `,v.parentNode.insertBefore(b,v.nextSibling)}t.querySelectorAll(".btn-fabricar").forEach(b=>{b.disabled=!0,b.style.opacity="0.5",b.style.cursor="not-allowed"}),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${d} actualizada manualmente`)}function c(){if(l)return;l=!0;const d=document.getElementById("qrItem");d&&(d.addEventListener("change",()=>d.dispatchEvent(new Event("input"))),d.addEventListener("input",async function(){const n=this.value.trim();if(n)try{const t=await s(n);if(!t.valida){await Swal.fire("Etiqueta no v√°lida",t.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}f(n,t)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(t){console.error("Error de validaci√≥n:",t),await Swal.fire("Error",t.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const u=document.getElementById("crearPaqueteBtn");u&&u.addEventListener("click",g),document.addEventListener("focus",function(n){n.target.id&&n.target.id.startsWith("input-etiqueta-")&&(a=n.target,console.log("üéØ Focus en input:",n.target.id))},!0),document.addEventListener("click",async function(n){var t;if(n.target.classList.contains("btn-agregar-carro")||n.target.closest(".btn-agregar-carro")){const y=(n.target.classList.contains("btn-agregar-carro")?n.target:n.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!y){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const E=document.querySelector(`[x-show="tabActivo === 'crear'"]`),v=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(E&&window.getComputedStyle(E).display,v&&window.getComputedStyle(v).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let b=document.activeElement;(!b||!((t=b.id)!=null&&t.startsWith("input-etiqueta-")))&&(b=a),(!b||!document.body.contains(b))&&(b=document.querySelector('input[id^="input-etiqueta-"]')),b?(b.value=y,b.focus(),b.classList.add("ring-4","ring-green-400"),setTimeout(()=>{b.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${y} a√±adida al input:`,b.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",y);try{const b=await s(y);if(!b.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:b.motivo||"Motivo no especificado"});return}f(y,b)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(b){console.error("Error al a√±adir al carro:",b),await Swal.fire({icon:"error",title:"Error",text:b.message||"No se pudo a√±adir al carro"})}}if(n.target.classList.contains("btn-agregar-carro-grupo")||n.target.closest(".btn-agregar-carro-grupo")){const A=n.target.classList.contains("btn-agregar-carro-grupo")?n.target:n.target.closest(".btn-agregar-carro-grupo"),y=A.dataset.grupoId;let E=[];try{E=JSON.parse(A.dataset.etiquetas||"[]")}catch(S){console.error("Error parseando etiquetas del grupo:",S);return}if(!E.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${E.length} etiquetas del grupo ${y} al carro`);let v=0,q=0,b=0;for(const S of E)try{const C=await s(S.id);if(!C.valida){b++;continue}f(S.id,C)?v++:q++}catch{b++}v>0?await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${v}</strong> etiquetas al carro.</p>
                            ${q>0?`<p class="text-gray-500">${q} ya estaban en el carro.</p>`:""}
                            ${b>0?`<p class="text-red-500">${b} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1}):q>0?await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."}):await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",text:"Las etiquetas del grupo no son v√°lidas para a√±adir al carro."})}})}x.TrabajoPaquete={inicializar:c,agregarItemEtiqueta:f,eliminarItem:h,limpiarCarro:w,obtenerItems:o,calcularPesoTotal:p,crearPaquete:g,validarEtiqueta:s,actualizarListaVisual:r},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c(),document.addEventListener("livewire:navigated",c)})(window);function Dt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(i,l){const a=document.getElementById("grid-maquina");if(!a)return;console.log("üîß Actualizando clases:",{showLeft:i,showRight:l,clasesAnteriores:a.className}),i||l?a.classList.add("columnas-laterales-visibles"):a.classList.remove("columnas-laterales-visibles"),i&&l?a.classList.add("ambas-columnas"):a.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",a.className),a.offsetHeight,a.querySelectorAll(".etiqueta-card").forEach(f=>{f.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,l)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,l)});function x(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((f,h)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),h.disconnect();const p=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(p,o)}}).observe(document.body,{childList:!0,subtree:!0});return}const l=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,a),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}x()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const x={debounceTime:500};let i=0;async function l(g){var c;const e=Date.now();if(e-i<x.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};i=e;const m=(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content");if(!m)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${g}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const u=await fetch(`/etiquetas/${encodeURIComponent(g)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":m}}),n=await u.json();return!u.ok||!n.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:n.message||"No se pudo revertir el cambio."}),{success:!1,message:n.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${n.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${n.estado}</strong>
                    </p>
                    ${n.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),h(g,n),n)}catch(d){return console.error("Error al deshacer etiqueta:",d),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:d.message}}}async function a(g){try{const e=await fetch(`/etiquetas/${encodeURIComponent(g)}/puede-deshacer`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{puede_deshacer:!1}}catch(e){return console.error("Error al verificar undo:",e),{puede_deshacer:!1}}}async function s(g){try{const e=await fetch(`/etiquetas/${encodeURIComponent(g)}/historial`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{success:!1,historial:[]}}catch(e){return console.error("Error al obtener historial:",e),{success:!1,historial:[]}}}async function f(g){var c;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const e=await s(g);if(!e.success||!((c=e.historial)!=null&&c.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const m=e.historial.map((d,u)=>`
            <tr class="${d.revertido?"bg-gray-100 text-gray-400":u===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${d.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${d.accion}</td>
                <td class="px-2 py-1 text-xs">${d.estado_anterior||"-"} ‚Üí ${d.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${d.revertido?'<span class="text-gray-400">Revertido</span>':u===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${g}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${m}</tbody>
                    </table>
                </div>
                ${e.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${e.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:e.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:e.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:e.puede_deshacer?"#f59e0b":"#6b7280"}).then(d=>{d.isConfirmed&&e.puede_deshacer&&l(g)})}function h(g,e){const m=g.replace(/\./g,"-"),c=document.getElementById(`etiqueta-${m}`);if(!c){console.warn(`Elemento etiqueta-${m} no encontrado en DOM`),typeof window.refrescarEtiquetasMaquina=="function"&&window.refrescarEtiquetasMaquina();return}c.dataset.estado=e.estado,c.className=c.className.split(" ").filter(n=>!n.startsWith("estado-")).join(" ").trim(),c.classList.add(`estado-${e.estado}`);const d=c.querySelector('[id^="contenedor-svg-"]'),u=d==null?void 0:d.querySelector("svg");u&&(u.style.background=getComputedStyle(c).getPropertyValue("--bg-estado").trim()),w(g,e.puede_deshacer),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(g,e.estado),console.log(`‚úÖ DOM actualizado para ${g}: estado = ${e.estado}`)}function w(g,e){const m=g.replace(/\./g,"-"),c=document.querySelector(`#etiqueta-${m} .btn-deshacer`);c&&(c.disabled=!e,c.classList.toggle("opacity-50",!e),c.classList.toggle("cursor-not-allowed",!e),c.title=e?"Deshacer √∫ltimo cambio":"No hay cambios para deshacer")}function p(){document.addEventListener("click",async g=>{const e=g.target.closest(".btn-deshacer");if(!e)return;g.preventDefault(),g.stopPropagation();const m=e.dataset.etiquetaId;if(!m){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await l(m)}),document.addEventListener("click",async g=>{const e=g.target.closest(".btn-historial");if(!e)return;g.preventDefault(),g.stopPropagation();const m=e.dataset.etiquetaId;m&&await f(m)}),console.log("‚úÖ Event listeners de historial inicializados")}function o(){let g=null;window.addEventListener("etiqueta-fabricada",e=>{var m;(m=e.detail)!=null&&m.etiquetaSubId&&(g=e.detail.etiquetaSubId)}),document.addEventListener("keydown",async e=>{var m,c;if(e.ctrlKey&&e.key==="z"&&!e.shiftKey){if(["INPUT","TEXTAREA"].includes((m=document.activeElement)==null?void 0:m.tagName))return;const d=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),u=((c=d==null?void 0:d.dataset)==null?void 0:c.etiquetaId)||g;u&&(e.preventDefault(),await l(u))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function r(){p(),o(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:l,puedeDeshacer:a,obtenerHistorial:s,mostrarHistorial:f,actualizarBoton:w},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r(),document.addEventListener("livewire:navigated",r)})();
