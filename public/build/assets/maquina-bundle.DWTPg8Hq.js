const Xt="rgba(0, 0, 0, 0.8)",$t="rgba(0, 0, 0, 1)",zt="rgba(0, 0, 0, 1)";function Ht(y,s){return!s||s===1?y.map(a=>({...a})):y.map(a=>a.type==="line"?{...a,length:(a.length||0)*s}:a.type==="arc"?{...a,radius:(a.radius||0)*s}:{...a})}const Vt=.75,Bt=14,Yt=60,Ot=[0,10,-10,20,-20,30,-30];function G(y){return y*Math.PI/180}function Ut(y){const s=y.closest(".proceso");return s&&getComputedStyle(s).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Wt(y,s,a){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.setAttribute("viewBox","0 0 "+y+" "+s),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.style.width="100%",o.style.height="100%",o.style.display="block",o.style.background=a||"#ffffff",o.style.shapeRendering="geometricPrecision",o.style.textRendering="optimizeLegibility",o.style.boxSizing="border-box",o}function Jt(y,s,a,o){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",s),n.setAttribute("stroke",a),n.setAttribute("fill","none"),n.setAttribute("stroke-width",o),n.setAttribute("vector-effect","non-scaling-stroke"),y.appendChild(n),n}function Ft(y){let s="",a=Number(y)||0;for(;a>=0;){const o=a%26;s=String.fromCharCode(65+o)+s,a=Math.floor(a/26)-1}return s}const Qt=0,Kt=-25;function Zt(y,s,a,o){if(!s||!s.length)return;const n=2,m=12,c=m+n,w=s.map(b=>(b.letter?b.letter+" ":"")+(b.text||"")),t=m*w.length+n*(w.length-1),i=Qt;let g=o-Kt-t+m/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let b=0;b<w.length;b++){const u=w[b],f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",i),f.setAttribute("y",g),f.setAttribute("fill",zt),f.setAttribute("font-size",m),f.setAttribute("text-anchor","start"),f.setAttribute("alignment-baseline","middle"),f.style.pointerEvents="none",f.textContent=u,y.appendChild(f);const l=Ct(u,m).w;window.__legendBoxesGroup.push({left:i,right:i+l,top:g-m/2,bottom:g+m/2}),g+=c}}function te(y){const s=(y||"").split(/\s+/).filter(Boolean),a=[];for(let o=0;o<s.length;o++){const n=s[o];if(n.endsWith("r")){const m=parseFloat(n.slice(0,-1));let c=360;o+1<s.length&&s[o+1].endsWith("d")&&(c=parseFloat(s[++o].slice(0,-1))),a.push({type:"arc",radius:m,arcAngle:c})}else n.endsWith("d")?a.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):a.push({type:"line",length:parseFloat(n)})}return a}function ee(y){let s=[],a=0,o=0,n=0;s.push({x:a,y:o});for(let m=0;m<y.length;m++){const c=y[m];if(c.type==="line")a+=c.length*Math.cos(G(n)),o+=c.length*Math.sin(G(n)),s.push({x:a,y:o});else if(c.type==="turn")n+=c.angle;else if(c.type==="arc"){const w=a+c.radius*Math.cos(G(n+90)),t=o+c.radius*Math.sin(G(n+90)),i=Math.atan2(o-t,a-w),g=i+G(c.arcAngle);a=w+c.radius*Math.cos(g),o=t+c.radius*Math.sin(g),n+=c.arcAngle,s.push({x:a,y:o})}}return s}function Gt(y){let s=[],a=0,o=0,n=0;for(let m=0;m<y.length;m++){const c=y[m];if(c.type==="line"){const w={x:a,y:o},t={x:a+c.length*Math.cos(G(n)),y:o+c.length*Math.sin(G(n))};s.push({start:w,end:t,length:c.length}),a=t.x,o=t.y}else if(c.type==="turn")n+=c.angle;else if(c.type==="arc"){const w=a+c.radius*Math.cos(G(n+90)),t=o+c.radius*Math.sin(G(n+90)),i=Math.atan2(o-t,a-w),g=i+G(c.arcAngle);a=w+c.radius*Math.cos(g),o=t+c.radius*Math.sin(g),n+=c.arcAngle}}return s}function Ct(y,s){const a=s||12;return{w:(y?y.length:0)*a*.55,h:a}}function et(y,s,a){const o=a||0;return!(y.right+o<s.left||y.left-o>s.right||y.bottom+o<s.top||y.top-o>s.bottom)}function It(y,s,a,o){const n=s/2;return Math.max(a+n,Math.min(o-n,y))}function oe(y,s){const o=[];let n=0;function m(){n>1e-9&&(o.push({type:"line",length:n}),n=0)}for(let c=0;c<y.length;c++){const w=y[c];if(w.type==="line"){n+=w.length;continue}if(w.type==="turn"){if(Math.abs(w.angle)<1e-9)continue;m(),o.push(w);continue}if(w.type==="arc"){m(),o.push(w);continue}m(),o.push(w)}return m(),o}function jt(y,s){const a=s&&s.decimals||0,o=s&&s.step||null;let n=Number(y||0);return o&&o>0&&(n=Math.round(n/o)*o),n.toFixed(a).replace(/\.0+$/,"")}function ne(y,s){const a=Math.hypot(y,s)||1;let o=y/a,n=s/a;return(n<-1e-9||Math.abs(n)<=1e-9&&o<0)&&(o=-o,n=-n),{ux:o,uy:n}}function Rt(y,s,a){const o=a||.01,n=ne(y,s),m=Math.round(n.ux/o)*o,c=Math.round(n.uy/o)*o;return m+"|"+c}function ae(y,s,a){const o=a&&a.dirPrecision||.01,n=a&&a.labelFormat||{decimals:0,step:null},m=y.reduce((f,l)=>f+Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y),0),c=s.reduce((f,l)=>f+(l.length||Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y)),0),w=c>0?m/c:1,t=new Map;for(let f=0;f<s.length;f++){const l=s[f],p=l.end.x-l.start.x,d=l.end.y-l.start.y,r=Rt(p,d,o),e=t.get(r)||[];e.push({length:l.length||Math.hypot(p,d),index:f}),t.set(r,e)}const i=s.map(f=>f.length||Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y)),g=new Set,b=new Set,u=[];for(let f=0;f<y.length;f++){const l=y[f],p=l.end.x-l.start.x,d=l.end.y-l.start.y,r=Rt(p,d,o),e=t.get(r)||[],E=Math.hypot(p,d);let h=E;if(e.length){const S=E/w;let x=null,q=1/0;for(const L of e){const I=Math.abs(L.length-S),v=b.has(L.index)?.1:0;I+v<q&&(x=L,q=I+v)}x&&(h=x.length,b.add(x.index))}else f<i.length&&(h=i[f]);const A=jt(h,n),M=r+"|"+A;g.has(M)||(g.add(M),u.push({start:l.start,end:l.end,_dirKey:r,_label:A,_lenChosen:h}))}return u}function se(y,s){const a=s,o=y.map(d=>Object.assign({},d));let n=0,m=0,c=0;const w=[];let t=null,i=-1,g=-1;const b=1e-7;function u(d){return d*Math.PI/180}function f(d){return Math.abs(Math.sin(u(d)))<1e-12}function l(d,r,e,E){return Math.min(r,E)-Math.max(d,e)>b}for(let d=0;d<o.length;d++){let e=function(){const S={x:Math.cos(u(c)),y:Math.sin(u(c))},x=n+o[d].length*S.x,q=m+o[d].length*S.y,L=f(c);for(let I=0;I<w.length;I++){const v=w[I];if(L&&v.horiz&&Math.abs(m-v.y)<b){if(l(Math.min(n,x),Math.max(n,x),Math.min(v.x1,v.x2),Math.max(v.x1,v.x2))&&t&&i>=0&&g>=0)return o[g].length+=a,n+=t.x*a,m+=t.y*a,w[i].x2+=t.x*a,w[i].y2+=t.y*a,!0}else if(!L&&!v.horiz&&Math.abs(n-v.x)<b&&l(Math.min(m,q),Math.max(m,q),Math.min(v.y1,v.y2),Math.max(v.y1,v.y2))&&t&&i>=0&&g>=0)return o[g].length+=a,n+=t.x*a,m+=t.y*a,w[i].x2+=t.x*a,w[i].y2+=t.y*a,!0}return!1};var p=e;const r=o[d];if(r.type==="turn"){c+=r.angle;continue}if(r.type==="arc"){const S=n+r.radius*Math.cos(u(c+90)),x=m+r.radius*Math.sin(u(c+90)),q=Math.atan2(m-x,n-S),L=q+u(r.arcAngle);n=S+r.radius*Math.cos(L),m=x+r.radius*Math.sin(L),c+=r.arcAngle,t=null;continue}for(;e(););const E={x:Math.cos(u(c)),y:Math.sin(u(c))},h=n+o[d].length*E.x,A=m+o[d].length*E.y,M=f(c);w.push({x1:n,y1:m,x2:h,y2:A,horiz:M,y:m,x:n}),t=E,i=w.length-1,g=d,n=h,m=A}return o}function At(y,s,a,o){const n=G(o),m=Math.cos(n),c=Math.sin(n),w=y.x-s,t=y.y-a;return{x:s+w*m-t*c,y:a+w*c+t*m}}function ie(y,s,a,o,n,m,c,w,t){let i="",g=0,b=0,u=0,f=!1;function l(d,r){const e=At({x:d,y:r},s,a,o);return{x:w+(e.x-m)*n,y:t+(e.y-c)*n}}function p(){if(!f){const d=l(g,b);i+="M "+d.x+" "+d.y,f=!0}}for(let d=0;d<y.length;d++){const r=y[d];if(r.type==="turn"){u+=r.angle;continue}if(r.type==="line"){const e=g+r.length*Math.cos(G(u)),E=b+r.length*Math.sin(G(u));p();const h=l(e,E);i+=" L "+h.x+" "+h.y,g=e,b=E;continue}if(r.type==="arc"){const e=g+r.radius*Math.cos(G(u+90)),E=b+r.radius*Math.sin(G(u+90)),h=Math.atan2(b-E,g-e),A=h+G(r.arcAngle),M=e+r.radius*Math.cos(A),S=E+r.radius*Math.sin(A),x=Math.abs(r.arcAngle)%360;if(p(),x<1e-6||Math.abs(r.arcAngle)>=359.9){const K=h+Math.sign(r.arcAngle)*Math.PI,V=e+r.radius*Math.cos(K),k=E+r.radius*Math.sin(K),D=l(V,k),O=l(g,b),$=r.radius*n,B=r.arcAngle>=0?1:0;i+=" A "+$+" "+$+" 0 1 "+B+" "+D.x+" "+D.y,i+=" A "+$+" "+$+" 0 1 "+B+" "+O.x+" "+O.y,u+=r.arcAngle;continue}const q=l(M,S),L=r.radius*n,I=x>180?1:0,v=r.arcAngle>=0?1:0;i+=" A "+L+" "+L+" 0 "+I+" "+v+" "+q.x+" "+q.y,g=M,b=S,u+=r.arcAngle}}return i||"M 0 0"}function re(y){const s=ee(y);let a=Math.min(...s.map(p=>p.x)),o=Math.max(...s.map(p=>p.x)),n=Math.min(...s.map(p=>p.y)),m=Math.max(...s.map(p=>p.y));const c=(a+o)/2,w=(n+m)/2,i=m-n>o-a?-90:0,g=s.map(p=>At(p,c,w,i));a=Math.min(...g.map(p=>p.x)),o=Math.max(...g.map(p=>p.x)),n=Math.min(...g.map(p=>p.y)),m=Math.max(...g.map(p=>p.y));const b=Math.max(1,o-a),u=Math.max(1,m-n),f=(a+o)/2,l=(n+m)/2;return{rotDeg:i,w:b,h:u,cxModel:c,cyModel:w,midX:f,midY:l,ptsRot:g}}function ce(y){const s=[];let a=0,o=0,n=0;function m(c){const w=G(c);return{x:Math.cos(w),y:Math.sin(w)}}for(let c=0;c<y.length;c++){const w=y[c];if(w.type==="line")a+=w.length*Math.cos(G(n)),o+=w.length*Math.sin(G(n));else if(w.type==="turn"){const t=m(n),i=w.angle;n+=i;const g=m(n);s.push({x:a,y:o,angleDeg:i,prevDir:t,nextDir:g})}else if(w.type==="arc"){const t=a+w.radius*Math.cos(G(n+90)),i=o+w.radius*Math.sin(G(n+90)),g=Math.atan2(o-i,a-t),b=g+G(w.arcAngle);a=t+w.radius*Math.cos(b),o=i+w.radius*Math.sin(b),n+=w.arcAngle}}return s}function le(y,s,a){const o=Array.from({length:s},()=>({sumH:0,maxW:0,items:[]})),n=[...y.keys()].sort((m,c)=>y[c].h-y[m].h);for(const m of n){let c=0,w=1/0;for(let i=0;i<s;i++){const g=o[i],b=g.sumH+(g.items.length>0?a:0)+y[m].h;b<w&&(w=b,c=i)}const t=o[c];t.sumH=t.items.length>0?t.sumH+a+y[m].h:t.sumH+y[m].h,t.maxW=Math.max(t.maxW,y[m].w),t.items.push(m)}return o}function de(y,s,a,o={}){const n=o.padding??12,m=o.gapCol??12,c=o.gapRow??10,w=Math.max(1,Math.min(y.length,o.kMax??4)),t=Math.max(10,s-2*n),i=Math.max(10,a-2*n),g=b(y);function b(e){const E=e.map($=>$.w/Math.max($.h,1)),h=e.map($=>$.h),A=e.map($=>$.w),M=e.map($=>$.w*$.h),S=$=>$.reduce((B,nt)=>B+nt,0)/$.length,x=($,B)=>$.reduce((nt,ot)=>nt+Math.pow(ot-B,2),0)/$.length,q=($,B)=>Math.sqrt(x($,B)),L=S(E),I=S(h),v=S(A),K=M.reduce(($,B)=>$+B,0),V=q(h,I),k=q(A,v),D=I>0?V/I:0,O=v>0?k/v:0;return{avgAspectRatio:L,avgHeight:I,avgWidth:v,totalArea:K,heightCV:D,widthCV:O,isLinear:L>6||I<v*.12,isUniformHeight:D<.15,isUniformWidth:O<.15,isHighlyVariable:D>.5||O>.5,count:e.length}}let u={S:0,k:1,cols:null,score:0};for(let e=1;e<=w;e++){const E=le(y,e,c),h=E.reduce((ot,T)=>ot+T.maxW,0)+m*(e-1),A=Math.max(...E.map(ot=>ot.sumH));if(h<=0||A<=0)continue;const M=t/h,S=i/A,x=Math.min(M,S),q=Math.max(.01,x*.92),L=g.totalArea*q*q,I=t*i,v=L/I,K=E.map(ot=>ot.sumH*q),V=K.reduce((ot,T)=>ot+T,0)/e,k=Math.max(...K)-Math.min(...K),D=V>0?1-k/V:1,O=e===1?1.1:e===2?.9:.7,$=e>g.count*.5?.7:1,B=D>.85?1.05:1,nt=q*(1+v*.25)*(1+D*.1)*O*$*B;nt>u.score&&(u={S:q,k:e,cols:E,score:nt,efficiency:v,colBalance:D})}const f=u.cols.map(e=>e.maxW*u.S),l=f.reduce((e,E)=>e+E,0);let p=[];if(u.k===1)p[0]=s/2;else{const e=(u.k-1)*m,E=l+e;if(E<t){const h=t-E,A=m+h/(u.k-1);let M=n;for(let S=0;S<u.k;S++)p[S]=M+f[S]/2,M+=f[S]+A}else{let h=n+Math.max(0,(t-E)/2);for(let A=0;A<u.k;A++)p[A]=h+f[A]/2,h+=f[A]+m}}const d=[],r=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(e=>e.right));for(let e=0;e<u.k;e++){const E=u.cols[e];d[e]=[];const h=E.items.map(k=>y[k].h*u.S),A=h.reduce((k,D)=>k+D,0);if(E.items.length===0)continue;const M=p[e],S=u.cols[e].maxW*u.S,x=M-S/2,q=M+S/2,L=r(),v=Math.max(0,Math.min(q,L)-x)/S,K=v>.05;let V=i;if(K&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const D=Math.min(...window.__legendBoxesGroup.map(O=>O.top))-15;V=Math.max(10,D-n),console.log(`üìè Columna ${e}: X=${x.toFixed(0)}-${q.toFixed(0)}, legendWidth=${L.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura reducida a ${V.toFixed(0)}px`)}else console.log(`üìè Columna ${e}: X=${x.toFixed(0)}-${q.toFixed(0)}, legendWidth=${L.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura completa ${V.toFixed(0)}px`);if(E.items.length===1){const k=h[0],D=n+V/2,O=Math.max(n+k/2,Math.min(D,a-n-k/2));d[e].push(O);continue}if(A>V){console.warn(`Columna ${e}: elementos no caben (${A}px > ${V}px)`);const O=A/E.items.length<4?20:5;let $=n;for(let B=0;B<E.items.length;B++){const nt=Math.max(h[B],2),ot=$+nt/2;d[e].push(ot),$+=nt+O}}else{const k=V-A,D=E.items.length-1;let O=k/D;A/E.items.length<4?O=Math.max(18,Math.min(O,50)):O=Math.max(5,O);const nt=A+D*O,ot=V-nt;let T=n+Math.max(0,ot/2);for(let st=0;st<E.items.length;st++){const dt=Math.max(h[st],2),C=T+dt/2,H=n+V-dt/2,N=Math.max(n+dt/2,Math.min(C,H));d[e].push(N),T+=dt+O}}}return{S:u.S,k:u.k,cols:u.cols,centersX:p,centersYByCol:d,padding:n,gapRow:c,gapCol:m}}window.renderizarGrupoSVG=function(s,a){const o=s&&s.etiqueta&&s.etiqueta.id!=null?s.etiqueta.id:s&&s.id!=null?s.id:a,n=document.getElementById("contenedor-svg-"+o);if(!n)return;const m=600,c=150,w=Ut(n),t=Wt(m,c,w);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const i=(s.elementos||[]).map((l,p)=>{var h,A,M;const d=l.barras!=null?l.barras:0;let r="N/A";if(l.diametro!=null&&l.diametro!==""){const x=String(l.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(x){const q=parseFloat(x[0]);isFinite(q)&&(r=String(Math.round(q)))}}const e=[];(h=l.coladas)!=null&&h.colada1&&e.push(l.coladas.colada1),(A=l.coladas)!=null&&A.colada2&&e.push(l.coladas.colada2),(M=l.coladas)!=null&&M.colada3&&e.push(l.coladas.colada3);const E=e.length>0?` (${e.join(", ")})`:"";return{letter:Ft(p),text:`√ò${r} x${d}${E}`}});Zt(t,i,m,c);const g=s.elementos.map(l=>{const p=te(l.dimensiones||""),d=oe(p);let r=0;for(const M of d)M.type==="line"&&(r=Math.max(r,Math.abs(M.length||0))),M.type==="arc"&&(r=Math.max(r,Math.abs(M.radius||0)));const E=r<=50?2:1,h=Ht(d,E),A=re(h);return{dimsRaw:p,dimsNoZero:d,dimsScaled:h,geomScale:E,medida:A}}),b=g.map(l=>l.medida),u=de(b,m,c,{padding:20,gapCol:50,gapRow:22,kMax:3}),f=new Map;for(let l=0;l<u.k;l++)u.cols[l].items.forEach((p,d)=>f.set(p,{c:l,j:d}));s.elementos.forEach(function(l,p){const{dimsNoZero:d,dimsScaled:r,medida:e}=g[p],E=f.get(p),h=u.centersX[E.c],A=u.centersYByCol[E.c][E.j],M=u.S,S=e.ptsRot.map(T=>({x:h+(T.x-e.midX)*M,y:A+(T.y-e.midY)*M})),x=Math.min(...S.map(T=>T.x)),q=Math.max(...S.map(T=>T.x)),L=Math.min(...S.map(T=>T.y)),I=Math.max(...S.map(T=>T.y)),v={left:x,right:q,top:L,bottom:I};window.__figBoxesGroup.push({...v});const K=se(r,.6),V=ie(K,e.cxModel,e.cyModel,e.rotDeg,M,e.midX,e.midY,h,A),k=Jt(t,V,Xt,2);(function(){const st=ce(r);function dt(_){return Math.abs(Math.abs(_)-90)>=Vt}const C=(_,P)=>At({x:_.x,y:_.y},0,0,P),H=(_,P)=>{const Y=At({x:_,y:P},e.cxModel,e.cyModel,e.rotDeg);return{x:h+(Y.x-e.midX)*M,y:A+(Y.y-e.midY)*M}},N=_=>Math.max(10,Math.min(28,_));st.forEach(_=>{if(!dt(_.angleDeg))return;const P=H(_.x,_.y),Y=C(_.prevDir,e.rotDeg),pt=C(_.nextDir,e.rotDeg),U=Math.atan2(Y.y,Y.x),R=U+G(_.angleDeg),W=Math.min(v.right-v.left,v.bottom-v.top);let F=N(.12*W);const ft=P.x+F*Math.cos(U),gt=P.y+F*Math.sin(U),X=P.x+F*Math.cos(R),wt=P.y+F*Math.sin(R),J=Math.abs(_.angleDeg),it=J>180?1:0,vt=_.angleDeg>=0?1:0,rt=document.createElementNS("http://www.w3.org/2000/svg","path");rt.setAttribute("d",`M ${ft} ${gt} A ${F} ${F} 0 ${it} ${vt} ${X} ${wt}`),rt.setAttribute("stroke","rgba(255,99,71,0.7)"),rt.setAttribute("stroke-width","2"),rt.setAttribute("fill","none"),rt.style.pointerEvents="none",t.appendChild(rt);let z=Y.x+pt.x,j=Y.y+pt.y;J>180&&(z=-z,j=-j);let Q=Math.hypot(z,j);if(Q<1e-6){const lt=_.angleDeg>=0?1:-1;z=-Y.y*lt,j=Y.x*lt,Q=Math.hypot(z,j)||1}z/=Q,j/=Q;const Z=(Math.round(_.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",tt=Ct(Z,14);function Mt(lt,ut){return{left:lt-tt.w/2,right:lt+tt.w/2,top:ut-tt.h/2,bottom:ut+tt.h/2}}let at=null;for(let lt=Bt;lt<=Yt&&!at;lt+=4)for(let ut=0;ut<Ot.length&&!at;ut++){const yt=Ot[ut],xt=C({x:z,y:j},yt),Et=P.x+xt.x*(F+lt),mt=P.y+xt.y*(F+lt),ht=Mt(Et,mt);ht.top<0||ht.bottom>c||ht.left<0||ht.right>m||window.__figBoxesGroup.some(bt=>et(bt,ht,6))||(window.__dimBoxesGroup||[]).some(bt=>et(bt,ht,2))||(window.__angleBoxesGroup||[]).some(bt=>et(bt,ht,2))||(window.__placedLetterBoxes||[]).some(bt=>et(bt,ht,2))||(window.__legendBoxesGroup||[]).some(bt=>et(bt,ht,6))||(at={x:Et,y:mt,box:ht})}if(!at){const lt=P.x+z*(F+Bt),ut=P.y+j*(F+Bt),yt=Mt(lt,ut);at={x:lt,y:ut,box:yt}}window.__angleBoxesGroup.push(at.box);const ct=document.createElementNS("http://www.w3.org/2000/svg","text");ct.setAttribute("x",at.x),ct.setAttribute("y",at.y),ct.setAttribute("fill",$t),ct.setAttribute("font-size",14),ct.setAttribute("text-anchor","middle"),ct.setAttribute("alignment-baseline","middle"),ct.style.cursor="pointer",ct.textContent=Z,t.appendChild(ct),ct.addEventListener("mouseenter",()=>{rt.setAttribute("stroke","rgba(255,69,0,1)"),rt.setAttribute("stroke-width","3"),rt.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),ct.addEventListener("mouseleave",()=>{rt.setAttribute("stroke","rgba(255,99,71,0.7)"),rt.setAttribute("stroke-width","2"),rt.style.filter="none"})})})();const D=k.cloneNode(!1);D.setAttribute("stroke-width","50"),D.setAttribute("stroke","transparent"),D.setAttribute("fill","none"),D.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(T=>{D.addEventListener(T,st=>k.dispatchEvent(new st.constructor(st.type,st)))}),t.insertBefore(D,k);const O=(l.codigo!=null?l.codigo:l.id)+"";k.style.cursor="pointer",k.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),k.addEventListener("click",function(T){if(T.ctrlKey||T.metaKey||T.shiftKey){T.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id);return}abrirModalDividirElemento(l.id,O)}),k.addEventListener("contextmenu",function(T){T.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id)});const $=[],B=Gt(K),nt=Gt(d);ae(B,nt,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(T){const st=At(T.start,e.cxModel,e.cyModel,e.rotDeg),dt=At(T.end,e.cxModel,e.cyModel,e.rotDeg),C={x:h+(st.x-e.midX)*M,y:A+(st.y-e.midY)*M},H={x:h+(dt.x-e.midX)*M,y:A+(dt.y-e.midY)*M},N=T._label,_=H.x-C.x,P=H.y-C.y,Y=Math.hypot(_,P)||1,pt=_/Y,U=P/Y,R=P/Y,W=-_/Y,F=(C.x+H.x)/2,ft=(C.y+H.y)/2,gt=F+R*10,X=ft+W*10,wt=Ct(N,14),J=wt.w,it=wt.h;function vt(at,ct){return{left:at-J/2,right:at+J/2,top:ct-it/2,bottom:ct+it/2}}const rt=Y*.45;let z=gt,j=X;for(let at=0;at<=Math.ceil(rt/6);at++){const ct=at%2===0?1:-1,lt=Math.ceil(at/2),ut=ct*lt*6;if(Math.abs(ut)>rt)continue;const yt=gt+pt*ut,xt=X+U*ut,Et=(yt-C.x)*pt+(xt-C.y)*U;if(Et<0+J*.3||Et>Y-J*.3)continue;const mt=vt(yt,xt);if(!(et({left:Math.min(C.x,H.x),right:Math.max(C.x,H.x),top:Math.min(C.y,H.y),bottom:Math.max(C.y,H.y)},mt,0)||(window.__angleBoxesGroup||[]).some(St=>et(St,mt,2))||(window.__legendBoxesGroup||[]).some(St=>et(St,mt,6))||$.some(St=>et(St,mt,2))||mt.top<0||mt.bottom>c||mt.left<0||mt.right>m)){z=yt,j=xt,$.push(mt),window.__dimBoxesGroup.push(mt);break}}const Q=document.createElementNS("http://www.w3.org/2000/svg","line");Q.setAttribute("x1",C.x),Q.setAttribute("y1",C.y),Q.setAttribute("x2",H.x),Q.setAttribute("y2",H.y),Q.setAttribute("stroke","rgba(0,0,255,0.6)"),Q.setAttribute("stroke-width","4"),Q.setAttribute("stroke-linecap","round"),Q.setAttribute("vector-effect","non-scaling-stroke"),Q.style.opacity=0,Q.style.pointerEvents="none",Q.style.transition="opacity 120ms ease",t.appendChild(Q);const Z=document.createElementNS("http://www.w3.org/2000/svg","text");Z.setAttribute("x",z),Z.setAttribute("y",j),Z.setAttribute("fill",$t),Z.setAttribute("font-size",14),Z.setAttribute("text-anchor","middle"),Z.setAttribute("alignment-baseline","middle"),Z.setAttribute("tabindex","0"),Z.style.cursor="pointer",Z.textContent=N,t.appendChild(Z);function tt(){Q.style.opacity=1}function Mt(){Q.style.opacity=0}Z.addEventListener("mouseenter",tt),Z.addEventListener("mouseleave",Mt),Z.addEventListener("focus",tt),Z.addEventListener("blur",Mt)}),function(){const st=[];let dt=0,C=0,H=0;for(let N=0;N<r.length;N++){const _=r[N];if(_.type==="line")dt+=_.length*Math.cos(G(H)),C+=_.length*Math.sin(G(H));else if(_.type==="turn")H+=_.angle;else if(_.type==="arc"){const P=dt+_.radius*Math.cos(G(H+90)),Y=C+_.radius*Math.sin(G(H+90)),pt=Math.atan2(C-Y,dt-P),U=pt+G(_.arcAngle);let R=_.radius;for(let W=0;W<d.length;W++){const F=d[W];if(F.type==="arc"&&Math.abs(F.arcAngle-_.arcAngle)<.01){R=F.radius;break}}st.push({center:{x:P,y:Y},radius:_.radius,originalRadius:R,arcAngle:_.arcAngle,startAngle:pt,endAngle:U}),dt=P+_.radius*Math.cos(U),C=Y+_.radius*Math.sin(U),H+=_.arcAngle}}st.forEach(function(N){const _=At(N.center,e.cxModel,e.cyModel,e.rotDeg),P={x:h+(_.x-e.midX)*M,y:A+(_.y-e.midY)*M},Y=(N.startAngle+N.endAngle)/2,pt=N.radius*M,U="R"+jt(N.originalRadius,{decimals:0,step:null}),R=Ct(U,14),W=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let F=!1,ft,gt,X;for(let tt=0;tt<W.length&&!F;tt++){const Mt=W[tt],at=Y+G(Mt),ct={x:N.center.x+N.radius*Math.cos(at),y:N.center.y+N.radius*Math.sin(at)},lt=At(ct,e.cxModel,e.cyModel,e.rotDeg),ut={x:h+(lt.x-e.midX)*M,y:A+(lt.y-e.midY)*M},yt=ut.x-P.x,xt=ut.y-P.y,Et=Math.hypot(yt,xt)||1,mt=yt/Et,ht=xt/Et;for(let qt=8;qt<=60&&!F;qt+=6){const _t=pt*.7;if(ft=P.x+mt*_t+mt*qt,gt=P.y+ht*_t+ht*qt,X={left:ft-R.w/2,right:ft+R.w/2,top:gt-R.h/2,bottom:gt+R.h/2},!(X.top<0||X.bottom>c||X.left<0||X.right>m||window.__figBoxesGroup.some(Lt=>et(Lt,X,2))||(window.__legendBoxesGroup||[]).some(Lt=>et(Lt,X,2)))){F=!0;break}}}if(!F)return;$.push(X);const wt={x:ft-P.x,y:gt-P.y},J=Math.hypot(wt.x,wt.y)||1,it={x:wt.x/J,y:wt.y/J},vt=P.x+it.x*pt*.6,rt=P.y+it.y*pt*.6,z=document.createElementNS("http://www.w3.org/2000/svg","line");z.setAttribute("x1",P.x),z.setAttribute("y1",P.y),z.setAttribute("x2",vt),z.setAttribute("y2",rt),z.setAttribute("stroke","rgba(0,128,0,0.6)"),z.setAttribute("stroke-width","4"),z.setAttribute("stroke-linecap","round"),z.setAttribute("vector-effect","non-scaling-stroke"),z.style.opacity=0,z.style.pointerEvents="none",z.style.transition="opacity 120ms ease",t.appendChild(z);const j=document.createElementNS("http://www.w3.org/2000/svg","text");j.setAttribute("x",ft),j.setAttribute("y",gt),j.setAttribute("fill",$t),j.setAttribute("font-size",14),j.setAttribute("text-anchor","middle"),j.setAttribute("alignment-baseline","middle"),j.setAttribute("tabindex","0"),j.style.cursor="pointer",j.textContent=U,t.appendChild(j);function Q(){z.style.opacity=1}function Z(){z.style.opacity=0}j.addEventListener("mouseenter",Q),j.addEventListener("mouseleave",Z),j.addEventListener("focus",Q),j.addEventListener("blur",Z)})}(),function(){const st=Ft(p),dt=14,C=Ct(st,dt);function H(R,W){return{left:R,right:R+C.w,top:W-C.h/2,bottom:W+C.h/2}}let N=null;const _=(v.top+v.bottom)/2,P=Math.max(C.h/2,Math.min(_,c-C.h/2));function Y(R){for(let F=0;F<=30;F+=4){const ft=F%2===0?1:-1,gt=Math.ceil(F/2),X=ft*gt*4,wt=Math.max(C.h/2,Math.min(c-C.h/2,P+X)),J=R,it=H(J,wt);if(!(window.__figBoxesGroup.some(tt=>et(tt,it,6))||(window.__dimBoxesGroup||[]).some(tt=>et(tt,it,3))||(window.__angleBoxesGroup||[]).some(tt=>et(tt,it,3))||(window.__legendBoxesGroup||[]).some(tt=>et(tt,it,6))||(window.__placedLetterBoxes||[]).some(tt=>et(tt,it,2))||it.top<0||it.bottom>c||it.left<0||it.right>m))return N={x:J,y:wt,box:it},!0}return!1}const pt=[{x:v.right+10,priority:1},{x:v.left-10-C.w,priority:1},{x:v.right+15,priority:2},{x:v.left-15-C.w,priority:2},{x:v.right+5,priority:2},{x:v.left-5-C.w,priority:2},{x:v.right+20,priority:3},{x:v.left-20-C.w,priority:3},{x:v.right+25,priority:3},{x:v.left-25-C.w,priority:3},{x:v.right+30,priority:3},{x:v.left-30-C.w,priority:3}];pt.sort((R,W)=>R.priority-W.priority);for(const R of pt){if(N)break;const W=It(R.x,C.w,0,m);if(Y(W))break}if(!N){const R=(v.left+v.right)/2,W=[{x:R-C.w/2,y:v.top-C.h-5},{x:R-C.w/2,y:v.bottom+C.h+5}];for(const F of W){if(N)break;const ft=It(F.x,C.w,0,m),gt=Math.max(C.h/2,Math.min(c-C.h/2,F.y)),X=H(ft,gt);!window.__figBoxesGroup.some(J=>et(J,X,6))&&!(window.__dimBoxesGroup||[]).some(J=>et(J,X,3))&&!(window.__angleBoxesGroup||[]).some(J=>et(J,X,3))&&!(window.__legendBoxesGroup||[]).some(J=>et(J,X,6))&&!(window.__placedLetterBoxes||[]).some(J=>et(J,X,2))&&X.top>=0&&X.bottom<=c&&X.left>=0&&X.right<=m&&(N={x:ft,y:gt,box:X})}}if(!N){const R=It(m-C.w,C.w,0,m),W=P;N={x:R,y:W,box:H(R,W)}}window.__placedLetterBoxes.push(N.box);const U=document.createElementNS("http://www.w3.org/2000/svg","text");U.setAttribute("x",N.x),U.setAttribute("y",N.y),U.setAttribute("fill",zt),U.setAttribute("font-size",dt),U.setAttribute("text-anchor","start"),U.setAttribute("alignment-baseline","middle"),U.style.fontWeight="600",U.style.pointerEvents="none",U.textContent=st,t.appendChild(U)}()}),n.innerHTML="",n.appendChild(t)};function Pt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const y=window.elementosAgrupadosScript;if(!y)return;const s=document.getElementById("grid-maquina");if(s&&window.updateGridClasses){const a=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,o),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}y.forEach(function(a,o){renderizarGrupoSVG(a,o)}),requestAnimationFrame(()=>{s&&(s.style.opacity="1",s.style.visibility="visible",s.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",s.className)),document.querySelectorAll(".proceso").forEach(a=>{a.style.opacity="1"})}),window.actualizarSVGConColadas=function(a,o){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,m=n.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(a));if(m===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${a}`);return}const c=n[m];c.elementos&&o&&c.elementos.forEach(w=>{const t=String(w.id),i=o[t];w.coladas||(w.coladas={colada1:null,colada2:null,colada3:null}),i&&Array.isArray(i)&&(w.coladas.colada1=i[0]||null,w.coladas.colada2=i[1]||null,w.coladas.colada3=i[2]||null)}),renderizarGrupoSVG(c,m),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${a}`,o)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pt):Pt();document.addEventListener("livewire:navigated",Pt);window.abrirModalDividirElemento=function(s){const a=document.getElementById("modalDividirElemento"),o=document.getElementById("dividir_elemento_id"),n=document.getElementById("formDividirElemento");!a||!o||!n||(o.value=s,window.rutaDividirElemento&&n.setAttribute("action",window.rutaDividirElemento),a.classList.remove("hidden"))};window.enviarDivision=async function(){const s=document.getElementById("formDividirElemento"),a=s.getAttribute("action")||window.rutaDividirElemento,o=new FormData(s);try{const n=document.querySelector('meta[name="csrf-token"]'),m=o.get("_token")||(n?n.getAttribute("content"):null),w=await fetch(a,{method:"POST",headers:m?{"X-CSRF-TOKEN":m}:{},body:o}),t=await w.json();if(!w.ok||!t.success)throw new Error(t.message||"Error al dividir");s.reset();const i=document.getElementById("modalDividirElemento");i&&i.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",t.message,"success"):alert(t.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(y){const s={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},a={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function o(t,i,g={}){console.log(`üîÑ Actualizando etiqueta ${t} a estado: ${i}`);const b=String(t).replace(/\./g,"-"),u=document.querySelector(`#etiqueta-${b}`);if(!u)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${t}`),!1;const f=String(i).toLowerCase().trim(),l=a[f];if(!l)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${i}`),!1;u.dataset.estado=f,Array.from(u.classList).forEach(e=>{e.startsWith("estado-")&&u.classList.remove(e)}),u.classList.add(l.cssClass),u.style.setProperty("--bg-estado",l.bgColor);const d=u.querySelector('[id^="contenedor-svg-"]');if(d){const e=d.querySelector("svg");e&&(e.style.background=l.bgColor)}const r=u.querySelector(".etiqueta-card")||u;return r&&(r.style.background=l.bgColor),n(u,f),m(u),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:t,estado:f,datosExtra:g}})),console.log(`‚úÖ Etiqueta ${t} actualizada a ${i}`),!0}function n(t,i){const g=t.querySelectorAll(".btn-fabricar"),b=["empaquetada","en-paquete"];g.forEach(u=>{b.includes(i)?(u.disabled=!0,u.style.opacity="0.5",u.style.cursor="not-allowed",u.title=`Etiqueta ya ${i}`):(u.disabled=!1,u.style.opacity="1",u.style.cursor="pointer",u.title="Fabricar esta etiqueta")})}function m(t){t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400)}function c(t,i,g={}){console.log(`üîÑ Actualizando ${t.length} etiquetas...`);const u=t.map(f=>o(f,i,g)).filter(f=>f).length;return console.log(`‚úÖ ${u}/${t.length} etiquetas actualizadas`),u}function w(t){const i=String(t).replace(/\./g,"-"),g=document.querySelector(`#etiqueta-${i}`);return g?{id:t,estado:g.dataset.estado||"desconocido",elemento:g}:null}window.addEventListener("paquete:creado",t=>{const{codigoPaquete:i,etiquetaIds:g}=t.detail;console.log(`üì¶ Evento paquete:creado recibido - ${i} con ${g.length} etiquetas`),c(g,"empaquetada",{codigo_paquete:i})}),y.SistemaDOM={actualizarEstadoEtiqueta:o,actualizarMultiplesEtiquetas:c,obtenerEstadoActual:w,ESTADOS_CONFIG:a},y.ColoresEstado={actualizar:(t,i)=>{s[t]=i;const g=document.getElementById("colores-estado-css");if(g){let b=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[u,f]of Object.entries(s))b+=`.proceso.estado-${u} {
    --bg-estado: ${f};
}
`;g.textContent=b,console.log(`‚úÖ Color actualizado para estado "${t}": ${i}`)}},obtenerColor:t=>s[t],todos:()=>({...s})}})(window);function Tt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async t=>{var d,r,e;const i=t.target.closest(".btn-fabricar");if(!i)return;t.preventDefault();const g=(r=(d=document.getElementById("maquina-info"))==null?void 0:d.dataset)==null?void 0:r.maquinaId;if(!g){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const b=String(i.dataset.etiquetaId||"").trim(),u=b.replace(/\./g,"-"),f=document.querySelector(`#etiqueta-${u}`);if(f){const E=(f.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(E)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${b} ya est√° en estado ${E}.`,timer:2500,showConfirmButton:!1});return}}const l=Number(((e=window.DIAMETRO_POR_ETIQUETA)==null?void 0:e[b])??0);if(!b){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!l&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const p=i.disabled;i.disabled=!0;try{await y(b,g,l)}finally{i.disabled=p}});async function y(t,i,g=null){var h,A,M,S;const b=`/actualizar-etiqueta/${t}/maquina/${i}`,u=(h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.getAttribute("content"),f=t.replace(/\./g,"-"),p=(((M=(A=document.querySelector(`#etiqueta-${f}`))==null?void 0:A.dataset)==null?void 0:M.estado)||"").toLowerCase()==="fabricando",d=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",r=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",e=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(d&&r||e){if(p&&((S=window._decisionCortePorEtiqueta)!=null&&S[t])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:a});return}for(;;){let x;try{x=await Cortes.mejorCorteSimple(t,g,u)}catch(q){w(q);return}if(!x)return;if(x.accion==="optimizar"){let q;try{q=await Cortes.mejorCorteOptimizado(t,g,x.patrones,u)}catch(L){w(L);return}if((q==null?void 0:q.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q.longitudBarraCm,etiquetas:q.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:a});return}else{if(q==="volver")continue;return}}if(x.accion==="fabricar_patron_simple"){const q=Math.round(Number(x.longitud_m||0)*100);if(!q){w("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q,etiquetas:[{etiqueta_sub_id:t,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:a});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,i,u)}catch(x){w(x)}return}try{const x=await fetch(b,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({})}),q=await x.json();if(!x.ok)throw new Error(q.message||"Error al actualizar");a(t,q)}catch(x){w(x)}}async function s(t,i,g){var V,k,D,O,$;const b=Number(((V=window.DIAMETRO_POR_ETIQUETA)==null?void 0:V[t])??0),f=Number(((k=window.LONGITUD_POR_ETIQUETA)==null?void 0:k[t])??0)/100;let l="";try{const B=await fetch(`/api/productos/sugerencias?diametro=${b}&longitud=${f}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":g}});if(B.ok){const nt=await B.json();nt.productos&&nt.productos.length>0?l=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${b}mm x ${f.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${nt.productos.map(ot=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${ot.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${ot.codigo}</td>
                                                <td class="px-2 py-1">${ot.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${ot.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${ot.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:l=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${b}mm x ${f.toFixed(1)}m</p>`}}catch(B){console.warn("No se pudieron cargar sugerencias:",B)}const{value:p,isConfirmed:d}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${l}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const B=document.getElementById("swal-input-producto").value;return!B||!B.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):B.trim()}});if(!d||!p)return;let r;try{const B=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(p.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":g}});if(!B.ok){const nt=await B.json();throw new Error(nt.message||"Producto no encontrado")}r=await B.json()}catch(B){await Swal.fire({icon:"error",title:"Producto no encontrado",text:B.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${p}`});return}const e=(r.tipo||"").toLowerCase(),E=Number(r.diametro??0),h=Number(r.longitud??0);if(e&&e!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${r.codigo}</p>
                        <p><strong>Tipo:</strong> ${r.tipo||"N/A"}</p>
                    </div>
                `});return}if(E>0&&b>0&&Math.abs(E-b)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${E} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${b} mm</p>
                    </div>
                `});return}if(h>0&&f>0&&Math.abs(h-f)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${h.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${f.toFixed(2)} m</p>
                    </div>
                `});return}const A=r.longitud?`${r.longitud} m`:"N/A",{value:M,isConfirmed:S}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${r.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${r.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${A}</p>
                    <p><strong>Stock actual:</strong> ${((D=r.peso_stock)==null?void 0:D.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${r.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!S)return;const x=M==="completo",q=`/actualizar-etiqueta/${t}/maquina/${i}`,L=await fetch(q,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":g},body:JSON.stringify({producto_id:r.id,paquete_completo:x})}),I=await L.json();if(!L.ok)throw new Error(I.message||"Error al fabricar");const v=((O=I.metricas)==null?void 0:O.peso_consumido)||0,K=(($=I.metricas)==null?void 0:$.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${r.codigo}</p>
                <p><strong>Peso consumido:</strong> ${v.toFixed(2)} kg</p>
                ${K?`<p><strong>Paquete:</strong> ${K}</p>`:""}
                ${x?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),a(t,I),K&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const B=document.getElementById("codigo_paquete_mover");B&&(B.value=K,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function a(t,i){var b,u;const g=t.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:i.estado,peso_etiqueta:i.peso_etiqueta,nombre:i.nombre,data_completa:i}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,i.estado,{peso:i.peso_etiqueta,nombre:i.nombre||t}):o(t,i.estado),i.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,i.coladas_por_elemento),(i.estado||"").toLowerCase()){case"cortando":c("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":c("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),n(g);break;case"fabricando":c("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":c("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),n(g),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"fabricada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),m(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":c("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(b=window._decisionCortePorEtiqueta)!=null&&b[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),n(g),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"completada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(l=>l.coladas&&(l.coladas.colada1||l.coladas.colada2||l.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),m(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":c("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":c("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),n(g);break;case"soldando":c("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":c("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),n(g);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${i.estado}`),c("warning","Estado desconocido",`El estado recibido (${i.estado}) no est√° reconocido.`,3e3)}(u=i.productos_afectados)!=null&&u.length&&i.productos_afectados.forEach(f=>{const l=document.getElementById(`peso-stock-${f.id}`),p=document.getElementById(`progreso-texto-${f.id}`),d=document.getElementById(`progreso-barra-${f.id}`);l&&(l.textContent=`${f.peso_stock} kg`),p&&(p.textContent=`${f.peso_stock} / ${f.peso_inicial} kg`),d&&(d.style.height=`${f.peso_stock/f.peso_inicial*100}%`)})}function o(t,i){const g=t.replace(/\./g,"-"),b=document.getElementById("etiqueta-"+g);if(!b)return;b.dataset.estado=String(i||"").toLowerCase(),b.className=b.className.split(" ").filter(l=>!l.startsWith("estado-")).join(" ").trim(),b.classList.add("estado-"+b.dataset.estado);const u=b.querySelector('[id^="contenedor-svg-"]'),f=u==null?void 0:u.querySelector("svg");f&&(f.style.background=getComputedStyle(b).getPropertyValue("--bg-estado").trim())}function n(t){const i=`#etiqueta-${CSS.escape(t)}`,g=document.querySelector(i),b=Array.from(document.querySelectorAll(".proceso")),u=E=>(E||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),f=E=>{var M;const h=(M=E.dataset)==null?void 0:M.estado;if(h)return u(h);const A=E.querySelector('[id^="estado-"]');return u((A==null?void 0:A.textContent)||(A==null?void 0:A.innerText)||"")},l=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),p=E=>l.has(f(E)),d=g?b.indexOf(g):-1,e=(d>=0?b.slice(d+1):b).find(E=>!p(E));e?e.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function m(t,i){var l;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!i||!Array.isArray(i)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(i.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const g=window.elementosAgrupadosScript.findIndex(p=>{var d;return((d=p.etiqueta)==null?void 0:d.etiqueta_sub_id)===t});if(g===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[g].elementos=i;const b=window.elementosAgrupadosScript[g],u=(l=b.etiqueta)==null?void 0:l.id;if(!u){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const f=document.getElementById("contenedor-svg-"+u);if(!f){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${u})`);return}try{const p=f.querySelector("svg");p&&p.remove();const d=600,r=150,e=f.closest(".proceso"),E=e&&getComputedStyle(e).getPropertyValue("--bg-estado").trim()||"#e5e7eb",h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("viewBox",`0 0 ${d} ${r}`),h.setAttribute("preserveAspectRatio","xMidYMid meet"),h.style.width="100%",h.style.height="100%",h.style.display="block",h.style.background=E;const A=(b.elementos||[]).map((S,x)=>{var K,V,k;const q=S.barras!=null?S.barras:0;let L="N/A";if(S.diametro!=null&&S.diametro!==""){const O=String(S.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(O){const $=parseFloat(O[0]);isFinite($)&&(L=String(Math.round($)))}}const I=[];(K=S.coladas)!=null&&K.colada1&&I.push(S.coladas.colada1),(V=S.coladas)!=null&&V.colada2&&I.push(S.coladas.colada2),(k=S.coladas)!=null&&k.colada3&&I.push(S.coladas.colada3);const v=I.length>0?` (${I.join(", ")})`:"";return{letter:indexToLetters(x),text:`√ò${L} x${q}${v}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(h,A,d,r):console.error("‚ùå drawLegendBottomLeft no est√° definida");const M=document.createElementNS("http://www.w3.org/2000/svg","text");M.setAttribute("x",d/2),M.setAttribute("y",r/2),M.setAttribute("text-anchor","middle"),M.setAttribute("fill","#059669"),M.setAttribute("font-size","14"),M.setAttribute("font-weight","600"),M.textContent="‚úì Coladas actualizadas",h.appendChild(M),f.appendChild(h),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{M&&M.parentNode&&M.remove()},2e3)}catch(p){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,p),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function c(t,i,g,b=2e3){Swal.fire({icon:t,title:i,text:g,timer:b,showConfirmButton:!1})}function w(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=a}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);(function(y){let s=[],a=!1,o=null;async function n(p){var r;const d=`/etiquetas/${encodeURIComponent(p)}/validar-para-paquete`;try{const e=await fetch(d,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content}});if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const h=await e.json();if(console.log("üîç validarEtiqueta response:",{status:e.status,data:h,peso_etiqueta:h.peso_etiqueta}),!e.ok)throw new Error((h==null?void 0:h.message)||(h==null?void 0:h.motivo)||"Error al validar");return h}catch(e){throw e}}function m(p,d){const r=d.id||p;if(s.some(h=>h.id===r))return!1;const e=parseFloat(d.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:p,id:r,peso_etiqueta_recibido:d.peso_etiqueta,peso_parseado:e,data_completa:d});const E={id:r,type:"etiqueta",peso:e,estado:d.estado||"desconocido",nombre:d.nombre||"Sin nombre"};return s.push(E),g(),!0}function c(p){const d=s.findIndex(r=>r.id===p);d>=0&&s.splice(d,1),g()}function w(){s=[],g()}function t(){return s.reduce((p,d)=>p+(parseFloat(d.peso)||0),0)}function i(){return s}function g(){const p=document.getElementById("itemsList");if(!p)return;p.innerHTML="";for(const e of s){const E=document.createElement("li");E.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",E.dataset.code=e.id,E.innerHTML=`
                <div>
                    <div class="font-semibold">${e.id} === ${e.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,E.querySelector("button").onclick=()=>c(e.id),p.appendChild(E)}const d=t(),r=document.createElement("li");r.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",r.textContent=`Total: ${d.toFixed(2)} kg (${s.length} etiquetas)`,p.appendChild(r)}async function b(){var h,A,M;if(!s.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const p=Number(((A=(h=document.getElementById("maquina-info"))==null?void 0:h.dataset)==null?void 0:A.maquinaId)||window.maquinaId),d=Number(((M=document.getElementById("ubicacion-id"))==null?void 0:M.value)||window.ubicacionId),r=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!p){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!r&&!d){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const e={items:s.map(S=>({id:S.id,type:S.type})),maquina_id:p,ubicacion_id:r?null:d,sin_ubicacion:r},E=async(S={})=>{var L;const x=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(L=document.querySelector('meta[name="csrf-token"]'))==null?void 0:L.content},body:JSON.stringify({...e,...S})}),q=await x.json();if(!x.ok)throw new Error(q.message||"Error al crear el paquete");return q};try{const S=await E();if(S.success)return u(S);if(S.warning){let x="<div style='text-align:left;'>Se detectaron advertencias:";for(const[L,I]of Object.entries(S.warning))Array.isArray(I)&&I.length&&(x+=`<br><strong>${L.replaceAll("_"," ")}:</strong> ${I.join(", ")}`);if(x+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:x,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const L=await E({confirmar:!0});if(L.success)return u(L);throw new Error(L.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(S){await Swal.fire("Error",S.message||"Error inesperado","error")}}async function u(p){var h;const d=p.codigo_paquete||((h=p.paquete)==null?void 0:h.codigo)||"N/D",r=t(),e=[...s.map(A=>A.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${d}</strong> creado correctamente</p>
                       <p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),w(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const A=document.getElementById("codigo_paquete_mover");A&&(A.value=d,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${d}</strong> creado correctamente</p><p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>`}),w()),console.log(`üì¶ Disparando evento paquete:creado para ${d}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:d,etiquetaIds:e,pesoTotal:r}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),e.forEach(A=>{f(A,d)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function f(p,d){const r=String(p).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${r}`);if(!e){console.warn(`‚ùå No se encontr√≥ elemento: ${p}`);return}console.log(`üîÑ Actualizando manualmente: ${p}`),Array.from(e.classList).forEach(x=>{x.startsWith("estado-")&&e.classList.remove(x)}),e.classList.add("estado-en-paquete"),e.dataset.estado="en-paquete",e.style.setProperty("--bg-estado","#e3e4FA");const h=e.querySelector('[id^="contenedor-svg-"]');if(h){const x=h.querySelector("svg");x&&(x.style.background="#e3e4FA")}const A=e.querySelector(".etiqueta-card")||e;A&&(A.style.background="#e3e4FA");const M=e.querySelector("h3");if(M&&!e.querySelector(".paquete-info")){const x=document.createElement("div");x.className="paquete-info text-sm font-semibold mt-2 no-print",x.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",x.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${d}</span>
            `,M.parentNode.insertBefore(x,M.nextSibling)}e.querySelectorAll(".btn-fabricar").forEach(x=>{x.disabled=!0,x.style.opacity="0.5",x.style.cursor="not-allowed"}),e.style.transition="transform 0.5s ease, background-color 0.5s ease",e.style.transform="scale(1.03)",setTimeout(()=>{e.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${p} actualizada manualmente`)}function l(){if(a)return;a=!0;const p=document.getElementById("qrItem");p&&(p.addEventListener("change",()=>p.dispatchEvent(new Event("input"))),p.addEventListener("input",async function(){const r=this.value.trim();if(r)try{const e=await n(r);if(!e.valida){await Swal.fire("Etiqueta no v√°lida",e.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}m(r,e)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(e){console.error("Error de validaci√≥n:",e),await Swal.fire("Error",e.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const d=document.getElementById("crearPaqueteBtn");d&&d.addEventListener("click",b),document.addEventListener("focus",function(r){r.target.id&&r.target.id.startsWith("input-etiqueta-")&&(o=r.target,console.log("üéØ Focus en input:",r.target.id))},!0),document.addEventListener("click",async function(r){var e;if(r.target.classList.contains("btn-agregar-carro")||r.target.closest(".btn-agregar-carro")){const h=(r.target.classList.contains("btn-agregar-carro")?r.target:r.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!h){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const A=document.querySelector(`[x-show="tabActivo === 'crear'"]`),M=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(A&&window.getComputedStyle(A).display,M&&window.getComputedStyle(M).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let x=document.activeElement;(!x||!((e=x.id)!=null&&e.startsWith("input-etiqueta-")))&&(x=o),(!x||!document.body.contains(x))&&(x=document.querySelector('input[id^="input-etiqueta-"]')),x?(x.value=h,x.focus(),x.classList.add("ring-4","ring-green-400"),setTimeout(()=>{x.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${h} a√±adida al input:`,x.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",h);try{const x=await n(h);if(!x.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:x.motivo||"Motivo no especificado"});return}m(h,x)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(x){console.error("Error al a√±adir al carro:",x),await Swal.fire({icon:"error",title:"Error",text:x.message||"No se pudo a√±adir al carro"})}}})}y.TrabajoPaquete={inicializar:l,agregarItemEtiqueta:m,eliminarItem:c,limpiarCarro:w,obtenerItems:i,calcularPesoTotal:t,crearPaquete:b,validarEtiqueta:n,actualizarListaVisual:g},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l(),document.addEventListener("livewire:navigated",l)})(window);function Dt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(s,a){const o=document.getElementById("grid-maquina");if(!o)return;console.log("üîß Actualizando clases:",{showLeft:s,showRight:a,clasesAnteriores:o.className}),s||a?o.classList.add("columnas-laterales-visibles"):o.classList.remove("columnas-laterales-visibles"),s&&a?o.classList.add("ambas-columnas"):o.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",o.className),o.offsetHeight,o.querySelectorAll(".etiqueta-card").forEach(m=>{m.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const s=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,a)});function y(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((m,c)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),c.disconnect();const t=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(t,i)}}).observe(document.body,{childList:!0,subtree:!0});return}const a=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,o),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}y()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);
