const k=()=>window.AppPlanif,R=()=>k().csrf,D=()=>k().routes,V=()=>({maquinas:k().maquinas,eventos:k().eventos,cargaTrabajo:k().cargaTrabajo||{},turnos:k().turnos||[]});let P=null;function C(){P&&(P.remove(),P=null,document.removeEventListener("click",C),document.removeEventListener("scroll",C,!0),window.removeEventListener("resize",C))}function A(l,p,a){C();const r=document.createElement("div");r.className="fc-contextmenu",Object.assign(r.style,{position:"fixed",zIndex:9999,minWidth:"240px",background:"#fff",border:"1px solid #e5e7eb",boxShadow:"0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05)",borderRadius:"8px",overflow:"hidden",visibility:"hidden"}),r.innerHTML=a,document.body.appendChild(r);const c=r.getBoundingClientRect(),d=window.innerHeight,f=window.innerWidth;let u=p;p+c.height>d&&(u=p-c.height,u<0&&(u=Math.max(0,d-c.height)));let g=l;return l+c.width>f&&(g=l-c.width,g<0&&(g=Math.max(0,f-c.width))),Object.assign(r.style,{top:u+"px",left:g+"px",visibility:"visible"}),P=r,setTimeout(()=>{document.addEventListener("click",C),document.addEventListener("scroll",C,!0),window.addEventListener("resize",C)},0),r}function W(l,p,{headerHtml:a="",items:r=[]}){const c=`
    <div class="ctx-menu-container">
      ${a?`<div class="ctx-menu-header">${a}</div>`:""}
      ${r.map((f,u)=>`
        <button class="ctx-menu-item${f.danger?" ctx-menu-danger":""}${f.disabled?" ctx-menu-disabled":""}" data-idx="${u}" ${f.disabled?"disabled":""}>
          ${f.icon?`<span class="ctx-menu-icon">${f.icon}</span>`:""}
          <span class="ctx-menu-label">${f.label}</span>
        </button>
      `).join("")}
    </div>
  `,d=A(l,p,c);return d.querySelectorAll(".ctx-menu-item").forEach(f=>{const u=parseInt(f.dataset.idx,10),g=r[u];f.addEventListener("click",async w=>{if(w.preventDefault(),w.stopPropagation(),console.log("[baseMenu] Click en item:",g.label,"disabled:",g.disabled),g.disabled){console.log("[baseMenu] Item deshabilitado, ignorando");return}const n=g.onClick;console.log("[baseMenu] Ejecutando acci√≥n..."),C();try{await(n==null?void 0:n()),console.log("[baseMenu] Acci√≥n completada")}catch(i){console.error("[baseMenu] Error en acci√≥n:",i)}})}),d}async function B(l,p={}){const a={headers:{Accept:"application/json","X-CSRF-TOKEN":R()},...p};a.body&&typeof a.body!="string"&&(a.headers["Content-Type"]="application/json",a.body=JSON.stringify(a.body));const r=await fetch(l,a);let c=null;try{c=await r.json()}catch{}if(!r.ok)throw new Error((c==null?void 0:c.message)||`HTTP ${r.status}`);return c}async function X(l){const p=await Swal.fire({title:"Nuevo festivo",input:"text",inputLabel:"T√≠tulo del festivo",inputValue:"Festivo",showCancelButton:!0,confirmButtonText:"Crear",cancelButtonText:"Cancelar",inputValidator:r=>!r||!r.trim()?"Pon un t√≠tulo":void 0});return p.isConfirmed?(await B(D().festivo.store,{method:"POST",body:{fecha:l,titulo:p.value.trim()}})).festivo:null}async function K(l,p,a){let r=[],c=[],d=[];try{const i=await fetch(`/api/usuarios/operarios-agrupados?fecha=${l}&maquina_id=${p}`,{headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"}});if(i.ok){const b=await i.json();r=b.todos||[],c=b.sin_turno||[],d=b.de_maquina||[]}else console.error("Error al obtener operarios:",i.status)}catch(i){console.error("Error al obtener operarios:",i)}const f=(i,b="No hay trabajadores")=>i.length===0?`<option value="" disabled>${b}</option>`:i.map(e=>`<option value="${e.id}">${e.name} ${e.primer_apellido||""} ${e.segundo_apellido||""}</option>`).join(""),u=f(c,"No hay operarios sin turno este d√≠a"),g=f(r,"No hay operarios disponibles"),w=f(d,"No hay operarios asignados a esta m√°quina"),{value:n}=await Swal.fire({title:"üîß Generar Turnos",html:`
            <div class="text-left space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha inicio:</strong> ${l}<br>
                        <strong>M√°quina:</strong> ${a}
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Sin turno asignado este d√≠a <span class="text-green-600">(${c.length})</span>
                    </label>
                    <select id="swal-trabajador-sin-turno" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${u}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Asignados a ${a} <span class="text-blue-600">(${d.length})</span>
                    </label>
                    <select id="swal-trabajador-maquina" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${w}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Todos los operarios <span class="text-gray-600">(${r.length})</span>
                    </label>
                    <select id="swal-trabajador-todos" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${g}
                    </select>
                </div>

                <input type="hidden" id="swal-trabajador" value="" />

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Alcance de generaci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-alcance" class="swal2-input w-full">
                        <option value="un_dia">Solo este d√≠a (${l})</option>
                        <option value="dos_semanas">Hasta el viernes de la semana siguiente</option>
                        <option value="resto_a√±o">Desde ${l} hasta fin de a√±o</option>
                    </select>
                </div>

                <div class="mb-4" id="turno-inicio-container" style="display: none;">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Turno inicial (para diurnos) <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-turno-inicio" class="swal2-input w-full">
                        <option value="ma√±ana">Ma√±ana</option>
                        <option value="tarde">Tarde</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Los turnos alternar√°n cada viernes</p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">
                        <strong>Nota:</strong> Se saltar√°n autom√°ticamente s√°bados, domingos, festivos y d√≠as con vacaciones.
                    </p>
                </div>
            </div>
        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Generar Turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",width:"600px",didOpen:()=>{const i=document.getElementById("swal-trabajador"),b=document.getElementById("turno-inicio-container"),e=document.getElementById("swal-trabajador-sin-turno"),t=document.getElementById("swal-trabajador-maquina"),o=document.getElementById("swal-trabajador-todos"),s=[...c,...d,...r];function h(m,v){i.value=m,v!==e&&(e.value=""),v!==t&&(t.value=""),v!==o&&(o.value="");const x=s.find(T=>T.id===parseInt(m));x&&x.turno==="diurno"?b.style.display="block":b.style.display="none"}e.addEventListener("change",m=>{m.target.value&&h(m.target.value,e)}),t.addEventListener("change",m=>{m.target.value&&h(m.target.value,t)}),o.addEventListener("change",m=>{m.target.value&&h(m.target.value,o)})},preConfirm:()=>{const i=document.getElementById("swal-trabajador").value,b=document.getElementById("swal-alcance").value,e=document.getElementById("swal-turno-inicio").value;return i?{trabajador_id:i,alcance:b,turno_inicio:e}:(Swal.showValidationMessage("Debes seleccionar un trabajador"),!1)}});if(!n)return null;try{const b=[...c,...d,...r].find(s=>s.id===parseInt(n.trabajador_id)),t=await fetch("/profile/generar-turnos-calendario",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"},body:JSON.stringify({user_id:n.trabajador_id,maquina_id:p,fecha_inicio:l,alcance:n.alcance,turno_inicio:n.turno_inicio})}),o=await t.json();if(!t.ok)throw new Error(o.message||`Error HTTP ${t.status}`);return{...o,eventos:o.eventos||[]}}catch(i){return console.error("Error al generar turnos:",i),await Swal.fire({icon:"error",title:"Error",text:i.message||"No se pudieron generar los turnos",confirmButtonText:"Aceptar"}),null}}async function O({fromISO:l,toISO:p,calendar:a}){var g,w;if(!await Swal.fire({icon:"question",title:"Copiar registros",html:`¬øCopiar registros de <b>${l}</b> a <b>${p}</b>?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar"}).then(n=>n.isConfirmed))return;const c=a.getEvents().filter(n=>{var i;return!((i=n.extendedProps)!=null&&i.es_festivo)}),d=(n,i,b)=>c.some(e=>{var o,s,h,m;const t=((s=(o=e.getResources)==null?void 0:o.call(e)[0])==null?void 0:s.id)??((h=e.extendedProps)==null?void 0:h.resourceId)??null;return e.title===n&&String(t)===String(i)&&(e.startStr||((m=e.start)==null?void 0:m.toISOString())).slice(0,10)===b}),f=c.filter(n=>{var i;return(n.startStr||((i=n.start)==null?void 0:i.toISOString())).slice(0,10)===l});let u=0;for(const n of f){const i=n.getResources?n.getResources():[],b=((g=i==null?void 0:i[0])==null?void 0:g.id)??((w=n.extendedProps)==null?void 0:w.resourceId)??null,e=n.start?new Date(n.start):null,t=n.end?new Date(n.end):null,o=e?`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`:"08:00",s=t?`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`:null,h=new Date(`${p}T${o}:00`),m=s?new Date(`${p}T${s}:00`):null;d(n.title,b,p)||(a.addEvent({id:`tmp-copy-${Date.now()}-${Math.random().toString(36).slice(2)}`,title:n.title,start:h.toISOString(),end:m?m.toISOString():null,resourceId:b??void 0,allDay:n.allDay,backgroundColor:n.backgroundColor,borderColor:n.borderColor,textColor:n.textColor,extendedProps:{...n.extendedProps}}),u++)}Swal.fire({icon:"success",title:"Copiado completado",html:`Se han creado <b>${u}</b> registros en ${p}.`,timer:1400,showConfirmButton:!1})}async function F({maquinaId:l,maquinaNombre:p,fechaISO:a,duracionSemanas:r,calendar:c}){const d=r===1?"la semana actual":"las pr√≥ximas 2 semanas";if(await Swal.fire({icon:"question",title:"Copiar semana anterior",html:`¬øCopiar los turnos de la semana anterior de <b>${p}</b> para ${d}?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6"}).then(u=>u.isConfirmed))try{const u=new Date(a),g=u.getDay(),w=g===0?-6:1-g,n=new Date(u);n.setDate(u.getDate()+w);const i=n.toISOString().slice(0,10),b=await fetch("/asignaciones-turno/repetir-semana-maquina",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":R(),Accept:"application/json"},body:JSON.stringify({maquina_id:l,semana_inicio:i,duracion_semanas:r})}),e=await b.json();if(!b.ok)throw new Error(e.message||`Error HTTP ${b.status}`);e.eventos&&e.eventos.length>0&&e.eventos.forEach(t=>{c.getEventById(t.id)||c.addEvent({id:t.id,title:t.title,start:t.start,end:t.end,resourceId:t.resourceId,backgroundColor:t.backgroundColor,borderColor:t.borderColor,textColor:t.textColor||"#000000",extendedProps:t.extendedProps||{}})}),await Swal.fire({icon:"success",title:"Turnos copiados",html:`Se han copiado <b>${e.turnos_creados||0}</b> turnos correctamente.`,timer:2e3,showConfirmButton:!1})}catch(u){console.error("Error al copiar turnos:",u),await Swal.fire({icon:"error",title:"Error",text:u.message||"No se pudieron copiar los turnos",confirmButtonText:"Aceptar"})}}function Y(l,p,{fechaISO:a,resourceId:r},c,d){var b;const f=new Date(a);f.setDate(f.getDate()-1);const u=new Date(a);u.setDate(u.getDate()+1);const g=f.toISOString().slice(0,10),w=u.toISOString().slice(0,10),n=r?((b=d.find(e=>String(e.id)===String(r)))==null?void 0:b.title)||`M√°quina ${r}`:"Seleccione una m√°quina",i=[{icon:"üìÖ",label:"Crear festivo este d√≠a",onClick:async()=>{const e=await X(a);if(!e)return;const t=new Date(e.fecha+"T00:00:00"),o=new Date(t);o.setDate(o.getDate()+1);const s=(d||[]).map(h=>h.id);c.addEvent({id:"festivo-"+e.id,title:e.titulo,start:t.toISOString(),end:o.toISOString(),allDay:!0,resourceIds:s,backgroundColor:"#ff0000",borderColor:"#b91c1c",textColor:"#ffffff",editable:!0,classNames:["evento-festivo"],extendedProps:{es_festivo:!0,festivo_id:e.id,entrada:null,salida:null}}),Swal.fire({icon:"success",title:"Festivo creado",timer:1200,showConfirmButton:!1})}},{icon:"‚¨ÖÔ∏è",label:`Copiar registros del d√≠a anterior (${g} ‚Üí ${a})`,onClick:()=>O({fromISO:g,toISO:a,calendar:c})},{icon:"‚û°Ô∏è",label:`Copiar registros del d√≠a siguiente (${w} ‚Üí ${a})`,onClick:()=>O({fromISO:w,toISO:a,calendar:c})},{icon:"üìÖ",label:r?`Copiar semana anterior ‚Üí semana actual (${n})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!r,onClick:()=>F({maquinaId:r,maquinaNombre:n,fechaISO:a,duracionSemanas:1,calendar:c})},{icon:"üìÖüìÖ",label:r?`Copiar semana anterior ‚Üí 2 semanas (${n})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!r,onClick:()=>F({maquinaId:r,maquinaNombre:n,fechaISO:a,duracionSemanas:2,calendar:c})},{icon:"üîß",label:r?`Generar turnos para ${n}`:"Generar turnos (seleccione una m√°quina)",disabled:!r,onClick:async()=>{var t;if(console.log("[menu] Click en generar turnos, resourceId:",r),!r){console.log("[menu] No hay resourceId, mostrando advertencia"),Swal.fire({icon:"warning",title:"M√°quina no seleccionada",text:"Haz clic derecho sobre una m√°quina espec√≠fica para generar turnos."});return}console.log("[menu] Llamando a generarTurnosDialog...");const e=await K(a,r,n);if(console.log("[menu] Resultado del di√°logo:",e),e&&e.eventos){console.log("[menu] Procesando eventos:",e.eventos.length);const o=(t=e.eventos[0])==null?void 0:t.user_id;if(o){const s=c.getEvents(),h=e.eventos.map(m=>m.start);s.forEach(m=>{var T,y,S,j;const v=(T=m.extendedProps)==null?void 0:T.user_id,x=((y=m.startStr)==null?void 0:y.slice(0,10))||((S=m.start)==null?void 0:S.toISOString().slice(0,10));v===o&&h.includes(x)&&!((j=m.extendedProps)!=null&&j.es_festivo)&&(console.log("[menu] Eliminando evento antiguo:",m.id),m.remove())})}e.eventos.forEach(s=>{c.addEvent({id:s.id,title:s.title,start:s.start,resourceId:s.resourceId,allDay:!0,backgroundColor:s.backgroundColor,borderColor:s.borderColor,textColor:s.textColor||"#000000",extendedProps:{user_id:s.user_id,categoria_nombre:s.categoria_nombre,turno:s.turno,entrada:s.entrada,salida:s.salida,foto:s.foto,es_festivo:!1}})}),console.log("[menu] Eventos actualizados correctamente")}}}];W(l,p,{headerHtml:`<div>Acciones para <b>${a}</b></div>`,items:i})}function J(l,p,{event:a,titulo:r}){A(l,p,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${r}
    </div>
    <button id="ctx-eliminar-festivo" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      üóëÔ∏è Eliminar festivo
    </button>
  `).querySelector("#ctx-eliminar-festivo").addEventListener("click",async()=>{if(C(),!await Swal.fire({icon:"warning",title:"Eliminar festivo",html:`<div>¬øSeguro que quieres eliminar <b>${r}</b>?</div>`,showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(u=>u.isConfirmed))return;const f=a.extendedProps.festivo_id;await B(D().festivo.delete.replace("__ID__",f),{method:"DELETE"}),a.remove(),Swal.fire({icon:"success",title:"Festivo eliminado",timer:1200,showConfirmButton:!1})})}async function G(l){const p=l.extendedProps||{},a=p.entrada||"",r=p.salida||"",c=await Swal.fire({title:"Editar fichaje",html:`
      <div class="flex flex-col gap-3">
        <label class="text-left text-sm">Entrada</label>
        <input id="entradaHora" type="time" class="swal2-input" value="${a}">
        <label class="text-left text-sm">Salida</label>
        <input id="salidaHora" type="time" class="swal2-input" value="${r}">
      </div>`,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",preConfirm:()=>{const f=document.getElementById("entradaHora").value,u=document.getElementById("salidaHora").value;return!f&&!u?(Swal.showValidationMessage("Debes indicar al menos una hora"),!1):{entrada:f,salida:u}}});if(!c.isConfirmed)return;const d=l.id.toString().replace(/^turno-/,"");await B(D().asignacion.updateHoras.replace("__ID__",d),{method:"POST",body:c.value}),l.setExtendedProp("entrada",c.value.entrada),l.setExtendedProp("salida",c.value.salida),Swal.fire({icon:"success",title:"Horas actualizadas",timer:1500,showConfirmButton:!1})}function U(l,p,a){var u,g;const r=a.title||"Operario",c=((u=a.extendedProps)==null?void 0:u.categoria_nombre)??"",d=((g=a.extendedProps)==null?void 0:g.especialidad_nombre)??"Sin especialidad",f=A(l,p,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${r} <div style="font-size:12px">${c} ¬∑ ${d}</div>
    </div>
    <button id="ctx-editar-fichajes" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      ‚úèÔ∏è Editar fichajes
    </button>
    <button id="ctx-eliminar-registro" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;color:#b91c1c;">
      üóëÔ∏è Eliminar registro
    </button>
  `);f.querySelector("#ctx-editar-fichajes").addEventListener("click",async()=>{C(),await G(a)}),f.querySelector("#ctx-eliminar-registro").addEventListener("click",async()=>{var b;if(C(),!await Swal.fire({icon:"warning",title:"Eliminar registro",html:`<div>¬øSeguro que quieres eliminar este evento/asignaci√≥n?</div>
                   <div class="text-xs text-gray-500 mt-1">Esta acci√≥n no se puede deshacer.</div>`,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",showCancelButton:!0,confirmButtonColor:"#b91c1c"}).then(e=>e.isConfirmed))return;const n="/asignaciones-turnos/destroy",i={_method:"DELETE",fecha_inicio:a.startStr,fecha_fin:a.endStr??a.startStr,tipo:"eliminarTurnoEstado",user_id:(b=a.extendedProps)==null?void 0:b.user_id};try{await B(n,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(i)}),a.remove(),Swal.fire({icon:"success",title:"Registro eliminado",timer:1300,showConfirmButton:!1})}catch(e){console.error("Error al eliminar el turno:",e),Swal.fire({icon:"error",title:"Error al eliminar",text:e.message||"No se pudo eliminar el turno."})}})}function Q(l,p){const a=[];if(!l||typeof l!="object")return a;const r=(p||[]).filter(d=>d.hora_inicio&&d.hora_fin);if(r.length===0)return a;const c={};r.forEach(d=>{const f=d.nombre.toLowerCase(),[u]=d.hora_inicio.split(":").map(Number),[g]=d.hora_fin.split(":").map(Number),w=g<u;let n,i;w?(n="00:00:00",i="00:30:00"):u<14?(n="08:00:00",i="08:30:00"):(n="16:00:00",i="16:30:00"),c[f]={esNocturno:w,slotInicio:n,slotFin:i,color:d.color}});for(const[d,f]of Object.entries(l))if(!(!f||typeof f!="object")){for(const[u,g]of Object.entries(f))if(g)for(const[w,n]of Object.entries(c)){const i=g[w]||0;i<=0||a.push({id:`carga-${d}-${u}-${w}`,title:`${i}h`,start:`${u}T${n.slotInicio}`,end:`${u}T${n.slotFin}`,resourceId:d,backgroundColor:H(i),borderColor:H(i),textColor:"#000",editable:!1,classNames:["evento-carga"],extendedProps:{es_carga:!0,turno:w,horas:i}})}}return a}function H(l){return l>6?"#fca5a5":l>3?"#fcd34d":"#86efac"}function Z(l){const p={slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[]};if(!l||l.length===0)return p;const a=l.filter(c=>c.hora_inicio&&c.hora_fin);return a.length===0?p:{slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[...a].sort((c,d)=>{const[f]=c.hora_inicio.split(":").map(Number),[u]=c.hora_fin.split(":").map(Number),[g]=d.hora_inicio.split(":").map(Number),[w]=d.hora_fin.split(":").map(Number),n=u<f,i=w<g;return n&&!i?-1:!n&&i?1:f-g})}}function ee(l,p,a){const r=localStorage.getItem(l);return p.includes(r)?r:a}function te(l){const{maquinas:p,eventos:a,cargaTrabajo:r,turnos:c}=V(),d=Z(c),f=Q(r,c),u=[...a,...f],g="vistaObras",w="fechaObras";let n=!1;const i=new FullCalendar.Calendar(l,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",locale:"es",initialView:ee(g,["resourceTimelineDay","resourceTimelineWeek"],"resourceTimelineWeek"),initialDate:localStorage.getItem(w)||void 0,selectable:!0,unselectAuto:!0,datesSet(e){localStorage.setItem("vistaObras",e.view.type),localStorage.setItem("fechaObras",e.startStr);const t=e.view.type==="resourceTimelineDay";if(l.classList.toggle("vista-dia",t),l.classList.toggle("vista-semana",!t),t){const s=l.querySelector(".fc-toolbar-title");if(s){const h=e.start,m={weekday:"long",day:"numeric",month:"long",year:"numeric"};s.textContent=h.toLocaleDateString("es-ES",m)}}const o=document.getElementById("btnRepetirSemana");o&&(e.view.type==="resourceTimelineWeek"?(o.classList.remove("hidden"),o.dataset.fecha=e.startStr):o.classList.add("hidden"))},displayEventEnd:!0,eventMinHeight:30,firstDay:1,height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"resourceTimelineDay,resourceTimelineWeek"},buttonText:{today:"Hoy",week:"Semana",day:"D√≠a"},slotLabelDidMount(e){if(e.view.type==="resourceTimelineDay"&&d.turnos){const o=e.date.getHours();let s=0;o>=8&&o<16?s=1:o>=16&&(s=2);const h=d.turnos[s];h&&(e.el.style.backgroundColor=h.color||"#e5e7eb")}},slotLabelContent(e){if(e.view.type==="resourceTimelineDay"){const o=e.date.getHours();if(o===0)return{html:"<b>Noche</b>"};if(o===8)return{html:"<b>Ma√±ana</b>"};if(o===16)return{html:"<b>Tarde</b>"}}return null},views:{resourceTimelineDay:{slotMinTime:d.slotMinTime,slotMaxTime:d.slotMaxTime,slotDuration:d.slotDuration,titleFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"}},resourceTimelineWeek:{slotDuration:{days:1},slotLabelFormat:{weekday:"long"}}},editable:!0,resources:p,resourceOrder:"orden",resourceAreaWidth:"100px",resourceLabelDidMount(e){const t=e.resource.extendedProps.backgroundColor;t&&(e.el.style.backgroundColor=t,e.el.style.color="#fff")},filterResourcesWithEvents:!1,events:u,resourceAreaColumns:[{field:"title",headerContent:"M√°quinas"}],eventDragStart:e=>{n=!0;const t=e.el;t._tippy&&t._tippy.destroy(),document.querySelectorAll(".fc-event").forEach(o=>{o._tippy&&o._tippy.disable()})},eventDragStop:e=>{n=!1,setTimeout(()=>{document.querySelectorAll(".fc-event").forEach(t=>{t._tippy&&t._tippy.enable()})},100)},eventDrop:async e=>{var s,h;const t=e.event,o=t.extendedProps||{};try{if(o.es_festivo){const _=t.startStr.slice(0,10);await fetch(D().festivo.update.replace("__ID__",o.festivo_id),{method:"PUT",headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({fecha:_})}).then($=>{if(!$.ok)throw new Error(`HTTP ${$.status}`)});return}const m=t.id.replace(/^turno-/,""),v=(s=t.getResources())==null?void 0:s[0],x=v?parseInt(v.id,10):null,T=(h=t.start)==null?void 0:h.toISOString(),y=new Date(T).getHours();let S=null;for(const _ of d.turnos){const[$]=_.hora_inicio.split(":").map(Number),[N]=_.hora_fin.split(":").map(Number),z=N<$;let q=!1;if(z?q=y>=$||y<N:q=y>=$&&y<N,q){S=_.id;break}}if(S||(S=y>=6&&y<14?1:y>=14&&y<22?2:3),!x||!T)throw new Error("Datos incompletos");const j=D().asignacion.updatePuesto.replace("__ID__",m),I=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf},body:JSON.stringify({maquina_id:x,start:T,turno_id:S})}),E=await I.json();if(!I.ok)throw new Error((E==null?void 0:E.message)||`HTTP ${I.status}`);E.color&&(t.setProp("backgroundColor",E.color),t.setProp("borderColor",E.color)),typeof E.nuevo_obra_id<"u"&&t.setExtendedProp("obra_id",E.nuevo_obra_id),t.setExtendedProp("turno_id",S);const L=d.turnos.find(_=>_.id===S);L&&t.setExtendedProp("turno_nombre",L.nombre),i.refetchEvents()}catch(m){console.error(m),Swal.fire("Error",m.message||"Ocurri√≥ un error inesperado.","error"),e.revert()}},eventDidMount(e){const t=e.event,o=t.extendedProps||{};if(o.es_carga){e.el.title=`${o.horas}h de trabajo - Turno ${o.turno}`;return}if(e.el._tippy&&e.el._tippy.destroy(),o.foto&&!o.es_festivo){const s=`<img src="${o.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`,h=tippy(e.el,{content:s,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(n)return!1}});n&&h&&h.disable()}e.el.addEventListener("contextmenu",s=>{s.preventDefault(),s.stopPropagation(),o.es_festivo?J(s.clientX,s.clientY,{event:t,titulo:t.title}):U(s.clientX,s.clientY,t)})},eventClick(e){const o=e.event.extendedProps||{};if(o.es_festivo)return;const s=o.user_id;if(s){const h=D().userShow.replace(":id",s);window.location.href=h}},eventContent(e){const t=e.event.extendedProps;if(t!=null&&t.es_carga)return{html:`<div class="carga-content">${t.horas}h</div>`};if(t!=null&&t.es_festivo)return{html:`<div class="px-2 py-1 text-xs font-semibold" style="color:#fff">${e.event.title}</div>`};const o=t.entrada&&t.salida?`${t.entrada} / ${t.salida}`:t.entrada||t.salida||"-- / --",s=t.turno_nombre?t.turno_nombre.charAt(0).toUpperCase()+t.turno_nombre.slice(1):"";return{html:`
          <div class="px-2 py-1 text-xs font-semibold flex items-center">
            <div class="flex flex-col">
              <span>${e.event.title} <span class="text-[10px] font-medium opacity-70">[${s}]</span></span>
              <span class="text-[10px] font-normal opacity-80">(${t.categoria_nombre??""} üõ† ${t.especialidad_nombre??"Sin especialidad"})</span>
            </div>
            <div class="ml-auto text-right">
              <span class="text-[10px] font-normal opacity-80">${o}</span>
            </div>
          </div>`}}});i.render(),console.log("[cal] Configurando event listener para contextmenu...");const b=i.el;return console.log("[cal] Elemento ra√≠z del calendario:",b),console.log("[cal] Agregando event listener de contextmenu al calendario"),b.addEventListener("contextmenu",e=>{if(console.log("[cal] ¬°Contextmenu disparado!",e.target),e.target.closest(".fc-event")){console.log("[cal] Es un evento, ignorando");return}e.preventDefault();let t=null,o=null;const s=e.target.closest("[data-date]");if(s&&(o=s.getAttribute("data-date")||"",o.length>=10&&(o=o.slice(0,10))),!o){console.log("[cal] No se pudo determinar la fecha");return}console.log("[cal] Fecha encontrada:",o),console.log("[cal] Elemento clickeado:",e.target),console.log("[cal] Elemento con data-date:",s);const h=b.querySelectorAll(".fc-timeline-lane[data-resource-id]");if(console.log("[cal] Filas de recursos encontradas:",h.length),h.length>0){const m=e.clientY;console.log("[cal] Posici√≥n Y del click:",m);for(const v of h){const x=v.getBoundingClientRect();if(console.log("[cal] Examinando lane con resource-id:",v.dataset.resourceId,"top:",x.top,"bottom:",x.bottom),m>=x.top&&m<=x.bottom){t=v.dataset.resourceId,console.log("[cal] ¬°ResourceId encontrado por posici√≥n Y!:",t);break}}}console.log("[cal] ResourceId final detectado:",t,"Fecha:",o),Y(e.clientX,e.clientY,{fechaISO:o,resourceId:t},i,p)}),console.log("[cal] Event listener de contextmenu agregado correctamente"),i}function M(){const l=document.getElementById("calendario");if(!l||l.getAttribute("data-calendar-type")!=="trabajadores"||!window.AppPlanif)return;if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}const p=te(l);window.calendarTrabajadores=p}function oe(){if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();document.addEventListener("livewire:navigated",M);document.addEventListener("livewire:navigating",oe);
