const k=()=>window.AppPlanif,R=()=>k().csrf,D=()=>k().routes,z=()=>({maquinas:k().maquinas,eventos:k().eventos,cargaTrabajo:k().cargaTrabajo||{},turnos:k().turnos||[]});let I=null;function S(){I&&(I.remove(),I=null,document.removeEventListener("click",S),document.removeEventListener("scroll",S,!0),window.removeEventListener("resize",S))}function q(s,f,n){S();const l=document.createElement("div");l.className="fc-contextmenu",Object.assign(l.style,{position:"fixed",zIndex:9999,minWidth:"240px",background:"#fff",border:"1px solid #e5e7eb",boxShadow:"0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05)",borderRadius:"8px",overflow:"hidden",visibility:"hidden"}),l.innerHTML=n,document.body.appendChild(l);const c=l.getBoundingClientRect(),d=window.innerHeight,u=window.innerWidth;let m=f;f+c.height>d&&(m=f-c.height,m<0&&(m=Math.max(0,d-c.height)));let b=s;return s+c.width>u&&(b=s-c.width,b<0&&(b=Math.max(0,u-c.width))),Object.assign(l.style,{top:m+"px",left:b+"px",visibility:"visible"}),I=l,setTimeout(()=>{document.addEventListener("click",S),document.addEventListener("scroll",S,!0),window.addEventListener("resize",S)},0),l}function V(s,f,{headerHtml:n="",items:l=[]}){const c=`
    <div class="ctx-menu-container">
      ${n?`<div class="ctx-menu-header">${n}</div>`:""}
      ${l.map((u,m)=>`
        <button class="ctx-menu-item${u.danger?" ctx-menu-danger":""}${u.disabled?" ctx-menu-disabled":""}" data-idx="${m}" ${u.disabled?"disabled":""}>
          ${u.icon?`<span class="ctx-menu-icon">${u.icon}</span>`:""}
          <span class="ctx-menu-label">${u.label}</span>
        </button>
      `).join("")}
    </div>
  `,d=q(s,f,c);return d.querySelectorAll(".ctx-menu-item").forEach(u=>{const m=parseInt(u.dataset.idx,10),b=l[m];u.addEventListener("click",async v=>{if(v.preventDefault(),v.stopPropagation(),console.log("[baseMenu] Click en item:",b.label,"disabled:",b.disabled),b.disabled){console.log("[baseMenu] Item deshabilitado, ignorando");return}const o=b.onClick;console.log("[baseMenu] Ejecutando acci√≥n..."),S();try{await(o==null?void 0:o()),console.log("[baseMenu] Acci√≥n completada")}catch(r){console.error("[baseMenu] Error en acci√≥n:",r)}})}),d}async function P(s,f={}){const n={headers:{Accept:"application/json","X-CSRF-TOKEN":R()},...f};n.body&&typeof n.body!="string"&&(n.headers["Content-Type"]="application/json",n.body=JSON.stringify(n.body));const l=await fetch(s,n);let c=null;try{c=await l.json()}catch{}if(!l.ok)throw new Error((c==null?void 0:c.message)||`HTTP ${l.status}`);return c}async function W(s){const f=await Swal.fire({title:"Nuevo festivo",input:"text",inputLabel:"T√≠tulo del festivo",inputValue:"Festivo",showCancelButton:!0,confirmButtonText:"Crear",cancelButtonText:"Cancelar",inputValidator:l=>!l||!l.trim()?"Pon un t√≠tulo":void 0});return f.isConfirmed?(await P(D().festivo.store,{method:"POST",body:{fecha:s,titulo:f.value.trim()}})).festivo:null}async function X(s,f,n){let l=[],c=[],d=[];try{const r=await fetch(`/api/usuarios/operarios-agrupados?fecha=${s}&maquina_id=${f}`,{headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"}});if(r.ok){const h=await r.json();l=h.todos||[],c=h.sin_turno||[],d=h.de_maquina||[]}else console.error("Error al obtener operarios:",r.status)}catch(r){console.error("Error al obtener operarios:",r)}const u=(r,h="No hay trabajadores")=>r.length===0?`<option value="" disabled>${h}</option>`:r.map(e=>`<option value="${e.id}">${e.name} ${e.primer_apellido||""} ${e.segundo_apellido||""}</option>`).join(""),m=u(c,"No hay operarios sin turno este d√≠a"),b=u(l,"No hay operarios disponibles"),v=u(d,"No hay operarios asignados a esta m√°quina"),{value:o}=await Swal.fire({title:"üîß Generar Turnos",html:`
            <div class="text-left space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha inicio:</strong> ${s}<br>
                        <strong>M√°quina:</strong> ${n}
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Sin turno asignado este d√≠a <span class="text-green-600">(${c.length})</span>
                    </label>
                    <select id="swal-trabajador-sin-turno" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${m}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Asignados a ${n} <span class="text-blue-600">(${d.length})</span>
                    </label>
                    <select id="swal-trabajador-maquina" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${v}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Todos los operarios <span class="text-gray-600">(${l.length})</span>
                    </label>
                    <select id="swal-trabajador-todos" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${b}
                    </select>
                </div>

                <input type="hidden" id="swal-trabajador" value="" />

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Alcance de generaci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-alcance" class="swal2-input w-full">
                        <option value="un_dia">Solo este d√≠a (${s})</option>
                        <option value="resto_a√±o">Desde ${s} hasta fin de a√±o</option>
                    </select>
                </div>

                <div class="mb-4" id="turno-inicio-container" style="display: none;">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Turno inicial (para diurnos) <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-turno-inicio" class="swal2-input w-full">
                        <option value="ma√±ana">Ma√±ana</option>
                        <option value="tarde">Tarde</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Los turnos alternar√°n cada viernes</p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">
                        <strong>Nota:</strong> Se saltar√°n autom√°ticamente s√°bados, domingos, festivos y d√≠as con vacaciones.
                    </p>
                </div>
            </div>
        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Generar Turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",width:"600px",didOpen:()=>{const r=document.getElementById("swal-trabajador"),h=document.getElementById("turno-inicio-container"),e=document.getElementById("swal-trabajador-sin-turno"),t=document.getElementById("swal-trabajador-maquina"),a=document.getElementById("swal-trabajador-todos"),i=[...c,...d,...l];function g(p,w){r.value=p,w!==e&&(e.value=""),w!==t&&(t.value=""),w!==a&&(a.value="");const x=i.find(E=>E.id===parseInt(p));x&&x.turno==="diurno"?h.style.display="block":h.style.display="none"}e.addEventListener("change",p=>{p.target.value&&g(p.target.value,e)}),t.addEventListener("change",p=>{p.target.value&&g(p.target.value,t)}),a.addEventListener("change",p=>{p.target.value&&g(p.target.value,a)})},preConfirm:()=>{const r=document.getElementById("swal-trabajador").value,h=document.getElementById("swal-alcance").value,e=document.getElementById("swal-turno-inicio").value;return r?{trabajador_id:r,alcance:h,turno_inicio:e}:(Swal.showValidationMessage("Debes seleccionar un trabajador"),!1)}});if(!o)return null;try{const h=[...c,...d,...l].find(i=>i.id===parseInt(o.trabajador_id)),t=await fetch("/profile/generar-turnos-calendario",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"},body:JSON.stringify({user_id:o.trabajador_id,maquina_id:f,fecha_inicio:s,alcance:o.alcance,turno_inicio:o.turno_inicio})}),a=await t.json();if(!t.ok)throw new Error(a.message||`Error HTTP ${t.status}`);return{...a,eventos:a.eventos||[]}}catch(r){return console.error("Error al generar turnos:",r),await Swal.fire({icon:"error",title:"Error",text:r.message||"No se pudieron generar los turnos",confirmButtonText:"Aceptar"}),null}}async function A({fromISO:s,toISO:f,calendar:n}){var b,v;if(!await Swal.fire({icon:"question",title:"Copiar registros",html:`¬øCopiar registros de <b>${s}</b> a <b>${f}</b>?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar"}).then(o=>o.isConfirmed))return;const c=n.getEvents().filter(o=>{var r;return!((r=o.extendedProps)!=null&&r.es_festivo)}),d=(o,r,h)=>c.some(e=>{var a,i,g,p;const t=((i=(a=e.getResources)==null?void 0:a.call(e)[0])==null?void 0:i.id)??((g=e.extendedProps)==null?void 0:g.resourceId)??null;return e.title===o&&String(t)===String(r)&&(e.startStr||((p=e.start)==null?void 0:p.toISOString())).slice(0,10)===h}),u=c.filter(o=>{var r;return(o.startStr||((r=o.start)==null?void 0:r.toISOString())).slice(0,10)===s});let m=0;for(const o of u){const r=o.getResources?o.getResources():[],h=((b=r==null?void 0:r[0])==null?void 0:b.id)??((v=o.extendedProps)==null?void 0:v.resourceId)??null,e=o.start?new Date(o.start):null,t=o.end?new Date(o.end):null,a=e?`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`:"08:00",i=t?`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`:null,g=new Date(`${f}T${a}:00`),p=i?new Date(`${f}T${i}:00`):null;d(o.title,h,f)||(n.addEvent({id:`tmp-copy-${Date.now()}-${Math.random().toString(36).slice(2)}`,title:o.title,start:g.toISOString(),end:p?p.toISOString():null,resourceId:h??void 0,allDay:o.allDay,backgroundColor:o.backgroundColor,borderColor:o.borderColor,textColor:o.textColor,extendedProps:{...o.extendedProps}}),m++)}Swal.fire({icon:"success",title:"Copiado completado",html:`Se han creado <b>${m}</b> registros en ${f}.`,timer:1400,showConfirmButton:!1})}function Y(s,f,{fechaISO:n,resourceId:l},c,d){var h;const u=new Date(n);u.setDate(u.getDate()-1);const m=new Date(n);m.setDate(m.getDate()+1);const b=u.toISOString().slice(0,10),v=m.toISOString().slice(0,10),o=l?((h=d.find(e=>String(e.id)===String(l)))==null?void 0:h.title)||`M√°quina ${l}`:"Seleccione una m√°quina",r=[{icon:"üìÖ",label:"Crear festivo este d√≠a",onClick:async()=>{const e=await W(n);if(!e)return;const t=new Date(e.fecha+"T00:00:00"),a=new Date(t);a.setDate(a.getDate()+1);const i=(d||[]).map(g=>g.id);c.addEvent({id:"festivo-"+e.id,title:e.titulo,start:t.toISOString(),end:a.toISOString(),allDay:!0,resourceIds:i,backgroundColor:"#ff0000",borderColor:"#b91c1c",textColor:"#ffffff",editable:!0,classNames:["evento-festivo"],extendedProps:{es_festivo:!0,festivo_id:e.id,entrada:null,salida:null}}),Swal.fire({icon:"success",title:"Festivo creado",timer:1200,showConfirmButton:!1})}},{icon:"‚¨ÖÔ∏è",label:`Copiar registros del d√≠a anterior (${b} ‚Üí ${n})`,onClick:()=>A({fromISO:b,toISO:n,calendar:c})},{icon:"‚û°Ô∏è",label:`Copiar registros del d√≠a siguiente (${v} ‚Üí ${n})`,onClick:()=>A({fromISO:v,toISO:n,calendar:c})},{icon:"üîß",label:l?`Generar turnos para ${o}`:"Generar turnos (seleccione una m√°quina)",disabled:!l,onClick:async()=>{var t;if(console.log("[menu] Click en generar turnos, resourceId:",l),!l){console.log("[menu] No hay resourceId, mostrando advertencia"),Swal.fire({icon:"warning",title:"M√°quina no seleccionada",text:"Haz clic derecho sobre una m√°quina espec√≠fica para generar turnos."});return}console.log("[menu] Llamando a generarTurnosDialog...");const e=await X(n,l,o);if(console.log("[menu] Resultado del di√°logo:",e),e&&e.eventos){console.log("[menu] Procesando eventos:",e.eventos.length);const a=(t=e.eventos[0])==null?void 0:t.user_id;if(a){const i=c.getEvents(),g=e.eventos.map(p=>p.start);i.forEach(p=>{var E,y,C,j;const w=(E=p.extendedProps)==null?void 0:E.user_id,x=((y=p.startStr)==null?void 0:y.slice(0,10))||((C=p.start)==null?void 0:C.toISOString().slice(0,10));w===a&&g.includes(x)&&!((j=p.extendedProps)!=null&&j.es_festivo)&&(console.log("[menu] Eliminando evento antiguo:",p.id),p.remove())})}e.eventos.forEach(i=>{c.addEvent({id:i.id,title:i.title,start:i.start,resourceId:i.resourceId,allDay:!0,backgroundColor:i.backgroundColor,borderColor:i.borderColor,textColor:i.textColor||"#000000",extendedProps:{user_id:i.user_id,categoria_nombre:i.categoria_nombre,turno:i.turno,entrada:i.entrada,salida:i.salida,foto:i.foto,es_festivo:!1}})}),console.log("[menu] Eventos actualizados correctamente")}}}];V(s,f,{headerHtml:`<div>Acciones para <b>${n}</b></div>`,items:r})}function K(s,f,{event:n,titulo:l}){q(s,f,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${l}
    </div>
    <button id="ctx-eliminar-festivo" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      üóëÔ∏è Eliminar festivo
    </button>
  `).querySelector("#ctx-eliminar-festivo").addEventListener("click",async()=>{if(S(),!await Swal.fire({icon:"warning",title:"Eliminar festivo",html:`<div>¬øSeguro que quieres eliminar <b>${l}</b>?</div>`,showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(m=>m.isConfirmed))return;const u=n.extendedProps.festivo_id;await P(D().festivo.delete.replace("__ID__",u),{method:"DELETE"}),n.remove(),Swal.fire({icon:"success",title:"Festivo eliminado",timer:1200,showConfirmButton:!1})})}async function J(s){const f=s.extendedProps||{},n=f.entrada||"",l=f.salida||"",c=await Swal.fire({title:"Editar fichaje",html:`
      <div class="flex flex-col gap-3">
        <label class="text-left text-sm">Entrada</label>
        <input id="entradaHora" type="time" class="swal2-input" value="${n}">
        <label class="text-left text-sm">Salida</label>
        <input id="salidaHora" type="time" class="swal2-input" value="${l}">
      </div>`,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",preConfirm:()=>{const u=document.getElementById("entradaHora").value,m=document.getElementById("salidaHora").value;return!u&&!m?(Swal.showValidationMessage("Debes indicar al menos una hora"),!1):{entrada:u,salida:m}}});if(!c.isConfirmed)return;const d=s.id.toString().replace(/^turno-/,"");await P(D().asignacion.updateHoras.replace("__ID__",d),{method:"POST",body:c.value}),s.setExtendedProp("entrada",c.value.entrada),s.setExtendedProp("salida",c.value.salida),Swal.fire({icon:"success",title:"Horas actualizadas",timer:1500,showConfirmButton:!1})}function G(s,f,n){var m,b;const l=n.title||"Operario",c=((m=n.extendedProps)==null?void 0:m.categoria_nombre)??"",d=((b=n.extendedProps)==null?void 0:b.especialidad_nombre)??"Sin especialidad",u=q(s,f,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${l} <div style="font-size:12px">${c} ¬∑ ${d}</div>
    </div>
    <button id="ctx-editar-fichajes" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      ‚úèÔ∏è Editar fichajes
    </button>
    <button id="ctx-eliminar-registro" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;color:#b91c1c;">
      üóëÔ∏è Eliminar registro
    </button>
  `);u.querySelector("#ctx-editar-fichajes").addEventListener("click",async()=>{S(),await J(n)}),u.querySelector("#ctx-eliminar-registro").addEventListener("click",async()=>{var h;if(S(),!await Swal.fire({icon:"warning",title:"Eliminar registro",html:`<div>¬øSeguro que quieres eliminar este evento/asignaci√≥n?</div>
                   <div class="text-xs text-gray-500 mt-1">Esta acci√≥n no se puede deshacer.</div>`,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",showCancelButton:!0,confirmButtonColor:"#b91c1c"}).then(e=>e.isConfirmed))return;const o="/asignaciones-turnos/destroy",r={_method:"DELETE",fecha_inicio:n.startStr,fecha_fin:n.endStr??n.startStr,tipo:"eliminarTurnoEstado",user_id:(h=n.extendedProps)==null?void 0:h.user_id};try{await P(o,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(r)}),n.remove(),Swal.fire({icon:"success",title:"Registro eliminado",timer:1300,showConfirmButton:!1})}catch(e){console.error("Error al eliminar el turno:",e),Swal.fire({icon:"error",title:"Error al eliminar",text:e.message||"No se pudo eliminar el turno."})}})}function U(s,f){const n=[];if(!s||typeof s!="object")return n;const l=(f||[]).filter(d=>d.hora_inicio&&d.hora_fin);if(l.length===0)return n;const c={};l.forEach(d=>{const u=d.nombre.toLowerCase(),[m]=d.hora_inicio.split(":").map(Number),[b]=d.hora_fin.split(":").map(Number),v=b<m;let o,r;v?(o="22:00:00",r="22:30:00"):m<14?(o="06:00:00",r="06:30:00"):(o="14:00:00",r="14:30:00"),c[u]={inicio:o,fin:r,color:d.color,esNocturno:v}});for(const[d,u]of Object.entries(s))if(!(!u||typeof u!="object")){for(const[m,b]of Object.entries(u))if(b)for(const[v,o]of Object.entries(c)){const r=b[v]||0;r<=0||n.push({id:`carga-${d}-${m}-${v}`,title:`${r}h`,start:`${m}T${o.inicio}`,end:`${m}T${o.fin}`,resourceId:d,backgroundColor:F(r),borderColor:F(r),textColor:"#000",editable:!1,classNames:["evento-carga"],extendedProps:{es_carga:!0,turno:v,horas:r}})}}return n}function F(s){return s>6?"#fca5a5":s>3?"#fcd34d":"#86efac"}function Q(s){const f={slotMinTime:"06:00:00",slotMaxTime:"30:00:00",slotDuration:"08:00:00",turnos:[]};if(!s||s.length===0)return f;const n=s.filter(o=>o.hora_inicio&&o.hora_fin);if(n.length===0)return f;const l=[...n].sort((o,r)=>(o.hora_inicio||"").localeCompare(r.hora_inicio||""));l[0];const c=n.find(o=>{const[r]=o.hora_inicio.split(":").map(Number),[h]=o.hora_fin.split(":").map(Number);return h<r}),d=6;let u=30;if(c){const[o]=c.hora_fin.split(":").map(Number);u=o+24}const m=u-d,b=n.length,v=Math.floor(m/b);return{slotMinTime:`${String(d).padStart(2,"0")}:00:00`,slotMaxTime:`${String(u).padStart(2,"0")}:00:00`,slotDuration:`${String(v).padStart(2,"0")}:00:00`,turnos:l}}function Z(s,f,n){const l=localStorage.getItem(s);return f.includes(l)?l:n}function ee(s){const{maquinas:f,eventos:n,cargaTrabajo:l,turnos:c}=z(),d=Q(c),u=U(l,c),m=[...n,...u],b="vistaObras",v="fechaObras";let o=!1;const r=new FullCalendar.Calendar(s,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",locale:"es",initialView:Z(b,["resourceTimelineDay","resourceTimelineWeek"],"resourceTimelineWeek"),initialDate:localStorage.getItem(v)||void 0,selectable:!0,unselectAuto:!0,datesSet(e){localStorage.setItem("vistaObras",e.view.type),localStorage.setItem("fechaObras",e.startStr);const t=e.view.type==="resourceTimelineDay";if(s.classList.toggle("vista-dia",t),s.classList.toggle("vista-semana",!t),t){const i=s.querySelector(".fc-toolbar-title");if(i){const g=e.start,p={weekday:"long",day:"numeric",month:"long",year:"numeric"};i.textContent=g.toLocaleDateString("es-ES",p)}}const a=document.getElementById("btnRepetirSemana");a&&(e.view.type==="resourceTimelineWeek"?(a.classList.remove("hidden"),a.dataset.fecha=e.startStr):a.classList.add("hidden"))},displayEventEnd:!0,eventMinHeight:30,firstDay:1,height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"resourceTimelineDay,resourceTimelineWeek"},buttonText:{today:"Hoy",week:"Semana",day:"D√≠a"},slotLabelDidMount(e){if(e.view.type==="resourceTimelineDay"&&d.turnos){const a=e.date.getHours();for(const i of d.turnos){const[g]=i.hora_inicio.split(":").map(Number),[p]=i.hora_fin.split(":").map(Number);let w=!1;if(p>g?w=a>=g&&a<p:w=a>=g||a<p,w){e.el.style.backgroundColor=i.color||"#e5e7eb";break}}}},views:{resourceTimelineDay:{slotMinTime:d.slotMinTime,slotMaxTime:d.slotMaxTime,slotDuration:d.slotDuration,slotLabelFormat:{hour:"2-digit",minute:"2-digit",hour12:!1},titleFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"}},resourceTimelineWeek:{slotDuration:{days:1},slotLabelFormat:{weekday:"long",day:"numeric",month:"short"}}},editable:!0,resources:f,resourceOrder:"orden",resourceAreaWidth:"100px",resourceLabelDidMount(e){const t=e.resource.extendedProps.backgroundColor;t&&(e.el.style.backgroundColor=t,e.el.style.color="#fff")},filterResourcesWithEvents:!1,events:m,resourceAreaColumns:[{field:"title",headerContent:"M√°quinas"}],eventDragStart:e=>{o=!0;const t=e.el;t._tippy&&t._tippy.destroy(),document.querySelectorAll(".fc-event").forEach(a=>{a._tippy&&a._tippy.disable()})},eventDragStop:e=>{o=!1,setTimeout(()=>{document.querySelectorAll(".fc-event").forEach(t=>{t._tippy&&t._tippy.enable()})},100)},eventDrop:async e=>{var i,g;const t=e.event,a=t.extendedProps||{};try{if(a.es_festivo){const _=t.startStr.slice(0,10);await fetch(D().festivo.update.replace("__ID__",a.festivo_id),{method:"PUT",headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({fecha:_})}).then($=>{if(!$.ok)throw new Error(`HTTP ${$.status}`)});return}const p=t.id.replace(/^turno-/,""),w=(i=t.getResources())==null?void 0:i[0],x=w?parseInt(w.id,10):null,E=(g=t.start)==null?void 0:g.toISOString(),y=new Date(E).getHours();let C=null;for(const _ of d.turnos){const[$]=_.hora_inicio.split(":").map(Number),[N]=_.hora_fin.split(":").map(Number),H=N<$;let B=!1;if(H?B=y>=$||y<N:B=y>=$&&y<N,B){C=_.id;break}}if(C||(C=y>=6&&y<14?1:y>=14&&y<22?2:3),!x||!E)throw new Error("Datos incompletos");const j=D().asignacion.updatePuesto.replace("__ID__",p),M=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf},body:JSON.stringify({maquina_id:x,start:E,turno_id:C})}),T=await M.json();if(!M.ok)throw new Error((T==null?void 0:T.message)||`HTTP ${M.status}`);T.color&&(t.setProp("backgroundColor",T.color),t.setProp("borderColor",T.color)),typeof T.nuevo_obra_id<"u"&&t.setExtendedProp("obra_id",T.nuevo_obra_id),t.setExtendedProp("turno_id",C);const O=d.turnos.find(_=>_.id===C);O&&t.setExtendedProp("turno_nombre",O.nombre),r.refetchEvents()}catch(p){console.error(p),Swal.fire("Error",p.message||"Ocurri√≥ un error inesperado.","error"),e.revert()}},eventDidMount(e){const t=e.event,a=t.extendedProps||{};if(a.es_carga){e.el.title=`${a.horas}h de trabajo - Turno ${a.turno}`;return}if(e.el._tippy&&e.el._tippy.destroy(),a.foto&&!a.es_festivo){const i=`<img src="${a.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`,g=tippy(e.el,{content:i,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(o)return!1}});o&&g&&g.disable()}e.el.addEventListener("contextmenu",i=>{i.preventDefault(),i.stopPropagation(),a.es_festivo?K(i.clientX,i.clientY,{event:t,titulo:t.title}):G(i.clientX,i.clientY,t)})},eventClick(e){const a=e.event.extendedProps||{};if(a.es_festivo)return;const i=a.user_id;if(i){const g=D().userShow.replace(":id",i);window.location.href=g}},eventContent(e){const t=e.event.extendedProps;if(t!=null&&t.es_carga)return{html:`<div class="carga-content">${t.horas}h</div>`};if(t!=null&&t.es_festivo)return{html:`<div class="px-2 py-1 text-xs font-semibold" style="color:#fff">${e.event.title}</div>`};const a=t.entrada&&t.salida?`${t.entrada} / ${t.salida}`:t.entrada||t.salida||"-- / --",i=t.turno_nombre?t.turno_nombre.charAt(0).toUpperCase()+t.turno_nombre.slice(1):"";return{html:`
          <div class="px-2 py-1 text-xs font-semibold flex items-center">
            <div class="flex flex-col">
              <span>${e.event.title} <span class="text-[10px] font-medium opacity-70">[${i}]</span></span>
              <span class="text-[10px] font-normal opacity-80">(${t.categoria_nombre??""} üõ† ${t.especialidad_nombre??"Sin especialidad"})</span>
            </div>
            <div class="ml-auto text-right">
              <span class="text-[10px] font-normal opacity-80">${a}</span>
            </div>
          </div>`}}});r.render(),console.log("[cal] Configurando event listener para contextmenu...");const h=r.el;return console.log("[cal] Elemento ra√≠z del calendario:",h),console.log("[cal] Agregando event listener de contextmenu al calendario"),h.addEventListener("contextmenu",e=>{if(console.log("[cal] ¬°Contextmenu disparado!",e.target),e.target.closest(".fc-event")){console.log("[cal] Es un evento, ignorando");return}e.preventDefault();let t=null,a=null;const i=e.target.closest("[data-date]");if(i&&(a=i.getAttribute("data-date")||"",a.length>=10&&(a=a.slice(0,10))),!a){console.log("[cal] No se pudo determinar la fecha");return}console.log("[cal] Fecha encontrada:",a),console.log("[cal] Elemento clickeado:",e.target),console.log("[cal] Elemento con data-date:",i);const g=h.querySelectorAll(".fc-timeline-lane[data-resource-id]");if(console.log("[cal] Filas de recursos encontradas:",g.length),g.length>0){const p=e.clientY;console.log("[cal] Posici√≥n Y del click:",p);for(const w of g){const x=w.getBoundingClientRect();if(console.log("[cal] Examinando lane con resource-id:",w.dataset.resourceId,"top:",x.top,"bottom:",x.bottom),p>=x.top&&p<=x.bottom){t=w.dataset.resourceId,console.log("[cal] ¬°ResourceId encontrado por posici√≥n Y!:",t);break}}}console.log("[cal] ResourceId final detectado:",t,"Fecha:",a),Y(e.clientX,e.clientY,{fechaISO:a,resourceId:t},r,f)}),console.log("[cal] Event listener de contextmenu agregado correctamente"),r}function L(){const s=document.getElementById("calendario");if(!s||s.getAttribute("data-calendar-type")!=="trabajadores"||!window.AppPlanif)return;if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}const f=ee(s);window.calendarTrabajadores=f}function te(){if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();document.addEventListener("livewire:navigated",L);document.addEventListener("livewire:navigating",te);
