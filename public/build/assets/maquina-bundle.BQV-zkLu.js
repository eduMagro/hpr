const jt="rgba(0, 0, 0, 0.8)",Lt="rgba(0, 0, 0, 1)",zt="rgba(0, 0, 0, 1)";function Ht(b,i){return!i||i===1?b.map(l=>({...l})):b.map(l=>l.type==="line"?{...l,length:(l.length||0)*i}:l.type==="arc"?{...l,radius:(l.radius||0)*i}:{...l})}const Xt=.75,$t=14,Vt=60,Pt=[0,10,-10,20,-20,30,-30];function F(b){return b*Math.PI/180}function Ut(b){const i=b.closest(".proceso");return i&&getComputedStyle(i).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Yt(b,i,l){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.setAttribute("viewBox","0 0 "+b+" "+i),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.style.width="100%",o.style.height="100%",o.style.display="block",o.style.background=l||"#ffffff",o.style.shapeRendering="geometricPrecision",o.style.textRendering="optimizeLegibility",o.style.boxSizing="border-box",o}function Wt(b,i,l,o){const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",i),s.setAttribute("stroke",l),s.setAttribute("fill","none"),s.setAttribute("stroke-width",o),s.setAttribute("vector-effect","non-scaling-stroke"),b.appendChild(s),s}function Ot(b){let i="",l=Number(b)||0;for(;l>=0;){const o=l%26;i=String.fromCharCode(65+o)+i,l=Math.floor(l/26)-1}return i}const Jt=0,Kt=-25;function Qt(b,i,l,o){if(!i||!i.length)return;const s=2,m=12,g=m+s,w=i.map(h=>(h.letter?h.letter+" ":"")+(h.text||"")),p=m*w.length+s*(w.length-1),a=Jt;let r=o-Kt-p+m/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let h=0;h<w.length;h++){const e=w[h],f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",a),f.setAttribute("y",r),f.setAttribute("fill",zt),f.setAttribute("font-size",m),f.setAttribute("text-anchor","start"),f.setAttribute("alignment-baseline","middle"),f.style.pointerEvents="none",f.textContent=e,b.appendChild(f);const c=_t(e,m).w;window.__legendBoxesGroup.push({left:a,right:a+c,top:r-m/2,bottom:r+m/2}),r+=g}}function Zt(b){const i=(b||"").split(/\s+/).filter(Boolean),l=[];for(let o=0;o<i.length;o++){const s=i[o];if(s.endsWith("r")){const m=parseFloat(s.slice(0,-1));let g=360;o+1<i.length&&i[o+1].endsWith("d")&&(g=parseFloat(i[++o].slice(0,-1))),l.push({type:"arc",radius:m,arcAngle:g})}else s.endsWith("d")?l.push({type:"turn",angle:parseFloat(s.slice(0,-1))}):l.push({type:"line",length:parseFloat(s)})}return l}function te(b){let i=[],l=0,o=0,s=0;i.push({x:l,y:o});for(let m=0;m<b.length;m++){const g=b[m];if(g.type==="line")l+=g.length*Math.cos(F(s)),o+=g.length*Math.sin(F(s)),i.push({x:l,y:o});else if(g.type==="turn")s+=g.angle;else if(g.type==="arc"){const w=l+g.radius*Math.cos(F(s+90)),p=o+g.radius*Math.sin(F(s+90)),a=Math.atan2(o-p,l-w),r=a+F(g.arcAngle);l=w+g.radius*Math.cos(r),o=p+g.radius*Math.sin(r),s+=g.arcAngle,i.push({x:l,y:o})}}return i}function Gt(b){let i=[],l=0,o=0,s=0;for(let m=0;m<b.length;m++){const g=b[m];if(g.type==="line"){const w={x:l,y:o},p={x:l+g.length*Math.cos(F(s)),y:o+g.length*Math.sin(F(s))};i.push({start:w,end:p,length:g.length}),l=p.x,o=p.y}else if(g.type==="turn")s+=g.angle;else if(g.type==="arc"){const w=l+g.radius*Math.cos(F(s+90)),p=o+g.radius*Math.sin(F(s+90)),a=Math.atan2(o-p,l-w),r=a+F(g.arcAngle);l=w+g.radius*Math.cos(r),o=p+g.radius*Math.sin(r),s+=g.arcAngle}}return i}function _t(b,i){const l=i||12;return{w:(b?b.length:0)*l*.55,h:l}}function ot(b,i,l){const o=l||0;return!(b.right+o<i.left||b.left-o>i.right||b.bottom+o<i.top||b.top-o>i.bottom)}function Bt(b,i,l,o){const s=i/2;return Math.max(l+s,Math.min(o-s,b))}function ee(b,i){const o=[];let s=0;function m(){s>1e-9&&(o.push({type:"line",length:s}),s=0)}for(let g=0;g<b.length;g++){const w=b[g];if(w.type==="line"){s+=w.length;continue}if(w.type==="turn"){if(Math.abs(w.angle)<1e-9)continue;m(),o.push(w);continue}if(w.type==="arc"){m(),o.push(w);continue}m(),o.push(w)}return m(),o}function Rt(b,i){const l=i&&i.decimals||0,o=i&&i.step||null;let s=Number(b||0);return o&&o>0&&(s=Math.round(s/o)*o),s.toFixed(l).replace(/\.0+$/,"")}function oe(b,i){const l=Math.hypot(b,i)||1;let o=b/l,s=i/l;return(s<-1e-9||Math.abs(s)<=1e-9&&o<0)&&(o=-o,s=-s),{ux:o,uy:s}}function Ft(b,i,l){const o=l||.01,s=oe(b,i),m=Math.round(s.ux/o)*o,g=Math.round(s.uy/o)*o;return m+"|"+g}function ae(b,i,l){const o=l&&l.dirPrecision||.01,s=l&&l.labelFormat||{decimals:0,step:null},m=b.reduce((f,c)=>f+Math.hypot(c.end.x-c.start.x,c.end.y-c.start.y),0),g=i.reduce((f,c)=>f+(c.length||Math.hypot(c.end.x-c.start.x,c.end.y-c.start.y)),0),w=g>0?m/g:1,p=new Map;for(let f=0;f<i.length;f++){const c=i[f],d=c.end.x-c.start.x,u=c.end.y-c.start.y,n=Ft(d,u,o),t=p.get(n)||[];t.push({length:c.length||Math.hypot(d,u),index:f}),p.set(n,t)}const a=i.map(f=>f.length||Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y)),r=new Set,h=new Set,e=[];for(let f=0;f<b.length;f++){const c=b[f],d=c.end.x-c.start.x,u=c.end.y-c.start.y,n=Ft(d,u,o),t=p.get(n)||[],q=Math.hypot(d,u);let y=q;if(t.length){const A=q/w;let x=null,_=1/0;for(const M of t){const T=Math.abs(M.length-A),v=h.has(M.index)?.1:0;T+v<_&&(x=M,_=T+v)}x&&(y=x.length,h.add(x.index))}else f<a.length&&(y=a[f]);const E=Rt(y,s),S=n+"|"+E;r.has(S)||(r.add(S),e.push({start:c.start,end:c.end,_dirKey:n,_label:E,_lenChosen:y}))}return e}function ne(b,i){const l=i,o=b.map(u=>Object.assign({},u));let s=0,m=0,g=0;const w=[];let p=null,a=-1,r=-1;const h=1e-7;function e(u){return u*Math.PI/180}function f(u){return Math.abs(Math.sin(e(u)))<1e-12}function c(u,n,t,q){return Math.min(n,q)-Math.max(u,t)>h}for(let u=0;u<o.length;u++){let t=function(){const A={x:Math.cos(e(g)),y:Math.sin(e(g))},x=s+o[u].length*A.x,_=m+o[u].length*A.y,M=f(g);for(let T=0;T<w.length;T++){const v=w[T];if(M&&v.horiz&&Math.abs(m-v.y)<h){if(c(Math.min(s,x),Math.max(s,x),Math.min(v.x1,v.x2),Math.max(v.x1,v.x2))&&p&&a>=0&&r>=0)return o[r].length+=l,s+=p.x*l,m+=p.y*l,w[a].x2+=p.x*l,w[a].y2+=p.y*l,!0}else if(!M&&!v.horiz&&Math.abs(s-v.x)<h&&c(Math.min(m,_),Math.max(m,_),Math.min(v.y1,v.y2),Math.max(v.y1,v.y2))&&p&&a>=0&&r>=0)return o[r].length+=l,s+=p.x*l,m+=p.y*l,w[a].x2+=p.x*l,w[a].y2+=p.y*l,!0}return!1};var d=t;const n=o[u];if(n.type==="turn"){g+=n.angle;continue}if(n.type==="arc"){const A=s+n.radius*Math.cos(e(g+90)),x=m+n.radius*Math.sin(e(g+90)),_=Math.atan2(m-x,s-A),M=_+e(n.arcAngle);s=A+n.radius*Math.cos(M),m=x+n.radius*Math.sin(M),g+=n.arcAngle,p=null;continue}for(;t(););const q={x:Math.cos(e(g)),y:Math.sin(e(g))},y=s+o[u].length*q.x,E=m+o[u].length*q.y,S=f(g);w.push({x1:s,y1:m,x2:y,y2:E,horiz:S,y:m,x:s}),p=q,a=w.length-1,r=u,s=y,m=E}return o}function Et(b,i,l,o){const s=F(o),m=Math.cos(s),g=Math.sin(s),w=b.x-i,p=b.y-l;return{x:i+w*m-p*g,y:l+w*g+p*m}}function se(b,i,l,o,s,m,g,w,p){let a="",r=0,h=0,e=0,f=!1;function c(u,n){const t=Et({x:u,y:n},i,l,o);return{x:w+(t.x-m)*s,y:p+(t.y-g)*s}}function d(){if(!f){const u=c(r,h);a+="M "+u.x+" "+u.y,f=!0}}for(let u=0;u<b.length;u++){const n=b[u];if(n.type==="turn"){e+=n.angle;continue}if(n.type==="line"){const t=r+n.length*Math.cos(F(e)),q=h+n.length*Math.sin(F(e));d();const y=c(t,q);a+=" L "+y.x+" "+y.y,r=t,h=q;continue}if(n.type==="arc"){const t=r+n.radius*Math.cos(F(e+90)),q=h+n.radius*Math.sin(F(e+90)),y=Math.atan2(h-q,r-t),E=y+F(n.arcAngle),S=t+n.radius*Math.cos(E),A=q+n.radius*Math.sin(E),x=Math.abs(n.arcAngle)%360;if(d(),x<1e-6||Math.abs(n.arcAngle)>=359.9){const ct=y+Math.sign(n.arcAngle)*Math.PI,X=t+n.radius*Math.cos(ct),N=q+n.radius*Math.sin(ct),D=c(X,N),O=c(r,h),B=n.radius*s,U=n.arcAngle>=0?1:0;a+=" A "+B+" "+B+" 0 1 "+U+" "+D.x+" "+D.y,a+=" A "+B+" "+B+" 0 1 "+U+" "+O.x+" "+O.y,e+=n.arcAngle;continue}const _=c(S,A),M=n.radius*s,T=x>180?1:0,v=n.arcAngle>=0?1:0;a+=" A "+M+" "+M+" 0 "+T+" "+v+" "+_.x+" "+_.y,r=S,h=A,e+=n.arcAngle}}return a||"M 0 0"}function ie(b){const i=te(b);let l=Math.min(...i.map(d=>d.x)),o=Math.max(...i.map(d=>d.x)),s=Math.min(...i.map(d=>d.y)),m=Math.max(...i.map(d=>d.y));const g=(l+o)/2,w=(s+m)/2,a=m-s>o-l?-90:0,r=i.map(d=>Et(d,g,w,a));l=Math.min(...r.map(d=>d.x)),o=Math.max(...r.map(d=>d.x)),s=Math.min(...r.map(d=>d.y)),m=Math.max(...r.map(d=>d.y));const h=Math.max(1,o-l),e=Math.max(1,m-s),f=(l+o)/2,c=(s+m)/2;return{rotDeg:a,w:h,h:e,cxModel:g,cyModel:w,midX:f,midY:c,ptsRot:r}}function re(b){const i=[];let l=0,o=0,s=0;function m(g){const w=F(g);return{x:Math.cos(w),y:Math.sin(w)}}for(let g=0;g<b.length;g++){const w=b[g];if(w.type==="line")l+=w.length*Math.cos(F(s)),o+=w.length*Math.sin(F(s));else if(w.type==="turn"){const p=m(s),a=w.angle;s+=a;const r=m(s);i.push({x:l,y:o,angleDeg:a,prevDir:p,nextDir:r})}else if(w.type==="arc"){const p=l+w.radius*Math.cos(F(s+90)),a=o+w.radius*Math.sin(F(s+90)),r=Math.atan2(o-a,l-p),h=r+F(w.arcAngle);l=p+w.radius*Math.cos(h),o=a+w.radius*Math.sin(h),s+=w.arcAngle}}return i}function ce(b,i,l){const o=Array.from({length:i},()=>({sumH:0,maxW:0,items:[]})),s=[...b.keys()].sort((m,g)=>b[g].h-b[m].h);for(const m of s){let g=0,w=1/0;for(let a=0;a<i;a++){const r=o[a],h=r.sumH+(r.items.length>0?l:0)+b[m].h;h<w&&(w=h,g=a)}const p=o[g];p.sumH=p.items.length>0?p.sumH+l+b[m].h:p.sumH+b[m].h,p.maxW=Math.max(p.maxW,b[m].w),p.items.push(m)}return o}function le(b,i,l,o={}){const s=o.padding??12,m=o.gapCol??12,g=o.gapRow??10,w=Math.max(1,Math.min(b.length,o.kMax??4)),p=Math.max(10,i-2*s),a=Math.max(10,l-2*s),r=h(b);function h(t){const q=t.map(B=>B.w/Math.max(B.h,1)),y=t.map(B=>B.h),E=t.map(B=>B.w),S=t.map(B=>B.w*B.h),A=B=>B.reduce((U,P)=>U+P,0)/B.length,x=(B,U)=>B.reduce((P,$)=>P+Math.pow($-U,2),0)/B.length,_=(B,U)=>Math.sqrt(x(B,U)),M=A(q),T=A(y),v=A(E),ct=S.reduce((B,U)=>B+U,0),X=_(y,T),N=_(E,v),D=T>0?X/T:0,O=v>0?N/v:0;return{avgAspectRatio:M,avgHeight:T,avgWidth:v,totalArea:ct,heightCV:D,widthCV:O,isLinear:M>6||T<v*.12,isUniformHeight:D<.15,isUniformWidth:O<.15,isHighlyVariable:D>.5||O>.5,count:t.length}}let e={S:0,k:1,cols:null,score:0};for(let t=1;t<=w;t++){const q=ce(b,t,g),y=q.reduce(($,z)=>$+z.maxW,0)+m*(t-1),E=Math.max(...q.map($=>$.sumH));if(y<=0||E<=0)continue;const S=p/y,A=a/E,x=Math.min(S,A),_=Math.max(.01,x*.92),M=r.totalArea*_*_,T=p*a,v=M/T,ct=q.map($=>$.sumH*_),X=ct.reduce(($,z)=>$+z,0)/t,N=Math.max(...ct)-Math.min(...ct),D=X>0?1-N/X:1,O=t===1?1.1:t===2?.9:.7,B=t>r.count*.5?.7:1,U=D>.85?1.05:1,P=_*(1+v*.25)*(1+D*.1)*O*B*U;P>e.score&&(e={S:_,k:t,cols:q,score:P,efficiency:v,colBalance:D})}const f=e.cols.map(t=>t.maxW*e.S),c=f.reduce((t,q)=>t+q,0);let d=[];if(e.k===1)d[0]=i/2;else{const t=(e.k-1)*m,q=c+t;if(q<p){const y=p-q,E=m+y/(e.k-1);let S=s;for(let A=0;A<e.k;A++)d[A]=S+f[A]/2,S+=f[A]+E}else{let y=s+Math.max(0,(p-q)/2);for(let E=0;E<e.k;E++)d[E]=y+f[E]/2,y+=f[E]+m}}const u=[],n=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(t=>t.right));for(let t=0;t<e.k;t++){const q=e.cols[t];u[t]=[];const y=q.items.map(N=>b[N].h*e.S),E=y.reduce((N,D)=>N+D,0);if(q.items.length===0)continue;const S=d[t],A=e.cols[t].maxW*e.S,x=S-A/2,_=S+A/2,M=n(),v=Math.max(0,Math.min(_,M)-x)/A,ct=v>.05;let X=a;if(ct&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const D=Math.min(...window.__legendBoxesGroup.map(O=>O.top))-15;X=Math.max(10,D-s),console.log(`üìè Columna ${t}: X=${x.toFixed(0)}-${_.toFixed(0)}, legendWidth=${M.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura reducida a ${X.toFixed(0)}px`)}else console.log(`üìè Columna ${t}: X=${x.toFixed(0)}-${_.toFixed(0)}, legendWidth=${M.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura completa ${X.toFixed(0)}px`);if(q.items.length===1){const N=y[0],D=s+X/2,O=Math.max(s+N/2,Math.min(D,l-s-N/2));u[t].push(O);continue}if(E>X){console.warn(`Columna ${t}: elementos no caben (${E}px > ${X}px)`);const O=E/q.items.length<4?20:5;let B=s;for(let U=0;U<q.items.length;U++){const P=Math.max(y[U],2),$=B+P/2;u[t].push($),B+=P+O}}else{const N=X-E,D=q.items.length-1;let O=N/D;E/q.items.length<4?O=Math.max(18,Math.min(O,50)):O=Math.max(5,O);const P=E+D*O,$=X-P;let z=s+Math.max(0,$/2);for(let lt=0;lt<q.items.length;lt++){const C=Math.max(y[lt],2),Y=z+C/2,k=s+X-C/2,L=Math.max(s+C/2,Math.min(Y,k));u[t].push(L),z+=C+O}}}return{S:e.S,k:e.k,cols:e.cols,centersX:d,centersYByCol:u,padding:s,gapRow:g,gapCol:m}}window.renderizarGrupoSVG=function(i,l){const o=i&&i.etiqueta&&i.etiqueta.id!=null?i.etiqueta.id:i&&i.id!=null?i.id:l,s=document.getElementById("contenedor-svg-"+o);if(!s)return;const m=600,g=150,w=Ut(s),p=Yt(m,g,w);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const a=(i.elementos||[]).map((c,d)=>{var y,E,S;const u=c.barras!=null?c.barras:0;let n="N/A";if(c.diametro!=null&&c.diametro!==""){const x=String(c.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(x){const _=parseFloat(x[0]);isFinite(_)&&(n=String(Math.round(_)))}}const t=[];i.colada_etiqueta&&t.push(i.colada_etiqueta),i.colada_etiqueta_2&&i.colada_etiqueta_2!==i.colada_etiqueta&&t.push(i.colada_etiqueta_2),t.length===0&&((y=c.coladas)!=null&&y.colada1&&t.push(c.coladas.colada1),(E=c.coladas)!=null&&E.colada2&&t.push(c.coladas.colada2),(S=c.coladas)!=null&&S.colada3&&t.push(c.coladas.colada3));const q=t.length>0?` (${t.join(", ")})`:"";return{letter:Ot(d),text:`√ò${n} x${u}${q}`}});Qt(p,a,m,g);const r=i.elementos.map(c=>{const d=Zt(c.dimensiones||""),u=ee(d);let n=0;for(const S of u)S.type==="line"&&(n=Math.max(n,Math.abs(S.length||0))),S.type==="arc"&&(n=Math.max(n,Math.abs(S.radius||0)));const q=n<=50?2:1,y=Ht(u,q),E=ie(y);return{dimsRaw:d,dimsNoZero:u,dimsScaled:y,geomScale:q,medida:E}}),h=r.map(c=>c.medida),e=le(h,m,g,{padding:20,gapCol:50,gapRow:22,kMax:3}),f=new Map;for(let c=0;c<e.k;c++)e.cols[c].items.forEach((d,u)=>f.set(d,{c,j:u}));i.elementos.forEach(function(c,d){const{dimsNoZero:u,dimsScaled:n,medida:t}=r[d],q=f.get(d),y=e.centersX[q.c],E=e.centersYByCol[q.c][q.j],S=e.S,A=t.ptsRot.map($=>({x:y+($.x-t.midX)*S,y:E+($.y-t.midY)*S})),x=Math.min(...A.map($=>$.x)),_=Math.max(...A.map($=>$.x)),M=Math.min(...A.map($=>$.y)),T=Math.max(...A.map($=>$.y)),v={left:x,right:_,top:M,bottom:T};window.__figBoxesGroup.push({...v});const ct=ne(n,.6),X=se(ct,t.cxModel,t.cyModel,t.rotDeg,S,t.midX,t.midY,y,E),N=Wt(p,X,jt,2);(function(){const z=re(n);function lt(L){return Math.abs(Math.abs(L)-90)>=Xt}const C=(L,I)=>Et({x:L.x,y:L.y},0,0,I),Y=(L,I)=>{const W=Et({x:L,y:I},t.cxModel,t.cyModel,t.rotDeg);return{x:y+(W.x-t.midX)*S,y:E+(W.y-t.midY)*S}},k=L=>Math.max(10,Math.min(28,L));z.forEach(L=>{if(!lt(L.angleDeg))return;const I=Y(L.x,L.y),W=C(L.prevDir,t.rotDeg),pt=C(L.nextDir,t.rotDeg),J=Math.atan2(W.y,W.x),R=J+F(L.angleDeg),K=Math.min(v.right-v.left,v.bottom-v.top);let G=k(.12*K);const ft=I.x+G*Math.cos(J),mt=I.y+G*Math.sin(J),V=I.x+G*Math.cos(R),ht=I.y+G*Math.sin(R),Q=Math.abs(L.angleDeg),nt=Q>180?1:0,St=L.angleDeg>=0?1:0,st=document.createElementNS("http://www.w3.org/2000/svg","path");st.setAttribute("d",`M ${ft} ${mt} A ${G} ${G} 0 ${nt} ${St} ${V} ${ht}`),st.setAttribute("stroke","rgba(255,99,71,0.7)"),st.setAttribute("stroke-width","2"),st.setAttribute("fill","none"),st.style.pointerEvents="none",p.appendChild(st);let j=W.x+pt.x,H=W.y+pt.y;Q>180&&(j=-j,H=-H);let Z=Math.hypot(j,H);if(Z<1e-6){const rt=L.angleDeg>=0?1:-1;j=-W.y*rt,H=W.x*rt,Z=Math.hypot(j,H)||1}j/=Z,H/=Z;const tt=(Math.round(L.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",et=_t(tt,14);function qt(rt,dt){return{left:rt-et.w/2,right:rt+et.w/2,top:dt-et.h/2,bottom:dt+et.h/2}}let at=null;for(let rt=$t;rt<=Vt&&!at;rt+=4)for(let dt=0;dt<Pt.length&&!at;dt++){const wt=Pt[dt],yt=C({x:j,y:H},wt),bt=I.x+yt.x*(G+rt),ut=I.y+yt.y*(G+rt),gt=qt(bt,ut);gt.top<0||gt.bottom>g||gt.left<0||gt.right>m||window.__figBoxesGroup.some(xt=>ot(xt,gt,6))||(window.__dimBoxesGroup||[]).some(xt=>ot(xt,gt,2))||(window.__angleBoxesGroup||[]).some(xt=>ot(xt,gt,2))||(window.__placedLetterBoxes||[]).some(xt=>ot(xt,gt,2))||(window.__legendBoxesGroup||[]).some(xt=>ot(xt,gt,6))||(at={x:bt,y:ut,box:gt})}if(!at){const rt=I.x+j*(G+$t),dt=I.y+H*(G+$t),wt=qt(rt,dt);at={x:rt,y:dt,box:wt}}window.__angleBoxesGroup.push(at.box);const it=document.createElementNS("http://www.w3.org/2000/svg","text");it.setAttribute("x",at.x),it.setAttribute("y",at.y),it.setAttribute("fill",Lt),it.setAttribute("font-size",14),it.setAttribute("text-anchor","middle"),it.setAttribute("alignment-baseline","middle"),it.style.cursor="pointer",it.textContent=tt,p.appendChild(it),it.addEventListener("mouseenter",()=>{st.setAttribute("stroke","rgba(255,69,0,1)"),st.setAttribute("stroke-width","3"),st.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),it.addEventListener("mouseleave",()=>{st.setAttribute("stroke","rgba(255,99,71,0.7)"),st.setAttribute("stroke-width","2"),st.style.filter="none"})})})();const D=N.cloneNode(!1);D.setAttribute("stroke-width","50"),D.setAttribute("stroke","transparent"),D.setAttribute("fill","none"),D.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach($=>{D.addEventListener($,z=>N.dispatchEvent(new z.constructor(z.type,z)))}),p.insertBefore(D,N),(c.codigo!=null?c.codigo:c.id)+"",N.style.cursor="pointer",N.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),N.addEventListener("click",function($){if($.ctrlKey||$.metaKey||$.shiftKey){$.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(c.id);return}abrirModalDividirElemento(c.id,c.barras||0)}),N.addEventListener("contextmenu",function($){$.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(c.id)});const O=[],B=Gt(ct),U=Gt(u);ae(B,U,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function($){const z=Et($.start,t.cxModel,t.cyModel,t.rotDeg),lt=Et($.end,t.cxModel,t.cyModel,t.rotDeg),C={x:y+(z.x-t.midX)*S,y:E+(z.y-t.midY)*S},Y={x:y+(lt.x-t.midX)*S,y:E+(lt.y-t.midY)*S},k=$._label,L=Y.x-C.x,I=Y.y-C.y,W=Math.hypot(L,I)||1,pt=L/W,J=I/W,R=I/W,K=-L/W,G=(C.x+Y.x)/2,ft=(C.y+Y.y)/2,mt=G+R*10,V=ft+K*10,ht=_t(k,14),Q=ht.w,nt=ht.h;function St(at,it){return{left:at-Q/2,right:at+Q/2,top:it-nt/2,bottom:it+nt/2}}const st=W*.45;let j=mt,H=V;for(let at=0;at<=Math.ceil(st/6);at++){const it=at%2===0?1:-1,rt=Math.ceil(at/2),dt=it*rt*6;if(Math.abs(dt)>st)continue;const wt=mt+pt*dt,yt=V+J*dt,bt=(wt-C.x)*pt+(yt-C.y)*J;if(bt<0+Q*.3||bt>W-Q*.3)continue;const ut=St(wt,yt);if(!(ot({left:Math.min(C.x,Y.x),right:Math.max(C.x,Y.x),top:Math.min(C.y,Y.y),bottom:Math.max(C.y,Y.y)},ut,0)||(window.__angleBoxesGroup||[]).some(At=>ot(At,ut,2))||(window.__legendBoxesGroup||[]).some(At=>ot(At,ut,6))||O.some(At=>ot(At,ut,2))||ut.top<0||ut.bottom>g||ut.left<0||ut.right>m)){j=wt,H=yt,O.push(ut),window.__dimBoxesGroup.push(ut);break}}const Z=document.createElementNS("http://www.w3.org/2000/svg","line");Z.setAttribute("x1",C.x),Z.setAttribute("y1",C.y),Z.setAttribute("x2",Y.x),Z.setAttribute("y2",Y.y),Z.setAttribute("stroke","rgba(0,0,255,0.6)"),Z.setAttribute("stroke-width","4"),Z.setAttribute("stroke-linecap","round"),Z.setAttribute("vector-effect","non-scaling-stroke"),Z.style.opacity=0,Z.style.pointerEvents="none",Z.style.transition="opacity 120ms ease",p.appendChild(Z);const tt=document.createElementNS("http://www.w3.org/2000/svg","text");tt.setAttribute("x",j),tt.setAttribute("y",H),tt.setAttribute("fill",Lt),tt.setAttribute("font-size",14),tt.setAttribute("text-anchor","middle"),tt.setAttribute("alignment-baseline","middle"),tt.setAttribute("tabindex","0"),tt.style.cursor="pointer",tt.textContent=k,p.appendChild(tt);function et(){Z.style.opacity=1}function qt(){Z.style.opacity=0}tt.addEventListener("mouseenter",et),tt.addEventListener("mouseleave",qt),tt.addEventListener("focus",et),tt.addEventListener("blur",qt)}),function(){const z=[];let lt=0,C=0,Y=0;for(let k=0;k<n.length;k++){const L=n[k];if(L.type==="line")lt+=L.length*Math.cos(F(Y)),C+=L.length*Math.sin(F(Y));else if(L.type==="turn")Y+=L.angle;else if(L.type==="arc"){const I=lt+L.radius*Math.cos(F(Y+90)),W=C+L.radius*Math.sin(F(Y+90)),pt=Math.atan2(C-W,lt-I),J=pt+F(L.arcAngle);let R=L.radius;for(let K=0;K<u.length;K++){const G=u[K];if(G.type==="arc"&&Math.abs(G.arcAngle-L.arcAngle)<.01){R=G.radius;break}}z.push({center:{x:I,y:W},radius:L.radius,originalRadius:R,arcAngle:L.arcAngle,startAngle:pt,endAngle:J}),lt=I+L.radius*Math.cos(J),C=W+L.radius*Math.sin(J),Y+=L.arcAngle}}z.forEach(function(k){const L=Et(k.center,t.cxModel,t.cyModel,t.rotDeg),I={x:y+(L.x-t.midX)*S,y:E+(L.y-t.midY)*S},W=(k.startAngle+k.endAngle)/2,pt=k.radius*S,J="R"+Rt(k.originalRadius,{decimals:0,step:null}),R=_t(J,14),K=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let G=!1,ft,mt,V;for(let et=0;et<K.length&&!G;et++){const qt=K[et],at=W+F(qt),it={x:k.center.x+k.radius*Math.cos(at),y:k.center.y+k.radius*Math.sin(at)},rt=Et(it,t.cxModel,t.cyModel,t.rotDeg),dt={x:y+(rt.x-t.midX)*S,y:E+(rt.y-t.midY)*S},wt=dt.x-I.x,yt=dt.y-I.y,bt=Math.hypot(wt,yt)||1,ut=wt/bt,gt=yt/bt;for(let vt=8;vt<=60&&!G;vt+=6){const Mt=pt*.7;if(ft=I.x+ut*Mt+ut*vt,mt=I.y+gt*Mt+gt*vt,V={left:ft-R.w/2,right:ft+R.w/2,top:mt-R.h/2,bottom:mt+R.h/2},!(V.top<0||V.bottom>g||V.left<0||V.right>m||window.__figBoxesGroup.some(Ct=>ot(Ct,V,2))||(window.__legendBoxesGroup||[]).some(Ct=>ot(Ct,V,2)))){G=!0;break}}}if(!G)return;O.push(V);const ht={x:ft-I.x,y:mt-I.y},Q=Math.hypot(ht.x,ht.y)||1,nt={x:ht.x/Q,y:ht.y/Q},St=I.x+nt.x*pt*.6,st=I.y+nt.y*pt*.6,j=document.createElementNS("http://www.w3.org/2000/svg","line");j.setAttribute("x1",I.x),j.setAttribute("y1",I.y),j.setAttribute("x2",St),j.setAttribute("y2",st),j.setAttribute("stroke","rgba(0,128,0,0.6)"),j.setAttribute("stroke-width","4"),j.setAttribute("stroke-linecap","round"),j.setAttribute("vector-effect","non-scaling-stroke"),j.style.opacity=0,j.style.pointerEvents="none",j.style.transition="opacity 120ms ease",p.appendChild(j);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",ft),H.setAttribute("y",mt),H.setAttribute("fill",Lt),H.setAttribute("font-size",14),H.setAttribute("text-anchor","middle"),H.setAttribute("alignment-baseline","middle"),H.setAttribute("tabindex","0"),H.style.cursor="pointer",H.textContent=J,p.appendChild(H);function Z(){j.style.opacity=1}function tt(){j.style.opacity=0}H.addEventListener("mouseenter",Z),H.addEventListener("mouseleave",tt),H.addEventListener("focus",Z),H.addEventListener("blur",tt)})}(),function(){const z=Ot(d),lt=14,C=_t(z,lt);function Y(R,K){return{left:R,right:R+C.w,top:K-C.h/2,bottom:K+C.h/2}}let k=null;const L=(v.top+v.bottom)/2,I=Math.max(C.h/2,Math.min(L,g-C.h/2));function W(R){for(let G=0;G<=30;G+=4){const ft=G%2===0?1:-1,mt=Math.ceil(G/2),V=ft*mt*4,ht=Math.max(C.h/2,Math.min(g-C.h/2,I+V)),Q=R,nt=Y(Q,ht);if(!(window.__figBoxesGroup.some(et=>ot(et,nt,6))||(window.__dimBoxesGroup||[]).some(et=>ot(et,nt,3))||(window.__angleBoxesGroup||[]).some(et=>ot(et,nt,3))||(window.__legendBoxesGroup||[]).some(et=>ot(et,nt,6))||(window.__placedLetterBoxes||[]).some(et=>ot(et,nt,2))||nt.top<0||nt.bottom>g||nt.left<0||nt.right>m))return k={x:Q,y:ht,box:nt},!0}return!1}const pt=[{x:v.right+10,priority:1},{x:v.left-10-C.w,priority:1},{x:v.right+15,priority:2},{x:v.left-15-C.w,priority:2},{x:v.right+5,priority:2},{x:v.left-5-C.w,priority:2},{x:v.right+20,priority:3},{x:v.left-20-C.w,priority:3},{x:v.right+25,priority:3},{x:v.left-25-C.w,priority:3},{x:v.right+30,priority:3},{x:v.left-30-C.w,priority:3}];pt.sort((R,K)=>R.priority-K.priority);for(const R of pt){if(k)break;const K=Bt(R.x,C.w,0,m);if(W(K))break}if(!k){const R=(v.left+v.right)/2,K=[{x:R-C.w/2,y:v.top-C.h-5},{x:R-C.w/2,y:v.bottom+C.h+5}];for(const G of K){if(k)break;const ft=Bt(G.x,C.w,0,m),mt=Math.max(C.h/2,Math.min(g-C.h/2,G.y)),V=Y(ft,mt);!window.__figBoxesGroup.some(Q=>ot(Q,V,6))&&!(window.__dimBoxesGroup||[]).some(Q=>ot(Q,V,3))&&!(window.__angleBoxesGroup||[]).some(Q=>ot(Q,V,3))&&!(window.__legendBoxesGroup||[]).some(Q=>ot(Q,V,6))&&!(window.__placedLetterBoxes||[]).some(Q=>ot(Q,V,2))&&V.top>=0&&V.bottom<=g&&V.left>=0&&V.right<=m&&(k={x:ft,y:mt,box:V})}}if(!k){const R=Bt(m-C.w,C.w,0,m),K=I;k={x:R,y:K,box:Y(R,K)}}window.__placedLetterBoxes.push(k.box);const J=document.createElementNS("http://www.w3.org/2000/svg","text");J.setAttribute("x",k.x),J.setAttribute("y",k.y),J.setAttribute("fill",zt),J.setAttribute("font-size",lt),J.setAttribute("text-anchor","start"),J.setAttribute("alignment-baseline","middle"),J.style.fontWeight="600",J.style.pointerEvents="none",J.textContent=z,p.appendChild(J)}()}),s.innerHTML="",s.appendChild(p)};function It(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const b=window.elementosAgrupadosScript;if(!b)return;const i=document.getElementById("grid-maquina");if(i&&window.updateGridClasses){const l=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,o),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}b.forEach(function(l,o){renderizarGrupoSVG(l,o)}),requestAnimationFrame(()=>{i&&(i.style.opacity="1",i.style.visibility="visible",i.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",i.className)),document.querySelectorAll(".proceso").forEach(l=>{l.style.opacity="1"})}),window.actualizarSVGConColadas=function(l,o){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,m=s.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(l));if(m===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${l}`);return}const g=s[m];g.elementos&&o&&g.elementos.forEach(w=>{const p=String(w.id),a=o[p];w.coladas||(w.coladas={colada1:null,colada2:null,colada3:null}),a&&Array.isArray(a)&&(w.coladas.colada1=a[0]||null,w.coladas.colada2=a[1]||null,w.coladas.colada3=a[2]||null)}),renderizarGrupoSVG(g,m),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${l}`,o)},window.limpiarColadasSVG=function(l){if(!window.elementosAgrupadosScript)return;const o=window.elementosAgrupadosScript,s=o.findIndex(g=>g.etiqueta&&String(g.etiqueta.etiqueta_sub_id)===String(l));if(s===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${l}`);return}const m=o[s];m.elementos&&m.elementos.forEach(g=>{g.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(m,s),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${l}`)},window.addEventListener("regenerar-svg-etiqueta",function(l){var w;const o=(w=l.detail)==null?void 0:w.etiquetaSubId;if(!o||!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,m=s.findIndex(p=>p.etiqueta&&String(p.etiqueta.etiqueta_sub_id)===String(o));if(m===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${o}`);return}const g=s[m];renderizarGrupoSVG(g,m),console.log(`üîÑ SVG regenerado para etiqueta ${o} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It();document.addEventListener("livewire:navigated",It);window.abrirModalDividirElemento=function(i,l){const o=document.getElementById("modalDividirElemento"),s=document.getElementById("dividir_elemento_id"),m=document.getElementById("dividir_barras_totales"),g=document.getElementById("labelBarrasActuales"),w=document.getElementById("barras_a_mover"),p=document.getElementById("previewDivision"),a=document.getElementById("formDividirElemento");if(!o||!s||!a)return;s.value=i;let r=parseInt(l)||0;if(r===0&&window.elementosAgrupadosScript){for(const h of window.elementosAgrupadosScript)if(h.elementos){const e=h.elementos.find(f=>String(f.id)===String(i));if(e&&e.barras){r=parseInt(e.barras)||0;break}}}m&&(m.value=r),g&&(g.textContent=r>0?r:"-"),w&&(w.value=""),p&&p.classList.add("hidden"),window.rutaDividirElemento&&a.setAttribute("action",window.rutaDividirElemento),o.classList.remove("hidden")};window.enviarDivision=async function(){const i=document.getElementById("formDividirElemento"),l=i.getAttribute("action")||window.rutaDividirElemento,o=new FormData(i);try{const s=document.querySelector('meta[name="csrf-token"]'),m=o.get("_token")||(s?s.getAttribute("content"):null),w=await fetch(l,{method:"POST",headers:m?{"X-CSRF-TOKEN":m}:{},body:o}),p=await w.json();if(!w.ok||!p.success)throw new Error(p.message||"Error al dividir");i.reset();const a=document.getElementById("modalDividirElemento");a&&a.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",p.message,"success"):alert(p.message)}catch(s){window.Swal?window.Swal.fire("Error",s&&s.message||"Error","error"):alert(s&&s.message||"Error")}};(function(b){const i={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},l={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function o(p,a,r={}){console.log(`üîÑ Actualizando etiqueta ${p} a estado: ${a}`);const h=String(p).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${h}`);if(!e)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${p}`),!1;const f=String(a).toLowerCase().trim(),c=l[f];if(!c)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${a}`),!1;e.dataset.estado=f,Array.from(e.classList).forEach(t=>{t.startsWith("estado-")&&e.classList.remove(t)}),e.classList.add(c.cssClass),e.style.setProperty("--bg-estado",c.bgColor);const u=e.querySelector('[id^="contenedor-svg-"]');if(u){const t=u.querySelector("svg");t&&(t.style.background=c.bgColor)}const n=e.querySelector(".etiqueta-card")||e;return n&&(n.style.background=c.bgColor),s(e,f),m(e),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:p,estado:f,datosExtra:r}})),console.log(`‚úÖ Etiqueta ${p} actualizada a ${a}`),!0}function s(p,a){const r=p.querySelectorAll(".btn-fabricar"),h=["empaquetada","en-paquete"];r.forEach(e=>{h.includes(a)?(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",e.title=`Etiqueta ya ${a}`):(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",e.title="Fabricar esta etiqueta")})}function m(p){p.style.transition="transform 0.5s ease, background-color 0.5s ease",p.style.transform="scale(1.03)",setTimeout(()=>{p.style.transform="scale(1)"},400)}function g(p,a,r={}){console.log(`üîÑ Actualizando ${p.length} etiquetas...`);const e=p.map(f=>o(f,a,r)).filter(f=>f).length;return console.log(`‚úÖ ${e}/${p.length} etiquetas actualizadas`),e}function w(p){const a=String(p).replace(/\./g,"-"),r=document.querySelector(`#etiqueta-${a}`);return r?{id:p,estado:r.dataset.estado||"desconocido",elemento:r}:null}window.addEventListener("paquete:creado",p=>{const{codigoPaquete:a,etiquetaIds:r}=p.detail;console.log(`üì¶ Evento paquete:creado recibido - ${a} con ${r.length} etiquetas`),g(r,"empaquetada",{codigo_paquete:a})}),b.SistemaDOM={actualizarEstadoEtiqueta:o,actualizarMultiplesEtiquetas:g,obtenerEstadoActual:w,ESTADOS_CONFIG:l},b.ColoresEstado={actualizar:(p,a)=>{i[p]=a;const r=document.getElementById("colores-estado-css");if(r){let h=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[e,f]of Object.entries(i))h+=`.proceso.estado-${e} {
    --bg-estado: ${f};
}
`;r.textContent=h,console.log(`‚úÖ Color actualizado para estado "${p}": ${a}`)}},obtenerColor:p=>i[p],todos:()=>({...i})}})(window);function Dt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async a=>{var t,q,y;const r=a.target.closest(".btn-fabricar");if(!r)return;a.preventDefault();const h=(q=(t=document.getElementById("maquina-info"))==null?void 0:t.dataset)==null?void 0:q.maquinaId;if(!h){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const e=r.dataset.grupoId;if(e){const E=r.disabled;r.disabled=!0;try{await i(e,h)}finally{r.disabled=E}return}const f=String(r.dataset.etiquetaId||"").trim(),c=f.replace(/\./g,"-"),d=document.querySelector(`#etiqueta-${c}`);if(d){const E=(d.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(E)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${f} ya est√° en estado ${E}.`,timer:2500,showConfirmButton:!1});return}}const u=Number(((y=window.DIAMETRO_POR_ETIQUETA)==null?void 0:y[f])??0);if(!f){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!u&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const n=r.disabled;r.disabled=!0;try{await b(f,h,u)}finally{r.disabled=n}});async function b(a,r,h=null){var E,S,A,x;const e=`/actualizar-etiqueta/${a}/maquina/${r}`,f=(E=document.querySelector('meta[name="csrf-token"]'))==null?void 0:E.getAttribute("content"),c=a.replace(/\./g,"-"),u=(((A=(S=document.querySelector(`#etiqueta-${c}`))==null?void 0:S.dataset)==null?void 0:A.estado)||"").toLowerCase()==="fabricando",n=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",t=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",q=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(n&&t||q){if(u&&((x=window._decisionCortePorEtiqueta)!=null&&x[a])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[a],csrfToken:f,etiquetaId:a,onUpdate:o});return}for(;;){let _;try{_=await Cortes.mejorCorteSimple(a,h,f)}catch(M){p(M);return}if(!_)return;if(_.accion==="optimizar"){let M;try{M=await Cortes.mejorCorteOptimizado(a,h,_.patrones,f)}catch(T){p(T);return}if((M==null?void 0:M.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[a]={longitudBarraCm:M.longitudBarraCm,etiquetas:M.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[a],csrfToken:f,etiquetaId:a,onUpdate:o});return}else{if(M==="volver")continue;return}}if(_.accion==="fabricar_patron_simple"){const M=Math.round(Number(_.longitud_m||0)*100);if(!M){p("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[a]={longitudBarraCm:M,etiquetas:[{etiqueta_sub_id:a,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[a],csrfToken:f,etiquetaId:a,onUpdate:o});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await l(a,r,f)}catch(_){p(_)}return}try{const _=await fetch(e,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f},body:JSON.stringify({})}),M=await _.json();if(!_.ok)throw new Error(M.message||"Error al actualizar");o(a,M)}catch(_){p(_)}}async function i(a,r){var c,d;const h=(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content"),e=document.querySelector(`[data-grupo-id="${a}"] .etiqueta-card`),f=(((d=e==null?void 0:e.dataset)==null?void 0:d.estado)||"pendiente").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(f)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${f}.`,timer:2500,showConfirmButton:!1});return}try{const u=await fetch(`/api/etiquetas/resumir/${a}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":h},body:JSON.stringify({maquina_id:r})}),n=await u.json();if(!u.ok||!n.success)throw new Error(n.message||"Error al actualizar grupo");const t=n.nuevo_estado||"actualizado";t==="fabricando"?w("info","Fabricando",`Grupo iniciado (${n.etiquetas_actualizadas||0} etiquetas)`):t==="completada"?w("success","¬°Completado!",`Grupo completado (${n.etiquetas_actualizadas||0} etiquetas)`):w("success","Actualizado",n.message),e&&(["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(q=>{e.classList.remove(`estado-${q}`)}),e.classList.add(`estado-${t}`),e.dataset.estado=t),typeof window.refrescarEtiquetasMaquina=="function"&&await window.refrescarEtiquetasMaquina()}catch(u){p(u)}}async function l(a,r,h){var N,D,O,B,U;const e=Number(((N=window.DIAMETRO_POR_ETIQUETA)==null?void 0:N[a])??0),c=Number(((D=window.LONGITUD_POR_ETIQUETA)==null?void 0:D[a])??0)/100;let d="";try{const P=await fetch(`/api/productos/sugerencias?diametro=${e}&longitud=${c}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":h}});if(P.ok){const $=await P.json();$.productos&&$.productos.length>0?d=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${e}mm x ${c.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${$.productos.map(z=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${z.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${z.codigo}</td>
                                                <td class="px-2 py-1">${z.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${z.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${z.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:d=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${e}mm x ${c.toFixed(1)}m</p>`}}catch(P){console.warn("No se pudieron cargar sugerencias:",P)}const{value:u,isConfirmed:n}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${d}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const P=document.getElementById("swal-input-producto").value;return!P||!P.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):P.trim()}});if(!n||!u)return;let t;try{const P=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(u.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":h}});if(!P.ok){const $=await P.json();throw new Error($.message||"Producto no encontrado")}t=await P.json()}catch(P){await Swal.fire({icon:"error",title:"Producto no encontrado",text:P.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${u}`});return}const q=(t.tipo||"").toLowerCase(),y=Number(t.diametro??0),E=Number(t.longitud??0);if(q&&q!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${t.codigo}</p>
                        <p><strong>Tipo:</strong> ${t.tipo||"N/A"}</p>
                    </div>
                `});return}if(y>0&&e>0&&Math.abs(y-e)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${y} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${e} mm</p>
                    </div>
                `});return}if(E>0&&c>0&&Math.abs(E-c)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${E.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${c.toFixed(2)} m</p>
                    </div>
                `});return}const S=t.longitud?`${t.longitud} m`:"N/A",{value:A,isConfirmed:x}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${t.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${t.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${S}</p>
                    <p><strong>Stock actual:</strong> ${((O=t.peso_stock)==null?void 0:O.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${t.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!x)return;const _=A==="completo",M=`/actualizar-etiqueta/${a}/maquina/${r}`,T=await fetch(M,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":h},body:JSON.stringify({producto_id:t.id,paquete_completo:_})}),v=await T.json();if(!T.ok)throw new Error(v.message||"Error al fabricar");const ct=((B=v.metricas)==null?void 0:B.peso_consumido)||0,X=((U=v.metricas)==null?void 0:U.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${t.codigo}</p>
                <p><strong>Peso consumido:</strong> ${ct.toFixed(2)} kg</p>
                ${X?`<p><strong>Paquete:</strong> ${X}</p>`:""}
                ${_?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),o(a,v),X&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const P=document.getElementById("codigo_paquete_mover");P&&(P.value=X,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function o(a,r){var e,f;const h=a.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:a,estado:r.estado,peso_etiqueta:r.peso_etiqueta,nombre:r.nombre,producto_n_colada:r.producto_n_colada,producto2_n_colada:r.producto2_n_colada,data_completa:r}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(a,r.estado,{peso:r.peso_etiqueta,nombre:r.nombre||a}):s(a,r.estado),r.producto_n_colada&&window.elementosAgrupadosScript){const c=window.elementosAgrupadosScript.findIndex(d=>d.etiqueta&&String(d.etiqueta.etiqueta_sub_id)===String(a));if(c!==-1){const d=window.elementosAgrupadosScript[c];d.colada_etiqueta=r.producto_n_colada,d.colada_etiqueta_2=r.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(d,c),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${r.producto_n_colada}`))}}switch(r.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(a,r.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(a,!0),(r.estado||"").toLowerCase()){case"cortando":w("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":w("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),m(h);break;case"fabricando":w("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":w("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),m(h),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(a,{id:a,peso_etiqueta:r.peso_etiqueta||0,estado:"fabricada",nombre:r.nombre||a}),r.elementos&&Array.isArray(r.elementos)&&r.elementos.length>0?r.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${a}`,r.elementos),g(a,r.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${a}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${a}`);break;case"completada":w("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(e=window._decisionCortePorEtiqueta)!=null&&e[a]&&(delete window._decisionCortePorEtiqueta[a],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),m(h),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(a,{id:a,peso_etiqueta:r.peso_etiqueta||0,estado:"completada",nombre:r.nombre||a}),r.elementos&&Array.isArray(r.elementos)&&r.elementos.length>0?r.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${a}`,r.elementos),g(a,r.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${a}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${a}`);break;case"ensamblando":w("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":w("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),m(h);break;case"soldando":w("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":w("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),m(h);break;default:console.warn(`Estado no manejado para etiqueta ${a}: ${r.estado}`),w("warning","Estado desconocido",`El estado recibido (${r.estado}) no est√° reconocido.`,3e3)}(f=r.productos_afectados)!=null&&f.length&&r.productos_afectados.forEach(c=>{const d=document.getElementById(`peso-stock-${c.id}`),u=document.getElementById(`progreso-texto-${c.id}`),n=document.getElementById(`progreso-barra-${c.id}`);d&&(d.textContent=`${c.peso_stock} kg`),u&&(u.textContent=`${c.peso_stock} / ${c.peso_inicial} kg`),n&&(n.style.height=`${c.peso_stock/c.peso_inicial*100}%`)})}function s(a,r){const h=a.replace(/\./g,"-"),e=document.getElementById("etiqueta-"+h);if(!e)return;e.dataset.estado=String(r||"").toLowerCase(),e.className=e.className.split(" ").filter(d=>!d.startsWith("estado-")).join(" ").trim(),e.classList.add("estado-"+e.dataset.estado);const f=e.querySelector('[id^="contenedor-svg-"]'),c=f==null?void 0:f.querySelector("svg");c&&(c.style.background=getComputedStyle(e).getPropertyValue("--bg-estado").trim())}function m(a){const r=`#etiqueta-${CSS.escape(a)}`,h=document.querySelector(r),e=Array.from(document.querySelectorAll(".proceso")),f=y=>(y||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),c=y=>{var A;const E=(A=y.dataset)==null?void 0:A.estado;if(E)return f(E);const S=y.querySelector('[id^="estado-"]');return f((S==null?void 0:S.textContent)||(S==null?void 0:S.innerText)||"")},d=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),u=y=>d.has(c(y)),n=h?e.indexOf(h):-1,q=(n>=0?e.slice(n+1):e).find(y=>!u(y));q?q.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function g(a,r){var d;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${a}`),!r||!Array.isArray(r)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${a}`);return}if(r.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${a}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const h=window.elementosAgrupadosScript.findIndex(u=>{var n;return((n=u.etiqueta)==null?void 0:n.etiqueta_sub_id)===a});if(h===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${a}`);return}window.elementosAgrupadosScript[h].elementos=r;const e=window.elementosAgrupadosScript[h],f=(d=e.etiqueta)==null?void 0:d.id;if(!f){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${a}`);return}const c=document.getElementById("contenedor-svg-"+f);if(!c){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${a} (id: ${f})`);return}try{const u=c.querySelector("svg");u&&u.remove();const n=600,t=150,q=c.closest(".proceso"),y=q&&getComputedStyle(q).getPropertyValue("--bg-estado").trim()||"#e5e7eb",E=document.createElementNS("http://www.w3.org/2000/svg","svg");E.setAttribute("viewBox",`0 0 ${n} ${t}`),E.setAttribute("preserveAspectRatio","xMidYMid meet"),E.style.width="100%",E.style.height="100%",E.style.display="block",E.style.background=y;const S=(e.elementos||[]).map((x,_)=>{var X,N,D;const M=x.barras!=null?x.barras:0;let T="N/A";if(x.diametro!=null&&x.diametro!==""){const B=String(x.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(B){const U=parseFloat(B[0]);isFinite(U)&&(T=String(Math.round(U)))}}const v=[];(X=x.coladas)!=null&&X.colada1&&v.push(x.coladas.colada1),(N=x.coladas)!=null&&N.colada2&&v.push(x.coladas.colada2),(D=x.coladas)!=null&&D.colada3&&v.push(x.coladas.colada3);const ct=v.length>0?` (${v.join(", ")})`:"";return{letter:indexToLetters(_),text:`√ò${T} x${M}${ct}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(E,S,n,t):console.error("‚ùå drawLegendBottomLeft no est√° definida");const A=document.createElementNS("http://www.w3.org/2000/svg","text");A.setAttribute("x",n/2),A.setAttribute("y",t/2),A.setAttribute("text-anchor","middle"),A.setAttribute("fill","#059669"),A.setAttribute("font-size","14"),A.setAttribute("font-weight","600"),A.textContent="‚úì Coladas actualizadas",E.appendChild(A),c.appendChild(E),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${a}`),setTimeout(()=>{A&&A.parentNode&&A.remove()},2e3)}catch(u){console.error(`‚ùå Error al actualizar SVG para etiqueta ${a}:`,u),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function w(a,r,h,e=2e3){Swal.fire({icon:a,title:r,text:h,timer:e,showConfirmButton:!1})}function p(a){Swal.fire({icon:"error",title:"Error",text:a.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=o}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);(function(b){let i=[],l=!1,o=null;async function s(d){var n;const u=`/etiquetas/${encodeURIComponent(d)}/validar-para-paquete`;try{const t=await fetch(u,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content}});if(!(t.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const y=await t.json();if(console.log("üîç validarEtiqueta response:",{status:t.status,data:y,peso_etiqueta:y.peso_etiqueta}),!t.ok)throw new Error((y==null?void 0:y.message)||(y==null?void 0:y.motivo)||"Error al validar");return y}catch(t){throw t}}function m(d,u){const n=u.id||d;if(i.some(y=>y.id===n))return!1;const t=parseFloat(u.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:d,id:n,peso_etiqueta_recibido:u.peso_etiqueta,peso_parseado:t,data_completa:u});const q={id:n,type:"etiqueta",peso:t,estado:u.estado||"desconocido",nombre:u.nombre||"Sin nombre"};return i.push(q),r(),!0}function g(d){const u=i.findIndex(n=>n.id===d);u>=0&&i.splice(u,1),r()}function w(){i=[],r()}function p(){return i.reduce((d,u)=>d+(parseFloat(u.peso)||0),0)}function a(){return i}function r(){const d=document.getElementById("itemsList");if(!d)return;d.innerHTML="";for(const t of i){const q=document.createElement("li");q.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",q.dataset.code=t.id,q.innerHTML=`
                <div>
                    <div class="font-semibold">${t.id} === ${t.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,q.querySelector("button").onclick=()=>g(t.id),d.appendChild(q)}const u=p(),n=document.createElement("li");n.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",n.textContent=`Total: ${u.toFixed(2)} kg (${i.length} etiquetas)`,d.appendChild(n)}async function h(){var y,E,S;if(!i.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const d=Number(((E=(y=document.getElementById("maquina-info"))==null?void 0:y.dataset)==null?void 0:E.maquinaId)||window.maquinaId),u=Number(((S=document.getElementById("ubicacion-id"))==null?void 0:S.value)||window.ubicacionId),n=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!d){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!n&&!u){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const t={items:i.map(A=>({id:A.id,type:A.type})),maquina_id:d,ubicacion_id:n?null:u,sin_ubicacion:n},q=async(A={})=>{var M;const x=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(M=document.querySelector('meta[name="csrf-token"]'))==null?void 0:M.content},body:JSON.stringify({...t,...A})}),_=await x.json();if(!x.ok)throw new Error(_.message||"Error al crear el paquete");return _};try{const A=await q();if(A.success)return e(A);if(A.warning){let x="<div style='text-align:left;'>Se detectaron advertencias:";for(const[M,T]of Object.entries(A.warning))Array.isArray(T)&&T.length&&(x+=`<br><strong>${M.replaceAll("_"," ")}:</strong> ${T.join(", ")}`);if(x+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:x,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const M=await q({confirmar:!0});if(M.success)return e(M);throw new Error(M.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(A){await Swal.fire("Error",A.message||"Error inesperado","error")}}async function e(d){var y;const u=d.codigo_paquete||((y=d.paquete)==null?void 0:y.codigo)||"N/D",n=p(),t=[...i.map(E=>E.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${u}</strong> creado correctamente</p>
                       <p>${t.length} etiquetas ¬∑ ${n.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),w(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const E=document.getElementById("codigo_paquete_mover");E&&(E.value=u,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${u}</strong> creado correctamente</p><p>${t.length} etiquetas ¬∑ ${n.toFixed(2)} kg</p>`}),w()),console.log(`üì¶ Disparando evento paquete:creado para ${u}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:u,etiquetaIds:t,pesoTotal:n}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),t.forEach(E=>{f(E,u)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function f(d,u){const n=String(d).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${n}`);if(!t){console.warn(`‚ùå No se encontr√≥ elemento: ${d}`);return}console.log(`üîÑ Actualizando manualmente: ${d}`),Array.from(t.classList).forEach(x=>{x.startsWith("estado-")&&t.classList.remove(x)}),t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.style.setProperty("--bg-estado","#e3e4FA");const y=t.querySelector('[id^="contenedor-svg-"]');if(y){const x=y.querySelector("svg");x&&(x.style.background="#e3e4FA")}const E=t.querySelector(".etiqueta-card")||t;E&&(E.style.background="#e3e4FA");const S=t.querySelector("h3");if(S&&!t.querySelector(".paquete-info")){const x=document.createElement("div");x.className="paquete-info text-sm font-semibold mt-2 no-print",x.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",x.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${u}</span>
            `,S.parentNode.insertBefore(x,S.nextSibling)}t.querySelectorAll(".btn-fabricar").forEach(x=>{x.disabled=!0,x.style.opacity="0.5",x.style.cursor="not-allowed"}),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${d} actualizada manualmente`)}function c(){if(l)return;l=!0;const d=document.getElementById("qrItem");d&&(d.addEventListener("change",()=>d.dispatchEvent(new Event("input"))),d.addEventListener("input",async function(){const n=this.value.trim();if(n)try{const t=await s(n);if(!t.valida){await Swal.fire("Etiqueta no v√°lida",t.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}m(n,t)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(t){console.error("Error de validaci√≥n:",t),await Swal.fire("Error",t.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const u=document.getElementById("crearPaqueteBtn");u&&u.addEventListener("click",h),document.addEventListener("focus",function(n){n.target.id&&n.target.id.startsWith("input-etiqueta-")&&(o=n.target,console.log("üéØ Focus en input:",n.target.id))},!0),document.addEventListener("click",async function(n){var t;if(n.target.classList.contains("btn-agregar-carro")||n.target.closest(".btn-agregar-carro")){const y=(n.target.classList.contains("btn-agregar-carro")?n.target:n.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!y){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const E=document.querySelector(`[x-show="tabActivo === 'crear'"]`),S=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(E&&window.getComputedStyle(E).display,S&&window.getComputedStyle(S).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let x=document.activeElement;(!x||!((t=x.id)!=null&&t.startsWith("input-etiqueta-")))&&(x=o),(!x||!document.body.contains(x))&&(x=document.querySelector('input[id^="input-etiqueta-"]')),x?(x.value=y,x.focus(),x.classList.add("ring-4","ring-green-400"),setTimeout(()=>{x.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${y} a√±adida al input:`,x.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",y);try{const x=await s(y);if(!x.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:x.motivo||"Motivo no especificado"});return}m(y,x)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(x){console.error("Error al a√±adir al carro:",x),await Swal.fire({icon:"error",title:"Error",text:x.message||"No se pudo a√±adir al carro"})}}if(n.target.classList.contains("btn-agregar-carro-grupo")||n.target.closest(".btn-agregar-carro-grupo")){const q=n.target.classList.contains("btn-agregar-carro-grupo")?n.target:n.target.closest(".btn-agregar-carro-grupo"),y=q.dataset.grupoId;let E=[];try{E=JSON.parse(q.dataset.etiquetas||"[]")}catch(_){console.error("Error parseando etiquetas del grupo:",_);return}if(!E.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${E.length} etiquetas del grupo ${y} al carro`);let S=0,A=0,x=0;for(const _ of E)try{const M=await s(_.id);if(!M.valida){x++;continue}m(_.id,M)?S++:A++}catch{x++}S>0?await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${S}</strong> etiquetas al carro.</p>
                            ${A>0?`<p class="text-gray-500">${A} ya estaban en el carro.</p>`:""}
                            ${x>0?`<p class="text-red-500">${x} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1}):A>0?await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."}):await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",text:"Las etiquetas del grupo no son v√°lidas para a√±adir al carro."})}})}b.TrabajoPaquete={inicializar:c,agregarItemEtiqueta:m,eliminarItem:g,limpiarCarro:w,obtenerItems:a,calcularPesoTotal:p,crearPaquete:h,validarEtiqueta:s,actualizarListaVisual:r},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c(),document.addEventListener("livewire:navigated",c)})(window);function Tt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(i,l){const o=document.getElementById("grid-maquina");if(!o)return;console.log("üîß Actualizando clases:",{showLeft:i,showRight:l,clasesAnteriores:o.className}),i||l?o.classList.add("columnas-laterales-visibles"):o.classList.remove("columnas-laterales-visibles"),i&&l?o.classList.add("ambas-columnas"):o.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",o.className),o.offsetHeight,o.querySelectorAll(".etiqueta-card").forEach(m=>{m.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,l)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const i=JSON.parse(localStorage.getItem("showLeft")??"true"),l=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,l)});function b(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((m,g)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),g.disconnect();const p=JSON.parse(localStorage.getItem("showLeft")??"true"),a=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(p,a)}}).observe(document.body,{childList:!0,subtree:!0});return}const l=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,o),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}b()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const b={debounceTime:500};let i=0;async function l(h){var c;const e=Date.now();if(e-i<b.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};i=e;const f=(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content");if(!f)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${h}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const u=await fetch(`/etiquetas/${encodeURIComponent(h)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f}}),n=await u.json();return!u.ok||!n.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:n.message||"No se pudo revertir el cambio."}),{success:!1,message:n.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${n.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${n.estado}</strong>
                    </p>
                    ${n.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),g(h,n),n)}catch(d){return console.error("Error al deshacer etiqueta:",d),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:d.message}}}async function o(h){try{const e=await fetch(`/etiquetas/${encodeURIComponent(h)}/puede-deshacer`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{puede_deshacer:!1}}catch(e){return console.error("Error al verificar undo:",e),{puede_deshacer:!1}}}async function s(h){try{const e=await fetch(`/etiquetas/${encodeURIComponent(h)}/historial`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{success:!1,historial:[]}}catch(e){return console.error("Error al obtener historial:",e),{success:!1,historial:[]}}}async function m(h){var c;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const e=await s(h);if(!e.success||!((c=e.historial)!=null&&c.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const f=e.historial.map((d,u)=>`
            <tr class="${d.revertido?"bg-gray-100 text-gray-400":u===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${d.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${d.accion}</td>
                <td class="px-2 py-1 text-xs">${d.estado_anterior||"-"} ‚Üí ${d.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${d.revertido?'<span class="text-gray-400">Revertido</span>':u===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${h}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${f}</tbody>
                    </table>
                </div>
                ${e.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${e.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:e.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:e.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:e.puede_deshacer?"#f59e0b":"#6b7280"}).then(d=>{d.isConfirmed&&e.puede_deshacer&&l(h)})}function g(h,e){const f=h.replace(/\./g,"-"),c=document.getElementById(`etiqueta-${f}`);if(c){c.dataset.estado=e.estado,c.className=c.className.split(" ").filter(n=>!n.startsWith("estado-")).join(" ").trim(),c.classList.add(`estado-${e.estado}`);const d=c.querySelector('[id^="contenedor-svg-"]'),u=d==null?void 0:d.querySelector("svg");u&&(u.style.background=getComputedStyle(c).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(h,e.estado)}if(e.estado==="pendiente"){if(window.elementosAgrupadosScript){const n=window.elementosAgrupadosScript.find(t=>t.etiqueta&&String(t.etiqueta.etiqueta_sub_id)===String(h));n&&(n.colada_etiqueta=null,n.colada_etiqueta_2=null,n.elementos&&n.elementos.forEach(t=>{t.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:h}})))}const d=document.getElementById(`colada-${f}`);d&&(d.textContent="")}console.log(`‚úÖ DOM actualizado para ${h}: estado = ${e.estado}`)}function w(h,e){const f=h.replace(/\./g,"-"),c=document.querySelector(`#etiqueta-${f} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${h}, puede=${e}, btn encontrado=${!!c}`),c&&(c.disabled=!1,c.classList.remove("opacity-50","cursor-not-allowed"),c.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function p(){document.addEventListener("click",async h=>{const e=h.target.closest(".btn-deshacer");if(!e)return;h.preventDefault(),h.stopPropagation();const f=e.dataset.etiquetaId;if(!f){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await l(f)}),document.addEventListener("click",async h=>{const e=h.target.closest(".btn-historial");if(!e)return;h.preventDefault(),h.stopPropagation();const f=e.dataset.etiquetaId;f&&await m(f)}),console.log("‚úÖ Event listeners de historial inicializados")}function a(){let h=null;window.addEventListener("etiqueta-fabricada",e=>{var f;(f=e.detail)!=null&&f.etiquetaSubId&&(h=e.detail.etiquetaSubId)}),document.addEventListener("keydown",async e=>{var f,c;if(e.ctrlKey&&e.key==="z"&&!e.shiftKey){if(["INPUT","TEXTAREA"].includes((f=document.activeElement)==null?void 0:f.tagName))return;const d=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),u=((c=d==null?void 0:d.dataset)==null?void 0:c.etiquetaId)||h;u&&(e.preventDefault(),await l(u))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function r(){p(),a(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:l,puedeDeshacer:o,obtenerHistorial:s,mostrarHistorial:m,actualizarBoton:w},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r(),document.addEventListener("livewire:navigated",r)})();
