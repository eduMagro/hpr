const Ht="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Vt="rgba(0, 0, 0, 1)";function Ut(q,l){return!l||l===1?q.map(c=>({...c})):q.map(c=>c.type==="line"?{...c,length:(c.length||0)*l}:c.type==="arc"?{...c,radius:(c.radius||0)*l}:{...c})}const Yt=.75,Tt=14,Wt=60,Ft=[0,10,-10,20,-20,30,-30];function j(q){return q*Math.PI/180}function Jt(q){const l=q.closest(".proceso");return l&&getComputedStyle(l).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Kt(q,l,c){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("viewBox","0 0 "+q+" "+l),s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.background=c||"#ffffff",s.style.shapeRendering="geometricPrecision",s.style.textRendering="optimizeLegibility",s.style.boxSizing="border-box",s}function Qt(q,l,c,s){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",l),n.setAttribute("stroke",c),n.setAttribute("fill","none"),n.setAttribute("stroke-width",s),n.setAttribute("vector-effect","non-scaling-stroke"),q.appendChild(n),n}function zt(q){let l="",c=Number(q)||0;for(;c>=0;){const s=c%26;l=String.fromCharCode(65+s)+l,c=Math.floor(c/26)-1}return l}const Zt=0,te=-25;function ee(q,l,c,s){if(!l||!l.length)return;const n=2,g=12,m=g+n,x=l.map(i=>(i.letter?i.letter+" ":"")+(i.text||"")),p=g*x.length+n*(x.length-1),y=Zt;let t=s-te-p+g/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let i=0;i<x.length;i++){const a=x[i],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",y),d.setAttribute("y",t),d.setAttribute("fill",Vt),d.setAttribute("font-size",g),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=a,q.appendChild(d);const f=Lt(a,g).w;window.__legendBoxesGroup.push({left:y,right:y+f,top:t-g/2,bottom:t+g/2}),t+=m}}function oe(q){const l=(q||"").split(/\s+/).filter(Boolean),c=[];for(let s=0;s<l.length;s++){const n=l[s];if(n.endsWith("r")){const g=parseFloat(n.slice(0,-1));let m=360;s+1<l.length&&l[s+1].endsWith("d")&&(m=parseFloat(l[++s].slice(0,-1))),c.push({type:"arc",radius:g,arcAngle:m})}else n.endsWith("d")?c.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):c.push({type:"line",length:parseFloat(n)})}return c}function ae(q){let l=[],c=0,s=0,n=0;l.push({x:c,y:s});for(let g=0;g<q.length;g++){const m=q[g];if(m.type==="line")c+=m.length*Math.cos(j(n)),s+=m.length*Math.sin(j(n)),l.push({x:c,y:s});else if(m.type==="turn")n+=m.angle;else if(m.type==="arc"){const x=c+m.radius*Math.cos(j(n+90)),p=s+m.radius*Math.sin(j(n+90)),y=Math.atan2(s-p,c-x),t=y+j(m.arcAngle);c=x+m.radius*Math.cos(t),s=p+m.radius*Math.sin(t),n+=m.arcAngle,l.push({x:c,y:s})}}return l}function Rt(q){let l=[],c=0,s=0,n=0;for(let g=0;g<q.length;g++){const m=q[g];if(m.type==="line"){const x={x:c,y:s},p={x:c+m.length*Math.cos(j(n)),y:s+m.length*Math.sin(j(n))};l.push({start:x,end:p,length:m.length}),c=p.x,s=p.y}else if(m.type==="turn")n+=m.angle;else if(m.type==="arc"){const x=c+m.radius*Math.cos(j(n+90)),p=s+m.radius*Math.sin(j(n+90)),y=Math.atan2(s-p,c-x),t=y+j(m.arcAngle);c=x+m.radius*Math.cos(t),s=p+m.radius*Math.sin(t),n+=m.arcAngle}}return l}function Lt(q,l){const c=l||12;return{w:(q?q.length:0)*c*.55,h:c}}function at(q,l,c){const s=c||0;return!(q.right+s<l.left||q.left-s>l.right||q.bottom+s<l.top||q.top-s>l.bottom)}function Nt(q,l,c,s){const n=l/2;return Math.max(c+n,Math.min(s-n,q))}function ne(q,l){const s=[];let n=0;function g(){n>1e-9&&(s.push({type:"line",length:n}),n=0)}for(let m=0;m<q.length;m++){const x=q[m];if(x.type==="line"){n+=x.length;continue}if(x.type==="turn"){if(Math.abs(x.angle)<1e-9)continue;g(),s.push(x);continue}if(x.type==="arc"){g(),s.push(x);continue}g(),s.push(x)}return g(),s}function Xt(q,l){const c=l&&l.decimals||0,s=l&&l.step||null;let n=Number(q||0);return s&&s>0&&(n=Math.round(n/s)*s),n.toFixed(c).replace(/\.0+$/,"")}function se(q,l){const c=Math.hypot(q,l)||1;let s=q/c,n=l/c;return(n<-1e-9||Math.abs(n)<=1e-9&&s<0)&&(s=-s,n=-n),{ux:s,uy:n}}function jt(q,l,c){const s=c||.01,n=se(q,l),g=Math.round(n.ux/s)*s,m=Math.round(n.uy/s)*s;return g+"|"+m}function ie(q,l,c){const s=c&&c.dirPrecision||.01,n=c&&c.labelFormat||{decimals:0,step:null},g=q.reduce((d,f)=>d+Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y),0),m=l.reduce((d,f)=>d+(f.length||Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y)),0),x=m>0?g/m:1,p=new Map;for(let d=0;d<l.length;d++){const f=l[d],u=f.end.x-f.start.x,e=f.end.y-f.start.y,r=jt(u,e,s),o=p.get(r)||[];o.push({length:f.length||Math.hypot(u,e),index:d}),p.set(r,o)}const y=l.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),t=new Set,i=new Set,a=[];for(let d=0;d<q.length;d++){const f=q[d],u=f.end.x-f.start.x,e=f.end.y-f.start.y,r=jt(u,e,s),o=p.get(r)||[],b=Math.hypot(u,e);let E=b;if(o.length){const A=b/x;let w=null,_=1/0;for(const M of o){const k=Math.abs(M.length-A),L=i.has(M.index)?.1:0;k+L<_&&(w=M,_=k+L)}w&&(E=w.length,i.add(w.index))}else d<y.length&&(E=y[d]);const h=Xt(E,n),v=r+"|"+h;t.has(v)||(t.add(v),a.push({start:f.start,end:f.end,_dirKey:r,_label:h,_lenChosen:E}))}return a}function re(q,l){const c=l,s=q.map(e=>Object.assign({},e));let n=0,g=0,m=0;const x=[];let p=null,y=-1,t=-1;const i=1e-7;function a(e){return e*Math.PI/180}function d(e){return Math.abs(Math.sin(a(e)))<1e-12}function f(e,r,o,b){return Math.min(r,b)-Math.max(e,o)>i}for(let e=0;e<s.length;e++){let o=function(){const A={x:Math.cos(a(m)),y:Math.sin(a(m))},w=n+s[e].length*A.x,_=g+s[e].length*A.y,M=d(m);for(let k=0;k<x.length;k++){const L=x[k];if(M&&L.horiz&&Math.abs(g-L.y)<i){if(f(Math.min(n,w),Math.max(n,w),Math.min(L.x1,L.x2),Math.max(L.x1,L.x2))&&p&&y>=0&&t>=0)return s[t].length+=c,n+=p.x*c,g+=p.y*c,x[y].x2+=p.x*c,x[y].y2+=p.y*c,!0}else if(!M&&!L.horiz&&Math.abs(n-L.x)<i&&f(Math.min(g,_),Math.max(g,_),Math.min(L.y1,L.y2),Math.max(L.y1,L.y2))&&p&&y>=0&&t>=0)return s[t].length+=c,n+=p.x*c,g+=p.y*c,x[y].x2+=p.x*c,x[y].y2+=p.y*c,!0}return!1};var u=o;const r=s[e];if(r.type==="turn"){m+=r.angle;continue}if(r.type==="arc"){const A=n+r.radius*Math.cos(a(m+90)),w=g+r.radius*Math.sin(a(m+90)),_=Math.atan2(g-w,n-A),M=_+a(r.arcAngle);n=A+r.radius*Math.cos(M),g=w+r.radius*Math.sin(M),m+=r.arcAngle,p=null;continue}for(;o(););const b={x:Math.cos(a(m)),y:Math.sin(a(m))},E=n+s[e].length*b.x,h=g+s[e].length*b.y,v=d(m);x.push({x1:n,y1:g,x2:E,y2:h,horiz:v,y:g,x:n}),p=b,y=x.length-1,t=e,n=E,g=h}return s}function At(q,l,c,s){const n=j(s),g=Math.cos(n),m=Math.sin(n),x=q.x-l,p=q.y-c;return{x:l+x*g-p*m,y:c+x*m+p*g}}function ce(q,l,c,s,n,g,m,x,p){let y="",t=0,i=0,a=0,d=!1;function f(e,r){const o=At({x:e,y:r},l,c,s);return{x:x+(o.x-g)*n,y:p+(o.y-m)*n}}function u(){if(!d){const e=f(t,i);y+="M "+e.x+" "+e.y,d=!0}}for(let e=0;e<q.length;e++){const r=q[e];if(r.type==="turn"){a+=r.angle;continue}if(r.type==="line"){const o=t+r.length*Math.cos(j(a)),b=i+r.length*Math.sin(j(a));u();const E=f(o,b);y+=" L "+E.x+" "+E.y,t=o,i=b;continue}if(r.type==="arc"){const o=t+r.radius*Math.cos(j(a+90)),b=i+r.radius*Math.sin(j(a+90)),E=Math.atan2(i-b,t-o),h=E+j(r.arcAngle),v=o+r.radius*Math.cos(h),A=b+r.radius*Math.sin(h),w=Math.abs(r.arcAngle)%360;if(u(),w<1e-6||Math.abs(r.arcAngle)>=359.9){const P=E+Math.sign(r.arcAngle)*Math.PI,C=o+r.radius*Math.cos(P),S=b+r.radius*Math.sin(P),D=f(C,S),I=f(t,i),B=r.radius*n,G=r.arcAngle>=0?1:0;y+=" A "+B+" "+B+" 0 1 "+G+" "+D.x+" "+D.y,y+=" A "+B+" "+B+" 0 1 "+G+" "+I.x+" "+I.y,a+=r.arcAngle;continue}const _=f(v,A),M=r.radius*n,k=w>180?1:0,L=r.arcAngle>=0?1:0;y+=" A "+M+" "+M+" 0 "+k+" "+L+" "+_.x+" "+_.y,t=v,i=A,a+=r.arcAngle}}return y||"M 0 0"}function le(q){const l=ae(q);let c=Math.min(...l.map(u=>u.x)),s=Math.max(...l.map(u=>u.x)),n=Math.min(...l.map(u=>u.y)),g=Math.max(...l.map(u=>u.y));const m=(c+s)/2,x=(n+g)/2,y=g-n>s-c?-90:0,t=l.map(u=>At(u,m,x,y));c=Math.min(...t.map(u=>u.x)),s=Math.max(...t.map(u=>u.x)),n=Math.min(...t.map(u=>u.y)),g=Math.max(...t.map(u=>u.y));const i=Math.max(1,s-c),a=Math.max(1,g-n),d=(c+s)/2,f=(n+g)/2;return{rotDeg:y,w:i,h:a,cxModel:m,cyModel:x,midX:d,midY:f,ptsRot:t}}function de(q){const l=[];let c=0,s=0,n=0;function g(m){const x=j(m);return{x:Math.cos(x),y:Math.sin(x)}}for(let m=0;m<q.length;m++){const x=q[m];if(x.type==="line")c+=x.length*Math.cos(j(n)),s+=x.length*Math.sin(j(n));else if(x.type==="turn"){const p=g(n),y=x.angle;n+=y;const t=g(n);l.push({x:c,y:s,angleDeg:y,prevDir:p,nextDir:t})}else if(x.type==="arc"){const p=c+x.radius*Math.cos(j(n+90)),y=s+x.radius*Math.sin(j(n+90)),t=Math.atan2(s-y,c-p),i=t+j(x.arcAngle);c=p+x.radius*Math.cos(i),s=y+x.radius*Math.sin(i),n+=x.arcAngle}}return l}function ue(q,l,c){const s=Array.from({length:l},()=>({sumH:0,maxW:0,items:[]})),n=[...q.keys()].sort((g,m)=>q[m].h-q[g].h);for(const g of n){let m=0,x=1/0;for(let y=0;y<l;y++){const t=s[y],i=t.sumH+(t.items.length>0?c:0)+q[g].h;i<x&&(x=i,m=y)}const p=s[m];p.sumH=p.items.length>0?p.sumH+c+q[g].h:p.sumH+q[g].h,p.maxW=Math.max(p.maxW,q[g].w),p.items.push(g)}return s}function pe(q,l,c,s={}){const n=s.padding??12,g=s.gapCol??12,m=s.gapRow??10,x=Math.max(1,Math.min(q.length,s.kMax??4)),p=Math.max(10,l-2*n),y=Math.max(10,c-2*n),t=i(q);function i(o){const b=o.map(B=>B.w/Math.max(B.h,1)),E=o.map(B=>B.h),h=o.map(B=>B.w),v=o.map(B=>B.w*B.h),A=B=>B.reduce((G,Y)=>G+Y,0)/B.length,w=(B,G)=>B.reduce((Y,T)=>Y+Math.pow(T-G,2),0)/B.length,_=(B,G)=>Math.sqrt(w(B,G)),M=A(b),k=A(E),L=A(h),P=v.reduce((B,G)=>B+G,0),C=_(E,k),S=_(h,L),D=k>0?C/k:0,I=L>0?S/L:0;return{avgAspectRatio:M,avgHeight:k,avgWidth:L,totalArea:P,heightCV:D,widthCV:I,isLinear:M>6||k<L*.12,isUniformHeight:D<.15,isUniformWidth:I<.15,isHighlyVariable:D>.5||I>.5,count:o.length}}let a={S:0,k:1,cols:null,score:0};for(let o=1;o<=x;o++){const b=ue(q,o,m),E=b.reduce((T,st)=>T+st.maxW,0)+g*(o-1),h=Math.max(...b.map(T=>T.sumH));if(E<=0||h<=0)continue;const v=p/E,A=y/h,w=Math.min(v,A),_=Math.max(.01,w*.92),M=t.totalArea*_*_,k=p*y,L=M/k,P=b.map(T=>T.sumH*_),C=P.reduce((T,st)=>T+st,0)/o,S=Math.max(...P)-Math.min(...P),D=C>0?1-S/C:1,I=o===1?1.1:o===2?.9:.7,B=o>t.count*.5?.7:1,G=D>.85?1.05:1,Y=_*(1+L*.25)*(1+D*.1)*I*B*G;Y>a.score&&(a={S:_,k:o,cols:b,score:Y,efficiency:L,colBalance:D})}const d=a.cols.map(o=>o.maxW*a.S),f=d.reduce((o,b)=>o+b,0);let u=[];if(a.k===1)u[0]=l/2;else{const o=(a.k-1)*g,b=f+o;if(b<p){const E=p-b,h=g+E/(a.k-1);let v=n;for(let A=0;A<a.k;A++)u[A]=v+d[A]/2,v+=d[A]+h}else{let E=n+Math.max(0,(p-b)/2);for(let h=0;h<a.k;h++)u[h]=E+d[h]/2,E+=d[h]+g}}const e=[],r=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(o=>o.right));for(let o=0;o<a.k;o++){const b=a.cols[o];e[o]=[];const E=b.items.map(S=>q[S].h*a.S),h=E.reduce((S,D)=>S+D,0);if(b.items.length===0)continue;const v=u[o],A=a.cols[o].maxW*a.S,w=v-A/2,_=v+A/2,M=r(),L=Math.max(0,Math.min(_,M)-w)/A,P=L>.05;let C=y;if(P&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const D=Math.min(...window.__legendBoxesGroup.map(I=>I.top))-15;C=Math.max(10,D-n),console.log(`üìè Columna ${o}: X=${w.toFixed(0)}-${_.toFixed(0)}, legendWidth=${M.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura reducida a ${C.toFixed(0)}px`)}else console.log(`üìè Columna ${o}: X=${w.toFixed(0)}-${_.toFixed(0)}, legendWidth=${M.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura completa ${C.toFixed(0)}px`);if(b.items.length===1){const S=E[0],D=n+C/2,I=Math.max(n+S/2,Math.min(D,c-n-S/2));e[o].push(I);continue}if(h>C){console.warn(`Columna ${o}: elementos no caben (${h}px > ${C}px)`);const I=h/b.items.length<4?20:5;let B=n;for(let G=0;G<b.items.length;G++){const Y=Math.max(E[G],2),T=B+Y/2;e[o].push(T),B+=Y+I}}else{const S=C-h,D=b.items.length-1;let I=S/D;h/b.items.length<4?I=Math.max(18,Math.min(I,50)):I=Math.max(5,I);const Y=h+D*I,T=C-Y;let st=n+Math.max(0,T/2);for(let mt=0;mt<b.items.length;mt++){const F=Math.max(E[mt],2),dt=st+F/2,ht=n+C-F/2,$=Math.max(n+F/2,Math.min(dt,ht));e[o].push($),st+=F+I}}}return{S:a.S,k:a.k,cols:a.cols,centersX:u,centersYByCol:e,padding:n,gapRow:m,gapCol:g}}window.renderizarGrupoSVG=function(l,c){const s=l&&l.etiqueta&&l.etiqueta.id!=null?l.etiqueta.id:l&&l.id!=null?l.id:c,n=document.getElementById("contenedor-svg-"+s);if(!n)return;const g=600,m=150,x=Jt(n),p=Kt(g,m,x);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const y=[],t=new Map;(l.elementos||[]).forEach(e=>{var E,h,v,A,w,_;let r="0";if(e.diametro!=null&&e.diametro!==""){const k=String(e.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(k){const L=parseFloat(k[0]);isFinite(L)&&(r=String(Math.round(L)))}}const o=(e.dimensiones||"barra").trim().toLowerCase(),b=`${r}|${o}`;if(t.has(b)){const M=t.get(b);y[M].barrasTotal+=e.barras||0,(E=e.coladas)!=null&&E.colada1&&!y[M].coladasSet.has(e.coladas.colada1)&&y[M].coladasSet.add(e.coladas.colada1),(h=e.coladas)!=null&&h.colada2&&!y[M].coladasSet.has(e.coladas.colada2)&&y[M].coladasSet.add(e.coladas.colada2),(v=e.coladas)!=null&&v.colada3&&!y[M].coladasSet.has(e.coladas.colada3)&&y[M].coladasSet.add(e.coladas.colada3)}else{const M=new Set;(A=e.coladas)!=null&&A.colada1&&M.add(e.coladas.colada1),(w=e.coladas)!=null&&w.colada2&&M.add(e.coladas.colada2),(_=e.coladas)!=null&&_.colada3&&M.add(e.coladas.colada3),y.push({elemento:e,diametro:r,dimensiones:e.dimensiones,barrasTotal:e.barras||0,coladasSet:M}),t.set(b,y.length-1)}});const i=y.map((e,r)=>{const o=[];l.colada_etiqueta&&o.push(l.colada_etiqueta),l.colada_etiqueta_2&&l.colada_etiqueta_2!==l.colada_etiqueta&&o.push(l.colada_etiqueta_2),o.length===0&&e.coladasSet.size>0&&o.push(...e.coladasSet);const b=o.length>0?` (${o.join(", ")})`:"";return{letter:zt(r),text:`√ò${e.diametro} x${e.barrasTotal}${b}`}});ee(p,i,g,m);const a=y.map(e=>{const r=e.elemento,o=oe(r.dimensiones||""),b=ne(o);let E=0;for(const _ of b)_.type==="line"&&(E=Math.max(E,Math.abs(_.length||0))),_.type==="arc"&&(E=Math.max(E,Math.abs(_.radius||0)));const v=E<=50?2:1,A=Ut(b,v),w=le(A);return{dimsRaw:o,dimsNoZero:b,dimsScaled:A,geomScale:v,medida:w}}),d=a.map(e=>e.medida),f=pe(d,g,m,{padding:20,gapCol:50,gapRow:22,kMax:3}),u=new Map;for(let e=0;e<f.k;e++)f.cols[e].items.forEach((r,o)=>u.set(r,{c:e,j:o}));y.forEach(function(e,r){const o=e.elemento,{dimsNoZero:b,dimsScaled:E,medida:h}=a[r],v=u.get(r),A=f.centersX[v.c],w=f.centersYByCol[v.c][v.j],_=f.S,M=h.ptsRot.map(F=>({x:A+(F.x-h.midX)*_,y:w+(F.y-h.midY)*_})),k=Math.min(...M.map(F=>F.x)),L=Math.max(...M.map(F=>F.x)),P=Math.min(...M.map(F=>F.y)),C=Math.max(...M.map(F=>F.y)),S={left:k,right:L,top:P,bottom:C};window.__figBoxesGroup.push({...S});const D=re(E,.6),I=ce(D,h.cxModel,h.cyModel,h.rotDeg,_,h.midX,h.midY,A,w),B=Qt(p,I,Ht,2);(function(){const dt=de(E);function ht(N){return Math.abs(Math.abs(N)-90)>=Yt}const $=(N,O)=>At({x:N.x,y:N.y},0,0,O),K=(N,O)=>{const W=At({x:N,y:O},h.cxModel,h.cyModel,h.rotDeg);return{x:A+(W.x-h.midX)*_,y:w+(W.y-h.midY)*_}},z=N=>Math.max(10,Math.min(28,N));dt.forEach(N=>{if(!ht(N.angleDeg))return;const O=K(N.x,N.y),W=$(N.prevDir,h.rotDeg),ft=$(N.nextDir,h.rotDeg),J=Math.atan2(W.y,W.x),V=J+j(N.angleDeg),Q=Math.min(S.right-S.left,S.bottom-S.top);let R=z(.12*Q);const wt=O.x+R*Math.cos(J),gt=O.y+R*Math.sin(J),U=O.x+R*Math.cos(V),bt=O.y+R*Math.sin(V),Z=Math.abs(N.angleDeg),it=Z>180?1:0,Mt=N.angleDeg>=0?1:0,rt=document.createElementNS("http://www.w3.org/2000/svg","path");rt.setAttribute("d",`M ${wt} ${gt} A ${R} ${R} 0 ${it} ${Mt} ${U} ${bt}`),rt.setAttribute("stroke","rgba(255,99,71,0.7)"),rt.setAttribute("stroke-width","2"),rt.setAttribute("fill","none"),rt.style.pointerEvents="none",p.appendChild(rt);let X=W.x+ft.x,H=W.y+ft.y;Z>180&&(X=-X,H=-H);let tt=Math.hypot(X,H);if(tt<1e-6){const lt=N.angleDeg>=0?1:-1;X=-W.y*lt,H=W.x*lt,tt=Math.hypot(X,H)||1}X/=tt,H/=tt;const et=(Math.round(N.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",ot=Lt(et,14);function _t(lt,ut){return{left:lt-ot.w/2,right:lt+ot.w/2,top:ut-ot.h/2,bottom:ut+ot.h/2}}let nt=null;for(let lt=Tt;lt<=Wt&&!nt;lt+=4)for(let ut=0;ut<Ft.length&&!nt;ut++){const xt=Ft[ut],Et=$({x:X,y:H},xt),St=O.x+Et.x*(R+lt),pt=O.y+Et.y*(R+lt),yt=_t(St,pt);yt.top<0||yt.bottom>m||yt.left<0||yt.right>g||window.__figBoxesGroup.some(qt=>at(qt,yt,6))||(window.__dimBoxesGroup||[]).some(qt=>at(qt,yt,2))||(window.__angleBoxesGroup||[]).some(qt=>at(qt,yt,2))||(window.__placedLetterBoxes||[]).some(qt=>at(qt,yt,2))||(window.__legendBoxesGroup||[]).some(qt=>at(qt,yt,6))||(nt={x:St,y:pt,box:yt})}if(!nt){const lt=O.x+X*(R+Tt),ut=O.y+H*(R+Tt),xt=_t(lt,ut);nt={x:lt,y:ut,box:xt}}window.__angleBoxesGroup.push(nt.box);const ct=document.createElementNS("http://www.w3.org/2000/svg","text");ct.setAttribute("x",nt.x),ct.setAttribute("y",nt.y),ct.setAttribute("fill",Bt),ct.setAttribute("font-size",14),ct.setAttribute("text-anchor","middle"),ct.setAttribute("alignment-baseline","middle"),ct.style.cursor="pointer",ct.textContent=et,p.appendChild(ct),ct.addEventListener("mouseenter",()=>{rt.setAttribute("stroke","rgba(255,69,0,1)"),rt.setAttribute("stroke-width","3"),rt.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),ct.addEventListener("mouseleave",()=>{rt.setAttribute("stroke","rgba(255,99,71,0.7)"),rt.setAttribute("stroke-width","2"),rt.style.filter="none"})})})();const G=B.cloneNode(!1);G.setAttribute("stroke-width","50"),G.setAttribute("stroke","transparent"),G.setAttribute("fill","none"),G.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(F=>{G.addEventListener(F,dt=>B.dispatchEvent(new dt.constructor(dt.type,dt)))}),p.insertBefore(G,B),(o.codigo!=null?o.codigo:o.id)+"",B.style.cursor="pointer",B.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),B.addEventListener("click",function(F){if(F.ctrlKey||F.metaKey||F.shiftKey){F.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(o.id);return}abrirModalDividirElemento(o.id,o.barras||0)}),B.addEventListener("contextmenu",function(F){F.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(o.id)});const Y=[],T=Rt(D),st=Rt(b);ie(T,st,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(F){const dt=At(F.start,h.cxModel,h.cyModel,h.rotDeg),ht=At(F.end,h.cxModel,h.cyModel,h.rotDeg),$={x:A+(dt.x-h.midX)*_,y:w+(dt.y-h.midY)*_},K={x:A+(ht.x-h.midX)*_,y:w+(ht.y-h.midY)*_},z=F._label,N=K.x-$.x,O=K.y-$.y,W=Math.hypot(N,O)||1,ft=N/W,J=O/W,V=O/W,Q=-N/W,R=($.x+K.x)/2,wt=($.y+K.y)/2,gt=R+V*10,U=wt+Q*10,bt=Lt(z,14),Z=bt.w,it=bt.h;function Mt(nt,ct){return{left:nt-Z/2,right:nt+Z/2,top:ct-it/2,bottom:ct+it/2}}const rt=W*.45;let X=gt,H=U;for(let nt=0;nt<=Math.ceil(rt/6);nt++){const ct=nt%2===0?1:-1,lt=Math.ceil(nt/2),ut=ct*lt*6;if(Math.abs(ut)>rt)continue;const xt=gt+ft*ut,Et=U+J*ut,St=(xt-$.x)*ft+(Et-$.y)*J;if(St<0+Z*.3||St>W-Z*.3)continue;const pt=Mt(xt,Et);if(!(at({left:Math.min($.x,K.x),right:Math.max($.x,K.x),top:Math.min($.y,K.y),bottom:Math.max($.y,K.y)},pt,0)||(window.__angleBoxesGroup||[]).some(vt=>at(vt,pt,2))||(window.__legendBoxesGroup||[]).some(vt=>at(vt,pt,6))||Y.some(vt=>at(vt,pt,2))||pt.top<0||pt.bottom>m||pt.left<0||pt.right>g)){X=xt,H=Et,Y.push(pt),window.__dimBoxesGroup.push(pt);break}}const tt=document.createElementNS("http://www.w3.org/2000/svg","line");tt.setAttribute("x1",$.x),tt.setAttribute("y1",$.y),tt.setAttribute("x2",K.x),tt.setAttribute("y2",K.y),tt.setAttribute("stroke","rgba(0,0,255,0.6)"),tt.setAttribute("stroke-width","4"),tt.setAttribute("stroke-linecap","round"),tt.setAttribute("vector-effect","non-scaling-stroke"),tt.style.opacity=0,tt.style.pointerEvents="none",tt.style.transition="opacity 120ms ease",p.appendChild(tt);const et=document.createElementNS("http://www.w3.org/2000/svg","text");et.setAttribute("x",X),et.setAttribute("y",H),et.setAttribute("fill",Bt),et.setAttribute("font-size",14),et.setAttribute("text-anchor","middle"),et.setAttribute("alignment-baseline","middle"),et.setAttribute("tabindex","0"),et.style.cursor="pointer",et.textContent=z,p.appendChild(et);function ot(){tt.style.opacity=1}function _t(){tt.style.opacity=0}et.addEventListener("mouseenter",ot),et.addEventListener("mouseleave",_t),et.addEventListener("focus",ot),et.addEventListener("blur",_t)}),function(){const dt=[];let ht=0,$=0,K=0;for(let z=0;z<E.length;z++){const N=E[z];if(N.type==="line")ht+=N.length*Math.cos(j(K)),$+=N.length*Math.sin(j(K));else if(N.type==="turn")K+=N.angle;else if(N.type==="arc"){const O=ht+N.radius*Math.cos(j(K+90)),W=$+N.radius*Math.sin(j(K+90)),ft=Math.atan2($-W,ht-O),J=ft+j(N.arcAngle);let V=N.radius;for(let Q=0;Q<b.length;Q++){const R=b[Q];if(R.type==="arc"&&Math.abs(R.arcAngle-N.arcAngle)<.01){V=R.radius;break}}dt.push({center:{x:O,y:W},radius:N.radius,originalRadius:V,arcAngle:N.arcAngle,startAngle:ft,endAngle:J}),ht=O+N.radius*Math.cos(J),$=W+N.radius*Math.sin(J),K+=N.arcAngle}}dt.forEach(function(z){const N=At(z.center,h.cxModel,h.cyModel,h.rotDeg),O={x:A+(N.x-h.midX)*_,y:w+(N.y-h.midY)*_},W=(z.startAngle+z.endAngle)/2,ft=z.radius*_,J="R"+Xt(z.originalRadius,{decimals:0,step:null}),V=Lt(J,14),Q=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let R=!1,wt,gt,U;for(let ot=0;ot<Q.length&&!R;ot++){const _t=Q[ot],nt=W+j(_t),ct={x:z.center.x+z.radius*Math.cos(nt),y:z.center.y+z.radius*Math.sin(nt)},lt=At(ct,h.cxModel,h.cyModel,h.rotDeg),ut={x:A+(lt.x-h.midX)*_,y:w+(lt.y-h.midY)*_},xt=ut.x-O.x,Et=ut.y-O.y,St=Math.hypot(xt,Et)||1,pt=xt/St,yt=Et/St;for(let Ct=8;Ct<=60&&!R;Ct+=6){const $t=ft*.7;if(wt=O.x+pt*$t+pt*Ct,gt=O.y+yt*$t+yt*Ct,U={left:wt-V.w/2,right:wt+V.w/2,top:gt-V.h/2,bottom:gt+V.h/2},!(U.top<0||U.bottom>m||U.left<0||U.right>g||window.__figBoxesGroup.some(It=>at(It,U,2))||(window.__legendBoxesGroup||[]).some(It=>at(It,U,2)))){R=!0;break}}}if(!R)return;Y.push(U);const bt={x:wt-O.x,y:gt-O.y},Z=Math.hypot(bt.x,bt.y)||1,it={x:bt.x/Z,y:bt.y/Z},Mt=O.x+it.x*ft*.6,rt=O.y+it.y*ft*.6,X=document.createElementNS("http://www.w3.org/2000/svg","line");X.setAttribute("x1",O.x),X.setAttribute("y1",O.y),X.setAttribute("x2",Mt),X.setAttribute("y2",rt),X.setAttribute("stroke","rgba(0,128,0,0.6)"),X.setAttribute("stroke-width","4"),X.setAttribute("stroke-linecap","round"),X.setAttribute("vector-effect","non-scaling-stroke"),X.style.opacity=0,X.style.pointerEvents="none",X.style.transition="opacity 120ms ease",p.appendChild(X);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",wt),H.setAttribute("y",gt),H.setAttribute("fill",Bt),H.setAttribute("font-size",14),H.setAttribute("text-anchor","middle"),H.setAttribute("alignment-baseline","middle"),H.setAttribute("tabindex","0"),H.style.cursor="pointer",H.textContent=J,p.appendChild(H);function tt(){X.style.opacity=1}function et(){X.style.opacity=0}H.addEventListener("mouseenter",tt),H.addEventListener("mouseleave",et),H.addEventListener("focus",tt),H.addEventListener("blur",et)})}(),function(){const dt=zt(r),ht=14,$=Lt(dt,ht);function K(V,Q){return{left:V,right:V+$.w,top:Q-$.h/2,bottom:Q+$.h/2}}let z=null;const N=(S.top+S.bottom)/2,O=Math.max($.h/2,Math.min(N,m-$.h/2));function W(V){for(let R=0;R<=30;R+=4){const wt=R%2===0?1:-1,gt=Math.ceil(R/2),U=wt*gt*4,bt=Math.max($.h/2,Math.min(m-$.h/2,O+U)),Z=V,it=K(Z,bt);if(!(window.__figBoxesGroup.some(ot=>at(ot,it,6))||(window.__dimBoxesGroup||[]).some(ot=>at(ot,it,3))||(window.__angleBoxesGroup||[]).some(ot=>at(ot,it,3))||(window.__legendBoxesGroup||[]).some(ot=>at(ot,it,6))||(window.__placedLetterBoxes||[]).some(ot=>at(ot,it,2))||it.top<0||it.bottom>m||it.left<0||it.right>g))return z={x:Z,y:bt,box:it},!0}return!1}const ft=[{x:S.right+10,priority:1},{x:S.left-10-$.w,priority:1},{x:S.right+15,priority:2},{x:S.left-15-$.w,priority:2},{x:S.right+5,priority:2},{x:S.left-5-$.w,priority:2},{x:S.right+20,priority:3},{x:S.left-20-$.w,priority:3},{x:S.right+25,priority:3},{x:S.left-25-$.w,priority:3},{x:S.right+30,priority:3},{x:S.left-30-$.w,priority:3}];ft.sort((V,Q)=>V.priority-Q.priority);for(const V of ft){if(z)break;const Q=Nt(V.x,$.w,0,g);if(W(Q))break}if(!z){const V=(S.left+S.right)/2,Q=[{x:V-$.w/2,y:S.top-$.h-5},{x:V-$.w/2,y:S.bottom+$.h+5}];for(const R of Q){if(z)break;const wt=Nt(R.x,$.w,0,g),gt=Math.max($.h/2,Math.min(m-$.h/2,R.y)),U=K(wt,gt);!window.__figBoxesGroup.some(Z=>at(Z,U,6))&&!(window.__dimBoxesGroup||[]).some(Z=>at(Z,U,3))&&!(window.__angleBoxesGroup||[]).some(Z=>at(Z,U,3))&&!(window.__legendBoxesGroup||[]).some(Z=>at(Z,U,6))&&!(window.__placedLetterBoxes||[]).some(Z=>at(Z,U,2))&&U.top>=0&&U.bottom<=m&&U.left>=0&&U.right<=g&&(z={x:wt,y:gt,box:U})}}if(!z){const V=Nt(g-$.w,$.w,0,g),Q=O;z={x:V,y:Q,box:K(V,Q)}}window.__placedLetterBoxes.push(z.box);const J=document.createElementNS("http://www.w3.org/2000/svg","text");J.setAttribute("x",z.x),J.setAttribute("y",z.y),J.setAttribute("fill",Vt),J.setAttribute("font-size",ht),J.setAttribute("text-anchor","start"),J.setAttribute("alignment-baseline","middle"),J.style.fontWeight="600",J.style.pointerEvents="none",J.textContent=dt,p.appendChild(J)}()}),n.innerHTML="",n.appendChild(p)};function Dt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const q=window.elementosAgrupadosScript;if(!q)return;const l=document.getElementById("grid-maquina");if(l&&window.updateGridClasses){const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}q.forEach(function(c,s){renderizarGrupoSVG(c,s)}),requestAnimationFrame(()=>{l&&(l.style.opacity="1",l.style.visibility="visible",l.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",l.className)),document.querySelectorAll(".proceso").forEach(c=>{c.style.opacity="1"})}),window.actualizarSVGConColadas=function(c,s){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,g=n.findIndex(x=>x.etiqueta&&String(x.etiqueta.etiqueta_sub_id)===String(c));if(g===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const m=n[g];m.elementos&&s&&m.elementos.forEach(x=>{const p=String(x.id),y=s[p];x.coladas||(x.coladas={colada1:null,colada2:null,colada3:null}),y&&Array.isArray(y)&&(x.coladas.colada1=y[0]||null,x.coladas.colada2=y[1]||null,x.coladas.colada3=y[2]||null)}),renderizarGrupoSVG(m,g),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${c}`,s)},window.limpiarColadasSVG=function(c){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,n=s.findIndex(m=>m.etiqueta&&String(m.etiqueta.etiqueta_sub_id)===String(c));if(n===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const g=s[n];g.elementos&&g.elementos.forEach(m=>{m.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(g,n),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${c}`)},window.addEventListener("regenerar-svg-etiqueta",function(c){var x;const s=(x=c.detail)==null?void 0:x.etiquetaSubId;if(!s||!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,g=n.findIndex(p=>p.etiqueta&&String(p.etiqueta.etiqueta_sub_id)===String(s));if(g===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${s}`);return}const m=n[g];renderizarGrupoSVG(m,g),console.log(`üîÑ SVG regenerado para etiqueta ${s} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);window.abrirModalDividirElemento=function(l,c){const s=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),g=document.getElementById("dividir_barras_totales"),m=document.getElementById("labelBarrasActuales"),x=document.getElementById("barras_a_mover"),p=document.getElementById("previewDivision"),y=document.getElementById("formDividirElemento");if(!s||!n||!y)return;n.value=l;let t=parseInt(c)||0;if(t===0&&window.elementosAgrupadosScript){for(const i of window.elementosAgrupadosScript)if(i.elementos){const a=i.elementos.find(d=>String(d.id)===String(l));if(a&&a.barras){t=parseInt(a.barras)||0;break}}}g&&(g.value=t),m&&(m.textContent=t>0?t:"-"),x&&(x.value=""),p&&p.classList.add("hidden"),window.rutaDividirElemento&&y.setAttribute("action",window.rutaDividirElemento),s.classList.remove("hidden")};window.enviarDivision=async function(){const l=document.getElementById("formDividirElemento"),c=l.getAttribute("action")||window.rutaDividirElemento,s=new FormData(l);try{const n=document.querySelector('meta[name="csrf-token"]'),g=s.get("_token")||(n?n.getAttribute("content"):null),x=await fetch(c,{method:"POST",headers:g?{"X-CSRF-TOKEN":g}:{},body:s}),p=await x.json();if(!x.ok||!p.success)throw new Error(p.message||"Error al dividir");l.reset();const y=document.getElementById("modalDividirElemento");y&&y.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",p.message,"success"):alert(p.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(q){const l={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},c={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function s(p,y,t={}){console.log(`üîÑ Actualizando etiqueta ${p} a estado: ${y}`);const i=String(p).replace(/\./g,"-"),a=document.querySelector(`#etiqueta-${i}`);if(!a)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${p}`),!1;const d=String(y).toLowerCase().trim(),f=c[d];if(!f)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${y}`),!1;a.dataset.estado=d,Array.from(a.classList).forEach(o=>{o.startsWith("estado-")&&a.classList.remove(o)}),a.classList.add(f.cssClass),a.style.setProperty("--bg-estado",f.bgColor);const e=a.querySelector('[id^="contenedor-svg-"]');if(e){const o=e.querySelector("svg");o&&(o.style.background=f.bgColor)}const r=a.querySelector(".etiqueta-card")||a;return r&&(r.style.background=f.bgColor),n(a,d),g(a),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:p,estado:d,datosExtra:t}})),console.log(`‚úÖ Etiqueta ${p} actualizada a ${y}`),!0}function n(p,y){const t=p.querySelectorAll(".btn-fabricar"),i=["empaquetada","en-paquete"];t.forEach(a=>{i.includes(y)?(a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed",a.title=`Etiqueta ya ${y}`):(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer",a.title="Fabricar esta etiqueta")})}function g(p){p.style.transition="transform 0.5s ease, background-color 0.5s ease",p.style.transform="scale(1.03)",setTimeout(()=>{p.style.transform="scale(1)"},400)}function m(p,y,t={}){console.log(`üîÑ Actualizando ${p.length} etiquetas...`);const a=p.map(d=>s(d,y,t)).filter(d=>d).length;return console.log(`‚úÖ ${a}/${p.length} etiquetas actualizadas`),a}function x(p){const y=String(p).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${y}`);return t?{id:p,estado:t.dataset.estado||"desconocido",elemento:t}:null}window.addEventListener("paquete:creado",p=>{const{codigoPaquete:y,etiquetaIds:t}=p.detail;console.log(`üì¶ Evento paquete:creado recibido - ${y} con ${t.length} etiquetas`),m(t,"empaquetada",{codigo_paquete:y})}),q.SistemaDOM={actualizarEstadoEtiqueta:s,actualizarMultiplesEtiquetas:m,obtenerEstadoActual:x,ESTADOS_CONFIG:c},q.ColoresEstado={actualizar:(p,y)=>{l[p]=y;const t=document.getElementById("colores-estado-css");if(t){let i=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[a,d]of Object.entries(l))i+=`.proceso.estado-${a} {
    --bg-estado: ${d};
}
`;t.textContent=i,console.log(`‚úÖ Color actualizado para estado "${p}": ${y}`)}},obtenerColor:p=>l[p],todos:()=>({...l})}})(window);function Pt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const t=localStorage.getItem("decisionCortePorEtiqueta");t&&(window._decisionCortePorEtiqueta=JSON.parse(t),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(t){console.warn("No se pudieron restaurar decisiones de corte:",t)}document.addEventListener("click",async t=>{var b,E,h;const i=t.target.closest(".btn-fabricar");if(!i)return;t.preventDefault();const a=(E=(b=document.getElementById("maquina-info"))==null?void 0:b.dataset)==null?void 0:E.maquinaId;if(!a){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const d=i.dataset.grupoId;if(d){const v=i.disabled;i.disabled=!0;try{await l(d,a)}finally{i.disabled=v}return}const f=String(i.dataset.etiquetaId||"").trim(),u=f.replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${u}`);if(e){const v=(e.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(v)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${f} ya est√° en estado ${v}.`,timer:2500,showConfirmButton:!1});return}}const r=Number(((h=window.DIAMETRO_POR_ETIQUETA)==null?void 0:h[f])??0);if(!f){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!r&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const o=i.disabled;i.disabled=!0;try{await q(f,a,r)}finally{i.disabled=o}});async function q(t,i,a=null){var v,A,w,_,M,k,L,P;const d=`/actualizar-etiqueta/${t}/maquina/${i}`,f=(v=document.querySelector('meta[name="csrf-token"]'))==null?void 0:v.getAttribute("content"),u=t.replace(/\./g,"-"),r=(((w=(A=document.querySelector(`#etiqueta-${u}`))==null?void 0:A.dataset)==null?void 0:w.estado)||"").toLowerCase()==="fabricando",o=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",b=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",E=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(o&&b||E){if(r)if((_=window._decisionCortePorEtiqueta)!=null&&_[t]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:f,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const C=await fetch(`/api/etiquetas/${t}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":f}});if(C.ok){const S=await C.json();if(S.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:S.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],csrfToken:f,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1});return}}}catch(C){console.warn("No se pudo obtener longitud asignada:",C)}for(;;){let C;try{C=await Cortes.mejorCorteSimple(t,a,f)}catch(S){y(S);return}if(!C)return;if(C.accion==="optimizar"){let S;try{S=await Cortes.mejorCorteOptimizado(t,a,C.patrones,f)}catch(D){y(D);return}if((S==null?void 0:S.accion)==="fabricar"){const D=((M=S.patronInfo)==null?void 0:M.desperdicio_cm)||((k=S.patron)==null?void 0:k.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:S.longitudBarraCm,etiquetas:S.etiquetas,desperdicioEstimadoCm:D},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const I=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:f,etiquetaId:t,onUpdate:n});if(I!=null&&I.cancelled)continue;return}else{if(S==="volver")continue;return}}if(C.accion==="fabricar_patron_simple"){const S=Math.round(Number(C.longitud_m||0)*100);if(!S){y("Longitud de barra no v√°lida.");return}const D=((L=C.patronInfo)==null?void 0:L.desperdicio_cm)||((P=C.patron)==null?void 0:P.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:S,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],desperdicioEstimadoCm:D},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const I=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:f,etiquetaId:t,onUpdate:n});if(I!=null&&I.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,i,f)}catch(C){y(C)}return}try{const C=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f},body:JSON.stringify({})}),S=await C.json();if(!C.ok)throw new Error(S.message||"Error al actualizar");n(t,S)}catch(C){y(C)}}async function l(t,i){var A,w,_,M,k,L;const a=(A=document.querySelector('meta[name="csrf-token"]'))==null?void 0:A.getAttribute("content"),d=document.querySelector(`[data-grupo-id="${t}"] .etiqueta-card`),f=(((w=d==null?void 0:d.dataset)==null?void 0:w.estado)||"pendiente").toLowerCase(),u=parseInt((_=d==null?void 0:d.dataset)==null?void 0:_.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(f)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${f}.`,timer:2500,showConfirmButton:!1});return}const e=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",r=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",o=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",b=e&&r||o;let E=[];try{E=JSON.parse(((M=d==null?void 0:d.dataset)==null?void 0:M.etiquetasSubIds)||"[]")}catch(P){console.warn("Error parseando etiquetas del grupo:",P)}const h=(k=d==null?void 0:d.dataset)==null?void 0:k.primeraEtiquetaId,v=((L=d==null?void 0:d.dataset)==null?void 0:L.planillaId)||window.PLANILLA_ID;if(f==="pendiente"&&b&&h){try{const P=await Cortes.mejorCorteSimple(h,u,a);if(!P)return;const C=E.map(D=>{var I;return{etiqueta_sub_id:D,patron_letras:((I=P.patron)==null?void 0:I.patron_letras)||""}}),S=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:P.longitudBarraCm,etiquetas:C,csrfToken:a,etiquetaId:h,onUpdate:(D,I)=>{c(d,"fabricando",t)},pedirDesperdicio:!0});if(S!=null&&S.cancelled)return;c(d,"fabricando",t),p("info","Fabricando",`Grupo iniciado (${E.length} etiquetas)`)}catch(P){y(P)}return}try{const P=await fetch(`/api/etiquetas/resumir/${t}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({maquina_id:i})}),C=await P.json();if(!P.ok||!C.success)throw new Error(C.message||"Error al actualizar grupo");const S=C.nuevo_estado||"actualizado",D=C.imprimir_etiquetas||[];if(c(d,S,t),S==="fabricando"?p("info","Fabricando",`Grupo iniciado (${C.etiquetas_actualizadas||0} etiquetas)`):S==="completada"&&p("success","¬°Completado!",`Grupo completado (${C.etiquetas_actualizadas||0} etiquetas)`),S==="completada"&&D.length>0){const I=D.map(T=>T.etiqueta_sub_id);await new Promise(T=>setTimeout(T,300));const B=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${I.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});B.isConfirmed&&typeof window.imprimirEtiquetas=="function"?window.imprimirEtiquetas(I,"a6"):B.isDenied&&typeof window.imprimirEtiquetas=="function"&&window.imprimirEtiquetas(I,"a4"),await new Promise(T=>setTimeout(T,1e3));const G=C.planilla_id||v,Y=C.maquina_id||i;if(G&&Y)try{await fetch("/api/etiquetas/resumir",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,Accept:"application/json"},body:JSON.stringify({planilla_id:G,maquina_id:Y})}),console.log("Etiquetas reagrupadas despu√©s de completar")}catch(T){console.warn("No se pudieron reagrupar las etiquetas:",T)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let T=0;for(const st of I)try{const mt=await window.TrabajoPaquete.validarEtiqueta(st);mt.valida&&window.TrabajoPaquete.agregarItemEtiqueta(st,mt)&&T++}catch(mt){console.warn(`No se pudo a√±adir ${st} al carro:`,mt)}T>0&&p("success","A√±adidas al carro",`${T} etiquetas a√±adidas al carro`)}c(d,"completada",t)}}catch(P){y(P)}}function c(t,i,a){if(!t)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(u=>{t.classList.remove(`estado-${u}`)}),t.classList.add(`estado-${i}`),t.dataset.estado=i;const d=t.dataset.contenedorSvgId,f=t.dataset.elementos;if(d&&f&&typeof window.renderizarGrupoSVG=="function")try{const u=JSON.parse(f),e={id:parseInt(d),etiqueta:{id:parseInt(d)},elementos:u};window.renderizarGrupoSVG(e,a)}catch(u){console.warn("No se pudo re-renderizar SVG del grupo:",u)}}async function s(t,i,a){var D,I,B,G,Y;const d=Number(((D=window.DIAMETRO_POR_ETIQUETA)==null?void 0:D[t])??0),u=Number(((I=window.LONGITUD_POR_ETIQUETA)==null?void 0:I[t])??0)/100;let e="";try{const T=await fetch(`/api/productos/sugerencias?diametro=${d}&longitud=${u}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":a}});if(T.ok){const st=await T.json();st.productos&&st.productos.length>0?e=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${d}mm x ${u.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${st.productos.map(mt=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${mt.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${mt.codigo}</td>
                                                <td class="px-2 py-1">${mt.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${mt.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${mt.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:e=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${d}mm x ${u.toFixed(1)}m</p>`}}catch(T){console.warn("No se pudieron cargar sugerencias:",T)}const{value:r,isConfirmed:o}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${e}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const T=document.getElementById("swal-input-producto").value;return!T||!T.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):T.trim()}});if(!o||!r)return;let b;try{const T=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(r.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":a}});if(!T.ok){const st=await T.json();throw new Error(st.message||"Producto no encontrado")}b=await T.json()}catch(T){await Swal.fire({icon:"error",title:"Producto no encontrado",text:T.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${r}`});return}const E=(b.tipo||"").toLowerCase(),h=Number(b.diametro??0),v=Number(b.longitud??0);if(E&&E!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${b.codigo}</p>
                        <p><strong>Tipo:</strong> ${b.tipo||"N/A"}</p>
                    </div>
                `});return}if(h>0&&d>0&&Math.abs(h-d)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${h} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${d} mm</p>
                    </div>
                `});return}if(v>0&&u>0&&Math.abs(v-u)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${v.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${u.toFixed(2)} m</p>
                    </div>
                `});return}const A=b.longitud?`${b.longitud} m`:"N/A",{value:w,isConfirmed:_}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${b.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${b.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${A}</p>
                    <p><strong>Stock actual:</strong> ${((B=b.peso_stock)==null?void 0:B.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${b.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!_)return;const M=w==="completo",k=`/actualizar-etiqueta/${t}/maquina/${i}`,L=await fetch(k,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({producto_id:b.id,paquete_completo:M})}),P=await L.json();if(!L.ok)throw new Error(P.message||"Error al fabricar");const C=((G=P.metricas)==null?void 0:G.peso_consumido)||0,S=((Y=P.metricas)==null?void 0:Y.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${b.codigo}</p>
                <p><strong>Peso consumido:</strong> ${C.toFixed(2)} kg</p>
                ${S?`<p><strong>Paquete:</strong> ${S}</p>`:""}
                ${M?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),n(t,P),S&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const T=document.getElementById("codigo_paquete_mover");T&&(T.value=S,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function n(t,i){var d,f;const a=t.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:i.estado,peso_etiqueta:i.peso_etiqueta,nombre:i.nombre,producto_n_colada:i.producto_n_colada,producto2_n_colada:i.producto2_n_colada,data_completa:i}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,i.estado,{peso:i.peso_etiqueta,nombre:i.nombre||t}):g(t,i.estado),i.producto_n_colada&&window.elementosAgrupadosScript){const u=window.elementosAgrupadosScript.findIndex(e=>e.etiqueta&&String(e.etiqueta.etiqueta_sub_id)===String(t));if(u!==-1){const e=window.elementosAgrupadosScript[u];e.colada_etiqueta=i.producto_n_colada,e.colada_etiqueta_2=i.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(e,u),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${i.producto_n_colada}`))}}switch(i.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,i.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(t,!0),(i.estado||"").toLowerCase()){case"cortando":p("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":p("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),m(a);break;case"fabricando":p("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":p("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),m(a),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"fabricada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(e=>e.coladas&&(e.coladas.colada1||e.coladas.colada2||e.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),x(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":p("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(d=window._decisionCortePorEtiqueta)!=null&&d[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),m(a),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"completada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(e=>e.coladas&&(e.coladas.colada1||e.coladas.colada2||e.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),x(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":p("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":p("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),m(a);break;case"soldando":p("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":p("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),m(a);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${i.estado}`),p("warning","Estado desconocido",`El estado recibido (${i.estado}) no est√° reconocido.`,3e3)}(f=i.productos_afectados)!=null&&f.length&&i.productos_afectados.forEach(u=>{const e=document.getElementById(`peso-stock-${u.id}`),r=document.getElementById(`progreso-texto-${u.id}`),o=document.getElementById(`progreso-barra-${u.id}`);e&&(e.textContent=`${u.peso_stock} kg`),r&&(r.textContent=`${u.peso_stock} / ${u.peso_inicial} kg`),o&&(o.style.height=`${u.peso_stock/u.peso_inicial*100}%`)})}function g(t,i){const a=t.replace(/\./g,"-"),d=document.getElementById("etiqueta-"+a);if(!d)return;d.dataset.estado=String(i||"").toLowerCase(),d.className=d.className.split(" ").filter(e=>!e.startsWith("estado-")).join(" ").trim(),d.classList.add("estado-"+d.dataset.estado);const f=d.querySelector('[id^="contenedor-svg-"]'),u=f==null?void 0:f.querySelector("svg");u&&(u.style.background=getComputedStyle(d).getPropertyValue("--bg-estado").trim())}function m(t){const i=`#etiqueta-${CSS.escape(t)}`,a=document.querySelector(i),d=Array.from(document.querySelectorAll(".proceso")),f=h=>(h||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),u=h=>{var w;const v=(w=h.dataset)==null?void 0:w.estado;if(v)return f(v);const A=h.querySelector('[id^="estado-"]');return f((A==null?void 0:A.textContent)||(A==null?void 0:A.innerText)||"")},e=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),r=h=>e.has(u(h)),o=a?d.indexOf(a):-1,E=(o>=0?d.slice(o+1):d).find(h=>!r(h));E?E.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function x(t,i){var e;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!i||!Array.isArray(i)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(i.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const a=window.elementosAgrupadosScript.findIndex(r=>{var o;return((o=r.etiqueta)==null?void 0:o.etiqueta_sub_id)===t});if(a===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[a].elementos=i;const d=window.elementosAgrupadosScript[a],f=(e=d.etiqueta)==null?void 0:e.id;if(!f){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const u=document.getElementById("contenedor-svg-"+f);if(!u){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${f})`);return}try{const r=u.querySelector("svg");r&&r.remove();const o=600,b=150,E=u.closest(".proceso"),h=E&&getComputedStyle(E).getPropertyValue("--bg-estado").trim()||"#e5e7eb",v=document.createElementNS("http://www.w3.org/2000/svg","svg");v.setAttribute("viewBox",`0 0 ${o} ${b}`),v.setAttribute("preserveAspectRatio","xMidYMid meet"),v.style.width="100%",v.style.height="100%",v.style.display="block",v.style.background=h;const A=(d.elementos||[]).map((_,M)=>{var S,D,I;const k=_.barras!=null?_.barras:0;let L="N/A";if(_.diametro!=null&&_.diametro!==""){const G=String(_.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(G){const Y=parseFloat(G[0]);isFinite(Y)&&(L=String(Math.round(Y)))}}const P=[];(S=_.coladas)!=null&&S.colada1&&P.push(_.coladas.colada1),(D=_.coladas)!=null&&D.colada2&&P.push(_.coladas.colada2),(I=_.coladas)!=null&&I.colada3&&P.push(_.coladas.colada3);const C=P.length>0?` (${P.join(", ")})`:"";return{letter:indexToLetters(M),text:`√ò${L} x${k}${C}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(v,A,o,b):console.error("‚ùå drawLegendBottomLeft no est√° definida");const w=document.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("x",o/2),w.setAttribute("y",b/2),w.setAttribute("text-anchor","middle"),w.setAttribute("fill","#059669"),w.setAttribute("font-size","14"),w.setAttribute("font-weight","600"),w.textContent="‚úì Coladas actualizadas",v.appendChild(w),u.appendChild(v),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{w&&w.parentNode&&w.remove()},2e3)}catch(r){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,r),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function p(t,i,a,d=2e3){Swal.fire({icon:t,title:i,text:a,timer:d,showConfirmButton:!1})}function y(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=n}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pt):Pt();document.addEventListener("livewire:navigated",Pt);(function(q){let l=[],c=!1,s=null;async function n(u){var r;const e=`/etiquetas/${encodeURIComponent(u)}/validar-para-paquete`;try{const o=await fetch(e,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content}});if(!(o.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const E=await o.json();if(console.log("üîç validarEtiqueta response:",{status:o.status,data:E,peso_etiqueta:E.peso_etiqueta}),!o.ok)throw new Error((E==null?void 0:E.message)||(E==null?void 0:E.motivo)||"Error al validar");return E}catch(o){throw o}}function g(u,e){const r=e.id||u;if(l.some(E=>E.id===r))return!1;const o=parseFloat(e.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:u,id:r,peso_etiqueta_recibido:e.peso_etiqueta,peso_parseado:o,data_completa:e});const b={id:r,type:"etiqueta",peso:o,estado:e.estado||"desconocido",nombre:e.nombre||"Sin nombre"};return l.push(b),t(),!0}function m(u){const e=l.findIndex(r=>r.id===u);e>=0&&l.splice(e,1),t()}function x(){l=[],t()}function p(){return l.reduce((u,e)=>u+(parseFloat(e.peso)||0),0)}function y(){return l}function t(){const u=document.getElementById("itemsList");if(!u)return;u.innerHTML="";for(const o of l){const b=document.createElement("li");b.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",b.dataset.code=o.id,b.innerHTML=`
                <div>
                    <div class="font-semibold">${o.id} === ${o.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,b.querySelector("button").onclick=()=>m(o.id),u.appendChild(b)}const e=p(),r=document.createElement("li");r.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",r.textContent=`Total: ${e.toFixed(2)} kg (${l.length} etiquetas)`,u.appendChild(r)}async function i(){var E,h,v;if(!l.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const u=Number(((h=(E=document.getElementById("maquina-info"))==null?void 0:E.dataset)==null?void 0:h.maquinaId)||window.maquinaId),e=Number(((v=document.getElementById("ubicacion-id"))==null?void 0:v.value)||window.ubicacionId),r=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!u){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!r&&!e){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const o={items:l.map(A=>({id:A.id,type:A.type})),maquina_id:u,ubicacion_id:r?null:e,sin_ubicacion:r},b=async(A={})=>{var M;const w=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(M=document.querySelector('meta[name="csrf-token"]'))==null?void 0:M.content},body:JSON.stringify({...o,...A})}),_=await w.json();if(!w.ok)throw new Error(_.message||"Error al crear el paquete");return _};try{const A=await b();if(A.success)return a(A);if(A.warning){let w="<div style='text-align:left;'>Se detectaron advertencias:";for(const[M,k]of Object.entries(A.warning))Array.isArray(k)&&k.length&&(w+=`<br><strong>${M.replaceAll("_"," ")}:</strong> ${k.join(", ")}`);if(w+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:w,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const M=await b({confirmar:!0});if(M.success)return a(M);throw new Error(M.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(A){await Swal.fire("Error",A.message||"Error inesperado","error")}}async function a(u){var E;const e=u.codigo_paquete||((E=u.paquete)==null?void 0:E.codigo)||"N/D",r=p(),o=[...l.map(h=>h.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${e}</strong> creado correctamente</p>
                       <p>${o.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),x(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const h=document.getElementById("codigo_paquete_mover");h&&(h.value=e,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${e}</strong> creado correctamente</p><p>${o.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>`}),x()),console.log(`üì¶ Disparando evento paquete:creado para ${e}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:e,etiquetaIds:o,pesoTotal:r}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),o.forEach(h=>{d(h,e)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function d(u,e){const r=String(u).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${r}`);if(!o){console.warn(`‚ùå No se encontr√≥ elemento: ${u}`);return}console.log(`üîÑ Actualizando manualmente: ${u}`),Array.from(o.classList).forEach(w=>{w.startsWith("estado-")&&o.classList.remove(w)}),o.classList.add("estado-en-paquete"),o.dataset.estado="en-paquete",o.style.setProperty("--bg-estado","#e3e4FA");const E=o.querySelector('[id^="contenedor-svg-"]');if(E){const w=E.querySelector("svg");w&&(w.style.background="#e3e4FA")}const h=o.querySelector(".etiqueta-card")||o;h&&(h.style.background="#e3e4FA");const v=o.querySelector("h3");if(v&&!o.querySelector(".paquete-info")){const w=document.createElement("div");w.className="paquete-info text-sm font-semibold mt-2 no-print",w.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",w.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${e}</span>
            `,v.parentNode.insertBefore(w,v.nextSibling)}o.querySelectorAll(".btn-fabricar").forEach(w=>{w.disabled=!0,w.style.opacity="0.5",w.style.cursor="not-allowed"}),o.style.transition="transform 0.5s ease, background-color 0.5s ease",o.style.transform="scale(1.03)",setTimeout(()=>{o.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${u} actualizada manualmente`)}function f(){if(c)return;c=!0;const u=document.getElementById("qrItem");u&&(u.addEventListener("change",()=>u.dispatchEvent(new Event("input"))),u.addEventListener("input",async function(){const r=this.value.trim();if(r)try{const o=await n(r);if(!o.valida){await Swal.fire("Etiqueta no v√°lida",o.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}g(r,o)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(o){console.error("Error de validaci√≥n:",o),await Swal.fire("Error",o.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const e=document.getElementById("crearPaqueteBtn");e&&e.addEventListener("click",i),document.addEventListener("focus",function(r){r.target.id&&r.target.id.startsWith("input-etiqueta-")&&(s=r.target,console.log("üéØ Focus en input:",r.target.id))},!0),document.addEventListener("click",async function(r){var o;if(r.target.classList.contains("btn-agregar-carro")||r.target.closest(".btn-agregar-carro")){const E=(r.target.classList.contains("btn-agregar-carro")?r.target:r.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!E){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const h=document.querySelector(`[x-show="tabActivo === 'crear'"]`),v=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(h&&window.getComputedStyle(h).display,v&&window.getComputedStyle(v).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let w=document.activeElement;(!w||!((o=w.id)!=null&&o.startsWith("input-etiqueta-")))&&(w=s),(!w||!document.body.contains(w))&&(w=document.querySelector('input[id^="input-etiqueta-"]')),w?(w.value=E,w.focus(),w.classList.add("ring-4","ring-green-400"),setTimeout(()=>{w.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${E} a√±adida al input:`,w.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",E);try{const w=await n(E);if(!w.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:w.motivo||"Motivo no especificado"});return}g(E,w)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(w){console.error("Error al a√±adir al carro:",w),await Swal.fire({icon:"error",title:"Error",text:w.message||"No se pudo a√±adir al carro"})}}if(r.target.classList.contains("btn-agregar-carro-grupo")||r.target.closest(".btn-agregar-carro-grupo")){const b=r.target.classList.contains("btn-agregar-carro-grupo")?r.target:r.target.closest(".btn-agregar-carro-grupo"),E=b.dataset.grupoId;let h=[];try{h=JSON.parse(b.dataset.etiquetas||"[]")}catch(_){console.error("Error parseando etiquetas del grupo:",_);return}if(!h.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${h.length} etiquetas del grupo ${E} al carro`);let v=0,A=0,w=0;for(const _ of h)try{const M=await n(_.id);if(!M.valida){w++;continue}g(_.id,M)?v++:A++}catch{w++}v>0?await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${v}</strong> etiquetas al carro.</p>
                            ${A>0?`<p class="text-gray-500">${A} ya estaban en el carro.</p>`:""}
                            ${w>0?`<p class="text-red-500">${w} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1}):A>0?await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."}):await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",text:"Las etiquetas del grupo no son v√°lidas para a√±adir al carro."})}})}q.TrabajoPaquete={inicializar:f,agregarItemEtiqueta:g,eliminarItem:m,limpiarCarro:x,obtenerItems:y,calcularPesoTotal:p,crearPaquete:i,validarEtiqueta:n,actualizarListaVisual:t},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f(),document.addEventListener("livewire:navigated",f)})(window);function kt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(l,c){const s=document.getElementById("grid-maquina");if(!s)return;console.log("üîß Actualizando clases:",{showLeft:l,showRight:c,clasesAnteriores:s.className}),l||c?s.classList.add("columnas-laterales-visibles"):s.classList.remove("columnas-laterales-visibles"),l&&c?s.classList.add("ambas-columnas"):s.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",s.className),s.offsetHeight,s.querySelectorAll(".etiqueta-card").forEach(g=>{g.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)});function q(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((g,m)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),m.disconnect();const p=JSON.parse(localStorage.getItem("showLeft")??"true"),y=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(p,y)}}).observe(document.body,{childList:!0,subtree:!0});return}const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}q()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",kt):kt();document.addEventListener("livewire:navigated",kt);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const q={debounceTime:500};let l=0;async function c(i){var f;const a=Date.now();if(a-l<q.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};l=a;const d=(f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${i}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const e=await fetch(`/etiquetas/${encodeURIComponent(i)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),r=await e.json();return!e.ok||!r.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:r.message||"No se pudo revertir el cambio."}),{success:!1,message:r.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${r.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${r.estado}</strong>
                    </p>
                    ${r.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),m(i,r),r)}catch(u){return console.error("Error al deshacer etiqueta:",u),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:u.message}}}async function s(i){try{const a=await fetch(`/etiquetas/${encodeURIComponent(i)}/puede-deshacer`,{headers:{Accept:"application/json"}});return a.ok?await a.json():{puede_deshacer:!1}}catch(a){return console.error("Error al verificar undo:",a),{puede_deshacer:!1}}}async function n(i){try{const a=await fetch(`/etiquetas/${encodeURIComponent(i)}/historial`,{headers:{Accept:"application/json"}});return a.ok?await a.json():{success:!1,historial:[]}}catch(a){return console.error("Error al obtener historial:",a),{success:!1,historial:[]}}}async function g(i){var f;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const a=await n(i);if(!a.success||!((f=a.historial)!=null&&f.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=a.historial.map((u,e)=>`
            <tr class="${u.revertido?"bg-gray-100 text-gray-400":e===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${u.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${u.accion}</td>
                <td class="px-2 py-1 text-xs">${u.estado_anterior||"-"} ‚Üí ${u.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${u.revertido?'<span class="text-gray-400">Revertido</span>':e===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${i}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${a.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${a.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:a.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:a.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:a.puede_deshacer?"#f59e0b":"#6b7280"}).then(u=>{u.isConfirmed&&a.puede_deshacer&&c(i)})}function m(i,a){const d=i.replace(/\./g,"-"),f=document.getElementById(`etiqueta-${d}`);if(f){f.dataset.estado=a.estado,f.className=f.className.split(" ").filter(r=>!r.startsWith("estado-")).join(" ").trim(),f.classList.add(`estado-${a.estado}`);const u=f.querySelector('[id^="contenedor-svg-"]'),e=u==null?void 0:u.querySelector("svg");e&&(e.style.background=getComputedStyle(f).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(i,a.estado)}if(a.estado==="pendiente"){if(window.elementosAgrupadosScript){const r=window.elementosAgrupadosScript.find(o=>o.etiqueta&&String(o.etiqueta.etiqueta_sub_id)===String(i));r&&(r.colada_etiqueta=null,r.colada_etiqueta_2=null,r.elementos&&r.elementos.forEach(o=>{o.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:i}})))}const u=document.getElementById(`colada-${d}`);u&&(u.textContent="")}console.log(`‚úÖ DOM actualizado para ${i}: estado = ${a.estado}`)}function x(i,a){const d=i.replace(/\./g,"-"),f=document.querySelector(`#etiqueta-${d} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${i}, puede=${a}, btn encontrado=${!!f}`),f&&(f.disabled=!1,f.classList.remove("opacity-50","cursor-not-allowed"),f.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function p(){document.addEventListener("click",async i=>{const a=i.target.closest(".btn-deshacer");if(!a)return;i.preventDefault(),i.stopPropagation();const d=a.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await c(d)}),document.addEventListener("click",async i=>{const a=i.target.closest(".btn-historial");if(!a)return;i.preventDefault(),i.stopPropagation();const d=a.dataset.etiquetaId;d&&await g(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function y(){let i=null;window.addEventListener("etiqueta-fabricada",a=>{var d;(d=a.detail)!=null&&d.etiquetaSubId&&(i=a.detail.etiquetaSubId)}),document.addEventListener("keydown",async a=>{var d,f;if(a.ctrlKey&&a.key==="z"&&!a.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const u=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),e=((f=u==null?void 0:u.dataset)==null?void 0:f.etiquetaId)||i;e&&(a.preventDefault(),await c(e))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function t(){p(),y(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:c,puedeDeshacer:s,obtenerHistorial:n,mostrarHistorial:g,actualizarBoton:x},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t(),document.addEventListener("livewire:navigated",t)})();
