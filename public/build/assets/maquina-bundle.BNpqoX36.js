const jt="rgba(0, 0, 0, 0.8)",Lt="rgba(0, 0, 0, 1)",Rt="rgba(0, 0, 0, 1)";function Xt(y,a){return!a||a===1?y.map(s=>({...s})):y.map(s=>s.type==="line"?{...s,length:(s.length||0)*a}:s.type==="arc"?{...s,radius:(s.radius||0)*a}:{...s})}const Ht=.75,Bt=14,Vt=60,kt=[0,10,-10,20,-20,30,-30];function G(y){return y*Math.PI/180}function Yt(y){const a=y.closest(".proceso");return a&&getComputedStyle(a).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Ut(y,a,s){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.setAttribute("viewBox","0 0 "+y+" "+a),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.style.width="100%",o.style.height="100%",o.style.display="block",o.style.background=s||"#ffffff",o.style.shapeRendering="geometricPrecision",o.style.textRendering="optimizeLegibility",o.style.boxSizing="border-box",o}function Wt(y,a,s,o){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",a),n.setAttribute("stroke",s),n.setAttribute("fill","none"),n.setAttribute("stroke-width",o),n.setAttribute("vector-effect","non-scaling-stroke"),y.appendChild(n),n}function Ot(y){let a="",s=Number(y)||0;for(;s>=0;){const o=s%26;a=String.fromCharCode(65+o)+a,s=Math.floor(s/26)-1}return a}const Jt=0,Qt=-25;function Kt(y,a,s,o){if(!a||!a.length)return;const n=2,u=12,c=u+n,h=a.map(b=>(b.letter?b.letter+" ":"")+(b.text||"")),t=u*h.length+n*(h.length-1),i=Jt;let p=o-Qt-t+u/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let b=0;b<h.length;b++){const l=h[b],g=document.createElementNS("http://www.w3.org/2000/svg","text");g.setAttribute("x",i),g.setAttribute("y",p),g.setAttribute("fill",Rt),g.setAttribute("font-size",u),g.setAttribute("text-anchor","start"),g.setAttribute("alignment-baseline","middle"),g.style.pointerEvents="none",g.textContent=l,y.appendChild(g);const d=qt(l,u).w;window.__legendBoxesGroup.push({left:i,right:i+d,top:p-u/2,bottom:p+u/2}),p+=c}}function Zt(y){const a=(y||"").split(/\s+/).filter(Boolean),s=[];for(let o=0;o<a.length;o++){const n=a[o];if(n.endsWith("r")){const u=parseFloat(n.slice(0,-1));let c=360;o+1<a.length&&a[o+1].endsWith("d")&&(c=parseFloat(a[++o].slice(0,-1))),s.push({type:"arc",radius:u,arcAngle:c})}else n.endsWith("d")?s.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):s.push({type:"line",length:parseFloat(n)})}return s}function te(y){let a=[],s=0,o=0,n=0;a.push({x:s,y:o});for(let u=0;u<y.length;u++){const c=y[u];if(c.type==="line")s+=c.length*Math.cos(G(n)),o+=c.length*Math.sin(G(n)),a.push({x:s,y:o});else if(c.type==="turn")n+=c.angle;else if(c.type==="arc"){const h=s+c.radius*Math.cos(G(n+90)),t=o+c.radius*Math.sin(G(n+90)),i=Math.atan2(o-t,s-h),p=i+G(c.arcAngle);s=h+c.radius*Math.cos(p),o=t+c.radius*Math.sin(p),n+=c.arcAngle,a.push({x:s,y:o})}}return a}function Ft(y){let a=[],s=0,o=0,n=0;for(let u=0;u<y.length;u++){const c=y[u];if(c.type==="line"){const h={x:s,y:o},t={x:s+c.length*Math.cos(G(n)),y:o+c.length*Math.sin(G(n))};a.push({start:h,end:t,length:c.length}),s=t.x,o=t.y}else if(c.type==="turn")n+=c.angle;else if(c.type==="arc"){const h=s+c.radius*Math.cos(G(n+90)),t=o+c.radius*Math.sin(G(n+90)),i=Math.atan2(o-t,s-h),p=i+G(c.arcAngle);s=h+c.radius*Math.cos(p),o=t+c.radius*Math.sin(p),n+=c.arcAngle}}return a}function qt(y,a){const s=a||12;return{w:(y?y.length:0)*s*.55,h:s}}function ot(y,a,s){const o=s||0;return!(y.right+o<a.left||y.left-o>a.right||y.bottom+o<a.top||y.top-o>a.bottom)}function $t(y,a,s,o){const n=a/2;return Math.max(s+n,Math.min(o-n,y))}function ee(y,a){const o=[];let n=0;function u(){n>1e-9&&(o.push({type:"line",length:n}),n=0)}for(let c=0;c<y.length;c++){const h=y[c];if(h.type==="line"){n+=h.length;continue}if(h.type==="turn"){if(Math.abs(h.angle)<1e-9)continue;u(),o.push(h);continue}if(h.type==="arc"){u(),o.push(h);continue}u(),o.push(h)}return u(),o}function zt(y,a){const s=a&&a.decimals||0,o=a&&a.step||null;let n=Number(y||0);return o&&o>0&&(n=Math.round(n/o)*o),n.toFixed(s).replace(/\.0+$/,"")}function oe(y,a){const s=Math.hypot(y,a)||1;let o=y/s,n=a/s;return(n<-1e-9||Math.abs(n)<=1e-9&&o<0)&&(o=-o,n=-n),{ux:o,uy:n}}function Gt(y,a,s){const o=s||.01,n=oe(y,a),u=Math.round(n.ux/o)*o,c=Math.round(n.uy/o)*o;return u+"|"+c}function ne(y,a,s){const o=s&&s.dirPrecision||.01,n=s&&s.labelFormat||{decimals:0,step:null},u=y.reduce((g,d)=>g+Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y),0),c=a.reduce((g,d)=>g+(d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),0),h=c>0?u/c:1,t=new Map;for(let g=0;g<a.length;g++){const d=a[g],f=d.end.x-d.start.x,m=d.end.y-d.start.y,r=Gt(f,m,o),e=t.get(r)||[];e.push({length:d.length||Math.hypot(f,m),index:g}),t.set(r,e)}const i=a.map(g=>g.length||Math.hypot(g.end.x-g.start.x,g.end.y-g.start.y)),p=new Set,b=new Set,l=[];for(let g=0;g<y.length;g++){const d=y[g],f=d.end.x-d.start.x,m=d.end.y-d.start.y,r=Gt(f,m,o),e=t.get(r)||[],E=Math.hypot(f,m);let w=E;if(e.length){const v=E/h;let x=null,q=1/0;for(const B of e){const T=Math.abs(B.length-v),S=b.has(B.index)?.1:0;T+S<q&&(x=B,q=T+S)}x&&(w=x.length,b.add(x.index))}else g<i.length&&(w=i[g]);const A=zt(w,n),M=r+"|"+A;p.has(M)||(p.add(M),l.push({start:d.start,end:d.end,_dirKey:r,_label:A,_lenChosen:w}))}return l}function ae(y,a){const s=a,o=y.map(m=>Object.assign({},m));let n=0,u=0,c=0;const h=[];let t=null,i=-1,p=-1;const b=1e-7;function l(m){return m*Math.PI/180}function g(m){return Math.abs(Math.sin(l(m)))<1e-12}function d(m,r,e,E){return Math.min(r,E)-Math.max(m,e)>b}for(let m=0;m<o.length;m++){let e=function(){const v={x:Math.cos(l(c)),y:Math.sin(l(c))},x=n+o[m].length*v.x,q=u+o[m].length*v.y,B=g(c);for(let T=0;T<h.length;T++){const S=h[T];if(B&&S.horiz&&Math.abs(u-S.y)<b){if(d(Math.min(n,x),Math.max(n,x),Math.min(S.x1,S.x2),Math.max(S.x1,S.x2))&&t&&i>=0&&p>=0)return o[p].length+=s,n+=t.x*s,u+=t.y*s,h[i].x2+=t.x*s,h[i].y2+=t.y*s,!0}else if(!B&&!S.horiz&&Math.abs(n-S.x)<b&&d(Math.min(u,q),Math.max(u,q),Math.min(S.y1,S.y2),Math.max(S.y1,S.y2))&&t&&i>=0&&p>=0)return o[p].length+=s,n+=t.x*s,u+=t.y*s,h[i].x2+=t.x*s,h[i].y2+=t.y*s,!0}return!1};var f=e;const r=o[m];if(r.type==="turn"){c+=r.angle;continue}if(r.type==="arc"){const v=n+r.radius*Math.cos(l(c+90)),x=u+r.radius*Math.sin(l(c+90)),q=Math.atan2(u-x,n-v),B=q+l(r.arcAngle);n=v+r.radius*Math.cos(B),u=x+r.radius*Math.sin(B),c+=r.arcAngle,t=null;continue}for(;e(););const E={x:Math.cos(l(c)),y:Math.sin(l(c))},w=n+o[m].length*E.x,A=u+o[m].length*E.y,M=g(c);h.push({x1:n,y1:u,x2:w,y2:A,horiz:M,y:u,x:n}),t=E,i=h.length-1,p=m,n=w,u=A}return o}function Et(y,a,s,o){const n=G(o),u=Math.cos(n),c=Math.sin(n),h=y.x-a,t=y.y-s;return{x:a+h*u-t*c,y:s+h*c+t*u}}function se(y,a,s,o,n,u,c,h,t){let i="",p=0,b=0,l=0,g=!1;function d(m,r){const e=Et({x:m,y:r},a,s,o);return{x:h+(e.x-u)*n,y:t+(e.y-c)*n}}function f(){if(!g){const m=d(p,b);i+="M "+m.x+" "+m.y,g=!0}}for(let m=0;m<y.length;m++){const r=y[m];if(r.type==="turn"){l+=r.angle;continue}if(r.type==="line"){const e=p+r.length*Math.cos(G(l)),E=b+r.length*Math.sin(G(l));f();const w=d(e,E);i+=" L "+w.x+" "+w.y,p=e,b=E;continue}if(r.type==="arc"){const e=p+r.radius*Math.cos(G(l+90)),E=b+r.radius*Math.sin(G(l+90)),w=Math.atan2(b-E,p-e),A=w+G(r.arcAngle),M=e+r.radius*Math.cos(A),v=E+r.radius*Math.sin(A),x=Math.abs(r.arcAngle)%360;if(f(),x<1e-6||Math.abs(r.arcAngle)>=359.9){const K=w+Math.sign(r.arcAngle)*Math.PI,V=e+r.radius*Math.cos(K),O=E+r.radius*Math.sin(K),P=d(V,O),N=d(p,b),$=r.radius*n,I=r.arcAngle>=0?1:0;i+=" A "+$+" "+$+" 0 1 "+I+" "+P.x+" "+P.y,i+=" A "+$+" "+$+" 0 1 "+I+" "+N.x+" "+N.y,l+=r.arcAngle;continue}const q=d(M,v),B=r.radius*n,T=x>180?1:0,S=r.arcAngle>=0?1:0;i+=" A "+B+" "+B+" 0 "+T+" "+S+" "+q.x+" "+q.y,p=M,b=v,l+=r.arcAngle}}return i||"M 0 0"}function ie(y){const a=te(y);let s=Math.min(...a.map(f=>f.x)),o=Math.max(...a.map(f=>f.x)),n=Math.min(...a.map(f=>f.y)),u=Math.max(...a.map(f=>f.y));const c=(s+o)/2,h=(n+u)/2,i=u-n>o-s?-90:0,p=a.map(f=>Et(f,c,h,i));s=Math.min(...p.map(f=>f.x)),o=Math.max(...p.map(f=>f.x)),n=Math.min(...p.map(f=>f.y)),u=Math.max(...p.map(f=>f.y));const b=Math.max(1,o-s),l=Math.max(1,u-n),g=(s+o)/2,d=(n+u)/2;return{rotDeg:i,w:b,h:l,cxModel:c,cyModel:h,midX:g,midY:d,ptsRot:p}}function re(y){const a=[];let s=0,o=0,n=0;function u(c){const h=G(c);return{x:Math.cos(h),y:Math.sin(h)}}for(let c=0;c<y.length;c++){const h=y[c];if(h.type==="line")s+=h.length*Math.cos(G(n)),o+=h.length*Math.sin(G(n));else if(h.type==="turn"){const t=u(n),i=h.angle;n+=i;const p=u(n);a.push({x:s,y:o,angleDeg:i,prevDir:t,nextDir:p})}else if(h.type==="arc"){const t=s+h.radius*Math.cos(G(n+90)),i=o+h.radius*Math.sin(G(n+90)),p=Math.atan2(o-i,s-t),b=p+G(h.arcAngle);s=t+h.radius*Math.cos(b),o=i+h.radius*Math.sin(b),n+=h.arcAngle}}return a}function ce(y,a,s){const o=Array.from({length:a},()=>({sumH:0,maxW:0,items:[]})),n=[...y.keys()].sort((u,c)=>y[c].h-y[u].h);for(const u of n){let c=0,h=1/0;for(let i=0;i<a;i++){const p=o[i],b=p.sumH+(p.items.length>0?s:0)+y[u].h;b<h&&(h=b,c=i)}const t=o[c];t.sumH=t.items.length>0?t.sumH+s+y[u].h:t.sumH+y[u].h,t.maxW=Math.max(t.maxW,y[u].w),t.items.push(u)}return o}function le(y,a,s,o={}){const n=o.padding??12,u=o.gapCol??12,c=o.gapRow??10,h=Math.max(1,Math.min(y.length,o.kMax??4)),t=Math.max(10,a-2*n),i=Math.max(10,s-2*n),p=b(y);function b(e){const E=e.map($=>$.w/Math.max($.h,1)),w=e.map($=>$.h),A=e.map($=>$.w),M=e.map($=>$.w*$.h),v=$=>$.reduce((I,at)=>I+at,0)/$.length,x=($,I)=>$.reduce((at,L)=>at+Math.pow(L-I,2),0)/$.length,q=($,I)=>Math.sqrt(x($,I)),B=v(E),T=v(w),S=v(A),K=M.reduce(($,I)=>$+I,0),V=q(w,T),O=q(A,S),P=T>0?V/T:0,N=S>0?O/S:0;return{avgAspectRatio:B,avgHeight:T,avgWidth:S,totalArea:K,heightCV:P,widthCV:N,isLinear:B>6||T<S*.12,isUniformHeight:P<.15,isUniformWidth:N<.15,isHighlyVariable:P>.5||N>.5,count:e.length}}let l={S:0,k:1,cols:null,score:0};for(let e=1;e<=h;e++){const E=ce(y,e,c),w=E.reduce((L,Z)=>L+Z.maxW,0)+u*(e-1),A=Math.max(...E.map(L=>L.sumH));if(w<=0||A<=0)continue;const M=t/w,v=i/A,x=Math.min(M,v),q=Math.max(.01,x*.92),B=p.totalArea*q*q,T=t*i,S=B/T,K=E.map(L=>L.sumH*q),V=K.reduce((L,Z)=>L+Z,0)/e,O=Math.max(...K)-Math.min(...K),P=V>0?1-O/V:1,N=e===1?1.1:e===2?.9:.7,$=e>p.count*.5?.7:1,I=P>.85?1.05:1,at=q*(1+S*.25)*(1+P*.1)*N*$*I;at>l.score&&(l={S:q,k:e,cols:E,score:at,efficiency:S,colBalance:P})}const g=l.cols.map(e=>e.maxW*l.S),d=g.reduce((e,E)=>e+E,0);let f=[];if(l.k===1)f[0]=a/2;else{const e=(l.k-1)*u,E=d+e;if(E<t){const w=t-E,A=u+w/(l.k-1);let M=n;for(let v=0;v<l.k;v++)f[v]=M+g[v]/2,M+=g[v]+A}else{let w=n+Math.max(0,(t-E)/2);for(let A=0;A<l.k;A++)f[A]=w+g[A]/2,w+=g[A]+u}}const m=[],r=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(e=>e.right));for(let e=0;e<l.k;e++){const E=l.cols[e];m[e]=[];const w=E.items.map(O=>y[O].h*l.S),A=w.reduce((O,P)=>O+P,0);if(E.items.length===0)continue;const M=f[e],v=l.cols[e].maxW*l.S,x=M-v/2,q=M+v/2,B=r(),S=Math.max(0,Math.min(q,B)-x)/v,K=S>.05;let V=i;if(K&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const P=Math.min(...window.__legendBoxesGroup.map(N=>N.top))-15;V=Math.max(10,P-n),console.log(`üìè Columna ${e}: X=${x.toFixed(0)}-${q.toFixed(0)}, legendWidth=${B.toFixed(0)}, solape=${(S*100).toFixed(0)}%, altura reducida a ${V.toFixed(0)}px`)}else console.log(`üìè Columna ${e}: X=${x.toFixed(0)}-${q.toFixed(0)}, legendWidth=${B.toFixed(0)}, solape=${(S*100).toFixed(0)}%, altura completa ${V.toFixed(0)}px`);if(E.items.length===1){const O=w[0],P=n+V/2,N=Math.max(n+O/2,Math.min(P,s-n-O/2));m[e].push(N);continue}if(A>V){console.warn(`Columna ${e}: elementos no caben (${A}px > ${V}px)`);const N=A/E.items.length<4?20:5;let $=n;for(let I=0;I<E.items.length;I++){const at=Math.max(w[I],2),L=$+at/2;m[e].push(L),$+=at+N}}else{const O=V-A,P=E.items.length-1;let N=O/P;A/E.items.length<4?N=Math.max(18,Math.min(N,50)):N=Math.max(5,N);const at=A+P*N,L=V-at;let Z=n+Math.max(0,L/2);for(let lt=0;lt<E.items.length;lt++){const C=Math.max(w[lt],2),H=Z+C/2,k=n+V-C/2,_=Math.max(n+C/2,Math.min(H,k));m[e].push(_),Z+=C+N}}}return{S:l.S,k:l.k,cols:l.cols,centersX:f,centersYByCol:m,padding:n,gapRow:c,gapCol:u}}window.renderizarGrupoSVG=function(a,s){const o=a&&a.etiqueta&&a.etiqueta.id!=null?a.etiqueta.id:a&&a.id!=null?a.id:s,n=document.getElementById("contenedor-svg-"+o);if(!n)return;const u=600,c=150,h=Yt(n),t=Ut(u,c,h);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const i=(a.elementos||[]).map((d,f)=>{var w,A,M;const m=d.barras!=null?d.barras:0;let r="N/A";if(d.diametro!=null&&d.diametro!==""){const x=String(d.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(x){const q=parseFloat(x[0]);isFinite(q)&&(r=String(Math.round(q)))}}const e=[];(w=d.coladas)!=null&&w.colada1&&e.push(d.coladas.colada1),(A=d.coladas)!=null&&A.colada2&&e.push(d.coladas.colada2),(M=d.coladas)!=null&&M.colada3&&e.push(d.coladas.colada3);const E=e.length>0?` (${e.join(", ")})`:"";return{letter:Ot(f),text:`√ò${r} x${m}${E}`}});Kt(t,i,u,c);const p=a.elementos.map(d=>{const f=Zt(d.dimensiones||""),m=ee(f);let r=0;for(const M of m)M.type==="line"&&(r=Math.max(r,Math.abs(M.length||0))),M.type==="arc"&&(r=Math.max(r,Math.abs(M.radius||0)));const E=r<=50?2:1,w=Xt(m,E),A=ie(w);return{dimsRaw:f,dimsNoZero:m,dimsScaled:w,geomScale:E,medida:A}}),b=p.map(d=>d.medida),l=le(b,u,c,{padding:20,gapCol:50,gapRow:22,kMax:3}),g=new Map;for(let d=0;d<l.k;d++)l.cols[d].items.forEach((f,m)=>g.set(f,{c:d,j:m}));a.elementos.forEach(function(d,f){const{dimsNoZero:m,dimsScaled:r,medida:e}=p[f],E=g.get(f),w=l.centersX[E.c],A=l.centersYByCol[E.c][E.j],M=l.S,v=e.ptsRot.map(L=>({x:w+(L.x-e.midX)*M,y:A+(L.y-e.midY)*M})),x=Math.min(...v.map(L=>L.x)),q=Math.max(...v.map(L=>L.x)),B=Math.min(...v.map(L=>L.y)),T=Math.max(...v.map(L=>L.y)),S={left:x,right:q,top:B,bottom:T};window.__figBoxesGroup.push({...S});const K=ae(r,.6),V=se(K,e.cxModel,e.cyModel,e.rotDeg,M,e.midX,e.midY,w,A),O=Wt(t,V,jt,2);(function(){const Z=re(r);function lt(_){return Math.abs(Math.abs(_)-90)>=Ht}const C=(_,D)=>Et({x:_.x,y:_.y},0,0,D),H=(_,D)=>{const Y=Et({x:_,y:D},e.cxModel,e.cyModel,e.rotDeg);return{x:w+(Y.x-e.midX)*M,y:A+(Y.y-e.midY)*M}},k=_=>Math.max(10,Math.min(28,_));Z.forEach(_=>{if(!lt(_.angleDeg))return;const D=H(_.x,_.y),Y=C(_.prevDir,e.rotDeg),mt=C(_.nextDir,e.rotDeg),U=Math.atan2(Y.y,Y.x),R=U+G(_.angleDeg),W=Math.min(S.right-S.left,S.bottom-S.top);let F=k(.12*W);const gt=D.x+F*Math.cos(U),pt=D.y+F*Math.sin(U),X=D.x+F*Math.cos(R),ht=D.y+F*Math.sin(R),J=Math.abs(_.angleDeg),st=J>180?1:0,vt=_.angleDeg>=0?1:0,it=document.createElementNS("http://www.w3.org/2000/svg","path");it.setAttribute("d",`M ${gt} ${pt} A ${F} ${F} 0 ${st} ${vt} ${X} ${ht}`),it.setAttribute("stroke","rgba(255,99,71,0.7)"),it.setAttribute("stroke-width","2"),it.setAttribute("fill","none"),it.style.pointerEvents="none",t.appendChild(it);let z=Y.x+mt.x,j=Y.y+mt.y;J>180&&(z=-z,j=-j);let Q=Math.hypot(z,j);if(Q<1e-6){const ct=_.angleDeg>=0?1:-1;z=-Y.y*ct,j=Y.x*ct,Q=Math.hypot(z,j)||1}z/=Q,j/=Q;const tt=(Math.round(_.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",et=qt(tt,14);function At(ct,dt){return{left:ct-et.w/2,right:ct+et.w/2,top:dt-et.h/2,bottom:dt+et.h/2}}let nt=null;for(let ct=Bt;ct<=Vt&&!nt;ct+=4)for(let dt=0;dt<kt.length&&!nt;dt++){const wt=kt[dt],yt=C({x:z,y:j},wt),bt=D.x+yt.x*(F+ct),ut=D.y+yt.y*(F+ct),ft=At(bt,ut);ft.top<0||ft.bottom>c||ft.left<0||ft.right>u||window.__figBoxesGroup.some(xt=>ot(xt,ft,6))||(window.__dimBoxesGroup||[]).some(xt=>ot(xt,ft,2))||(window.__angleBoxesGroup||[]).some(xt=>ot(xt,ft,2))||(window.__placedLetterBoxes||[]).some(xt=>ot(xt,ft,2))||(window.__legendBoxesGroup||[]).some(xt=>ot(xt,ft,6))||(nt={x:bt,y:ut,box:ft})}if(!nt){const ct=D.x+z*(F+Bt),dt=D.y+j*(F+Bt),wt=At(ct,dt);nt={x:ct,y:dt,box:wt}}window.__angleBoxesGroup.push(nt.box);const rt=document.createElementNS("http://www.w3.org/2000/svg","text");rt.setAttribute("x",nt.x),rt.setAttribute("y",nt.y),rt.setAttribute("fill",Lt),rt.setAttribute("font-size",14),rt.setAttribute("text-anchor","middle"),rt.setAttribute("alignment-baseline","middle"),rt.style.cursor="pointer",rt.textContent=tt,t.appendChild(rt),rt.addEventListener("mouseenter",()=>{it.setAttribute("stroke","rgba(255,69,0,1)"),it.setAttribute("stroke-width","3"),it.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),rt.addEventListener("mouseleave",()=>{it.setAttribute("stroke","rgba(255,99,71,0.7)"),it.setAttribute("stroke-width","2"),it.style.filter="none"})})})();const P=O.cloneNode(!1);P.setAttribute("stroke-width","50"),P.setAttribute("stroke","transparent"),P.setAttribute("fill","none"),P.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(L=>{P.addEventListener(L,Z=>O.dispatchEvent(new Z.constructor(Z.type,Z)))}),t.insertBefore(P,O),(d.codigo!=null?d.codigo:d.id)+"",O.style.cursor="pointer",O.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),O.addEventListener("click",function(L){if(L.ctrlKey||L.metaKey||L.shiftKey){L.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(d.id);return}abrirModalDividirElemento(d.id,d.barras||0)}),O.addEventListener("contextmenu",function(L){L.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(d.id)});const N=[],$=Ft(K),I=Ft(m);ne($,I,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(L){const Z=Et(L.start,e.cxModel,e.cyModel,e.rotDeg),lt=Et(L.end,e.cxModel,e.cyModel,e.rotDeg),C={x:w+(Z.x-e.midX)*M,y:A+(Z.y-e.midY)*M},H={x:w+(lt.x-e.midX)*M,y:A+(lt.y-e.midY)*M},k=L._label,_=H.x-C.x,D=H.y-C.y,Y=Math.hypot(_,D)||1,mt=_/Y,U=D/Y,R=D/Y,W=-_/Y,F=(C.x+H.x)/2,gt=(C.y+H.y)/2,pt=F+R*10,X=gt+W*10,ht=qt(k,14),J=ht.w,st=ht.h;function vt(nt,rt){return{left:nt-J/2,right:nt+J/2,top:rt-st/2,bottom:rt+st/2}}const it=Y*.45;let z=pt,j=X;for(let nt=0;nt<=Math.ceil(it/6);nt++){const rt=nt%2===0?1:-1,ct=Math.ceil(nt/2),dt=rt*ct*6;if(Math.abs(dt)>it)continue;const wt=pt+mt*dt,yt=X+U*dt,bt=(wt-C.x)*mt+(yt-C.y)*U;if(bt<0+J*.3||bt>Y-J*.3)continue;const ut=vt(wt,yt);if(!(ot({left:Math.min(C.x,H.x),right:Math.max(C.x,H.x),top:Math.min(C.y,H.y),bottom:Math.max(C.y,H.y)},ut,0)||(window.__angleBoxesGroup||[]).some(Mt=>ot(Mt,ut,2))||(window.__legendBoxesGroup||[]).some(Mt=>ot(Mt,ut,6))||N.some(Mt=>ot(Mt,ut,2))||ut.top<0||ut.bottom>c||ut.left<0||ut.right>u)){z=wt,j=yt,N.push(ut),window.__dimBoxesGroup.push(ut);break}}const Q=document.createElementNS("http://www.w3.org/2000/svg","line");Q.setAttribute("x1",C.x),Q.setAttribute("y1",C.y),Q.setAttribute("x2",H.x),Q.setAttribute("y2",H.y),Q.setAttribute("stroke","rgba(0,0,255,0.6)"),Q.setAttribute("stroke-width","4"),Q.setAttribute("stroke-linecap","round"),Q.setAttribute("vector-effect","non-scaling-stroke"),Q.style.opacity=0,Q.style.pointerEvents="none",Q.style.transition="opacity 120ms ease",t.appendChild(Q);const tt=document.createElementNS("http://www.w3.org/2000/svg","text");tt.setAttribute("x",z),tt.setAttribute("y",j),tt.setAttribute("fill",Lt),tt.setAttribute("font-size",14),tt.setAttribute("text-anchor","middle"),tt.setAttribute("alignment-baseline","middle"),tt.setAttribute("tabindex","0"),tt.style.cursor="pointer",tt.textContent=k,t.appendChild(tt);function et(){Q.style.opacity=1}function At(){Q.style.opacity=0}tt.addEventListener("mouseenter",et),tt.addEventListener("mouseleave",At),tt.addEventListener("focus",et),tt.addEventListener("blur",At)}),function(){const Z=[];let lt=0,C=0,H=0;for(let k=0;k<r.length;k++){const _=r[k];if(_.type==="line")lt+=_.length*Math.cos(G(H)),C+=_.length*Math.sin(G(H));else if(_.type==="turn")H+=_.angle;else if(_.type==="arc"){const D=lt+_.radius*Math.cos(G(H+90)),Y=C+_.radius*Math.sin(G(H+90)),mt=Math.atan2(C-Y,lt-D),U=mt+G(_.arcAngle);let R=_.radius;for(let W=0;W<m.length;W++){const F=m[W];if(F.type==="arc"&&Math.abs(F.arcAngle-_.arcAngle)<.01){R=F.radius;break}}Z.push({center:{x:D,y:Y},radius:_.radius,originalRadius:R,arcAngle:_.arcAngle,startAngle:mt,endAngle:U}),lt=D+_.radius*Math.cos(U),C=Y+_.radius*Math.sin(U),H+=_.arcAngle}}Z.forEach(function(k){const _=Et(k.center,e.cxModel,e.cyModel,e.rotDeg),D={x:w+(_.x-e.midX)*M,y:A+(_.y-e.midY)*M},Y=(k.startAngle+k.endAngle)/2,mt=k.radius*M,U="R"+zt(k.originalRadius,{decimals:0,step:null}),R=qt(U,14),W=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let F=!1,gt,pt,X;for(let et=0;et<W.length&&!F;et++){const At=W[et],nt=Y+G(At),rt={x:k.center.x+k.radius*Math.cos(nt),y:k.center.y+k.radius*Math.sin(nt)},ct=Et(rt,e.cxModel,e.cyModel,e.rotDeg),dt={x:w+(ct.x-e.midX)*M,y:A+(ct.y-e.midY)*M},wt=dt.x-D.x,yt=dt.y-D.y,bt=Math.hypot(wt,yt)||1,ut=wt/bt,ft=yt/bt;for(let St=8;St<=60&&!F;St+=6){const Ct=mt*.7;if(gt=D.x+ut*Ct+ut*St,pt=D.y+ft*Ct+ft*St,X={left:gt-R.w/2,right:gt+R.w/2,top:pt-R.h/2,bottom:pt+R.h/2},!(X.top<0||X.bottom>c||X.left<0||X.right>u||window.__figBoxesGroup.some(_t=>ot(_t,X,2))||(window.__legendBoxesGroup||[]).some(_t=>ot(_t,X,2)))){F=!0;break}}}if(!F)return;N.push(X);const ht={x:gt-D.x,y:pt-D.y},J=Math.hypot(ht.x,ht.y)||1,st={x:ht.x/J,y:ht.y/J},vt=D.x+st.x*mt*.6,it=D.y+st.y*mt*.6,z=document.createElementNS("http://www.w3.org/2000/svg","line");z.setAttribute("x1",D.x),z.setAttribute("y1",D.y),z.setAttribute("x2",vt),z.setAttribute("y2",it),z.setAttribute("stroke","rgba(0,128,0,0.6)"),z.setAttribute("stroke-width","4"),z.setAttribute("stroke-linecap","round"),z.setAttribute("vector-effect","non-scaling-stroke"),z.style.opacity=0,z.style.pointerEvents="none",z.style.transition="opacity 120ms ease",t.appendChild(z);const j=document.createElementNS("http://www.w3.org/2000/svg","text");j.setAttribute("x",gt),j.setAttribute("y",pt),j.setAttribute("fill",Lt),j.setAttribute("font-size",14),j.setAttribute("text-anchor","middle"),j.setAttribute("alignment-baseline","middle"),j.setAttribute("tabindex","0"),j.style.cursor="pointer",j.textContent=U,t.appendChild(j);function Q(){z.style.opacity=1}function tt(){z.style.opacity=0}j.addEventListener("mouseenter",Q),j.addEventListener("mouseleave",tt),j.addEventListener("focus",Q),j.addEventListener("blur",tt)})}(),function(){const Z=Ot(f),lt=14,C=qt(Z,lt);function H(R,W){return{left:R,right:R+C.w,top:W-C.h/2,bottom:W+C.h/2}}let k=null;const _=(S.top+S.bottom)/2,D=Math.max(C.h/2,Math.min(_,c-C.h/2));function Y(R){for(let F=0;F<=30;F+=4){const gt=F%2===0?1:-1,pt=Math.ceil(F/2),X=gt*pt*4,ht=Math.max(C.h/2,Math.min(c-C.h/2,D+X)),J=R,st=H(J,ht);if(!(window.__figBoxesGroup.some(et=>ot(et,st,6))||(window.__dimBoxesGroup||[]).some(et=>ot(et,st,3))||(window.__angleBoxesGroup||[]).some(et=>ot(et,st,3))||(window.__legendBoxesGroup||[]).some(et=>ot(et,st,6))||(window.__placedLetterBoxes||[]).some(et=>ot(et,st,2))||st.top<0||st.bottom>c||st.left<0||st.right>u))return k={x:J,y:ht,box:st},!0}return!1}const mt=[{x:S.right+10,priority:1},{x:S.left-10-C.w,priority:1},{x:S.right+15,priority:2},{x:S.left-15-C.w,priority:2},{x:S.right+5,priority:2},{x:S.left-5-C.w,priority:2},{x:S.right+20,priority:3},{x:S.left-20-C.w,priority:3},{x:S.right+25,priority:3},{x:S.left-25-C.w,priority:3},{x:S.right+30,priority:3},{x:S.left-30-C.w,priority:3}];mt.sort((R,W)=>R.priority-W.priority);for(const R of mt){if(k)break;const W=$t(R.x,C.w,0,u);if(Y(W))break}if(!k){const R=(S.left+S.right)/2,W=[{x:R-C.w/2,y:S.top-C.h-5},{x:R-C.w/2,y:S.bottom+C.h+5}];for(const F of W){if(k)break;const gt=$t(F.x,C.w,0,u),pt=Math.max(C.h/2,Math.min(c-C.h/2,F.y)),X=H(gt,pt);!window.__figBoxesGroup.some(J=>ot(J,X,6))&&!(window.__dimBoxesGroup||[]).some(J=>ot(J,X,3))&&!(window.__angleBoxesGroup||[]).some(J=>ot(J,X,3))&&!(window.__legendBoxesGroup||[]).some(J=>ot(J,X,6))&&!(window.__placedLetterBoxes||[]).some(J=>ot(J,X,2))&&X.top>=0&&X.bottom<=c&&X.left>=0&&X.right<=u&&(k={x:gt,y:pt,box:X})}}if(!k){const R=$t(u-C.w,C.w,0,u),W=D;k={x:R,y:W,box:H(R,W)}}window.__placedLetterBoxes.push(k.box);const U=document.createElementNS("http://www.w3.org/2000/svg","text");U.setAttribute("x",k.x),U.setAttribute("y",k.y),U.setAttribute("fill",Rt),U.setAttribute("font-size",lt),U.setAttribute("text-anchor","start"),U.setAttribute("alignment-baseline","middle"),U.style.fontWeight="600",U.style.pointerEvents="none",U.textContent=Z,t.appendChild(U)}()}),n.innerHTML="",n.appendChild(t)};function It(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const y=window.elementosAgrupadosScript;if(!y)return;const a=document.getElementById("grid-maquina");if(a&&window.updateGridClasses){const s=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,o),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}y.forEach(function(s,o){renderizarGrupoSVG(s,o)}),requestAnimationFrame(()=>{a&&(a.style.opacity="1",a.style.visibility="visible",a.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",a.className)),document.querySelectorAll(".proceso").forEach(s=>{s.style.opacity="1"})}),window.actualizarSVGConColadas=function(s,o){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,u=n.findIndex(h=>h.etiqueta&&String(h.etiqueta.etiqueta_sub_id)===String(s));if(u===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${s}`);return}const c=n[u];c.elementos&&o&&c.elementos.forEach(h=>{const t=String(h.id),i=o[t];h.coladas||(h.coladas={colada1:null,colada2:null,colada3:null}),i&&Array.isArray(i)&&(h.coladas.colada1=i[0]||null,h.coladas.colada2=i[1]||null,h.coladas.colada3=i[2]||null)}),renderizarGrupoSVG(c,u),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${s}`,o)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It();document.addEventListener("livewire:navigated",It);window.abrirModalDividirElemento=function(a,s){const o=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),u=document.getElementById("dividir_barras_totales"),c=document.getElementById("labelBarrasActuales"),h=document.getElementById("barras_a_mover"),t=document.getElementById("previewDivision"),i=document.getElementById("formDividirElemento");if(!o||!n||!i)return;n.value=a;let p=parseInt(s)||0;if(p===0&&window.elementosAgrupadosScript){for(const b of window.elementosAgrupadosScript)if(b.elementos){const l=b.elementos.find(g=>String(g.id)===String(a));if(l&&l.barras){p=parseInt(l.barras)||0;break}}}u&&(u.value=p),c&&(c.textContent=p>0?p:"-"),h&&(h.value=""),t&&t.classList.add("hidden"),window.rutaDividirElemento&&i.setAttribute("action",window.rutaDividirElemento),o.classList.remove("hidden")};window.enviarDivision=async function(){const a=document.getElementById("formDividirElemento"),s=a.getAttribute("action")||window.rutaDividirElemento,o=new FormData(a);try{const n=document.querySelector('meta[name="csrf-token"]'),u=o.get("_token")||(n?n.getAttribute("content"):null),h=await fetch(s,{method:"POST",headers:u?{"X-CSRF-TOKEN":u}:{},body:o}),t=await h.json();if(!h.ok||!t.success)throw new Error(t.message||"Error al dividir");a.reset();const i=document.getElementById("modalDividirElemento");i&&i.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",t.message,"success"):alert(t.message)}catch(n){window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(y){const a={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},s={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function o(t,i,p={}){console.log(`üîÑ Actualizando etiqueta ${t} a estado: ${i}`);const b=String(t).replace(/\./g,"-"),l=document.querySelector(`#etiqueta-${b}`);if(!l)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${t}`),!1;const g=String(i).toLowerCase().trim(),d=s[g];if(!d)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${i}`),!1;l.dataset.estado=g,Array.from(l.classList).forEach(e=>{e.startsWith("estado-")&&l.classList.remove(e)}),l.classList.add(d.cssClass),l.style.setProperty("--bg-estado",d.bgColor);const m=l.querySelector('[id^="contenedor-svg-"]');if(m){const e=m.querySelector("svg");e&&(e.style.background=d.bgColor)}const r=l.querySelector(".etiqueta-card")||l;return r&&(r.style.background=d.bgColor),n(l,g),u(l),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:t,estado:g,datosExtra:p}})),console.log(`‚úÖ Etiqueta ${t} actualizada a ${i}`),!0}function n(t,i){const p=t.querySelectorAll(".btn-fabricar"),b=["empaquetada","en-paquete"];p.forEach(l=>{b.includes(i)?(l.disabled=!0,l.style.opacity="0.5",l.style.cursor="not-allowed",l.title=`Etiqueta ya ${i}`):(l.disabled=!1,l.style.opacity="1",l.style.cursor="pointer",l.title="Fabricar esta etiqueta")})}function u(t){t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400)}function c(t,i,p={}){console.log(`üîÑ Actualizando ${t.length} etiquetas...`);const l=t.map(g=>o(g,i,p)).filter(g=>g).length;return console.log(`‚úÖ ${l}/${t.length} etiquetas actualizadas`),l}function h(t){const i=String(t).replace(/\./g,"-"),p=document.querySelector(`#etiqueta-${i}`);return p?{id:t,estado:p.dataset.estado||"desconocido",elemento:p}:null}window.addEventListener("paquete:creado",t=>{const{codigoPaquete:i,etiquetaIds:p}=t.detail;console.log(`üì¶ Evento paquete:creado recibido - ${i} con ${p.length} etiquetas`),c(p,"empaquetada",{codigo_paquete:i})}),y.SistemaDOM={actualizarEstadoEtiqueta:o,actualizarMultiplesEtiquetas:c,obtenerEstadoActual:h,ESTADOS_CONFIG:s},y.ColoresEstado={actualizar:(t,i)=>{a[t]=i;const p=document.getElementById("colores-estado-css");if(p){let b=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[l,g]of Object.entries(a))b+=`.proceso.estado-${l} {
    --bg-estado: ${g};
}
`;p.textContent=b,console.log(`‚úÖ Color actualizado para estado "${t}": ${i}`)}},obtenerColor:t=>a[t],todos:()=>({...a})}})(window);function Tt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async t=>{var m,r,e;const i=t.target.closest(".btn-fabricar");if(!i)return;t.preventDefault();const p=(r=(m=document.getElementById("maquina-info"))==null?void 0:m.dataset)==null?void 0:r.maquinaId;if(!p){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const b=String(i.dataset.etiquetaId||"").trim(),l=b.replace(/\./g,"-"),g=document.querySelector(`#etiqueta-${l}`);if(g){const E=(g.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(E)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${b} ya est√° en estado ${E}.`,timer:2500,showConfirmButton:!1});return}}const d=Number(((e=window.DIAMETRO_POR_ETIQUETA)==null?void 0:e[b])??0);if(!b){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!d&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const f=i.disabled;i.disabled=!0;try{await y(b,p,d)}finally{i.disabled=f}});async function y(t,i,p=null){var w,A,M,v;const b=`/actualizar-etiqueta/${t}/maquina/${i}`,l=(w=document.querySelector('meta[name="csrf-token"]'))==null?void 0:w.getAttribute("content"),g=t.replace(/\./g,"-"),f=(((M=(A=document.querySelector(`#etiqueta-${g}`))==null?void 0:A.dataset)==null?void 0:M.estado)||"").toLowerCase()==="fabricando",m=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",r=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",e=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(m&&r||e){if(f&&((v=window._decisionCortePorEtiqueta)!=null&&v[t])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:s});return}for(;;){let x;try{x=await Cortes.mejorCorteSimple(t,p,l)}catch(q){h(q);return}if(!x)return;if(x.accion==="optimizar"){let q;try{q=await Cortes.mejorCorteOptimizado(t,p,x.patrones,l)}catch(B){h(B);return}if((q==null?void 0:q.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q.longitudBarraCm,etiquetas:q.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:s});return}else{if(q==="volver")continue;return}}if(x.accion==="fabricar_patron_simple"){const q=Math.round(Number(x.longitud_m||0)*100);if(!q){h("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:q,etiquetas:[{etiqueta_sub_id:t,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:s});return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await a(t,i,l)}catch(x){h(x)}return}try{const x=await fetch(b,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({})}),q=await x.json();if(!x.ok)throw new Error(q.message||"Error al actualizar");s(t,q)}catch(x){h(x)}}async function a(t,i,p){var V,O,P,N,$;const b=Number(((V=window.DIAMETRO_POR_ETIQUETA)==null?void 0:V[t])??0),g=Number(((O=window.LONGITUD_POR_ETIQUETA)==null?void 0:O[t])??0)/100;let d="";try{const I=await fetch(`/api/productos/sugerencias?diametro=${b}&longitud=${g}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":p}});if(I.ok){const at=await I.json();at.productos&&at.productos.length>0?d=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${b}mm x ${g.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${at.productos.map(L=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${L.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${L.codigo}</td>
                                                <td class="px-2 py-1">${L.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${L.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${L.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:d=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${b}mm x ${g.toFixed(1)}m</p>`}}catch(I){console.warn("No se pudieron cargar sugerencias:",I)}const{value:f,isConfirmed:m}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${d}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const I=document.getElementById("swal-input-producto").value;return!I||!I.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):I.trim()}});if(!m||!f)return;let r;try{const I=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(f.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":p}});if(!I.ok){const at=await I.json();throw new Error(at.message||"Producto no encontrado")}r=await I.json()}catch(I){await Swal.fire({icon:"error",title:"Producto no encontrado",text:I.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${f}`});return}const e=(r.tipo||"").toLowerCase(),E=Number(r.diametro??0),w=Number(r.longitud??0);if(e&&e!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${r.codigo}</p>
                        <p><strong>Tipo:</strong> ${r.tipo||"N/A"}</p>
                    </div>
                `});return}if(E>0&&b>0&&Math.abs(E-b)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${E} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${b} mm</p>
                    </div>
                `});return}if(w>0&&g>0&&Math.abs(w-g)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${w.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${g.toFixed(2)} m</p>
                    </div>
                `});return}const A=r.longitud?`${r.longitud} m`:"N/A",{value:M,isConfirmed:v}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${r.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${r.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${A}</p>
                    <p><strong>Stock actual:</strong> ${((P=r.peso_stock)==null?void 0:P.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${r.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!v)return;const x=M==="completo",q=`/actualizar-etiqueta/${t}/maquina/${i}`,B=await fetch(q,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":p},body:JSON.stringify({producto_id:r.id,paquete_completo:x})}),T=await B.json();if(!B.ok)throw new Error(T.message||"Error al fabricar");const S=((N=T.metricas)==null?void 0:N.peso_consumido)||0,K=(($=T.metricas)==null?void 0:$.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${r.codigo}</p>
                <p><strong>Peso consumido:</strong> ${S.toFixed(2)} kg</p>
                ${K?`<p><strong>Paquete:</strong> ${K}</p>`:""}
                ${x?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),s(t,T),K&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const I=document.getElementById("codigo_paquete_mover");I&&(I.value=K,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function s(t,i){var b,l;const p=t.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:i.estado,peso_etiqueta:i.peso_etiqueta,nombre:i.nombre,data_completa:i}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,i.estado,{peso:i.peso_etiqueta,nombre:i.nombre||t}):o(t,i.estado),i.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,i.coladas_por_elemento),(i.estado||"").toLowerCase()){case"cortando":c("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":c("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),n(p);break;case"fabricando":c("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":c("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),n(p),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"fabricada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),u(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":c("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(b=window._decisionCortePorEtiqueta)!=null&&b[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),n(p),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:i.peso_etiqueta||0,estado:"completada",nombre:i.nombre||t}),i.elementos&&Array.isArray(i.elementos)&&i.elementos.length>0?i.elementos.some(d=>d.coladas&&(d.coladas.colada1||d.coladas.colada2||d.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,i.elementos),u(t,i.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":c("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":c("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),n(p);break;case"soldando":c("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":c("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),n(p);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${i.estado}`),c("warning","Estado desconocido",`El estado recibido (${i.estado}) no est√° reconocido.`,3e3)}(l=i.productos_afectados)!=null&&l.length&&i.productos_afectados.forEach(g=>{const d=document.getElementById(`peso-stock-${g.id}`),f=document.getElementById(`progreso-texto-${g.id}`),m=document.getElementById(`progreso-barra-${g.id}`);d&&(d.textContent=`${g.peso_stock} kg`),f&&(f.textContent=`${g.peso_stock} / ${g.peso_inicial} kg`),m&&(m.style.height=`${g.peso_stock/g.peso_inicial*100}%`)})}function o(t,i){const p=t.replace(/\./g,"-"),b=document.getElementById("etiqueta-"+p);if(!b)return;b.dataset.estado=String(i||"").toLowerCase(),b.className=b.className.split(" ").filter(d=>!d.startsWith("estado-")).join(" ").trim(),b.classList.add("estado-"+b.dataset.estado);const l=b.querySelector('[id^="contenedor-svg-"]'),g=l==null?void 0:l.querySelector("svg");g&&(g.style.background=getComputedStyle(b).getPropertyValue("--bg-estado").trim())}function n(t){const i=`#etiqueta-${CSS.escape(t)}`,p=document.querySelector(i),b=Array.from(document.querySelectorAll(".proceso")),l=E=>(E||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),g=E=>{var M;const w=(M=E.dataset)==null?void 0:M.estado;if(w)return l(w);const A=E.querySelector('[id^="estado-"]');return l((A==null?void 0:A.textContent)||(A==null?void 0:A.innerText)||"")},d=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),f=E=>d.has(g(E)),m=p?b.indexOf(p):-1,e=(m>=0?b.slice(m+1):b).find(E=>!f(E));e?e.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function u(t,i){var d;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!i||!Array.isArray(i)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(i.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const p=window.elementosAgrupadosScript.findIndex(f=>{var m;return((m=f.etiqueta)==null?void 0:m.etiqueta_sub_id)===t});if(p===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[p].elementos=i;const b=window.elementosAgrupadosScript[p],l=(d=b.etiqueta)==null?void 0:d.id;if(!l){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const g=document.getElementById("contenedor-svg-"+l);if(!g){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${l})`);return}try{const f=g.querySelector("svg");f&&f.remove();const m=600,r=150,e=g.closest(".proceso"),E=e&&getComputedStyle(e).getPropertyValue("--bg-estado").trim()||"#e5e7eb",w=document.createElementNS("http://www.w3.org/2000/svg","svg");w.setAttribute("viewBox",`0 0 ${m} ${r}`),w.setAttribute("preserveAspectRatio","xMidYMid meet"),w.style.width="100%",w.style.height="100%",w.style.display="block",w.style.background=E;const A=(b.elementos||[]).map((v,x)=>{var K,V,O;const q=v.barras!=null?v.barras:0;let B="N/A";if(v.diametro!=null&&v.diametro!==""){const N=String(v.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(N){const $=parseFloat(N[0]);isFinite($)&&(B=String(Math.round($)))}}const T=[];(K=v.coladas)!=null&&K.colada1&&T.push(v.coladas.colada1),(V=v.coladas)!=null&&V.colada2&&T.push(v.coladas.colada2),(O=v.coladas)!=null&&O.colada3&&T.push(v.coladas.colada3);const S=T.length>0?` (${T.join(", ")})`:"";return{letter:indexToLetters(x),text:`√ò${B} x${q}${S}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(w,A,m,r):console.error("‚ùå drawLegendBottomLeft no est√° definida");const M=document.createElementNS("http://www.w3.org/2000/svg","text");M.setAttribute("x",m/2),M.setAttribute("y",r/2),M.setAttribute("text-anchor","middle"),M.setAttribute("fill","#059669"),M.setAttribute("font-size","14"),M.setAttribute("font-weight","600"),M.textContent="‚úì Coladas actualizadas",w.appendChild(M),g.appendChild(w),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{M&&M.parentNode&&M.remove()},2e3)}catch(f){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,f),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function c(t,i,p,b=2e3){Swal.fire({icon:t,title:i,text:p,timer:b,showConfirmButton:!1})}function h(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=s}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Tt):Tt();document.addEventListener("livewire:navigated",Tt);(function(y){let a=[],s=!1,o=null;async function n(f){var r;const m=`/etiquetas/${encodeURIComponent(f)}/validar-para-paquete`;try{const e=await fetch(m,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content}});if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const w=await e.json();if(console.log("üîç validarEtiqueta response:",{status:e.status,data:w,peso_etiqueta:w.peso_etiqueta}),!e.ok)throw new Error((w==null?void 0:w.message)||(w==null?void 0:w.motivo)||"Error al validar");return w}catch(e){throw e}}function u(f,m){const r=m.id||f;if(a.some(w=>w.id===r))return!1;const e=parseFloat(m.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:f,id:r,peso_etiqueta_recibido:m.peso_etiqueta,peso_parseado:e,data_completa:m});const E={id:r,type:"etiqueta",peso:e,estado:m.estado||"desconocido",nombre:m.nombre||"Sin nombre"};return a.push(E),p(),!0}function c(f){const m=a.findIndex(r=>r.id===f);m>=0&&a.splice(m,1),p()}function h(){a=[],p()}function t(){return a.reduce((f,m)=>f+(parseFloat(m.peso)||0),0)}function i(){return a}function p(){const f=document.getElementById("itemsList");if(!f)return;f.innerHTML="";for(const e of a){const E=document.createElement("li");E.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",E.dataset.code=e.id,E.innerHTML=`
                <div>
                    <div class="font-semibold">${e.id} === ${e.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,E.querySelector("button").onclick=()=>c(e.id),f.appendChild(E)}const m=t(),r=document.createElement("li");r.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",r.textContent=`Total: ${m.toFixed(2)} kg (${a.length} etiquetas)`,f.appendChild(r)}async function b(){var w,A,M;if(!a.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const f=Number(((A=(w=document.getElementById("maquina-info"))==null?void 0:w.dataset)==null?void 0:A.maquinaId)||window.maquinaId),m=Number(((M=document.getElementById("ubicacion-id"))==null?void 0:M.value)||window.ubicacionId),r=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!f){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!r&&!m){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const e={items:a.map(v=>({id:v.id,type:v.type})),maquina_id:f,ubicacion_id:r?null:m,sin_ubicacion:r},E=async(v={})=>{var B;const x=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(B=document.querySelector('meta[name="csrf-token"]'))==null?void 0:B.content},body:JSON.stringify({...e,...v})}),q=await x.json();if(!x.ok)throw new Error(q.message||"Error al crear el paquete");return q};try{const v=await E();if(v.success)return l(v);if(v.warning){let x="<div style='text-align:left;'>Se detectaron advertencias:";for(const[B,T]of Object.entries(v.warning))Array.isArray(T)&&T.length&&(x+=`<br><strong>${B.replaceAll("_"," ")}:</strong> ${T.join(", ")}`);if(x+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:x,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const B=await E({confirmar:!0});if(B.success)return l(B);throw new Error(B.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(v){await Swal.fire("Error",v.message||"Error inesperado","error")}}async function l(f){var w;const m=f.codigo_paquete||((w=f.paquete)==null?void 0:w.codigo)||"N/D",r=t(),e=[...a.map(A=>A.id)];(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${m}</strong> creado correctamente</p>
                       <p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),h(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const A=document.getElementById("codigo_paquete_mover");A&&(A.value=m,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${m}</strong> creado correctamente</p><p>${e.length} etiquetas ¬∑ ${r.toFixed(2)} kg</p>`}),h()),console.log(`üì¶ Disparando evento paquete:creado para ${m}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:m,etiquetaIds:e,pesoTotal:r}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),e.forEach(A=>{g(A,m)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function g(f,m){const r=String(f).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${r}`);if(!e){console.warn(`‚ùå No se encontr√≥ elemento: ${f}`);return}console.log(`üîÑ Actualizando manualmente: ${f}`),Array.from(e.classList).forEach(x=>{x.startsWith("estado-")&&e.classList.remove(x)}),e.classList.add("estado-en-paquete"),e.dataset.estado="en-paquete",e.style.setProperty("--bg-estado","#e3e4FA");const w=e.querySelector('[id^="contenedor-svg-"]');if(w){const x=w.querySelector("svg");x&&(x.style.background="#e3e4FA")}const A=e.querySelector(".etiqueta-card")||e;A&&(A.style.background="#e3e4FA");const M=e.querySelector("h3");if(M&&!e.querySelector(".paquete-info")){const x=document.createElement("div");x.className="paquete-info text-sm font-semibold mt-2 no-print",x.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",x.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${m}</span>
            `,M.parentNode.insertBefore(x,M.nextSibling)}e.querySelectorAll(".btn-fabricar").forEach(x=>{x.disabled=!0,x.style.opacity="0.5",x.style.cursor="not-allowed"}),e.style.transition="transform 0.5s ease, background-color 0.5s ease",e.style.transform="scale(1.03)",setTimeout(()=>{e.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${f} actualizada manualmente`)}function d(){if(s)return;s=!0;const f=document.getElementById("qrItem");f&&(f.addEventListener("change",()=>f.dispatchEvent(new Event("input"))),f.addEventListener("input",async function(){const r=this.value.trim();if(r)try{const e=await n(r);if(!e.valida){await Swal.fire("Etiqueta no v√°lida",e.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}u(r,e)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(e){console.error("Error de validaci√≥n:",e),await Swal.fire("Error",e.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const m=document.getElementById("crearPaqueteBtn");m&&m.addEventListener("click",b),document.addEventListener("focus",function(r){r.target.id&&r.target.id.startsWith("input-etiqueta-")&&(o=r.target,console.log("üéØ Focus en input:",r.target.id))},!0),document.addEventListener("click",async function(r){var e;if(r.target.classList.contains("btn-agregar-carro")||r.target.closest(".btn-agregar-carro")){const w=(r.target.classList.contains("btn-agregar-carro")?r.target:r.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!w){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const A=document.querySelector(`[x-show="tabActivo === 'crear'"]`),M=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(A&&window.getComputedStyle(A).display,M&&window.getComputedStyle(M).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let x=document.activeElement;(!x||!((e=x.id)!=null&&e.startsWith("input-etiqueta-")))&&(x=o),(!x||!document.body.contains(x))&&(x=document.querySelector('input[id^="input-etiqueta-"]')),x?(x.value=w,x.focus(),x.classList.add("ring-4","ring-green-400"),setTimeout(()=>{x.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${w} a√±adida al input:`,x.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",w);try{const x=await n(w);if(!x.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:x.motivo||"Motivo no especificado"});return}u(w,x)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(x){console.error("Error al a√±adir al carro:",x),await Swal.fire({icon:"error",title:"Error",text:x.message||"No se pudo a√±adir al carro"})}}})}y.TrabajoPaquete={inicializar:d,agregarItemEtiqueta:u,eliminarItem:c,limpiarCarro:h,obtenerItems:i,calcularPesoTotal:t,crearPaquete:b,validarEtiqueta:n,actualizarListaVisual:p},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d(),document.addEventListener("livewire:navigated",d)})(window);function Dt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(a,s){const o=document.getElementById("grid-maquina");if(!o)return;console.log("üîß Actualizando clases:",{showLeft:a,showRight:s,clasesAnteriores:o.className}),a||s?o.classList.add("columnas-laterales-visibles"):o.classList.remove("columnas-laterales-visibles"),a&&s?o.classList.add("ambas-columnas"):o.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",o.className),o.offsetHeight,o.querySelectorAll(".etiqueta-card").forEach(u=>{u.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const a=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,s)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const a=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,s)});function y(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((u,c)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),c.disconnect();const t=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(t,i)}}).observe(document.body,{childList:!0,subtree:!0});return}const s=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(s,o),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}y()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);
