function l(){window.actualizarEstado=function(a){Swal.fire({title:"¬øEst√°s seguro?",text:"¬øQuieres marcar esta salida como completada?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"S√≠, marcar como completada",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&fetch(`/salidas/${a}/actualizar-estado`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({estado:"completada"})}).then(t=>t.json()).then(t=>{t.success?(Swal.fire("Completada","La salida ha sido marcada como completada.","success"),location.reload()):Swal.fire("Completada",t.message,"success")}).catch(t=>{Swal.fire("Error","Hubo un error al realizar la solicitud.","error")})})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l();document.addEventListener("livewire:navigated",l);function f(){const a=document.getElementById("contenido-resumen-planillas"),e=document.getElementById("icono-toggle-planillas");!a||!e||(a.classList.contains("hidden")?(a.classList.remove("hidden"),e.classList.add("rotate-90")):(a.classList.add("hidden"),e.classList.remove("rotate-90")))}window.toggleResumenPlanillas=f;function g(){const a=document.getElementById("btn-crear-salidas-rapido");a&&a.addEventListener("click",w);const e=document.getElementById("btn-guardar-asignaciones");e&&e.addEventListener("click",y),document.querySelector(".paquete-item")&&p(),document.querySelector(".drop-zone")&&r()}async function w(){const a=parseInt(document.getElementById("num-salidas").value);if(a<1||a>10){Swal.fire("‚ö†Ô∏è","El n√∫mero de salidas debe estar entre 1 y 10","warning");return}const e=window.AppGestionSalidas.fechaEstimadaEntrega,t=[];for(let o=0;o<a;o++)t.push({fecha_salida:e,empresa_transporte_id:null,camion_id:null,codigo_sage:null});try{Swal.fire({title:"Creando salidas...",text:`Creando ${a} salida(s) con fecha ${e}`,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const n=await(await fetch(window.AppGestionSalidas.routes.crearSalidasVacias,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf},body:JSON.stringify({salidas:t,planillas_ids:window.AppGestionSalidas.planillasIds})})).json();n.success?(await Swal.fire({icon:"success",title:"Salidas Creadas",text:`Se han creado ${n.salidas_creadas} salida(s) correctamente`,timer:2e3}),window.location.href=window.AppGestionSalidas.routes.recargarVista):Swal.fire("‚ùå",n.message||"Error al crear las salidas","error")}catch(o){console.error("Error:",o),Swal.fire("‚ùå","Error al crear las salidas","error")}}function p(){let a=null;document.querySelectorAll(".paquete-item").forEach(e=>{e.addEventListener("dragstart",t=>{a=e,e.style.opacity="0.5",t.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",t=>{e.style.opacity="1",a=null})}),document.querySelectorAll(".drop-zone").forEach(e=>{e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move",e.style.backgroundColor="#e0f2fe"}),e.addEventListener("dragleave",t=>{e.style.backgroundColor=""}),e.addEventListener("drop",t=>{if(t.preventDefault(),e.style.backgroundColor="",a){const o=e.querySelector(".text-gray-400");o&&o.remove(),e.appendChild(a),r()}})})}function r(){document.querySelectorAll(".drop-zone").forEach(a=>{const e=a.querySelectorAll(".paquete-item");let t=0;if(e.forEach(o=>{const n=parseFloat(o.dataset.peso)||0;t+=n}),a.dataset.salidaId==="null"){const o=document.getElementById("peso-total-disponibles"),n=document.getElementById("count-paquetes-disponibles");o&&(o.textContent=`${t.toFixed(2)} kg`),n&&(n.textContent=e.length)}else{const o=document.querySelector(`.peso-total-salida[data-salida-id="${a.dataset.salidaId}"]`);o&&(o.textContent=`${t.toFixed(2)} kg`)}})}function S(){const a=document.getElementById("select-salida-destino");if(!a){Swal.fire("‚ö†Ô∏è","No se encontr√≥ el selector de salida","warning");return}const e=a.value,t=a.options[a.selectedIndex].text,o=document.querySelector('.drop-zone[data-salida-id="null"]'),n=o?o.querySelectorAll(".paquete-item"):[];if(n.length===0){Swal.fire("‚ÑπÔ∏è","No hay paquetes disponibles para mover","info");return}const s=document.querySelector(`.drop-zone[data-salida-id="${e}"]`);if(!s){Swal.fire("‚ö†Ô∏è","No se encontr√≥ la zona de la salida","warning");return}n.forEach(i=>{s.appendChild(i)}),r(),Swal.fire({icon:"success",title:"Paquetes movidos",text:`Se han movido ${n.length} paquete(s) a ${t}`,timer:2e3,showConfirmButton:!1})}function h(a){const e=document.querySelector(`.drop-zone[data-salida-id="${a}"]`);if(!e){Swal.fire("‚ö†Ô∏è","No se encontr√≥ la zona de la salida","warning");return}const t=e.querySelectorAll(".paquete-item");if(t.length===0){Swal.fire("‚ÑπÔ∏è","Esta salida no tiene paquetes asignados","info");return}const o=document.querySelector('.drop-zone[data-salida-id="null"]');if(!o){Swal.fire("‚ö†Ô∏è","No se encontr√≥ la zona de paquetes disponibles","warning");return}t.forEach(n=>{o.appendChild(n)}),r(),Swal.fire({icon:"success",title:"Salida vaciada",text:`Se han devuelto ${t.length} paquete(s) a disponibles`,timer:2e3,showConfirmButton:!1})}window.volcarTodosASalida=S;window.vaciarSalida=h;async function y(){const a=[];document.querySelectorAll(".drop-zone").forEach(e=>{const t=e.dataset.salidaId;e.querySelectorAll(".paquete-item").forEach(n=>{const s=parseInt(n.dataset.paqueteId);a.push({paquete_id:s,salida_id:t==="null"?null:parseInt(t)})})});try{Swal.fire({title:"Guardando asignaciones...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const t=await(await fetch(window.AppGestionSalidas.routes.guardarAsignacionesPaquetes,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf},body:JSON.stringify({asignaciones:a})})).json();t.success?await Swal.fire({icon:"success",title:"‚úÖ Asignaciones Guardadas",text:"Los paquetes han sido asignados correctamente a las salidas",timer:2e3}):Swal.fire("‚ö†Ô∏è",t.message||"No se pudieron guardar las asignaciones","warning")}catch(e){console.error("Error:",e),Swal.fire("‚ùå","Error al guardar las asignaciones","error")}}function E(a){const e=document.getElementById("modal-dibujo"),t=document.getElementById("canvas-dibujo");if(!e||!t){console.error("Modal o canvas no encontrado");return}const o=window.paquetes.find(s=>s.id==a);if(!o){console.warn("No se encontr√≥ el paquete");return}const n=[];if(o.etiquetas&&o.etiquetas.length>0&&o.etiquetas.forEach(s=>{s.elementos&&s.elementos.length>0&&s.elementos.forEach(i=>{n.push({id:i.id,dimensiones:i.dimensiones})})}),n.length===0){Swal.fire("‚ö†Ô∏è","Este paquete no tiene elementos para dibujar.","warning");return}t.innerHTML="",n.forEach(s=>{const i=document.createElement("div");i.id=`elemento-${s.id}`,i.style.width="100%",i.style.height="200px",i.style.border="1px solid #e5e7eb",i.style.borderRadius="4px",i.style.background="white",i.style.position="relative",i.style.marginBottom="10px",t.appendChild(i)}),e.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{n.forEach(s=>{typeof window.dibujarFiguraElemento=="function"?window.dibujarFiguraElemento(`elemento-${s.id}`,s.dimensiones,null):console.error("‚ùå dibujarFiguraElemento no est√° disponible")})})})}window.mostrarDibujo=E;function b(){const a=document.getElementById("cerrar-modal"),e=document.getElementById("modal-dibujo");a&&e&&(a.addEventListener("click",function(){e.classList.add("hidden")}),e.addEventListener("click",function(t){t.target===e&&e.classList.add("hidden")}))}function d(){g(),b()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d();document.addEventListener("livewire:navigated",d);async function v(a){if((await Swal.fire({title:"¬øEliminar salida?",text:"Los paquetes asignados volver√°n a estar disponibles. Esta acci√≥n no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"S√≠, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{Swal.fire({title:"Eliminando salida...",text:"Por favor espera",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const t=await fetch(`/salidas-ferralla/${a}`,{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":window.AppGestionSalidas.csrf}}),o=await t.text();let n;try{n=JSON.parse(o)}catch(s){console.error("Error al parsear JSON:",s),console.error("Respuesta del servidor:",o),Swal.fire("Error","Error al procesar la respuesta del servidor. Revisa la consola para m√°s detalles.","error");return}if(t.ok&&n.success){const s=document.querySelector(`.drop-zone[data-salida-id="${a}"]`),i=s?s.querySelectorAll(".paquete-item"):[],c=document.querySelector('.drop-zone[data-salida-id="null"]');c&&i.length>0&&i.forEach(m=>{c.appendChild(m)});const u=s?s.closest(".bg-blue-50"):null;u&&u.remove(),Swal.fire({icon:"success",title:"Salida eliminada",text:"La salida ha sido eliminada correctamente",timer:2e3,showConfirmButton:!1})}else Swal.fire("Error",n.message||"No se pudo eliminar la salida","error")}catch(t){console.error("Error completo:",t),Swal.fire("Error","Error al eliminar la salida: "+t.message,"error")}}function q(){const a=window.AppGestionSalidas.mostrarTodosPaquetes;window.AppGestionSalidas.mostrarTodosPaquetes=!a;const e=window.AppGestionSalidas.mostrarTodosPaquetes?window.paquetesTodos:window.paquetesFiltrados;x(e),C(),T(),p()}function x(a){const e=document.querySelector('.paquetes-zona[data-salida-id="null"]');if(!e){console.error("No se encontr√≥ el contenedor de paquetes disponibles");return}e.innerHTML="",a.forEach(t=>{const o=document.createElement("div");o.className="paquete-item bg-white border border-gray-300 rounded p-2 mb-2 cursor-move hover:shadow-md transition-shadow",o.draggable=!0,o.dataset.paqueteId=t.id,o.dataset.peso=t.peso,o.innerHTML=`
            <div class="flex items-center justify-between text-xs">
                <span class="font-medium">üì¶ ${t.codigo}</span>
                <button onclick="mostrarDibujo(${t.id}); event.stopPropagation();"
                    class="text-blue-500 hover:underline text-xs">
                    üëÅÔ∏è Ver
                </button>
            </div>
            <div class="flex items-center justify-between text-xs mt-1">
                <span class="text-gray-500">${t.planilla_codigo||"N/A"}</span>
                <span class="text-gray-600">${parseFloat(t.peso).toFixed(2)} kg</span>
            </div>
            <div class="text-xs text-gray-500 mt-1 border-t border-gray-200 pt-1">
                <div class="truncate" title="${t.obra}">üèóÔ∏è ${t.obra}</div>
                <div class="truncate" title="${t.cliente}">üë§ ${t.cliente}</div>
            </div>
        `,e.appendChild(o)}),console.log(`‚úÖ Renderizados ${a.length} paquetes`)}function C(){const a=document.getElementById("btn-toggle-paquetes");if(!a)return;window.AppGestionSalidas.mostrarTodosPaquetes?(a.className="text-xs px-3 py-1 rounded-md transition-colors bg-orange-500 hover:bg-orange-600 text-white",a.innerHTML="üìç Ver solo obra/cliente"):(a.className="text-xs px-3 py-1 rounded-md transition-colors bg-blue-500 hover:bg-blue-600 text-white",a.innerHTML="üåê Ver todos pendientes")}function T(){const a=document.querySelector('.paquetes-zona[data-salida-id="null"]').closest(".bg-gray-50").querySelector("p.text-xs");if(!a)return;window.AppGestionSalidas.mostrarTodosPaquetes?a.innerHTML="Mostrando <strong>TODOS</strong> los paquetes pendientes sin filtro":a.innerHTML="Mostrando solo paquetes de <strong>esta obra/cliente</strong>"}window.eliminarSalida=v;window.toggleFiltroPaquetes=q;
