const O=()=>window.AppPlanif,A=()=>O().csrf,P=()=>O().routes,W=()=>{var t;const o=O()||{};let c=o.turnos;return Array.isArray(c)||(c=((t=o.turnosConfig)==null?void 0:t.turnos)||[]),{maquinas:o.maquinas||[],eventos:o.eventos||[],cargaTrabajo:o.cargaTrabajo||{},turnos:c}};let B=null;function E(){B&&(B.remove(),B=null,document.removeEventListener("click",E),document.removeEventListener("scroll",E,!0),window.removeEventListener("resize",E))}function F(o,c,t){E();const a=document.createElement("div");a.className="fc-contextmenu",Object.assign(a.style,{position:"fixed",zIndex:9999,minWidth:"240px",background:"#fff",border:"1px solid #e5e7eb",boxShadow:"0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05)",borderRadius:"8px",overflow:"hidden",visibility:"hidden"}),a.innerHTML=t,document.body.appendChild(a);const l=a.getBoundingClientRect(),r=window.innerHeight,i=window.innerWidth;let s=c;c+l.height>r&&(s=c-l.height,s<0&&(s=Math.max(0,r-l.height)));let u=o;return o+l.width>i&&(u=o-l.width,u<0&&(u=Math.max(0,i-l.width))),Object.assign(a.style,{top:s+"px",left:u+"px",visibility:"visible"}),B=a,setTimeout(()=>{document.addEventListener("click",E),document.addEventListener("scroll",E,!0),window.addEventListener("resize",E)},0),a}function Y(o,c,{headerHtml:t="",items:a=[]}){const l=`
    <div class="ctx-menu-container">
      ${t?`<div class="ctx-menu-header">${t}</div>`:""}
      ${a.map((i,s)=>i.type==="separator"?'<div class="ctx-menu-separator" style="height:1px; background:#e5e7eb; margin:4px 0;"></div>':`
        <button class="ctx-menu-item${i.danger?" ctx-menu-danger":""}${i.disabled?" ctx-menu-disabled":""}" data-idx="${s}" ${i.disabled?"disabled":""}>
          ${i.icon?`<span class="ctx-menu-icon">${i.icon}</span>`:""}
          <span class="ctx-menu-label">${i.label}</span>
        </button>
      `).join("")}
    </div>
  `,r=F(o,c,l);return r.querySelectorAll(".ctx-menu-item").forEach(i=>{const s=parseInt(i.dataset.idx,10),u=a[s];i.addEventListener("click",async y=>{if(y.preventDefault(),y.stopPropagation(),console.log("[baseMenu] Click en item:",u.label,"disabled:",u.disabled),u.disabled){console.log("[baseMenu] Item deshabilitado, ignorando");return}const f=u.onClick;console.log("[baseMenu] Ejecutando acci√≥n..."),E();try{await(f==null?void 0:f()),console.log("[baseMenu] Acci√≥n completada")}catch(d){console.error("[baseMenu] Error en acci√≥n:",d)}})}),r}async function q(o,c={}){const t={headers:{Accept:"application/json","X-CSRF-TOKEN":A()},...c};t.body&&typeof t.body!="string"&&(t.headers["Content-Type"]="application/json",t.body=JSON.stringify(t.body));const a=await fetch(o,t);let l=null;try{l=await a.json()}catch{}if(!a.ok)throw new Error((l==null?void 0:l.message)||`HTTP ${a.status}`);return l}async function J(o){const c=await Swal.fire({title:"Nuevo festivo",input:"text",inputLabel:"T√≠tulo del festivo",inputValue:"Festivo",showCancelButton:!0,confirmButtonText:"Crear",cancelButtonText:"Cancelar",inputValidator:a=>!a||!a.trim()?"Pon un t√≠tulo":void 0});return c.isConfirmed?(await q(P().festivo.store,{method:"POST",body:{fecha:o,titulo:c.value.trim()}})).festivo:null}function G(o){var a,l,r;if(!o)return null;const[c]=o.split(":").map(Number),t=((l=(a=window.AppPlanif)==null?void 0:a.turnosConfig)==null?void 0:l.turnos)||((r=window.AppPlanif)==null?void 0:r.turnos)||[];for(const i of t){if(!i.hora_inicio||!i.hora_fin)continue;const[s]=i.hora_inicio.split(":").map(Number),[u]=i.hora_fin.split(":").map(Number),y=u<s;let f=!1;if(y?f=c>=s||c<u:f=c>=s&&c<u,f)return i.nombre}return c>=0&&c<8?"noche":c>=8&&c<16?"ma√±ana":"tarde"}const R=[{bg:"bg-emerald-50",border:"border-emerald-200",text:"text-emerald-700",badge:"bg-emerald-100 text-emerald-800"},{bg:"bg-blue-50",border:"border-blue-200",text:"text-blue-700",badge:"bg-blue-100 text-blue-800"},{bg:"bg-amber-50",border:"border-amber-200",text:"text-amber-700",badge:"bg-amber-100 text-amber-800"},{bg:"bg-purple-50",border:"border-purple-200",text:"text-purple-700",badge:"bg-purple-100 text-purple-800"},{bg:"bg-rose-50",border:"border-rose-200",text:"text-rose-700",badge:"bg-rose-100 text-rose-800"},{bg:"bg-cyan-50",border:"border-cyan-200",text:"text-cyan-700",badge:"bg-cyan-100 text-cyan-800"}];function U(o,c,t,a){const l=R[a%R.length],r=`swal-trabajador-${t}-${c}`,i=o.operarios.length;if(i===0)return"";const s=o.operarios.map(u=>`<option value="${u.id}">${u.name} ${u.primer_apellido||""} ${u.segundo_apellido||""}</option>`).join("");return`
        <div class="mb-3 ${l.bg} ${l.border} border rounded-lg p-2">
            <label class="block text-xs font-semibold ${l.text} mb-1">
                ${o.empresa_nombre}
                <span class="${l.badge} text-xs px-1.5 py-0.5 rounded-full ml-1">${i}</span>
            </label>
            <select id="${r}" data-tipo="${t}" class="swal2-input w-full select-operario text-sm py-1" style="margin: 0;">
                <option value="" selected>Seleccionar...</option>
                ${s}
            </select>
        </div>
    `}function L(o,c,t,a){if(!o||o.length===0)return`
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-500 mb-2">${t}</p>
                <p class="text-xs text-gray-400 italic">No hay operarios</p>
            </div>
        `;const l=o.reduce((i,s)=>i+s.operarios.length,0),r=o.map((i,s)=>U(i,s,c,s)).join("");return`
        <div class="mb-4">
            <p class="text-sm font-semibold text-gray-700 mb-2">
                ${t} <span class="${a}">(${l})</span>
            </p>
            <div class="space-y-2 max-h-48 overflow-y-auto pr-1">
                ${r}
            </div>
        </div>
    `}async function Q(o,c,t,a=null){const l=G(a);console.log("[generarTurnos] horaISO:",a,"turnoDetectado:",l);let r={sin_turno_por_empresa:[],de_maquina_por_empresa:[],todos_por_empresa:[],todos:[]};try{const d=await fetch(`/api/usuarios/operarios-agrupados?fecha=${o}&maquina_id=${c}`,{headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"}});d.ok?(r=await d.json(),console.log("[generarTurnos] Datos recibidos:",r)):console.error("Error al obtener operarios:",d.status)}catch(d){console.error("Error al obtener operarios:",d)}const i=l?`<span class="text-green-600 font-semibold">${l.charAt(0).toUpperCase()+l.slice(1)}</span>`:'<span class="text-gray-400">No detectado</span>',s=L(r.sin_turno_por_empresa,"sin_turno","Sin turno asignado este d√≠a","text-green-600"),u=L(r.de_maquina_por_empresa,"de_maquina",`Asignados a ${t}`,"text-blue-600"),y=L(r.todos_por_empresa,"todos","Todos los operarios","text-gray-600"),{value:f}=await Swal.fire({title:"Generar Turnos",html:`
            <div class="text-left space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha inicio:</strong> ${o}<br>
                        <strong>M√°quina:</strong> ${t}<br>
                        <strong>Turno detectado:</strong> ${i}
                    </p>
                </div>

                <!-- Tabs para las secciones -->
                <div class="border-b border-gray-200 mb-3">
                    <nav class="flex space-x-1" aria-label="Tabs">
                        <button type="button" data-tab="sin_turno" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-green-500 text-green-600 bg-green-50">
                            Sin turno hoy
                        </button>
                        <button type="button" data-tab="de_maquina" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            De ${t}
                        </button>
                        <button type="button" data-tab="todos" class="tab-btn px-2 py-2 text-xs font-medium rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            Todos
                        </button>
                    </nav>
                </div>

                <!-- Contenido de tabs -->
                <div id="tab-content-sin_turno" class="tab-content">
                    ${s}
                </div>
                <div id="tab-content-de_maquina" class="tab-content hidden">
                    ${u}
                </div>
                <div id="tab-content-todos" class="tab-content hidden">
                    ${y}
                </div>

                <input type="hidden" id="swal-trabajador" value="" />
                <input type="hidden" id="swal-turno-detectado" value="${l||""}" />

                <!-- Trabajador seleccionado -->
                <div id="trabajador-seleccionado" class="hidden bg-green-50 border border-green-200 rounded-lg p-2 mb-3">
                    <p class="text-sm text-green-800">
                        <strong>Seleccionado:</strong> <span id="nombre-seleccionado"></span>
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Alcance de generaci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-alcance" class="swal2-input w-full">
                        <option value="un_dia">Solo este d√≠a (${o})</option>
                        <option value="dos_semanas">Hasta el viernes de la semana siguiente</option>
                        <option value="resto_a√±o">Desde ${o} hasta fin de a√±o</option>
                    </select>
                </div>

                <div class="mb-4" id="turno-inicio-container" style="display: ${l?"none":"block"};">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Turno inicial (para diurnos) <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-turno-inicio" class="swal2-input w-full">
                        <option value="ma√±ana" ${l==="ma√±ana"?"selected":""}>Ma√±ana</option>
                        <option value="tarde" ${l==="tarde"?"selected":""}>Tarde</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Los turnos alternar√°n cada viernes</p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">
                        <strong>Nota:</strong> Se saltar√°n autom√°ticamente s√°bados, domingos, festivos y d√≠as con vacaciones.
                    </p>
                </div>
            </div>
        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Generar Turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",width:"650px",didOpen:()=>{const d=document.getElementById("swal-trabajador"),w=document.getElementById("turno-inicio-container"),n=document.getElementById("trabajador-seleccionado"),e=document.getElementById("nombre-seleccionado"),p=r.todos||[];function m(g,b){d.value=g,document.querySelectorAll(".select-operario").forEach(x=>{x!==b&&(x.value="")});const h=p.find(x=>x.id===parseInt(g));h&&(e.textContent=`${h.name} ${h.primer_apellido||""} ${h.segundo_apellido||""} (${h.empresa_nombre||"Sin empresa"})`,n.classList.remove("hidden"),h.turno==="diurno"?w.style.display="block":w.style.display="none")}document.querySelectorAll(".select-operario").forEach(g=>{g.addEventListener("change",b=>{b.target.value&&m(b.target.value,b.target)})}),document.querySelectorAll(".tab-btn").forEach(g=>{g.addEventListener("click",b=>{const h=b.target.dataset.tab;document.querySelectorAll(".tab-btn").forEach(x=>{x.classList.remove("border-green-500","text-green-600","bg-green-50"),x.classList.add("border-transparent","text-gray-500")}),b.target.classList.remove("border-transparent","text-gray-500"),b.target.classList.add("border-green-500","text-green-600","bg-green-50"),document.querySelectorAll(".tab-content").forEach(x=>{x.classList.add("hidden")}),document.getElementById(`tab-content-${h}`).classList.remove("hidden")})})},preConfirm:()=>{const d=document.getElementById("swal-trabajador").value,w=document.getElementById("swal-alcance").value,n=document.getElementById("swal-turno-inicio").value,e=document.getElementById("swal-turno-detectado").value;return d?{trabajador_id:d,alcance:w,turno_inicio:n,turno_detectado:e||null}:(Swal.showValidationMessage("Debes seleccionar un trabajador"),!1)}});if(!f)return null;try{const w=await fetch("/profile/generar-turnos-calendario",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"},body:JSON.stringify({user_id:f.trabajador_id,maquina_id:c,fecha_inicio:o,alcance:f.alcance,turno_inicio:f.turno_inicio,turno_detectado:f.turno_detectado})}),n=await w.json();if(console.log("[generarTurnos] Respuesta backend:",n),n.eventos&&n.eventos.length>0&&console.log("[generarTurnos] Primer evento:",n.eventos[0]),!w.ok)throw new Error(n.message||`Error HTTP ${w.status}`);return{...n,eventos:n.eventos||[]}}catch(d){return console.error("Error al generar turnos:",d),await Swal.fire({icon:"error",title:"Error",text:d.message||"No se pudieron generar los turnos",confirmButtonText:"Aceptar"}),null}}async function X({fromISO:o,toISO:c,calendar:t,maquinaId:a=null}){if(await Swal.fire({icon:"question",title:"Copiar registros",html:`¬øCopiar registros de <b>${o}</b> a <b>${c}</b>?<br><small class="text-gray-500">Se guardar√°n en la base de datos</small>`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar"}).then(r=>r.isConfirmed))try{const r=await fetch("/asignaciones-turno/copiar-dia",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":A(),Accept:"application/json"},body:JSON.stringify({fecha_origen:o,fecha_destino:c,maquina_id:a})}),i=await r.json();if(!r.ok)throw new Error(i.message||`Error HTTP ${r.status}`);i.eventos&&i.eventos.length>0&&i.eventos.forEach(s=>{t.addEvent({id:s.id,title:s.title,start:s.start,end:s.end,resourceId:s.resourceId,backgroundColor:s.backgroundColor,borderColor:s.borderColor,textColor:s.textColor||"#000000",extendedProps:s.extendedProps||{}})}),Swal.fire({icon:"success",title:"Copiado completado",html:`Se han copiado <b>${i.copiadas||0}</b> registros a ${c}.`,timer:1800,showConfirmButton:!1})}catch(r){console.error("Error al copiar d√≠a:",r),Swal.fire({icon:"error",title:"Error al copiar",text:r.message||"No se pudieron copiar los registros."})}}async function j({fechaISO:o,alcance:c,maquinaId:t,calendar:a}){const l=c==="semana_actual"?"el resto de esta semana":"esta semana y la siguiente";if(await Swal.fire({icon:"question",title:"Propagar asignaciones",html:`¬øPropagar las asignaciones del <b>${o}</b> a ${l}?<br>
               <small class="text-gray-500">Se saltar√°n fines de semana, festivos y vacaciones.</small>`,showCancelButton:!0,confirmButtonText:"Propagar",cancelButtonText:"Cancelar",confirmButtonColor:"#10b981"}).then(i=>i.isConfirmed))try{const i=await fetch("/asignaciones-turno/propagar-dia",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":A(),Accept:"application/json"},body:JSON.stringify({fecha_origen:o,alcance:c,maquina_id:t})}),s=await i.json();if(!i.ok)throw new Error(s.message||`Error HTTP ${i.status}`);s.eventos&&s.eventos.length>0&&s.eventos.forEach(u=>{a.getEventById(u.id)||a.addEvent({id:u.id,title:u.title,start:u.start,end:u.end,resourceId:u.resourceId,backgroundColor:u.backgroundColor,borderColor:u.borderColor,textColor:u.textColor||"#000000",extendedProps:u.extendedProps||{}})}),await Swal.fire({icon:"success",title:"Asignaciones propagadas",html:`Se propagaron <b>${s.copiadas||0}</b> asignaciones a <b>${s.dias_procesados||0}</b> d√≠as.`,timer:2500,showConfirmButton:!1})}catch(i){console.error("Error al propagar d√≠a:",i),await Swal.fire({icon:"error",title:"Error",text:i.message||"No se pudieron propagar las asignaciones",confirmButtonText:"Aceptar"})}}async function z({maquinaId:o,maquinaNombre:c,fechaISO:t,duracionSemanas:a,calendar:l}){const r=a===1?"la semana actual":"las pr√≥ximas 2 semanas";if(await Swal.fire({icon:"question",title:"Copiar semana anterior",html:`¬øCopiar los turnos de la semana anterior de <b>${c}</b> para ${r}?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6"}).then(s=>s.isConfirmed))try{const s=new Date(t),u=s.getDay(),y=u===0?-6:1-u,f=new Date(s);f.setDate(s.getDate()+y);const d=f.toISOString().slice(0,10),w=await fetch("/asignaciones-turno/repetir-semana-maquina",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":A(),Accept:"application/json"},body:JSON.stringify({maquina_id:o,semana_inicio:d,duracion_semanas:a})}),n=await w.json();if(!w.ok)throw new Error(n.message||`Error HTTP ${w.status}`);n.eventos&&n.eventos.length>0&&n.eventos.forEach(e=>{l.getEventById(e.id)||l.addEvent({id:e.id,title:e.title,start:e.start,end:e.end,resourceId:e.resourceId,backgroundColor:e.backgroundColor,borderColor:e.borderColor,textColor:e.textColor||"#000000",extendedProps:e.extendedProps||{}})}),await Swal.fire({icon:"success",title:"Turnos copiados",html:`Se han copiado <b>${n.turnos_creados||0}</b> turnos correctamente.`,timer:2e3,showConfirmButton:!1})}catch(s){console.error("Error al copiar turnos:",s),await Swal.fire({icon:"error",title:"Error",text:s.message||"No se pudieron copiar los turnos",confirmButtonText:"Aceptar"})}}function Z(o,c,{fechaISO:t,resourceId:a,horaISO:l},r,i){var n;const s=new Date(t);s.setDate(s.getDate()-1);const u=new Date(t);u.setDate(u.getDate()+1);const y=s.toISOString().slice(0,10),f=u.toISOString().slice(0,10),d=a?((n=i.find(e=>String(e.id)===String(a)))==null?void 0:n.title)||`M√°quina ${a}`:"Seleccione una m√°quina",w=[{icon:"üìÖ",label:"Crear festivo este d√≠a",onClick:async()=>{const e=await J(t);if(!e)return;const p=new Date(e.fecha+"T00:00:00"),m=new Date(p);m.setDate(m.getDate()+1);const g=(i||[]).map(b=>b.id);r.addEvent({id:"festivo-"+e.id,title:e.titulo,start:p.toISOString(),end:m.toISOString(),allDay:!0,resourceIds:g,backgroundColor:"#ff0000",borderColor:"#b91c1c",textColor:"#ffffff",editable:!0,classNames:["evento-festivo"],extendedProps:{es_festivo:!0,festivo_id:e.id,entrada:null,salida:null}}),Swal.fire({icon:"success",title:"Festivo creado",timer:1200,showConfirmButton:!1})}},{icon:"‚¨ÖÔ∏è",label:`Copiar registros del d√≠a anterior (${y} ‚Üí ${t})`,onClick:()=>X({fromISO:y,toISO:t,calendar:r})},{icon:"‚û°Ô∏è",label:`Copiar registros del d√≠a siguiente (${f} ‚Üí ${t})`,onClick:()=>X({fromISO:f,toISO:t,calendar:r})},{icon:"üìÖ",label:a?`Copiar semana anterior ‚Üí semana actual (${d})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!a,onClick:()=>z({maquinaId:a,maquinaNombre:d,fechaISO:t,duracionSemanas:1,calendar:r})},{icon:"üìÖüìÖ",label:a?`Copiar semana anterior ‚Üí 2 semanas (${d})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!a,onClick:()=>z({maquinaId:a,maquinaNombre:d,fechaISO:t,duracionSemanas:2,calendar:r})},{type:"separator"},{icon:"üì§",label:a?`Propagar ${t} ‚Üí semana (${d})`:`Propagar ${t} ‚Üí semana`,onClick:()=>j({fechaISO:t,alcance:"semana_actual",maquinaId:a||null,calendar:r})},{icon:"üì§üì§",label:a?`Propagar ${t} ‚Üí 2 semanas (${d})`:`Propagar ${t} ‚Üí 2 semanas`,onClick:()=>j({fechaISO:t,alcance:"dos_semanas",maquinaId:a||null,calendar:r})},{icon:"üîÑ",label:`Propagar ${t} ‚Üí semana (TODAS las m√°quinas)`,onClick:()=>j({fechaISO:t,alcance:"semana_actual",maquinaId:null,calendar:r})},{icon:"üîÑüîÑ",label:`Propagar ${t} ‚Üí 2 semanas (TODAS las m√°quinas)`,onClick:()=>j({fechaISO:t,alcance:"dos_semanas",maquinaId:null,calendar:r})},{type:"separator"},{icon:"üîß",label:a?`Generar turnos para ${d}`:"Generar turnos (seleccione una m√°quina)",disabled:!a,onClick:async()=>{var p,m;if(console.log("[menu] Click en generar turnos, resourceId:",a),!a){console.log("[menu] No hay resourceId, mostrando advertencia"),Swal.fire({icon:"warning",title:"M√°quina no seleccionada",text:"Haz clic derecho sobre una m√°quina espec√≠fica para generar turnos."});return}console.log("[menu] Llamando a generarTurnosDialog...");const e=await Q(t,a,d,l);if(console.log("[menu] Resultado del di√°logo:",e),e&&e.eventos){console.log("[menu] Procesando eventos:",e.eventos.length);const g=(m=(p=e.eventos[0])==null?void 0:p.extendedProps)==null?void 0:m.user_id;if(g){const b=r.getEvents(),h=e.eventos.map(x=>{var v;return(v=x.start)==null?void 0:v.slice(0,10)});b.forEach(x=>{var _,k,S,T;const v=(_=x.extendedProps)==null?void 0:_.user_id,C=((k=x.startStr)==null?void 0:k.slice(0,10))||((S=x.start)==null?void 0:S.toISOString().slice(0,10));v===g&&h.includes(C)&&!((T=x.extendedProps)!=null&&T.es_festivo)&&(console.log("[menu] Eliminando evento antiguo:",x.id),x.remove())})}e.eventos.forEach(b=>{console.log("[menu] A√±adiendo evento:",{id:b.id,start:b.start,end:b.end,resourceId:b.resourceId}),r.addEvent({id:b.id,title:b.title,start:b.start,end:b.end,resourceId:b.resourceId,backgroundColor:b.backgroundColor,borderColor:b.borderColor,textColor:b.textColor||"#000000",extendedProps:b.extendedProps||{}})}),console.log("[menu] Eventos actualizados correctamente")}}}];Y(o,c,{headerHtml:`<div>Acciones para <b>${t}</b></div>`,items:w})}function ee(o,c,{event:t,titulo:a}){F(o,c,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${a}
    </div>
    <button id="ctx-eliminar-festivo" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      üóëÔ∏è Eliminar festivo
    </button>
  `).querySelector("#ctx-eliminar-festivo").addEventListener("click",async()=>{if(E(),!await Swal.fire({icon:"warning",title:"Eliminar festivo",html:`<div>¬øSeguro que quieres eliminar <b>${a}</b>?</div>`,showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(s=>s.isConfirmed))return;const i=t.extendedProps.festivo_id;await q(P().festivo.delete.replace("__ID__",i),{method:"DELETE"}),t.remove(),Swal.fire({icon:"success",title:"Festivo eliminado",timer:1200,showConfirmButton:!1})})}async function te(o){const c=o.extendedProps||{},t=c.entrada||"",a=c.salida||"",l=await Swal.fire({title:"Editar fichaje",html:`
      <div class="flex flex-col gap-3">
        <label class="text-left text-sm">Entrada</label>
        <input id="entradaHora" type="time" class="swal2-input" value="${t}">
        <label class="text-left text-sm">Salida</label>
        <input id="salidaHora" type="time" class="swal2-input" value="${a}">
      </div>`,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",preConfirm:()=>{const i=document.getElementById("entradaHora").value,s=document.getElementById("salidaHora").value;return!i&&!s?(Swal.showValidationMessage("Debes indicar al menos una hora"),!1):{entrada:i,salida:s}}});if(!l.isConfirmed)return;const r=o.id.toString().replace(/^turno-/,"");await q(P().asignacion.updateHoras.replace("__ID__",r),{method:"POST",body:l.value}),o.setExtendedProp("entrada",l.value.entrada),o.setExtendedProp("salida",l.value.salida),Swal.fire({icon:"success",title:"Horas actualizadas",timer:1500,showConfirmButton:!1})}function oe(o,c,t){var s,u;const a=t.title||"Operario",l=((s=t.extendedProps)==null?void 0:s.categoria_nombre)??"",r=((u=t.extendedProps)==null?void 0:u.especialidad_nombre)??"Sin especialidad",i=F(o,c,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${a} <div style="font-size:12px">${l} ¬∑ ${r}</div>
    </div>
    <button id="ctx-editar-fichajes" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      ‚úèÔ∏è Editar fichajes
    </button>
    <button id="ctx-eliminar-registro" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;color:#b91c1c;">
      üóëÔ∏è Eliminar registro
    </button>
  `);i.querySelector("#ctx-editar-fichajes").addEventListener("click",async()=>{E(),await te(t)}),i.querySelector("#ctx-eliminar-registro").addEventListener("click",async()=>{var w;if(E(),!await Swal.fire({icon:"warning",title:"Eliminar registro",html:`<div>¬øSeguro que quieres eliminar este evento/asignaci√≥n?</div>
                   <div class="text-xs text-gray-500 mt-1">Esta acci√≥n no se puede deshacer.</div>`,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",showCancelButton:!0,confirmButtonColor:"#b91c1c"}).then(n=>n.isConfirmed))return;const f="/asignaciones-turnos/destroy",d={_method:"DELETE",fecha_inicio:t.startStr,fecha_fin:t.endStr??t.startStr,tipo:"eliminarTurnoEstado",user_id:(w=t.extendedProps)==null?void 0:w.user_id};console.log("[workerMenu] Eliminando turno, payload:",d),console.log("[workerMenu] Event extendedProps:",t.extendedProps);try{await q(f,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(d)}),t.remove(),Swal.fire({icon:"success",title:"Registro eliminado",timer:1300,showConfirmButton:!1})}catch(n){console.error("Error al eliminar el turno:",n),Swal.fire({icon:"error",title:"Error al eliminar",text:n.message||"No se pudo eliminar el turno."})}})}function ne(o,c){const t=[];if(!o||typeof o!="object")return t;const a=(c||[]).filter(r=>r.hora_inicio&&r.hora_fin);if(a.length===0)return t;const l={};a.forEach(r=>{const i=r.nombre.toLowerCase(),[s]=r.hora_inicio.split(":").map(Number),[u]=r.hora_fin.split(":").map(Number),y=u<s;let f,d;y?(f="00:00:00",d="00:30:00"):s<14?(f="08:00:00",d="08:30:00"):(f="16:00:00",d="16:30:00"),l[i]={esNocturno:y,slotInicio:f,slotFin:d,color:r.color}});for(const[r,i]of Object.entries(o))if(!(!i||typeof i!="object")){for(const[s,u]of Object.entries(i))if(u)for(const[y,f]of Object.entries(l)){const d=u[y]||0;d<=0||t.push({id:`carga-${r}-${s}-${y}`,title:`${d}h`,start:`${s}T${f.slotInicio}`,end:`${s}T${f.slotFin}`,resourceId:r,backgroundColor:V(d),borderColor:V(d),textColor:"#000",editable:!1,classNames:["evento-carga"],extendedProps:{es_carga:!0,turno:y,horas:d}})}}return t}function V(o){return o>6?"#fca5a5":o>3?"#fcd34d":"#86efac"}function ae(o){const c={slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[]};if(!o||o.length===0)return c;const t=o.filter(l=>l.hora_inicio&&l.hora_fin);return t.length===0?c:{slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[...t].sort((l,r)=>{const[i]=l.hora_inicio.split(":").map(Number),[s]=l.hora_fin.split(":").map(Number),[u]=r.hora_inicio.split(":").map(Number),[y]=r.hora_fin.split(":").map(Number),f=s<i,d=y<u;return f&&!d?-1:!f&&d?1:i-u})}}function re(o,c,t){const a=localStorage.getItem(o);return c.includes(a)?a:t}function se(o){const{maquinas:c,eventos:t,cargaTrabajo:a,turnos:l}=W(),r=ae(l),i=ne(a,l),s=[...t,...i],u="vistaObras",y="fechaObras";let f=!1;const d=new FullCalendar.Calendar(o,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",locale:"es",initialView:re(u,["resourceTimelineDay","resourceTimelineWeek"],"resourceTimelineWeek"),initialDate:localStorage.getItem(y)||void 0,selectable:!0,unselectAuto:!0,datesSet(n){localStorage.setItem("vistaObras",n.view.type),localStorage.setItem("fechaObras",n.startStr);const e=n.view.type==="resourceTimelineDay";if(o.classList.toggle("vista-dia",e),o.classList.toggle("vista-semana",!e),e){const m=o.querySelector(".fc-toolbar-title");if(m){const g=n.start,b={weekday:"long",day:"numeric",month:"long",year:"numeric"};m.textContent=g.toLocaleDateString("es-ES",b)}}const p=document.getElementById("btnRepetirSemana");p&&(n.view.type==="resourceTimelineWeek"?(p.classList.remove("hidden"),p.dataset.fecha=n.startStr):p.classList.add("hidden"))},displayEventEnd:!0,eventMinHeight:30,firstDay:1,height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"resourceTimelineDay,resourceTimelineWeek"},buttonText:{today:"Hoy",week:"Semana",day:"D√≠a"},slotLabelDidMount(n){if(n.view.type==="resourceTimelineDay"&&r.turnos){const p=n.date.getHours();let m=0;p>=8&&p<16?m=1:p>=16&&(m=2);const g=r.turnos[m];g&&(n.el.style.backgroundColor=g.color||"#e5e7eb")}},slotLabelContent(n){if(n.view.type==="resourceTimelineDay"){const p=n.date.getHours();if(p===0)return{html:"<b>Noche</b>"};if(p===8)return{html:"<b>Ma√±ana</b>"};if(p===16)return{html:"<b>Tarde</b>"}}return null},views:{resourceTimelineDay:{slotMinTime:r.slotMinTime,slotMaxTime:r.slotMaxTime,slotDuration:r.slotDuration,titleFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"}},resourceTimelineWeek:{slotDuration:{days:1},slotLabelFormat:{weekday:"long"}}},editable:!0,resources:c,resourceOrder:"orden",resourceAreaWidth:"100px",resourceLabelDidMount(n){const e=n.resource.extendedProps.backgroundColor;e&&(n.el.style.backgroundColor=e,n.el.style.color="#fff")},filterResourcesWithEvents:!1,events:s,resourceAreaColumns:[{field:"title",headerContent:"M√°quinas"}],eventDragStart:n=>{f=!0;const e=n.el;e._tippy&&(e._tippy.hide(),e._tippy.disable()),document.querySelectorAll(".fc-event").forEach(p=>{p._tippy&&p._tippy.disable()})},eventDragStop:n=>{f=!1,setTimeout(()=>{document.querySelectorAll(".fc-event").forEach(m=>{m._tippy&&m._tippy.enable()});const e=n.el,p=n.event.extendedProps||{};if(!e._tippy&&p.foto&&!p.es_festivo){const m=`<img src="${p.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`;tippy(e,{content:m,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(f)return!1}})}},100)},eventDrop:async n=>{var m,g;const e=n.event,p=e.extendedProps||{};try{if(p.es_festivo){const $=e.startStr.slice(0,10);await fetch(P().festivo.update.replace("__ID__",p.festivo_id),{method:"PUT",headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({fecha:$})}).then(D=>{if(!D.ok)throw new Error(`HTTP ${D.status}`)});return}const b=e.id.replace(/^turno-/,""),h=(m=e.getResources())==null?void 0:m[0],x=h?parseInt(h.id,10):null,v=(g=e.start)==null?void 0:g.toISOString(),C=new Date(v).getHours();let _=null;for(const $ of r.turnos){const[D]=$.hora_inicio.split(":").map(Number),[N]=$.hora_fin.split(":").map(Number),K=N<D;let I=!1;if(K?I=C>=D||C<N:I=C>=D&&C<N,I){_=$.id;break}}if(_||(_=C>=6&&C<14?1:C>=14&&C<22?2:3),!x||!v)throw new Error("Datos incompletos");const k=P().asignacion.updatePuesto.replace("__ID__",b),S=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf},body:JSON.stringify({maquina_id:x,start:v,turno_id:_})}),T=await S.json();if(!S.ok)throw new Error((T==null?void 0:T.message)||`HTTP ${S.status}`);T.color&&(e.setProp("backgroundColor",T.color),e.setProp("borderColor",T.color)),typeof T.nuevo_obra_id<"u"&&e.setExtendedProp("obra_id",T.nuevo_obra_id),e.setExtendedProp("turno_id",_);const H=r.turnos.find($=>$.id===_);H&&e.setExtendedProp("turno_nombre",H.nombre),d.refetchEvents()}catch(b){console.error(b),Swal.fire("Error",b.message||"Ocurri√≥ un error inesperado.","error"),n.revert()}},eventDidMount(n){const e=n.event,p=e.extendedProps||{};if(p.es_carga){n.el.title=`${p.horas}h de trabajo - Turno ${p.turno}`;return}if(n.el._tippy&&n.el._tippy.destroy(),p.foto&&!p.es_festivo){const m=`<img src="${p.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`,g=tippy(n.el,{content:m,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(f)return!1}});f&&g&&g.disable()}n.el.addEventListener("contextmenu",m=>{m.preventDefault(),m.stopPropagation(),p.es_festivo?ee(m.clientX,m.clientY,{event:e,titulo:e.title}):oe(m.clientX,m.clientY,e)})},eventClick(n){const p=n.event.extendedProps||{};if(p.es_festivo)return;const m=p.user_id;if(m){const g=P().userShow.replace(":id",m);window.location.href=g}},eventContent(n){const e=n.event.extendedProps;if(e!=null&&e.es_carga)return{html:`<div class="carga-content">${e.horas}h</div>`};if(e!=null&&e.es_festivo)return{html:`<div class="px-2 py-1 text-xs font-semibold" style="color:#fff">${n.event.title}</div>`};const p=e.entrada&&e.salida?`${e.entrada} / ${e.salida}`:e.entrada||e.salida||"-- / --",m=e.turno_nombre?e.turno_nombre.charAt(0).toUpperCase()+e.turno_nombre.slice(1):"";return{html:`
          <div class="px-2 py-1 text-xs font-semibold flex items-center">
            <div class="flex flex-col">
              <span>${n.event.title} <span class="text-[10px] font-medium opacity-70">[${m}]</span></span>
              <span class="text-[10px] font-normal opacity-80">(${e.categoria_nombre??""} üõ† ${e.especialidad_nombre??"Sin especialidad"})</span>
            </div>
            <div class="ml-auto text-right">
              <span class="text-[10px] font-normal opacity-80">${p}</span>
            </div>
          </div>`}}});d.render(),console.log("[cal] Configurando event listener para contextmenu...");const w=d.el;return console.log("[cal] Elemento ra√≠z del calendario:",w),console.log("[cal] Agregando event listener de contextmenu al calendario"),w.addEventListener("contextmenu",n=>{if(console.log("[cal] ¬°Contextmenu disparado!",n.target),n.target.closest(".fc-event")){console.log("[cal] Es un evento, ignorando");return}n.preventDefault();let e=null,p=null,m=null;const g=n.target.closest("[data-date]");if(g){const h=g.getAttribute("data-date")||"";h.includes("T")?(p=h.slice(0,10),m=h.slice(11,16)):p=h.slice(0,10)}if(!m&&d.view.type==="resourceTimelineDay"){const h=d;if(h.getDate(),typeof h.el.getBoundingClientRect=="function"){h.el.getBoundingClientRect();const x=h.el.querySelector(".fc-timeline-body");if(x){const v=x.getBoundingClientRect(),C=n.clientX-v.left,_=v.width,k=C/_*24,S=Math.floor(k);m=String(S).padStart(2,"0")+":00",console.log("[cal] Hora calculada por posici√≥n X:",m)}}}if(!p){console.log("[cal] No se pudo determinar la fecha");return}console.log("[cal] Fecha encontrada:",p,"Hora:",m),console.log("[cal] Elemento clickeado:",n.target),console.log("[cal] Elemento con data-date:",g);const b=w.querySelectorAll(".fc-timeline-lane[data-resource-id]");if(console.log("[cal] Filas de recursos encontradas:",b.length),b.length>0){const h=n.clientY;console.log("[cal] Posici√≥n Y del click:",h);for(const x of b){const v=x.getBoundingClientRect();if(console.log("[cal] Examinando lane con resource-id:",x.dataset.resourceId,"top:",v.top,"bottom:",v.bottom),h>=v.top&&h<=v.bottom){e=x.dataset.resourceId,console.log("[cal] ¬°ResourceId encontrado por posici√≥n Y!:",e);break}}}console.log("[cal] ResourceId final detectado:",e,"Fecha:",p,"Hora:",m),Z(n.clientX,n.clientY,{fechaISO:p,resourceId:e,horaISO:m},d,c)}),console.log("[cal] Event listener de contextmenu agregado correctamente"),d}function M(){const o=document.getElementById("calendario");if(!o||o.getAttribute("data-calendar-type")!=="trabajadores"||!window.AppPlanif)return;if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}const c=se(o);window.calendarTrabajadores=c}function ie(){if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();document.addEventListener("livewire:navigated",M);document.addEventListener("livewire:navigating",ie);
