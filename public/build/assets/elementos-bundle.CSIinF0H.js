window.guardarCambios=function(g){var $,K;const G={id:g.id,planilla_id:(($=g.planilla)==null?void 0:$.id)??null,users_id:g.users_id??null,users_id_2:Number(g.users_id_2)||null,etiqueta_id:((K=g.etiquetaRelacion)==null?void 0:K.id)??null,paquete_id:g.paquete_id??null,maquina_id:Number(g.maquina_id)||null,maquina_id_2:Number(g.maquina_id_2)||null,producto_id:Number(g.producto_id)||null,producto_id_2:Number(g.producto_id_2)||null,producto_id_3:Number(g.producto_id_3)||null,figura:g.figura||null,dimensiones:g.dimensiones||null,peso:g.peso||null,diametro:g.diametro||null,longitud:g.longitud||null,barras:g.barras??null,estado:g.estado??null};fetch(`/elementos/${g.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(G)}).then(I=>I.json()).then(I=>{if(I.success)window.location.reload();else{let U=I.message||"Ha ocurrido un error inesperado.";I.errors&&(U=Object.values(I.errors).flat().join(" ")),Swal.fire({icon:"error",title:"Error al actualizar",text:U,confirmButtonText:"OK"})}}).catch(I=>{console.error("Error:",I),Swal.fire({icon:"error",title:"Error de conexi√≥n",text:"No se pudo actualizar el elemento. Int√©ntalo nuevamente.",confirmButtonText:"OK"})})};function tt(){const g=document.getElementById("modal-dibujo"),G=document.getElementById("cerrar-modal");document.getElementById("canvas-dibujo");const $="rgba(0, 0, 0, 0.8)",K=.6,I=50,U=2;function y(r){return r*Math.PI/180}function st(r){const a=(r||"").split(/\s+/).filter(Boolean),n=[];for(let e=0;e<a.length;e++){const t=a[e];if(t.endsWith("r")){const o=parseFloat(t.slice(0,-1));let i=360;e+1<a.length&&a[e+1].endsWith("d")&&(i=parseFloat(a[++e].slice(0,-1))),n.push({type:"arc",radius:o,arcAngle:i})}else t.endsWith("d")?n.push({type:"turn",angle:parseFloat(t.slice(0,-1))}):n.push({type:"line",length:parseFloat(t)})}return n}function at(r){let a=[],n=0,e=0,t=0;a.push({x:n,y:e});for(let o=0;o<r.length;o++){const i=r[o];if(i.type==="line")n+=i.length*Math.cos(y(t)),e+=i.length*Math.sin(y(t)),a.push({x:n,y:e});else if(i.type==="turn")t+=i.angle;else if(i.type==="arc"){const s=n+i.radius*Math.cos(y(t+90)),l=e+i.radius*Math.sin(y(t+90)),m=Math.atan2(e-l,n-s),p=m+y(i.arcAngle);n=s+i.radius*Math.cos(p),e=l+i.radius*Math.sin(p),t+=i.arcAngle,a.push({x:n,y:e})}}return a}function rt(r,a){return!a||a===1?r.map(n=>({...n})):r.map(n=>n.type==="line"?{...n,length:(n.length||0)*a}:n.type==="arc"?{...n,radius:(n.radius||0)*a}:{...n})}function ct(r,a){const e=[];let t=0;function o(){t>1e-9&&(e.push({type:"line",length:t}),t=0)}for(let i=0;i<r.length;i++){const s=r[i];if(s.type==="line"){t+=s.length;continue}if(s.type==="turn"){if(Math.abs(s.angle)<1e-9)continue;o(),e.push(s);continue}if(s.type==="arc"){o(),e.push(s);continue}o(),e.push(s)}return o(),e}function lt(r,a){const n=a,e=r.map(d=>Object.assign({},d));let t=0,o=0,i=0;const s=[];let l=null,m=-1,p=-1;const f=1e-7;function w(d){return Math.abs(Math.sin(y(d)))<1e-12}function v(d,h,c,b){return Math.min(h,b)-Math.max(d,c)>f}for(let d=0;d<e.length;d++){let c=function(){const P={x:Math.cos(y(i)),y:Math.sin(y(i))},L=t+e[d].length*P.x,O=o+e[d].length*P.y,C=w(i);for(let N=0;N<s.length;N++){const M=s[N];if(C&&M.horiz&&Math.abs(o-M.y)<f){if(v(Math.min(t,L),Math.max(t,L),Math.min(M.x1,M.x2),Math.max(M.x1,M.x2))&&l&&m>=0&&p>=0)return e[p].length+=n,t+=l.x*n,o+=l.y*n,s[m].x2+=l.x*n,s[m].y2+=l.y*n,!0}else if(!C&&!M.horiz&&Math.abs(t-M.x)<f&&v(Math.min(o,O),Math.max(o,O),Math.min(M.y1,M.y2),Math.max(M.y1,M.y2))&&l&&m>=0&&p>=0)return e[p].length+=n,t+=l.x*n,o+=l.y*n,s[m].x2+=l.x*n,s[m].y2+=l.y*n,!0}return!1};var R=c;const h=e[d];if(h.type==="turn"){i+=h.angle;continue}if(h.type==="arc"){const P=t+h.radius*Math.cos(y(i+90)),L=o+h.radius*Math.sin(y(i+90)),C=Math.atan2(o-L,t-P)+y(h.arcAngle);t=P+h.radius*Math.cos(C),o=L+h.radius*Math.sin(C),i+=h.arcAngle,l=null;continue}for(;c(););const b={x:Math.cos(y(i)),y:Math.sin(y(i))},_=t+e[d].length*b.x,x=o+e[d].length*b.y,T=w(i);s.push({x1:t,y1:o,x2:_,y2:x,horiz:T,y:o,x:t}),l=b,m=s.length-1,p=d,t=_,o=x}return e}function V(r,a,n,e){const t=y(e),o=Math.cos(t),i=Math.sin(t),s=r.x-a,l=r.y-n;return{x:a+s*o-l*i,y:n+s*i+l*o}}function dt(r,a,n){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.setAttribute("viewBox","0 0 "+r+" "+a),e.setAttribute("preserveAspectRatio","xMidYMid meet"),e.style.width="100%",e.style.height="100%",e.style.display="block",e.style.background=n,e.style.shapeRendering="geometricPrecision",e.style.textRendering="optimizeLegibility",e.style.boxSizing="border-box",e}function Y(r,a,n,e,t,o,i){const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",a),s.setAttribute("y",n),s.setAttribute("fill",t||"black"),s.setAttribute("font-size",o||16),s.setAttribute("text-anchor",i||"middle"),s.setAttribute("alignment-baseline","middle"),s.style.pointerEvents="none",s.textContent=e,r.appendChild(s)}function ut(r,a,n,e){const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d",a),t.setAttribute("stroke",n),t.setAttribute("fill","none"),t.setAttribute("stroke-width",e||2),t.setAttribute("vector-effect","non-scaling-stroke"),r.appendChild(t),t}function ht(r,a){const n=Math.hypot(r,a)||1;let e=r/n,t=a/n;return(t<-1e-9||Math.abs(t)<=1e-9&&e<0)&&(e=-e,t=-t),{ux:e,uy:t}}function gt(r,a,n=.01){const e=ht(r,a),t=Math.round(e.ux/n)*n,o=Math.round(e.uy/n)*n;return t+"|"+o}function yt(r){const a=new Set,n=[];for(let e=0;e<r.length;e++){const t=r[e],o=t.p2.x-t.p1.x,i=t.p2.y-t.p1.y,s=gt(o,i),l=Math.round(t.length).toString(),m=s+"|"+l;a.has(m)||(a.add(m),n.push({p1:t.p1,p2:t.p2,label:l,length:t.length}))}return n}function mt(r,a,n,e,t){const o=n.x-a.x,i=n.y-a.y,s=Math.hypot(o,i)||1,l=i/s,m=-o/s,p=(a.x+n.x)/2,f=(a.y+n.y)/2,w=t*.8,v=p+l*w,R=f+m*w,d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",v),d.setAttribute("y",R),d.setAttribute("fill","black"),d.setAttribute("font-size",t),d.setAttribute("font-weight","bold"),d.setAttribute("text-anchor","middle"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=e,r.appendChild(d)}function pt(r,a,n,e,t,o,i,s,l){let m="",p=0,f=0,w=0,v=!1;function R(h,c){const b=V({x:h,y:c},a,n,e);return{x:s+(b.x-o)*t,y:l+(b.y-i)*t}}function d(){if(!v){const h=R(p,f);m+="M "+h.x+" "+h.y,v=!0}}for(let h=0;h<r.length;h++){const c=r[h];if(c.type==="turn"){w+=c.angle;continue}if(c.type==="line"){const b=p+c.length*Math.cos(y(w)),_=f+c.length*Math.sin(y(w));d();const x=R(b,_);m+=" L "+x.x+" "+x.y,p=b,f=_;continue}if(c.type==="arc"){const b=p+c.radius*Math.cos(y(w+90)),_=f+c.radius*Math.sin(y(w+90)),x=Math.atan2(f-_,p-b),T=x+y(c.arcAngle),P=b+c.radius*Math.cos(T),L=_+c.radius*Math.sin(T),O=Math.abs(c.arcAngle)%360;if(d(),O<1e-6||Math.abs(c.arcAngle)>=359.9){const C=x+Math.sign(c.arcAngle)*Math.PI,N=b+c.radius*Math.cos(C),M=_+c.radius*Math.sin(C),q=R(N,M),B=R(p,f),H=c.radius*t,J=c.arcAngle>=0?1:0;m+=" A "+H+" "+H+" 0 1 "+J+" "+q.x+" "+q.y,m+=" A "+H+" "+H+" 0 1 "+J+" "+B.x+" "+B.y}else{const C=R(P,L),N=c.radius*t,M=O>180?1:0,q=c.arcAngle>=0?1:0;m+=" A "+N+" "+N+" 0 "+M+" "+q+" "+C.x+" "+C.y}p=P,f=L,w+=c.arcAngle}}return m}function et(r){const a=at(r);if(a.length===0)return null;let n=a[0].x,e=a[0].x,t=a[0].y,o=a[0].y;for(const x of a)n=Math.min(n,x.x),e=Math.max(e,x.x),t=Math.min(t,x.y),o=Math.max(o,x.y);const i=e-n,s=o-t,l=(n+e)/2,m=(t+o)/2,p=0,f=0;let w=0;i<s&&(w=90);const v=a.map(x=>V(x,p,f,w));let R=v[0].x,d=v[0].x,h=v[0].y,c=v[0].y;for(const x of v)R=Math.min(R,x.x),d=Math.max(d,x.x),h=Math.min(h,x.y),c=Math.max(c,x.y);const b=(R+d)/2,_=(h+c)/2;return{w:i,h:s,minX:n,maxX:e,minY:t,maxY:o,midX:l,midY:m,midXRot:b,midYRot:_,cxModel:p,cyModel:f,rotDeg:w,wRot:d-R,hRot:c-h,ptsRot:v}}function nt(r,a,n,e,t){console.log("üé® dibujarFigura llamada:",{containerId:r,dimensionesStr:a,peso:n,diametro:e,barras:t});let o=document.getElementById(r);if(!o){console.error("‚ùå Contenedor no encontrado:",r);return}let i,s;if(o.tagName.toLowerCase()==="canvas"){console.log("üîÑ Detectado canvas, reemplazando por div contenedor"),i=o.width||parseInt(o.style.width)||240,s=o.height||parseInt(o.style.height)||120;const E=window.getComputedStyle(o),S=document.createElement("div");S.id=r,S.style.width="100%",S.style.height=E.height||s+"px",S.style.display="block",S.style.margin="0",S.style.padding="0",S.style.boxSizing="border-box",S.style.overflow="hidden",S.style.border=E.border||"1px solid #e5e7eb",S.style.borderRadius=E.borderRadius||"4px",S.style.background="white",S.className=o.className,o.parentNode.replaceChild(S,o),o=S;const W=S.getBoundingClientRect();i=W.width||i,s=W.height||s}else{const E=o.getBoundingClientRect();console.log("üîç getBoundingClientRect:",E),console.log("üîç contenedor.style:",{width:o.style.width,height:o.style.height}),i=E.width>0?E.width:parseInt(o.style.width)||600,s=E.height>0?E.height:parseInt(o.style.height)||400}console.log("üìê Dimensiones finales del contenedor:",{ancho:i,alto:s});const l=dt(i,s,"white"),m=st(a);if(console.log("üìê Dimensiones extra√≠das:",m),m.length===0){console.warn("‚ö†Ô∏è No hay dimensiones v√°lidas para dibujar."),Y(l,i/2,s/2,"Sin dimensiones v√°lidas","#FF0000",16,"middle"),o.innerHTML="",o.appendChild(l);return}const p=ct(m);console.log("üîß Dimensiones combinadas:",p);let f=0;for(const E of p)E.type==="line"&&(f=Math.max(f,Math.abs(E.length||0))),E.type==="arc"&&(f=Math.max(f,Math.abs(E.radius||0)));const w=f<=I,v=w?U:1,R=rt(p,v);console.log("üìè Max linear:",f,"isSmall:",w,"geomScale:",v);const d=et(R);if(!d){console.warn("‚ö†Ô∏è No se pudo medir la figura."),Y(l,i/2,s/2,"Error al medir figura","#FF0000",16,"middle"),o.innerHTML="",o.appendChild(l);return}console.log("üìä Medida inicial:",d);const h=lt(R,K),c=et(h);console.log("üìä Medida ajustada:",c);const b=c.wRot||1,_=c.hRot||1,x=.15,T=i*(1-x),P=s*(1-x);let L=Math.min(T/b,P/_);(i<300||s<150)&&(L*=.95),console.log("üîç Escala calculada:",L,"wRot:",b,"hRot:",_,"availableWidth:",T,"availableHeight:",P);const O=i/2,C=s/2,N=pt(h,c.cxModel,c.cyModel,c.rotDeg,L,c.midXRot,c.midYRot,O,C);if(console.log("üé® Path generado:",N),N&&N.length>0){const E=i<300?1.5:2;if(ut(l,N,$,E),console.log("‚úÖ Path dibujado correctamente con grosor:",E),console.log("üîç Verificando acotaciones:",{ancho:i,alto:s,cumpleCondicion:i>150&&s>80}),i>150&&s>80){let W=function(A,u){const j=V({x:A,y:u},c.cxModel,c.cyModel,c.rotDeg);return{x:O+(j.x-c.midXRot)*L,y:C+(j.y-c.midYRot)*L}};var J=W;console.log("‚úÖ Dibujando acotaciones...");const S=i<300?8:10,ot=[],it=[];let k=0,F=0,D=0;for(let A=0;A<h.length;A++){const u=h[A];if(u.type==="line"){const j={x:k,y:F};k+=u.length*Math.cos(y(D)),F+=u.length*Math.sin(y(D));const z={x:k,y:F},Q=W(j.x,j.y),X=W(z.x,z.y);ot.push({p1:Q,p2:X,length:u.length})}else if(u.type==="turn")D+=u.angle;else if(u.type==="arc"){const j=k+u.radius*Math.cos(y(D+90)),z=F+u.radius*Math.sin(y(D+90)),X=Math.atan2(F-z,k-j)+y(u.arcAngle);k=j+u.radius*Math.cos(X),F=z+u.radius*Math.sin(X),D+=u.arcAngle}}k=0,F=0,D=0;for(let A=0;A<p.length;A++){const u=p[A];if(u.type==="line")it.push({length:u.length}),k+=u.length*Math.cos(y(D)),F+=u.length*Math.sin(y(D));else if(u.type==="turn")D+=u.angle;else if(u.type==="arc"){const j=k+u.radius*Math.cos(y(D+90)),z=F+u.radius*Math.sin(y(D+90)),X=Math.atan2(F-z,k-j)+y(u.arcAngle);k=j+u.radius*Math.cos(X),F=z+u.radius*Math.sin(X),D+=u.arcAngle}}const ft=ot.map((A,u)=>{var j;return{p1:A.p1,p2:A.p2,length:((j=it[u])==null?void 0:j.length)||A.length}}),Z=yt(ft);console.log("üìä Segmentos √∫nicos para acotar:",Z.length,Z),Z.forEach((A,u)=>{console.log(`üìè Dibujando acotaci√≥n ${u}:`,A.label),mt(l,A.p1,A.p2,A.label,S)}),console.log("‚úÖ Acotaciones completadas")}else console.log("‚ö†Ô∏è Contenedor muy peque√±o para acotaciones")}else console.error("‚ùå Path vac√≠o"),Y(l,i/2,s/2,"Path vac√≠o","#FF0000",16,"middle");console.log("üìù Informaci√≥n a mostrar:",{peso:n,diametro:e,barras:t,ancho:i,alto:s});const M=i<300?10:12,q=15;let B=25;const H=M+8;n&&(Y(l,q,B,`Peso: ${n} kg`,"#333333",M,"start"),B+=H),e&&(Y(l,q,B,`√ò: ${e} mm`,"#333333",M,"start"),B+=H),t&&Y(l,q,B,`Barras: ${t}`,"#333333",M,"start"),o.innerHTML="",o.appendChild(l),console.log("‚úÖ SVG agregado al contenedor")}window.dibujarFiguraElemento=nt,document.querySelectorAll(".abrir-modal-dibujo").forEach(r=>{r.addEventListener("click",function(a){a.preventDefault();const n=this.getAttribute("data-dimensiones"),e=this.getAttribute("data-peso")||"N/A";g.classList.remove("hidden");let t=document.getElementById("svg-dibujo-container");if(!t){const o=document.getElementById("canvas-dibujo");o&&o.parentNode?(t=document.createElement("div"),t.id="svg-dibujo-container",t.style.width="100%",t.style.height="100%",o.style.display="none",o.parentNode.insertBefore(t,o)):(t=document.createElement("div"),t.id="svg-dibujo-container",t.style.width="100%",t.style.minHeight="200px",g.querySelector(".modal-content")?g.querySelector(".modal-content").appendChild(t):g.appendChild(t))}nt("svg-dibujo-container",n,e)})}),G&&G.addEventListener("click",function(){g.classList.add("hidden")}),g&&g.addEventListener("click",function(r){r.target===g&&g.classList.add("hidden")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",tt):tt();document.addEventListener("livewire:navigated",tt);
