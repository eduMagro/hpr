const q=()=>window.AppPlanif,M=()=>q().csrf,j=()=>q().routes,X=()=>{var o;const n=q()||{};let c=n.turnos;return Array.isArray(c)||(c=((o=n.turnosConfig)==null?void 0:o.turnos)||[]),{maquinas:n.maquinas||[],eventos:n.eventos||[],cargaTrabajo:n.cargaTrabajo||{},turnos:c}};let P=null;function S(){P&&(P.remove(),P=null,document.removeEventListener("click",S),document.removeEventListener("scroll",S,!0),window.removeEventListener("resize",S))}function L(n,c,o){S();const i=document.createElement("div");i.className="fc-contextmenu",Object.assign(i.style,{position:"fixed",zIndex:9999,minWidth:"240px",background:"#fff",border:"1px solid #e5e7eb",boxShadow:"0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05)",borderRadius:"8px",overflow:"hidden",visibility:"hidden"}),i.innerHTML=o,document.body.appendChild(i);const u=i.getBoundingClientRect(),a=window.innerHeight,d=window.innerWidth;let s=c;c+u.height>a&&(s=c-u.height,s<0&&(s=Math.max(0,a-u.height)));let f=n;return n+u.width>d&&(f=n-u.width,f<0&&(f=Math.max(0,d-u.width))),Object.assign(i.style,{top:s+"px",left:f+"px",visibility:"visible"}),P=i,setTimeout(()=>{document.addEventListener("click",S),document.addEventListener("scroll",S,!0),window.addEventListener("resize",S)},0),i}function V(n,c,{headerHtml:o="",items:i=[]}){const u=`
    <div class="ctx-menu-container">
      ${o?`<div class="ctx-menu-header">${o}</div>`:""}
      ${i.map((d,s)=>`
        <button class="ctx-menu-item${d.danger?" ctx-menu-danger":""}${d.disabled?" ctx-menu-disabled":""}" data-idx="${s}" ${d.disabled?"disabled":""}>
          ${d.icon?`<span class="ctx-menu-icon">${d.icon}</span>`:""}
          <span class="ctx-menu-label">${d.label}</span>
        </button>
      `).join("")}
    </div>
  `,a=L(n,c,u);return a.querySelectorAll(".ctx-menu-item").forEach(d=>{const s=parseInt(d.dataset.idx,10),f=i[s];d.addEventListener("click",async w=>{if(w.preventDefault(),w.stopPropagation(),console.log("[baseMenu] Click en item:",f.label,"disabled:",f.disabled),f.disabled){console.log("[baseMenu] Item deshabilitado, ignorando");return}const g=f.onClick;console.log("[baseMenu] Ejecutando acci√≥n..."),S();try{await(g==null?void 0:g()),console.log("[baseMenu] Acci√≥n completada")}catch(m){console.error("[baseMenu] Error en acci√≥n:",m)}})}),a}async function B(n,c={}){const o={headers:{Accept:"application/json","X-CSRF-TOKEN":M()},...c};o.body&&typeof o.body!="string"&&(o.headers["Content-Type"]="application/json",o.body=JSON.stringify(o.body));const i=await fetch(n,o);let u=null;try{u=await i.json()}catch{}if(!i.ok)throw new Error((u==null?void 0:u.message)||`HTTP ${i.status}`);return u}async function W(n){const c=await Swal.fire({title:"Nuevo festivo",input:"text",inputLabel:"T√≠tulo del festivo",inputValue:"Festivo",showCancelButton:!0,confirmButtonText:"Crear",cancelButtonText:"Cancelar",inputValidator:i=>!i||!i.trim()?"Pon un t√≠tulo":void 0});return c.isConfirmed?(await B(j().festivo.store,{method:"POST",body:{fecha:n,titulo:c.value.trim()}})).festivo:null}function K(n){var i,u,a;if(!n)return null;const[c]=n.split(":").map(Number),o=((u=(i=window.AppPlanif)==null?void 0:i.turnosConfig)==null?void 0:u.turnos)||((a=window.AppPlanif)==null?void 0:a.turnos)||[];for(const d of o){if(!d.hora_inicio||!d.hora_fin)continue;const[s]=d.hora_inicio.split(":").map(Number),[f]=d.hora_fin.split(":").map(Number),w=f<s;let g=!1;if(w?g=c>=s||c<f:g=c>=s&&c<f,g)return d.nombre}return c>=0&&c<8?"noche":c>=8&&c<16?"ma√±ana":"tarde"}async function Y(n,c,o,i=null){const u=K(i);console.log("[generarTurnos] horaISO:",i,"turnoDetectado:",u);let a=[],d=[],s=[];try{const e=await fetch(`/api/usuarios/operarios-agrupados?fecha=${n}&maquina_id=${c}`,{headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"}});if(e.ok){const r=await e.json();a=r.todos||[],d=r.sin_turno||[],s=r.de_maquina||[]}else console.error("Error al obtener operarios:",e.status)}catch(e){console.error("Error al obtener operarios:",e)}const f=(e,r="No hay trabajadores")=>e.length===0?`<option value="" disabled>${r}</option>`:e.map(l=>`<option value="${l.id}">${l.name} ${l.primer_apellido||""} ${l.segundo_apellido||""}</option>`).join(""),w=f(d,"No hay operarios sin turno este d√≠a"),g=f(a,"No hay operarios disponibles"),m=f(s,"No hay operarios asignados a esta m√°quina"),C=u?`<span class="text-green-600 font-semibold">${u.charAt(0).toUpperCase()+u.slice(1)}</span>`:'<span class="text-gray-400">No detectado</span>',{value:t}=await Swal.fire({title:"üîß Generar Turnos",html:`
            <div class="text-left space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha inicio:</strong> ${n}<br>
                        <strong>M√°quina:</strong> ${o}<br>
                        <strong>Turno detectado:</strong> ${C}
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Sin turno asignado este d√≠a <span class="text-green-600">(${d.length})</span>
                    </label>
                    <select id="swal-trabajador-sin-turno" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${w}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Asignados a ${o} <span class="text-blue-600">(${s.length})</span>
                    </label>
                    <select id="swal-trabajador-maquina" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${m}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Todos los operarios <span class="text-gray-600">(${a.length})</span>
                    </label>
                    <select id="swal-trabajador-todos" class="swal2-input w-full">
                        <option value="" selected>Seleccionar...</option>
                        ${g}
                    </select>
                </div>

                <input type="hidden" id="swal-trabajador" value="" />
                <input type="hidden" id="swal-turno-detectado" value="${u||""}" />

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Alcance de generaci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-alcance" class="swal2-input w-full">
                        <option value="un_dia">Solo este d√≠a (${n})</option>
                        <option value="dos_semanas">Hasta el viernes de la semana siguiente</option>
                        <option value="resto_a√±o">Desde ${n} hasta fin de a√±o</option>
                    </select>
                </div>

                <div class="mb-4" id="turno-inicio-container" style="display: ${u?"none":"block"};">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Turno inicial (para diurnos) <span class="text-red-500">*</span>
                    </label>
                    <select id="swal-turno-inicio" class="swal2-input w-full">
                        <option value="ma√±ana" ${u==="ma√±ana"?"selected":""}>Ma√±ana</option>
                        <option value="tarde" ${u==="tarde"?"selected":""}>Tarde</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Los turnos alternar√°n cada viernes</p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">
                        <strong>Nota:</strong> Se saltar√°n autom√°ticamente s√°bados, domingos, festivos y d√≠as con vacaciones.
                    </p>
                </div>
            </div>
        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Generar Turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",width:"600px",didOpen:()=>{const e=document.getElementById("swal-trabajador"),r=document.getElementById("turno-inicio-container"),l=document.getElementById("swal-trabajador-sin-turno"),b=document.getElementById("swal-trabajador-maquina"),p=document.getElementById("swal-trabajador-todos"),v=[...d,...s,...a];function y(h,x){e.value=h,x!==l&&(l.value=""),x!==b&&(b.value=""),x!==p&&(p.value="");const T=v.find(_=>_.id===parseInt(h));T&&T.turno==="diurno"?r.style.display="block":r.style.display="none"}l.addEventListener("change",h=>{h.target.value&&y(h.target.value,l)}),b.addEventListener("change",h=>{h.target.value&&y(h.target.value,b)}),p.addEventListener("change",h=>{h.target.value&&y(h.target.value,p)})},preConfirm:()=>{const e=document.getElementById("swal-trabajador").value,r=document.getElementById("swal-alcance").value,l=document.getElementById("swal-turno-inicio").value,b=document.getElementById("swal-turno-detectado").value;return e?{trabajador_id:e,alcance:r,turno_inicio:l,turno_detectado:b||null}:(Swal.showValidationMessage("Debes seleccionar un trabajador"),!1)}});if(!t)return null;try{const r=[...d,...s,...a].find(v=>v.id===parseInt(t.trabajador_id)),b=await fetch("/profile/generar-turnos-calendario",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json"},body:JSON.stringify({user_id:t.trabajador_id,maquina_id:c,fecha_inicio:n,alcance:t.alcance,turno_inicio:t.turno_inicio,turno_detectado:t.turno_detectado})}),p=await b.json();if(console.log("[generarTurnos] Respuesta backend:",p),p.eventos&&p.eventos.length>0&&console.log("[generarTurnos] Primer evento:",p.eventos[0]),!b.ok)throw new Error(p.message||`Error HTTP ${b.status}`);return{...p,eventos:p.eventos||[]}}catch(e){return console.error("Error al generar turnos:",e),await Swal.fire({icon:"error",title:"Error",text:e.message||"No se pudieron generar los turnos",confirmButtonText:"Aceptar"}),null}}async function F({fromISO:n,toISO:c,calendar:o,maquinaId:i=null}){if(await Swal.fire({icon:"question",title:"Copiar registros",html:`¬øCopiar registros de <b>${n}</b> a <b>${c}</b>?<br><small class="text-gray-500">Se guardar√°n en la base de datos</small>`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar"}).then(a=>a.isConfirmed))try{const a=await fetch("/asignaciones-turno/copiar-dia",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":M(),Accept:"application/json"},body:JSON.stringify({fecha_origen:n,fecha_destino:c,maquina_id:i})}),d=await a.json();if(!a.ok)throw new Error(d.message||`Error HTTP ${a.status}`);d.eventos&&d.eventos.length>0&&d.eventos.forEach(s=>{o.addEvent({id:s.id,title:s.title,start:s.start,end:s.end,resourceId:s.resourceId,backgroundColor:s.backgroundColor,borderColor:s.borderColor,textColor:s.textColor||"#000000",extendedProps:s.extendedProps||{}})}),Swal.fire({icon:"success",title:"Copiado completado",html:`Se han copiado <b>${d.copiadas||0}</b> registros a ${c}.`,timer:1800,showConfirmButton:!1})}catch(a){console.error("Error al copiar d√≠a:",a),Swal.fire({icon:"error",title:"Error al copiar",text:a.message||"No se pudieron copiar los registros."})}}async function H({maquinaId:n,maquinaNombre:c,fechaISO:o,duracionSemanas:i,calendar:u}){const a=i===1?"la semana actual":"las pr√≥ximas 2 semanas";if(await Swal.fire({icon:"question",title:"Copiar semana anterior",html:`¬øCopiar los turnos de la semana anterior de <b>${c}</b> para ${a}?`,showCancelButton:!0,confirmButtonText:"Copiar",cancelButtonText:"Cancelar",confirmButtonColor:"#3b82f6"}).then(s=>s.isConfirmed))try{const s=new Date(o),f=s.getDay(),w=f===0?-6:1-f,g=new Date(s);g.setDate(s.getDate()+w);const m=g.toISOString().slice(0,10),C=await fetch("/asignaciones-turno/repetir-semana-maquina",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":M(),Accept:"application/json"},body:JSON.stringify({maquina_id:n,semana_inicio:m,duracion_semanas:i})}),t=await C.json();if(!C.ok)throw new Error(t.message||`Error HTTP ${C.status}`);t.eventos&&t.eventos.length>0&&t.eventos.forEach(e=>{u.getEventById(e.id)||u.addEvent({id:e.id,title:e.title,start:e.start,end:e.end,resourceId:e.resourceId,backgroundColor:e.backgroundColor,borderColor:e.borderColor,textColor:e.textColor||"#000000",extendedProps:e.extendedProps||{}})}),await Swal.fire({icon:"success",title:"Turnos copiados",html:`Se han copiado <b>${t.turnos_creados||0}</b> turnos correctamente.`,timer:2e3,showConfirmButton:!1})}catch(s){console.error("Error al copiar turnos:",s),await Swal.fire({icon:"error",title:"Error",text:s.message||"No se pudieron copiar los turnos",confirmButtonText:"Aceptar"})}}function J(n,c,{fechaISO:o,resourceId:i,horaISO:u},a,d){var t;const s=new Date(o);s.setDate(s.getDate()-1);const f=new Date(o);f.setDate(f.getDate()+1);const w=s.toISOString().slice(0,10),g=f.toISOString().slice(0,10),m=i?((t=d.find(e=>String(e.id)===String(i)))==null?void 0:t.title)||`M√°quina ${i}`:"Seleccione una m√°quina",C=[{icon:"üìÖ",label:"Crear festivo este d√≠a",onClick:async()=>{const e=await W(o);if(!e)return;const r=new Date(e.fecha+"T00:00:00"),l=new Date(r);l.setDate(l.getDate()+1);const b=(d||[]).map(p=>p.id);a.addEvent({id:"festivo-"+e.id,title:e.titulo,start:r.toISOString(),end:l.toISOString(),allDay:!0,resourceIds:b,backgroundColor:"#ff0000",borderColor:"#b91c1c",textColor:"#ffffff",editable:!0,classNames:["evento-festivo"],extendedProps:{es_festivo:!0,festivo_id:e.id,entrada:null,salida:null}}),Swal.fire({icon:"success",title:"Festivo creado",timer:1200,showConfirmButton:!1})}},{icon:"‚¨ÖÔ∏è",label:`Copiar registros del d√≠a anterior (${w} ‚Üí ${o})`,onClick:()=>F({fromISO:w,toISO:o,calendar:a})},{icon:"‚û°Ô∏è",label:`Copiar registros del d√≠a siguiente (${g} ‚Üí ${o})`,onClick:()=>F({fromISO:g,toISO:o,calendar:a})},{icon:"üìÖ",label:i?`Copiar semana anterior ‚Üí semana actual (${m})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!i,onClick:()=>H({maquinaId:i,maquinaNombre:m,fechaISO:o,duracionSemanas:1,calendar:a})},{icon:"üìÖüìÖ",label:i?`Copiar semana anterior ‚Üí 2 semanas (${m})`:"Copiar semana anterior (seleccione una m√°quina)",disabled:!i,onClick:()=>H({maquinaId:i,maquinaNombre:m,fechaISO:o,duracionSemanas:2,calendar:a})},{icon:"üîß",label:i?`Generar turnos para ${m}`:"Generar turnos (seleccione una m√°quina)",disabled:!i,onClick:async()=>{var r,l;if(console.log("[menu] Click en generar turnos, resourceId:",i),!i){console.log("[menu] No hay resourceId, mostrando advertencia"),Swal.fire({icon:"warning",title:"M√°quina no seleccionada",text:"Haz clic derecho sobre una m√°quina espec√≠fica para generar turnos."});return}console.log("[menu] Llamando a generarTurnosDialog...");const e=await Y(o,i,m,u);if(console.log("[menu] Resultado del di√°logo:",e),e&&e.eventos){console.log("[menu] Procesando eventos:",e.eventos.length);const b=(l=(r=e.eventos[0])==null?void 0:r.extendedProps)==null?void 0:l.user_id;if(b){const p=a.getEvents(),v=e.eventos.map(y=>{var h;return(h=y.start)==null?void 0:h.slice(0,10)});p.forEach(y=>{var T,_,$,E;const h=(T=y.extendedProps)==null?void 0:T.user_id,x=((_=y.startStr)==null?void 0:_.slice(0,10))||(($=y.start)==null?void 0:$.toISOString().slice(0,10));h===b&&v.includes(x)&&!((E=y.extendedProps)!=null&&E.es_festivo)&&(console.log("[menu] Eliminando evento antiguo:",y.id),y.remove())})}e.eventos.forEach(p=>{console.log("[menu] A√±adiendo evento:",{id:p.id,start:p.start,end:p.end,resourceId:p.resourceId}),a.addEvent({id:p.id,title:p.title,start:p.start,end:p.end,resourceId:p.resourceId,backgroundColor:p.backgroundColor,borderColor:p.borderColor,textColor:p.textColor||"#000000",extendedProps:p.extendedProps||{}})}),console.log("[menu] Eventos actualizados correctamente")}}}];V(n,c,{headerHtml:`<div>Acciones para <b>${o}</b></div>`,items:C})}function G(n,c,{event:o,titulo:i}){L(n,c,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${i}
    </div>
    <button id="ctx-eliminar-festivo" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      üóëÔ∏è Eliminar festivo
    </button>
  `).querySelector("#ctx-eliminar-festivo").addEventListener("click",async()=>{if(S(),!await Swal.fire({icon:"warning",title:"Eliminar festivo",html:`<div>¬øSeguro que quieres eliminar <b>${i}</b>?</div>`,showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(s=>s.isConfirmed))return;const d=o.extendedProps.festivo_id;await B(j().festivo.delete.replace("__ID__",d),{method:"DELETE"}),o.remove(),Swal.fire({icon:"success",title:"Festivo eliminado",timer:1200,showConfirmButton:!1})})}async function U(n){const c=n.extendedProps||{},o=c.entrada||"",i=c.salida||"",u=await Swal.fire({title:"Editar fichaje",html:`
      <div class="flex flex-col gap-3">
        <label class="text-left text-sm">Entrada</label>
        <input id="entradaHora" type="time" class="swal2-input" value="${o}">
        <label class="text-left text-sm">Salida</label>
        <input id="salidaHora" type="time" class="swal2-input" value="${i}">
      </div>`,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",preConfirm:()=>{const d=document.getElementById("entradaHora").value,s=document.getElementById("salidaHora").value;return!d&&!s?(Swal.showValidationMessage("Debes indicar al menos una hora"),!1):{entrada:d,salida:s}}});if(!u.isConfirmed)return;const a=n.id.toString().replace(/^turno-/,"");await B(j().asignacion.updateHoras.replace("__ID__",a),{method:"POST",body:u.value}),n.setExtendedProp("entrada",u.value.entrada),n.setExtendedProp("salida",u.value.salida),Swal.fire({icon:"success",title:"Horas actualizadas",timer:1500,showConfirmButton:!1})}function Q(n,c,o){var s,f;const i=o.title||"Operario",u=((s=o.extendedProps)==null?void 0:s.categoria_nombre)??"",a=((f=o.extendedProps)==null?void 0:f.especialidad_nombre)??"Sin especialidad",d=L(n,c,`
    <div style="padding:10px 12px; font-size:13px; color:#6b7280; border-bottom:1px solid #f3f4f6;">
      ${i} <div style="font-size:12px">${u} ¬∑ ${a}</div>
    </div>
    <button id="ctx-editar-fichajes" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;">
      ‚úèÔ∏è Editar fichajes
    </button>
    <button id="ctx-eliminar-registro" style="display:block;width:100%;text-align:left;padding:10px 12px;font-size:14px;background:#fff;border:none;cursor:pointer;color:#b91c1c;">
      üóëÔ∏è Eliminar registro
    </button>
  `);d.querySelector("#ctx-editar-fichajes").addEventListener("click",async()=>{S(),await U(o)}),d.querySelector("#ctx-eliminar-registro").addEventListener("click",async()=>{var C;if(S(),!await Swal.fire({icon:"warning",title:"Eliminar registro",html:`<div>¬øSeguro que quieres eliminar este evento/asignaci√≥n?</div>
                   <div class="text-xs text-gray-500 mt-1">Esta acci√≥n no se puede deshacer.</div>`,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",showCancelButton:!0,confirmButtonColor:"#b91c1c"}).then(t=>t.isConfirmed))return;const g="/asignaciones-turnos/destroy",m={_method:"DELETE",fecha_inicio:o.startStr,fecha_fin:o.endStr??o.startStr,tipo:"eliminarTurnoEstado",user_id:(C=o.extendedProps)==null?void 0:C.user_id};console.log("[workerMenu] Eliminando turno, payload:",m),console.log("[workerMenu] Event extendedProps:",o.extendedProps);try{await B(g,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(m)}),o.remove(),Swal.fire({icon:"success",title:"Registro eliminado",timer:1300,showConfirmButton:!1})}catch(t){console.error("Error al eliminar el turno:",t),Swal.fire({icon:"error",title:"Error al eliminar",text:t.message||"No se pudo eliminar el turno."})}})}function Z(n,c){const o=[];if(!n||typeof n!="object")return o;const i=(c||[]).filter(a=>a.hora_inicio&&a.hora_fin);if(i.length===0)return o;const u={};i.forEach(a=>{const d=a.nombre.toLowerCase(),[s]=a.hora_inicio.split(":").map(Number),[f]=a.hora_fin.split(":").map(Number),w=f<s;let g,m;w?(g="00:00:00",m="00:30:00"):s<14?(g="08:00:00",m="08:30:00"):(g="16:00:00",m="16:30:00"),u[d]={esNocturno:w,slotInicio:g,slotFin:m,color:a.color}});for(const[a,d]of Object.entries(n))if(!(!d||typeof d!="object")){for(const[s,f]of Object.entries(d))if(f)for(const[w,g]of Object.entries(u)){const m=f[w]||0;m<=0||o.push({id:`carga-${a}-${s}-${w}`,title:`${m}h`,start:`${s}T${g.slotInicio}`,end:`${s}T${g.slotFin}`,resourceId:a,backgroundColor:R(m),borderColor:R(m),textColor:"#000",editable:!1,classNames:["evento-carga"],extendedProps:{es_carga:!0,turno:w,horas:m}})}}return o}function R(n){return n>6?"#fca5a5":n>3?"#fcd34d":"#86efac"}function ee(n){const c={slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[]};if(!n||n.length===0)return c;const o=n.filter(u=>u.hora_inicio&&u.hora_fin);return o.length===0?c:{slotMinTime:"00:00:00",slotMaxTime:"24:00:00",slotDuration:"08:00:00",turnos:[...o].sort((u,a)=>{const[d]=u.hora_inicio.split(":").map(Number),[s]=u.hora_fin.split(":").map(Number),[f]=a.hora_inicio.split(":").map(Number),[w]=a.hora_fin.split(":").map(Number),g=s<d,m=w<f;return g&&!m?-1:!g&&m?1:d-f})}}function te(n,c,o){const i=localStorage.getItem(n);return c.includes(i)?i:o}function oe(n){const{maquinas:c,eventos:o,cargaTrabajo:i,turnos:u}=X(),a=ee(u),d=Z(i,u),s=[...o,...d],f="vistaObras",w="fechaObras";let g=!1;const m=new FullCalendar.Calendar(n,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",locale:"es",initialView:te(f,["resourceTimelineDay","resourceTimelineWeek"],"resourceTimelineWeek"),initialDate:localStorage.getItem(w)||void 0,selectable:!0,unselectAuto:!0,datesSet(t){localStorage.setItem("vistaObras",t.view.type),localStorage.setItem("fechaObras",t.startStr);const e=t.view.type==="resourceTimelineDay";if(n.classList.toggle("vista-dia",e),n.classList.toggle("vista-semana",!e),e){const l=n.querySelector(".fc-toolbar-title");if(l){const b=t.start,p={weekday:"long",day:"numeric",month:"long",year:"numeric"};l.textContent=b.toLocaleDateString("es-ES",p)}}const r=document.getElementById("btnRepetirSemana");r&&(t.view.type==="resourceTimelineWeek"?(r.classList.remove("hidden"),r.dataset.fecha=t.startStr):r.classList.add("hidden"))},displayEventEnd:!0,eventMinHeight:30,firstDay:1,height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"resourceTimelineDay,resourceTimelineWeek"},buttonText:{today:"Hoy",week:"Semana",day:"D√≠a"},slotLabelDidMount(t){if(t.view.type==="resourceTimelineDay"&&a.turnos){const r=t.date.getHours();let l=0;r>=8&&r<16?l=1:r>=16&&(l=2);const b=a.turnos[l];b&&(t.el.style.backgroundColor=b.color||"#e5e7eb")}},slotLabelContent(t){if(t.view.type==="resourceTimelineDay"){const r=t.date.getHours();if(r===0)return{html:"<b>Noche</b>"};if(r===8)return{html:"<b>Ma√±ana</b>"};if(r===16)return{html:"<b>Tarde</b>"}}return null},views:{resourceTimelineDay:{slotMinTime:a.slotMinTime,slotMaxTime:a.slotMaxTime,slotDuration:a.slotDuration,titleFormat:{weekday:"long",day:"numeric",month:"long",year:"numeric"}},resourceTimelineWeek:{slotDuration:{days:1},slotLabelFormat:{weekday:"long"}}},editable:!0,resources:c,resourceOrder:"orden",resourceAreaWidth:"100px",resourceLabelDidMount(t){const e=t.resource.extendedProps.backgroundColor;e&&(t.el.style.backgroundColor=e,t.el.style.color="#fff")},filterResourcesWithEvents:!1,events:s,resourceAreaColumns:[{field:"title",headerContent:"M√°quinas"}],eventDragStart:t=>{g=!0;const e=t.el;e._tippy&&(e._tippy.hide(),e._tippy.disable()),document.querySelectorAll(".fc-event").forEach(r=>{r._tippy&&r._tippy.disable()})},eventDragStop:t=>{g=!1,setTimeout(()=>{document.querySelectorAll(".fc-event").forEach(l=>{l._tippy&&l._tippy.enable()});const e=t.el,r=t.event.extendedProps||{};if(!e._tippy&&r.foto&&!r.es_festivo){const l=`<img src="${r.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`;tippy(e,{content:l,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(g)return!1}})}},100)},eventDrop:async t=>{var l,b;const e=t.event,r=e.extendedProps||{};try{if(r.es_festivo){const k=e.startStr.slice(0,10);await fetch(j().festivo.update.replace("__ID__",r.festivo_id),{method:"PUT",headers:{"X-CSRF-TOKEN":window.AppPlanif.csrf,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({fecha:k})}).then(D=>{if(!D.ok)throw new Error(`HTTP ${D.status}`)});return}const p=e.id.replace(/^turno-/,""),v=(l=e.getResources())==null?void 0:l[0],y=v?parseInt(v.id,10):null,h=(b=e.start)==null?void 0:b.toISOString(),x=new Date(h).getHours();let T=null;for(const k of a.turnos){const[D]=k.hora_inicio.split(":").map(Number),[N]=k.hora_fin.split(":").map(Number),z=N<D;let I=!1;if(z?I=x>=D||x<N:I=x>=D&&x<N,I){T=k.id;break}}if(T||(T=x>=6&&x<14?1:x>=14&&x<22?2:3),!y||!h)throw new Error("Datos incompletos");const _=j().asignacion.updatePuesto.replace("__ID__",p),$=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppPlanif.csrf},body:JSON.stringify({maquina_id:y,start:h,turno_id:T})}),E=await $.json();if(!$.ok)throw new Error((E==null?void 0:E.message)||`HTTP ${$.status}`);E.color&&(e.setProp("backgroundColor",E.color),e.setProp("borderColor",E.color)),typeof E.nuevo_obra_id<"u"&&e.setExtendedProp("obra_id",E.nuevo_obra_id),e.setExtendedProp("turno_id",T);const O=a.turnos.find(k=>k.id===T);O&&e.setExtendedProp("turno_nombre",O.nombre),m.refetchEvents()}catch(p){console.error(p),Swal.fire("Error",p.message||"Ocurri√≥ un error inesperado.","error"),t.revert()}},eventDidMount(t){const e=t.event,r=e.extendedProps||{};if(r.es_carga){t.el.title=`${r.horas}h de trabajo - Turno ${r.turno}`;return}if(t.el._tippy&&t.el._tippy.destroy(),r.foto&&!r.es_festivo){const l=`<img src="${r.foto}" class="w-18 h-18 rounded-full object-cover ring-2 ring-blue-400 shadow-lg">`,b=tippy(t.el,{content:l,allowHTML:!0,placement:"top",theme:"transparent-avatar",interactive:!1,arrow:!1,delay:[100,0],offset:[0,10],onShow(){if(g)return!1}});g&&b&&b.disable()}t.el.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),r.es_festivo?G(l.clientX,l.clientY,{event:e,titulo:e.title}):Q(l.clientX,l.clientY,e)})},eventClick(t){const r=t.event.extendedProps||{};if(r.es_festivo)return;const l=r.user_id;if(l){const b=j().userShow.replace(":id",l);window.location.href=b}},eventContent(t){const e=t.event.extendedProps;if(e!=null&&e.es_carga)return{html:`<div class="carga-content">${e.horas}h</div>`};if(e!=null&&e.es_festivo)return{html:`<div class="px-2 py-1 text-xs font-semibold" style="color:#fff">${t.event.title}</div>`};const r=e.entrada&&e.salida?`${e.entrada} / ${e.salida}`:e.entrada||e.salida||"-- / --",l=e.turno_nombre?e.turno_nombre.charAt(0).toUpperCase()+e.turno_nombre.slice(1):"";return{html:`
          <div class="px-2 py-1 text-xs font-semibold flex items-center">
            <div class="flex flex-col">
              <span>${t.event.title} <span class="text-[10px] font-medium opacity-70">[${l}]</span></span>
              <span class="text-[10px] font-normal opacity-80">(${e.categoria_nombre??""} üõ† ${e.especialidad_nombre??"Sin especialidad"})</span>
            </div>
            <div class="ml-auto text-right">
              <span class="text-[10px] font-normal opacity-80">${r}</span>
            </div>
          </div>`}}});m.render(),console.log("[cal] Configurando event listener para contextmenu...");const C=m.el;return console.log("[cal] Elemento ra√≠z del calendario:",C),console.log("[cal] Agregando event listener de contextmenu al calendario"),C.addEventListener("contextmenu",t=>{if(console.log("[cal] ¬°Contextmenu disparado!",t.target),t.target.closest(".fc-event")){console.log("[cal] Es un evento, ignorando");return}t.preventDefault();let e=null,r=null,l=null;const b=t.target.closest("[data-date]");if(b){const v=b.getAttribute("data-date")||"";v.includes("T")?(r=v.slice(0,10),l=v.slice(11,16)):r=v.slice(0,10)}if(!l&&m.view.type==="resourceTimelineDay"){const v=m;if(v.getDate(),typeof v.el.getBoundingClientRect=="function"){v.el.getBoundingClientRect();const y=v.el.querySelector(".fc-timeline-body");if(y){const h=y.getBoundingClientRect(),x=t.clientX-h.left,T=h.width,_=x/T*24,$=Math.floor(_);l=String($).padStart(2,"0")+":00",console.log("[cal] Hora calculada por posici√≥n X:",l)}}}if(!r){console.log("[cal] No se pudo determinar la fecha");return}console.log("[cal] Fecha encontrada:",r,"Hora:",l),console.log("[cal] Elemento clickeado:",t.target),console.log("[cal] Elemento con data-date:",b);const p=C.querySelectorAll(".fc-timeline-lane[data-resource-id]");if(console.log("[cal] Filas de recursos encontradas:",p.length),p.length>0){const v=t.clientY;console.log("[cal] Posici√≥n Y del click:",v);for(const y of p){const h=y.getBoundingClientRect();if(console.log("[cal] Examinando lane con resource-id:",y.dataset.resourceId,"top:",h.top,"bottom:",h.bottom),v>=h.top&&v<=h.bottom){e=y.dataset.resourceId,console.log("[cal] ¬°ResourceId encontrado por posici√≥n Y!:",e);break}}}console.log("[cal] ResourceId final detectado:",e,"Fecha:",r,"Hora:",l),J(t.clientX,t.clientY,{fechaISO:r,resourceId:e,horaISO:l},m,c)}),console.log("[cal] Event listener de contextmenu agregado correctamente"),m}function A(){const n=document.getElementById("calendario");if(!n||n.getAttribute("data-calendar-type")!=="trabajadores"||!window.AppPlanif)return;if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}const c=oe(n);window.calendarTrabajadores=c}function ne(){if(window.calendarTrabajadores){try{window.calendarTrabajadores.destroy()}catch{}window.calendarTrabajadores=null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();document.addEventListener("livewire:navigated",A);document.addEventListener("livewire:navigating",ne);
