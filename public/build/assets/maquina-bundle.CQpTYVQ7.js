const He="rgba(0, 0, 0, 0.8)",Te="rgba(0, 0, 0, 1)",Ve="rgba(0, 0, 0, 1)";function Ye(v,r){return!r||r===1?v.map(i=>({...i})):v.map(i=>i.type==="line"?{...i,length:(i.length||0)*r}:i.type==="arc"?{...i,radius:(i.radius||0)*r}:{...i})}const We=.75,Pe=14,Je=60,Re=[0,10,-10,20,-20,30,-30];function U(v){return v*Math.PI/180}function Qe(v){const r=v.closest(".proceso");return r&&getComputedStyle(r).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Ke(v,r,i){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("viewBox","0 0 "+v+" "+r),s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.background=i||"#ffffff",s.style.shapeRendering="geometricPrecision",s.style.textRendering="optimizeLegibility",s.style.boxSizing="border-box",s}function Ze(v,r,i,s){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",r),n.setAttribute("stroke",i),n.setAttribute("fill","none"),n.setAttribute("stroke-width",s),n.setAttribute("vector-effect","non-scaling-stroke"),v.appendChild(n),n}function Fe(v){let r="",i=Number(v)||0;for(;i>=0;){const s=i%26;r=String.fromCharCode(65+s)+r,i=Math.floor(i/26)-1}return r}const et=0,tt=-25;function ot(v,r,i,s){if(!r||!r.length)return;const n=2,x=12,h=x+n,b=r.map(a=>(a.letter?a.letter+" ":"")+(a.text||"")),g=x*b.length+n*(b.length-1),E=et;let t=s-tt-g+x/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let a=0;a<b.length;a++){const o=b[a],c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("x",E),c.setAttribute("y",t),c.setAttribute("fill",Ve),c.setAttribute("font-size",x),c.setAttribute("text-anchor","start"),c.setAttribute("alignment-baseline","middle"),c.style.pointerEvents="none",c.textContent=o,v.appendChild(c);const l=$e(o,x).w;window.__legendBoxesGroup.push({left:E,right:E+l,top:t-x/2,bottom:t+x/2}),t+=h}}function at(v){const r=(v||"").split(/\s+/).filter(Boolean),i=[];for(let s=0;s<r.length;s++){const n=r[s];if(n.endsWith("r")){const x=parseFloat(n.slice(0,-1));let h=360;s+1<r.length&&r[s+1].endsWith("d")&&(h=parseFloat(r[++s].slice(0,-1))),i.push({type:"arc",radius:x,arcAngle:h})}else n.endsWith("d")?i.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):i.push({type:"line",length:parseFloat(n)})}return i}function nt(v){let r=[],i=0,s=0,n=0;r.push({x:i,y:s});for(let x=0;x<v.length;x++){const h=v[x];if(h.type==="line")i+=h.length*Math.cos(U(n)),s+=h.length*Math.sin(U(n)),r.push({x:i,y:s});else if(h.type==="turn")n+=h.angle;else if(h.type==="arc"){const b=i+h.radius*Math.cos(U(n+90)),g=s+h.radius*Math.sin(U(n+90)),E=Math.atan2(s-g,i-b),t=E+U(h.arcAngle);i=b+h.radius*Math.cos(t),s=g+h.radius*Math.sin(t),n+=h.arcAngle,r.push({x:i,y:s})}}return r}function je(v){let r=[],i=0,s=0,n=0;for(let x=0;x<v.length;x++){const h=v[x];if(h.type==="line"){const b={x:i,y:s},g={x:i+h.length*Math.cos(U(n)),y:s+h.length*Math.sin(U(n))};r.push({start:b,end:g,length:h.length}),i=g.x,s=g.y}else if(h.type==="turn")n+=h.angle;else if(h.type==="arc"){const b=i+h.radius*Math.cos(U(n+90)),g=s+h.radius*Math.sin(U(n+90)),E=Math.atan2(s-g,i-b),t=E+U(h.arcAngle);i=b+h.radius*Math.cos(t),s=g+h.radius*Math.sin(t),n+=h.arcAngle}}return r}function $e(v,r){const i=r||12;return{w:(v?v.length:0)*i*.55,h:i}}function ne(v,r,i){const s=i||0;return!(v.right+s<r.left||v.left-s>r.right||v.bottom+s<r.top||v.top-s>r.bottom)}function Ne(v,r,i,s){const n=r/2;return Math.max(i+n,Math.min(s-n,v))}function st(v,r){const s=[];let n=0;function x(){n>1e-9&&(s.push({type:"line",length:n}),n=0)}for(let h=0;h<v.length;h++){const b=v[h];if(b.type==="line"){n+=b.length;continue}if(b.type==="turn"){if(Math.abs(b.angle)<1e-9)continue;x(),s.push(b);continue}if(b.type==="arc"){x(),s.push(b);continue}x(),s.push(b)}return x(),s}function Xe(v,r){const i=r&&r.decimals||0,s=r&&r.step||null;let n=Number(v||0);return s&&s>0&&(n=Math.round(n/s)*s),n.toFixed(i).replace(/\.0+$/,"")}function it(v,r){const i=Math.hypot(v,r)||1;let s=v/i,n=r/i;return(n<-1e-9||Math.abs(n)<=1e-9&&s<0)&&(s=-s,n=-n),{ux:s,uy:n}}function Ue(v,r,i){const s=i||.01,n=it(v,r),x=Math.round(n.ux/s)*s,h=Math.round(n.uy/s)*s;return x+"|"+h}function rt(v,r,i){const s=i&&i.dirPrecision||.01,n=i&&i.labelFormat||{decimals:0,step:null},x=v.reduce((c,l)=>c+Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y),0),h=r.reduce((c,l)=>c+(l.length||Math.hypot(l.end.x-l.start.x,l.end.y-l.start.y)),0),b=h>0?x/h:1,g=new Map;for(let c=0;c<r.length;c++){const l=r[c],u=l.end.x-l.start.x,w=l.end.y-l.start.y,e=Ue(u,w,s),d=g.get(e)||[];d.push({length:l.length||Math.hypot(u,w),index:c}),g.set(e,d)}const E=r.map(c=>c.length||Math.hypot(c.end.x-c.start.x,c.end.y-c.start.y)),t=new Set,a=new Set,o=[];for(let c=0;c<v.length;c++){const l=v[c],u=l.end.x-l.start.x,w=l.end.y-l.start.y,e=Ue(u,w,s),d=g.get(e)||[],p=Math.hypot(u,w);let m=p;if(d.length){const C=p/b;let q=null,_=1/0;for(const S of d){const M=Math.abs(S.length-C),$=a.has(S.index)?.1:0;M+$<_&&(q=S,_=M+$)}q&&(m=q.length,a.add(q.index))}else c<E.length&&(m=E[c]);const y=Xe(m,n),f=e+"|"+y;t.has(f)||(t.add(f),o.push({start:l.start,end:l.end,_dirKey:e,_label:y,_lenChosen:m}))}return o}function ct(v,r){const i=r,s=v.map(w=>Object.assign({},w));let n=0,x=0,h=0;const b=[];let g=null,E=-1,t=-1;const a=1e-7;function o(w){return w*Math.PI/180}function c(w){return Math.abs(Math.sin(o(w)))<1e-12}function l(w,e,d,p){return Math.min(e,p)-Math.max(w,d)>a}for(let w=0;w<s.length;w++){let d=function(){const q={x:Math.cos(o(h)),y:Math.sin(o(h))},_=n+s[w].length*q.x,S=x+s[w].length*q.y,M=c(h);for(let $=0;$<b.length;$++){const I=b[$];if(M&&I.horiz&&Math.abs(x-I.y)<a){if(l(Math.min(n,_),Math.max(n,_),Math.min(I.x1,I.x2),Math.max(I.x1,I.x2))&&g&&E>=0&&t>=0)return s[t].length+=i,n+=g.x*i,x+=g.y*i,b[E].x2+=g.x*i,b[E].y2+=g.y*i,!0}else if(!M&&!I.horiz&&Math.abs(n-I.x)<a&&l(Math.min(x,S),Math.max(x,S),Math.min(I.y1,I.y2),Math.max(I.y1,I.y2))&&g&&E>=0&&t>=0)return s[t].length+=i,n+=g.x*i,x+=g.y*i,b[E].x2+=g.x*i,b[E].y2+=g.y*i,!0}return!1};var u=d;const e=s[w];if(e.type==="turn"){h+=e.angle;continue}if(e.type==="arc"){const q=n+e.radius*Math.cos(o(h+90)),_=x+e.radius*Math.sin(o(h+90)),S=Math.atan2(x-_,n-q),M=S+o(e.arcAngle);n=q+e.radius*Math.cos(M),x=_+e.radius*Math.sin(M),h+=e.arcAngle,g=null;continue}let p=0;for(;d()&&p<3;)p++;const m={x:Math.cos(o(h)),y:Math.sin(o(h))},y=n+s[w].length*m.x,f=x+s[w].length*m.y,C=c(h);b.push({x1:n,y1:x,x2:y,y2:f,horiz:C,y:x,x:n}),g=m,E=b.length-1,t=w,n=y,x=f}return s}function Ae(v,r,i,s){const n=U(s),x=Math.cos(n),h=Math.sin(n),b=v.x-r,g=v.y-i;return{x:r+b*x-g*h,y:i+b*h+g*x}}function lt(v,r,i,s,n,x,h,b,g){let E="",t=0,a=0,o=0,c=!1;function l(w,e){const d=Ae({x:w,y:e},r,i,s);return{x:b+(d.x-x)*n,y:g+(d.y-h)*n}}function u(){if(!c){const w=l(t,a);E+="M "+w.x+" "+w.y,c=!0}}for(let w=0;w<v.length;w++){const e=v[w];if(e.type==="turn"){o+=e.angle;continue}if(e.type==="line"){const d=t+e.length*Math.cos(U(o)),p=a+e.length*Math.sin(U(o));u();const m=l(d,p);E+=" L "+m.x+" "+m.y,t=d,a=p;continue}if(e.type==="arc"){const d=t+e.radius*Math.cos(U(o+90)),p=a+e.radius*Math.sin(U(o+90)),m=Math.atan2(a-p,t-d),y=m+U(e.arcAngle),f=d+e.radius*Math.cos(y),C=p+e.radius*Math.sin(y),q=Math.abs(e.arcAngle)%360;if(u(),q<1e-6||Math.abs(e.arcAngle)>=359.9){const I=m+Math.sign(e.arcAngle)*Math.PI,R=d+e.radius*Math.cos(I),L=p+e.radius*Math.sin(I),A=l(R,L),N=l(t,a),B=e.radius*n,O=e.arcAngle>=0?1:0;E+=" A "+B+" "+B+" 0 1 "+O+" "+A.x+" "+A.y,E+=" A "+B+" "+B+" 0 1 "+O+" "+N.x+" "+N.y,o+=e.arcAngle;continue}const _=l(f,C),S=e.radius*n,M=q>180?1:0,$=e.arcAngle>=0?1:0;E+=" A "+S+" "+S+" 0 "+M+" "+$+" "+_.x+" "+_.y,t=f,a=C,o+=e.arcAngle}}return E||"M 0 0"}function dt(v){const r=nt(v);let i=Math.min(...r.map(u=>u.x)),s=Math.max(...r.map(u=>u.x)),n=Math.min(...r.map(u=>u.y)),x=Math.max(...r.map(u=>u.y));const h=(i+s)/2,b=(n+x)/2,E=x-n>s-i?-90:0,t=r.map(u=>Ae(u,h,b,E));i=Math.min(...t.map(u=>u.x)),s=Math.max(...t.map(u=>u.x)),n=Math.min(...t.map(u=>u.y)),x=Math.max(...t.map(u=>u.y));const a=Math.max(1,s-i),o=Math.max(1,x-n),c=(i+s)/2,l=(n+x)/2;return{rotDeg:E,w:a,h:o,cxModel:h,cyModel:b,midX:c,midY:l,ptsRot:t}}function ut(v){const r=[];let i=0,s=0,n=0;function x(h){const b=U(h);return{x:Math.cos(b),y:Math.sin(b)}}for(let h=0;h<v.length;h++){const b=v[h];if(b.type==="line")i+=b.length*Math.cos(U(n)),s+=b.length*Math.sin(U(n));else if(b.type==="turn"){const g=x(n),E=b.angle;n+=E;const t=x(n);r.push({x:i,y:s,angleDeg:E,prevDir:g,nextDir:t})}else if(b.type==="arc"){const g=i+b.radius*Math.cos(U(n+90)),E=s+b.radius*Math.sin(U(n+90)),t=Math.atan2(s-E,i-g),a=t+U(b.arcAngle);i=g+b.radius*Math.cos(a),s=E+b.radius*Math.sin(a),n+=b.arcAngle}}return r}function pt(v,r,i){const s=Array.from({length:r},()=>({sumH:0,maxW:0,items:[]})),n=[...v.keys()].sort((x,h)=>v[h].h-v[x].h);for(const x of n){let h=0,b=1/0;for(let E=0;E<r;E++){const t=s[E],a=t.sumH+(t.items.length>0?i:0)+v[x].h;a<b&&(b=a,h=E)}const g=s[h];g.sumH=g.items.length>0?g.sumH+i+v[x].h:g.sumH+v[x].h,g.maxW=Math.max(g.maxW,v[x].w),g.items.push(x)}return s}function mt(v,r,i,s={}){const n=s.padding??12,x=s.gapCol??12,h=s.gapRow??10,b=Math.max(1,Math.min(v.length,s.kMax??4)),g=Math.max(10,r-2*n),E=Math.max(10,i-2*n),t=a(v);function a(d){const p=d.map(B=>B.w/Math.max(B.h,1)),m=d.map(B=>B.h),y=d.map(B=>B.w),f=d.map(B=>B.w*B.h),C=B=>B.reduce((O,k)=>O+k,0)/B.length,q=(B,O)=>B.reduce((k,P)=>k+Math.pow(P-O,2),0)/B.length,_=(B,O)=>Math.sqrt(q(B,O)),S=C(p),M=C(m),$=C(y),I=f.reduce((B,O)=>B+O,0),R=_(m,M),L=_(y,$),A=M>0?R/M:0,N=$>0?L/$:0;return{avgAspectRatio:S,avgHeight:M,avgWidth:$,totalArea:I,heightCV:A,widthCV:N,isLinear:S>6||M<$*.12,isUniformHeight:A<.15,isUniformWidth:N<.15,isHighlyVariable:A>.5||N>.5,count:d.length}}let o={S:0,k:1,cols:null,score:0};for(let d=1;d<=b;d++){const p=pt(v,d,h),m=p.reduce((P,W)=>P+W.maxW,0)+x*(d-1),y=Math.max(...p.map(P=>P.sumH));if(m<=0||y<=0)continue;const f=g/m,C=E/y,q=Math.min(f,C),_=Math.max(.01,q*.92),S=t.totalArea*_*_,M=g*E,$=S/M,I=p.map(P=>P.sumH*_),R=I.reduce((P,W)=>P+W,0)/d,L=Math.max(...I)-Math.min(...I),A=R>0?1-L/R:1,N=d===1?1.1:d===2?.9:.7,B=d>t.count*.5?.7:1,O=A>.85?1.05:1,k=_*(1+$*.25)*(1+A*.1)*N*B*O;k>o.score&&(o={S:_,k:d,cols:p,score:k,efficiency:$,colBalance:A})}const c=o.cols.map(d=>d.maxW*o.S),l=c.reduce((d,p)=>d+p,0);let u=[];if(o.k===1)u[0]=r/2;else{const d=(o.k-1)*x,p=l+d;if(p<g){const m=g-p,y=x+m/(o.k-1);let f=n;for(let C=0;C<o.k;C++)u[C]=f+c[C]/2,f+=c[C]+y}else{let m=n+Math.max(0,(g-p)/2);for(let y=0;y<o.k;y++)u[y]=m+c[y]/2,m+=c[y]+x}}const w=[],e=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(d=>d.right));for(let d=0;d<o.k;d++){const p=o.cols[d];w[d]=[];const m=p.items.map(L=>v[L].h*o.S),y=m.reduce((L,A)=>L+A,0);if(p.items.length===0)continue;const f=u[d],C=o.cols[d].maxW*o.S,q=f-C/2,_=f+C/2,S=e(),I=Math.max(0,Math.min(_,S)-q)/C>.05;let R=E;if(I&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const A=Math.min(...window.__legendBoxesGroup.map(N=>N.top))-15;R=Math.max(10,A-n)}if(p.items.length===1){const L=m[0],N=n+R-L/2-10,B=Math.max(n+L/2,Math.min(N,i-n-L/2));w[d].push(B);continue}if(y>R){console.warn(`Columna ${d}: elementos no caben (${y}px > ${R}px)`);const N=y/p.items.length<4?20:5;let B=n;for(let O=0;O<p.items.length;O++){const k=Math.max(m[O],2),P=B+k/2;w[d].push(P),B+=k+N}}else{const L=R-y,A=p.items.length-1;let N=L/A;y/p.items.length<4?N=Math.max(18,Math.min(N,50)):N=Math.max(5,N);const k=y+A*N,P=R-k;let de=n+Math.max(0,P-10);for(let Ee=0;Ee<p.items.length;Ee++){const z=Math.max(m[Ee],2),ue=de+z/2,he=n+R-z/2,T=Math.max(n+z/2,Math.min(ue,he));w[d].push(T),de+=z+N}}}return{S:o.S,k:o.k,cols:o.cols,centersX:u,centersYByCol:w,padding:n,gapRow:h,gapCol:x}}window.renderizarGrupoSVG=function(r,i){const s=r&&r.etiqueta&&r.etiqueta.id!=null?r.etiqueta.id:r&&r.id!=null?r.id:i,n=document.getElementById("contenedor-svg-"+s);if(!n)return;const x=n.getBoundingClientRect(),h=x.width>0?x.width:600,b=x.height>0?x.height:150;console.log("üìê SVG container:",s,"dims:",h,"x",b);const g=Qe(n),E=Ke(h,b,g);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const t=[],a=new Map;(r.elementos||[]).forEach(e=>{var y,f,C,q,_,S;let d="0";if(e.diametro!=null&&e.diametro!==""){const $=String(e.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if($){const I=parseFloat($[0]);isFinite(I)&&(d=String(Math.round(I)))}}const p=(e.dimensiones||"barra").trim().toLowerCase(),m=`${d}|${p}`;if(a.has(m)){const M=a.get(m);t[M].barrasTotal+=e.barras||0,(y=e.coladas)!=null&&y.colada1&&!t[M].coladasSet.has(e.coladas.colada1)&&t[M].coladasSet.add(e.coladas.colada1),(f=e.coladas)!=null&&f.colada2&&!t[M].coladasSet.has(e.coladas.colada2)&&t[M].coladasSet.add(e.coladas.colada2),(C=e.coladas)!=null&&C.colada3&&!t[M].coladasSet.has(e.coladas.colada3)&&t[M].coladasSet.add(e.coladas.colada3)}else{const M=new Set;(q=e.coladas)!=null&&q.colada1&&M.add(e.coladas.colada1),(_=e.coladas)!=null&&_.colada2&&M.add(e.coladas.colada2),(S=e.coladas)!=null&&S.colada3&&M.add(e.coladas.colada3),t.push({elemento:e,diametro:d,dimensiones:e.dimensiones,barrasTotal:e.barras||0,coladasSet:M}),a.set(m,t.length-1)}});const o=t.map((e,d)=>{const p=[];r.colada_etiqueta&&p.push(r.colada_etiqueta),r.colada_etiqueta_2&&r.colada_etiqueta_2!==r.colada_etiqueta&&p.push(r.colada_etiqueta_2),p.length===0&&e.coladasSet.size>0&&p.push(...e.coladasSet);const m=p.length>0?` (${p.join(", ")})`:"";return{letter:Fe(d),text:`√ò${e.diametro} x${e.barrasTotal}${m}`}});ot(E,o,h,b);const c=t.map(e=>{const d=e.elemento,p=at(d.dimensiones||""),m=st(p);let y=0;for(const S of m)S.type==="line"&&(y=Math.max(y,Math.abs(S.length||0))),S.type==="arc"&&(y=Math.max(y,Math.abs(S.radius||0)));const C=y<=50?2:1,q=Ye(m,C),_=dt(q);return{dimsRaw:p,dimsNoZero:m,dimsScaled:q,geomScale:C,medida:_}}),l=c.map(e=>e.medida),u=mt(l,h,b,{padding:20,gapCol:50,gapRow:22,kMax:3}),w=new Map;for(let e=0;e<u.k;e++)u.cols[e].items.forEach((d,p)=>w.set(d,{c:e,j:p}));t.forEach(function(e,d){const p=e.elemento,{dimsNoZero:m,dimsScaled:y,medida:f}=c[d],C=w.get(d),q=u.centersX[C.c],_=u.centersYByCol[C.c][C.j],S=u.S,M=f.ptsRot.map(z=>({x:q+(z.x-f.midX)*S,y:_+(z.y-f.midY)*S})),$=Math.min(...M.map(z=>z.x)),I=Math.max(...M.map(z=>z.x)),R=Math.min(...M.map(z=>z.y)),L=Math.max(...M.map(z=>z.y)),A={left:$,right:I,top:R,bottom:L};window.__figBoxesGroup.push({...A});const N=ct(y,.6),B=lt(N,f.cxModel,f.cyModel,f.rotDeg,S,f.midX,f.midY,q,_),O=Ze(E,B,He,2);(function(){const ue=ut(y);function he(D){return Math.abs(Math.abs(D)-90)>=We}const T=(D,G)=>Ae({x:D.x,y:D.y},0,0,G),K=(D,G)=>{const J=Ae({x:D,y:G},f.cxModel,f.cyModel,f.rotDeg);return{x:q+(J.x-f.midX)*S,y:_+(J.y-f.midY)*S}},F=D=>Math.max(10,Math.min(28,D));ue.forEach(D=>{if(!he(D.angleDeg))return;const G=K(D.x,D.y),J=T(D.prevDir,f.rotDeg),fe=T(D.nextDir,f.rotDeg),Q=Math.atan2(J.y,J.x),V=Q+U(D.angleDeg),Z=Math.min(A.right-A.left,A.bottom-A.top);let j=F(.12*Z);const we=G.x+j*Math.cos(Q),ge=G.y+j*Math.sin(Q),Y=G.x+j*Math.cos(V),ye=G.y+j*Math.sin(V),ee=Math.abs(D.angleDeg),ie=ee>180?1:0,Me=D.angleDeg>=0?1:0,re=document.createElementNS("http://www.w3.org/2000/svg","path");re.setAttribute("d",`M ${we} ${ge} A ${j} ${j} 0 ${ie} ${Me} ${Y} ${ye}`),re.setAttribute("stroke","rgba(255,99,71,0.7)"),re.setAttribute("stroke-width","2"),re.setAttribute("fill","none"),re.style.pointerEvents="none",E.appendChild(re);let X=J.x+fe.x,H=J.y+fe.y;ee>180&&(X=-X,H=-H);let te=Math.hypot(X,H);if(te<1e-6){const le=D.angleDeg>=0?1:-1;X=-J.y*le,H=J.x*le,te=Math.hypot(X,H)||1}X/=te,H/=te;const oe=(Math.round(D.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",ae=$e(oe,14);function ve(le,pe){return{left:le-ae.w/2,right:le+ae.w/2,top:pe-ae.h/2,bottom:pe+ae.h/2}}let se=null;for(let le=Pe;le<=Je&&!se;le+=4)for(let pe=0;pe<Re.length&&!se;pe++){const xe=Re[pe],qe=T({x:X,y:H},xe),_e=G.x+qe.x*(j+le),me=G.y+qe.y*(j+le),be=ve(_e,me);be.top<0||be.bottom>b||be.left<0||be.right>h||window.__figBoxesGroup.some(Se=>ne(Se,be,6))||(window.__dimBoxesGroup||[]).some(Se=>ne(Se,be,2))||(window.__angleBoxesGroup||[]).some(Se=>ne(Se,be,2))||(window.__placedLetterBoxes||[]).some(Se=>ne(Se,be,2))||(window.__legendBoxesGroup||[]).some(Se=>ne(Se,be,6))||(se={x:_e,y:me,box:be})}if(!se){const le=G.x+X*(j+Pe),pe=G.y+H*(j+Pe),xe=ve(le,pe);se={x:le,y:pe,box:xe}}window.__angleBoxesGroup.push(se.box);const ce=document.createElementNS("http://www.w3.org/2000/svg","text");ce.setAttribute("x",se.x),ce.setAttribute("y",se.y),ce.setAttribute("fill",Te),ce.setAttribute("font-size",14),ce.setAttribute("text-anchor","middle"),ce.setAttribute("alignment-baseline","middle"),ce.style.cursor="pointer",ce.textContent=oe,E.appendChild(ce),ce.addEventListener("mouseenter",()=>{re.setAttribute("stroke","rgba(255,69,0,1)"),re.setAttribute("stroke-width","3"),re.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),ce.addEventListener("mouseleave",()=>{re.setAttribute("stroke","rgba(255,99,71,0.7)"),re.setAttribute("stroke-width","2"),re.style.filter="none"})})})();const k=O.cloneNode(!1);k.setAttribute("stroke-width","50"),k.setAttribute("stroke","transparent"),k.setAttribute("fill","none"),k.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(z=>{k.addEventListener(z,ue=>O.dispatchEvent(new ue.constructor(ue.type,ue)))}),E.insertBefore(k,O),(p.codigo!=null?p.codigo:p.id)+"",O.style.cursor="pointer",O.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),O.addEventListener("click",function(z){if(z.ctrlKey||z.metaKey||z.shiftKey){z.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(p.id);return}abrirModalDividirElemento(p.id,p.barras||0)}),O.addEventListener("contextmenu",function(z){z.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(p.id)});const P=[],W=je(N),de=je(m);rt(W,de,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(z){const ue=Ae(z.start,f.cxModel,f.cyModel,f.rotDeg),he=Ae(z.end,f.cxModel,f.cyModel,f.rotDeg),T={x:q+(ue.x-f.midX)*S,y:_+(ue.y-f.midY)*S},K={x:q+(he.x-f.midX)*S,y:_+(he.y-f.midY)*S},F=z._label,D=K.x-T.x,G=K.y-T.y,J=Math.hypot(D,G)||1,fe=D/J,Q=G/J,V=G/J,Z=-D/J,j=(T.x+K.x)/2,we=(T.y+K.y)/2,ge=j+V*10,Y=we+Z*10,ye=$e(F,14),ee=ye.w,ie=ye.h;function Me(se,ce){return{left:se-ee/2,right:se+ee/2,top:ce-ie/2,bottom:ce+ie/2}}const re=J*.45;let X=ge,H=Y;for(let se=0;se<=Math.ceil(re/6);se++){const ce=se%2===0?1:-1,le=Math.ceil(se/2),pe=ce*le*6;if(Math.abs(pe)>re)continue;const xe=ge+fe*pe,qe=Y+Q*pe,_e=(xe-T.x)*fe+(qe-T.y)*Q;if(_e<0+ee*.3||_e>J-ee*.3)continue;const me=Me(xe,qe);if(!(ne({left:Math.min(T.x,K.x),right:Math.max(T.x,K.x),top:Math.min(T.y,K.y),bottom:Math.max(T.y,K.y)},me,0)||(window.__angleBoxesGroup||[]).some(Ce=>ne(Ce,me,2))||(window.__legendBoxesGroup||[]).some(Ce=>ne(Ce,me,6))||P.some(Ce=>ne(Ce,me,2))||me.top<0||me.bottom>b||me.left<0||me.right>h)){X=xe,H=qe,P.push(me),window.__dimBoxesGroup.push(me);break}}const te=document.createElementNS("http://www.w3.org/2000/svg","line");te.setAttribute("x1",T.x),te.setAttribute("y1",T.y),te.setAttribute("x2",K.x),te.setAttribute("y2",K.y),te.setAttribute("stroke","rgba(0,0,255,0.6)"),te.setAttribute("stroke-width","4"),te.setAttribute("stroke-linecap","round"),te.setAttribute("vector-effect","non-scaling-stroke"),te.style.opacity=0,te.style.pointerEvents="none",te.style.transition="opacity 120ms ease",E.appendChild(te);const oe=document.createElementNS("http://www.w3.org/2000/svg","text");oe.setAttribute("x",X),oe.setAttribute("y",H),oe.setAttribute("fill",Te),oe.setAttribute("font-size",14),oe.setAttribute("text-anchor","middle"),oe.setAttribute("alignment-baseline","middle"),oe.setAttribute("tabindex","0"),oe.style.cursor="pointer",oe.textContent=F,E.appendChild(oe);function ae(){te.style.opacity=1}function ve(){te.style.opacity=0}oe.addEventListener("mouseenter",ae),oe.addEventListener("mouseleave",ve),oe.addEventListener("focus",ae),oe.addEventListener("blur",ve)}),function(){const ue=[];let he=0,T=0,K=0;for(let F=0;F<y.length;F++){const D=y[F];if(D.type==="line")he+=D.length*Math.cos(U(K)),T+=D.length*Math.sin(U(K));else if(D.type==="turn")K+=D.angle;else if(D.type==="arc"){const G=he+D.radius*Math.cos(U(K+90)),J=T+D.radius*Math.sin(U(K+90)),fe=Math.atan2(T-J,he-G),Q=fe+U(D.arcAngle);let V=D.radius;for(let Z=0;Z<m.length;Z++){const j=m[Z];if(j.type==="arc"&&Math.abs(j.arcAngle-D.arcAngle)<.01){V=j.radius;break}}ue.push({center:{x:G,y:J},radius:D.radius,originalRadius:V,arcAngle:D.arcAngle,startAngle:fe,endAngle:Q}),he=G+D.radius*Math.cos(Q),T=J+D.radius*Math.sin(Q),K+=D.arcAngle}}ue.forEach(function(F){const D=Ae(F.center,f.cxModel,f.cyModel,f.rotDeg),G={x:q+(D.x-f.midX)*S,y:_+(D.y-f.midY)*S},J=(F.startAngle+F.endAngle)/2,fe=F.radius*S,Q="R"+Xe(F.originalRadius,{decimals:0,step:null}),V=$e(Q,14),Z=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let j=!1,we,ge,Y;for(let ae=0;ae<Z.length&&!j;ae++){const ve=Z[ae],se=J+U(ve),ce={x:F.center.x+F.radius*Math.cos(se),y:F.center.y+F.radius*Math.sin(se)},le=Ae(ce,f.cxModel,f.cyModel,f.rotDeg),pe={x:q+(le.x-f.midX)*S,y:_+(le.y-f.midY)*S},xe=pe.x-G.x,qe=pe.y-G.y,_e=Math.hypot(xe,qe)||1,me=xe/_e,be=qe/_e;for(let Le=8;Le<=60&&!j;Le+=6){const Ie=fe*.7;if(we=G.x+me*Ie+me*Le,ge=G.y+be*Ie+be*Le,Y={left:we-V.w/2,right:we+V.w/2,top:ge-V.h/2,bottom:ge+V.h/2},!(Y.top<0||Y.bottom>b||Y.left<0||Y.right>h||window.__figBoxesGroup.some(Be=>ne(Be,Y,2))||(window.__legendBoxesGroup||[]).some(Be=>ne(Be,Y,2)))){j=!0;break}}}if(!j)return;P.push(Y);const ye={x:we-G.x,y:ge-G.y},ee=Math.hypot(ye.x,ye.y)||1,ie={x:ye.x/ee,y:ye.y/ee},Me=G.x+ie.x*fe*.6,re=G.y+ie.y*fe*.6,X=document.createElementNS("http://www.w3.org/2000/svg","line");X.setAttribute("x1",G.x),X.setAttribute("y1",G.y),X.setAttribute("x2",Me),X.setAttribute("y2",re),X.setAttribute("stroke","rgba(0,128,0,0.6)"),X.setAttribute("stroke-width","4"),X.setAttribute("stroke-linecap","round"),X.setAttribute("vector-effect","non-scaling-stroke"),X.style.opacity=0,X.style.pointerEvents="none",X.style.transition="opacity 120ms ease",E.appendChild(X);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",we),H.setAttribute("y",ge),H.setAttribute("fill",Te),H.setAttribute("font-size",14),H.setAttribute("text-anchor","middle"),H.setAttribute("alignment-baseline","middle"),H.setAttribute("tabindex","0"),H.style.cursor="pointer",H.textContent=Q,E.appendChild(H);function te(){X.style.opacity=1}function oe(){X.style.opacity=0}H.addEventListener("mouseenter",te),H.addEventListener("mouseleave",oe),H.addEventListener("focus",te),H.addEventListener("blur",oe)})}(),function(){const ue=Fe(d),he=14,T=$e(ue,he);function K(V,Z){return{left:V,right:V+T.w,top:Z-T.h/2,bottom:Z+T.h/2}}let F=null;const D=(A.top+A.bottom)/2,G=Math.max(T.h/2,Math.min(D,b-T.h/2));function J(V){for(let j=0;j<=30;j+=4){const we=j%2===0?1:-1,ge=Math.ceil(j/2),Y=we*ge*4,ye=Math.max(T.h/2,Math.min(b-T.h/2,G+Y)),ee=V,ie=K(ee,ye);if(!(window.__figBoxesGroup.some(ae=>ne(ae,ie,6))||(window.__dimBoxesGroup||[]).some(ae=>ne(ae,ie,3))||(window.__angleBoxesGroup||[]).some(ae=>ne(ae,ie,3))||(window.__legendBoxesGroup||[]).some(ae=>ne(ae,ie,6))||(window.__placedLetterBoxes||[]).some(ae=>ne(ae,ie,2))||ie.top<0||ie.bottom>b||ie.left<0||ie.right>h))return F={x:ee,y:ye,box:ie},!0}return!1}const fe=[{x:A.right+10,priority:1},{x:A.left-10-T.w,priority:1},{x:A.right+15,priority:2},{x:A.left-15-T.w,priority:2},{x:A.right+5,priority:2},{x:A.left-5-T.w,priority:2},{x:A.right+20,priority:3},{x:A.left-20-T.w,priority:3},{x:A.right+25,priority:3},{x:A.left-25-T.w,priority:3},{x:A.right+30,priority:3},{x:A.left-30-T.w,priority:3}];fe.sort((V,Z)=>V.priority-Z.priority);for(const V of fe){if(F)break;const Z=Ne(V.x,T.w,0,h);if(J(Z))break}if(!F){const V=(A.left+A.right)/2,Z=[{x:V-T.w/2,y:A.top-T.h-5},{x:V-T.w/2,y:A.bottom+T.h+5}];for(const j of Z){if(F)break;const we=Ne(j.x,T.w,0,h),ge=Math.max(T.h/2,Math.min(b-T.h/2,j.y)),Y=K(we,ge);!window.__figBoxesGroup.some(ee=>ne(ee,Y,6))&&!(window.__dimBoxesGroup||[]).some(ee=>ne(ee,Y,3))&&!(window.__angleBoxesGroup||[]).some(ee=>ne(ee,Y,3))&&!(window.__legendBoxesGroup||[]).some(ee=>ne(ee,Y,6))&&!(window.__placedLetterBoxes||[]).some(ee=>ne(ee,Y,2))&&Y.top>=0&&Y.bottom<=b&&Y.left>=0&&Y.right<=h&&(F={x:we,y:ge,box:Y})}}if(!F){const V=Ne(h-T.w,T.w,0,h),Z=G;F={x:V,y:Z,box:K(V,Z)}}window.__placedLetterBoxes.push(F.box);const Q=document.createElementNS("http://www.w3.org/2000/svg","text");Q.setAttribute("x",F.x),Q.setAttribute("y",F.y),Q.setAttribute("fill",Ve),Q.setAttribute("font-size",he),Q.setAttribute("text-anchor","start"),Q.setAttribute("alignment-baseline","middle"),Q.style.fontWeight="600",Q.style.pointerEvents="none",Q.textContent=ue,E.appendChild(Q)}()}),n.innerHTML="",n.appendChild(E)};function De(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const v=window.elementosAgrupadosScript;if(!v)return;const r=document.getElementById("grid-maquina");if(r&&window.updateGridClasses){const i=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,s),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}v.forEach(function(i,s){renderizarGrupoSVG(i,s)}),requestAnimationFrame(()=>{r&&(r.style.opacity="1",r.style.visibility="visible",r.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",r.className)),document.querySelectorAll(".proceso").forEach(i=>{i.style.opacity="1"})}),window.actualizarSVGConColadas=function(i,s){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,x=n.findIndex(b=>b.etiqueta&&String(b.etiqueta.etiqueta_sub_id)===String(i));if(x===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${i}`);return}const h=n[x];h.elementos&&s&&h.elementos.forEach(b=>{const g=String(b.id),E=s[g];b.coladas||(b.coladas={colada1:null,colada2:null,colada3:null}),E&&Array.isArray(E)&&(b.coladas.colada1=E[0]||null,b.coladas.colada2=E[1]||null,b.coladas.colada3=E[2]||null)}),renderizarGrupoSVG(h,x),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${i}`,s)},window.limpiarColadasSVG=function(i){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,n=s.findIndex(h=>h.etiqueta&&String(h.etiqueta.etiqueta_sub_id)===String(i));if(n===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${i}`);return}const x=s[n];x.elementos&&x.elementos.forEach(h=>{h.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(x,n),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${i}`)},window.addEventListener("regenerar-svg-etiqueta",function(i){var b;const s=(b=i.detail)==null?void 0:b.etiquetaSubId;if(!s||!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,x=n.findIndex(g=>g.etiqueta&&String(g.etiqueta.etiqueta_sub_id)===String(s));if(x===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${s}`);return}const h=n[x];renderizarGrupoSVG(h,x),console.log(`üîÑ SVG regenerado para etiqueta ${s} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",De):De();document.addEventListener("livewire:navigated",De);window.abrirModalDividirElemento=async function(r,i){const s=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),x=document.getElementById("dividir_barras_totales"),h=document.getElementById("dividir_peso_total"),b=document.getElementById("labelBarrasActuales"),g=document.getElementById("barras_a_mover"),E=document.getElementById("previewDivision"),t=document.getElementById("formDividirElemento"),a=document.getElementById("badgeSugerenciaPeso"),o=document.getElementById("barrasSugeridas"),c=document.getElementById("detalleSugerencia");if(!s||!n||!t)return;n.value=r,b&&(b.textContent="...");let l=null,u=parseInt(i)||0;try{const _=await fetch(`/elementos/${r}/info-basica`);if(_.ok){const S=await _.json();S.success&&S.elemento&&(l=S.elemento,u=parseInt(S.elemento.barras)||0,console.log("üìä Datos frescos del servidor:",S.elemento))}}catch(_){console.warn("‚ö†Ô∏è No se pudieron obtener datos frescos, usando datos locales:",_)}if(!l){if(window.elementosAgrupadosScript){for(const _ of window.elementosAgrupadosScript)if(_.elementos){const S=_.elementos.find(M=>String(M.id)===String(r));if(S){l=S,S.barras&&(u=parseInt(S.barras)||0);break}}}if(!l&&window.gruposResumenData){for(const _ of window.gruposResumenData)if(_.elementos){const S=_.elementos.find(M=>String(M.id)===String(r));if(S){l=S,S.barras&&(u=parseInt(S.barras)||0);break}}}}const w=l==null?void 0:l.estado,e=w==="fabricando"||w==="completada",d=l&&l.paquete_id,p=e||d,m=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),y=m==null?void 0:m.closest("label");if(m){if(m.disabled=p,y)if(p){y.classList.add("opacity-50","cursor-not-allowed");let _=e?"La etiqueta est√° en proceso o completada":"El elemento pertenece a un paquete";y.setAttribute("title",_)}else y.classList.remove("opacity-50","cursor-not-allowed"),y.removeAttribute("title");if(p&&m.checked){const _=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');_&&(_.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}x&&(x.value=u),b&&(b.textContent=u>0?u:"-");const f=l&&parseFloat(l.peso_numerico)||0;h&&(h.value=f),console.log("üîç Debug badge sugerencia:",{peso_numerico:l==null?void 0:l.peso_numerico,pesoTotal:f,barrasTotales:u});const C=1200,q=document.getElementById("divisionAutoData");if(a&&o&&u>0&&f>0){const _=f/u,S=Math.floor(C/_);if(f>C&&S<u){const M=Math.ceil(u/S),$=Math.floor(u/M),I=u%M;q&&(q.value=JSON.stringify({elemento_id:r,etiqueta_sub_id:(l==null?void 0:l.etiqueta_sub_id)||null,num_etiquetas:M,barras_por_etiqueta:$,etiquetas_con_barra_extra:I,barras_totales:u,peso_por_barra:_}));let R="";if(I===0)R=`${M} etiquetas de ${$} barras cada una (~${($*_).toFixed(0)} kg)`;else{const L=$+1,A=$;R=`${I} etiqueta(s) de ${L} barras + ${M-I} etiqueta(s) de ${A} barras`}o.textContent=`${M} etiquetas`,c.innerHTML=R+`<br><span class="text-xs text-amber-600">Barras m√°x por etiqueta: ${S} (para no superar ${C} kg)</span>`,a.classList.remove("hidden")}else a.classList.add("hidden"),q&&(q.value="")}else a&&a.classList.add("hidden"),q&&(q.value="");g&&(g.value=""),E&&E.classList.add("hidden"),window.rutaDividirElemento&&t.setAttribute("action",window.rutaDividirElemento),s.classList.remove("hidden")};window.enviarDivision=async function(){const r=document.getElementById("formDividirElemento"),i=r.getAttribute("action")||window.rutaDividirElemento,s=new FormData(r);try{const n=document.querySelector('meta[name="csrf-token"]'),x=s.get("_token")||(n?n.getAttribute("content"):null),b=await fetch(i,{method:"POST",headers:x?{"X-CSRF-TOKEN":x}:{},body:s}),g=await b.text();let E;try{E=JSON.parse(g)}catch(a){const o=g.substring(0,200)+(g.length>200?"...":"");typeof window.mostrarErrorConReporte=="function"?window.mostrarErrorConReporte("El servidor devolvi√≥ una respuesta inv√°lida","Error de respuesta",`${a.message}

Respuesta: ${o}`):window.Swal&&window.Swal.fire("Error",a.message,"error");return}if(!b.ok||!E.success)throw new Error(E.message||"Error al dividir");r.reset();const t=document.getElementById("modalDividirElemento");t&&t.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",E.message,"success"):alert(E.message)}catch(n){typeof window.mostrarErrorConReporte=="function"?window.mostrarErrorConReporte(n&&n.message||"Error","Error"):window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(v){const r={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",doblando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},i={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},doblando:{cssClass:"estado-doblando",bgColor:"#facc15",texto:"Doblando",icono:"‚öôÔ∏è"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function s(g,E,t={}){console.log(`üîÑ Actualizando etiqueta ${g} a estado: ${E}`);const a=String(g).replace(/\./g,"-"),o=document.querySelector(`#etiqueta-${a}`);if(!o)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${g}`),!1;const c=o.dataset.tieneMaquina2==="true"||t.es_secundaria;let l=String(E).toLowerCase().trim();const u=t.estado2||o.dataset.estado2||null;c&&u&&(l=u.toLowerCase().trim(),console.log(`üîÑ Usando estado2 para color: ${l}`));const w=String(E).toLowerCase().trim(),e=i[l]||i[w];if(!e)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${E}`),!1;o.dataset.estado=w,u&&(o.dataset.estado2=u),Array.from(o.classList).forEach(f=>{(f.startsWith("estado-")||f.startsWith("estado2-"))&&o.classList.remove(f)}),o.classList.add(e.cssClass),u&&o.classList.add(`estado2-${u}`),o.style.setProperty("--bg-estado",e.bgColor);const p=o.querySelector('[id^="contenedor-svg-"]');if(p){const f=p.querySelector("svg");f&&(f.style.background=e.bgColor)}const m=o.querySelector(".etiqueta-card")||o;m&&(m.style.background=e.bgColor),n(o,l);const y=o.querySelector(".estado-badge");if(y){const f=i[w];let C=f?f.texto:w;if(u){const q=i[u.toLowerCase()];C+="/"+(q?q.texto:u)}y.textContent=C,y.className="estado-badge ml-2 text-xs px-2 py-0.5 rounded-full",l==="pendiente"?y.classList.add("bg-gray-200","text-gray-700"):["fabricando","ensamblando","soldando","doblando"].includes(l)?y.classList.add("bg-yellow-200","text-yellow-800"):["fabricada","completada","ensamblada","soldada"].includes(l)?y.classList.add("bg-green-200","text-green-800"):l==="en-paquete"||l==="empaquetada"?y.classList.add("bg-purple-200","text-purple-800"):y.classList.add("bg-gray-200","text-gray-700")}return x(o),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:g,estado:w,datosExtra:t}})),console.log(`‚úÖ Etiqueta ${g} actualizada a ${E}`),!0}function n(g,E){const t=g.querySelectorAll(".btn-fabricar"),a=["empaquetada","en-paquete"];t.forEach(o=>{a.includes(E)?(o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed",o.title=`Etiqueta ya ${E}`):(o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer",o.title="Fabricar esta etiqueta")})}function x(g){g.style.transition="transform 0.5s ease, background-color 0.5s ease",g.style.transform="scale(1.03)",setTimeout(()=>{g.style.transform="scale(1)"},400)}function h(g,E,t={}){console.log(`üîÑ Actualizando ${g.length} etiquetas...`);const o=g.map(c=>s(c,E,t)).filter(c=>c).length;return console.log(`‚úÖ ${o}/${g.length} etiquetas actualizadas`),o}function b(g){const E=String(g).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${E}`);return t?{id:g,estado:t.dataset.estado||"desconocido",elemento:t}:null}window.addEventListener("paquete:creado",g=>{const{codigoPaquete:E,etiquetaIds:t}=g.detail;console.log(`üì¶ Evento paquete:creado recibido - ${E} con ${t.length} etiquetas`),h(t,"empaquetada",{codigo_paquete:E})}),v.SistemaDOM={actualizarEstadoEtiqueta:s,actualizarMultiplesEtiquetas:h,obtenerEstadoActual:b,ESTADOS_CONFIG:i},v.ColoresEstado={actualizar:(g,E)=>{r[g]=E;const t=document.getElementById("colores-estado-css");if(t){let a=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[o,c]of Object.entries(r))a+=`.proceso.estado-${o} {
    --bg-estado: ${c};
}
`;t.textContent=a,console.log(`‚úÖ Color actualizado para estado "${g}": ${E}`)}},obtenerColor:g=>r[g],todos:()=>({...r})}})(window);function Oe(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const t=localStorage.getItem("decisionCortePorEtiqueta");t&&(window._decisionCortePorEtiqueta=JSON.parse(t),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(t){console.warn("No se pudieron restaurar decisiones de corte:",t)}document.addEventListener("click",async t=>{var p,m,y;const a=t.target.closest(".btn-fabricar");if(!a)return;t.preventDefault();const o=(m=(p=document.getElementById("maquina-info"))==null?void 0:p.dataset)==null?void 0:m.maquinaId;if(!o){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const c=a.dataset.grupoId;if(c){const f=a.disabled;a.disabled=!0;try{await r(c,o)}finally{a.disabled=f}return}const l=String(a.dataset.etiquetaId||"").trim(),u=l.replace(/\./g,"-"),w=document.querySelector(`#etiqueta-${u}`);if(w){const f=(w.dataset.estado||"").toLowerCase(),C=(w.dataset.estado2||"").toLowerCase();w.dataset.maquinaId;const q=w.dataset.maquinaId2||"",_=q&&q===o,S=_?C:f;if(["completada","en-paquete","empaquetada"].includes(S)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${l} ya est√° en estado ${S}${_?" en esta m√°quina":""}.`,timer:2500,showConfirmButton:!1});return}}const e=Number(((y=window.DIAMETRO_POR_ETIQUETA)==null?void 0:y[l])??0);if(!l){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!e&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const d=a.disabled;a.disabled=!0;try{await v(l,o,e)}finally{a.disabled=d}});async function v(t,a,o=null){var C,q,_,S,M,$,I,R;const c=`/actualizar-etiqueta/${t}/maquina/${a}`,l=(C=document.querySelector('meta[name="csrf-token"]'))==null?void 0:C.getAttribute("content"),u=t.replace(/\./g,"-"),e=(((_=(q=document.querySelector(`#etiqueta-${u}`))==null?void 0:q.dataset)==null?void 0:_.estado)||"").toLowerCase()==="fabricando",d=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",p=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",m=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",y=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:d,esSL28:p,esCortadoraManual:m,esCortadoraDobladoraBarra:y}),d&&p||m||y){if(e)if((S=window._decisionCortePorEtiqueta)!=null&&S[t]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const L=await fetch(`/api/etiquetas/${t}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":l}});if(L.ok){const A=await L.json();if(A.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:A.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],csrfToken:l,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1});return}}}catch(L){console.warn("No se pudo obtener longitud asignada:",L)}for(;;){let L;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),L=await Cortes.mejorCorteSimple(t,o,l),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",L)}catch(A){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",A),E(A);return}if(!L){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",L.accion),L.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let A;try{A=await Cortes.mejorCorteOptimizado(t,o,L.patrones,l)}catch(N){E(N);return}if((A==null?void 0:A.accion)==="fabricar"){const N=((M=A.patronInfo)==null?void 0:M.desperdicio_cm)||(($=A.patron)==null?void 0:$.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:A.longitudBarraCm,etiquetas:A.etiquetas,desperdicioEstimadoCm:N},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const B=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:n});if(B!=null&&B.cancelled)continue;return}else{if(A==="volver")continue;return}}if(L.accion==="fabricar_patron_simple"){const A=Math.round(Number(L.longitud_m||0)*100);if(!A){E("Longitud de barra no v√°lida.");return}const N=((I=L.patronInfo)==null?void 0:I.desperdicio_cm)||((R=L.patron)==null?void 0:R.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:A,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],desperdicioEstimadoCm:N},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const B=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:l,etiquetaId:t,onUpdate:n});if(B!=null&&B.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,a,l)}catch(L){E(L)}return}try{const L=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({})}),A=await L.json();if(!L.ok)throw new Error(A.message||"Error al actualizar");n(t,A)}catch(L){E(L)}}async function r(t,a){var f,C,q,_,S,M,$,I,R;const o=(f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.getAttribute("content"),c=document.querySelector(`[data-grupo-id="${t}"] .etiqueta-card`),l=(((C=c==null?void 0:c.dataset)==null?void 0:C.estado)||"pendiente").toLowerCase(),u=parseInt((q=c==null?void 0:c.dataset)==null?void 0:q.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(l)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${l}.`,timer:2500,showConfirmButton:!1});return}const w=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",e=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",d=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",p=w&&e||d;let m=[];try{m=JSON.parse(((_=c==null?void 0:c.dataset)==null?void 0:_.etiquetasSubIds)||"[]")}catch(L){console.warn("Error parseando etiquetas del grupo:",L)}const y=(S=c==null?void 0:c.dataset)==null?void 0:S.primeraEtiquetaId;if((M=c==null?void 0:c.dataset)!=null&&M.planillaId||window.PLANILLA_ID,l==="pendiente"&&p&&y){try{for(;;){const L=await Cortes.mejorCorteSimple(y,u,o);if(!L)return;if(L.accion==="optimizar"){const A=await Cortes.mejorCorteOptimizado(y,u,null,o);if(A==="volver")continue;if(!A||A.accion!=="fabricar")return;const N=(($=A.patronInfo)==null?void 0:$.desperdicio_cm)||0;let B=null;const O=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:A.longitudBarraCm,etiquetas:A.etiquetas,csrfToken:o,etiquetaId:y,desperdicioEstimadoCm:N,onUpdate:(k,P)=>{P.producto_n_colada&&(B={colada1:P.producto_n_colada,colada2:P.producto2_n_colada||null}),i(c,"fabricando",t,B)},pedirDesperdicio:!0});if(O!=null&&O.cancelled)continue;i(c,"fabricando",t,B),g("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(L.accion==="fabricar_patron_simple"){const A=Math.round(Number(L.longitud_m||0)*100);if(!A){E("Longitud de barra no v√°lida.");return}const N=((I=L.patronInfo)==null?void 0:I.desperdicio_cm)||((R=L.patron)==null?void 0:R.sobra_cm)||0,B=m.map(P=>({etiqueta_sub_id:P,patron_letras:L.patron_letras||""}));let O=null;const k=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:A,etiquetas:B,csrfToken:o,etiquetaId:y,desperdicioEstimadoCm:N,onUpdate:(P,W)=>{W.producto_n_colada&&(O={colada1:W.producto_n_colada,colada2:W.producto2_n_colada||null}),i(c,"fabricando",t,O)},pedirDesperdicio:!0});if(k!=null&&k.cancelled)continue;i(c,"fabricando",t,O),g("info","Fabricando",`Grupo iniciado (${m.length} etiquetas)`);return}return}}catch(L){E(L)}return}try{const L=await fetch(`/api/etiquetas/resumir/${t}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({maquina_id:a})}),A=await L.json();if(!L.ok||!A.success)throw new Error(A.message||"Error al actualizar grupo");const N=A.nuevo_estado||"actualizado",B=A.imprimir_etiquetas||[],O={colada1:A.producto_n_colada||null,colada2:A.producto2_n_colada||null};if(i(c,N,t,O),N==="fabricando"){const k=O.colada1?` - Colada: ${O.colada1}`:"";g("info","Fabricando",`Grupo iniciado (${A.etiquetas_actualizadas||0} etiquetas)${k}`)}else N==="completada"&&g("success","¬°Completado!",`Grupo completado (${A.etiquetas_actualizadas||0} etiquetas)`);if(N==="completada"&&B.length>0){const k=B.map(W=>W.etiqueta_sub_id),P=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${k.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(P.isConfirmed||P.isDenied){const W=P.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(de=>setTimeout(de,200)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(k,W)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let W=0;for(const de of k)try{const Ee=await window.TrabajoPaquete.validarEtiqueta(de);Ee.valida&&window.TrabajoPaquete.agregarItemEtiqueta(de,Ee)&&W++}catch(Ee){console.warn(`No se pudo a√±adir ${de} al carro:`,Ee)}W>0&&g("success","A√±adidas al carro",`${W} etiquetas a√±adidas al carro`)}i(c,"completada",t)}}catch(L){E(L)}}function i(t,a,o,c=null){if(!t)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(w=>{t.classList.remove(`estado-${w}`)}),t.classList.add(`estado-${a}`),t.dataset.estado=a;const l=t.dataset.contenedorSvgId,u=t.dataset.elementos;if(l&&u&&typeof window.renderizarGrupoSVG=="function")try{const w=JSON.parse(u);c&&(w.forEach(d=>{d.coladas={colada1:c.colada1||null,colada2:c.colada2||null,colada3:null}}),t.dataset.elementos=JSON.stringify(w));const e={id:parseInt(l),etiqueta:{id:parseInt(l)},elementos:w};window.renderizarGrupoSVG(e,o)}catch(w){console.warn("No se pudo re-renderizar SVG del grupo:",w)}}async function s(t,a,o){var A,N,B,O,k;const c=Number(((A=window.DIAMETRO_POR_ETIQUETA)==null?void 0:A[t])??0),u=Number(((N=window.LONGITUD_POR_ETIQUETA)==null?void 0:N[t])??0)/100;let w="";try{const P=await fetch(`/api/productos/sugerencias?diametro=${c}&longitud=${u}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(P.ok){const W=await P.json();W.productos&&W.productos.length>0?w=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${c}mm x ${u.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${W.productos.map(de=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${de.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${de.codigo}</td>
                                                <td class="px-2 py-1">${de.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${de.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${de.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:w=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${c}mm x ${u.toFixed(1)}m</p>`}}catch(P){console.warn("No se pudieron cargar sugerencias:",P)}const{value:e,isConfirmed:d}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${w}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const P=document.getElementById("swal-input-producto").value;return!P||!P.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):P.trim()}});if(!d||!e)return;let p;try{const P=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(e.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":o}});if(!P.ok){const W=await P.json();throw new Error(W.message||"Producto no encontrado")}p=await P.json()}catch(P){await Swal.fire({icon:"error",title:"Producto no encontrado",text:P.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${e}`});return}const m=(p.tipo||"").toLowerCase(),y=Number(p.diametro??0),f=Number(p.longitud??0);if(m&&m!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${p.codigo}</p>
                        <p><strong>Tipo:</strong> ${p.tipo||"N/A"}</p>
                    </div>
                `});return}if(y>0&&c>0&&Math.abs(y-c)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${y} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${c} mm</p>
                    </div>
                `});return}if(f>0&&u>0&&Math.abs(f-u)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${f.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${u.toFixed(2)} m</p>
                    </div>
                `});return}const C=p.longitud?`${p.longitud} m`:"N/A",{value:q,isConfirmed:_}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${p.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${p.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${C}</p>
                    <p><strong>Stock actual:</strong> ${((B=p.peso_stock)==null?void 0:B.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${p.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!_)return;const S=q==="completo",M=`/actualizar-etiqueta/${t}/maquina/${a}`,$=await fetch(M,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o},body:JSON.stringify({producto_id:p.id,paquete_completo:S})}),I=await $.json();if(!$.ok)throw new Error(I.message||"Error al fabricar");const R=((O=I.metricas)==null?void 0:O.peso_consumido)||0,L=((k=I.metricas)==null?void 0:k.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${p.codigo}</p>
                <p><strong>Peso consumido:</strong> ${R.toFixed(2)} kg</p>
                ${L?`<p><strong>Paquete:</strong> ${L}</p>`:""}
                ${S?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),n(t,I),L&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const P=document.getElementById("codigo_paquete_mover");P&&(P.value=L,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function n(t,a){var c,l;const o=t.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:a.estado,peso_etiqueta:a.peso_etiqueta,nombre:a.nombre,producto_n_colada:a.producto_n_colada,producto2_n_colada:a.producto2_n_colada,data_completa:a}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,a.estado,{peso:a.peso_etiqueta,nombre:a.nombre||t,estado2:a.estado2||null,es_secundaria:a.es_secundaria||!1}):x(t,a.estado),a.estado2){const u=String(t).replace(/\./g,"-"),w=document.getElementById(`etiqueta-${u}`);w&&(w.dataset.estado2=a.estado2)}if(a.producto_n_colada&&window.elementosAgrupadosScript){const u=window.elementosAgrupadosScript.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(t));if(u!==-1){const w=window.elementosAgrupadosScript[u];w.colada_etiqueta=a.producto_n_colada,w.colada_etiqueta_2=a.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(w,u),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${a.producto_n_colada}`))}}switch(a.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,a.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(t,!0),(a.estado||"").toLowerCase()){case"pendiente":g("info","Pendiente","La etiqueta est√° pendiente de fabricaci√≥n.");break;case"cortando":g("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":g("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),h(o);break;case"fabricando":g("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":g("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),h(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"fabricada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(w=>w.coladas&&(w.coladas.colada1||w.coladas.colada2||w.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),b(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":g("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(c=window._decisionCortePorEtiqueta)!=null&&c[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),h(o),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"completada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(w=>w.coladas&&(w.coladas.colada1||w.coladas.colada2||w.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),b(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":g("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":g("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),h(o);break;case"soldando":g("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":g("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),h(o);break;case"doblando":g("info","Doblando","La etiqueta est√° en proceso de doblado.");break;case"completada":g("success","Doblado completado","El proceso de doblado ha finalizado correctamente."),h(o);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${a.estado}`),g("warning","Estado desconocido",`El estado recibido (${a.estado}) no est√° reconocido.`,3e3)}(l=a.productos_afectados)!=null&&l.length&&a.productos_afectados.forEach(u=>{const w=document.getElementById(`peso-stock-${u.id}`),e=document.getElementById(`progreso-texto-${u.id}`),d=document.getElementById(`progreso-barra-${u.id}`);w&&(w.textContent=`${u.peso_stock} kg`),e&&(e.textContent=`${u.peso_stock} / ${u.peso_inicial} kg`),d&&(d.style.height=`${u.peso_stock/u.peso_inicial*100}%`)})}function x(t,a){const o=t.replace(/\./g,"-"),c=document.getElementById("etiqueta-"+o);if(!c)return;c.dataset.estado=String(a||"").toLowerCase(),c.className=c.className.split(" ").filter(w=>!w.startsWith("estado-")).join(" ").trim(),c.classList.add("estado-"+c.dataset.estado);const l=c.querySelector('[id^="contenedor-svg-"]'),u=l==null?void 0:l.querySelector("svg");u&&(u.style.background=getComputedStyle(c).getPropertyValue("--bg-estado").trim())}function h(t){const a=`#etiqueta-${CSS.escape(t)}`,o=document.querySelector(a),c=Array.from(document.querySelectorAll(".proceso")),l=y=>(y||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),u=y=>{var q;const f=(q=y.dataset)==null?void 0:q.estado;if(f)return l(f);const C=y.querySelector('[id^="estado-"]');return l((C==null?void 0:C.textContent)||(C==null?void 0:C.innerText)||"")},w=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),e=y=>w.has(u(y)),d=o?c.indexOf(o):-1,m=(d>=0?c.slice(d+1):c).find(y=>!e(y));m?m.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function b(t,a){var w;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!a||!Array.isArray(a)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(a.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const o=window.elementosAgrupadosScript.findIndex(e=>{var d;return((d=e.etiqueta)==null?void 0:d.etiqueta_sub_id)===t});if(o===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[o].elementos=a;const c=window.elementosAgrupadosScript[o],l=(w=c.etiqueta)==null?void 0:w.id;if(!l){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const u=document.getElementById("contenedor-svg-"+l);if(!u){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${l})`);return}try{const e=u.querySelector("svg");e&&e.remove();const d=600,p=150,m=u.closest(".proceso"),y=m&&getComputedStyle(m).getPropertyValue("--bg-estado").trim()||"#e5e7eb",f=document.createElementNS("http://www.w3.org/2000/svg","svg");f.setAttribute("viewBox",`0 0 ${d} ${p}`),f.setAttribute("preserveAspectRatio","xMidYMid meet"),f.style.width="100%",f.style.height="100%",f.style.display="block",f.style.background=y;const C=(c.elementos||[]).map((_,S)=>{var L,A,N;const M=_.barras!=null?_.barras:0;let $="N/A";if(_.diametro!=null&&_.diametro!==""){const O=String(_.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(O){const k=parseFloat(O[0]);isFinite(k)&&($=String(Math.round(k)))}}const I=[];(L=_.coladas)!=null&&L.colada1&&I.push(_.coladas.colada1),(A=_.coladas)!=null&&A.colada2&&I.push(_.coladas.colada2),(N=_.coladas)!=null&&N.colada3&&I.push(_.coladas.colada3);const R=I.length>0?` (${I.join(", ")})`:"";return{letter:indexToLetters(S),text:`√ò${$} x${M}${R}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(f,C,d,p):console.error("‚ùå drawLegendBottomLeft no est√° definida");const q=document.createElementNS("http://www.w3.org/2000/svg","text");q.setAttribute("x",d/2),q.setAttribute("y",p/2),q.setAttribute("text-anchor","middle"),q.setAttribute("fill","#059669"),q.setAttribute("font-size","14"),q.setAttribute("font-weight","600"),q.textContent="‚úì Coladas actualizadas",f.appendChild(q),u.appendChild(f),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{q&&q.parentNode&&q.remove()},2e3)}catch(e){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,e),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function g(t,a,o,c=2e3){Swal.fire({icon:t,title:a,text:o,timer:c,showConfirmButton:!1})}function E(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=n}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Oe):Oe();document.addEventListener("livewire:navigated",Oe);(function(v){let r=[],i=!1,s=null;async function n(e){var p;const d=`/etiquetas/${encodeURIComponent(e)}/validar-para-paquete`;try{const m=await fetch(d,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(p=document.querySelector('meta[name="csrf-token"]'))==null?void 0:p.content}});if(!(m.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const f=await m.json();if(!m.ok)throw new Error((f==null?void 0:f.message)||(f==null?void 0:f.motivo)||"Error al validar");return f}catch(m){throw m}}function x(e,d){const p=d.id||e;if(r.some(f=>f.id===p))return!1;const m=parseFloat(d.peso_etiqueta)||0,y={id:p,type:"etiqueta",peso:m,estado:d.estado||"desconocido",nombre:d.nombre||"Sin nombre"};return r.push(y),t(),!0}function h(e){const d=r.findIndex(p=>p.id===e);d>=0&&r.splice(d,1),t()}function b(){r=[],t()}function g(){return r.reduce((e,d)=>e+(parseFloat(d.peso)||0),0)}function E(){return r}function t(){const e=document.getElementById("itemsList");if(!e)return;e.innerHTML="";for(const m of r){const y=document.createElement("li");y.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",y.dataset.code=m.id,y.innerHTML=`
                <div>
                    <div class="font-semibold">${m.id}</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,y.querySelector("button").onclick=()=>h(m.id),e.appendChild(y)}const d=g(),p=document.createElement("li");p.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",p.textContent=`Total: ${Math.round(d)} kg (${r.length} etiquetas)`,e.appendChild(p)}async function a(){var f,C,q;if(!r.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const e=Number(((C=(f=document.getElementById("maquina-info"))==null?void 0:f.dataset)==null?void 0:C.maquinaId)||window.maquinaId),d=Number(((q=document.getElementById("ubicacion-id"))==null?void 0:q.value)||window.ubicacionId),p=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!e){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}const m={items:r.map(_=>({id:_.id,type:_.type})),maquina_id:e,ubicacion_id:p?null:d||null,sin_ubicacion:p},y=async(_={})=>{var $;const S=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":($=document.querySelector('meta[name="csrf-token"]'))==null?void 0:$.content},body:JSON.stringify({...m,..._})}),M=await S.json();if(!S.ok)throw new Error(M.message||"Error al crear el paquete");return M};try{const _=await y();if(_.success)return o(_);if(_.warning){let S="<div style='text-align:left;'>Se detectaron advertencias:";for(const[$,I]of Object.entries(_.warning))Array.isArray(I)&&I.length&&(S+=`<br><strong>${$.replaceAll("_"," ")}:</strong> ${I.join(", ")}`);if(S+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:S,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const $=await y({confirmar:!0});if($.success)return o($);throw new Error($.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(_){await Swal.fire("Error",_.message||"Error inesperado","error")}}async function o(e){var f;console.log("üì¶ postCreacion llamada con data:",e);const d=e.codigo_paquete||((f=e.paquete)==null?void 0:f.codigo)||"N/D",p=g(),m=[...r.map(C=>C.id)];console.log("üì¶ Etiquetas a actualizar:",m),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${d}</strong> creado correctamente</p>
                       <p>${m.length} etiquetas ¬∑ ${p.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),b(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const C=document.getElementById("codigo_paquete_mover");C&&(C.value=d,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},50)))},50))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${d}</strong> creado correctamente</p><p>${m.length} etiquetas ¬∑ ${p.toFixed(2)} kg</p>`}),b()),console.log(`üì¶ Disparando evento paquete:creado para ${d}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:d,etiquetaIds:m,pesoTotal:p}})),console.log(`üîÑ Actualizando DOM para ${m.length} etiquetas con paquete ${d}`),m.forEach(C=>{c(C,d)})}function c(e,d){const p=String(e).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${e} (safe: ${p})`);let m=document.querySelector(`#etiqueta-${p}`);if(m&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${p}`),!m){const S=document.querySelector(`[data-etiqueta-sub-id="${e}"]`);S&&(m=S.querySelector(".etiqueta-card"),m&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!m){const S=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${S.length} grupos...`);for(const M of S)try{const $=JSON.parse(M.dataset.etiquetasSubIds||"[]");if($.includes(e)){m=M,console.log(`‚úÖ Etiqueta ${e} encontrada en grupo con ${$.length} etiquetas`);break}}catch($){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",$)}}if(!m){console.warn(`‚ùå No se encontr√≥ elemento: ${e}`);return}console.log(`üîÑ Actualizando manualmente: ${e}`),Array.from(m.classList).forEach(S=>{S.startsWith("estado-")&&m.classList.remove(S)}),m.classList.add("estado-en-paquete"),m.dataset.estado="en-paquete",m.style.setProperty("--bg-estado","#e3e4FA");const f=m.querySelector('[id^="contenedor-svg-"]');if(f){const S=f.querySelector("svg");S&&(S.style.background="#e3e4FA")}const C=m.querySelector(".etiqueta-card")||m;C&&(C.style.background="#e3e4FA");const q=m.querySelector(".paquete-codigo");q?(q.textContent=`(${d})`,q.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${d})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),m.querySelectorAll(".btn-fabricar").forEach(S=>{S.disabled=!0,S.style.opacity="0.5",S.style.cursor="not-allowed"}),m.style.transition="transform 0.5s ease, background-color 0.5s ease",m.style.transform="scale(1.03)",setTimeout(()=>{m.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${e} actualizada manualmente`)}function l(){u(),i||(w(),i=!0)}function u(){const e=document.getElementById("qrItem");e&&!e.dataset.initialized&&(e.dataset.initialized="true",e.addEventListener("change",()=>e.dispatchEvent(new Event("input"))),e.addEventListener("input",async function(){const d=this.value.trim();if(d)try{const p=await n(d);if(!p.valida){await Swal.fire("Etiqueta no v√°lida",p.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}x(d,p)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(p){console.error("Error de validaci√≥n:",p),await Swal.fire("Error",p.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}))}function w(){document.addEventListener("click",async function(e){if(e.target.id==="crearPaqueteBtn"||e.target.closest("#crearPaqueteBtn")){e.preventDefault(),await a();return}}),document.addEventListener("focus",function(e){e.target.id&&e.target.id.startsWith("input-etiqueta-")&&(s=e.target,console.log("üéØ Focus en input:",e.target.id))},!0),document.addEventListener("click",async function(e){var d;if(e.target.classList.contains("btn-agregar-carro")||e.target.closest(".btn-agregar-carro")){const m=(e.target.classList.contains("btn-agregar-carro")?e.target:e.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!m){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const y=document.querySelector(`[x-show="tabActivo === 'crear'"]`),f=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(y&&window.getComputedStyle(y).display,f&&window.getComputedStyle(f).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let q=document.activeElement;(!q||!((d=q.id)!=null&&d.startsWith("input-etiqueta-")))&&(q=s),(!q||!document.body.contains(q))&&(q=document.querySelector('input[id^="input-etiqueta-"]')),q?(q.value=m,q.focus(),q.classList.add("ring-4","ring-green-400"),setTimeout(()=>{q.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${m} a√±adida al input:`,q.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",m);try{const q=await n(m);if(!q.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:q.motivo||"Motivo no especificado"});return}x(m,q)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(q){console.error("Error al a√±adir al carro:",q),await Swal.fire({icon:"error",title:"Error",text:q.message||"No se pudo a√±adir al carro"})}}if(e.target.classList.contains("btn-agregar-carro-grupo")||e.target.closest(".btn-agregar-carro-grupo")){const p=e.target.classList.contains("btn-agregar-carro-grupo")?e.target:e.target.closest(".btn-agregar-carro-grupo"),m=p.dataset.grupoId;let y=[];try{y=JSON.parse(p.dataset.etiquetas||"[]")}catch(M){console.error("Error parseando etiquetas del grupo:",M);return}if(!y.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${y.length} etiquetas del grupo ${m} al carro`);let f=0,C=0,q=0,_=[];const S=await Promise.all(y.map(async M=>{try{const $=await n(M.id);return{id:M.id,data:$,error:null}}catch($){return{id:M.id,data:null,error:$}}}));for(const{id:M,data:$,error:I}of S){if(I){q++,console.error("Error validando etiqueta:",M,I);continue}if(!$.valida){q++,$.motivo&&!_.includes($.motivo)&&_.push($.motivo);continue}x(M,$)?f++:C++}if(f>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${f}</strong> etiquetas al carro.</p>
                            ${C>0?`<p class="text-gray-500">${C} ya estaban en el carro.</p>`:""}
                            ${q>0?`<p class="text-red-500">${q} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(C>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const M=_.length>0?`<ul class="text-left mt-2 text-sm">${_.map($=>`<li>‚Ä¢ ${$}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${M}
                        `})}}})}v.TrabajoPaquete={inicializar:l,agregarItemEtiqueta:x,eliminarItem:h,limpiarCarro:b,obtenerItems:E,calcularPesoTotal:g,crearPaquete:a,validarEtiqueta:n,actualizarListaVisual:t},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l(),document.addEventListener("livewire:navigated",l)})(window);function ke(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(r,i){const s=document.getElementById("grid-maquina");if(!s)return;console.log("üîß Actualizando clases:",{showLeft:r,showRight:i,clasesAnteriores:s.className}),r||i?s.classList.add("columnas-laterales-visibles"):s.classList.remove("columnas-laterales-visibles"),r&&i?s.classList.add("ambas-columnas"):s.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",s.className),s.offsetHeight,s.querySelectorAll(".etiqueta-card").forEach(x=>{x.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const r=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,i)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const r=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,i)});function v(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((x,h)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),h.disconnect();const g=JSON.parse(localStorage.getItem("showLeft")??"true"),E=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(g,E)}}).observe(document.body,{childList:!0,subtree:!0});return}const i=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,s),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}v()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ke):ke();document.addEventListener("livewire:navigated",ke);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const v={debounceTime:500};let r=0;async function i(a){var l;const o=Date.now();if(o-r<v.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};r=o;const c=(l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content");if(!c)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${a}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const w=await fetch(`/etiquetas/${encodeURIComponent(a)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":c}}),e=await w.json();return!w.ok||!e.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:e.message||"No se pudo revertir el cambio."}),{success:!1,message:e.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${e.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${e.estado}</strong>
                    </p>
                    ${e.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),h(a,e),e)}catch(u){return console.error("Error al deshacer etiqueta:",u),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:u.message}}}async function s(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/puede-deshacer`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{puede_deshacer:!1}}catch(o){return console.error("Error al verificar undo:",o),{puede_deshacer:!1}}}async function n(a){try{const o=await fetch(`/etiquetas/${encodeURIComponent(a)}/historial`,{headers:{Accept:"application/json"}});return o.ok?await o.json():{success:!1,historial:[]}}catch(o){return console.error("Error al obtener historial:",o),{success:!1,historial:[]}}}async function x(a){var l;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const o=await n(a);if(!o.success||!((l=o.historial)!=null&&l.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const c=o.historial.map((u,w)=>`
            <tr class="${u.revertido?"bg-gray-100 text-gray-400":w===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${u.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${u.accion}</td>
                <td class="px-2 py-1 text-xs">${u.estado_anterior||"-"} ‚Üí ${u.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${u.revertido?'<span class="text-gray-400">Revertido</span>':w===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${a}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${c}</tbody>
                    </table>
                </div>
                ${o.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${o.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:o.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:o.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:o.puede_deshacer?"#f59e0b":"#6b7280"}).then(u=>{u.isConfirmed&&o.puede_deshacer&&i(a)})}function h(a,o){const c=a.replace(/\./g,"-"),l=document.getElementById(`etiqueta-${c}`);if(l){l.dataset.estado=o.estado,l.className=l.className.split(" ").filter(e=>!e.startsWith("estado-")).join(" ").trim(),l.classList.add(`estado-${o.estado}`);const u=l.querySelector('[id^="contenedor-svg-"]'),w=u==null?void 0:u.querySelector("svg");w&&(w.style.background=getComputedStyle(l).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(a,o.estado)}if(o.estado==="pendiente"){if(window.elementosAgrupadosScript){const e=window.elementosAgrupadosScript.find(d=>d.etiqueta&&String(d.etiqueta.etiqueta_sub_id)===String(a));e&&(e.colada_etiqueta=null,e.colada_etiqueta_2=null,e.elementos&&e.elementos.forEach(d=>{d.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:a}})))}const u=document.getElementById(`colada-${c}`);u&&(u.textContent="")}console.log(`‚úÖ DOM actualizado para ${a}: estado = ${o.estado}`)}function b(a,o){const c=a.replace(/\./g,"-"),l=document.querySelector(`#etiqueta-${c} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${a}, puede=${o}, btn encontrado=${!!l}`),l&&(l.disabled=!1,l.classList.remove("opacity-50","cursor-not-allowed"),l.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function g(){document.addEventListener("click",async a=>{const o=a.target.closest(".btn-deshacer");if(!o)return;a.preventDefault(),a.stopPropagation();const c=o.dataset.etiquetaId;if(!c){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await i(c)}),document.addEventListener("click",async a=>{const o=a.target.closest(".btn-historial");if(!o)return;a.preventDefault(),a.stopPropagation();const c=o.dataset.etiquetaId;c&&await x(c)}),console.log("‚úÖ Event listeners de historial inicializados")}function E(){let a=null;window.addEventListener("etiqueta-fabricada",o=>{var c;(c=o.detail)!=null&&c.etiquetaSubId&&(a=o.detail.etiquetaSubId)}),document.addEventListener("keydown",async o=>{var c,l;if(o.ctrlKey&&o.key==="z"&&!o.shiftKey){if(["INPUT","TEXTAREA"].includes((c=document.activeElement)==null?void 0:c.tagName))return;const u=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),w=((l=u==null?void 0:u.dataset)==null?void 0:l.etiquetaId)||a;w&&(o.preventDefault(),await i(w))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function t(){g(),E(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:i,puedeDeshacer:s,obtenerHistorial:n,mostrarHistorial:x,actualizarBoton:b},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t(),document.addEventListener("livewire:navigated",t)})();
