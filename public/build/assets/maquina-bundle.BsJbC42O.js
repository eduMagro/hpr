const Xt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Ut="rgba(0, 0, 0, 1)";function Ht(E,l){return!l||l===1?E.map(c=>({...c})):E.map(c=>c.type==="line"?{...c,length:(c.length||0)*l}:c.type==="arc"?{...c,radius:(c.radius||0)*l}:{...c})}const Yt=.75,Tt=14,Wt=60,Ft=[0,10,-10,20,-20,30,-30];function U(E){return E*Math.PI/180}function Jt(E){const l=E.closest(".proceso");return l&&getComputedStyle(l).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Qt(E,l,c){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");return s.setAttribute("viewBox","0 0 "+E+" "+l),s.setAttribute("preserveAspectRatio","xMidYMid meet"),s.style.width="100%",s.style.height="100%",s.style.display="block",s.style.background=c||"#ffffff",s.style.shapeRendering="geometricPrecision",s.style.textRendering="optimizeLegibility",s.style.boxSizing="border-box",s}function Kt(E,l,c,s){const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",l),i.setAttribute("stroke",c),i.setAttribute("fill","none"),i.setAttribute("stroke-width",s),i.setAttribute("vector-effect","non-scaling-stroke"),E.appendChild(i),i}function zt(E){let l="",c=Number(E)||0;for(;c>=0;){const s=c%26;l=String.fromCharCode(65+s)+l,c=Math.floor(c/26)-1}return l}const Zt=0,te=-25;function ee(E,l,c,s){if(!l||!l.length)return;const i=2,w=12,h=w+i,x=l.map(n=>(n.letter?n.letter+" ":"")+(n.text||"")),u=w*x.length+i*(x.length-1),b=Zt;let t=s-te-u+w/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let n=0;n<x.length;n++){const a=x[n],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",b),d.setAttribute("y",t),d.setAttribute("fill",Ut),d.setAttribute("font-size",w),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=a,E.appendChild(d);const p=Lt(a,w).w;window.__legendBoxesGroup.push({left:b,right:b+p,top:t-w/2,bottom:t+w/2}),t+=h}}function oe(E){const l=(E||"").split(/\s+/).filter(Boolean),c=[];for(let s=0;s<l.length;s++){const i=l[s];if(i.endsWith("r")){const w=parseFloat(i.slice(0,-1));let h=360;s+1<l.length&&l[s+1].endsWith("d")&&(h=parseFloat(l[++s].slice(0,-1))),c.push({type:"arc",radius:w,arcAngle:h})}else i.endsWith("d")?c.push({type:"turn",angle:parseFloat(i.slice(0,-1))}):c.push({type:"line",length:parseFloat(i)})}return c}function ae(E){let l=[],c=0,s=0,i=0;l.push({x:c,y:s});for(let w=0;w<E.length;w++){const h=E[w];if(h.type==="line")c+=h.length*Math.cos(U(i)),s+=h.length*Math.sin(U(i)),l.push({x:c,y:s});else if(h.type==="turn")i+=h.angle;else if(h.type==="arc"){const x=c+h.radius*Math.cos(U(i+90)),u=s+h.radius*Math.sin(U(i+90)),b=Math.atan2(s-u,c-x),t=b+U(h.arcAngle);c=x+h.radius*Math.cos(t),s=u+h.radius*Math.sin(t),i+=h.arcAngle,l.push({x:c,y:s})}}return l}function Rt(E){let l=[],c=0,s=0,i=0;for(let w=0;w<E.length;w++){const h=E[w];if(h.type==="line"){const x={x:c,y:s},u={x:c+h.length*Math.cos(U(i)),y:s+h.length*Math.sin(U(i))};l.push({start:x,end:u,length:h.length}),c=u.x,s=u.y}else if(h.type==="turn")i+=h.angle;else if(h.type==="arc"){const x=c+h.radius*Math.cos(U(i+90)),u=s+h.radius*Math.sin(U(i+90)),b=Math.atan2(s-u,c-x),t=b+U(h.arcAngle);c=x+h.radius*Math.cos(t),s=u+h.radius*Math.sin(t),i+=h.arcAngle}}return l}function Lt(E,l){const c=l||12;return{w:(E?E.length:0)*c*.55,h:c}}function it(E,l,c){const s=c||0;return!(E.right+s<l.left||E.left-s>l.right||E.bottom+s<l.top||E.top-s>l.bottom)}function Nt(E,l,c,s){const i=l/2;return Math.max(c+i,Math.min(s-i,E))}function ne(E,l){const s=[];let i=0;function w(){i>1e-9&&(s.push({type:"line",length:i}),i=0)}for(let h=0;h<E.length;h++){const x=E[h];if(x.type==="line"){i+=x.length;continue}if(x.type==="turn"){if(Math.abs(x.angle)<1e-9)continue;w(),s.push(x);continue}if(x.type==="arc"){w(),s.push(x);continue}w(),s.push(x)}return w(),s}function Vt(E,l){const c=l&&l.decimals||0,s=l&&l.step||null;let i=Number(E||0);return s&&s>0&&(i=Math.round(i/s)*s),i.toFixed(c).replace(/\.0+$/,"")}function ie(E,l){const c=Math.hypot(E,l)||1;let s=E/c,i=l/c;return(i<-1e-9||Math.abs(i)<=1e-9&&s<0)&&(s=-s,i=-i),{ux:s,uy:i}}function jt(E,l,c){const s=c||.01,i=ie(E,l),w=Math.round(i.ux/s)*s,h=Math.round(i.uy/s)*s;return w+"|"+h}function se(E,l,c){const s=c&&c.dirPrecision||.01,i=c&&c.labelFormat||{decimals:0,step:null},w=E.reduce((d,p)=>d+Math.hypot(p.end.x-p.start.x,p.end.y-p.start.y),0),h=l.reduce((d,p)=>d+(p.length||Math.hypot(p.end.x-p.start.x,p.end.y-p.start.y)),0),x=h>0?w/h:1,u=new Map;for(let d=0;d<l.length;d++){const p=l[d],y=p.end.x-p.start.x,r=p.end.y-p.start.y,e=jt(y,r,s),o=u.get(e)||[];o.push({length:p.length||Math.hypot(y,r),index:d}),u.set(e,o)}const b=l.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),t=new Set,n=new Set,a=[];for(let d=0;d<E.length;d++){const p=E[d],y=p.end.x-p.start.x,r=p.end.y-p.start.y,e=jt(y,r,s),o=u.get(e)||[],m=Math.hypot(y,r);let g=m;if(o.length){const v=m/x;let q=null,S=1/0;for(const _ of o){const T=Math.abs(_.length-v),L=n.has(_.index)?.1:0;T+L<S&&(q=_,S=T+L)}q&&(g=q.length,n.add(q.index))}else d<b.length&&(g=b[d]);const f=Vt(g,i),A=e+"|"+f;t.has(A)||(t.add(A),a.push({start:p.start,end:p.end,_dirKey:e,_label:f,_lenChosen:g}))}return a}function re(E,l){const c=l,s=E.map(r=>Object.assign({},r));let i=0,w=0,h=0;const x=[];let u=null,b=-1,t=-1;const n=1e-7;function a(r){return r*Math.PI/180}function d(r){return Math.abs(Math.sin(a(r)))<1e-12}function p(r,e,o,m){return Math.min(e,m)-Math.max(r,o)>n}for(let r=0;r<s.length;r++){let o=function(){const v={x:Math.cos(a(h)),y:Math.sin(a(h))},q=i+s[r].length*v.x,S=w+s[r].length*v.y,_=d(h);for(let T=0;T<x.length;T++){const L=x[T];if(_&&L.horiz&&Math.abs(w-L.y)<n){if(p(Math.min(i,q),Math.max(i,q),Math.min(L.x1,L.x2),Math.max(L.x1,L.x2))&&u&&b>=0&&t>=0)return s[t].length+=c,i+=u.x*c,w+=u.y*c,x[b].x2+=u.x*c,x[b].y2+=u.y*c,!0}else if(!_&&!L.horiz&&Math.abs(i-L.x)<n&&p(Math.min(w,S),Math.max(w,S),Math.min(L.y1,L.y2),Math.max(L.y1,L.y2))&&u&&b>=0&&t>=0)return s[t].length+=c,i+=u.x*c,w+=u.y*c,x[b].x2+=u.x*c,x[b].y2+=u.y*c,!0}return!1};var y=o;const e=s[r];if(e.type==="turn"){h+=e.angle;continue}if(e.type==="arc"){const v=i+e.radius*Math.cos(a(h+90)),q=w+e.radius*Math.sin(a(h+90)),S=Math.atan2(w-q,i-v),_=S+a(e.arcAngle);i=v+e.radius*Math.cos(_),w=q+e.radius*Math.sin(_),h+=e.arcAngle,u=null;continue}for(;o(););const m={x:Math.cos(a(h)),y:Math.sin(a(h))},g=i+s[r].length*m.x,f=w+s[r].length*m.y,A=d(h);x.push({x1:i,y1:w,x2:g,y2:f,horiz:A,y:w,x:i}),u=m,b=x.length-1,t=r,i=g,w=f}return s}function _t(E,l,c,s){const i=U(s),w=Math.cos(i),h=Math.sin(i),x=E.x-l,u=E.y-c;return{x:l+x*w-u*h,y:c+x*h+u*w}}function ce(E,l,c,s,i,w,h,x,u){let b="",t=0,n=0,a=0,d=!1;function p(r,e){const o=_t({x:r,y:e},l,c,s);return{x:x+(o.x-w)*i,y:u+(o.y-h)*i}}function y(){if(!d){const r=p(t,n);b+="M "+r.x+" "+r.y,d=!0}}for(let r=0;r<E.length;r++){const e=E[r];if(e.type==="turn"){a+=e.angle;continue}if(e.type==="line"){const o=t+e.length*Math.cos(U(a)),m=n+e.length*Math.sin(U(a));y();const g=p(o,m);b+=" L "+g.x+" "+g.y,t=o,n=m;continue}if(e.type==="arc"){const o=t+e.radius*Math.cos(U(a+90)),m=n+e.radius*Math.sin(U(a+90)),g=Math.atan2(n-m,t-o),f=g+U(e.arcAngle),A=o+e.radius*Math.cos(f),v=m+e.radius*Math.sin(f),q=Math.abs(e.arcAngle)%360;if(y(),q<1e-6||Math.abs(e.arcAngle)>=359.9){const G=g+Math.sign(e.arcAngle)*Math.PI,V=o+e.radius*Math.cos(G),C=m+e.radius*Math.sin(G),M=p(V,C),I=p(t,n),$=e.radius*i,P=e.arcAngle>=0?1:0;b+=" A "+$+" "+$+" 0 1 "+P+" "+M.x+" "+M.y,b+=" A "+$+" "+$+" 0 1 "+P+" "+I.x+" "+I.y,a+=e.arcAngle;continue}const S=p(A,v),_=e.radius*i,T=q>180?1:0,L=e.arcAngle>=0?1:0;b+=" A "+_+" "+_+" 0 "+T+" "+L+" "+S.x+" "+S.y,t=A,n=v,a+=e.arcAngle}}return b||"M 0 0"}function le(E){const l=ae(E);let c=Math.min(...l.map(y=>y.x)),s=Math.max(...l.map(y=>y.x)),i=Math.min(...l.map(y=>y.y)),w=Math.max(...l.map(y=>y.y));const h=(c+s)/2,x=(i+w)/2,b=w-i>s-c?-90:0,t=l.map(y=>_t(y,h,x,b));c=Math.min(...t.map(y=>y.x)),s=Math.max(...t.map(y=>y.x)),i=Math.min(...t.map(y=>y.y)),w=Math.max(...t.map(y=>y.y));const n=Math.max(1,s-c),a=Math.max(1,w-i),d=(c+s)/2,p=(i+w)/2;return{rotDeg:b,w:n,h:a,cxModel:h,cyModel:x,midX:d,midY:p,ptsRot:t}}function de(E){const l=[];let c=0,s=0,i=0;function w(h){const x=U(h);return{x:Math.cos(x),y:Math.sin(x)}}for(let h=0;h<E.length;h++){const x=E[h];if(x.type==="line")c+=x.length*Math.cos(U(i)),s+=x.length*Math.sin(U(i));else if(x.type==="turn"){const u=w(i),b=x.angle;i+=b;const t=w(i);l.push({x:c,y:s,angleDeg:b,prevDir:u,nextDir:t})}else if(x.type==="arc"){const u=c+x.radius*Math.cos(U(i+90)),b=s+x.radius*Math.sin(U(i+90)),t=Math.atan2(s-b,c-u),n=t+U(x.arcAngle);c=u+x.radius*Math.cos(n),s=b+x.radius*Math.sin(n),i+=x.arcAngle}}return l}function ue(E,l,c){const s=Array.from({length:l},()=>({sumH:0,maxW:0,items:[]})),i=[...E.keys()].sort((w,h)=>E[h].h-E[w].h);for(const w of i){let h=0,x=1/0;for(let b=0;b<l;b++){const t=s[b],n=t.sumH+(t.items.length>0?c:0)+E[w].h;n<x&&(x=n,h=b)}const u=s[h];u.sumH=u.items.length>0?u.sumH+c+E[w].h:u.sumH+E[w].h,u.maxW=Math.max(u.maxW,E[w].w),u.items.push(w)}return s}function pe(E,l,c,s={}){const i=s.padding??12,w=s.gapCol??12,h=s.gapRow??10,x=Math.max(1,Math.min(E.length,s.kMax??4)),u=Math.max(10,l-2*i),b=Math.max(10,c-2*i),t=n(E);function n(o){const m=o.map($=>$.w/Math.max($.h,1)),g=o.map($=>$.h),f=o.map($=>$.w),A=o.map($=>$.w*$.h),v=$=>$.reduce((P,F)=>P+F,0)/$.length,q=($,P)=>$.reduce((F,D)=>F+Math.pow(D-P,2),0)/$.length,S=($,P)=>Math.sqrt(q($,P)),_=v(m),T=v(g),L=v(f),G=A.reduce(($,P)=>$+P,0),V=S(g,T),C=S(f,L),M=T>0?V/T:0,I=L>0?C/L:0;return{avgAspectRatio:_,avgHeight:T,avgWidth:L,totalArea:G,heightCV:M,widthCV:I,isLinear:_>6||T<L*.12,isUniformHeight:M<.15,isUniformWidth:I<.15,isHighlyVariable:M>.5||I>.5,count:o.length}}let a={S:0,k:1,cols:null,score:0};for(let o=1;o<=x;o++){const m=ue(E,o,h),g=m.reduce((D,J)=>D+J.maxW,0)+w*(o-1),f=Math.max(...m.map(D=>D.sumH));if(g<=0||f<=0)continue;const A=u/g,v=b/f,q=Math.min(A,v),S=Math.max(.01,q*.92),_=t.totalArea*S*S,T=u*b,L=_/T,G=m.map(D=>D.sumH*S),V=G.reduce((D,J)=>D+J,0)/o,C=Math.max(...G)-Math.min(...G),M=V>0?1-C/V:1,I=o===1?1.1:o===2?.9:.7,$=o>t.count*.5?.7:1,P=M>.85?1.05:1,F=S*(1+L*.25)*(1+M*.1)*I*$*P;F>a.score&&(a={S,k:o,cols:m,score:F,efficiency:L,colBalance:M})}const d=a.cols.map(o=>o.maxW*a.S),p=d.reduce((o,m)=>o+m,0);let y=[];if(a.k===1)y[0]=l/2;else{const o=(a.k-1)*w,m=p+o;if(m<u){const g=u-m,f=w+g/(a.k-1);let A=i;for(let v=0;v<a.k;v++)y[v]=A+d[v]/2,A+=d[v]+f}else{let g=i+Math.max(0,(u-m)/2);for(let f=0;f<a.k;f++)y[f]=g+d[f]/2,g+=d[f]+w}}const r=[],e=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(o=>o.right));for(let o=0;o<a.k;o++){const m=a.cols[o];r[o]=[];const g=m.items.map(C=>E[C].h*a.S),f=g.reduce((C,M)=>C+M,0);if(m.items.length===0)continue;const A=y[o],v=a.cols[o].maxW*a.S,q=A-v/2,S=A+v/2,_=e(),L=Math.max(0,Math.min(S,_)-q)/v,G=L>.05;let V=b;if(G&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const M=Math.min(...window.__legendBoxesGroup.map(I=>I.top))-15;V=Math.max(10,M-i),console.log(`üìè Columna ${o}: X=${q.toFixed(0)}-${S.toFixed(0)}, legendWidth=${_.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura reducida a ${V.toFixed(0)}px`)}else console.log(`üìè Columna ${o}: X=${q.toFixed(0)}-${S.toFixed(0)}, legendWidth=${_.toFixed(0)}, solape=${(L*100).toFixed(0)}%, altura completa ${V.toFixed(0)}px`);if(m.items.length===1){const C=g[0],M=i+V/2,I=Math.max(i+C/2,Math.min(M,c-i-C/2));r[o].push(I);continue}if(f>V){console.warn(`Columna ${o}: elementos no caben (${f}px > ${V}px)`);const I=f/m.items.length<4?20:5;let $=i;for(let P=0;P<m.items.length;P++){const F=Math.max(g[P],2),D=$+F/2;r[o].push(D),$+=F+I}}else{const C=V-f,M=m.items.length-1;let I=C/M;f/m.items.length<4?I=Math.max(18,Math.min(I,50)):I=Math.max(5,I);const F=f+M*I,D=V-F;let J=i+Math.max(0,D/2);for(let pt=0;pt<m.items.length;pt++){const O=Math.max(g[pt],2),z=J+O/2,st=i+V-O/2,B=Math.max(i+O/2,Math.min(z,st));r[o].push(B),J+=O+I}}}return{S:a.S,k:a.k,cols:a.cols,centersX:y,centersYByCol:r,padding:i,gapRow:h,gapCol:w}}window.renderizarGrupoSVG=function(l,c){const s=l&&l.etiqueta&&l.etiqueta.id!=null?l.etiqueta.id:l&&l.id!=null?l.id:c,i=document.getElementById("contenedor-svg-"+s);if(!i)return;const w=600,h=150,x=Jt(i),u=Qt(w,h,x);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const b=[],t=new Map;(l.elementos||[]).forEach(r=>{var g,f,A,v,q,S;let e="0";if(r.diametro!=null&&r.diametro!==""){const T=String(r.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(T){const L=parseFloat(T[0]);isFinite(L)&&(e=String(Math.round(L)))}}const o=(r.dimensiones||"barra").trim().toLowerCase(),m=`${e}|${o}`;if(t.has(m)){const _=t.get(m);b[_].barrasTotal+=r.barras||0,(g=r.coladas)!=null&&g.colada1&&!b[_].coladasSet.has(r.coladas.colada1)&&b[_].coladasSet.add(r.coladas.colada1),(f=r.coladas)!=null&&f.colada2&&!b[_].coladasSet.has(r.coladas.colada2)&&b[_].coladasSet.add(r.coladas.colada2),(A=r.coladas)!=null&&A.colada3&&!b[_].coladasSet.has(r.coladas.colada3)&&b[_].coladasSet.add(r.coladas.colada3)}else{const _=new Set;(v=r.coladas)!=null&&v.colada1&&_.add(r.coladas.colada1),(q=r.coladas)!=null&&q.colada2&&_.add(r.coladas.colada2),(S=r.coladas)!=null&&S.colada3&&_.add(r.coladas.colada3),b.push({elemento:r,diametro:e,dimensiones:r.dimensiones,barrasTotal:r.barras||0,coladasSet:_}),t.set(m,b.length-1)}});const n=b.map((r,e)=>{const o=[];l.colada_etiqueta&&o.push(l.colada_etiqueta),l.colada_etiqueta_2&&l.colada_etiqueta_2!==l.colada_etiqueta&&o.push(l.colada_etiqueta_2),o.length===0&&r.coladasSet.size>0&&o.push(...r.coladasSet);const m=o.length>0?` (${o.join(", ")})`:"";return{letter:zt(e),text:`√ò${r.diametro} x${r.barrasTotal}${m}`}});ee(u,n,w,h);const a=b.map(r=>{const e=r.elemento,o=oe(e.dimensiones||""),m=ne(o);let g=0;for(const S of m)S.type==="line"&&(g=Math.max(g,Math.abs(S.length||0))),S.type==="arc"&&(g=Math.max(g,Math.abs(S.radius||0)));const A=g<=50?2:1,v=Ht(m,A),q=le(v);return{dimsRaw:o,dimsNoZero:m,dimsScaled:v,geomScale:A,medida:q}}),d=a.map(r=>r.medida),p=pe(d,w,h,{padding:20,gapCol:50,gapRow:22,kMax:3}),y=new Map;for(let r=0;r<p.k;r++)p.cols[r].items.forEach((e,o)=>y.set(e,{c:r,j:o}));b.forEach(function(r,e){const o=r.elemento,{dimsNoZero:m,dimsScaled:g,medida:f}=a[e],A=y.get(e),v=p.centersX[A.c],q=p.centersYByCol[A.c][A.j],S=p.S,_=f.ptsRot.map(O=>({x:v+(O.x-f.midX)*S,y:q+(O.y-f.midY)*S})),T=Math.min(..._.map(O=>O.x)),L=Math.max(..._.map(O=>O.x)),G=Math.min(..._.map(O=>O.y)),V=Math.max(..._.map(O=>O.y)),C={left:T,right:L,top:G,bottom:V};window.__figBoxesGroup.push({...C});const M=re(g,.6),I=ce(M,f.cxModel,f.cyModel,f.rotDeg,S,f.midX,f.midY,v,q),$=Kt(u,I,Xt,2);(function(){const z=de(g);function st(N){return Math.abs(Math.abs(N)-90)>=Yt}const B=(N,k)=>_t({x:N.x,y:N.y},0,0,k),Q=(N,k)=>{const K=_t({x:N,y:k},f.cxModel,f.cyModel,f.rotDeg);return{x:v+(K.x-f.midX)*S,y:q+(K.y-f.midY)*S}},R=N=>Math.max(10,Math.min(28,N));z.forEach(N=>{if(!st(N.angleDeg))return;const k=Q(N.x,N.y),K=B(N.prevDir,f.rotDeg),gt=B(N.nextDir,f.rotDeg),Z=Math.atan2(K.y,K.x),X=Z+U(N.angleDeg),tt=Math.min(C.right-C.left,C.bottom-C.top);let j=R(.12*tt);const wt=k.x+j*Math.cos(Z),ht=k.y+j*Math.sin(Z),W=k.x+j*Math.cos(X),bt=k.y+j*Math.sin(X),et=Math.abs(N.angleDeg),ct=et>180?1:0,Ct=N.angleDeg>=0?1:0,lt=document.createElementNS("http://www.w3.org/2000/svg","path");lt.setAttribute("d",`M ${wt} ${ht} A ${j} ${j} 0 ${ct} ${Ct} ${W} ${bt}`),lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.setAttribute("fill","none"),lt.style.pointerEvents="none",u.appendChild(lt);let H=K.x+gt.x,Y=K.y+gt.y;et>180&&(H=-H,Y=-Y);let ot=Math.hypot(H,Y);if(ot<1e-6){const ut=N.angleDeg>=0?1:-1;H=-K.y*ut,Y=K.x*ut,ot=Math.hypot(H,Y)||1}H/=ot,Y/=ot;const at=(Math.round(N.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",nt=Lt(at,14);function At(ut,mt){return{left:ut-nt.w/2,right:ut+nt.w/2,top:mt-nt.h/2,bottom:mt+nt.h/2}}let rt=null;for(let ut=Tt;ut<=Wt&&!rt;ut+=4)for(let mt=0;mt<Ft.length&&!rt;mt++){const xt=Ft[mt],Et=B({x:H,y:Y},xt),St=k.x+Et.x*(j+ut),ft=k.y+Et.y*(j+ut),yt=At(St,ft);yt.top<0||yt.bottom>h||yt.left<0||yt.right>w||window.__figBoxesGroup.some(qt=>it(qt,yt,6))||(window.__dimBoxesGroup||[]).some(qt=>it(qt,yt,2))||(window.__angleBoxesGroup||[]).some(qt=>it(qt,yt,2))||(window.__placedLetterBoxes||[]).some(qt=>it(qt,yt,2))||(window.__legendBoxesGroup||[]).some(qt=>it(qt,yt,6))||(rt={x:St,y:ft,box:yt})}if(!rt){const ut=k.x+H*(j+Tt),mt=k.y+Y*(j+Tt),xt=At(ut,mt);rt={x:ut,y:mt,box:xt}}window.__angleBoxesGroup.push(rt.box);const dt=document.createElementNS("http://www.w3.org/2000/svg","text");dt.setAttribute("x",rt.x),dt.setAttribute("y",rt.y),dt.setAttribute("fill",Bt),dt.setAttribute("font-size",14),dt.setAttribute("text-anchor","middle"),dt.setAttribute("alignment-baseline","middle"),dt.style.cursor="pointer",dt.textContent=at,u.appendChild(dt),dt.addEventListener("mouseenter",()=>{lt.setAttribute("stroke","rgba(255,69,0,1)"),lt.setAttribute("stroke-width","3"),lt.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),dt.addEventListener("mouseleave",()=>{lt.setAttribute("stroke","rgba(255,99,71,0.7)"),lt.setAttribute("stroke-width","2"),lt.style.filter="none"})})})();const P=$.cloneNode(!1);P.setAttribute("stroke-width","50"),P.setAttribute("stroke","transparent"),P.setAttribute("fill","none"),P.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(O=>{P.addEventListener(O,z=>$.dispatchEvent(new z.constructor(z.type,z)))}),u.insertBefore(P,$),(o.codigo!=null?o.codigo:o.id)+"",$.style.cursor="pointer",$.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),$.addEventListener("click",function(O){if(O.ctrlKey||O.metaKey||O.shiftKey){O.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(o.id);return}abrirModalDividirElemento(o.id,o.barras||0)}),$.addEventListener("contextmenu",function(O){O.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(o.id)});const F=[],D=Rt(M),J=Rt(m);se(D,J,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(O){const z=_t(O.start,f.cxModel,f.cyModel,f.rotDeg),st=_t(O.end,f.cxModel,f.cyModel,f.rotDeg),B={x:v+(z.x-f.midX)*S,y:q+(z.y-f.midY)*S},Q={x:v+(st.x-f.midX)*S,y:q+(st.y-f.midY)*S},R=O._label,N=Q.x-B.x,k=Q.y-B.y,K=Math.hypot(N,k)||1,gt=N/K,Z=k/K,X=k/K,tt=-N/K,j=(B.x+Q.x)/2,wt=(B.y+Q.y)/2,ht=j+X*10,W=wt+tt*10,bt=Lt(R,14),et=bt.w,ct=bt.h;function Ct(rt,dt){return{left:rt-et/2,right:rt+et/2,top:dt-ct/2,bottom:dt+ct/2}}const lt=K*.45;let H=ht,Y=W;for(let rt=0;rt<=Math.ceil(lt/6);rt++){const dt=rt%2===0?1:-1,ut=Math.ceil(rt/2),mt=dt*ut*6;if(Math.abs(mt)>lt)continue;const xt=ht+gt*mt,Et=W+Z*mt,St=(xt-B.x)*gt+(Et-B.y)*Z;if(St<0+et*.3||St>K-et*.3)continue;const ft=Ct(xt,Et);if(!(it({left:Math.min(B.x,Q.x),right:Math.max(B.x,Q.x),top:Math.min(B.y,Q.y),bottom:Math.max(B.y,Q.y)},ft,0)||(window.__angleBoxesGroup||[]).some(vt=>it(vt,ft,2))||(window.__legendBoxesGroup||[]).some(vt=>it(vt,ft,6))||F.some(vt=>it(vt,ft,2))||ft.top<0||ft.bottom>h||ft.left<0||ft.right>w)){H=xt,Y=Et,F.push(ft),window.__dimBoxesGroup.push(ft);break}}const ot=document.createElementNS("http://www.w3.org/2000/svg","line");ot.setAttribute("x1",B.x),ot.setAttribute("y1",B.y),ot.setAttribute("x2",Q.x),ot.setAttribute("y2",Q.y),ot.setAttribute("stroke","rgba(0,0,255,0.6)"),ot.setAttribute("stroke-width","4"),ot.setAttribute("stroke-linecap","round"),ot.setAttribute("vector-effect","non-scaling-stroke"),ot.style.opacity=0,ot.style.pointerEvents="none",ot.style.transition="opacity 120ms ease",u.appendChild(ot);const at=document.createElementNS("http://www.w3.org/2000/svg","text");at.setAttribute("x",H),at.setAttribute("y",Y),at.setAttribute("fill",Bt),at.setAttribute("font-size",14),at.setAttribute("text-anchor","middle"),at.setAttribute("alignment-baseline","middle"),at.setAttribute("tabindex","0"),at.style.cursor="pointer",at.textContent=R,u.appendChild(at);function nt(){ot.style.opacity=1}function At(){ot.style.opacity=0}at.addEventListener("mouseenter",nt),at.addEventListener("mouseleave",At),at.addEventListener("focus",nt),at.addEventListener("blur",At)}),function(){const z=[];let st=0,B=0,Q=0;for(let R=0;R<g.length;R++){const N=g[R];if(N.type==="line")st+=N.length*Math.cos(U(Q)),B+=N.length*Math.sin(U(Q));else if(N.type==="turn")Q+=N.angle;else if(N.type==="arc"){const k=st+N.radius*Math.cos(U(Q+90)),K=B+N.radius*Math.sin(U(Q+90)),gt=Math.atan2(B-K,st-k),Z=gt+U(N.arcAngle);let X=N.radius;for(let tt=0;tt<m.length;tt++){const j=m[tt];if(j.type==="arc"&&Math.abs(j.arcAngle-N.arcAngle)<.01){X=j.radius;break}}z.push({center:{x:k,y:K},radius:N.radius,originalRadius:X,arcAngle:N.arcAngle,startAngle:gt,endAngle:Z}),st=k+N.radius*Math.cos(Z),B=K+N.radius*Math.sin(Z),Q+=N.arcAngle}}z.forEach(function(R){const N=_t(R.center,f.cxModel,f.cyModel,f.rotDeg),k={x:v+(N.x-f.midX)*S,y:q+(N.y-f.midY)*S},K=(R.startAngle+R.endAngle)/2,gt=R.radius*S,Z="R"+Vt(R.originalRadius,{decimals:0,step:null}),X=Lt(Z,14),tt=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let j=!1,wt,ht,W;for(let nt=0;nt<tt.length&&!j;nt++){const At=tt[nt],rt=K+U(At),dt={x:R.center.x+R.radius*Math.cos(rt),y:R.center.y+R.radius*Math.sin(rt)},ut=_t(dt,f.cxModel,f.cyModel,f.rotDeg),mt={x:v+(ut.x-f.midX)*S,y:q+(ut.y-f.midY)*S},xt=mt.x-k.x,Et=mt.y-k.y,St=Math.hypot(xt,Et)||1,ft=xt/St,yt=Et/St;for(let Mt=8;Mt<=60&&!j;Mt+=6){const $t=gt*.7;if(wt=k.x+ft*$t+ft*Mt,ht=k.y+yt*$t+yt*Mt,W={left:wt-X.w/2,right:wt+X.w/2,top:ht-X.h/2,bottom:ht+X.h/2},!(W.top<0||W.bottom>h||W.left<0||W.right>w||window.__figBoxesGroup.some(It=>it(It,W,2))||(window.__legendBoxesGroup||[]).some(It=>it(It,W,2)))){j=!0;break}}}if(!j)return;F.push(W);const bt={x:wt-k.x,y:ht-k.y},et=Math.hypot(bt.x,bt.y)||1,ct={x:bt.x/et,y:bt.y/et},Ct=k.x+ct.x*gt*.6,lt=k.y+ct.y*gt*.6,H=document.createElementNS("http://www.w3.org/2000/svg","line");H.setAttribute("x1",k.x),H.setAttribute("y1",k.y),H.setAttribute("x2",Ct),H.setAttribute("y2",lt),H.setAttribute("stroke","rgba(0,128,0,0.6)"),H.setAttribute("stroke-width","4"),H.setAttribute("stroke-linecap","round"),H.setAttribute("vector-effect","non-scaling-stroke"),H.style.opacity=0,H.style.pointerEvents="none",H.style.transition="opacity 120ms ease",u.appendChild(H);const Y=document.createElementNS("http://www.w3.org/2000/svg","text");Y.setAttribute("x",wt),Y.setAttribute("y",ht),Y.setAttribute("fill",Bt),Y.setAttribute("font-size",14),Y.setAttribute("text-anchor","middle"),Y.setAttribute("alignment-baseline","middle"),Y.setAttribute("tabindex","0"),Y.style.cursor="pointer",Y.textContent=Z,u.appendChild(Y);function ot(){H.style.opacity=1}function at(){H.style.opacity=0}Y.addEventListener("mouseenter",ot),Y.addEventListener("mouseleave",at),Y.addEventListener("focus",ot),Y.addEventListener("blur",at)})}(),function(){const z=zt(e),st=14,B=Lt(z,st);function Q(X,tt){return{left:X,right:X+B.w,top:tt-B.h/2,bottom:tt+B.h/2}}let R=null;const N=(C.top+C.bottom)/2,k=Math.max(B.h/2,Math.min(N,h-B.h/2));function K(X){for(let j=0;j<=30;j+=4){const wt=j%2===0?1:-1,ht=Math.ceil(j/2),W=wt*ht*4,bt=Math.max(B.h/2,Math.min(h-B.h/2,k+W)),et=X,ct=Q(et,bt);if(!(window.__figBoxesGroup.some(nt=>it(nt,ct,6))||(window.__dimBoxesGroup||[]).some(nt=>it(nt,ct,3))||(window.__angleBoxesGroup||[]).some(nt=>it(nt,ct,3))||(window.__legendBoxesGroup||[]).some(nt=>it(nt,ct,6))||(window.__placedLetterBoxes||[]).some(nt=>it(nt,ct,2))||ct.top<0||ct.bottom>h||ct.left<0||ct.right>w))return R={x:et,y:bt,box:ct},!0}return!1}const gt=[{x:C.right+10,priority:1},{x:C.left-10-B.w,priority:1},{x:C.right+15,priority:2},{x:C.left-15-B.w,priority:2},{x:C.right+5,priority:2},{x:C.left-5-B.w,priority:2},{x:C.right+20,priority:3},{x:C.left-20-B.w,priority:3},{x:C.right+25,priority:3},{x:C.left-25-B.w,priority:3},{x:C.right+30,priority:3},{x:C.left-30-B.w,priority:3}];gt.sort((X,tt)=>X.priority-tt.priority);for(const X of gt){if(R)break;const tt=Nt(X.x,B.w,0,w);if(K(tt))break}if(!R){const X=(C.left+C.right)/2,tt=[{x:X-B.w/2,y:C.top-B.h-5},{x:X-B.w/2,y:C.bottom+B.h+5}];for(const j of tt){if(R)break;const wt=Nt(j.x,B.w,0,w),ht=Math.max(B.h/2,Math.min(h-B.h/2,j.y)),W=Q(wt,ht);!window.__figBoxesGroup.some(et=>it(et,W,6))&&!(window.__dimBoxesGroup||[]).some(et=>it(et,W,3))&&!(window.__angleBoxesGroup||[]).some(et=>it(et,W,3))&&!(window.__legendBoxesGroup||[]).some(et=>it(et,W,6))&&!(window.__placedLetterBoxes||[]).some(et=>it(et,W,2))&&W.top>=0&&W.bottom<=h&&W.left>=0&&W.right<=w&&(R={x:wt,y:ht,box:W})}}if(!R){const X=Nt(w-B.w,B.w,0,w),tt=k;R={x:X,y:tt,box:Q(X,tt)}}window.__placedLetterBoxes.push(R.box);const Z=document.createElementNS("http://www.w3.org/2000/svg","text");Z.setAttribute("x",R.x),Z.setAttribute("y",R.y),Z.setAttribute("fill",Ut),Z.setAttribute("font-size",st),Z.setAttribute("text-anchor","start"),Z.setAttribute("alignment-baseline","middle"),Z.style.fontWeight="600",Z.style.pointerEvents="none",Z.textContent=z,u.appendChild(Z)}()}),i.innerHTML="",i.appendChild(u)};function Dt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const E=window.elementosAgrupadosScript;if(!E)return;const l=document.getElementById("grid-maquina");if(l&&window.updateGridClasses){const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}E.forEach(function(c,s){renderizarGrupoSVG(c,s)}),requestAnimationFrame(()=>{l&&(l.style.opacity="1",l.style.visibility="visible",l.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",l.className)),document.querySelectorAll(".proceso").forEach(c=>{c.style.opacity="1"})}),window.actualizarSVGConColadas=function(c,s){if(!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,w=i.findIndex(x=>x.etiqueta&&String(x.etiqueta.etiqueta_sub_id)===String(c));if(w===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const h=i[w];h.elementos&&s&&h.elementos.forEach(x=>{const u=String(x.id),b=s[u];x.coladas||(x.coladas={colada1:null,colada2:null,colada3:null}),b&&Array.isArray(b)&&(x.coladas.colada1=b[0]||null,x.coladas.colada2=b[1]||null,x.coladas.colada3=b[2]||null)}),renderizarGrupoSVG(h,w),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${c}`,s)},window.limpiarColadasSVG=function(c){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,i=s.findIndex(h=>h.etiqueta&&String(h.etiqueta.etiqueta_sub_id)===String(c));if(i===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${c}`);return}const w=s[i];w.elementos&&w.elementos.forEach(h=>{h.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(w,i),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${c}`)},window.addEventListener("regenerar-svg-etiqueta",function(c){var x;const s=(x=c.detail)==null?void 0:x.etiquetaSubId;if(!s||!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,w=i.findIndex(u=>u.etiqueta&&String(u.etiqueta.etiqueta_sub_id)===String(s));if(w===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${s}`);return}const h=i[w];renderizarGrupoSVG(h,w),console.log(`üîÑ SVG regenerado para etiqueta ${s} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);window.abrirModalDividirElemento=function(l,c){const s=document.getElementById("modalDividirElemento"),i=document.getElementById("dividir_elemento_id"),w=document.getElementById("dividir_barras_totales"),h=document.getElementById("labelBarrasActuales"),x=document.getElementById("barras_a_mover"),u=document.getElementById("previewDivision"),b=document.getElementById("formDividirElemento");if(!s||!i||!b)return;i.value=l;let t=null,n=parseInt(c)||0;if(window.elementosAgrupadosScript){for(const e of window.elementosAgrupadosScript)if(e.elementos){const o=e.elementos.find(m=>String(m.id)===String(l));if(o){t=o,o.barras&&(n=parseInt(o.barras)||0);break}}}if(!t&&window.gruposResumenData){for(const e of window.gruposResumenData)if(e.elementos){const o=e.elementos.find(m=>String(m.id)===String(l));if(o){t=o,o.barras&&(n=parseInt(o.barras)||0);break}}}const a=t&&t.estado==="fabricado",d=t&&t.paquete_id,p=a||d,y=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),r=y==null?void 0:y.closest("label");if(y){if(y.disabled=p,r)if(p){r.classList.add("opacity-50","cursor-not-allowed");let e=a?"El elemento ya est√° fabricado":"El elemento pertenece a un paquete";r.setAttribute("title",e)}else r.classList.remove("opacity-50","cursor-not-allowed"),r.removeAttribute("title");if(p&&y.checked){const e=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');e&&(e.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}w&&(w.value=n),h&&(h.textContent=n>0?n:"-"),x&&(x.value=""),u&&u.classList.add("hidden"),window.rutaDividirElemento&&b.setAttribute("action",window.rutaDividirElemento),s.classList.remove("hidden")};window.enviarDivision=async function(){const l=document.getElementById("formDividirElemento"),c=l.getAttribute("action")||window.rutaDividirElemento,s=new FormData(l);try{const i=document.querySelector('meta[name="csrf-token"]'),w=s.get("_token")||(i?i.getAttribute("content"):null),x=await fetch(c,{method:"POST",headers:w?{"X-CSRF-TOKEN":w}:{},body:s}),u=await x.json();if(!x.ok||!u.success)throw new Error(u.message||"Error al dividir");l.reset();const b=document.getElementById("modalDividirElemento");b&&b.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",u.message,"success"):alert(u.message)}catch(i){window.Swal?window.Swal.fire("Error",i&&i.message||"Error","error"):alert(i&&i.message||"Error")}};(function(E){const l={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},c={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function s(u,b,t={}){console.log(`üîÑ Actualizando etiqueta ${u} a estado: ${b}`);const n=String(u).replace(/\./g,"-"),a=document.querySelector(`#etiqueta-${n}`);if(!a)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${u}`),!1;const d=String(b).toLowerCase().trim(),p=c[d];if(!p)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${b}`),!1;a.dataset.estado=d,Array.from(a.classList).forEach(o=>{o.startsWith("estado-")&&a.classList.remove(o)}),a.classList.add(p.cssClass),a.style.setProperty("--bg-estado",p.bgColor);const r=a.querySelector('[id^="contenedor-svg-"]');if(r){const o=r.querySelector("svg");o&&(o.style.background=p.bgColor)}const e=a.querySelector(".etiqueta-card")||a;return e&&(e.style.background=p.bgColor),i(a,d),w(a),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:u,estado:d,datosExtra:t}})),console.log(`‚úÖ Etiqueta ${u} actualizada a ${b}`),!0}function i(u,b){const t=u.querySelectorAll(".btn-fabricar"),n=["empaquetada","en-paquete"];t.forEach(a=>{n.includes(b)?(a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed",a.title=`Etiqueta ya ${b}`):(a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer",a.title="Fabricar esta etiqueta")})}function w(u){u.style.transition="transform 0.5s ease, background-color 0.5s ease",u.style.transform="scale(1.03)",setTimeout(()=>{u.style.transform="scale(1)"},400)}function h(u,b,t={}){console.log(`üîÑ Actualizando ${u.length} etiquetas...`);const a=u.map(d=>s(d,b,t)).filter(d=>d).length;return console.log(`‚úÖ ${a}/${u.length} etiquetas actualizadas`),a}function x(u){const b=String(u).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${b}`);return t?{id:u,estado:t.dataset.estado||"desconocido",elemento:t}:null}window.addEventListener("paquete:creado",u=>{const{codigoPaquete:b,etiquetaIds:t}=u.detail;console.log(`üì¶ Evento paquete:creado recibido - ${b} con ${t.length} etiquetas`),h(t,"empaquetada",{codigo_paquete:b})}),E.SistemaDOM={actualizarEstadoEtiqueta:s,actualizarMultiplesEtiquetas:h,obtenerEstadoActual:x,ESTADOS_CONFIG:c},E.ColoresEstado={actualizar:(u,b)=>{l[u]=b;const t=document.getElementById("colores-estado-css");if(t){let n=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[a,d]of Object.entries(l))n+=`.proceso.estado-${a} {
    --bg-estado: ${d};
}
`;t.textContent=n,console.log(`‚úÖ Color actualizado para estado "${u}": ${b}`)}},obtenerColor:u=>l[u],todos:()=>({...l})}})(window);function Pt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const t=localStorage.getItem("decisionCortePorEtiqueta");t&&(window._decisionCortePorEtiqueta=JSON.parse(t),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(t){console.warn("No se pudieron restaurar decisiones de corte:",t)}document.addEventListener("click",async t=>{var m,g,f;const n=t.target.closest(".btn-fabricar");if(!n)return;t.preventDefault();const a=(g=(m=document.getElementById("maquina-info"))==null?void 0:m.dataset)==null?void 0:g.maquinaId;if(!a){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const d=n.dataset.grupoId;if(d){const A=n.disabled;n.disabled=!0;try{await l(d,a)}finally{n.disabled=A}return}const p=String(n.dataset.etiquetaId||"").trim(),y=p.replace(/\./g,"-"),r=document.querySelector(`#etiqueta-${y}`);if(r){const A=(r.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(A)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${p} ya est√° en estado ${A}.`,timer:2500,showConfirmButton:!1});return}}const e=Number(((f=window.DIAMETRO_POR_ETIQUETA)==null?void 0:f[p])??0);if(!p){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!e&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const o=n.disabled;n.disabled=!0;try{await E(p,a,e)}finally{n.disabled=o}});async function E(t,n,a=null){var v,q,S,_,T,L,G,V;const d=`/actualizar-etiqueta/${t}/maquina/${n}`,p=(v=document.querySelector('meta[name="csrf-token"]'))==null?void 0:v.getAttribute("content"),y=t.replace(/\./g,"-"),e=(((S=(q=document.querySelector(`#etiqueta-${y}`))==null?void 0:q.dataset)==null?void 0:S.estado)||"").toLowerCase()==="fabricando",o=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",m=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",g=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",f=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:o,esSL28:m,esCortadoraManual:g,esCortadoraDobladoraBarra:f}),o&&m||g||f){if(e)if((_=window._decisionCortePorEtiqueta)!=null&&_[t]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:p,etiquetaId:t,onUpdate:i,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const C=await fetch(`/api/etiquetas/${t}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":p}});if(C.ok){const M=await C.json();if(M.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:M.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],csrfToken:p,etiquetaId:t,onUpdate:i,pedirDesperdicio:!1});return}}}catch(C){console.warn("No se pudo obtener longitud asignada:",C)}for(;;){let C;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),C=await Cortes.mejorCorteSimple(t,a,p),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",C)}catch(M){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",M),b(M);return}if(!C){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",C.accion),C.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let M;try{M=await Cortes.mejorCorteOptimizado(t,a,C.patrones,p)}catch(I){b(I);return}if((M==null?void 0:M.accion)==="fabricar"){const I=((T=M.patronInfo)==null?void 0:T.desperdicio_cm)||((L=M.patron)==null?void 0:L.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:M.longitudBarraCm,etiquetas:M.etiquetas,desperdicioEstimadoCm:I},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:p,etiquetaId:t,onUpdate:i});if($!=null&&$.cancelled)continue;return}else{if(M==="volver")continue;return}}if(C.accion==="fabricar_patron_simple"){const M=Math.round(Number(C.longitud_m||0)*100);if(!M){b("Longitud de barra no v√°lida.");return}const I=((G=C.patronInfo)==null?void 0:G.desperdicio_cm)||((V=C.patron)==null?void 0:V.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:M,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],desperdicioEstimadoCm:I},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const $=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:p,etiquetaId:t,onUpdate:i});if($!=null&&$.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await s(t,n,p)}catch(C){b(C)}return}try{const C=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":p},body:JSON.stringify({})}),M=await C.json();if(!C.ok)throw new Error(M.message||"Error al actualizar");i(t,M)}catch(C){b(C)}}async function l(t,n){var v,q,S,_,T,L,G,V,C;const a=(v=document.querySelector('meta[name="csrf-token"]'))==null?void 0:v.getAttribute("content"),d=document.querySelector(`[data-grupo-id="${t}"] .etiqueta-card`),p=(((q=d==null?void 0:d.dataset)==null?void 0:q.estado)||"pendiente").toLowerCase(),y=parseInt((S=d==null?void 0:d.dataset)==null?void 0:S.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(p)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${p}.`,timer:2500,showConfirmButton:!1});return}const r=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",e=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",o=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",m=r&&e||o;let g=[];try{g=JSON.parse(((_=d==null?void 0:d.dataset)==null?void 0:_.etiquetasSubIds)||"[]")}catch(M){console.warn("Error parseando etiquetas del grupo:",M)}const f=(T=d==null?void 0:d.dataset)==null?void 0:T.primeraEtiquetaId,A=((L=d==null?void 0:d.dataset)==null?void 0:L.planillaId)||window.PLANILLA_ID;if(p==="pendiente"&&m&&f){try{for(;;){const M=await Cortes.mejorCorteSimple(f,y,a);if(!M)return;if(M.accion==="optimizar"){const I=await Cortes.mejorCorteOptimizado(f,y,null,a);if(I==="volver")continue;if(!I||I.accion!=="fabricar")return;const $=((G=I.patronInfo)==null?void 0:G.desperdicio_cm)||0;let P=null;const F=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:I.longitudBarraCm,etiquetas:I.etiquetas,csrfToken:a,etiquetaId:f,desperdicioEstimadoCm:$,onUpdate:(D,J)=>{J.producto_n_colada&&(P={colada1:J.producto_n_colada,colada2:J.producto2_n_colada||null}),c(d,"fabricando",t,P)},pedirDesperdicio:!0});if(F!=null&&F.cancelled)continue;c(d,"fabricando",t,P),u("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(M.accion==="fabricar_patron_simple"){const I=Math.round(Number(M.longitud_m||0)*100);if(!I){b("Longitud de barra no v√°lida.");return}const $=((V=M.patronInfo)==null?void 0:V.desperdicio_cm)||((C=M.patron)==null?void 0:C.sobra_cm)||0,P=g.map(J=>({etiqueta_sub_id:J,patron_letras:M.patron_letras||""}));let F=null;const D=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:I,etiquetas:P,csrfToken:a,etiquetaId:f,desperdicioEstimadoCm:$,onUpdate:(J,pt)=>{pt.producto_n_colada&&(F={colada1:pt.producto_n_colada,colada2:pt.producto2_n_colada||null}),c(d,"fabricando",t,F)},pedirDesperdicio:!0});if(D!=null&&D.cancelled)continue;c(d,"fabricando",t,F),u("info","Fabricando",`Grupo iniciado (${g.length} etiquetas)`);return}return}}catch(M){b(M)}return}try{const M=await fetch(`/api/etiquetas/resumir/${t}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({maquina_id:n})}),I=await M.json();if(!M.ok||!I.success)throw new Error(I.message||"Error al actualizar grupo");const $=I.nuevo_estado||"actualizado",P=I.imprimir_etiquetas||[],F={colada1:I.producto_n_colada||null,colada2:I.producto2_n_colada||null};if(c(d,$,t,F),$==="fabricando"){const D=F.colada1?` - Colada: ${F.colada1}`:"";u("info","Fabricando",`Grupo iniciado (${I.etiquetas_actualizadas||0} etiquetas)${D}`)}else $==="completada"&&u("success","¬°Completado!",`Grupo completado (${I.etiquetas_actualizadas||0} etiquetas)`);if($==="completada"&&P.length>0){const D=P.map(z=>z.etiqueta_sub_id);await new Promise(z=>setTimeout(z,300));const J=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${D.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(J.isConfirmed||J.isDenied){const z=J.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(st=>setTimeout(st,800)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(D,z)}await new Promise(z=>setTimeout(z,500));const pt=I.planilla_id||A,O=I.maquina_id||n;if(pt&&O)try{await fetch("/api/etiquetas/resumir",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,Accept:"application/json"},body:JSON.stringify({planilla_id:pt,maquina_id:O})}),console.log("Etiquetas reagrupadas despu√©s de completar")}catch(z){console.warn("No se pudieron reagrupar las etiquetas:",z)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let z=0;for(const st of D)try{const B=await window.TrabajoPaquete.validarEtiqueta(st);B.valida&&window.TrabajoPaquete.agregarItemEtiqueta(st,B)&&z++}catch(B){console.warn(`No se pudo a√±adir ${st} al carro:`,B)}z>0&&u("success","A√±adidas al carro",`${z} etiquetas a√±adidas al carro`)}c(d,"completada",t)}}catch(M){b(M)}}function c(t,n,a,d=null){if(!t)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(r=>{t.classList.remove(`estado-${r}`)}),t.classList.add(`estado-${n}`),t.dataset.estado=n;const p=t.dataset.contenedorSvgId,y=t.dataset.elementos;if(p&&y&&typeof window.renderizarGrupoSVG=="function")try{const r=JSON.parse(y);d&&(r.forEach(o=>{o.coladas={colada1:d.colada1||null,colada2:d.colada2||null,colada3:null}}),t.dataset.elementos=JSON.stringify(r));const e={id:parseInt(p),etiqueta:{id:parseInt(p)},elementos:r};window.renderizarGrupoSVG(e,a)}catch(r){console.warn("No se pudo re-renderizar SVG del grupo:",r)}}async function s(t,n,a){var M,I,$,P,F;const d=Number(((M=window.DIAMETRO_POR_ETIQUETA)==null?void 0:M[t])??0),y=Number(((I=window.LONGITUD_POR_ETIQUETA)==null?void 0:I[t])??0)/100;let r="";try{const D=await fetch(`/api/productos/sugerencias?diametro=${d}&longitud=${y}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":a}});if(D.ok){const J=await D.json();J.productos&&J.productos.length>0?r=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${d}mm x ${y.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${J.productos.map(pt=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${pt.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${pt.codigo}</td>
                                                <td class="px-2 py-1">${pt.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${pt.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${pt.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:r=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${d}mm x ${y.toFixed(1)}m</p>`}}catch(D){console.warn("No se pudieron cargar sugerencias:",D)}const{value:e,isConfirmed:o}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${r}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const D=document.getElementById("swal-input-producto").value;return!D||!D.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):D.trim()}});if(!o||!e)return;let m;try{const D=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(e.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":a}});if(!D.ok){const J=await D.json();throw new Error(J.message||"Producto no encontrado")}m=await D.json()}catch(D){await Swal.fire({icon:"error",title:"Producto no encontrado",text:D.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${e}`});return}const g=(m.tipo||"").toLowerCase(),f=Number(m.diametro??0),A=Number(m.longitud??0);if(g&&g!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${m.codigo}</p>
                        <p><strong>Tipo:</strong> ${m.tipo||"N/A"}</p>
                    </div>
                `});return}if(f>0&&d>0&&Math.abs(f-d)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${f} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${d} mm</p>
                    </div>
                `});return}if(A>0&&y>0&&Math.abs(A-y)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${A.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${y.toFixed(2)} m</p>
                    </div>
                `});return}const v=m.longitud?`${m.longitud} m`:"N/A",{value:q,isConfirmed:S}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${m.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${m.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${v}</p>
                    <p><strong>Stock actual:</strong> ${(($=m.peso_stock)==null?void 0:$.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${m.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!S)return;const _=q==="completo",T=`/actualizar-etiqueta/${t}/maquina/${n}`,L=await fetch(T,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a},body:JSON.stringify({producto_id:m.id,paquete_completo:_})}),G=await L.json();if(!L.ok)throw new Error(G.message||"Error al fabricar");const V=((P=G.metricas)==null?void 0:P.peso_consumido)||0,C=((F=G.metricas)==null?void 0:F.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${m.codigo}</p>
                <p><strong>Peso consumido:</strong> ${V.toFixed(2)} kg</p>
                ${C?`<p><strong>Paquete:</strong> ${C}</p>`:""}
                ${_?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),i(t,G),C&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const D=document.getElementById("codigo_paquete_mover");D&&(D.value=C,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function i(t,n){var d,p;const a=t.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:n.estado,peso_etiqueta:n.peso_etiqueta,nombre:n.nombre,producto_n_colada:n.producto_n_colada,producto2_n_colada:n.producto2_n_colada,data_completa:n}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,n.estado,{peso:n.peso_etiqueta,nombre:n.nombre||t}):w(t,n.estado),n.producto_n_colada&&window.elementosAgrupadosScript){const y=window.elementosAgrupadosScript.findIndex(r=>r.etiqueta&&String(r.etiqueta.etiqueta_sub_id)===String(t));if(y!==-1){const r=window.elementosAgrupadosScript[y];r.colada_etiqueta=n.producto_n_colada,r.colada_etiqueta_2=n.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(r,y),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${n.producto_n_colada}`))}}switch(n.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,n.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(t,!0),(n.estado||"").toLowerCase()){case"cortando":u("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":u("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),h(a);break;case"fabricando":u("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":u("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),h(a),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:n.peso_etiqueta||0,estado:"fabricada",nombre:n.nombre||t}),n.elementos&&Array.isArray(n.elementos)&&n.elementos.length>0?n.elementos.some(r=>r.coladas&&(r.coladas.colada1||r.coladas.colada2||r.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,n.elementos),x(t,n.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":u("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(d=window._decisionCortePorEtiqueta)!=null&&d[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),h(a),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:n.peso_etiqueta||0,estado:"completada",nombre:n.nombre||t}),n.elementos&&Array.isArray(n.elementos)&&n.elementos.length>0?n.elementos.some(r=>r.coladas&&(r.coladas.colada1||r.coladas.colada2||r.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,n.elementos),x(t,n.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":u("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":u("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),h(a);break;case"soldando":u("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":u("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),h(a);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${n.estado}`),u("warning","Estado desconocido",`El estado recibido (${n.estado}) no est√° reconocido.`,3e3)}(p=n.productos_afectados)!=null&&p.length&&n.productos_afectados.forEach(y=>{const r=document.getElementById(`peso-stock-${y.id}`),e=document.getElementById(`progreso-texto-${y.id}`),o=document.getElementById(`progreso-barra-${y.id}`);r&&(r.textContent=`${y.peso_stock} kg`),e&&(e.textContent=`${y.peso_stock} / ${y.peso_inicial} kg`),o&&(o.style.height=`${y.peso_stock/y.peso_inicial*100}%`)})}function w(t,n){const a=t.replace(/\./g,"-"),d=document.getElementById("etiqueta-"+a);if(!d)return;d.dataset.estado=String(n||"").toLowerCase(),d.className=d.className.split(" ").filter(r=>!r.startsWith("estado-")).join(" ").trim(),d.classList.add("estado-"+d.dataset.estado);const p=d.querySelector('[id^="contenedor-svg-"]'),y=p==null?void 0:p.querySelector("svg");y&&(y.style.background=getComputedStyle(d).getPropertyValue("--bg-estado").trim())}function h(t){const n=`#etiqueta-${CSS.escape(t)}`,a=document.querySelector(n),d=Array.from(document.querySelectorAll(".proceso")),p=f=>(f||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),y=f=>{var q;const A=(q=f.dataset)==null?void 0:q.estado;if(A)return p(A);const v=f.querySelector('[id^="estado-"]');return p((v==null?void 0:v.textContent)||(v==null?void 0:v.innerText)||"")},r=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),e=f=>r.has(y(f)),o=a?d.indexOf(a):-1,g=(o>=0?d.slice(o+1):d).find(f=>!e(f));g?g.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function x(t,n){var r;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!n||!Array.isArray(n)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(n.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const a=window.elementosAgrupadosScript.findIndex(e=>{var o;return((o=e.etiqueta)==null?void 0:o.etiqueta_sub_id)===t});if(a===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[a].elementos=n;const d=window.elementosAgrupadosScript[a],p=(r=d.etiqueta)==null?void 0:r.id;if(!p){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const y=document.getElementById("contenedor-svg-"+p);if(!y){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${p})`);return}try{const e=y.querySelector("svg");e&&e.remove();const o=600,m=150,g=y.closest(".proceso"),f=g&&getComputedStyle(g).getPropertyValue("--bg-estado").trim()||"#e5e7eb",A=document.createElementNS("http://www.w3.org/2000/svg","svg");A.setAttribute("viewBox",`0 0 ${o} ${m}`),A.setAttribute("preserveAspectRatio","xMidYMid meet"),A.style.width="100%",A.style.height="100%",A.style.display="block",A.style.background=f;const v=(d.elementos||[]).map((S,_)=>{var C,M,I;const T=S.barras!=null?S.barras:0;let L="N/A";if(S.diametro!=null&&S.diametro!==""){const P=String(S.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(P){const F=parseFloat(P[0]);isFinite(F)&&(L=String(Math.round(F)))}}const G=[];(C=S.coladas)!=null&&C.colada1&&G.push(S.coladas.colada1),(M=S.coladas)!=null&&M.colada2&&G.push(S.coladas.colada2),(I=S.coladas)!=null&&I.colada3&&G.push(S.coladas.colada3);const V=G.length>0?` (${G.join(", ")})`:"";return{letter:indexToLetters(_),text:`√ò${L} x${T}${V}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(A,v,o,m):console.error("‚ùå drawLegendBottomLeft no est√° definida");const q=document.createElementNS("http://www.w3.org/2000/svg","text");q.setAttribute("x",o/2),q.setAttribute("y",m/2),q.setAttribute("text-anchor","middle"),q.setAttribute("fill","#059669"),q.setAttribute("font-size","14"),q.setAttribute("font-weight","600"),q.textContent="‚úì Coladas actualizadas",A.appendChild(q),y.appendChild(A),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{q&&q.parentNode&&q.remove()},2e3)}catch(e){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,e),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function u(t,n,a,d=2e3){Swal.fire({icon:t,title:n,text:a,timer:d,showConfirmButton:!1})}function b(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=i}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pt):Pt();document.addEventListener("livewire:navigated",Pt);(function(E){let l=[],c=!1,s=null;async function i(e){var m;const o=`/etiquetas/${encodeURIComponent(e)}/validar-para-paquete`;try{const g=await fetch(o,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(m=document.querySelector('meta[name="csrf-token"]'))==null?void 0:m.content}});if(!(g.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const A=await g.json();if(console.log("üîç validarEtiqueta response:",{status:g.status,data:A,peso_etiqueta:A.peso_etiqueta}),!g.ok)throw new Error((A==null?void 0:A.message)||(A==null?void 0:A.motivo)||"Error al validar");return A}catch(g){throw g}}function w(e,o){const m=o.id||e;if(l.some(A=>A.id===m))return!1;const g=parseFloat(o.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:e,id:m,peso_etiqueta_recibido:o.peso_etiqueta,peso_parseado:g,data_completa:o});const f={id:m,type:"etiqueta",peso:g,estado:o.estado||"desconocido",nombre:o.nombre||"Sin nombre"};return l.push(f),t(),!0}function h(e){const o=l.findIndex(m=>m.id===e);o>=0&&l.splice(o,1),t()}function x(){l=[],t()}function u(){return l.reduce((e,o)=>e+(parseFloat(o.peso)||0),0)}function b(){return l}function t(){const e=document.getElementById("itemsList");if(!e)return;e.innerHTML="";for(const g of l){const f=document.createElement("li");f.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",f.dataset.code=g.id,f.innerHTML=`
                <div>
                    <div class="font-semibold">${g.id} === ${g.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,f.querySelector("button").onclick=()=>h(g.id),e.appendChild(f)}const o=u(),m=document.createElement("li");m.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",m.textContent=`Total: ${o.toFixed(2)} kg (${l.length} etiquetas)`,e.appendChild(m)}async function n(){var A,v,q;if(!l.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const e=Number(((v=(A=document.getElementById("maquina-info"))==null?void 0:A.dataset)==null?void 0:v.maquinaId)||window.maquinaId),o=Number(((q=document.getElementById("ubicacion-id"))==null?void 0:q.value)||window.ubicacionId),m=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!e){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}if(!m&&!o){await Swal.fire("Faltan datos","Debe especificarse la ubicaci√≥n.","error");return}const g={items:l.map(S=>({id:S.id,type:S.type})),maquina_id:e,ubicacion_id:m?null:o,sin_ubicacion:m},f=async(S={})=>{var L;const _=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(L=document.querySelector('meta[name="csrf-token"]'))==null?void 0:L.content},body:JSON.stringify({...g,...S})}),T=await _.json();if(!_.ok)throw new Error(T.message||"Error al crear el paquete");return T};try{const S=await f();if(S.success)return a(S);if(S.warning){let _="<div style='text-align:left;'>Se detectaron advertencias:";for(const[L,G]of Object.entries(S.warning))Array.isArray(G)&&G.length&&(_+=`<br><strong>${L.replaceAll("_"," ")}:</strong> ${G.join(", ")}`);if(_+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:_,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const L=await f({confirmar:!0});if(L.success)return a(L);throw new Error(L.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(S){await Swal.fire("Error",S.message||"Error inesperado","error")}}async function a(e){var A;console.log("üì¶ postCreacion llamada con data:",e);const o=e.codigo_paquete||((A=e.paquete)==null?void 0:A.codigo)||"N/D",m=u(),g=[...l.map(v=>v.id)];console.log("üì¶ Etiquetas a actualizar:",g),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${o}</strong> creado correctamente</p>
                       <p>${g.length} etiquetas ¬∑ ${m.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),x(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const v=document.getElementById("codigo_paquete_mover");v&&(v.value=o,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${o}</strong> creado correctamente</p><p>${g.length} etiquetas ¬∑ ${m.toFixed(2)} kg</p>`}),x()),console.log(`üì¶ Disparando evento paquete:creado para ${o}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:o,etiquetaIds:g,pesoTotal:m}})),console.log(`üîÑ Actualizando DOM para ${g.length} etiquetas con paquete ${o}`),g.forEach(v=>{d(v,o)})}function d(e,o){const m=String(e).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${e} (safe: ${m})`);let g=document.querySelector(`#etiqueta-${m}`);if(g&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${m}`),!g){const _=document.querySelector(`[data-etiqueta-sub-id="${e}"]`);_&&(g=_.querySelector(".etiqueta-card"),g&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!g){const _=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${_.length} grupos...`);for(const T of _)try{const L=JSON.parse(T.dataset.etiquetasSubIds||"[]");if(L.includes(e)){g=T,console.log(`‚úÖ Etiqueta ${e} encontrada en grupo con ${L.length} etiquetas`);break}}catch(L){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",L)}}if(!g){console.warn(`‚ùå No se encontr√≥ elemento: ${e}`);return}console.log(`üîÑ Actualizando manualmente: ${e}`),Array.from(g.classList).forEach(_=>{_.startsWith("estado-")&&g.classList.remove(_)}),g.classList.add("estado-en-paquete"),g.dataset.estado="en-paquete",g.style.setProperty("--bg-estado","#e3e4FA");const A=g.querySelector('[id^="contenedor-svg-"]');if(A){const _=A.querySelector("svg");_&&(_.style.background="#e3e4FA")}const v=g.querySelector(".etiqueta-card")||g;v&&(v.style.background="#e3e4FA");const q=g.querySelector(".paquete-codigo");q?(q.textContent=`(${o})`,q.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${o})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),g.querySelectorAll(".btn-fabricar").forEach(_=>{_.disabled=!0,_.style.opacity="0.5",_.style.cursor="not-allowed"}),g.style.transition="transform 0.5s ease, background-color 0.5s ease",g.style.transform="scale(1.03)",setTimeout(()=>{g.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${e} actualizada manualmente`)}function p(){y(),c||(r(),c=!0)}function y(){const e=document.getElementById("qrItem");e&&!e.dataset.initialized&&(e.dataset.initialized="true",e.addEventListener("change",()=>e.dispatchEvent(new Event("input"))),e.addEventListener("input",async function(){const o=this.value.trim();if(o)try{const m=await i(o);if(!m.valida){await Swal.fire("Etiqueta no v√°lida",m.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}w(o,m)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(m){console.error("Error de validaci√≥n:",m),await Swal.fire("Error",m.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}))}function r(){document.addEventListener("click",async function(e){if(e.target.id==="crearPaqueteBtn"||e.target.closest("#crearPaqueteBtn")){e.preventDefault(),await n();return}}),document.addEventListener("focus",function(e){e.target.id&&e.target.id.startsWith("input-etiqueta-")&&(s=e.target,console.log("üéØ Focus en input:",e.target.id))},!0),document.addEventListener("click",async function(e){var o;if(e.target.classList.contains("btn-agregar-carro")||e.target.closest(".btn-agregar-carro")){const g=(e.target.classList.contains("btn-agregar-carro")?e.target:e.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!g){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const f=document.querySelector(`[x-show="tabActivo === 'crear'"]`),A=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(f&&window.getComputedStyle(f).display,A&&window.getComputedStyle(A).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let q=document.activeElement;(!q||!((o=q.id)!=null&&o.startsWith("input-etiqueta-")))&&(q=s),(!q||!document.body.contains(q))&&(q=document.querySelector('input[id^="input-etiqueta-"]')),q?(q.value=g,q.focus(),q.classList.add("ring-4","ring-green-400"),setTimeout(()=>{q.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${g} a√±adida al input:`,q.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",g);try{const q=await i(g);if(!q.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:q.motivo||"Motivo no especificado"});return}w(g,q)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(q){console.error("Error al a√±adir al carro:",q),await Swal.fire({icon:"error",title:"Error",text:q.message||"No se pudo a√±adir al carro"})}}if(e.target.classList.contains("btn-agregar-carro-grupo")||e.target.closest(".btn-agregar-carro-grupo")){const m=e.target.classList.contains("btn-agregar-carro-grupo")?e.target:e.target.closest(".btn-agregar-carro-grupo"),g=m.dataset.grupoId;let f=[];try{f=JSON.parse(m.dataset.etiquetas||"[]")}catch(_){console.error("Error parseando etiquetas del grupo:",_);return}if(!f.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${f.length} etiquetas del grupo ${g} al carro`);let A=0,v=0,q=0,S=[];for(const _ of f)try{const T=await i(_.id);if(!T.valida){q++,T.motivo&&!S.includes(T.motivo)&&S.push(T.motivo);continue}w(_.id,T)?A++:v++}catch(T){q++,console.error("Error validando etiqueta:",_.id,T)}if(A>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${A}</strong> etiquetas al carro.</p>
                            ${v>0?`<p class="text-gray-500">${v} ya estaban en el carro.</p>`:""}
                            ${q>0?`<p class="text-red-500">${q} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(v>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const _=S.length>0?`<ul class="text-left mt-2 text-sm">${S.map(T=>`<li>‚Ä¢ ${T}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${_}
                        `})}}})}E.TrabajoPaquete={inicializar:p,agregarItemEtiqueta:w,eliminarItem:h,limpiarCarro:x,obtenerItems:b,calcularPesoTotal:u,crearPaquete:n,validarEtiqueta:i,actualizarListaVisual:t},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p(),document.addEventListener("livewire:navigated",p)})(window);function Ot(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(l,c){const s=document.getElementById("grid-maquina");if(!s)return;console.log("üîß Actualizando clases:",{showLeft:l,showRight:c,clasesAnteriores:s.className}),l||c?s.classList.add("columnas-laterales-visibles"):s.classList.remove("columnas-laterales-visibles"),l&&c?s.classList.add("ambas-columnas"):s.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",s.className),s.offsetHeight,s.querySelectorAll(".etiqueta-card").forEach(w=>{w.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const l=JSON.parse(localStorage.getItem("showLeft")??"true"),c=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(l,c)});function E(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((w,h)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),h.disconnect();const u=JSON.parse(localStorage.getItem("showLeft")??"true"),b=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(u,b)}}).observe(document.body,{childList:!0,subtree:!0});return}const c=JSON.parse(localStorage.getItem("showLeft")??"true"),s=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,s),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}E()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ot):Ot();document.addEventListener("livewire:navigated",Ot);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const E={debounceTime:500};let l=0;async function c(n){var p;const a=Date.now();if(a-l<E.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};l=a;const d=(p=document.querySelector('meta[name="csrf-token"]'))==null?void 0:p.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${n}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const r=await fetch(`/etiquetas/${encodeURIComponent(n)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),e=await r.json();return!r.ok||!e.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:e.message||"No se pudo revertir el cambio."}),{success:!1,message:e.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${e.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${e.estado}</strong>
                    </p>
                    ${e.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),h(n,e),e)}catch(y){return console.error("Error al deshacer etiqueta:",y),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:y.message}}}async function s(n){try{const a=await fetch(`/etiquetas/${encodeURIComponent(n)}/puede-deshacer`,{headers:{Accept:"application/json"}});return a.ok?await a.json():{puede_deshacer:!1}}catch(a){return console.error("Error al verificar undo:",a),{puede_deshacer:!1}}}async function i(n){try{const a=await fetch(`/etiquetas/${encodeURIComponent(n)}/historial`,{headers:{Accept:"application/json"}});return a.ok?await a.json():{success:!1,historial:[]}}catch(a){return console.error("Error al obtener historial:",a),{success:!1,historial:[]}}}async function w(n){var p;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const a=await i(n);if(!a.success||!((p=a.historial)!=null&&p.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=a.historial.map((y,r)=>`
            <tr class="${y.revertido?"bg-gray-100 text-gray-400":r===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${y.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${y.accion}</td>
                <td class="px-2 py-1 text-xs">${y.estado_anterior||"-"} ‚Üí ${y.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${y.revertido?'<span class="text-gray-400">Revertido</span>':r===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${n}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${a.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${a.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:a.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:a.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:a.puede_deshacer?"#f59e0b":"#6b7280"}).then(y=>{y.isConfirmed&&a.puede_deshacer&&c(n)})}function h(n,a){const d=n.replace(/\./g,"-"),p=document.getElementById(`etiqueta-${d}`);if(p){p.dataset.estado=a.estado,p.className=p.className.split(" ").filter(e=>!e.startsWith("estado-")).join(" ").trim(),p.classList.add(`estado-${a.estado}`);const y=p.querySelector('[id^="contenedor-svg-"]'),r=y==null?void 0:y.querySelector("svg");r&&(r.style.background=getComputedStyle(p).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(n,a.estado)}if(a.estado==="pendiente"){if(window.elementosAgrupadosScript){const e=window.elementosAgrupadosScript.find(o=>o.etiqueta&&String(o.etiqueta.etiqueta_sub_id)===String(n));e&&(e.colada_etiqueta=null,e.colada_etiqueta_2=null,e.elementos&&e.elementos.forEach(o=>{o.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:n}})))}const y=document.getElementById(`colada-${d}`);y&&(y.textContent="")}console.log(`‚úÖ DOM actualizado para ${n}: estado = ${a.estado}`)}function x(n,a){const d=n.replace(/\./g,"-"),p=document.querySelector(`#etiqueta-${d} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${n}, puede=${a}, btn encontrado=${!!p}`),p&&(p.disabled=!1,p.classList.remove("opacity-50","cursor-not-allowed"),p.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function u(){document.addEventListener("click",async n=>{const a=n.target.closest(".btn-deshacer");if(!a)return;n.preventDefault(),n.stopPropagation();const d=a.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await c(d)}),document.addEventListener("click",async n=>{const a=n.target.closest(".btn-historial");if(!a)return;n.preventDefault(),n.stopPropagation();const d=a.dataset.etiquetaId;d&&await w(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function b(){let n=null;window.addEventListener("etiqueta-fabricada",a=>{var d;(d=a.detail)!=null&&d.etiquetaSubId&&(n=a.detail.etiquetaSubId)}),document.addEventListener("keydown",async a=>{var d,p;if(a.ctrlKey&&a.key==="z"&&!a.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const y=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),r=((p=y==null?void 0:y.dataset)==null?void 0:p.etiquetaId)||n;r&&(a.preventDefault(),await c(r))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function t(){u(),b(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:c,puedeDeshacer:s,obtenerHistorial:i,mostrarHistorial:w,actualizarBoton:x},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t(),document.addEventListener("livewire:navigated",t)})();
