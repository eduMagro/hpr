const Xt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Rt="rgba(0, 0, 0, 1)";function Ht(h,a){return!a||a===1?h.map(i=>({...i})):h.map(i=>i.type==="line"?{...i,length:(i.length||0)*a}:i.type==="arc"?{...i,radius:(i.radius||0)*a}:{...i})}const Vt=.75,Dt=14,Yt=60,Gt=[0,10,-10,20,-20,30,-30];function T(h){return h*Math.PI/180}function Wt(h){const a=h.closest(".proceso");return a&&getComputedStyle(a).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Ut(h,a,i){const o=document.createElementNS("http://www.w3.org/2000/svg","svg");return o.setAttribute("viewBox","0 0 "+h+" "+a),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.style.width="100%",o.style.height="100%",o.style.display="block",o.style.background=i||"#ffffff",o.style.shapeRendering="geometricPrecision",o.style.textRendering="optimizeLegibility",o.style.boxSizing="border-box",o}function Jt(h,a,i,o){const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",a),s.setAttribute("stroke",i),s.setAttribute("fill","none"),s.setAttribute("stroke-width",o),s.setAttribute("vector-effect","non-scaling-stroke"),h.appendChild(s),s}function Ft(h){let a="",i=Number(h)||0;for(;i>=0;){const o=i%26;a=String.fromCharCode(65+o)+a,i=Math.floor(i/26)-1}return a}const Kt=0,Zt=-25;function Qt(h,a,i,o){if(!a||!a.length)return;const s=2,r=12,l=r+s,n=a.map(M=>(M.letter?M.letter+" ":"")+(M.text||"")),e=r*n.length+s*(n.length-1),u=Kt;let m=o-Zt-e+r/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let M=0;M<n.length;M++){const d=n[M],w=document.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("x",u),w.setAttribute("y",m),w.setAttribute("fill",Rt),w.setAttribute("font-size",r),w.setAttribute("text-anchor","start"),w.setAttribute("alignment-baseline","middle"),w.style.pointerEvents="none",w.textContent=d,h.appendChild(w);const f=_t(d,r).w;window.__legendBoxesGroup.push({left:u,right:u+f,top:m-r/2,bottom:m+r/2}),m+=l}}function te(h){const a=(h||"").split(/\s+/).filter(Boolean),i=[];for(let o=0;o<a.length;o++){const s=a[o];if(s.endsWith("r")){const r=parseFloat(s.slice(0,-1));let l=360;o+1<a.length&&a[o+1].endsWith("d")&&(l=parseFloat(a[++o].slice(0,-1))),i.push({type:"arc",radius:r,arcAngle:l})}else s.endsWith("d")?i.push({type:"turn",angle:parseFloat(s.slice(0,-1))}):i.push({type:"line",length:parseFloat(s)})}return i}function ee(h){let a=[],i=0,o=0,s=0;a.push({x:i,y:o});for(let r=0;r<h.length;r++){const l=h[r];if(l.type==="line")i+=l.length*Math.cos(T(s)),o+=l.length*Math.sin(T(s)),a.push({x:i,y:o});else if(l.type==="turn")s+=l.angle;else if(l.type==="arc"){const n=i+l.radius*Math.cos(T(s+90)),e=o+l.radius*Math.sin(T(s+90)),u=Math.atan2(o-e,i-n),m=u+T(l.arcAngle);i=n+l.radius*Math.cos(m),o=e+l.radius*Math.sin(m),s+=l.arcAngle,a.push({x:i,y:o})}}return a}function Pt(h){let a=[],i=0,o=0,s=0;for(let r=0;r<h.length;r++){const l=h[r];if(l.type==="line"){const n={x:i,y:o},e={x:i+l.length*Math.cos(T(s)),y:o+l.length*Math.sin(T(s))};a.push({start:n,end:e,length:l.length}),i=e.x,o=e.y}else if(l.type==="turn")s+=l.angle;else if(l.type==="arc"){const n=i+l.radius*Math.cos(T(s+90)),e=o+l.radius*Math.sin(T(s+90)),u=Math.atan2(o-e,i-n),m=u+T(l.arcAngle);i=n+l.radius*Math.cos(m),o=e+l.radius*Math.sin(m),s+=l.arcAngle}}return a}function _t(h,a){const i=a||12;return{w:(h?h.length:0)*i*.55,h:i}}function Q(h,a,i){const o=i||0;return!(h.right+o<a.left||h.left-o>a.right||h.bottom+o<a.top||h.top-o>a.bottom)}function It(h,a,i,o){const s=a/2;return Math.max(i+s,Math.min(o-s,h))}function oe(h,a){const o=[];let s=0;function r(){s>1e-9&&(o.push({type:"line",length:s}),s=0)}for(let l=0;l<h.length;l++){const n=h[l];if(n.type==="line"){s+=n.length;continue}if(n.type==="turn"){if(Math.abs(n.angle)<1e-9)continue;r(),o.push(n);continue}if(n.type==="arc"){r(),o.push(n);continue}r(),o.push(n)}return r(),o}function jt(h,a){const i=a&&a.decimals||0,o=a&&a.step||null;let s=Number(h||0);return o&&o>0&&(s=Math.round(s/o)*o),s.toFixed(i).replace(/\.0+$/,"")}function ne(h,a){const i=Math.hypot(h,a)||1;let o=h/i,s=a/i;return(s<-1e-9||Math.abs(s)<=1e-9&&o<0)&&(o=-o,s=-s),{ux:o,uy:s}}function zt(h,a,i){const o=i||.01,s=ne(h,a),r=Math.round(s.ux/o)*o,l=Math.round(s.uy/o)*o;return r+"|"+l}function ae(h,a,i){const o=i&&i.dirPrecision||.01,s=i&&i.labelFormat||{decimals:0,step:null},r=h.reduce((w,f)=>w+Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y),0),l=a.reduce((w,f)=>w+(f.length||Math.hypot(f.end.x-f.start.x,f.end.y-f.start.y)),0),n=l>0?r/l:1,e=new Map;for(let w=0;w<a.length;w++){const f=a[w],g=f.end.x-f.start.x,p=f.end.y-f.start.y,c=zt(g,p,o),t=e.get(c)||[];t.push({length:f.length||Math.hypot(g,p),index:w}),e.set(c,t)}const u=a.map(w=>w.length||Math.hypot(w.end.x-w.start.x,w.end.y-w.start.y)),m=new Set,M=new Set,d=[];for(let w=0;w<h.length;w++){const f=h[w],g=f.end.x-f.start.x,p=f.end.y-f.start.y,c=zt(g,p,o),t=e.get(c)||[],b=Math.hypot(g,p);let y=b;if(t.length){const S=b/n;let A=null,C=1/0;for(const D of t){const U=Math.abs(D.length-S),v=M.has(D.index)?.1:0;U+v<C&&(A=D,C=U+v)}A&&(y=A.length,M.add(A.index))}else w<u.length&&(y=u[w]);const E=jt(y,s),x=c+"|"+E;m.has(x)||(m.add(x),d.push({start:f.start,end:f.end,_dirKey:c,_label:E,_lenChosen:y}))}return d}function se(h,a){const i=a,o=h.map(p=>Object.assign({},p));let s=0,r=0,l=0;const n=[];let e=null,u=-1,m=-1;const M=1e-7;function d(p){return p*Math.PI/180}function w(p){return Math.abs(Math.sin(d(p)))<1e-12}function f(p,c,t,b){return Math.min(c,b)-Math.max(p,t)>M}for(let p=0;p<o.length;p++){let t=function(){const S={x:Math.cos(d(l)),y:Math.sin(d(l))},A=s+o[p].length*S.x,C=r+o[p].length*S.y,D=w(l);for(let U=0;U<n.length;U++){const v=n[U];if(D&&v.horiz&&Math.abs(r-v.y)<M){if(f(Math.min(s,A),Math.max(s,A),Math.min(v.x1,v.x2),Math.max(v.x1,v.x2))&&e&&u>=0&&m>=0)return o[m].length+=i,s+=e.x*i,r+=e.y*i,n[u].x2+=e.x*i,n[u].y2+=e.y*i,!0}else if(!D&&!v.horiz&&Math.abs(s-v.x)<M&&f(Math.min(r,C),Math.max(r,C),Math.min(v.y1,v.y2),Math.max(v.y1,v.y2))&&e&&u>=0&&m>=0)return o[m].length+=i,s+=e.x*i,r+=e.y*i,n[u].x2+=e.x*i,n[u].y2+=e.y*i,!0}return!1};var g=t;const c=o[p];if(c.type==="turn"){l+=c.angle;continue}if(c.type==="arc"){const S=s+c.radius*Math.cos(d(l+90)),A=r+c.radius*Math.sin(d(l+90)),C=Math.atan2(r-A,s-S),D=C+d(c.arcAngle);s=S+c.radius*Math.cos(D),r=A+c.radius*Math.sin(D),l+=c.arcAngle,e=null;continue}for(;t(););const b={x:Math.cos(d(l)),y:Math.sin(d(l))},y=s+o[p].length*b.x,E=r+o[p].length*b.y,x=w(l);n.push({x1:s,y1:r,x2:y,y2:E,horiz:x,y:r,x:s}),e=b,u=n.length-1,m=p,s=y,r=E}return o}function At(h,a,i,o){const s=T(o),r=Math.cos(s),l=Math.sin(s),n=h.x-a,e=h.y-i;return{x:a+n*r-e*l,y:i+n*l+e*r}}function ie(h,a,i,o,s,r,l,n,e){let u="",m=0,M=0,d=0,w=!1;function f(p,c){const t=At({x:p,y:c},a,i,o);return{x:n+(t.x-r)*s,y:e+(t.y-l)*s}}function g(){if(!w){const p=f(m,M);u+="M "+p.x+" "+p.y,w=!0}}for(let p=0;p<h.length;p++){const c=h[p];if(c.type==="turn"){d+=c.angle;continue}if(c.type==="line"){const t=m+c.length*Math.cos(T(d)),b=M+c.length*Math.sin(T(d));g();const y=f(t,b);u+=" L "+y.x+" "+y.y,m=t,M=b;continue}if(c.type==="arc"){const t=m+c.radius*Math.cos(T(d+90)),b=M+c.radius*Math.sin(T(d+90)),y=Math.atan2(M-b,m-t),E=y+T(c.arcAngle),x=t+c.radius*Math.cos(E),S=b+c.radius*Math.sin(E),A=Math.abs(c.arcAngle)%360;if(g(),A<1e-6||Math.abs(c.arcAngle)>=359.9){const ct=y+Math.sign(c.arcAngle)*Math.PI,J=t+c.radius*Math.cos(ct),R=b+c.radius*Math.sin(ct),$=f(J,R),P=f(m,M),L=c.radius*s,tt=c.arcAngle>=0?1:0;u+=" A "+L+" "+L+" 0 1 "+tt+" "+$.x+" "+$.y,u+=" A "+L+" "+L+" 0 1 "+tt+" "+P.x+" "+P.y,d+=c.arcAngle;continue}const C=f(x,S),D=c.radius*s,U=A>180?1:0,v=c.arcAngle>=0?1:0;u+=" A "+D+" "+D+" 0 "+U+" "+v+" "+C.x+" "+C.y,m=x,M=S,d+=c.arcAngle}}return u||"M 0 0"}function re(h){const a=ee(h);let i=Math.min(...a.map(g=>g.x)),o=Math.max(...a.map(g=>g.x)),s=Math.min(...a.map(g=>g.y)),r=Math.max(...a.map(g=>g.y));const l=(i+o)/2,n=(s+r)/2,u=r-s>o-i?-90:0,m=a.map(g=>At(g,l,n,u));i=Math.min(...m.map(g=>g.x)),o=Math.max(...m.map(g=>g.x)),s=Math.min(...m.map(g=>g.y)),r=Math.max(...m.map(g=>g.y));const M=Math.max(1,o-i),d=Math.max(1,r-s),w=(i+o)/2,f=(s+r)/2;return{rotDeg:u,w:M,h:d,cxModel:l,cyModel:n,midX:w,midY:f,ptsRot:m}}function ce(h){const a=[];let i=0,o=0,s=0;function r(l){const n=T(l);return{x:Math.cos(n),y:Math.sin(n)}}for(let l=0;l<h.length;l++){const n=h[l];if(n.type==="line")i+=n.length*Math.cos(T(s)),o+=n.length*Math.sin(T(s));else if(n.type==="turn"){const e=r(s),u=n.angle;s+=u;const m=r(s);a.push({x:i,y:o,angleDeg:u,prevDir:e,nextDir:m})}else if(n.type==="arc"){const e=i+n.radius*Math.cos(T(s+90)),u=o+n.radius*Math.sin(T(s+90)),m=Math.atan2(o-u,i-e),M=m+T(n.arcAngle);i=e+n.radius*Math.cos(M),o=u+n.radius*Math.sin(M),s+=n.arcAngle}}return a}function le(h,a,i){const o=Array.from({length:a},()=>({sumH:0,maxW:0,items:[]})),s=[...h.keys()].sort((r,l)=>h[l].h-h[r].h);for(const r of s){let l=0,n=1/0;for(let u=0;u<a;u++){const m=o[u],M=m.sumH+(m.items.length>0?i:0)+h[r].h;M<n&&(n=M,l=u)}const e=o[l];e.sumH=e.items.length>0?e.sumH+i+h[r].h:e.sumH+h[r].h,e.maxW=Math.max(e.maxW,h[r].w),e.items.push(r)}return o}function de(h,a,i,o={}){const s=o.padding??12,r=o.gapCol??12,l=o.gapRow??10,n=Math.max(1,Math.min(h.length,o.kMax??4)),e=Math.max(10,a-2*s),u=Math.max(10,i-2*s),m=M(h);function M(t){const b=t.map(L=>L.w/Math.max(L.h,1)),y=t.map(L=>L.h),E=t.map(L=>L.w),x=t.map(L=>L.w*L.h),S=L=>L.reduce((tt,ht)=>tt+ht,0)/L.length,A=(L,tt)=>L.reduce((ht,ft)=>ht+Math.pow(ft-tt,2),0)/L.length,C=(L,tt)=>Math.sqrt(A(L,tt)),D=S(b),U=S(y),v=S(E),ct=x.reduce((L,tt)=>L+tt,0),J=C(y,U),R=C(E,v),$=U>0?J/U:0,P=v>0?R/v:0;return{avgAspectRatio:D,avgHeight:U,avgWidth:v,totalArea:ct,heightCV:$,widthCV:P,isLinear:D>6||U<v*.12,isUniformHeight:$<.15,isUniformWidth:P<.15,isHighlyVariable:$>.5||P>.5,count:t.length}}let d={S:0,k:1,cols:null,score:0};for(let t=1;t<=n;t++){const b=le(h,t,l),y=b.reduce((ft,I)=>ft+I.maxW,0)+r*(t-1),E=Math.max(...b.map(ft=>ft.sumH));if(y<=0||E<=0)continue;const x=e/y,S=u/E,A=Math.min(x,S),C=Math.max(.01,A*.92),D=m.totalArea*C*C,U=e*u,v=D/U,ct=b.map(ft=>ft.sumH*C),J=ct.reduce((ft,I)=>ft+I,0)/t,R=Math.max(...ct)-Math.min(...ct),$=J>0?1-R/J:1,P=t===1?1.1:t===2?.9:.7,L=t>m.count*.5?.7:1,tt=$>.85?1.05:1,ht=C*(1+v*.25)*(1+$*.1)*P*L*tt;ht>d.score&&(d={S:C,k:t,cols:b,score:ht,efficiency:v,colBalance:$})}const w=d.cols.map(t=>t.maxW*d.S),f=w.reduce((t,b)=>t+b,0);let g=[];if(d.k===1)g[0]=a/2;else{const t=(d.k-1)*r,b=f+t;if(b<e){const y=e-b,E=r+y/(d.k-1);let x=s;for(let S=0;S<d.k;S++)g[S]=x+w[S]/2,x+=w[S]+E}else{let y=s+Math.max(0,(e-b)/2);for(let E=0;E<d.k;E++)g[E]=y+w[E]/2,y+=w[E]+r}}const p=[],c=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(t=>t.right));for(let t=0;t<d.k;t++){const b=d.cols[t];p[t]=[];const y=b.items.map(R=>h[R].h*d.S),E=y.reduce((R,$)=>R+$,0);if(b.items.length===0)continue;const x=g[t],S=d.cols[t].maxW*d.S,A=x-S/2,C=x+S/2,D=c(),v=Math.max(0,Math.min(C,D)-A)/S,ct=v>.05;let J=u;if(ct&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const $=Math.min(...window.__legendBoxesGroup.map(P=>P.top))-15;J=Math.max(10,$-s),console.log(`üìè Columna ${t}: X=${A.toFixed(0)}-${C.toFixed(0)}, legendWidth=${D.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura reducida a ${J.toFixed(0)}px`)}else console.log(`üìè Columna ${t}: X=${A.toFixed(0)}-${C.toFixed(0)}, legendWidth=${D.toFixed(0)}, solape=${(v*100).toFixed(0)}%, altura completa ${J.toFixed(0)}px`);if(b.items.length===1){const R=y[0],$=s+J/2,P=Math.max(s+R/2,Math.min($,i-s-R/2));p[t].push(P);continue}if(E>J){console.warn(`Columna ${t}: elementos no caben (${E}px > ${J}px)`);const P=E/b.items.length<4?20:5;let L=s;for(let tt=0;tt<b.items.length;tt++){const ht=Math.max(y[tt],2),ft=L+ht/2;p[t].push(ft),L+=ht+P}}else{const R=J-E,$=b.items.length-1;let P=R/$;E/b.items.length<4?P=Math.max(18,Math.min(P,50)):P=Math.max(5,P);const ht=E+$*P,ft=J-ht;let I=s+Math.max(0,ft/2);for(let ot=0;ot<b.items.length;ot++){const rt=Math.max(y[ot],2),q=I+rt/2,j=s+J-rt/2,k=Math.max(s+rt/2,Math.min(q,j));p[t].push(k),I+=rt+P}}}return{S:d.S,k:d.k,cols:d.cols,centersX:g,centersYByCol:p,padding:s,gapRow:l,gapCol:r}}window.renderizarGrupoSVG=function(a,i){const o=a&&a.etiqueta&&a.etiqueta.id!=null?a.etiqueta.id:a&&a.id!=null?a.id:i,s=document.getElementById("contenedor-svg-"+o);if(!s)return;const r=600,l=150,n=Wt(s),e=Ut(r,l,n);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const u=(a.elementos||[]).map((f,g)=>{var y,E,x;const p=f.barras!=null?f.barras:0;let c="N/A";if(f.diametro!=null&&f.diametro!==""){const A=String(f.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(A){const C=parseFloat(A[0]);isFinite(C)&&(c=String(Math.round(C)))}}const t=[];(y=f.coladas)!=null&&y.colada1&&t.push(f.coladas.colada1),(E=f.coladas)!=null&&E.colada2&&t.push(f.coladas.colada2),(x=f.coladas)!=null&&x.colada3&&t.push(f.coladas.colada3);const b=t.length>0?` (${t.join(", ")})`:"";return{letter:Ft(g),text:`√ò${c} x${p}${b}`}});Qt(e,u,r,l);const m=a.elementos.map(f=>{const g=te(f.dimensiones||""),p=oe(g);let c=0;for(const x of p)x.type==="line"&&(c=Math.max(c,Math.abs(x.length||0))),x.type==="arc"&&(c=Math.max(c,Math.abs(x.radius||0)));const b=c<=50?2:1,y=Ht(p,b),E=re(y);return{dimsRaw:g,dimsNoZero:p,dimsScaled:y,geomScale:b,medida:E}}),M=m.map(f=>f.medida),d=de(M,r,l,{padding:20,gapCol:50,gapRow:22,kMax:3}),w=new Map;for(let f=0;f<d.k;f++)d.cols[f].items.forEach((g,p)=>w.set(g,{c:f,j:p}));a.elementos.forEach(function(f,g){const{dimsNoZero:p,dimsScaled:c,medida:t}=m[g],b=w.get(g),y=d.centersX[b.c],E=d.centersYByCol[b.c][b.j],x=d.S,S=t.ptsRot.map(I=>({x:y+(I.x-t.midX)*x,y:E+(I.y-t.midY)*x})),A=Math.min(...S.map(I=>I.x)),C=Math.max(...S.map(I=>I.x)),D=Math.min(...S.map(I=>I.y)),U=Math.max(...S.map(I=>I.y)),v={left:A,right:C,top:D,bottom:U};window.__figBoxesGroup.push({...v});const ct=se(c,.6),J=ie(ct,t.cxModel,t.cyModel,t.rotDeg,x,t.midX,t.midY,y,E),R=Jt(e,J,Xt,2);(function(){const ot=ce(c);function rt(_){return Math.abs(Math.abs(_)-90)>=Vt}const q=(_,B)=>At({x:_.x,y:_.y},0,0,B),j=(_,B)=>{const X=At({x:_,y:B},t.cxModel,t.cyModel,t.rotDeg);return{x:y+(X.x-t.midX)*x,y:E+(X.y-t.midY)*x}},k=_=>Math.max(10,Math.min(28,_));ot.forEach(_=>{if(!rt(_.angleDeg))return;const B=j(_.x,_.y),X=q(_.prevDir,t.rotDeg),ut=q(_.nextDir,t.rotDeg),H=Math.atan2(X.y,X.x),O=H+T(_.angleDeg),V=Math.min(v.right-v.left,v.bottom-v.top);let N=k(.12*V);const gt=B.x+N*Math.cos(H),mt=B.y+N*Math.sin(H),z=B.x+N*Math.cos(O),wt=B.y+N*Math.sin(O),Y=Math.abs(_.angleDeg),nt=Y>180?1:0,vt=_.angleDeg>=0?1:0,at=document.createElementNS("http://www.w3.org/2000/svg","path");at.setAttribute("d",`M ${gt} ${mt} A ${N} ${N} 0 ${nt} ${vt} ${z} ${wt}`),at.setAttribute("stroke","rgba(255,99,71,0.7)"),at.setAttribute("stroke-width","2"),at.setAttribute("fill","none"),at.style.pointerEvents="none",e.appendChild(at);let G=X.x+ut.x,F=X.y+ut.y;Y>180&&(G=-G,F=-F);let W=Math.hypot(G,F);if(W<1e-6){const it=_.angleDeg>=0?1:-1;G=-X.y*it,F=X.x*it,W=Math.hypot(G,F)||1}G/=W,F/=W;const K=(Math.round(_.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",Z=_t(K,14);function Mt(it,lt){return{left:it-Z.w/2,right:it+Z.w/2,top:lt-Z.h/2,bottom:lt+Z.h/2}}let et=null;for(let it=Dt;it<=Yt&&!et;it+=4)for(let lt=0;lt<Gt.length&&!et;lt++){const yt=Gt[lt],xt=q({x:G,y:F},yt),Et=B.x+xt.x*(N+it),dt=B.y+xt.y*(N+it),pt=Mt(Et,dt);pt.top<0||pt.bottom>l||pt.left<0||pt.right>r||window.__figBoxesGroup.some(bt=>Q(bt,pt,6))||(window.__dimBoxesGroup||[]).some(bt=>Q(bt,pt,2))||(window.__angleBoxesGroup||[]).some(bt=>Q(bt,pt,2))||(window.__placedLetterBoxes||[]).some(bt=>Q(bt,pt,2))||(window.__legendBoxesGroup||[]).some(bt=>Q(bt,pt,6))||(et={x:Et,y:dt,box:pt})}if(!et){const it=B.x+G*(N+Dt),lt=B.y+F*(N+Dt),yt=Mt(it,lt);et={x:it,y:lt,box:yt}}window.__angleBoxesGroup.push(et.box);const st=document.createElementNS("http://www.w3.org/2000/svg","text");st.setAttribute("x",et.x),st.setAttribute("y",et.y),st.setAttribute("fill",Bt),st.setAttribute("font-size",14),st.setAttribute("text-anchor","middle"),st.setAttribute("alignment-baseline","middle"),st.style.cursor="pointer",st.textContent=K,e.appendChild(st),st.addEventListener("mouseenter",()=>{at.setAttribute("stroke","rgba(255,69,0,1)"),at.setAttribute("stroke-width","3"),at.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),st.addEventListener("mouseleave",()=>{at.setAttribute("stroke","rgba(255,99,71,0.7)"),at.setAttribute("stroke-width","2"),at.style.filter="none"})})})();const $=R.cloneNode(!1);$.setAttribute("stroke-width","50"),$.setAttribute("stroke","transparent"),$.setAttribute("fill","none"),$.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(I=>{$.addEventListener(I,ot=>R.dispatchEvent(new ot.constructor(ot.type,ot)))}),e.insertBefore($,R);const P=(f.codigo!=null?f.codigo:f.id)+"";R.style.cursor="pointer",R.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),R.addEventListener("click",function(I){if(I.ctrlKey||I.metaKey||I.shiftKey){I.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(f.id);return}abrirModalDividirElemento(f.id,P)}),R.addEventListener("contextmenu",function(I){I.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(f.id)});const L=[],tt=Pt(ct),ht=Pt(p);ae(tt,ht,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(I){const ot=At(I.start,t.cxModel,t.cyModel,t.rotDeg),rt=At(I.end,t.cxModel,t.cyModel,t.rotDeg),q={x:y+(ot.x-t.midX)*x,y:E+(ot.y-t.midY)*x},j={x:y+(rt.x-t.midX)*x,y:E+(rt.y-t.midY)*x},k=I._label,_=j.x-q.x,B=j.y-q.y,X=Math.hypot(_,B)||1,ut=_/X,H=B/X,O=B/X,V=-_/X,N=(q.x+j.x)/2,gt=(q.y+j.y)/2,mt=N+O*10,z=gt+V*10,wt=_t(k,14),Y=wt.w,nt=wt.h;function vt(et,st){return{left:et-Y/2,right:et+Y/2,top:st-nt/2,bottom:st+nt/2}}const at=X*.45;let G=mt,F=z;for(let et=0;et<=Math.ceil(at/6);et++){const st=et%2===0?1:-1,it=Math.ceil(et/2),lt=st*it*6;if(Math.abs(lt)>at)continue;const yt=mt+ut*lt,xt=z+H*lt,Et=(yt-q.x)*ut+(xt-q.y)*H;if(Et<0+Y*.3||Et>X-Y*.3)continue;const dt=vt(yt,xt);if(!(Q({left:Math.min(q.x,j.x),right:Math.max(q.x,j.x),top:Math.min(q.y,j.y),bottom:Math.max(q.y,j.y)},dt,0)||(window.__angleBoxesGroup||[]).some(St=>Q(St,dt,2))||(window.__legendBoxesGroup||[]).some(St=>Q(St,dt,6))||L.some(St=>Q(St,dt,2))||dt.top<0||dt.bottom>l||dt.left<0||dt.right>r)){G=yt,F=xt,L.push(dt),window.__dimBoxesGroup.push(dt);break}}const W=document.createElementNS("http://www.w3.org/2000/svg","line");W.setAttribute("x1",q.x),W.setAttribute("y1",q.y),W.setAttribute("x2",j.x),W.setAttribute("y2",j.y),W.setAttribute("stroke","rgba(0,0,255,0.6)"),W.setAttribute("stroke-width","4"),W.setAttribute("stroke-linecap","round"),W.setAttribute("vector-effect","non-scaling-stroke"),W.style.opacity=0,W.style.pointerEvents="none",W.style.transition="opacity 120ms ease",e.appendChild(W);const K=document.createElementNS("http://www.w3.org/2000/svg","text");K.setAttribute("x",G),K.setAttribute("y",F),K.setAttribute("fill",Bt),K.setAttribute("font-size",14),K.setAttribute("text-anchor","middle"),K.setAttribute("alignment-baseline","middle"),K.setAttribute("tabindex","0"),K.style.cursor="pointer",K.textContent=k,e.appendChild(K);function Z(){W.style.opacity=1}function Mt(){W.style.opacity=0}K.addEventListener("mouseenter",Z),K.addEventListener("mouseleave",Mt),K.addEventListener("focus",Z),K.addEventListener("blur",Mt)}),function(){const ot=[];let rt=0,q=0,j=0;for(let k=0;k<c.length;k++){const _=c[k];if(_.type==="line")rt+=_.length*Math.cos(T(j)),q+=_.length*Math.sin(T(j));else if(_.type==="turn")j+=_.angle;else if(_.type==="arc"){const B=rt+_.radius*Math.cos(T(j+90)),X=q+_.radius*Math.sin(T(j+90)),ut=Math.atan2(q-X,rt-B),H=ut+T(_.arcAngle);let O=_.radius;for(let V=0;V<p.length;V++){const N=p[V];if(N.type==="arc"&&Math.abs(N.arcAngle-_.arcAngle)<.01){O=N.radius;break}}ot.push({center:{x:B,y:X},radius:_.radius,originalRadius:O,arcAngle:_.arcAngle,startAngle:ut,endAngle:H}),rt=B+_.radius*Math.cos(H),q=X+_.radius*Math.sin(H),j+=_.arcAngle}}ot.forEach(function(k){const _=At(k.center,t.cxModel,t.cyModel,t.rotDeg),B={x:y+(_.x-t.midX)*x,y:E+(_.y-t.midY)*x},X=(k.startAngle+k.endAngle)/2,ut=k.radius*x,H="R"+jt(k.originalRadius,{decimals:0,step:null}),O=_t(H,14),V=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let N=!1,gt,mt,z;for(let Z=0;Z<V.length&&!N;Z++){const Mt=V[Z],et=X+T(Mt),st={x:k.center.x+k.radius*Math.cos(et),y:k.center.y+k.radius*Math.sin(et)},it=At(st,t.cxModel,t.cyModel,t.rotDeg),lt={x:y+(it.x-t.midX)*x,y:E+(it.y-t.midY)*x},yt=lt.x-B.x,xt=lt.y-B.y,Et=Math.hypot(yt,xt)||1,dt=yt/Et,pt=xt/Et;for(let qt=8;qt<=60&&!N;qt+=6){const Ct=ut*.7;if(gt=B.x+dt*Ct+dt*qt,mt=B.y+pt*Ct+pt*qt,z={left:gt-O.w/2,right:gt+O.w/2,top:mt-O.h/2,bottom:mt+O.h/2},!(z.top<0||z.bottom>l||z.left<0||z.right>r||window.__figBoxesGroup.some(Lt=>Q(Lt,z,2))||(window.__legendBoxesGroup||[]).some(Lt=>Q(Lt,z,2)))){N=!0;break}}}if(!N)return;L.push(z);const wt={x:gt-B.x,y:mt-B.y},Y=Math.hypot(wt.x,wt.y)||1,nt={x:wt.x/Y,y:wt.y/Y},vt=B.x+nt.x*ut*.6,at=B.y+nt.y*ut*.6,G=document.createElementNS("http://www.w3.org/2000/svg","line");G.setAttribute("x1",B.x),G.setAttribute("y1",B.y),G.setAttribute("x2",vt),G.setAttribute("y2",at),G.setAttribute("stroke","rgba(0,128,0,0.6)"),G.setAttribute("stroke-width","4"),G.setAttribute("stroke-linecap","round"),G.setAttribute("vector-effect","non-scaling-stroke"),G.style.opacity=0,G.style.pointerEvents="none",G.style.transition="opacity 120ms ease",e.appendChild(G);const F=document.createElementNS("http://www.w3.org/2000/svg","text");F.setAttribute("x",gt),F.setAttribute("y",mt),F.setAttribute("fill",Bt),F.setAttribute("font-size",14),F.setAttribute("text-anchor","middle"),F.setAttribute("alignment-baseline","middle"),F.setAttribute("tabindex","0"),F.style.cursor="pointer",F.textContent=H,e.appendChild(F);function W(){G.style.opacity=1}function K(){G.style.opacity=0}F.addEventListener("mouseenter",W),F.addEventListener("mouseleave",K),F.addEventListener("focus",W),F.addEventListener("blur",K)})}(),function(){const ot=Ft(g),rt=14,q=_t(ot,rt);function j(O,V){return{left:O,right:O+q.w,top:V-q.h/2,bottom:V+q.h/2}}let k=null;const _=(v.top+v.bottom)/2,B=Math.max(q.h/2,Math.min(_,l-q.h/2));function X(O){for(let N=0;N<=30;N+=4){const gt=N%2===0?1:-1,mt=Math.ceil(N/2),z=gt*mt*4,wt=Math.max(q.h/2,Math.min(l-q.h/2,B+z)),Y=O,nt=j(Y,wt);if(!(window.__figBoxesGroup.some(Z=>Q(Z,nt,6))||(window.__dimBoxesGroup||[]).some(Z=>Q(Z,nt,3))||(window.__angleBoxesGroup||[]).some(Z=>Q(Z,nt,3))||(window.__legendBoxesGroup||[]).some(Z=>Q(Z,nt,6))||(window.__placedLetterBoxes||[]).some(Z=>Q(Z,nt,2))||nt.top<0||nt.bottom>l||nt.left<0||nt.right>r))return k={x:Y,y:wt,box:nt},!0}return!1}const ut=[{x:v.right+10,priority:1},{x:v.left-10-q.w,priority:1},{x:v.right+15,priority:2},{x:v.left-15-q.w,priority:2},{x:v.right+5,priority:2},{x:v.left-5-q.w,priority:2},{x:v.right+20,priority:3},{x:v.left-20-q.w,priority:3},{x:v.right+25,priority:3},{x:v.left-25-q.w,priority:3},{x:v.right+30,priority:3},{x:v.left-30-q.w,priority:3}];ut.sort((O,V)=>O.priority-V.priority);for(const O of ut){if(k)break;const V=It(O.x,q.w,0,r);if(X(V))break}if(!k){const O=(v.left+v.right)/2,V=[{x:O-q.w/2,y:v.top-q.h-5},{x:O-q.w/2,y:v.bottom+q.h+5}];for(const N of V){if(k)break;const gt=It(N.x,q.w,0,r),mt=Math.max(q.h/2,Math.min(l-q.h/2,N.y)),z=j(gt,mt);!window.__figBoxesGroup.some(Y=>Q(Y,z,6))&&!(window.__dimBoxesGroup||[]).some(Y=>Q(Y,z,3))&&!(window.__angleBoxesGroup||[]).some(Y=>Q(Y,z,3))&&!(window.__legendBoxesGroup||[]).some(Y=>Q(Y,z,6))&&!(window.__placedLetterBoxes||[]).some(Y=>Q(Y,z,2))&&z.top>=0&&z.bottom<=l&&z.left>=0&&z.right<=r&&(k={x:gt,y:mt,box:z})}}if(!k){const O=It(r-q.w,q.w,0,r),V=B;k={x:O,y:V,box:j(O,V)}}window.__placedLetterBoxes.push(k.box);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",k.x),H.setAttribute("y",k.y),H.setAttribute("fill",Rt),H.setAttribute("font-size",rt),H.setAttribute("text-anchor","start"),H.setAttribute("alignment-baseline","middle"),H.style.fontWeight="600",H.style.pointerEvents="none",H.textContent=ot,e.appendChild(H)}()}),s.innerHTML="",s.appendChild(e)};function kt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const h=window.elementosAgrupadosScript;if(!h)return;const a=document.getElementById("grid-maquina");if(a&&window.updateGridClasses){const i=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,o),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}h.forEach(function(i,o){renderizarGrupoSVG(i,o)}),requestAnimationFrame(()=>{a&&(a.style.opacity="1",a.style.visibility="visible",a.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",a.className)),document.querySelectorAll(".proceso").forEach(i=>{i.style.opacity="1"})}),window.actualizarSVGConColadas=function(i,o){if(!window.elementosAgrupadosScript)return;const s=window.elementosAgrupadosScript,r=s.findIndex(n=>n.etiqueta&&String(n.etiqueta.etiqueta_sub_id)===String(i));if(r===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${i}`);return}const l=s[r];l.elementos&&o&&l.elementos.forEach(n=>{const e=String(n.id),u=o[e];n.coladas||(n.coladas={colada1:null,colada2:null,colada3:null}),u&&Array.isArray(u)&&(n.coladas.colada1=u[0]||null,n.coladas.colada2=u[1]||null,n.coladas.colada3=u[2]||null)}),renderizarGrupoSVG(l,r),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${i}`,o)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",kt):kt();document.addEventListener("livewire:navigated",kt);window.abrirModalDividirElemento=function(a){const i=document.getElementById("modalDividirElemento"),o=document.getElementById("dividir_elemento_id"),s=document.getElementById("formDividirElemento");!i||!o||!s||(o.value=a,window.rutaDividirElemento&&s.setAttribute("action",window.rutaDividirElemento),i.classList.remove("hidden"))};window.enviarDivision=async function(){const a=document.getElementById("formDividirElemento"),i=a.getAttribute("action")||window.rutaDividirElemento,o=new FormData(a);try{const s=document.querySelector('meta[name="csrf-token"]'),r=o.get("_token")||(s?s.getAttribute("content"):null),n=await fetch(i,{method:"POST",headers:r?{"X-CSRF-TOKEN":r}:{},body:o}),e=await n.json();if(!n.ok||!e.success)throw new Error(e.message||"Error al dividir");a.reset();const u=document.getElementById("modalDividirElemento");u&&u.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",e.message,"success"):alert(e.message)}catch(s){window.Swal?window.Swal.fire("Error",s&&s.message||"Error","error"):alert(s&&s.message||"Error")}};(function(h){const a={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},i={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function o(e,u,m={}){console.log(`üîÑ Actualizando etiqueta ${e} a estado: ${u}`);const M=String(e).replace(/\./g,"-"),d=document.querySelector(`#etiqueta-${M}`);if(!d)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${e}`),!1;const w=String(u).toLowerCase().trim(),f=i[w];if(!f)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${u}`),!1;d.dataset.estado=w,Array.from(d.classList).forEach(t=>{t.startsWith("estado-")&&d.classList.remove(t)}),d.classList.add(f.cssClass),d.style.setProperty("--bg-estado",f.bgColor);const p=d.querySelector('[id^="contenedor-svg-"]');if(p){const t=p.querySelector("svg");t&&(t.style.background=f.bgColor)}const c=d.querySelector(".etiqueta-card")||d;return c&&(c.style.background=f.bgColor),s(d,w),r(d),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:e,estado:w,datosExtra:m}})),console.log(`‚úÖ Etiqueta ${e} actualizada a ${u}`),!0}function s(e,u){const m=e.querySelectorAll(".btn-fabricar"),M=["empaquetada","en-paquete"];m.forEach(d=>{M.includes(u)?(d.disabled=!0,d.style.opacity="0.5",d.style.cursor="not-allowed",d.title=`Etiqueta ya ${u}`):(d.disabled=!1,d.style.opacity="1",d.style.cursor="pointer",d.title="Fabricar esta etiqueta")})}function r(e){e.style.transition="transform 0.5s ease, background-color 0.5s ease",e.style.transform="scale(1.03)",setTimeout(()=>{e.style.transform="scale(1)"},400)}function l(e,u,m={}){console.log(`üîÑ Actualizando ${e.length} etiquetas...`);const d=e.map(w=>o(w,u,m)).filter(w=>w).length;return console.log(`‚úÖ ${d}/${e.length} etiquetas actualizadas`),d}function n(e){const u=String(e).replace(/\./g,"-"),m=document.querySelector(`#etiqueta-${u}`);return m?{id:e,estado:m.dataset.estado||"desconocido",elemento:m}:null}window.addEventListener("paquete:creado",e=>{const{codigoPaquete:u,etiquetaIds:m}=e.detail;console.log(`üì¶ Evento paquete:creado recibido - ${u} con ${m.length} etiquetas`),l(m,"empaquetada",{codigo_paquete:u})}),h.SistemaDOM={actualizarEstadoEtiqueta:o,actualizarMultiplesEtiquetas:l,obtenerEstadoActual:n,ESTADOS_CONFIG:i},h.ColoresEstado={actualizar:(e,u)=>{a[e]=u;const m=document.getElementById("colores-estado-css");if(m){let M=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[d,w]of Object.entries(a))M+=`.proceso.estado-${d} {
    --bg-estado: ${w};
}
`;m.textContent=M,console.log(`‚úÖ Color actualizado para estado "${e}": ${u}`)}},obtenerColor:e=>a[e],todos:()=>({...a})}})(window);function $t(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0,document.addEventListener("click",async n=>{var g,p,c;const e=n.target.closest(".btn-fabricar");if(!e)return;n.preventDefault();const u=(p=(g=document.getElementById("maquina-info"))==null?void 0:g.dataset)==null?void 0:p.maquinaId;if(!u){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const m=String(e.dataset.etiquetaId||"").trim(),M=m.replace(/\./g,"-"),d=document.querySelector(`#etiqueta-${M}`);if(d){const t=(d.dataset.estado||"").toLowerCase();if(["completada","en-paquete","empaquetada"].includes(t)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${m} ya est√° en estado ${t}.`,timer:2500,showConfirmButton:!1});return}}const w=Number(((c=window.DIAMETRO_POR_ETIQUETA)==null?void 0:c[m])??0);if(!m){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!w&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const f=e.disabled;e.disabled=!0;try{await h(m,u,w)}finally{e.disabled=f}});async function h(n,e,u=null){var t,b,y,E;const m=`/actualizar-etiqueta/${n}/maquina/${e}`,M=(t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"),d=n.replace(/\./g,"-"),f=(((y=(b=document.querySelector(`#etiqueta-${d}`))==null?void 0:b.dataset)==null?void 0:y.estado)||"").toLowerCase()==="fabricando",g=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",p=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",c=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual";if(g&&p||c){if(f&&((E=window._decisionCortePorEtiqueta)!=null&&E[n])){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[n],csrfToken:M,etiquetaId:n,onUpdate:a});return}for(;;){let x;try{x=await Cortes.mejorCorteSimple(n,u,M)}catch(S){l(S);return}if(!x)return;if(x.accion==="optimizar"){let S;try{S=await Cortes.mejorCorteOptimizado(n,u,x.patrones,M)}catch(A){l(A);return}if((S==null?void 0:S.accion)==="fabricar"){window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[n]={longitudBarraCm:S.longitudBarraCm,etiquetas:S.etiquetas},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[n],csrfToken:M,etiquetaId:n,onUpdate:a});return}else{if(S==="volver")continue;return}}if(x.accion==="fabricar_patron_simple"){const S=Math.round(Number(x.longitud_m||0)*100);if(!S){l("Longitud de barra no v√°lida.");return}window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[n]={longitudBarraCm:S,etiquetas:[{etiqueta_sub_id:n,elementos:[]}]},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta)),await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[n],csrfToken:M,etiquetaId:n,onUpdate:a});return}return}}try{const x=await fetch(m,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":M},body:JSON.stringify({})}),S=await x.json();if(!x.ok)throw new Error(S.message||"Error al actualizar");a(n,S)}catch(x){l(x)}}function a(n,e){var m,M;const u=n.replace(/\./g,"-");switch(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:n,estado:e.estado,peso_etiqueta:e.peso_etiqueta,nombre:e.nombre,data_completa:e}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(n,e.estado,{peso:e.peso_etiqueta,nombre:e.nombre||n}):i(n,e.estado),e.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(n,e.coladas_por_elemento),(e.estado||"").toLowerCase()){case"cortando":r("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":r("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),o(u);break;case"fabricando":r("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":r("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),o(u),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(n,{id:n,peso_etiqueta:e.peso_etiqueta||0,estado:"fabricada",nombre:e.nombre||n}),e.elementos&&Array.isArray(e.elementos)&&e.elementos.length>0?e.elementos.some(w=>w.coladas&&(w.coladas.colada1||w.coladas.colada2||w.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${n}`,e.elementos),s(n,e.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${n}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${n}`);break;case"completada":r("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(m=window._decisionCortePorEtiqueta)!=null&&m[n]&&(delete window._decisionCortePorEtiqueta[n],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),o(u),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(n,{id:n,peso_etiqueta:e.peso_etiqueta||0,estado:"completada",nombre:e.nombre||n}),e.elementos&&Array.isArray(e.elementos)&&e.elementos.length>0?e.elementos.some(w=>w.coladas&&(w.coladas.colada1||w.coladas.colada2||w.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${n}`,e.elementos),s(n,e.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${n}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${n}`);break;case"ensamblando":r("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":r("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),o(u);break;case"soldando":r("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":r("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),o(u);break;default:console.warn(`Estado no manejado para etiqueta ${n}: ${e.estado}`),r("warning","Estado desconocido",`El estado recibido (${e.estado}) no est√° reconocido.`,3e3)}(M=e.productos_afectados)!=null&&M.length&&e.productos_afectados.forEach(d=>{const w=document.getElementById(`peso-stock-${d.id}`),f=document.getElementById(`progreso-texto-${d.id}`),g=document.getElementById(`progreso-barra-${d.id}`);w&&(w.textContent=`${d.peso_stock} kg`),f&&(f.textContent=`${d.peso_stock} / ${d.peso_inicial} kg`),g&&(g.style.height=`${d.peso_stock/d.peso_inicial*100}%`)})}function i(n,e){const u=n.replace(/\./g,"-"),m=document.getElementById("etiqueta-"+u);if(!m)return;m.dataset.estado=String(e||"").toLowerCase(),m.className=m.className.split(" ").filter(w=>!w.startsWith("estado-")).join(" ").trim(),m.classList.add("estado-"+m.dataset.estado);const M=m.querySelector('[id^="contenedor-svg-"]'),d=M==null?void 0:M.querySelector("svg");d&&(d.style.background=getComputedStyle(m).getPropertyValue("--bg-estado").trim())}function o(n){const e=`#etiqueta-${CSS.escape(n)}`,u=document.querySelector(e),m=Array.from(document.querySelectorAll(".proceso")),M=t=>(t||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),d=t=>{var E;const b=(E=t.dataset)==null?void 0:E.estado;if(b)return M(b);const y=t.querySelector('[id^="estado-"]');return M((y==null?void 0:y.textContent)||(y==null?void 0:y.innerText)||"")},w=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),f=t=>w.has(d(t)),g=u?m.indexOf(u):-1,c=(g>=0?m.slice(g+1):m).find(t=>!f(t));c?c.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function s(n,e){var w;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${n}`),!e||!Array.isArray(e)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${n}`);return}if(e.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${n}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const u=window.elementosAgrupadosScript.findIndex(f=>{var g;return((g=f.etiqueta)==null?void 0:g.etiqueta_sub_id)===n});if(u===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${n}`);return}window.elementosAgrupadosScript[u].elementos=e;const m=window.elementosAgrupadosScript[u],M=(w=m.etiqueta)==null?void 0:w.id;if(!M){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${n}`);return}const d=document.getElementById("contenedor-svg-"+M);if(!d){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${n} (id: ${M})`);return}try{const f=d.querySelector("svg");f&&f.remove();const g=600,p=150,c=d.closest(".proceso"),t=c&&getComputedStyle(c).getPropertyValue("--bg-estado").trim()||"#e5e7eb",b=document.createElementNS("http://www.w3.org/2000/svg","svg");b.setAttribute("viewBox",`0 0 ${g} ${p}`),b.setAttribute("preserveAspectRatio","xMidYMid meet"),b.style.width="100%",b.style.height="100%",b.style.display="block",b.style.background=t;const y=(m.elementos||[]).map((x,S)=>{var v,ct,J;const A=x.barras!=null?x.barras:0;let C="N/A";if(x.diametro!=null&&x.diametro!==""){const $=String(x.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if($){const P=parseFloat($[0]);isFinite(P)&&(C=String(Math.round(P)))}}const D=[];(v=x.coladas)!=null&&v.colada1&&D.push(x.coladas.colada1),(ct=x.coladas)!=null&&ct.colada2&&D.push(x.coladas.colada2),(J=x.coladas)!=null&&J.colada3&&D.push(x.coladas.colada3);const U=D.length>0?` (${D.join(", ")})`:"";return{letter:indexToLetters(S),text:`√ò${C} x${A}${U}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(b,y,g,p):console.error("‚ùå drawLegendBottomLeft no est√° definida");const E=document.createElementNS("http://www.w3.org/2000/svg","text");E.setAttribute("x",g/2),E.setAttribute("y",p/2),E.setAttribute("text-anchor","middle"),E.setAttribute("fill","#059669"),E.setAttribute("font-size","14"),E.setAttribute("font-weight","600"),E.textContent="‚úì Coladas actualizadas",b.appendChild(E),d.appendChild(b),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${n}`),setTimeout(()=>{E&&E.parentNode&&E.remove()},2e3)}catch(f){console.error(`‚ùå Error al actualizar SVG para etiqueta ${n}:`,f),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function r(n,e,u,m=2e3){Swal.fire({icon:n,title:e,text:u,timer:m,showConfirmButton:!1})}function l(n){Swal.fire({icon:"error",title:"Error",text:n.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=a}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$t):$t();document.addEventListener("livewire:navigated",$t);(function(h){let a=[],i=!1,o=null;async function s(g){var c;const p=`/etiquetas/${encodeURIComponent(g)}/validar-para-paquete`;try{const t=await fetch(p,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.content}});if(!(t.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const y=await t.json();if(console.log("üîç validarEtiqueta response:",{status:t.status,data:y,peso_etiqueta:y.peso_etiqueta}),!t.ok)throw new Error((y==null?void 0:y.message)||(y==null?void 0:y.motivo)||"Error al validar");return y}catch(t){throw t}}function r(g,p){const c=p.id||g;if(a.some(y=>y.id===c))return!1;const t=parseFloat(p.peso_etiqueta)||0;console.log("üîç agregarItemEtiqueta:",{codigo:g,id:c,peso_etiqueta_recibido:p.peso_etiqueta,peso_parseado:t,data_completa:p});const b={id:c,type:"etiqueta",peso:t,estado:p.estado||"desconocido",nombre:p.nombre||"Sin nombre"};return a.push(b),m(),!0}function l(g){const p=a.findIndex(c=>c.id===g);p>=0&&a.splice(p,1),m()}function n(){a=[],m()}function e(){return a.reduce((g,p)=>g+(parseFloat(p.peso)||0),0)}function u(){return a}function m(){const g=document.getElementById("itemsList");if(!g)return;g.innerHTML="";for(const t of a){const b=document.createElement("li");b.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",b.dataset.code=t.id,b.innerHTML=`
                <div>
                    <div class="font-semibold">${t.id} === ${t.peso.toFixed(2)} kg</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,b.querySelector("button").onclick=()=>l(t.id),g.appendChild(b)}const p=e(),c=document.createElement("li");c.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",c.textContent=`Total: ${p.toFixed(2)} kg (${a.length} etiquetas)`,g.appendChild(c)}async function M(){var b,y,E;if(!a.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const g=Number(((y=(b=document.getElementById("maquina-info"))==null?void 0:b.dataset)==null?void 0:y.maquinaId)||window.maquinaId),p=Number(((E=document.getElementById("ubicacion-id"))==null?void 0:E.value)||window.ubicacionId);if(!g||!p){await Swal.fire("Faltan datos","Debe especificarse la m√°quina y la ubicaci√≥n.","error");return}const c={items:a.map(x=>({id:x.id,type:x.type})),maquina_id:g,ubicacion_id:p},t=async(x={})=>{var C;const S=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(C=document.querySelector('meta[name="csrf-token"]'))==null?void 0:C.content},body:JSON.stringify({...c,...x})}),A=await S.json();if(!S.ok)throw new Error(A.message||"Error al crear el paquete");return A};try{const x=await t();if(x.success)return d(x);if(x.warning){let S="<div style='text-align:left;'>Se detectaron advertencias:";for(const[C,D]of Object.entries(x.warning))Array.isArray(D)&&D.length&&(S+=`<br><strong>${C.replaceAll("_"," ")}:</strong> ${D.join(", ")}`);if(S+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:S,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const C=await t({confirmar:!0});if(C.success)return d(C);throw new Error(C.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(x){await Swal.fire("Error",x.message||"Error inesperado","error")}}async function d(g){var b;const p=g.codigo_paquete||((b=g.paquete)==null?void 0:b.codigo)||"N/D",c=e(),t=[...a.map(y=>y.id)];await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${p}</strong> creado correctamente</p><p>${t.length} etiquetas ¬∑ ${c.toFixed(2)} kg</p>`}),n(),console.log(`üì¶ Disparando evento paquete:creado para ${p}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:p,etiquetaIds:t,pesoTotal:c}})),typeof window.SistemaDOM>"u"?(console.log("‚ö†Ô∏è SistemaDOM no disponible, actualizando manualmente"),t.forEach(y=>{w(y,p)})):console.log("‚úÖ SistemaDOM detectado, se actualizar√° autom√°ticamente")}function w(g,p){const c=String(g).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${c}`);if(!t){console.warn(`‚ùå No se encontr√≥ elemento: ${g}`);return}console.log(`üîÑ Actualizando manualmente: ${g}`),Array.from(t.classList).forEach(A=>{A.startsWith("estado-")&&t.classList.remove(A)}),t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.style.setProperty("--bg-estado","#e3e4FA");const y=t.querySelector('[id^="contenedor-svg-"]');if(y){const A=y.querySelector("svg");A&&(A.style.background="#e3e4FA")}const E=t.querySelector(".etiqueta-card")||t;E&&(E.style.background="#e3e4FA");const x=t.querySelector("h3");if(x&&!t.querySelector(".paquete-info")){const A=document.createElement("div");A.className="paquete-info text-sm font-semibold mt-2 no-print",A.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",A.innerHTML=`
                <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Paquete: ${p}</span>
            `,x.parentNode.insertBefore(A,x.nextSibling)}t.querySelectorAll(".btn-fabricar").forEach(A=>{A.disabled=!0,A.style.opacity="0.5",A.style.cursor="not-allowed"}),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${g} actualizada manualmente`)}function f(){if(i)return;i=!0;const g=document.getElementById("qrItem");g&&(g.addEventListener("change",()=>g.dispatchEvent(new Event("input"))),g.addEventListener("input",async function(){const c=this.value.trim();if(c)try{const t=await s(c);if(!t.valida){await Swal.fire("Etiqueta no v√°lida",t.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}r(c,t)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(t){console.error("Error de validaci√≥n:",t),await Swal.fire("Error",t.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}));const p=document.getElementById("crearPaqueteBtn");p&&p.addEventListener("click",M),document.addEventListener("focus",function(c){c.target.id&&c.target.id.startsWith("input-etiqueta-")&&(o=c.target,console.log("üéØ Focus en input:",c.target.id))},!0),document.addEventListener("click",async function(c){var t;if(c.target.classList.contains("btn-agregar-carro")||c.target.closest(".btn-agregar-carro")){const y=(c.target.classList.contains("btn-agregar-carro")?c.target:c.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!y){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const E=document.querySelector(`[x-show="tabActivo === 'crear'"]`),x=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(E&&window.getComputedStyle(E).display,x&&window.getComputedStyle(x).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let A=document.activeElement;(!A||!((t=A.id)!=null&&t.startsWith("input-etiqueta-")))&&(A=o),(!A||!document.body.contains(A))&&(A=document.querySelector('input[id^="input-etiqueta-"]')),A?(A.value=y,A.focus(),A.classList.add("ring-4","ring-green-400"),setTimeout(()=>{A.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${y} a√±adida al input:`,A.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",y);try{const A=await s(y);if(!A.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:A.motivo||"Motivo no especificado"});return}r(y,A)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(A){console.error("Error al a√±adir al carro:",A),await Swal.fire({icon:"error",title:"Error",text:A.message||"No se pudo a√±adir al carro"})}}})}h.TrabajoPaquete={inicializar:f,agregarItemEtiqueta:r,eliminarItem:l,limpiarCarro:n,obtenerItems:u,calcularPesoTotal:e,crearPaquete:M,validarEtiqueta:s,actualizarListaVisual:m},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f(),document.addEventListener("livewire:navigated",f)})(window);function Nt(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(a,i){const o=document.getElementById("grid-maquina");if(!o)return;console.log("üîß Actualizando clases:",{showLeft:a,showRight:i,clasesAnteriores:o.className}),a||i?o.classList.add("columnas-laterales-visibles"):o.classList.remove("columnas-laterales-visibles"),a&&i?o.classList.add("ambas-columnas"):o.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",o.className),o.offsetHeight,o.querySelectorAll(".etiqueta-card").forEach(r=>{r.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const a=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,i)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const a=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(a,i)});function h(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((r,l)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),l.disconnect();const e=JSON.parse(localStorage.getItem("showLeft")??"true"),u=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(e,u)}}).observe(document.body,{childList:!0,subtree:!0});return}const i=JSON.parse(localStorage.getItem("showLeft")??"true"),o=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(i,o),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}h()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Nt):Nt();document.addEventListener("livewire:navigated",Nt);
