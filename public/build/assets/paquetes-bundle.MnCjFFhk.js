document.addEventListener("DOMContentLoaded",function(){const p=document.getElementById("modal-dibujo"),M=document.getElementById("cerrar-modal"),g=document.getElementById("canvas-dibujo");if(!g){console.log("Canvas no encontrado en esta pÃ¡gina, saltando inicializaciÃ³n de figuras");return}const f=g.getContext("2d"),n=50,r=25,o=10,c=100;function t(e){const a=[],s=[];return e.split(/\s+/).forEach(i=>{i.includes("d")?s.push(parseFloat(i.replace("d",""))||0):a.push(parseFloat(i)||50)}),{longitudes:a,angulos:s}}function j(e,a){let s=0,i=0,l=0,d=0,u=0,q=0,m=0;return e.forEach((v,y)=>{s+=v*Math.cos(l*Math.PI/180),i+=v*Math.sin(l*Math.PI/180),d=Math.min(d,s),u=Math.max(u,s),q=Math.min(q,i),m=Math.max(m,i),l+=a[y]||0}),{minX:d,maxX:u,minY:q,maxY:m}}function b(e){f.clearRect(0,0,g.width,g.height);const a=e.length,s=g.width,i=r*2+a*c+(a-1)*o;g.height=i;const l=s-2*n,d=(i-2*r-(a-1)*o)/a;e.forEach((u,q)=>{const{longitudes:m,angulos:v}=t(u.dimensiones||""),y=n+l/2,E=r+d/2+q*(d+o);m.length===1?P(f,y,E,l,m):h(f,y,E,l,d,m,v),f.font="14px Arial",f.fillStyle="#FF0000",f.fillText(`#${u.id}`,n+l-10,E+d/2-5)})}function P(e,a,s,i,l){const d=i/Math.abs(l),u=Math.abs(l)*d;e.strokeStyle="#0000FF",e.lineWidth=2,e.beginPath(),e.moveTo(a-u/2,s),e.lineTo(a+u/2,s),e.stroke(),e.font="12px Arial",e.fillStyle="red",e.fillText(l.toString(),a,s-10)}function h(e,a,s,i,l,d,u){const{minX:q,maxX:m,minY:v,maxY:y}=j(d,u),E=m-q,A=y-v,I=E<A,L=Math.min(i/(I?A:E),l/(I?E:A)),Y=(q+m)/2,C=(v+y)/2;e.save(),e.translate(a,s),I&&e.rotate(-Math.PI/2),e.scale(L,L),e.translate(-Y,-C),e.strokeStyle="#0000FF",e.lineWidth=2/L,e.beginPath();let w=0,S=0,T=0;e.moveTo(w,S),d.forEach(($,k)=>{const z=w+$*Math.cos(T*Math.PI/180),F=S+$*Math.sin(T*Math.PI/180);e.lineTo(z,F);const B=(w+z)/2,H=(S+F)/2,D=Math.atan2(F-S,z-w);e.save(),e.translate(B,H),e.rotate(D),e.font=`${12/L}px Arial`,e.fillStyle="red",e.fillText($.toFixed(1),0,-5/L),e.restore(),w=z,S=F,T+=u[k]||0}),e.stroke(),e.restore()}function X(e){const a=window.paquetes.find(l=>l.id==e);if(console.log(window.paquetes),!a){console.warn("No se encontrÃ³ el paquete.");return}let s=a.elementos||[],i=a.subpaquetes||[];s.length>0?(b(s),p.classList.remove("hidden")):i.length>0?(b(i),p.classList.remove("hidden")):alert("Este paquete no tiene elementos para dibujar.")}M.addEventListener("click",function(){p.classList.add("hidden")}),p.addEventListener("click",function(e){e.target===p&&p.classList.add("hidden")}),window.mostrarDibujo=X});(function(p){function M(n,r,o=null){const c=String(n).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${c}`);if(!t){console.warn(`âš ï¸ No se encontrÃ³ elemento: ${n}`);return}if(console.log(`ðŸ”„ Actualizando estado de etiqueta ${n} a: ${r}`),Array.from(t.classList).forEach(h=>{h.startsWith("estado-")&&t.classList.remove(h)}),r==="en-paquete"&&o)t.classList.add("estado-en-paquete"),t.dataset.estado="en-paquete",t.dataset.paquete=o,t.style.setProperty("--bg-estado","#e3e4FA"),g(t,o);else if(r==="pendiente"){t.classList.add("estado-pendiente"),t.dataset.estado="pendiente",delete t.dataset.paquete,t.style.setProperty("--bg-estado","#ffffff");const h=t.querySelector(".paquete-info");h&&h.remove()}const b=t.querySelector('[id^="contenedor-svg-"]');if(b){const h=b.querySelector("svg");h&&(h.style.background=r==="en-paquete"?"#e3e4FA":"#ffffff")}const P=t.querySelector(".etiqueta-card")||t;P&&(P.style.background=r==="en-paquete"?"#e3e4FA":"#ffffff"),t.style.transition="transform 0.5s ease, background-color 0.5s ease",t.style.transform="scale(1.03)",setTimeout(()=>{t.style.transform="scale(1)"},400),console.log(`âœ… Etiqueta ${n} actualizada a estado: ${r}`)}function g(n,r){const o=n.querySelector("h3");if(!o)return;let c=n.querySelector(".paquete-info");c||(c=document.createElement("div"),c.className="paquete-info text-sm font-semibold mt-2 no-print",c.style.cssText="display: flex; align-items: center; gap: 0.25rem; color: #7c3aed; font-size: 0.875rem;",o.parentNode.insertBefore(c,o.nextSibling)),c.innerHTML=`
            <svg style="width: 1rem; height: 1rem;" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
            </svg>
            <span>Paquete: ${r}</span>
        `}function f(){console.log("ðŸŽ§ Inicializando listeners de paquetes..."),window.addEventListener("paquete:creado",n=>{console.log("ðŸŽ‰ Paquete creado:",n.detail);const{codigoPaquete:r,etiquetaIds:o}=n.detail;Array.isArray(o)&&o.forEach(c=>{M(c,"en-paquete",r)})}),window.addEventListener("paquete:actualizado",n=>{console.log("ðŸ”„ Paquete actualizado:",n.detail);const{paqueteId:r,etiquetaCodigo:o,eliminada:c}=n.detail;c?M(o,"pendiente"):fetch(`/api/paquetes/${r}`).then(t=>t.json()).then(t=>{t.success&&t.paquete&&M(o,"en-paquete",t.paquete.codigo)}).catch(t=>console.error("Error al obtener info del paquete:",t))}),console.log("âœ… Listeners de paquetes inicializados")}p.GestionPaquetesDOM={actualizarEstadoEtiquetaPaquete:M,actualizarInfoPaqueteEnEtiqueta:g,inicializarListenersPaquetes:f},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f()})(window);
