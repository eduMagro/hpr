const Xt="rgba(0, 0, 0, 0.8)",Bt="rgba(0, 0, 0, 1)",Ut="rgba(0, 0, 0, 1)";function Ht(v,c){return!c||c===1?v.map(r=>({...r})):v.map(r=>r.type==="line"?{...r,length:(r.length||0)*c}:r.type==="arc"?{...r,radius:(r.radius||0)*c}:{...r})}const Yt=.75,Tt=14,Wt=60,zt=[0,10,-10,20,-20,30,-30];function U(v){return v*Math.PI/180}function Jt(v){const c=v.closest(".proceso");return c&&getComputedStyle(c).getPropertyValue("--bg-estado").trim()||"#e5e7eb"}function Qt(v,c,r){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");return i.setAttribute("viewBox","0 0 "+v+" "+c),i.setAttribute("preserveAspectRatio","xMidYMid meet"),i.style.width="100%",i.style.height="100%",i.style.display="block",i.style.background=r||"#ffffff",i.style.shapeRendering="geometricPrecision",i.style.textRendering="optimizeLegibility",i.style.boxSizing="border-box",i}function Kt(v,c,r,i){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",c),n.setAttribute("stroke",r),n.setAttribute("fill","none"),n.setAttribute("stroke-width",i),n.setAttribute("vector-effect","non-scaling-stroke"),v.appendChild(n),n}function Ft(v){let c="",r=Number(v)||0;for(;r>=0;){const i=r%26;c=String.fromCharCode(65+i)+c,r=Math.floor(r/26)-1}return c}const Zt=0,te=-25;function ee(v,c,r,i){if(!c||!c.length)return;const n=2,b=12,w=b+n,S=c.map(a=>(a.letter?a.letter+" ":"")+(a.text||"")),m=b*S.length+n*(S.length-1),y=Zt;let t=i-te-m+b/2;window.__legendBoxesGroup=window.__legendBoxesGroup||[];for(let a=0;a<S.length;a++){const e=S[a],d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",y),d.setAttribute("y",t),d.setAttribute("fill",Ut),d.setAttribute("font-size",b),d.setAttribute("text-anchor","start"),d.setAttribute("alignment-baseline","middle"),d.style.pointerEvents="none",d.textContent=e,v.appendChild(d);const u=Lt(e,b).w;window.__legendBoxesGroup.push({left:y,right:y+u,top:t-b/2,bottom:t+b/2}),t+=w}}function oe(v){const c=(v||"").split(/\s+/).filter(Boolean),r=[];for(let i=0;i<c.length;i++){const n=c[i];if(n.endsWith("r")){const b=parseFloat(n.slice(0,-1));let w=360;i+1<c.length&&c[i+1].endsWith("d")&&(w=parseFloat(c[++i].slice(0,-1))),r.push({type:"arc",radius:b,arcAngle:w})}else n.endsWith("d")?r.push({type:"turn",angle:parseFloat(n.slice(0,-1))}):r.push({type:"line",length:parseFloat(n)})}return r}function ae(v){let c=[],r=0,i=0,n=0;c.push({x:r,y:i});for(let b=0;b<v.length;b++){const w=v[b];if(w.type==="line")r+=w.length*Math.cos(U(n)),i+=w.length*Math.sin(U(n)),c.push({x:r,y:i});else if(w.type==="turn")n+=w.angle;else if(w.type==="arc"){const S=r+w.radius*Math.cos(U(n+90)),m=i+w.radius*Math.sin(U(n+90)),y=Math.atan2(i-m,r-S),t=y+U(w.arcAngle);r=S+w.radius*Math.cos(t),i=m+w.radius*Math.sin(t),n+=w.arcAngle,c.push({x:r,y:i})}}return c}function Rt(v){let c=[],r=0,i=0,n=0;for(let b=0;b<v.length;b++){const w=v[b];if(w.type==="line"){const S={x:r,y:i},m={x:r+w.length*Math.cos(U(n)),y:i+w.length*Math.sin(U(n))};c.push({start:S,end:m,length:w.length}),r=m.x,i=m.y}else if(w.type==="turn")n+=w.angle;else if(w.type==="arc"){const S=r+w.radius*Math.cos(U(n+90)),m=i+w.radius*Math.sin(U(n+90)),y=Math.atan2(i-m,r-S),t=y+U(w.arcAngle);r=S+w.radius*Math.cos(t),i=m+w.radius*Math.sin(t),n+=w.arcAngle}}return c}function Lt(v,c){const r=c||12;return{w:(v?v.length:0)*r*.55,h:r}}function nt(v,c,r){const i=r||0;return!(v.right+i<c.left||v.left-i>c.right||v.bottom+i<c.top||v.top-i>c.bottom)}function Pt(v,c,r,i){const n=c/2;return Math.max(r+n,Math.min(i-n,v))}function ne(v,c){const i=[];let n=0;function b(){n>1e-9&&(i.push({type:"line",length:n}),n=0)}for(let w=0;w<v.length;w++){const S=v[w];if(S.type==="line"){n+=S.length;continue}if(S.type==="turn"){if(Math.abs(S.angle)<1e-9)continue;b(),i.push(S);continue}if(S.type==="arc"){b(),i.push(S);continue}b(),i.push(S)}return b(),i}function Vt(v,c){const r=c&&c.decimals||0,i=c&&c.step||null;let n=Number(v||0);return i&&i>0&&(n=Math.round(n/i)*i),n.toFixed(r).replace(/\.0+$/,"")}function se(v,c){const r=Math.hypot(v,c)||1;let i=v/r,n=c/r;return(n<-1e-9||Math.abs(n)<=1e-9&&i<0)&&(i=-i,n=-n),{ux:i,uy:n}}function jt(v,c,r){const i=r||.01,n=se(v,c),b=Math.round(n.ux/i)*i,w=Math.round(n.uy/i)*i;return b+"|"+w}function ie(v,c,r){const i=r&&r.dirPrecision||.01,n=r&&r.labelFormat||{decimals:0,step:null},b=v.reduce((d,u)=>d+Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y),0),w=c.reduce((d,u)=>d+(u.length||Math.hypot(u.end.x-u.start.x,u.end.y-u.start.y)),0),S=w>0?b/w:1,m=new Map;for(let d=0;d<c.length;d++){const u=c[d],f=u.end.x-u.start.x,s=u.end.y-u.start.y,o=jt(f,s,i),l=m.get(o)||[];l.push({length:u.length||Math.hypot(f,s),index:d}),m.set(o,l)}const y=c.map(d=>d.length||Math.hypot(d.end.x-d.start.x,d.end.y-d.start.y)),t=new Set,a=new Set,e=[];for(let d=0;d<v.length;d++){const u=v[d],f=u.end.x-u.start.x,s=u.end.y-u.start.y,o=jt(f,s,i),l=m.get(o)||[],h=Math.hypot(f,s);let g=h;if(l.length){const M=h/S;let E=null,x=1/0;for(const A of l){const $=Math.abs(A.length-M),L=a.has(A.index)?.1:0;$+L<x&&(E=A,x=$+L)}E&&(g=E.length,a.add(E.index))}else d<y.length&&(g=y[d]);const p=Vt(g,n),q=o+"|"+p;t.has(q)||(t.add(q),e.push({start:u.start,end:u.end,_dirKey:o,_label:p,_lenChosen:g}))}return e}function re(v,c){const r=c,i=v.map(s=>Object.assign({},s));let n=0,b=0,w=0;const S=[];let m=null,y=-1,t=-1;const a=1e-7;function e(s){return s*Math.PI/180}function d(s){return Math.abs(Math.sin(e(s)))<1e-12}function u(s,o,l,h){return Math.min(o,h)-Math.max(s,l)>a}for(let s=0;s<i.length;s++){let l=function(){const E={x:Math.cos(e(w)),y:Math.sin(e(w))},x=n+i[s].length*E.x,A=b+i[s].length*E.y,$=d(w);for(let L=0;L<S.length;L++){const B=S[L];if($&&B.horiz&&Math.abs(b-B.y)<a){if(u(Math.min(n,x),Math.max(n,x),Math.min(B.x1,B.x2),Math.max(B.x1,B.x2))&&m&&y>=0&&t>=0)return i[t].length+=r,n+=m.x*r,b+=m.y*r,S[y].x2+=m.x*r,S[y].y2+=m.y*r,!0}else if(!$&&!B.horiz&&Math.abs(n-B.x)<a&&u(Math.min(b,A),Math.max(b,A),Math.min(B.y1,B.y2),Math.max(B.y1,B.y2))&&m&&y>=0&&t>=0)return i[t].length+=r,n+=m.x*r,b+=m.y*r,S[y].x2+=m.x*r,S[y].y2+=m.y*r,!0}return!1};var f=l;const o=i[s];if(o.type==="turn"){w+=o.angle;continue}if(o.type==="arc"){const E=n+o.radius*Math.cos(e(w+90)),x=b+o.radius*Math.sin(e(w+90)),A=Math.atan2(b-x,n-E),$=A+e(o.arcAngle);n=E+o.radius*Math.cos($),b=x+o.radius*Math.sin($),w+=o.arcAngle,m=null;continue}let h=0;for(;l()&&h<3;)h++;const g={x:Math.cos(e(w)),y:Math.sin(e(w))},p=n+i[s].length*g.x,q=b+i[s].length*g.y,M=d(w);S.push({x1:n,y1:b,x2:p,y2:q,horiz:M,y:b,x:n}),m=g,y=S.length-1,t=s,n=p,b=q}return i}function _t(v,c,r,i){const n=U(i),b=Math.cos(n),w=Math.sin(n),S=v.x-c,m=v.y-r;return{x:c+S*b-m*w,y:r+S*w+m*b}}function ce(v,c,r,i,n,b,w,S,m){let y="",t=0,a=0,e=0,d=!1;function u(s,o){const l=_t({x:s,y:o},c,r,i);return{x:S+(l.x-b)*n,y:m+(l.y-w)*n}}function f(){if(!d){const s=u(t,a);y+="M "+s.x+" "+s.y,d=!0}}for(let s=0;s<v.length;s++){const o=v[s];if(o.type==="turn"){e+=o.angle;continue}if(o.type==="line"){const l=t+o.length*Math.cos(U(e)),h=a+o.length*Math.sin(U(e));f();const g=u(l,h);y+=" L "+g.x+" "+g.y,t=l,a=h;continue}if(o.type==="arc"){const l=t+o.radius*Math.cos(U(e+90)),h=a+o.radius*Math.sin(U(e+90)),g=Math.atan2(a-h,t-l),p=g+U(o.arcAngle),q=l+o.radius*Math.cos(p),M=h+o.radius*Math.sin(p),E=Math.abs(o.arcAngle)%360;if(f(),E<1e-6||Math.abs(o.arcAngle)>=359.9){const B=g+Math.sign(o.arcAngle)*Math.PI,F=l+o.radius*Math.cos(B),_=h+o.radius*Math.sin(B),C=u(F,_),N=u(t,a),I=o.radius*n,O=o.arcAngle>=0?1:0;y+=" A "+I+" "+I+" 0 1 "+O+" "+C.x+" "+C.y,y+=" A "+I+" "+I+" 0 1 "+O+" "+N.x+" "+N.y,e+=o.arcAngle;continue}const x=u(q,M),A=o.radius*n,$=E>180?1:0,L=o.arcAngle>=0?1:0;y+=" A "+A+" "+A+" 0 "+$+" "+L+" "+x.x+" "+x.y,t=q,a=M,e+=o.arcAngle}}return y||"M 0 0"}function le(v){const c=ae(v);let r=Math.min(...c.map(f=>f.x)),i=Math.max(...c.map(f=>f.x)),n=Math.min(...c.map(f=>f.y)),b=Math.max(...c.map(f=>f.y));const w=(r+i)/2,S=(n+b)/2,y=b-n>i-r?-90:0,t=c.map(f=>_t(f,w,S,y));r=Math.min(...t.map(f=>f.x)),i=Math.max(...t.map(f=>f.x)),n=Math.min(...t.map(f=>f.y)),b=Math.max(...t.map(f=>f.y));const a=Math.max(1,i-r),e=Math.max(1,b-n),d=(r+i)/2,u=(n+b)/2;return{rotDeg:y,w:a,h:e,cxModel:w,cyModel:S,midX:d,midY:u,ptsRot:t}}function de(v){const c=[];let r=0,i=0,n=0;function b(w){const S=U(w);return{x:Math.cos(S),y:Math.sin(S)}}for(let w=0;w<v.length;w++){const S=v[w];if(S.type==="line")r+=S.length*Math.cos(U(n)),i+=S.length*Math.sin(U(n));else if(S.type==="turn"){const m=b(n),y=S.angle;n+=y;const t=b(n);c.push({x:r,y:i,angleDeg:y,prevDir:m,nextDir:t})}else if(S.type==="arc"){const m=r+S.radius*Math.cos(U(n+90)),y=i+S.radius*Math.sin(U(n+90)),t=Math.atan2(i-y,r-m),a=t+U(S.arcAngle);r=m+S.radius*Math.cos(a),i=y+S.radius*Math.sin(a),n+=S.arcAngle}}return c}function ue(v,c,r){const i=Array.from({length:c},()=>({sumH:0,maxW:0,items:[]})),n=[...v.keys()].sort((b,w)=>v[w].h-v[b].h);for(const b of n){let w=0,S=1/0;for(let y=0;y<c;y++){const t=i[y],a=t.sumH+(t.items.length>0?r:0)+v[b].h;a<S&&(S=a,w=y)}const m=i[w];m.sumH=m.items.length>0?m.sumH+r+v[b].h:m.sumH+v[b].h,m.maxW=Math.max(m.maxW,v[b].w),m.items.push(b)}return i}function pe(v,c,r,i={}){const n=i.padding??12,b=i.gapCol??12,w=i.gapRow??10,S=Math.max(1,Math.min(v.length,i.kMax??4)),m=Math.max(10,c-2*n),y=Math.max(10,r-2*n),t=a(v);function a(l){const h=l.map(I=>I.w/Math.max(I.h,1)),g=l.map(I=>I.h),p=l.map(I=>I.w),q=l.map(I=>I.w*I.h),M=I=>I.reduce((O,z)=>O+z,0)/I.length,E=(I,O)=>I.reduce((z,D)=>z+Math.pow(D-O,2),0)/I.length,x=(I,O)=>Math.sqrt(E(I,O)),A=M(h),$=M(g),L=M(p),B=q.reduce((I,O)=>I+O,0),F=x(g,$),_=x(p,L),C=$>0?F/$:0,N=L>0?_/L:0;return{avgAspectRatio:A,avgHeight:$,avgWidth:L,totalArea:B,heightCV:C,widthCV:N,isLinear:A>6||$<L*.12,isUniformHeight:C<.15,isUniformWidth:N<.15,isHighlyVariable:C>.5||N>.5,count:l.length}}let e={S:0,k:1,cols:null,score:0};for(let l=1;l<=S;l++){const h=ue(v,l,w),g=h.reduce((D,J)=>D+J.maxW,0)+b*(l-1),p=Math.max(...h.map(D=>D.sumH));if(g<=0||p<=0)continue;const q=m/g,M=y/p,E=Math.min(q,M),x=Math.max(.01,E*.92),A=t.totalArea*x*x,$=m*y,L=A/$,B=h.map(D=>D.sumH*x),F=B.reduce((D,J)=>D+J,0)/l,_=Math.max(...B)-Math.min(...B),C=F>0?1-_/F:1,N=l===1?1.1:l===2?.9:.7,I=l>t.count*.5?.7:1,O=C>.85?1.05:1,z=x*(1+L*.25)*(1+C*.1)*N*I*O;z>e.score&&(e={S:x,k:l,cols:h,score:z,efficiency:L,colBalance:C})}const d=e.cols.map(l=>l.maxW*e.S),u=d.reduce((l,h)=>l+h,0);let f=[];if(e.k===1)f[0]=c/2;else{const l=(e.k-1)*b,h=u+l;if(h<m){const g=m-h,p=b+g/(e.k-1);let q=n;for(let M=0;M<e.k;M++)f[M]=q+d[M]/2,q+=d[M]+p}else{let g=n+Math.max(0,(m-h)/2);for(let p=0;p<e.k;p++)f[p]=g+d[p]/2,g+=d[p]+b}}const s=[],o=()=>!window.__legendBoxesGroup||window.__legendBoxesGroup.length===0?0:Math.max(...window.__legendBoxesGroup.map(l=>l.right));for(let l=0;l<e.k;l++){const h=e.cols[l];s[l]=[];const g=h.items.map(_=>v[_].h*e.S),p=g.reduce((_,C)=>_+C,0);if(h.items.length===0)continue;const q=f[l],M=e.cols[l].maxW*e.S,E=q-M/2,x=q+M/2,A=o(),B=Math.max(0,Math.min(x,A)-E)/M>.05;let F=y;if(B&&window.__legendBoxesGroup&&window.__legendBoxesGroup.length>0){const C=Math.min(...window.__legendBoxesGroup.map(N=>N.top))-15;F=Math.max(10,C-n)}if(h.items.length===1){const _=g[0],N=n+F-_/2-10,I=Math.max(n+_/2,Math.min(N,r-n-_/2));s[l].push(I);continue}if(p>F){console.warn(`Columna ${l}: elementos no caben (${p}px > ${F}px)`);const N=p/h.items.length<4?20:5;let I=n;for(let O=0;O<h.items.length;O++){const z=Math.max(g[O],2),D=I+z/2;s[l].push(D),I+=z+N}}else{const _=F-p,C=h.items.length-1;let N=_/C;p/h.items.length<4?N=Math.max(18,Math.min(N,50)):N=Math.max(5,N);const z=p+C*N,D=F-z;let mt=n+Math.max(0,D-10);for(let k=0;k<h.items.length;k++){const st=Math.max(g[k],2),ht=mt+st/2,T=n+F-st/2,W=Math.max(n+st/2,Math.min(ht,T));s[l].push(W),mt+=st+N}}}return{S:e.S,k:e.k,cols:e.cols,centersX:f,centersYByCol:s,padding:n,gapRow:w,gapCol:b}}window.renderizarGrupoSVG=function(c,r){const i=c&&c.etiqueta&&c.etiqueta.id!=null?c.etiqueta.id:c&&c.id!=null?c.id:r,n=document.getElementById("contenedor-svg-"+i);if(!n)return;const b=600,w=150,S=Jt(n),m=Qt(b,w,S);window.__placedLetterBoxes=[],window.__figBoxesGroup=[],window.__dimBoxesGroup=[],window.__angleBoxesGroup=[],window.__legendBoxesGroup=[];const y=[],t=new Map;(c.elementos||[]).forEach(s=>{var g,p,q,M,E,x;let o="0";if(s.diametro!=null&&s.diametro!==""){const $=String(s.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if($){const L=parseFloat($[0]);isFinite(L)&&(o=String(Math.round(L)))}}const l=(s.dimensiones||"barra").trim().toLowerCase(),h=`${o}|${l}`;if(t.has(h)){const A=t.get(h);y[A].barrasTotal+=s.barras||0,(g=s.coladas)!=null&&g.colada1&&!y[A].coladasSet.has(s.coladas.colada1)&&y[A].coladasSet.add(s.coladas.colada1),(p=s.coladas)!=null&&p.colada2&&!y[A].coladasSet.has(s.coladas.colada2)&&y[A].coladasSet.add(s.coladas.colada2),(q=s.coladas)!=null&&q.colada3&&!y[A].coladasSet.has(s.coladas.colada3)&&y[A].coladasSet.add(s.coladas.colada3)}else{const A=new Set;(M=s.coladas)!=null&&M.colada1&&A.add(s.coladas.colada1),(E=s.coladas)!=null&&E.colada2&&A.add(s.coladas.colada2),(x=s.coladas)!=null&&x.colada3&&A.add(s.coladas.colada3),y.push({elemento:s,diametro:o,dimensiones:s.dimensiones,barrasTotal:s.barras||0,coladasSet:A}),t.set(h,y.length-1)}});const a=y.map((s,o)=>{const l=[];c.colada_etiqueta&&l.push(c.colada_etiqueta),c.colada_etiqueta_2&&c.colada_etiqueta_2!==c.colada_etiqueta&&l.push(c.colada_etiqueta_2),l.length===0&&s.coladasSet.size>0&&l.push(...s.coladasSet);const h=l.length>0?` (${l.join(", ")})`:"";return{letter:Ft(o),text:`√ò${s.diametro} x${s.barrasTotal}${h}`}});ee(m,a,b,w);const e=y.map(s=>{const o=s.elemento,l=oe(o.dimensiones||""),h=ne(l);let g=0;for(const x of h)x.type==="line"&&(g=Math.max(g,Math.abs(x.length||0))),x.type==="arc"&&(g=Math.max(g,Math.abs(x.radius||0)));const q=g<=50?2:1,M=Ht(h,q),E=le(M);return{dimsRaw:l,dimsNoZero:h,dimsScaled:M,geomScale:q,medida:E}}),d=e.map(s=>s.medida),u=pe(d,b,w,{padding:20,gapCol:50,gapRow:22,kMax:3}),f=new Map;for(let s=0;s<u.k;s++)u.cols[s].items.forEach((o,l)=>f.set(o,{c:s,j:l}));y.forEach(function(s,o){const l=s.elemento,{dimsNoZero:h,dimsScaled:g,medida:p}=e[o],q=f.get(o),M=u.centersX[q.c],E=u.centersYByCol[q.c][q.j],x=u.S,A=p.ptsRot.map(k=>({x:M+(k.x-p.midX)*x,y:E+(k.y-p.midY)*x})),$=Math.min(...A.map(k=>k.x)),L=Math.max(...A.map(k=>k.x)),B=Math.min(...A.map(k=>k.y)),F=Math.max(...A.map(k=>k.y)),_={left:$,right:L,top:B,bottom:F};window.__figBoxesGroup.push({..._});const C=re(g,.6),N=ce(C,p.cxModel,p.cyModel,p.rotDeg,x,p.midX,p.midY,M,E),I=Kt(m,N,Xt,2);(function(){const st=de(g);function ht(P){return Math.abs(Math.abs(P)-90)>=Yt}const T=(P,G)=>_t({x:P.x,y:P.y},0,0,G),W=(P,G)=>{const Q=_t({x:P,y:G},p.cxModel,p.cyModel,p.rotDeg);return{x:M+(Q.x-p.midX)*x,y:E+(Q.y-p.midY)*x}},R=P=>Math.max(10,Math.min(28,P));st.forEach(P=>{if(!ht(P.angleDeg))return;const G=W(P.x,P.y),Q=T(P.prevDir,p.rotDeg),ft=T(P.nextDir,p.rotDeg),K=Math.atan2(Q.y,Q.x),V=K+U(P.angleDeg),Z=Math.min(_.right-_.left,_.bottom-_.top);let j=R(.12*Z);const wt=G.x+j*Math.cos(K),gt=G.y+j*Math.sin(K),Y=G.x+j*Math.cos(V),yt=G.y+j*Math.sin(V),tt=Math.abs(P.angleDeg),rt=tt>180?1:0,Mt=P.angleDeg>=0?1:0,ct=document.createElementNS("http://www.w3.org/2000/svg","path");ct.setAttribute("d",`M ${wt} ${gt} A ${j} ${j} 0 ${rt} ${Mt} ${Y} ${yt}`),ct.setAttribute("stroke","rgba(255,99,71,0.7)"),ct.setAttribute("stroke-width","2"),ct.setAttribute("fill","none"),ct.style.pointerEvents="none",m.appendChild(ct);let X=Q.x+ft.x,H=Q.y+ft.y;tt>180&&(X=-X,H=-H);let et=Math.hypot(X,H);if(et<1e-6){const dt=P.angleDeg>=0?1:-1;X=-Q.y*dt,H=Q.x*dt,et=Math.hypot(X,H)||1}X/=et,H/=et;const ot=(Math.round(P.angleDeg*100)/100).toString().replace(/\.0+$/,"")+"¬∞",at=Lt(ot,14);function At(dt,ut){return{left:dt-at.w/2,right:dt+at.w/2,top:ut-at.h/2,bottom:ut+at.h/2}}let it=null;for(let dt=Tt;dt<=Wt&&!it;dt+=4)for(let ut=0;ut<zt.length&&!it;ut++){const xt=zt[ut],Et=T({x:X,y:H},xt),St=G.x+Et.x*(j+dt),pt=G.y+Et.y*(j+dt),bt=At(St,pt);bt.top<0||bt.bottom>w||bt.left<0||bt.right>b||window.__figBoxesGroup.some(qt=>nt(qt,bt,6))||(window.__dimBoxesGroup||[]).some(qt=>nt(qt,bt,2))||(window.__angleBoxesGroup||[]).some(qt=>nt(qt,bt,2))||(window.__placedLetterBoxes||[]).some(qt=>nt(qt,bt,2))||(window.__legendBoxesGroup||[]).some(qt=>nt(qt,bt,6))||(it={x:St,y:pt,box:bt})}if(!it){const dt=G.x+X*(j+Tt),ut=G.y+H*(j+Tt),xt=At(dt,ut);it={x:dt,y:ut,box:xt}}window.__angleBoxesGroup.push(it.box);const lt=document.createElementNS("http://www.w3.org/2000/svg","text");lt.setAttribute("x",it.x),lt.setAttribute("y",it.y),lt.setAttribute("fill",Bt),lt.setAttribute("font-size",14),lt.setAttribute("text-anchor","middle"),lt.setAttribute("alignment-baseline","middle"),lt.style.cursor="pointer",lt.textContent=ot,m.appendChild(lt),lt.addEventListener("mouseenter",()=>{ct.setAttribute("stroke","rgba(255,69,0,1)"),ct.setAttribute("stroke-width","3"),ct.style.filter="drop-shadow(0 0 2px rgba(255,69,0,0.7))"}),lt.addEventListener("mouseleave",()=>{ct.setAttribute("stroke","rgba(255,99,71,0.7)"),ct.setAttribute("stroke-width","2"),ct.style.filter="none"})})})();const O=I.cloneNode(!1);O.setAttribute("stroke-width","50"),O.setAttribute("stroke","transparent"),O.setAttribute("fill","none"),O.style.cursor="pointer",["click","contextmenu","mouseenter","mouseleave","keydown"].forEach(k=>{O.addEventListener(k,st=>I.dispatchEvent(new st.constructor(st.type,st)))}),m.insertBefore(O,I),(l.codigo!=null?l.codigo:l.id)+"",I.style.cursor="pointer",I.setAttribute("title","Click: dividir ¬∑ Ctrl/Shift/‚åò+Click o bot√≥n derecho: info"),I.addEventListener("click",function(k){if(k.ctrlKey||k.metaKey||k.shiftKey){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id);return}abrirModalDividirElemento(l.id,l.barras||0)}),I.addEventListener("contextmenu",function(k){k.preventDefault(),window.mostrarPanelInfoElemento&&window.mostrarPanelInfoElemento(l.id)});const z=[],D=Rt(C),J=Rt(h);ie(D,J,{dirPrecision:.01,labelFormat:{decimals:0,step:null}}).forEach(function(k){const st=_t(k.start,p.cxModel,p.cyModel,p.rotDeg),ht=_t(k.end,p.cxModel,p.cyModel,p.rotDeg),T={x:M+(st.x-p.midX)*x,y:E+(st.y-p.midY)*x},W={x:M+(ht.x-p.midX)*x,y:E+(ht.y-p.midY)*x},R=k._label,P=W.x-T.x,G=W.y-T.y,Q=Math.hypot(P,G)||1,ft=P/Q,K=G/Q,V=G/Q,Z=-P/Q,j=(T.x+W.x)/2,wt=(T.y+W.y)/2,gt=j+V*10,Y=wt+Z*10,yt=Lt(R,14),tt=yt.w,rt=yt.h;function Mt(it,lt){return{left:it-tt/2,right:it+tt/2,top:lt-rt/2,bottom:lt+rt/2}}const ct=Q*.45;let X=gt,H=Y;for(let it=0;it<=Math.ceil(ct/6);it++){const lt=it%2===0?1:-1,dt=Math.ceil(it/2),ut=lt*dt*6;if(Math.abs(ut)>ct)continue;const xt=gt+ft*ut,Et=Y+K*ut,St=(xt-T.x)*ft+(Et-T.y)*K;if(St<0+tt*.3||St>Q-tt*.3)continue;const pt=Mt(xt,Et);if(!(nt({left:Math.min(T.x,W.x),right:Math.max(T.x,W.x),top:Math.min(T.y,W.y),bottom:Math.max(T.y,W.y)},pt,0)||(window.__angleBoxesGroup||[]).some(vt=>nt(vt,pt,2))||(window.__legendBoxesGroup||[]).some(vt=>nt(vt,pt,6))||z.some(vt=>nt(vt,pt,2))||pt.top<0||pt.bottom>w||pt.left<0||pt.right>b)){X=xt,H=Et,z.push(pt),window.__dimBoxesGroup.push(pt);break}}const et=document.createElementNS("http://www.w3.org/2000/svg","line");et.setAttribute("x1",T.x),et.setAttribute("y1",T.y),et.setAttribute("x2",W.x),et.setAttribute("y2",W.y),et.setAttribute("stroke","rgba(0,0,255,0.6)"),et.setAttribute("stroke-width","4"),et.setAttribute("stroke-linecap","round"),et.setAttribute("vector-effect","non-scaling-stroke"),et.style.opacity=0,et.style.pointerEvents="none",et.style.transition="opacity 120ms ease",m.appendChild(et);const ot=document.createElementNS("http://www.w3.org/2000/svg","text");ot.setAttribute("x",X),ot.setAttribute("y",H),ot.setAttribute("fill",Bt),ot.setAttribute("font-size",14),ot.setAttribute("text-anchor","middle"),ot.setAttribute("alignment-baseline","middle"),ot.setAttribute("tabindex","0"),ot.style.cursor="pointer",ot.textContent=R,m.appendChild(ot);function at(){et.style.opacity=1}function At(){et.style.opacity=0}ot.addEventListener("mouseenter",at),ot.addEventListener("mouseleave",At),ot.addEventListener("focus",at),ot.addEventListener("blur",At)}),function(){const st=[];let ht=0,T=0,W=0;for(let R=0;R<g.length;R++){const P=g[R];if(P.type==="line")ht+=P.length*Math.cos(U(W)),T+=P.length*Math.sin(U(W));else if(P.type==="turn")W+=P.angle;else if(P.type==="arc"){const G=ht+P.radius*Math.cos(U(W+90)),Q=T+P.radius*Math.sin(U(W+90)),ft=Math.atan2(T-Q,ht-G),K=ft+U(P.arcAngle);let V=P.radius;for(let Z=0;Z<h.length;Z++){const j=h[Z];if(j.type==="arc"&&Math.abs(j.arcAngle-P.arcAngle)<.01){V=j.radius;break}}st.push({center:{x:G,y:Q},radius:P.radius,originalRadius:V,arcAngle:P.arcAngle,startAngle:ft,endAngle:K}),ht=G+P.radius*Math.cos(K),T=Q+P.radius*Math.sin(K),W+=P.arcAngle}}st.forEach(function(R){const P=_t(R.center,p.cxModel,p.cyModel,p.rotDeg),G={x:M+(P.x-p.midX)*x,y:E+(P.y-p.midY)*x},Q=(R.startAngle+R.endAngle)/2,ft=R.radius*x,K="R"+Vt(R.originalRadius,{decimals:0,step:null}),V=Lt(K,14),Z=[0,15,-15,30,-30,45,-45,60,-60,90,-90];let j=!1,wt,gt,Y;for(let at=0;at<Z.length&&!j;at++){const At=Z[at],it=Q+U(At),lt={x:R.center.x+R.radius*Math.cos(it),y:R.center.y+R.radius*Math.sin(it)},dt=_t(lt,p.cxModel,p.cyModel,p.rotDeg),ut={x:M+(dt.x-p.midX)*x,y:E+(dt.y-p.midY)*x},xt=ut.x-G.x,Et=ut.y-G.y,St=Math.hypot(xt,Et)||1,pt=xt/St,bt=Et/St;for(let Ct=8;Ct<=60&&!j;Ct+=6){const $t=ft*.7;if(wt=G.x+pt*$t+pt*Ct,gt=G.y+bt*$t+bt*Ct,Y={left:wt-V.w/2,right:wt+V.w/2,top:gt-V.h/2,bottom:gt+V.h/2},!(Y.top<0||Y.bottom>w||Y.left<0||Y.right>b||window.__figBoxesGroup.some(It=>nt(It,Y,2))||(window.__legendBoxesGroup||[]).some(It=>nt(It,Y,2)))){j=!0;break}}}if(!j)return;z.push(Y);const yt={x:wt-G.x,y:gt-G.y},tt=Math.hypot(yt.x,yt.y)||1,rt={x:yt.x/tt,y:yt.y/tt},Mt=G.x+rt.x*ft*.6,ct=G.y+rt.y*ft*.6,X=document.createElementNS("http://www.w3.org/2000/svg","line");X.setAttribute("x1",G.x),X.setAttribute("y1",G.y),X.setAttribute("x2",Mt),X.setAttribute("y2",ct),X.setAttribute("stroke","rgba(0,128,0,0.6)"),X.setAttribute("stroke-width","4"),X.setAttribute("stroke-linecap","round"),X.setAttribute("vector-effect","non-scaling-stroke"),X.style.opacity=0,X.style.pointerEvents="none",X.style.transition="opacity 120ms ease",m.appendChild(X);const H=document.createElementNS("http://www.w3.org/2000/svg","text");H.setAttribute("x",wt),H.setAttribute("y",gt),H.setAttribute("fill",Bt),H.setAttribute("font-size",14),H.setAttribute("text-anchor","middle"),H.setAttribute("alignment-baseline","middle"),H.setAttribute("tabindex","0"),H.style.cursor="pointer",H.textContent=K,m.appendChild(H);function et(){X.style.opacity=1}function ot(){X.style.opacity=0}H.addEventListener("mouseenter",et),H.addEventListener("mouseleave",ot),H.addEventListener("focus",et),H.addEventListener("blur",ot)})}(),function(){const st=Ft(o),ht=14,T=Lt(st,ht);function W(V,Z){return{left:V,right:V+T.w,top:Z-T.h/2,bottom:Z+T.h/2}}let R=null;const P=(_.top+_.bottom)/2,G=Math.max(T.h/2,Math.min(P,w-T.h/2));function Q(V){for(let j=0;j<=30;j+=4){const wt=j%2===0?1:-1,gt=Math.ceil(j/2),Y=wt*gt*4,yt=Math.max(T.h/2,Math.min(w-T.h/2,G+Y)),tt=V,rt=W(tt,yt);if(!(window.__figBoxesGroup.some(at=>nt(at,rt,6))||(window.__dimBoxesGroup||[]).some(at=>nt(at,rt,3))||(window.__angleBoxesGroup||[]).some(at=>nt(at,rt,3))||(window.__legendBoxesGroup||[]).some(at=>nt(at,rt,6))||(window.__placedLetterBoxes||[]).some(at=>nt(at,rt,2))||rt.top<0||rt.bottom>w||rt.left<0||rt.right>b))return R={x:tt,y:yt,box:rt},!0}return!1}const ft=[{x:_.right+10,priority:1},{x:_.left-10-T.w,priority:1},{x:_.right+15,priority:2},{x:_.left-15-T.w,priority:2},{x:_.right+5,priority:2},{x:_.left-5-T.w,priority:2},{x:_.right+20,priority:3},{x:_.left-20-T.w,priority:3},{x:_.right+25,priority:3},{x:_.left-25-T.w,priority:3},{x:_.right+30,priority:3},{x:_.left-30-T.w,priority:3}];ft.sort((V,Z)=>V.priority-Z.priority);for(const V of ft){if(R)break;const Z=Pt(V.x,T.w,0,b);if(Q(Z))break}if(!R){const V=(_.left+_.right)/2,Z=[{x:V-T.w/2,y:_.top-T.h-5},{x:V-T.w/2,y:_.bottom+T.h+5}];for(const j of Z){if(R)break;const wt=Pt(j.x,T.w,0,b),gt=Math.max(T.h/2,Math.min(w-T.h/2,j.y)),Y=W(wt,gt);!window.__figBoxesGroup.some(tt=>nt(tt,Y,6))&&!(window.__dimBoxesGroup||[]).some(tt=>nt(tt,Y,3))&&!(window.__angleBoxesGroup||[]).some(tt=>nt(tt,Y,3))&&!(window.__legendBoxesGroup||[]).some(tt=>nt(tt,Y,6))&&!(window.__placedLetterBoxes||[]).some(tt=>nt(tt,Y,2))&&Y.top>=0&&Y.bottom<=w&&Y.left>=0&&Y.right<=b&&(R={x:wt,y:gt,box:Y})}}if(!R){const V=Pt(b-T.w,T.w,0,b),Z=G;R={x:V,y:Z,box:W(V,Z)}}window.__placedLetterBoxes.push(R.box);const K=document.createElementNS("http://www.w3.org/2000/svg","text");K.setAttribute("x",R.x),K.setAttribute("y",R.y),K.setAttribute("fill",Ut),K.setAttribute("font-size",ht),K.setAttribute("text-anchor","start"),K.setAttribute("alignment-baseline","middle"),K.style.fontWeight="600",K.style.pointerEvents="none",K.textContent=st,m.appendChild(K)}()}),n.innerHTML="",n.appendChild(m)};function Nt(){window.setDataSources&&window.setDataSources({sugerencias:window.SUGERENCIAS||{},elementosAgrupados:window.elementosAgrupadosScript||[]});const v=window.elementosAgrupadosScript;if(!v)return;const c=document.getElementById("grid-maquina");if(c&&window.updateGridClasses){const r=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,i),console.log("üé® Clases aplicadas ANTES de renderizar SVG")}v.forEach(function(r,i){renderizarGrupoSVG(r,i)}),requestAnimationFrame(()=>{c&&(c.style.opacity="1",c.style.visibility="visible",c.style.transition="opacity 0.2s ease-in, visibility 0s 0s",console.log("‚úÖ Grid visible con clases:",c.className)),document.querySelectorAll(".proceso").forEach(r=>{r.style.opacity="1"})}),window.actualizarSVGConColadas=function(r,i){if(!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,b=n.findIndex(S=>S.etiqueta&&String(S.etiqueta.etiqueta_sub_id)===String(r));if(b===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${r}`);return}const w=n[b];w.elementos&&i&&w.elementos.forEach(S=>{const m=String(S.id),y=i[m];S.coladas||(S.coladas={colada1:null,colada2:null,colada3:null}),y&&Array.isArray(y)&&(S.coladas.colada1=y[0]||null,S.coladas.colada2=y[1]||null,S.coladas.colada3=y[2]||null)}),renderizarGrupoSVG(w,b),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${r}`,i)},window.limpiarColadasSVG=function(r){if(!window.elementosAgrupadosScript)return;const i=window.elementosAgrupadosScript,n=i.findIndex(w=>w.etiqueta&&String(w.etiqueta.etiqueta_sub_id)===String(r));if(n===-1){console.warn(`No se encontr√≥ grupo para etiqueta ${r}`);return}const b=i[n];b.elementos&&b.elementos.forEach(w=>{w.coladas={colada1:null,colada2:null,colada3:null}}),renderizarGrupoSVG(b,n),console.log(`üßπ Coladas limpiadas del SVG para etiqueta ${r}`)},window.addEventListener("regenerar-svg-etiqueta",function(r){var S;const i=(S=r.detail)==null?void 0:S.etiquetaSubId;if(!i||!window.elementosAgrupadosScript)return;const n=window.elementosAgrupadosScript,b=n.findIndex(m=>m.etiqueta&&String(m.etiqueta.etiqueta_sub_id)===String(i));if(b===-1){console.warn(`No se encontr√≥ grupo para regenerar SVG: ${i}`);return}const w=n[b];renderizarGrupoSVG(w,b),console.log(`üîÑ SVG regenerado para etiqueta ${i} (evento deshacer)`)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Nt):Nt();document.addEventListener("livewire:navigated",Nt);window.abrirModalDividirElemento=function(c,r){const i=document.getElementById("modalDividirElemento"),n=document.getElementById("dividir_elemento_id"),b=document.getElementById("dividir_barras_totales"),w=document.getElementById("dividir_peso_total"),S=document.getElementById("labelBarrasActuales"),m=document.getElementById("barras_a_mover"),y=document.getElementById("previewDivision"),t=document.getElementById("formDividirElemento"),a=document.getElementById("badgeSugerenciaPeso"),e=document.getElementById("barrasSugeridas"),d=document.getElementById("detalleSugerencia");if(!i||!n||!t)return;n.value=c;let u=null,f=parseInt(r)||0;if(window.elementosAgrupadosScript){for(const x of window.elementosAgrupadosScript)if(x.elementos){const A=x.elementos.find($=>String($.id)===String(c));if(A){u=A,A.barras&&(f=parseInt(A.barras)||0);break}}}if(!u&&window.gruposResumenData){for(const x of window.gruposResumenData)if(x.elementos){const A=x.elementos.find($=>String($.id)===String(c));if(A){u=A,A.barras&&(f=parseInt(A.barras)||0);break}}}const s=u==null?void 0:u.estado,o=s==="fabricando"||s==="completada",l=u&&u.paquete_id,h=o||l,g=document.querySelector('input[name="accion_etiqueta"][value="cambiar_maquina"]'),p=g==null?void 0:g.closest("label");if(g){if(g.disabled=h,p)if(h){p.classList.add("opacity-50","cursor-not-allowed");let x=o?"La etiqueta est√° en proceso o completada":"El elemento pertenece a un paquete";p.setAttribute("title",x)}else p.classList.remove("opacity-50","cursor-not-allowed"),p.removeAttribute("title");if(h&&g.checked){const x=document.querySelector('input[name="accion_etiqueta"][value="dividir"]');x&&(x.checked=!0,typeof toggleCamposDivision=="function"&&toggleCamposDivision())}}b&&(b.value=f),S&&(S.textContent=f>0?f:"-");const q=u&&parseFloat(u.peso_numerico)||0;w&&(w.value=q),console.log("üîç Debug badge sugerencia:",{peso_numerico:u==null?void 0:u.peso_numerico,pesoTotal:q,barrasTotales:f});const M=1200,E=document.getElementById("divisionAutoData");if(a&&e&&f>0&&q>0){const x=q/f,A=Math.floor(M/x);if(q>M&&A<f){const $=Math.ceil(f/A),L=Math.floor(f/$),B=f%$;E&&(E.value=JSON.stringify({elemento_id:c,etiqueta_sub_id:(u==null?void 0:u.etiqueta_sub_id)||null,num_etiquetas:$,barras_por_etiqueta:L,etiquetas_con_barra_extra:B,barras_totales:f,peso_por_barra:x}));let F="";if(B===0)F=`${$} etiquetas de ${L} barras cada una (~${(L*x).toFixed(0)} kg)`;else{const _=L+1,C=L;F=`${B} etiqueta(s) de ${_} barras + ${$-B} etiqueta(s) de ${C} barras`}e.textContent=`${$} etiquetas`,d.innerHTML=F+`<br><span class="text-xs text-amber-600">Barras m√°x por etiqueta: ${A} (para no superar ${M} kg)</span>`,a.classList.remove("hidden")}else a.classList.add("hidden"),E&&(E.value="")}else a&&a.classList.add("hidden"),E&&(E.value="");m&&(m.value=""),y&&y.classList.add("hidden"),window.rutaDividirElemento&&t.setAttribute("action",window.rutaDividirElemento),i.classList.remove("hidden")};window.enviarDivision=async function(){const c=document.getElementById("formDividirElemento"),r=c.getAttribute("action")||window.rutaDividirElemento,i=new FormData(c);try{const n=document.querySelector('meta[name="csrf-token"]'),b=i.get("_token")||(n?n.getAttribute("content"):null),S=await fetch(r,{method:"POST",headers:b?{"X-CSRF-TOKEN":b}:{},body:i}),m=await S.text();let y;try{y=JSON.parse(m)}catch(a){const e=m.substring(0,200)+(m.length>200?"...":"");typeof window.mostrarErrorConReporte=="function"?window.mostrarErrorConReporte("El servidor devolvi√≥ una respuesta inv√°lida","Error de respuesta",`${a.message}

Respuesta: ${e}`):window.Swal&&window.Swal.fire("Error",a.message,"error");return}if(!S.ok||!y.success)throw new Error(y.message||"Error al dividir");c.reset();const t=document.getElementById("modalDividirElemento");t&&t.classList.add("hidden"),window.Swal?window.Swal.fire("Hecho",y.message,"success"):alert(y.message)}catch(n){typeof window.mostrarErrorConReporte=="function"?window.mostrarErrorConReporte(n&&n.message||"Error","Error"):window.Swal?window.Swal.fire("Error",n&&n.message||"Error","error"):alert(n&&n.message||"Error")}};(function(v){const c={pendiente:"#ffffff",fabricando:"#facc15",ensamblando:"#facc15",soldando:"#facc15",doblando:"#facc15",fabricada:"#22c55e",completada:"#22c55e",ensamblada:"#22c55e",soldada:"#22c55e","en-paquete":"#e3e4FA"},r={pendiente:{cssClass:"estado-pendiente",bgColor:"#ffffff",texto:"Pendiente",icono:"‚è≥"},fabricando:{cssClass:"estado-fabricando",bgColor:"#facc15",texto:"Fabricando",icono:"‚öôÔ∏è"},fabricada:{cssClass:"estado-fabricada",bgColor:"#22c55e",texto:"Fabricada",icono:"‚úÖ"},ensamblando:{cssClass:"estado-ensamblando",bgColor:"#facc15",texto:"Ensamblando",icono:"üîß"},ensamblada:{cssClass:"estado-ensamblada",bgColor:"#22c55e",texto:"Ensamblada",icono:"‚úÖ"},soldando:{cssClass:"estado-soldando",bgColor:"#facc15",texto:"Soldando",icono:"üî•"},soldada:{cssClass:"estado-soldada",bgColor:"#22c55e",texto:"Soldada",icono:"‚úÖ"},doblando:{cssClass:"estado-doblando",bgColor:"#facc15",texto:"Doblando",icono:"‚öôÔ∏è"},completada:{cssClass:"estado-completada",bgColor:"#22c55e",texto:"Completada",icono:"‚úÖ"},empaquetada:{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"Empaquetada",icono:"üì¶"},"en-paquete":{cssClass:"estado-en-paquete",bgColor:"#e3e4FA",texto:"En Paquete",icono:"üì¶"}};function i(m,y,t={}){console.log(`üîÑ Actualizando etiqueta ${m} a estado: ${y}`);const a=String(m).replace(/\./g,"-"),e=document.querySelector(`#etiqueta-${a}`);if(!e)return console.warn(`‚ùå No se encontr√≥ elemento para etiqueta: ${m}`),!1;const d=e.dataset.tieneMaquina2==="true"||t.es_secundaria;let u=String(y).toLowerCase().trim();const f=t.estado2||e.dataset.estado2||null;d&&f&&(u=f.toLowerCase().trim(),console.log(`üîÑ Usando estado2 para color: ${u}`));const s=String(y).toLowerCase().trim(),o=r[u]||r[s];if(!o)return console.warn(`‚ö†Ô∏è Estado no reconocido: ${y}`),!1;e.dataset.estado=s,f&&(e.dataset.estado2=f),Array.from(e.classList).forEach(q=>{(q.startsWith("estado-")||q.startsWith("estado2-"))&&e.classList.remove(q)}),e.classList.add(o.cssClass),f&&e.classList.add(`estado2-${f}`),e.style.setProperty("--bg-estado",o.bgColor);const h=e.querySelector('[id^="contenedor-svg-"]');if(h){const q=h.querySelector("svg");q&&(q.style.background=o.bgColor)}const g=e.querySelector(".etiqueta-card")||e;g&&(g.style.background=o.bgColor),n(e,u);const p=e.querySelector(".estado-badge");if(p){const q=r[s];let M=q?q.texto:s;if(f){const E=r[f.toLowerCase()];M+="/"+(E?E.texto:f)}p.textContent=M,p.className="estado-badge ml-2 text-xs px-2 py-0.5 rounded-full",u==="pendiente"?p.classList.add("bg-gray-200","text-gray-700"):["fabricando","ensamblando","soldando","doblando"].includes(u)?p.classList.add("bg-yellow-200","text-yellow-800"):["fabricada","completada","ensamblada","soldada"].includes(u)?p.classList.add("bg-green-200","text-green-800"):u==="en-paquete"||u==="empaquetada"?p.classList.add("bg-purple-200","text-purple-800"):p.classList.add("bg-gray-200","text-gray-700")}return b(e),window.dispatchEvent(new CustomEvent("etiqueta:actualizada",{detail:{etiquetaId:m,estado:s,datosExtra:t}})),console.log(`‚úÖ Etiqueta ${m} actualizada a ${y}`),!0}function n(m,y){const t=m.querySelectorAll(".btn-fabricar"),a=["empaquetada","en-paquete"];t.forEach(e=>{a.includes(y)?(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",e.title=`Etiqueta ya ${y}`):(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",e.title="Fabricar esta etiqueta")})}function b(m){m.style.transition="transform 0.5s ease, background-color 0.5s ease",m.style.transform="scale(1.03)",setTimeout(()=>{m.style.transform="scale(1)"},400)}function w(m,y,t={}){console.log(`üîÑ Actualizando ${m.length} etiquetas...`);const e=m.map(d=>i(d,y,t)).filter(d=>d).length;return console.log(`‚úÖ ${e}/${m.length} etiquetas actualizadas`),e}function S(m){const y=String(m).replace(/\./g,"-"),t=document.querySelector(`#etiqueta-${y}`);return t?{id:m,estado:t.dataset.estado||"desconocido",elemento:t}:null}window.addEventListener("paquete:creado",m=>{const{codigoPaquete:y,etiquetaIds:t}=m.detail;console.log(`üì¶ Evento paquete:creado recibido - ${y} con ${t.length} etiquetas`),w(t,"empaquetada",{codigo_paquete:y})}),v.SistemaDOM={actualizarEstadoEtiqueta:i,actualizarMultiplesEtiquetas:w,obtenerEstadoActual:S,ESTADOS_CONFIG:r},v.ColoresEstado={actualizar:(m,y)=>{c[m]=y;const t=document.getElementById("colores-estado-css");if(t){let a=`
/* === Colores de estado (inyectados din√°micamente) === */
.proceso {
    --bg-estado: #e5e7eb;
}
`;for(const[e,d]of Object.entries(c))a+=`.proceso.estado-${e} {
    --bg-estado: ${d};
}
`;t.textContent=a,console.log(`‚úÖ Color actualizado para estado "${m}": ${y}`)}},obtenerColor:m=>c[m],todos:()=>({...c})}})(window);function Dt(){if(window.__trabajoEtiquetaInit)return;window.__trabajoEtiquetaInit=!0;try{const t=localStorage.getItem("decisionCortePorEtiqueta");t&&(window._decisionCortePorEtiqueta=JSON.parse(t),console.log("üì¶ Decisiones de corte restauradas desde localStorage"))}catch(t){console.warn("No se pudieron restaurar decisiones de corte:",t)}document.addEventListener("click",async t=>{var h,g,p;const a=t.target.closest(".btn-fabricar");if(!a)return;t.preventDefault();const e=(g=(h=document.getElementById("maquina-info"))==null?void 0:h.dataset)==null?void 0:g.maquinaId;if(!e){console.error("No se encontr√≥ #maquina-info o data-maquina-id."),await Swal.fire({icon:"error",title:"Falta la m√°quina",text:"No se pudo determinar la m√°quina de trabajo."});return}const d=a.dataset.grupoId;if(d){const q=a.disabled;a.disabled=!0;try{await c(d,e)}finally{a.disabled=q}return}const u=String(a.dataset.etiquetaId||"").trim(),f=u.replace(/\./g,"-"),s=document.querySelector(`#etiqueta-${f}`);if(s){const q=(s.dataset.estado||"").toLowerCase(),M=(s.dataset.estado2||"").toLowerCase();s.dataset.maquinaId;const E=s.dataset.maquinaId2||"",x=E&&E===e,A=x?M:q;if(["completada","en-paquete","empaquetada"].includes(A)){await Swal.fire({icon:"info",title:"Etiqueta ya completada",text:`La etiqueta ${u} ya est√° en estado ${A}${x?" en esta m√°quina":""}.`,timer:2500,showConfirmButton:!1});return}}const o=Number(((p=window.DIAMETRO_POR_ETIQUETA)==null?void 0:p[u])??0);if(!u){Swal.fire({icon:"error",title:"Etiqueta no v√°lida",text:"Falta el ID de etiqueta."});return}if(!o&&(window.MAQUINA_TIPO||"").toLowerCase()==="barra"){Swal.fire({icon:"error",title:"Di√°metro desconocido",text:"No se pudo determinar el di√°metro de la subetiqueta."});return}const l=a.disabled;a.disabled=!0;try{await v(u,e,o)}finally{a.disabled=l}});async function v(t,a,e=null){var M,E,x,A,$,L,B,F;const d=`/actualizar-etiqueta/${t}/maquina/${a}`,u=(M=document.querySelector('meta[name="csrf-token"]'))==null?void 0:M.getAttribute("content"),f=t.replace(/\./g,"-"),o=(((x=(E=document.querySelector(`#etiqueta-${f}`))==null?void 0:E.dataset)==null?void 0:x.estado)||"").toLowerCase()==="fabricando",l=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",h=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",g=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",p=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_dobladora_barra";if(console.log("üìã [TrabajoEtiqueta] Tipo m√°quina:",{MAQUINA_TIPO:window.MAQUINA_TIPO,MAQUINA_CODIGO:window.MAQUINA_CODIGO,MAQUINA_TIPO_NOMBRE:window.MAQUINA_TIPO_NOMBRE,esMaquinaBarra:l,esSL28:h,esCortadoraManual:g,esCortadoraDobladoraBarra:p}),l&&h||g||p){if(o)if((A=window._decisionCortePorEtiqueta)!=null&&A[t]){await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1}),delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));return}else try{const _=await fetch(`/api/etiquetas/${t}/longitud-asignada`,{headers:{Accept:"application/json","X-CSRF-TOKEN":u}});if(_.ok){const C=await _.json();if(C.longitud_barra_cm){await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:C.longitud_barra_cm,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],csrfToken:u,etiquetaId:t,onUpdate:n,pedirDesperdicio:!1});return}}}catch(_){console.warn("No se pudo obtener longitud asignada:",_)}for(;;){let _;try{console.log("üìã [TrabajoEtiqueta] Llamando a mejorCorteSimple..."),_=await Cortes.mejorCorteSimple(t,e,u),console.log("üìã [TrabajoEtiqueta] Decisi√≥n recibida:",_)}catch(C){console.error("üìã [TrabajoEtiqueta] Error en mejorCorteSimple:",C),y(C);return}if(!_){console.log("üìã [TrabajoEtiqueta] Sin decisi√≥n, saliendo...");return}if(console.log("üìã [TrabajoEtiqueta] Acci√≥n:",_.accion),_.accion==="optimizar"){console.log("üìã [TrabajoEtiqueta] Entrando en flujo de optimizaci√≥n...");let C;try{C=await Cortes.mejorCorteOptimizado(t,e,_.patrones,u)}catch(N){y(N);return}if((C==null?void 0:C.accion)==="fabricar"){const N=(($=C.patronInfo)==null?void 0:$.desperdicio_cm)||((L=C.patron)==null?void 0:L.desperdicio_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:C.longitudBarraCm,etiquetas:C.etiquetas,desperdicioEstimadoCm:N},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const I=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:n});if(I!=null&&I.cancelled)continue;return}else{if(C==="volver")continue;return}}if(_.accion==="fabricar_patron_simple"){const C=Math.round(Number(_.longitud_m||0)*100);if(!C){y("Longitud de barra no v√°lida.");return}const N=((B=_.patronInfo)==null?void 0:B.desperdicio_cm)||((F=_.patron)==null?void 0:F.sobra_cm)||0;window._decisionCortePorEtiqueta=window._decisionCortePorEtiqueta||{},window._decisionCortePorEtiqueta[t]={longitudBarraCm:C,etiquetas:[{etiqueta_sub_id:t,elementos:[]}],desperdicioEstimadoCm:N},localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta));const I=await Cortes.enviarAFabricacionOptimizada({...window._decisionCortePorEtiqueta[t],csrfToken:u,etiquetaId:t,onUpdate:n});if(I!=null&&I.cancelled)continue;return}return}}if((window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"){try{await i(t,a,u)}catch(_){y(_)}return}try{const _=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({})}),C=await _.json();if(!_.ok)throw new Error(C.message||"Error al actualizar");n(t,C)}catch(_){y(_)}}async function c(t,a){var q,M,E,x,A,$,L,B,F;const e=(q=document.querySelector('meta[name="csrf-token"]'))==null?void 0:q.getAttribute("content"),d=document.querySelector(`[data-grupo-id="${t}"] .etiqueta-card`),u=(((M=d==null?void 0:d.dataset)==null?void 0:M.estado)||"pendiente").toLowerCase(),f=parseInt((E=d==null?void 0:d.dataset)==null?void 0:E.diametro)||0;if(["completada","en-paquete","empaquetada"].includes(u)){await Swal.fire({icon:"info",title:"Grupo ya completado",text:`El grupo ya est√° en estado ${u}.`,timer:2500,showConfirmButton:!1});return}const s=(window.MAQUINA_TIPO||"").toLowerCase()==="barra",o=(window.MAQUINA_CODIGO||"").toUpperCase()==="SL28",l=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="cortadora_manual",h=s&&o||l;let g=[];try{g=JSON.parse(((x=d==null?void 0:d.dataset)==null?void 0:x.etiquetasSubIds)||"[]")}catch(_){console.warn("Error parseando etiquetas del grupo:",_)}const p=(A=d==null?void 0:d.dataset)==null?void 0:A.primeraEtiquetaId;if(($=d==null?void 0:d.dataset)!=null&&$.planillaId||window.PLANILLA_ID,u==="pendiente"&&h&&p){try{for(;;){const _=await Cortes.mejorCorteSimple(p,f,e);if(!_)return;if(_.accion==="optimizar"){const C=await Cortes.mejorCorteOptimizado(p,f,null,e);if(C==="volver")continue;if(!C||C.accion!=="fabricar")return;const N=((L=C.patronInfo)==null?void 0:L.desperdicio_cm)||0;let I=null;const O=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:C.longitudBarraCm,etiquetas:C.etiquetas,csrfToken:e,etiquetaId:p,desperdicioEstimadoCm:N,onUpdate:(z,D)=>{D.producto_n_colada&&(I={colada1:D.producto_n_colada,colada2:D.producto2_n_colada||null}),r(d,"fabricando",t,I)},pedirDesperdicio:!0});if(O!=null&&O.cancelled)continue;r(d,"fabricando",t,I),m("info","Fabricando","Grupo iniciado con patr√≥n optimizado");return}if(_.accion==="fabricar_patron_simple"){const C=Math.round(Number(_.longitud_m||0)*100);if(!C){y("Longitud de barra no v√°lida.");return}const N=((B=_.patronInfo)==null?void 0:B.desperdicio_cm)||((F=_.patron)==null?void 0:F.sobra_cm)||0,I=g.map(D=>({etiqueta_sub_id:D,patron_letras:_.patron_letras||""}));let O=null;const z=await Cortes.enviarAFabricacionOptimizada({longitudBarraCm:C,etiquetas:I,csrfToken:e,etiquetaId:p,desperdicioEstimadoCm:N,onUpdate:(D,J)=>{J.producto_n_colada&&(O={colada1:J.producto_n_colada,colada2:J.producto2_n_colada||null}),r(d,"fabricando",t,O)},pedirDesperdicio:!0});if(z!=null&&z.cancelled)continue;r(d,"fabricando",t,O),m("info","Fabricando",`Grupo iniciado (${g.length} etiquetas)`);return}return}}catch(_){y(_)}return}try{const _=await fetch(`/api/etiquetas/resumir/${t}/estado`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":e},body:JSON.stringify({maquina_id:a})}),C=await _.json();if(!_.ok||!C.success)throw new Error(C.message||"Error al actualizar grupo");const N=C.nuevo_estado||"actualizado",I=C.imprimir_etiquetas||[],O={colada1:C.producto_n_colada||null,colada2:C.producto2_n_colada||null};if(r(d,N,t,O),N==="fabricando"){const z=O.colada1?` - Colada: ${O.colada1}`:"";m("info","Fabricando",`Grupo iniciado (${C.etiquetas_actualizadas||0} etiquetas)${z}`)}else N==="completada"&&m("success","¬°Completado!",`Grupo completado (${C.etiquetas_actualizadas||0} etiquetas)`);if(N==="completada"&&I.length>0){const z=I.map(J=>J.etiqueta_sub_id),D=await Swal.fire({icon:"question",title:"Imprimir etiquetas",html:`Se han completado <strong>${z.length}</strong> etiquetas.<br>¬øDeseas imprimirlas ahora?`,showCancelButton:!0,confirmButtonText:"Imprimir A6",cancelButtonText:"No imprimir",showDenyButton:!0,denyButtonText:"Imprimir A4",confirmButtonColor:"#3085d6",denyButtonColor:"#6c757d"});if(D.isConfirmed||D.isDenied){const J=D.isConfirmed?"a6":"a4";typeof window.refrescarEtiquetasMaquina=="function"&&(Swal.fire({title:"Preparando impresi√≥n...",html:"Renderizando etiquetas...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),await window.refrescarEtiquetasMaquina(),await new Promise(mt=>setTimeout(mt,200)),Swal.close()),typeof window.imprimirEtiquetas=="function"&&await window.imprimirEtiquetas(z,J)}if(window.TrabajoPaquete&&typeof window.TrabajoPaquete.validarEtiqueta=="function"){let J=0;for(const mt of z)try{const k=await window.TrabajoPaquete.validarEtiqueta(mt);k.valida&&window.TrabajoPaquete.agregarItemEtiqueta(mt,k)&&J++}catch(k){console.warn(`No se pudo a√±adir ${mt} al carro:`,k)}J>0&&m("success","A√±adidas al carro",`${J} etiquetas a√±adidas al carro`)}r(d,"completada",t)}}catch(_){y(_)}}function r(t,a,e,d=null){if(!t)return;["pendiente","fabricando","fabricada","completada","en-paquete"].forEach(s=>{t.classList.remove(`estado-${s}`)}),t.classList.add(`estado-${a}`),t.dataset.estado=a;const u=t.dataset.contenedorSvgId,f=t.dataset.elementos;if(u&&f&&typeof window.renderizarGrupoSVG=="function")try{const s=JSON.parse(f);d&&(s.forEach(l=>{l.coladas={colada1:d.colada1||null,colada2:d.colada2||null,colada3:null}}),t.dataset.elementos=JSON.stringify(s));const o={id:parseInt(u),etiqueta:{id:parseInt(u)},elementos:s};window.renderizarGrupoSVG(o,e)}catch(s){console.warn("No se pudo re-renderizar SVG del grupo:",s)}}async function i(t,a,e){var C,N,I,O,z;const d=Number(((C=window.DIAMETRO_POR_ETIQUETA)==null?void 0:C[t])??0),f=Number(((N=window.LONGITUD_POR_ETIQUETA)==null?void 0:N[t])??0)/100;let s="";try{const D=await fetch(`/api/productos/sugerencias?diametro=${d}&longitud=${f}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":e}});if(D.ok){const J=await D.json();J.productos&&J.productos.length>0?s=`
                        <div class="mt-3 mb-2 text-left">
                            <p class="font-semibold text-gray-700 mb-2">üìã Productos disponibles (√ò${d}mm x ${f.toFixed(1)}m):</p>
                            <div class="max-h-40 overflow-y-auto border rounded">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">C√≥digo</th>
                                            <th class="px-2 py-1 text-left">Stock</th>
                                            <th class="px-2 py-1 text-left">Ubicaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${J.productos.map(mt=>`
                                            <tr class="border-t hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('swal-input-producto').value='${mt.codigo}'">
                                                <td class="px-2 py-1 font-mono text-blue-600">${mt.codigo}</td>
                                                <td class="px-2 py-1">${mt.peso_stock} kg</td>
                                                <td class="px-2 py-1 ${mt.ubicacion==="Sin ubicaci√≥n"?"text-gray-400 italic":"text-green-700 font-medium"}">${mt.ubicacion}</td>
                                            </tr>
                                        `).join("")}
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en una fila para seleccionar el producto</p>
                        </div>
                    `:s=`<p class="text-orange-600 text-sm mt-2">‚ö†Ô∏è No hay productos disponibles con √ò${d}mm x ${f.toFixed(1)}m</p>`}}catch(D){console.warn("No se pudieron cargar sugerencias:",D)}const{value:o,isConfirmed:l}=await Swal.fire({title:"üì¶ Escanear producto",html:`
                <p class="mb-3">Escanea el QR del paquete de material a usar</p>
                ${s}
                <input type="text" id="swal-input-producto" class="swal2-input" placeholder="C√≥digo del producto..." autofocus>
            `,showCancelButton:!0,confirmButtonText:"Siguiente",cancelButtonText:"Cancelar",confirmButtonColor:"#F97316",focusConfirm:!1,preConfirm:()=>{const D=document.getElementById("swal-input-producto").value;return!D||!D.trim()?(Swal.showValidationMessage("Debes escanear o introducir el c√≥digo del producto"),!1):D.trim()}});if(!l||!o)return;let h;try{const D=await fetch(`/api/productos/buscar-por-codigo?codigo=${encodeURIComponent(o.trim())}`,{headers:{Accept:"application/json","X-CSRF-TOKEN":e}});if(!D.ok){const J=await D.json();throw new Error(J.message||"Producto no encontrado")}h=await D.json()}catch(D){await Swal.fire({icon:"error",title:"Producto no encontrado",text:D.message||`No se encontr√≥ ning√∫n producto con c√≥digo: ${o}`});return}const g=(h.tipo||"").toLowerCase(),p=Number(h.diametro??0),q=Number(h.longitud??0);if(g&&g!=="barra"){await Swal.fire({icon:"error",title:"Tipo de producto incorrecto",html:`
                    <p>El producto debe ser de tipo <strong>barra</strong>.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${h.codigo}</p>
                        <p><strong>Tipo:</strong> ${h.tipo||"N/A"}</p>
                    </div>
                `});return}if(p>0&&d>0&&Math.abs(p-d)>.1){await Swal.fire({icon:"error",title:"Di√°metro incorrecto",html:`
                    <p>El di√°metro del producto no coincide con el de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> √ò${p} mm</p>
                        <p><strong>Etiqueta requiere:</strong> √ò${d} mm</p>
                    </div>
                `});return}if(q>0&&f>0&&Math.abs(q-f)>.1){await Swal.fire({icon:"error",title:"Longitud incorrecta",html:`
                    <p>La longitud del producto no coincide con la de la etiqueta.</p>
                    <div class="mt-3 p-3 bg-red-50 rounded text-left">
                        <p><strong>Producto:</strong> ${q.toFixed(2)} m</p>
                        <p><strong>Etiqueta requiere:</strong> ${f.toFixed(2)} m</p>
                    </div>
                `});return}const M=h.longitud?`${h.longitud} m`:"N/A",{value:E,isConfirmed:x}=await Swal.fire({title:"¬øC√≥mo usar el paquete?",html:`
                <div class="text-left p-4 bg-gray-100 rounded mb-4">
                    <p><strong>Producto:</strong> ${h.codigo}</p>
                    <p><strong>Di√°metro:</strong> √ò${h.diametro} mm</p>
                    <p><strong>Longitud:</strong> ${M}</p>
                    <p><strong>Stock actual:</strong> ${((I=h.peso_stock)==null?void 0:I.toFixed(2))||0} kg</p>
                    <p><strong>Colada:</strong> ${h.n_colada||"N/A"}</p>
                </div>
            `,input:"radio",inputOptions:{completo:"üì¶ Usar paquete completo (consumir todo)",parcial:"‚úÇÔ∏è Quitar barras (restar peso de la etiqueta)"},inputValue:"completo",showCancelButton:!0,confirmButtonText:"Fabricar",cancelButtonText:"Cancelar",confirmButtonColor:"#10B981"});if(!x)return;const A=E==="completo",$=`/actualizar-etiqueta/${t}/maquina/${a}`,L=await fetch($,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":e},body:JSON.stringify({producto_id:h.id,paquete_completo:A})}),B=await L.json();if(!L.ok)throw new Error(B.message||"Error al fabricar");const F=((O=B.metricas)==null?void 0:O.peso_consumido)||0,_=((z=B.metricas)==null?void 0:z.paquete_codigo)||null;await Swal.fire({icon:"success",title:"¬°Fabricaci√≥n completada!",html:`
                <p>Etiqueta fabricada correctamente.</p>
                <p><strong>Producto usado:</strong> ${h.codigo}</p>
                <p><strong>Peso consumido:</strong> ${F.toFixed(2)} kg</p>
                ${_?`<p><strong>Paquete:</strong> ${_}</p>`:""}
                ${A?'<p class="text-orange-600">El producto ha sido marcado como consumido.</p>':""}
                <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>
            `,timer:2e3,showConfirmButton:!1}),n(t,B),_&&typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const D=document.getElementById("codigo_paquete_mover");D&&(D.value=_,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},300)))},100))}function n(t,a){var d,u;const e=t.replace(/\./g,"-");if(console.log("üîç DEBUG actualizarDOMEtiqueta - Datos recibidos:",{id:t,estado:a.estado,peso_etiqueta:a.peso_etiqueta,nombre:a.nombre,producto_n_colada:a.producto_n_colada,producto2_n_colada:a.producto2_n_colada,data_completa:a}),typeof window.SistemaDOM<"u"?window.SistemaDOM.actualizarEstadoEtiqueta(t,a.estado,{peso:a.peso_etiqueta,nombre:a.nombre||t,estado2:a.estado2||null,es_secundaria:a.es_secundaria||!1}):b(t,a.estado),a.estado2){const f=String(t).replace(/\./g,"-"),s=document.getElementById(`etiqueta-${f}`);s&&(s.dataset.estado2=a.estado2)}if(a.producto_n_colada&&window.elementosAgrupadosScript){const f=window.elementosAgrupadosScript.findIndex(s=>s.etiqueta&&String(s.etiqueta.etiqueta_sub_id)===String(t));if(f!==-1){const s=window.elementosAgrupadosScript[f];s.colada_etiqueta=a.producto_n_colada,s.colada_etiqueta_2=a.producto2_n_colada||null,typeof window.renderizarGrupoSVG=="function"&&(window.renderizarGrupoSVG(s,f),console.log(`‚úÖ SVG regenerado con colada de etiqueta: ${a.producto_n_colada}`))}}switch(a.coladas_por_elemento&&typeof window.actualizarSVGConColadas=="function"&&window.actualizarSVGConColadas(t,a.coladas_por_elemento),typeof window.HistorialEtiquetas<"u"&&window.HistorialEtiquetas.actualizarBoton(t,!0),(a.estado||"").toLowerCase()){case"pendiente":m("info","Pendiente","La etiqueta est√° pendiente de fabricaci√≥n.");break;case"cortando":m("info","Cortando","El proceso de corte ha iniciado.");break;case"cortada":m("success","Etiqueta cortada","El proceso de corte ha finalizado correctamente."),w(e);break;case"fabricando":m("info","Fabricando","El proceso de fabricaci√≥n ha iniciado.");break;case"fabricada":m("success","Etiqueta fabricada","La etiqueta ha sido fabricada exitosamente."),w(e),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"fabricada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(s=>s.coladas&&(s.coladas.colada1||s.coladas.colada2||s.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),S(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"completada":m("success","Etiqueta completada","La etiqueta ha sido procesada exitosamente."),(d=window._decisionCortePorEtiqueta)!=null&&d[t]&&(delete window._decisionCortePorEtiqueta[t],localStorage.setItem("decisionCortePorEtiqueta",JSON.stringify(window._decisionCortePorEtiqueta))),w(e),typeof window.TrabajoPaquete<"u"&&window.TrabajoPaquete.agregarItemEtiqueta(t,{id:t,peso_etiqueta:a.peso_etiqueta||0,estado:"completada",nombre:a.nombre||t}),a.elementos&&Array.isArray(a.elementos)&&a.elementos.length>0?a.elementos.some(s=>s.coladas&&(s.coladas.colada1||s.coladas.colada2||s.coladas.colada3))?(console.log(`üîÑ Actualizando coladas para etiqueta ${t}`,a.elementos),S(t,a.elementos)):console.warn(`‚ö†Ô∏è No se encontraron coladas en elementos para etiqueta ${t}`):console.warn(`‚ö†Ô∏è No se recibieron elementos v√°lidos para actualizar coladas en etiqueta ${t}`);break;case"ensamblando":m("info","Ensamblando","La etiqueta est√° en proceso de ensamblado.");break;case"ensamblada":m("success","Etiqueta ensamblada","El proceso de ensamblado ha finalizado correctamente."),w(e);break;case"soldando":m("info","Soldando","La etiqueta est√° en proceso de soldadura.");break;case"soldada":m("success","Etiqueta soldada","El proceso de soldadura ha finalizado correctamente."),w(e);break;case"doblando":m("info","Doblando","La etiqueta est√° en proceso de doblado.");break;case"completada":m("success","Doblado completado","El proceso de doblado ha finalizado correctamente."),w(e);break;default:console.warn(`Estado no manejado para etiqueta ${t}: ${a.estado}`),m("warning","Estado desconocido",`El estado recibido (${a.estado}) no est√° reconocido.`,3e3)}(u=a.productos_afectados)!=null&&u.length&&a.productos_afectados.forEach(f=>{const s=document.getElementById(`peso-stock-${f.id}`),o=document.getElementById(`progreso-texto-${f.id}`),l=document.getElementById(`progreso-barra-${f.id}`);s&&(s.textContent=`${f.peso_stock} kg`),o&&(o.textContent=`${f.peso_stock} / ${f.peso_inicial} kg`),l&&(l.style.height=`${f.peso_stock/f.peso_inicial*100}%`)})}function b(t,a){const e=t.replace(/\./g,"-"),d=document.getElementById("etiqueta-"+e);if(!d)return;d.dataset.estado=String(a||"").toLowerCase(),d.className=d.className.split(" ").filter(s=>!s.startsWith("estado-")).join(" ").trim(),d.classList.add("estado-"+d.dataset.estado);const u=d.querySelector('[id^="contenedor-svg-"]'),f=u==null?void 0:u.querySelector("svg");f&&(f.style.background=getComputedStyle(d).getPropertyValue("--bg-estado").trim())}function w(t){const a=`#etiqueta-${CSS.escape(t)}`,e=document.querySelector(a),d=Array.from(document.querySelectorAll(".proceso")),u=p=>(p||"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),f=p=>{var E;const q=(E=p.dataset)==null?void 0:E.estado;if(q)return u(q);const M=p.querySelector('[id^="estado-"]');return u((M==null?void 0:M.textContent)||(M==null?void 0:M.innerText)||"")},s=new Set(["completada","completado","finalizada","finalizado","terminada","terminado","hecha","hecho","empaquetada","en-paquete"]),o=p=>s.has(f(p)),l=e?d.indexOf(e):-1,g=(l>=0?d.slice(l+1):d).find(p=>!o(p));g?g.scrollIntoView({behavior:"smooth",block:"center"}):Swal.fire({icon:"success",title:"¬°Perfecto!",text:"Has terminado todas las etiquetas de esta planilla.",showConfirmButton:!0})}function S(t,a){var s;if(console.log(`üîÑ Actualizando coladas en SVG para etiqueta ${t}`),!a||!Array.isArray(a)){console.error(`‚ùå elementosActualizados no es un array v√°lido para etiqueta ${t}`);return}if(a.length===0){console.warn(`‚ö†Ô∏è elementosActualizados est√° vac√≠o para etiqueta ${t}`);return}if(!window.elementosAgrupadosScript||!Array.isArray(window.elementosAgrupadosScript)){console.error("‚ùå window.elementosAgrupadosScript no est√° disponible");return}const e=window.elementosAgrupadosScript.findIndex(o=>{var l;return((l=o.etiqueta)==null?void 0:l.etiqueta_sub_id)===t});if(e===-1){console.warn(`‚ö†Ô∏è No se encontr√≥ grupo para etiqueta ${t}`);return}window.elementosAgrupadosScript[e].elementos=a;const d=window.elementosAgrupadosScript[e],u=(s=d.etiqueta)==null?void 0:s.id;if(!u){console.error(`‚ùå No se pudo obtener groupId para etiqueta ${t}`);return}const f=document.getElementById("contenedor-svg-"+u);if(!f){console.warn(`‚ö†Ô∏è No se encontr√≥ contenedor SVG para etiqueta ${t} (id: ${u})`);return}try{const o=f.querySelector("svg");o&&o.remove();const l=600,h=150,g=f.closest(".proceso"),p=g&&getComputedStyle(g).getPropertyValue("--bg-estado").trim()||"#e5e7eb",q=document.createElementNS("http://www.w3.org/2000/svg","svg");q.setAttribute("viewBox",`0 0 ${l} ${h}`),q.setAttribute("preserveAspectRatio","xMidYMid meet"),q.style.width="100%",q.style.height="100%",q.style.display="block",q.style.background=p;const M=(d.elementos||[]).map((x,A)=>{var _,C,N;const $=x.barras!=null?x.barras:0;let L="N/A";if(x.diametro!=null&&x.diametro!==""){const O=String(x.diametro).replace(",",".").match(/-?\d+(?:\.\d+)?/);if(O){const z=parseFloat(O[0]);isFinite(z)&&(L=String(Math.round(z)))}}const B=[];(_=x.coladas)!=null&&_.colada1&&B.push(x.coladas.colada1),(C=x.coladas)!=null&&C.colada2&&B.push(x.coladas.colada2),(N=x.coladas)!=null&&N.colada3&&B.push(x.coladas.colada3);const F=B.length>0?` (${B.join(", ")})`:"";return{letter:indexToLetters(A),text:`√ò${L} x${$}${F}`}});typeof drawLegendBottomLeft=="function"?drawLegendBottomLeft(q,M,l,h):console.error("‚ùå drawLegendBottomLeft no est√° definida");const E=document.createElementNS("http://www.w3.org/2000/svg","text");E.setAttribute("x",l/2),E.setAttribute("y",h/2),E.setAttribute("text-anchor","middle"),E.setAttribute("fill","#059669"),E.setAttribute("font-size","14"),E.setAttribute("font-weight","600"),E.textContent="‚úì Coladas actualizadas",q.appendChild(E),f.appendChild(q),console.log(`‚úÖ SVG actualizado con coladas para etiqueta ${t}`),setTimeout(()=>{E&&E.parentNode&&E.remove()},2e3)}catch(o){console.error(`‚ùå Error al actualizar SVG para etiqueta ${t}:`,o),typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Advertencia",text:"Las coladas se guardaron pero hubo un problema al actualizar la visualizaci√≥n.",timer:3e3,showConfirmButton:!1})}}function m(t,a,e,d=2e3){Swal.fire({icon:t,title:a,text:e,timer:d,showConfirmButton:!1})}function y(t){Swal.fire({icon:"error",title:"Error",text:t.message||"Ha ocurrido un error inesperado"})}window.actualizarDOMEtiqueta=n}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Dt):Dt();document.addEventListener("livewire:navigated",Dt);(function(v){let c=[],r=!1,i=null;async function n(o){var h;const l=`/etiquetas/${encodeURIComponent(o)}/validar-para-paquete`;try{const g=await fetch(l,{method:"GET",headers:{Accept:"application/json","X-CSRF-TOKEN":(h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.content}});if(!(g.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta del servidor no es JSON");const q=await g.json();if(!g.ok)throw new Error((q==null?void 0:q.message)||(q==null?void 0:q.motivo)||"Error al validar");return q}catch(g){throw g}}function b(o,l){const h=l.id||o;if(c.some(q=>q.id===h))return!1;const g=parseFloat(l.peso_etiqueta)||0,p={id:h,type:"etiqueta",peso:g,estado:l.estado||"desconocido",nombre:l.nombre||"Sin nombre"};return c.push(p),t(),!0}function w(o){const l=c.findIndex(h=>h.id===o);l>=0&&c.splice(l,1),t()}function S(){c=[],t()}function m(){return c.reduce((o,l)=>o+(parseFloat(l.peso)||0),0)}function y(){return c}function t(){const o=document.getElementById("itemsList");if(!o)return;o.innerHTML="";for(const g of c){const p=document.createElement("li");p.className="flex justify-between items-center px-3 py-2 bg-white border rounded mb-2",p.dataset.code=g.id,p.innerHTML=`
                <div>
                    <div class="font-semibold">${g.id}</div>
                </div>
                <button class="text-red-600 hover:text-red-800" title="Eliminar">‚ùå</button>
            `,p.querySelector("button").onclick=()=>w(g.id),o.appendChild(p)}const l=m(),h=document.createElement("li");h.className="py-3 px-3 bg-blue-50 border-t-2 mt-3 font-bold",h.textContent=`Total: ${Math.round(l)} kg (${c.length} etiquetas)`,o.appendChild(h)}async function a(){var q,M,E;if(!c.length){await Swal.fire("Carro vac√≠o","No hay etiquetas para empaquetar","warning");return}const o=Number(((M=(q=document.getElementById("maquina-info"))==null?void 0:q.dataset)==null?void 0:M.maquinaId)||window.maquinaId),l=Number(((E=document.getElementById("ubicacion-id"))==null?void 0:E.value)||window.ubicacionId),h=(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua";if(!o){await Swal.fire("Faltan datos","Debe especificarse la m√°quina.","error");return}const g={items:c.map(x=>({id:x.id,type:x.type})),maquina_id:o,ubicacion_id:h?null:l||null,sin_ubicacion:h},p=async(x={})=>{var L;const A=await fetch("/paquetes",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":(L=document.querySelector('meta[name="csrf-token"]'))==null?void 0:L.content},body:JSON.stringify({...g,...x})}),$=await A.json();if(!A.ok)throw new Error($.message||"Error al crear el paquete");return $};try{const x=await p();if(x.success)return e(x);if(x.warning){let A="<div style='text-align:left;'>Se detectaron advertencias:";for(const[L,B]of Object.entries(x.warning))Array.isArray(B)&&B.length&&(A+=`<br><strong>${L.replaceAll("_"," ")}:</strong> ${B.join(", ")}`);if(A+="</div>",(await Swal.fire({icon:"warning",title:"Advertencias",html:A,showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"})).isConfirmed){const L=await p({confirmar:!0});if(L.success)return e(L);throw new Error(L.message)}throw new Error("Operaci√≥n cancelada por el usuario.")}throw new Error("No se pudo crear el paquete")}catch(x){await Swal.fire("Error",x.message||"Error inesperado","error")}}async function e(o){var q;console.log("üì¶ postCreacion llamada con data:",o);const l=o.codigo_paquete||((q=o.paquete)==null?void 0:q.codigo)||"N/D",h=m(),g=[...c.map(M=>M.id)];console.log("üì¶ Etiquetas a actualizar:",g),(window.MAQUINA_TIPO_NOMBRE||"").toLowerCase()==="grua"?(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${l}</strong> creado correctamente</p>
                       <p>${g.length} etiquetas ¬∑ ${h.toFixed(2)} kg</p>
                       <p class="mt-2 text-blue-600 font-semibold">Ahora selecciona d√≥nde ubicar el paquete...</p>`,timer:2e3,showConfirmButton:!1}),S(),typeof abrirModalMoverPaquete=="function"&&(abrirModalMoverPaquete(),setTimeout(async()=>{const M=document.getElementById("codigo_paquete_mover");M&&(M.value=l,typeof buscarPaqueteParaMover=="function"&&(await buscarPaqueteParaMover(),setTimeout(()=>{typeof mostrarPasoMapa=="function"&&mostrarPasoMapa()},50)))},50))):(await Swal.fire({icon:"success",title:"Paquete creado",html:`<p><strong>${l}</strong> creado correctamente</p><p>${g.length} etiquetas ¬∑ ${h.toFixed(2)} kg</p>`}),S()),console.log(`üì¶ Disparando evento paquete:creado para ${l}`),window.dispatchEvent(new CustomEvent("paquete:creado",{detail:{codigoPaquete:l,etiquetaIds:g,pesoTotal:h}})),console.log(`üîÑ Actualizando DOM para ${g.length} etiquetas con paquete ${l}`),g.forEach(M=>{d(M,l)})}function d(o,l){const h=String(o).replace(/\./g,"-");console.log(`üîç Buscando elemento para etiqueta: ${o} (safe: ${h})`);let g=document.querySelector(`#etiqueta-${h}`);if(g&&console.log(`‚úÖ Encontrado por ID: #etiqueta-${h}`),!g){const A=document.querySelector(`[data-etiqueta-sub-id="${o}"]`);A&&(g=A.querySelector(".etiqueta-card"),g&&console.log("‚úÖ Encontrado por data-etiqueta-sub-id en wrapper"))}if(!g){const A=document.querySelectorAll("[data-etiquetas-sub-ids]");console.log(`üîç Buscando en ${A.length} grupos...`);for(const $ of A)try{const L=JSON.parse($.dataset.etiquetasSubIds||"[]");if(L.includes(o)){g=$,console.log(`‚úÖ Etiqueta ${o} encontrada en grupo con ${L.length} etiquetas`);break}}catch(L){console.warn("‚ö†Ô∏è Error parseando etiquetas del grupo:",L)}}if(!g){console.warn(`‚ùå No se encontr√≥ elemento: ${o}`);return}console.log(`üîÑ Actualizando manualmente: ${o}`),Array.from(g.classList).forEach(A=>{A.startsWith("estado-")&&g.classList.remove(A)}),g.classList.add("estado-en-paquete"),g.dataset.estado="en-paquete",g.style.setProperty("--bg-estado","#e3e4FA");const q=g.querySelector('[id^="contenedor-svg-"]');if(q){const A=q.querySelector("svg");A&&(A.style.background="#e3e4FA")}const M=g.querySelector(".etiqueta-card")||g;M&&(M.style.background="#e3e4FA");const E=g.querySelector(".paquete-codigo");E?(E.textContent=`(${l})`,E.style.display="inline",console.log(`‚úÖ C√≥digo de paquete actualizado: (${l})`)):console.warn("‚ö†Ô∏è No se encontr√≥ span .paquete-codigo en elemento"),g.querySelectorAll(".btn-fabricar").forEach(A=>{A.disabled=!0,A.style.opacity="0.5",A.style.cursor="not-allowed"}),g.style.transition="transform 0.5s ease, background-color 0.5s ease",g.style.transform="scale(1.03)",setTimeout(()=>{g.style.transform="scale(1)"},400),console.log(`‚úÖ Etiqueta ${o} actualizada manualmente`)}function u(){f(),r||(s(),r=!0)}function f(){const o=document.getElementById("qrItem");o&&!o.dataset.initialized&&(o.dataset.initialized="true",o.addEventListener("change",()=>o.dispatchEvent(new Event("input"))),o.addEventListener("input",async function(){const l=this.value.trim();if(l)try{const h=await n(l);if(!h.valida){await Swal.fire("Etiqueta no v√°lida",h.motivo||"Motivo no especificado","warning"),this.value="",this.focus();return}b(l,h)||await Swal.fire("Etiqueta duplicada","Ya est√° en el carro","info"),this.value="",this.focus()}catch(h){console.error("Error de validaci√≥n:",h),await Swal.fire("Error",h.message||"Fallo en validaci√≥n","error"),this.value="",this.focus()}}))}function s(){document.addEventListener("click",async function(o){if(o.target.id==="crearPaqueteBtn"||o.target.closest("#crearPaqueteBtn")){o.preventDefault(),await a();return}}),document.addEventListener("focus",function(o){o.target.id&&o.target.id.startsWith("input-etiqueta-")&&(i=o.target,console.log("üéØ Focus en input:",o.target.id))},!0),document.addEventListener("click",async function(o){var l;if(o.target.classList.contains("btn-agregar-carro")||o.target.closest(".btn-agregar-carro")){const g=(o.target.classList.contains("btn-agregar-carro")?o.target:o.target.closest(".btn-agregar-carro")).dataset.etiquetaId;if(!g){console.error("No se encontr√≥ etiqueta_id en el bot√≥n");return}const p=document.querySelector(`[x-show="tabActivo === 'crear'"]`),q=document.querySelector(`[x-show="tabActivo === 'gestion'"]`);if(p&&window.getComputedStyle(p).display,q&&window.getComputedStyle(q).display!=="none"){console.log("üì¶ Modo Gesti√≥n: A√±adiendo al input de a√±adir etiqueta");let E=document.activeElement;(!E||!((l=E.id)!=null&&l.startsWith("input-etiqueta-")))&&(E=i),(!E||!document.body.contains(E))&&(E=document.querySelector('input[id^="input-etiqueta-"]')),E?(E.value=g,E.focus(),E.classList.add("ring-4","ring-green-400"),setTimeout(()=>{E.classList.remove("ring-4","ring-green-400")},1e3),console.log(`‚úÖ Etiqueta ${g} a√±adida al input:`,E.id)):await Swal.fire({icon:"info",title:"Expande un paquete",text:"Para a√±adir una etiqueta, primero expande el paquete donde deseas a√±adirla"});return}console.log("üõí Modo Crear: A√±adiendo etiqueta al carro:",g);try{const E=await n(g);if(!E.valida){await Swal.fire({icon:"warning",title:"Etiqueta no v√°lida",text:E.motivo||"Motivo no especificado"});return}b(g,E)||await Swal.fire({icon:"info",title:"Etiqueta duplicada",text:"Ya est√° en el carro"})}catch(E){console.error("Error al a√±adir al carro:",E),await Swal.fire({icon:"error",title:"Error",text:E.message||"No se pudo a√±adir al carro"})}}if(o.target.classList.contains("btn-agregar-carro-grupo")||o.target.closest(".btn-agregar-carro-grupo")){const h=o.target.classList.contains("btn-agregar-carro-grupo")?o.target:o.target.closest(".btn-agregar-carro-grupo"),g=h.dataset.grupoId;let p=[];try{p=JSON.parse(h.dataset.etiquetas||"[]")}catch($){console.error("Error parseando etiquetas del grupo:",$);return}if(!p.length){await Swal.fire({icon:"info",title:"Grupo vac√≠o",text:"No hay etiquetas en este grupo"});return}console.log(`üõí A√±adiendo ${p.length} etiquetas del grupo ${g} al carro`);let q=0,M=0,E=0,x=[];const A=await Promise.all(p.map(async $=>{try{const L=await n($.id);return{id:$.id,data:L,error:null}}catch(L){return{id:$.id,data:null,error:L}}}));for(const{id:$,data:L,error:B}of A){if(B){E++,console.error("Error validando etiqueta:",$,B);continue}if(!L.valida){E++,L.motivo&&!x.includes(L.motivo)&&x.push(L.motivo);continue}b($,L)?q++:M++}if(q>0)await Swal.fire({icon:"success",title:"Etiquetas a√±adidas",html:`
                            <p>Se a√±adieron <strong>${q}</strong> etiquetas al carro.</p>
                            ${M>0?`<p class="text-gray-500">${M} ya estaban en el carro.</p>`:""}
                            ${E>0?`<p class="text-red-500">${E} no pudieron a√±adirse.</p>`:""}
                        `,timer:2500,showConfirmButton:!1});else if(M>0)await Swal.fire({icon:"info",title:"Etiquetas duplicadas",text:"Todas las etiquetas del grupo ya est√°n en el carro."});else{const $=x.length>0?`<ul class="text-left mt-2 text-sm">${x.map(L=>`<li>‚Ä¢ ${L}</li>`).join("")}</ul>`:"";await Swal.fire({icon:"warning",title:"No se a√±adieron etiquetas",html:`
                            <p>Las etiquetas del grupo no son v√°lidas para a√±adir al carro.</p>
                            ${$}
                        `})}}})}v.TrabajoPaquete={inicializar:u,agregarItemEtiqueta:b,eliminarItem:w,limpiarCarro:S,obtenerItems:y,calcularPesoTotal:m,crearPaquete:a,validarEtiqueta:n,actualizarListaVisual:t},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u(),document.addEventListener("livewire:navigated",u)})(window);function Ot(){document.addEventListener("alpine:init",()=>{window.updateGridClasses=function(c,r){const i=document.getElementById("grid-maquina");if(!i)return;console.log("üîß Actualizando clases:",{showLeft:c,showRight:r,clasesAnteriores:i.className}),c||r?i.classList.add("columnas-laterales-visibles"):i.classList.remove("columnas-laterales-visibles"),c&&r?i.classList.add("ambas-columnas"):i.classList.remove("ambas-columnas"),console.log("‚úÖ Clases actualizadas:",i.className),i.offsetHeight,i.querySelectorAll(".etiqueta-card").forEach(b=>{b.offsetHeight}),console.log("üé® Repaint forzado (optimizado)")},window.addEventListener("toggleLeft",()=>{const c=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,r)}),window.addEventListener("solo",()=>{window.updateGridClasses(!1,!1)}),window.addEventListener("toggleRight",()=>{const c=JSON.parse(localStorage.getItem("showLeft")??"true"),r=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(c,r)});function v(){if(!document.getElementById("grid-maquina")){console.log("‚è≥ Grid no encontrado, reintentando..."),new MutationObserver((b,w)=>{if(document.getElementById("grid-maquina")){console.log("‚úÖ Grid detectado por MutationObserver"),w.disconnect();const m=JSON.parse(localStorage.getItem("showLeft")??"true"),y=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(m,y)}}).observe(document.body,{childList:!0,subtree:!0});return}const r=JSON.parse(localStorage.getItem("showLeft")??"true"),i=JSON.parse(localStorage.getItem("showRight")??"true");window.updateGridClasses(r,i),console.log("‚úÖ Clases iniciales aplicadas inmediatamente")}v()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ot):Ot();document.addEventListener("livewire:navigated",Ot);(function(){if(window.__historialEtiquetasInit)return;window.__historialEtiquetasInit=!0;const v={debounceTime:500};let c=0;async function r(a){var u;const e=Date.now();if(e-c<v.debounceTime)return console.warn("Acci√≥n demasiado r√°pida, ignorando..."),{success:!1,message:"Espera un momento antes de intentar de nuevo."};c=e;const d=(u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content");if(!d)return console.error("CSRF token no encontrado"),{success:!1,message:"Error de seguridad: token no encontrado."};try{if(!(await Swal.fire({icon:"question",title:"¬øDeshacer √∫ltimo cambio?",text:`Se revertir√° el √∫ltimo cambio de la etiqueta ${a}`,showCancelButton:!0,confirmButtonText:"S√≠, deshacer",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b",cancelButtonColor:"#6b7280"})).isConfirmed)return{success:!1,message:"Operaci√≥n cancelada."};Swal.fire({title:"Deshaciendo...",text:"Revirtiendo cambios...",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>Swal.showLoading()});const s=await fetch(`/etiquetas/${encodeURIComponent(a)}/deshacer`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":d}}),o=await s.json();return!s.ok||!o.success?(Swal.fire({icon:"error",title:"Error al deshacer",text:o.message||"No se pudo revertir el cambio."}),{success:!1,message:o.message}):(Swal.fire({icon:"success",title:"Cambio revertido",html:`
                    <p>${o.message}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Estado actual: <strong>${o.estado}</strong>
                    </p>
                    ${o.puede_deshacer?'<p class="text-xs text-blue-600 mt-1">Puedes deshacer m√°s cambios.</p>':""}
                `,timer:3e3,showConfirmButton:!1}),w(a,o),o)}catch(f){return console.error("Error al deshacer etiqueta:",f),Swal.fire({icon:"error",title:"Error",text:"Error de conexi√≥n al intentar deshacer el cambio."}),{success:!1,message:f.message}}}async function i(a){try{const e=await fetch(`/etiquetas/${encodeURIComponent(a)}/puede-deshacer`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{puede_deshacer:!1}}catch(e){return console.error("Error al verificar undo:",e),{puede_deshacer:!1}}}async function n(a){try{const e=await fetch(`/etiquetas/${encodeURIComponent(a)}/historial`,{headers:{Accept:"application/json"}});return e.ok?await e.json():{success:!1,historial:[]}}catch(e){return console.error("Error al obtener historial:",e),{success:!1,historial:[]}}}async function b(a){var u;Swal.fire({title:"Cargando historial...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const e=await n(a);if(!e.success||!((u=e.historial)!=null&&u.length)){Swal.fire({icon:"info",title:"Sin historial",text:"No hay cambios registrados para esta etiqueta."});return}const d=e.historial.map((f,s)=>`
            <tr class="${f.revertido?"bg-gray-100 text-gray-400":s===0?"bg-yellow-50":""}">
                <td class="px-2 py-1 text-xs">${f.fecha}</td>
                <td class="px-2 py-1 text-xs font-medium">${f.accion}</td>
                <td class="px-2 py-1 text-xs">${f.estado_anterior||"-"} ‚Üí ${f.estado_nuevo}</td>
                <td class="px-2 py-1 text-xs">
                    ${f.revertido?'<span class="text-gray-400">Revertido</span>':s===0?'<span class="text-green-600 font-bold">Actual</span>':""}
                </td>
            </tr>
        `).join("");Swal.fire({title:`Historial de ${a}`,html:`
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-xs">Fecha</th>
                                <th class="px-2 py-1 text-xs">Acci√≥n</th>
                                <th class="px-2 py-1 text-xs">Estado</th>
                                <th class="px-2 py-1 text-xs"></th>
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                </div>
                ${e.puede_deshacer?`
                    <p class="mt-3 text-sm text-blue-600">
                        Puedes deshacer el √∫ltimo cambio (estado anterior: <strong>${e.ultimo_estado_reversible}</strong>)
                    </p>
                `:""}
            `,width:"600px",showConfirmButton:!0,confirmButtonText:e.puede_deshacer?"Deshacer √∫ltimo cambio":"Cerrar",showCancelButton:e.puede_deshacer,cancelButtonText:"Cerrar",confirmButtonColor:e.puede_deshacer?"#f59e0b":"#6b7280"}).then(f=>{f.isConfirmed&&e.puede_deshacer&&r(a)})}function w(a,e){const d=a.replace(/\./g,"-"),u=document.getElementById(`etiqueta-${d}`);if(u){u.dataset.estado=e.estado,u.className=u.className.split(" ").filter(o=>!o.startsWith("estado-")).join(" ").trim(),u.classList.add(`estado-${e.estado}`);const f=u.querySelector('[id^="contenedor-svg-"]'),s=f==null?void 0:f.querySelector("svg");s&&(s.style.background=getComputedStyle(u).getPropertyValue("--bg-estado").trim()),typeof window.SistemaDOM<"u"&&window.SistemaDOM.actualizarEstadoEtiqueta(a,e.estado)}if(e.estado==="pendiente"){if(window.elementosAgrupadosScript){const o=window.elementosAgrupadosScript.find(l=>l.etiqueta&&String(l.etiqueta.etiqueta_sub_id)===String(a));o&&(o.colada_etiqueta=null,o.colada_etiqueta_2=null,o.elementos&&o.elementos.forEach(l=>{l.coladas={colada1:null,colada2:null,colada3:null}}),window.dispatchEvent(new CustomEvent("regenerar-svg-etiqueta",{detail:{etiquetaSubId:a}})))}const f=document.getElementById(`colada-${d}`);f&&(f.textContent="")}console.log(`‚úÖ DOM actualizado para ${a}: estado = ${e.estado}`)}function S(a,e){const d=a.replace(/\./g,"-"),u=document.querySelector(`#etiqueta-${d} .btn-deshacer`);console.log(`üîÑ actualizarBotonDeshacer: ${a}, puede=${e}, btn encontrado=${!!u}`),u&&(u.disabled=!1,u.classList.remove("opacity-50","cursor-not-allowed"),u.title="Deshacer √∫ltimo cambio (Ctrl+Z)")}function m(){document.addEventListener("click",async a=>{const e=a.target.closest(".btn-deshacer");if(!e)return;a.preventDefault(),a.stopPropagation();const d=e.dataset.etiquetaId;if(!d){console.error("Bot√≥n deshacer sin data-etiqueta-id");return}await r(d)}),document.addEventListener("click",async a=>{const e=a.target.closest(".btn-historial");if(!e)return;a.preventDefault(),a.stopPropagation();const d=e.dataset.etiquetaId;d&&await b(d)}),console.log("‚úÖ Event listeners de historial inicializados")}function y(){let a=null;window.addEventListener("etiqueta-fabricada",e=>{var d;(d=e.detail)!=null&&d.etiquetaSubId&&(a=e.detail.etiquetaSubId)}),document.addEventListener("keydown",async e=>{var d,u;if(e.ctrlKey&&e.key==="z"&&!e.shiftKey){if(["INPUT","TEXTAREA"].includes((d=document.activeElement)==null?void 0:d.tagName))return;const f=document.querySelector(".etiqueta-card:focus, .etiqueta-card:hover"),s=((u=f==null?void 0:f.dataset)==null?void 0:u.etiquetaId)||a;s&&(e.preventDefault(),await r(s))}}),console.log("‚úÖ Atajo Ctrl+Z habilitado para deshacer etiquetas")}function t(){m(),y(),console.log("‚úÖ M√≥dulo historialEtiquetas.js inicializado")}window.HistorialEtiquetas={deshacer:r,puedeDeshacer:i,obtenerHistorial:n,mostrarHistorial:b,actualizarBoton:S},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t(),document.addEventListener("livewire:navigated",t)})();
